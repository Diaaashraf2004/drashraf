<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>برنامج إدارة البضائع والمخزون والفواتير (drashraf) - مُعدل</title>
    <meta name="description" content="برنامج ويب لإدارة المخزون، المبيعات، الموردين، السيولة، الديون، الالتزامات، وحساب رأس المال مع تقارير، بحث فواتير، وترحيل أرصدة تلقائي عند بدء يوم جديد. يتضمن تتبع الأرقام التسلسلية وإدارتها للمخزون الحالي مع بحث داخلي. تطوير ضياء أشرف (drashraf). يشمل بحث وتصفيات للمبيعات المؤقتة وإمكانية تعديل السيولة يدوياً.">
    <meta name="keywords" content="إدارة بضائع, مخزون, موردين, سيولة, ديون, التزامات, مقاصة, تقرير مبيعات, بحث فاتورة, ترحيل أرصدة, ترحيل تلقائي, تعديل, حذف, سبب الدين, برنامج, drashraf, ضياء أشرف, فاتورة, بيع مؤقت, بحث بيع مؤقت, رقم تسلسلي, سيريال, بحث سيريال, استيراد CSV, ربط سيريال بالفاتورة, إدارة سيريالات, بحث داخلي, تعديل السيولة, supplier, invoice, inventory, management, offsetting, sales report, invoice search, carry forward, auto carry forward, edit, delete, debt reason, pending sale, filter pending sales, deduct cost, serial number tracking, serial search, csv import, invoice serial link, manage serials, filter serials, adjust liquidity">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* --- التنسيقات الأساسية --- */
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; margin: 0; padding: 0; }
        html { direction: rtl; }

        /* --- تنسيقات الأقسام (Widgets) --- */
        .widget-card { background-color: #ffffff; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); border: 1px solid #e5e7eb; transition: box-shadow 0.3s ease-in-out; margin-bottom: 1.5rem; }
        .widget-card:hover { box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .widget-card h2 { font-size: 1.25rem; font-weight: 600; color: #1f2937; margin-top: 0; margin-bottom: 1.25rem; padding-bottom: 0.75rem; border-bottom: 1px solid #e5e7eb; }
        .widget-card h3.sub-heading { font-size: 1.1rem; font-weight: 600; color: #374151; margin-top: 1.5rem; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px dashed #e5e7eb; }

        /* --- تنسيقات التنقل (Tabs) --- */
        #main-nav button { padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 500; color: #4b5563; background-color: #f9fafb; border: 1px solid #e5e7eb; transition: all 0.2s ease-in-out; margin-bottom: 0.5rem; cursor: pointer; }
        #main-nav button:hover { background-color: #f3f4f6; color: #1f2937; }
        #main-nav button.active { background-color: #3b82f6; color: #ffffff; border-color: #2563eb; }

        /* --- تنسيقات أخرى --- */
        .save-icon { display: inline-block; width: 1em; height: 1em; margin-left: 0.5em; vertical-align: middle; fill: currentColor; }
        input[type="text"], input[type="number"], input[type="tel"], input[type="date"], input[type="month"], select, textarea, input[type="checkbox"] { /* Added checkbox */
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            width: 100%;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            box-sizing: border-box; /* Added for consistent sizing */
            font-size: 1em; /* Ensure consistent font size */
            background-color: white; /* Ensure background */
        }
        input[type="checkbox"] { /* Specific checkbox overrides */
             width: auto; /* Checkboxes shouldn't be full width */
             padding: 0; /* Remove padding */
             vertical-align: middle; /* Align with text */
             margin-left: 0.5rem; /* Space after checkbox */
             cursor: pointer;
        }
        input[type="file"] { /* Style file input trigger button instead */
            display: none;
        }
        input[type="text"]:focus, input[type="number"]:focus, input[type="tel"]:focus, input[type="date"]:focus, input[type="month"]:focus, select:focus, textarea:focus, input[type="checkbox"]:focus { /* Added checkbox focus */
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }
        input[type="date"], input[type="month"] { appearance: none; -webkit-appearance: none; cursor: pointer; position: relative; } /* Added relative positioning */
        input[type="date"]::-webkit-calendar-picker-indicator, input[type="month"]::-webkit-calendar-picker-indicator { opacity: 0.6; cursor: pointer; filter: invert(0.5); /* Position indicator if needed, often handled by browser */ }
        select {
            appearance: none; -webkit-appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%2020%2020%22%20fill%3D%22%236b7280%22%3E%3Cpath%20fill-rule%3D%22evenodd%22%20d%3D%22M5.293%207.293a1%201%200%20011.414%200L10%2010.586l3.293-3.293a1%201%200%20111.414%201.414l-4%204a1%201%200%2001-1.414%200l-4-4a1%201%200%20010-1.414z%22%20clip-rule%3D%22evenodd%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat; background-position: left 0.5rem center; background-size: 1.25em; padding-left: 2.5rem; cursor: pointer;
        }

        .section-message {
            min-height: 1.5em; margin-top: 0.75rem; font-weight: 600; display: none;
            border-radius: 0.375rem; padding: 0.75rem; border: 1px solid transparent;
            text-align: center; font-size: 0.9em;
        }
        .section-message.visible { display: block; }
        .section-message.success { color: #065f46; background-color: #d1fae5; border-color: #6ee7b7; } /* text-green-800 bg-green-100 border-green-300 */
        .section-message.error { color: #991b1b; background-color: #fee2e2; border-color: #fca5a5; } /* text-red-800 bg-red-100 border-red-300 */
        .section-message.info { color: #1e40af; background-color: #dbeafe; border-color: #93c5fd; } /* text-blue-800 bg-blue-100 border-blue-300 */


        /* Adjusting global message slightly */
        #global-message { margin-bottom: 1rem; text-align: center; }

        #additional-costs-container { max-height: 150px; overflow-y: auto; border: 1px solid #e2e8f0; padding: 0.75rem; border-radius: 0.375rem; background-color: #f9fafb; margin-top: 1rem; }
        #additional-costs-container label { display: block; margin-bottom: 0.5rem; font-size: 0.875rem; cursor: pointer; padding: 4px; border-radius: 3px; }
        #additional-costs-container label:hover { background-color: #e5e7eb; }
        #additional-costs-container input[type="checkbox"] { margin-left: 0.5rem; cursor: pointer; vertical-align: middle;} /* Already had checkbox styles here */

        /* Unified max-height for lists */
        #pending-sales-list, #debtors-list, #liquidity-log-list, #liabilities-list,
        #sales-report-table-body, #supplier-list, #product-list, #operation-log-list,
        #search-results-list, #supplier-serials-results, #modal-registered-serials-list { /* Added modal-registered-serials-list */
             max-height: 300px; overflow-y: auto;
        }
        #product-list { max-height: 50vh; }
        #search-results-list { max-height: 40vh; }
        #supplier-serials-results { max-height: 40vh; border: 1px solid #e5e7eb; padding: 0.75rem; border-radius: 0.375rem; background-color: #f9fafb; } /* Style for serial results */
        #modal-registered-serials-list { max-height: 150px; /* Shorter height for modal list */ border: 1px solid #e5e7eb; padding: 0.75rem; border-radius: 0.375rem; background-color: #f9fafb; margin-top: 1rem; }
        #operation-log-list { max-height: 60vh; background-color: #f9fafb; border: 1px solid #e5e7eb; padding: 0.75rem; border-radius: 0.375rem; }
        #operation-log-list li { border-bottom: 1px solid #eee; padding-bottom: 0.5rem; margin-bottom: 0.5rem; list-style-position: inside; }

        #pending-sales-list li, #liquidity-log-list li, #liabilities-list li, #supplier-serials-results li, #modal-registered-serials-list li { /* Added modal-registered-serials-list */
            border-bottom: 1px solid #eee; padding: 0.75rem 0.5rem; margin-bottom: 0.5rem; font-size: 0.9em; list-style: none;
        }
        #supplier-serials-results li strong, #modal-registered-serials-list li strong { color: #1d4ed8; } /* Style serial number */
        #debtors-list details { list-style: none; padding: 0; margin: 0 0 0.5rem 0; border: 1px solid #e5e7eb; border-radius: 0.375rem; overflow: hidden;}
        #debtors-list summary { list-style: none; cursor: pointer; background-color: #f9fafb; padding: 0.75rem; font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
        #debtors-list summary::-webkit-details-marker { display: none; }
        #debtors-list details[open] summary { border-bottom: 1px solid #e5e7eb; }
        #debtors-list ul { padding: 0.75rem; background-color: #ffffff; margin: 0; }
        #debtors-list li .debt-details { font-size: 0.8em; color: #6b7280; }
        #pending-sales-list li .details, #liquidity-log-list li .details, #liabilities-list li .details { color: #4b5563; }
        #pending-sales-list li .actions button, #debtors-list li .actions button, #liabilities-list li .actions button, .supplier-actions button, .product-actions button { font-size: 0.75rem; padding: 0.25rem 0.5rem; margin-right: 0.5rem; cursor: pointer; border-radius: 0.25rem; border: 1px solid transparent; }
        .product-actions .manage-serials-btn { background-color: #6366f1; color: white; border-color: #4f46e5; } /* Style for manage serials button */
        .product-actions .manage-serials-btn:hover { background-color: #4f46e5; }

        #consignment-value-display { font-size: 1.125rem; font-weight: 600; color: #ca8a04; }

        /* Ensure containers have consistent spacing and border */
        #debtors-list-container, #liquidity-log-container, #liabilities-list-container,
        #pending-sales-container, #import-export-section, #sales-report-display,
        #suppliers-list-container, #search-results-container, #serial-search-container,
        #liquidity-adjustment-container { /* Added liquidity-adjustment-container */
            margin-top: 1.5rem; border-top: 1px solid #e5e7eb; padding-top: 1rem;
        }
        #debtors-list-container h3, #liquidity-log-container h3, #liabilities-list-container h3,
        #pending-sales-container h3, #import-export-section h3, #sales-report-display h3,
        #suppliers-list-container h3, #search-results-container h3, #serial-search-container h3,
        #liquidity-adjustment-container h3 { /* Added liquidity-adjustment-container */
            font-weight: 600; margin-bottom: 0.75rem; color: #374151; font-size: 1.1rem;
        }
        /* Styling for pending sales search and totals (New) */
        #pending-sales-controls { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem; align-items: center;}
        #pending-sales-search-group { flex-grow: 1; min-width: 200px;}
        #pending-sales-totals-group { display: flex; flex-wrap: wrap; gap: 0.5rem 1.5rem; font-size: 0.9em; font-weight: 500; flex-shrink: 0;}
        #pending-sales-totals-group span { white-space: nowrap; }
        #pending-sales-total-cost { color: #c026d3; } /* Fuchsia for cost */
        #pending-sales-total-profit { color: #16a34a; } /* Green for profit */


        #liquidity-log-list li span.add { color: #16a34a; }
        #liquidity-log-list li span.remove { color: #dc2626; }
        #liabilities-list li span { color: #7c3aed; } /* Purple color for liabilities */

        .hidden { display: none; }
        #import-file-input, #import-serial-csv-input, #modal-import-serial-csv-input { display: none; } /* Hide all file inputs */

        #sales-report-table { width: 100%; border-collapse: collapse; }
        #sales-report-table th, #sales-report-table td { border: 1px solid #e5e7eb; padding: 0.5rem; text-align: right; font-size: 0.875rem; vertical-align: top; }
        #sales-report-table th { background-color: #f9fafb; font-weight: 600; text-align: center;}
        #sales-report-table tfoot td { font-weight: bold; background-color: #f3f4f6; }
        #sales-report-table tbody tr.no-sales-day td { color: #9ca3af; font-style: italic; text-align: center; }
        #sales-report-table td.font-mono { font-family: monospace; }

        textarea { resize: vertical; min-height: 60px; font-family: inherit; }
        .required { color: #dc2626; margin-left: 2px; font-weight: bold; }
        button, label.button-like { /* Style label like a button */
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
            cursor: pointer;
            padding: 0.5rem 1rem; /* Example padding */
            border-radius: 0.375rem;
            font-weight: 500;
            text-align: center;
            display: inline-block; /* Make label behave like button */
        }
        button:disabled { cursor: default; opacity: 0.7; }

        /* --- Modal Styles (Generic) --- */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.5); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 0; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 0.5rem; box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19); animation-name: animatetop; animation-duration: 0.4s; display: flex; flex-direction: column; }
        @keyframes animatetop { from {top: -300px; opacity: 0} to {top: 0; opacity: 1} }
        .modal-header { padding: 0.75rem 1rem; background-color: #f9fafb; color: #1f2937; border-bottom: 1px solid #e5e7eb; border-top-left-radius: 0.5rem; border-top-right-radius: 0.5rem; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { margin: 0; font-size: 1.15em; font-weight: 600; }
        .modal-close-btn { color: #9ca3af; font-size: 24px; font-weight: bold; cursor: pointer; border: none; background: none; padding: 0;}
        .modal-close-btn:hover, .modal-close-btn:focus { color: #374151; text-decoration: none; }
        .modal-body { padding: 1rem 1.25rem; max-height: 70vh; overflow-y: auto; }
        .modal-footer { padding: 0.75rem 1rem; background-color: #f9fafb; border-top: 1px solid #e5e7eb; text-align: left; display: flex; justify-content: flex-start; flex-wrap: wrap; gap: 0.5rem; border-bottom-left-radius: 0.5rem; border-bottom-right-radius: 0.5rem; }
        .modal-footer button { padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 500; color: white; border: 1px solid transparent; transition: all 0.2s ease-in-out; cursor: pointer; }
        .modal-footer button.modal-close-btn-footer { background-color: #6b7280; border-color: #6b7280; margin-right: auto; margin-left: 0; } /* Adjusted margin */
        .modal-footer button.modal-close-btn-footer:hover { background-color: #4b5563; border-color: #4b5563;}

        /* --- Invoice Modal Specific Styles (Overrides) --- */
        #invoiceModal .modal-content { max-width: 800px; } /* Larger modal for invoice */
        #inv_printInvoiceBtn { background-color: #f59e0b; border-color: #f59e0b; color:#fff;}
        #inv_printInvoiceBtn:hover { background-color: #d97706; border-color: #d97706;}
        #inv_saveInvoiceBtn { background-color: #10b981; border-color: #10b981;}
        #inv_saveInvoiceBtn:hover { background-color: #059669; border-color: #059669;}

        /* --- Manage Serials Modal Specific Styles --- */
        #manageSerialsModal .modal-content { max-width: 500px; } /* Smaller modal */
        #modal_saveAddedSerialsBtn { background-color: #3b82f6; border-color: #2563eb; }
        #modal_saveAddedSerialsBtn:hover { background-color: #2563eb; border-color: #1d4ed8; }
        #modal_productNameDisplay { font-weight: 600; color: #1e40af; }
        #modal_serialCounts { font-size: 0.9em; color: #4b5563; margin-bottom: 1rem; }

        fieldset { border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1.25rem; }
        legend { font-weight: 600; color: #374151; padding: 0 0.5rem; font-size: 1rem; }
        .form-row { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem; align-items: flex-end; }
        .form-group { flex: 1; min-width: 150px; display: flex; flex-direction: column; }
        .form-group label { margin-bottom: 0.3rem; font-size: 0.875rem; color: #374151; font-weight: 500;}
        .inv-phone-entry { margin-bottom: 0.75rem; padding-bottom: 0.75rem; border-bottom: 1px dashed #e5e7eb; align-items: center; }
        .inv-phone-entry .form-group { flex-grow: 1; margin-bottom: 0; } /* Removed bottom margin */
        .remove-phone-btn { padding: 0.3rem 0.5rem; background-color: #f59e0b; color: white; border: none; border-radius: 0.375rem; cursor: pointer; font-size: 0.9em; margin-right: 0; margin-left: 0; flex-shrink: 0; height: fit-content; } /* Adjusted margin */
        .remove-phone-btn:hover { background-color: #d97706;}
        #inv_addPhoneBtn { padding: 0.5rem 0.75rem; background-color: #0ea5e9; color: white; border: none; border-radius: 0.375rem; cursor: pointer; margin-top: 0.25rem; font-size: 0.9em; }
        #inv_addPhoneBtn:hover { background-color: #0284c7; }
        .add-item-section { background-color: #f9fafb; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; margin-bottom: 1rem; }
        .add-item-section h4 { margin-top: 0; margin-bottom: 0.75rem; color: #4b5563; font-weight: 600; font-size: 1rem; }
        #inv_addItemBtn { background-color: #3b82f6; color: white; border-color: #3b82f6; width: auto; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 500; cursor: pointer; flex-shrink: 0; /* Prevent shrinking */ }
        #inv_addItemBtn:hover { background-color: #2563eb; border-color: #2563eb; }
        #inv_invoiceItemsTable { width: 100%; border-collapse: collapse; margin-top: 0.75rem; }
        #inv_invoiceItemsTable th, #inv_invoiceItemsTable td { border: 1px solid #e5e7eb; padding: 0.5rem; text-align: right; font-size: 0.9em; vertical-align: middle; }
        #inv_invoiceItemsTable th { background-color: #f3f4f6; font-weight: 600; text-align: center; }
        #inv_invoiceItemsTable tbody tr:nth-child(even) { background-color: #f9fafb; }
        #inv_invoiceItemsTable td.item-qty, #inv_invoiceItemsTable td.item-price, #inv_invoiceItemsTable td.item-subtotal { text-align: center; font-family: monospace; }
        #inv_invoiceItemsTable td .serial-display { font-size: 0.8em; color: #6b7280; display: block; margin-top: 2px; } /* Style for serial in invoice */
        .item-subtotal { font-weight: bold; }
        .remove-item-btn { color: #ef4444; background: none; border: none; font-weight: bold; cursor: pointer; font-size: 1.1em; padding: 0 5px; }
        .remove-item-btn:hover { color: #dc2626; }
        .serial-select-container { margin-top: 0.3rem; } /* Container for serial dropdown */
        .serial-select-container input[type="text"] { /* Style for serial search input */
             width: auto; /* Adjust width as needed */
             min-width: 150px;
             padding: 0.25rem 0.5rem;
             font-size: 0.85em;
             margin-bottom: 0.25rem; /* Space below search */
        }
        .serial-select-container select { font-size: 0.85em; padding: 0.25rem 0.5rem; width: auto; min-width: 150px; max-height: 100px; } /* Style for serial dropdown */

        #inv_deductibleCostsContainer { max-height: 100px; overflow-y: auto; border: 1px solid #e5e7eb; padding: 0.75rem; border-radius: 0.375rem; background-color: #f9fafb; margin-top: 1rem; }
        #inv_deductibleCostsContainer label { display: block; margin-bottom: 0.5rem; font-size: 0.875rem; cursor: pointer; padding: 4px; border-radius: 3px; }
        #inv_deductibleCostsContainer label:hover { background-color: #e5e7eb; }
        #inv_deductibleCostsContainer input[type="checkbox"] { margin-left: 0.5rem; cursor: pointer; vertical-align: middle; }
        .totals-display .form-group { flex-direction: row; align-items: center; justify-content: space-between; background-color: #f3f4f6; padding: 0.5rem 0.75rem; border-radius: 0.375rem; min-width: 180px; flex-basis: auto; margin-bottom: 0.5rem; }
        .totals-display label { margin-bottom: 0; font-weight: 600; white-space: nowrap; margin-left: 0.5rem; }
        .totals-display span, .totals-display strong { font-family: monospace; font-size: 1em; margin-right: 0.3rem; white-space: nowrap; }
        #inv_grandTotalPrice { color: #dc2626; font-size: 1.1em; }
        .error-message {
            color: #991b1b; background-color: #fee2e2; border: 1px solid #fca5a5;
            padding: 0.75rem; border-radius: 0.375rem; margin-top: 1rem;
            text-align: center; font-size: 0.9em; display: none;
        }
        .error-message.visible { display: block; }
        #inv_itemAddError { padding: 0.3rem 0.6rem; margin-top: 0.4rem; margin-bottom: 0.75rem; }
        .no-print { /* Applied via @media print */ }

        /* --- Print Styles --- */
        @media print {
            body { background-color: #ffffff !important; margin: 0; padding: 10px; font-size: 10pt; }
            section, .widget-card, .modal { display: none !important; } /* Hide all main sections & modals by default */
             #main-nav, footer, #global-message, #current-data-date, #current-time { display: none !important; } /* Hide time in footer */

            /* Show only specific sections for general report */
             body.print-report #summary-section,
             body.print-report #inventory-section,
             body.print-report #suppliers-section,
             body.print-report #debts-section,
             body.print-report #liabilities-section,
             body.print-report #log-section {
                 display: block !important;
                 box-shadow: none !important;
                 border: 1px solid #ccc !important;
                 margin-bottom: 15px !important;
                 border-radius: 0 !important;
                 padding: 10px !important;
             }
             body.print-report #inventory-section #add-update-product-form, /* Hide product input form */
             body.print-report #inventory-section #serial-number-entry-container, /* Hide serial number input */
             body.print-report #inventory-section label[for="product-deduct-liquidity"], /* Hide deduct checkbox */
             body.print-report #suppliers-section #add-update-supplier-form, /* Hide supplier input form */
             body.print-report #suppliers-section #serial-search-container, /* Hide serial search form */
             body.print-report #debts-section > div:not(#debtors-list-container), /* Hide input forms in debts */
             body.print-report #liabilities-section > div:not(#liabilities-list-container), /* Hide input forms in liabilities */
             body.print-report #log-section button,
             body.print-report #liquidity-adjustment-container { /* Hide liquidity adjustment form */
                  display: none !important;
             }
             body.print-report .product-actions, body.print-report .supplier-actions { display: none !important; }
             body.print-report #debtors-list details { page-break-inside: avoid; }
             body.print-report #debtors-list details > ul { display: block !important; } /* Ensure debt details are expanded */
             body.print-report #debtors-list summary { list-style: none; cursor: default; background-color: #eee !important; padding: 5px !important; }
             body.print-report #debtors-list summary::-webkit-details-marker { display: none !important; }
             body.print-report h2 { border-bottom: 1px solid #eee !important; font-size: 1.2em !important; page-break-after: avoid; }
             body.print-report h3 { font-size: 1.1em !important; page-break-after: avoid; }
             body.print-report .grid { display: block !important; } /* Simplify grid layouts */
             body.print-report table { font-size: 9pt !important; page-break-inside: auto; }
             body.print-report th, body.print-report td { padding: 4px !important; }
             body.print-report tr { page-break-inside: avoid; page-break-after: auto; }
             body.print-report thead { display: table-header-group; }
             body.print-report tfoot { display: table-footer-group; }


            /* Hide things not needed in any print */
            .no-print, #controls-section, #load-data-section, #pending-sales-section button, #consignment-value-display, #debtors-list button, #load-date-day-name-alt, #liquidity-section button, #liabilities-section button, #liabilities-list button, #settings-section button, #pending-sales-list button, #import-export-section, #offsetting-section, #sales-report-section button, #sales-report-section input, #sales-report-section label, #search-section, #openInvoiceModalBtn, #add-update-product-form button, #sell-product > div:first-of-type, #pending-sales-container h3, #liquidity-section > div:nth-of-type(2), #expenses-section > div:nth-of-type(2), #debts-section > div:nth-of-type(2), #debts-section > div:nth-of-type(3), #liabilities-section > div:nth-of-type(2), #offsetting-section > div:nth-of-type(1), #log-section button, #add-update-supplier-form button, #suppliers-list-container button,
            #pending-sales-controls /* Hide pending sales search/totals in print */ {
                 display: none !important;
             }

            /* Invoice Modal Print Specifics */
            body.print-invoice #main-content { display: none !important; } /* Hide main app when printing invoice */
            body.print-invoice #invoicePrintArea { display: block !important; }
            body.print-invoice .invoice-modal-content { border: none !important; box-shadow: none !important; margin: 0 !important; max-width: 100% !important; border-radius: 0 !important; animation: none !important; }
            body.print-invoice .invoice-modal-body { max-height: none !important; overflow: visible !important; padding: 0 !important; }
            body.print-invoice .no-print { display: none !important; }
            body.print-invoice #inv_invoiceItemsTable { font-size: 9pt !important; }
            body.print-invoice #inv_invoiceItemsTable th, body.print-invoice #inv_invoiceItemsTable td { padding: 4px !important; }
            body.print-invoice .serial-display-print { display: block !important; font-size: 0.8em; color: #555; } /* Show serial in print */

        }
        /* --- START: FINANCIAL CENTER STYLES --- */
.fc-main-tabs button.active { border-color: #3b82f6; color: #3b82f6; background-color: #eff6ff; }
.fc-form-input, .fc-form-select { border: 1px solid #d1d5db; border-radius: 0.375rem; padding: 0.5rem 0.75rem; width: 100%; transition: all 0.2s; }
.fc-form-input:focus, .fc-form-select:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
.fc-step-card { background-color: white; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.07); border: 1px solid #e5e7eb; margin-bottom: 1.5rem; }
.fc-step-card h3 { font-size: 1.25rem; font-weight: 700; color: #1e3a8a; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; gap: 0.75rem; }
.fc-step-card h3 .fc-step-number { background-color: #3b82f6; color: white; height: 2rem; width: 2rem; border-radius: 9999px; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; }
.fc-preview-card { transition: all 0.4s ease-in-out; max-height: 0; overflow: hidden; opacity: 0; border-width: 2px; }
.fc-preview-card.visible { max-height: 1500px; opacity: 1; margin-top: 1.5rem; }
.fc-manual-dist-input { width: 80px; text-align: center; }
.fc-disabled-section { opacity: 0.45; pointer-events: none; user-select: none; background-color: #f9fafb; }
/* --- END: FINANCIAL CENTER STYLES --- */
#undo-button:disabled, #redo-button:disabled {
    background-color: #fed7aa; /* لون برتقالي باهت */
    color: #7c2d12;           /* لون بني داكن للنص */
    opacity: 0.7;
    cursor: not-allowed;
}
    </style>
    <style>
        /* TailwindCSS Utility Class Placeholders (Copied for reference, not dynamically generated) */
        *, ::before, ::after{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }
        *,::after,::before{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}::after,::before{--tw-content:''}
        html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}
        body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0;padding:0}legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default; opacity: 0.7;}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]{display:none} /* Simplified */
        .col-span-full{grid-column:1 / -1}.mb-1{margin-bottom:0.25rem}.mb-2{margin-bottom:0.5rem}.mb-3{margin-bottom:0.75rem}.mb-4{margin-bottom:1rem}.mb-6{margin-bottom:1.5rem}.ml-2{margin-left:0.5rem}.mt-1{margin-top:0.25rem}.mt-10{margin-top:2.5rem}.mt-2{margin-top:0.5rem}.mt-3{margin-top:0.75rem}.mt-4{margin-top:1rem}.mt-6{margin-top:1.5rem}.mt-8{margin-top:2rem}.block{display:block}.flex{display:flex}.inline-flex{display:inline-flex}.grid{display:grid}.hidden{display:none}.max-h-\[50vh\]{max-height:50vh}.max-h-\[60vh\]{max-height:60vh}.w-52{width:13rem}.w-full{width:100%}.min-w-\[50px\]{min-width:50px}.min-w-full{min-width:100%}.flex-shrink-0{flex-shrink:0}.cursor-pointer{cursor:pointer}.list-disc{list-style-type:disc}.grid-cols-1{grid-template-columns:repeat(1, minmax(0, 1fr))}.flex-col{flex-direction:column}.flex-wrap{flex-wrap:wrap}.items-start{align-items:flex-start}.items-end{align-items:flex-end}.items-center{align-items:center}.justify-start{justify-content:flex-start}.justify-end{justify-content:flex-end}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-1{gap:0.25rem}.gap-2{gap:0.5rem}.gap-4{gap:1rem}.gap-6{gap:1.5rem}.space-y-2 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(0.5rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(0.5rem * var(--tw-space-y-reverse))}.space-y-3 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(0.75rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(0.75rem * var(--tw-space-y-reverse))}.overflow-hidden{overflow:hidden}.overflow-x-auto{overflow-x:auto}.overflow-y-auto{overflow-y:auto}.rounded{border-radius:0.25rem}.rounded-lg{border-radius:0.5rem}.rounded-md{border-radius:0.375rem}.border{border-width:1px}.border-b{border-bottom-width:1px}.border-l{border-left-width:1px}.border-t{border-top-width:1px}.border-blue-200{--tw-border-opacity:1;border-color:rgb(191 219 254 / var(--tw-border-opacity, 1))}.border-gray-200{--tw-border-opacity:1;border-color:rgb(229 231 235 / var(--tw-border-opacity, 1))}.border-gray-300{--tw-border-opacity:1;border-color:rgb(209 213 219 / var(--tw-border-opacity, 1))}.border-green-200{--tw-border-opacity:1;border-color:rgb(187 247 208 / var(--tw-border-opacity, 1))}.border-indigo-200{--tw-border-opacity:1;border-color:rgb(199 210 254 / var(--tw-border-opacity, 1))}.border-indigo-300{--tw-border-opacity:1;border-color:rgb(165 180 252 / var(--tw-border-opacity, 1))}.border-pink-200{--tw-border-opacity:1;border-color:rgb(251 207 232 / var(--tw-border-opacity, 1))}.border-purple-200{--tw-border-opacity:1;border-color:rgb(233 213 255 / var(--tw-border-opacity, 1))}.border-red-200{--tw-border-opacity:1;border-color:rgb(254 202 202 / var(--tw-border-opacity, 1))}.border-teal-200{--tw-border-opacity:1;border-color:rgb(153 246 228 / var(--tw-border-opacity, 1))}.border-yellow-200{--tw-border-opacity:1;border-color:rgb(254 240 138 / var(--tw-border-opacity, 1))}.border-gray-100{--tw-border-opacity:1;border-color:rgb(243 244 246 / var(--tw-border-opacity, 1))}.border-red-400{--tw-border-opacity:1;border-color:rgb(248 113 113 / var(--tw-border-opacity, 1))}.border-green-400{--tw-border-opacity:1;border-color:rgb(74 222 128 / var(--tw-border-opacity, 1))}.border-yellow-500{--tw-border-opacity:1;border-color:rgb(234 179 8 / var(--tw-border-opacity, 1))}.border-red-600{--tw-border-opacity:1;border-color:rgb(220 38 38 / var(--tw-border-opacity, 1))}.border-green-700{--tw-border-opacity:1;border-color:rgb(21 128 61 / var(--tw-border-opacity, 1))}.border-yellow-700{--tw-border-opacity:1;border-color:rgb(161 98 7 / var(--tw-border-opacity, 1))}.border-teal-600{--tw-border-opacity:1;border-color:rgb(13 148 136 / var(--tw-border-opacity, 1))}.bg-blue-50{--tw-bg-opacity:1;background-color:rgb(239 246 255 / var(--tw-bg-opacity, 1))}.bg-blue-500{--tw-bg-opacity:1;background-color:rgb(59 130 246 / var(--tw-bg-opacity, 1))}.bg-cyan-500{--tw-bg-opacity:1;background-color:rgb(6 182 212 / var(--tw-bg-opacity, 1))}.bg-gray-200{--tw-bg-opacity:1;background-color:rgb(229 231 235 / var(--tw-bg-opacity, 1))}.bg-gray-400{--tw-bg-opacity:1;background-color:rgb(156 163 175 / var(--tw-bg-opacity, 1))}.bg-gray-50{--tw-bg-opacity:1;background-color:rgb(249 250 251 / var(--tw-bg-opacity, 1))}.bg-green-50{--tw-bg-opacity:1;background-color:rgb(240 253 244 / var(--tw-bg-opacity, 1))}.bg-green-500{--tw-bg-opacity:1;background-color:rgb(34 197 94 / var(--tw-bg-opacity, 1))}.bg-indigo-50{--tw-bg-opacity:1;background-color:rgb(238 242 255 / var(--tw-bg-opacity, 1))}.bg-indigo-500{--tw-bg-opacity:1;background-color:rgb(99 102 241 / var(--tw-bg-opacity, 1))}.bg-orange-500{--tw-bg-opacity:1;background-color:rgb(249 115 22 / var(--tw-bg-opacity, 1))}.bg-pink-50{--tw-bg-opacity:1;background-color:rgb(253 242 248 / var(--tw-bg-opacity, 1))}.bg-purple-50{--tw-bg-opacity:1;background-color:rgb(250 245 255 / var(--tw-bg-opacity, 1))}.bg-purple-500{--tw-bg-opacity:1;background-color:rgb(168 85 247 / var(--tw-bg-opacity, 1))}.bg-red-50{--tw-bg-opacity:1;background-color:rgb(254 242 242 / var(--tw-bg-opacity, 1))}.bg-red-500{--tw-bg-opacity:1;background-color:rgb(239 68 68 / var(--tw-bg-opacity, 1))}.bg-rose-500{--tw-bg-opacity:1;background-color:rgb(244 63 94 / var(--tw-bg-opacity, 1))}.bg-teal-50{--tw-bg-opacity:1;background-color:rgb(240 253 250 / var(--tw-bg-opacity, 1))}.bg-teal-500{--tw-bg-opacity:1;background-color:rgb(20 184 166 / var(--tw-bg-opacity, 1))}.bg-yellow-50{--tw-bg-opacity:1;background-color:rgb(254 252 232 / var(--tw-bg-opacity, 1))}.bg-yellow-500{--tw-bg-opacity:1;background-color:rgb(234 179 8 / var(--tw-bg-opacity, 1))}.bg-white{--tw-bg-opacity:1;background-color:rgb(255 255 255 / var(--tw-bg-opacity, 1))}.bg-yellow-400{--tw-bg-opacity:1;background-color:rgb(250 204 21 / var(--tw-bg-opacity, 1))}.bg-red-100{--tw-bg-opacity:1;background-color:rgb(254 226 226 / var(--tw-bg-opacity, 1))}.bg-green-100{--tw-bg-opacity:1;background-color:rgb(220 252 231 / var(--tw-bg-opacity, 1))}.p-2{padding:0.5rem}.p-3{padding:0.75rem}.p-4{padding:1rem}.p-6{padding:1.5rem}.px-2{padding-left:0.5rem;padding-right:0.5rem}.px-3{padding-left:0.75rem;padding-right:0.75rem}.px-4{padding-left:1rem;padding-right:1rem}.py-1{padding-top:0.25rem;padding-bottom:0.25rem}.py-2{padding-top:0.5rem;padding-bottom:0.5rem}.py-4{padding-top:1rem;padding-bottom:1rem}.py-1\.5{padding-top:0.375rem;padding-bottom:0.375rem}.pb-4{padding-bottom:1rem}.pl-4{padding-left:1rem}.pl-5{padding-left:1.25rem}.pt-4{padding-top:1rem}.pt-6{padding-top:1.5rem}.pb-1{padding-bottom:0.25rem}.pt-2{padding-top:0.5rem}.pt-3{padding-top:0.75rem}.text-center{text-align:center}.text-right{text-align:right}.font-mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}.text-2xl{font-size:1.5rem;line-height:2rem}.text-3xl{font-size:1.875rem;line-height:2.25rem}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-sm{font-size:0.875rem;line-height:1.25rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-xs{font-size:0.75rem;line-height:1rem}.font-bold{font-weight:700}.font-medium{font-weight:500}.font-semibold{font-weight:600}.text-blue-600{--tw-text-opacity:1;color:rgb(37 99 235 / var(--tw-text-opacity, 1))}.text-blue-700{--tw-text-opacity:1;color:rgb(29 78 216 / var(--tw-text-opacity, 1))}.text-blue-800{--tw-text-opacity:1;color:rgb(30 64 175 / var(--tw-text-opacity, 1))}.text-gray-500{--tw-text-opacity:1;color:rgb(107 114 128 / var(--tw-text-opacity, 1))}.text-gray-600{--tw-text-opacity:1;color:rgb(75 85 99 / var(--tw-text-opacity, 1))}.text-gray-700{--tw-text-opacity:1;color:rgb(55 65 81 / var(--tw-text-opacity, 1))}.text-green-600{--tw-text-opacity:1;color:rgb(22 163 74 / var(--tw-text-opacity, 1))}.text-green-700{--tw-text-opacity:1;color:rgb(21 128 61 / var(--tw-text-opacity, 1))}.text-green-800{--tw-text-opacity:1;color:rgb(22 101 52 / var(--tw-text-opacity, 1))}.text-indigo-600{--tw-text-opacity:1;color:rgb(79 70 229 / var(--tw-text-opacity, 1))}.text-indigo-700{--tw-text-opacity:1;color:rgb(67 56 202 / var(--tw-text-opacity, 1))}.text-indigo-800{--tw-text-opacity:1;color:rgb(55 48 163 / var(--tw-text-opacity, 1))}.text-pink-700{--tw-text-opacity:1;color:rgb(190 24 93 / var(--tw-text-opacity, 1))}.text-pink-800{--tw-text-opacity:1;color:rgb(157 23 77 / var(--tw-text-opacity, 1))}.text-purple-700{--tw-text-opacity:1;color:rgb(126 34 206 / var(--tw-text-opacity, 1))}.text-purple-800{--tw-text-opacity:1;color:rgb(107 33 168 / var(--tw-text-opacity, 1))}.text-red-700{--tw-text-opacity:1;color:rgb(185 28 28 / var(--tw-text-opacity, 1))}.text-red-600{--tw-text-opacity:1;color:rgb(220 38 38 / var(--tw-text-opacity, 1))}.text-red-800{--tw-text-opacity:1;color:rgb(153 27 27 / var(--tw-text-opacity, 1))}.text-teal-700{--tw-text-opacity:1;color:rgb(15 118 110 / var(--tw-text-opacity, 1))}.text-teal-800{--tw-text-opacity:1;color:rgb(17 94 89 / var(--tw-text-opacity, 1))}.text-white{--tw-text-opacity:1;color:rgb(255 255 255 / var(--tw-text-opacity, 1))}.text-yellow-600{--tw-text-opacity:1;color:rgb(202 138 4 / var(--tw-text-opacity, 1))}.text-yellow-700{--tw-text-opacity:1;color:rgb(161 98 7 / var(--tw-text-opacity, 1))}.text-yellow-800{--tw-text-opacity:1;color:rgb(133 77 14 / var(--tw-text-opacity, 1))}.text-blue-500{--tw-text-opacity:1;color:rgb(59 130 246 / var(--tw-text-opacity, 1))}.text-gray-400{--tw-text-opacity:1;color:rgb(156 163 175 / var(--tw-text-opacity, 1))}.text-gray-800{--tw-text-opacity:1;color:rgb(31 41 55 / var(--tw-text-opacity, 1))}.text-purple-500{--tw-text-opacity:1;color:rgb(168 85 247 / var(--tw-text-opacity, 1))}.text-yellow-900{--tw-text-opacity:1;color:rgb(113 63 18 / var(--tw-text-opacity, 1))}.text-teal-500{--tw-text-opacity:1;color:rgb(20 184 166 / var(--tw-bg-opacity, 1))}.text-cyan-600{--tw-text-opacity:1;color:rgb(8 145 178 / var(--tw-text-opacity, 1))}.shadow-sm{--tw-shadow:0 1px 2px 0 rgb(0 0 0 / 0.05);--tw-shadow-colored:0 1px 2px 0 var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow{--tw-shadow:0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 1px 3px 0 var(--tw-shadow-color), 0 1px 2px -1px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.flex-grow{flex-grow:1}.hover\:bg-blue-600:hover{--tw-bg-opacity:1;background-color:rgb(37 99 235 / var(--tw-bg-opacity, 1))}.hover\:bg-cyan-600:hover{--tw-bg-opacity:1;background-color:rgb(8 145 178 / var(--tw-bg-opacity, 1))}.hover\:bg-gray-300:hover{--tw-bg-opacity:1;background-color:rgb(209 213 219 / var(--tw-bg-opacity, 1))}.hover\:bg-gray-500:hover{--tw-bg-opacity:1;background-color:rgb(107 114 128 / var(--tw-bg-opacity, 1))}.hover\:bg-green-600:hover{--tw-bg-opacity:1;background-color:rgb(22 163 74 / var(--tw-bg-opacity, 1))}.hover\:bg-indigo-600:hover{--tw-bg-opacity:1;background-color:rgb(79 70 229 / var(--tw-bg-opacity, 1))}.hover\:bg-orange-600:hover{--tw-bg-opacity:1;background-color:rgb(234 88 12 / var(--tw-bg-opacity, 1))}.hover\:bg-purple-600:hover{--tw-bg-opacity:1;background-color:rgb(147 51 234 / var(--tw-bg-opacity, 1))}.hover\:bg-red-600:hover{--tw-bg-opacity:1;background-color:rgb(220 38 38 / var(--tw-bg-opacity, 1))}.hover\:bg-rose-600:hover{--tw-bg-opacity:1;background-color:rgb(225 29 72 / var(--tw-bg-opacity, 1))}.hover\:bg-teal-600:hover{--tw-bg-opacity:1;background-color:rgb(13 148 136 / var(--tw-bg-opacity, 1))}.hover\:bg-yellow-600:hover{--tw-bg-opacity:1;background-color:rgb(202 138 4 / var(--tw-bg-opacity, 1))}.hover\:bg-gray-100:hover{--tw-bg-opacity:1;background-color:rgb(243 244 246 / var(--tw-bg-opacity, 1))}.hover\:bg-yellow-500:hover{--tw-bg-opacity:1;background-color:rgb(234 179 8 / var(--tw-bg-opacity, 1))}.hover\:underline:hover{-webkit-text-decoration-line:underline;text-decoration-line:underline}.focus\:border-blue-300:focus{--tw-border-opacity:1;border-color:rgb(147 197 253 / var(--tw-border-opacity, 1))}.focus\:border-indigo-300:focus{--tw-border-opacity:1;border-color:rgb(165 180 252 / var(--tw-border-opacity, 1))}.focus\:ring:focus{--tw-ring-offset-shadow:var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);--tw-ring-shadow:var(--tw-ring-inset) 0 0 0 calc(3px + var(--tw-ring-offset-width)) var(--tw-ring-color);box-shadow:var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000)}.focus\:ring-blue-200:focus{--tw-ring-opacity:1;--tw-ring-color:rgb(191 219 254 / var(--tw-ring-opacity, 1))}.focus\:ring-indigo-200:focus{--tw-ring-opacity:1;--tw-ring-color:rgb(199 210 254 / var(--tw-ring-opacity, 1))}.focus\:ring-opacity-50:focus{--tw-ring-opacity:0.5}.focus\:ring-offset-0:focus{--tw-ring-offset-width:0px}
        @media (min-width: 640px){.sm\:w-auto{width:auto}.sm\:grid-cols-2{grid-template-columns:repeat(2, minmax(0, 1fr))}.sm\:flex-row{flex-direction:row}}
        @media (min-width: 768px){.md\:col-span-1{grid-column:span 1 / span 1}.md\:col-start-1{grid-column-start:1}.md\:grid-cols-2{grid-template-columns:repeat(2, minmax(0, 1fr))}.md\:grid-cols-3{grid-template-columns:repeat(3, minmax(0, 1fr))}.md\:gap-4{gap:1rem}.md\:border-l-0{border-left-width:0px}.md\:border-r{border-right-width:1px}.md\:pl-0{padding-left:0px}.md\:pr-4{padding-right:1rem}}
        @media (min-width: 1024px){.lg\:grid-cols-3{grid-template-columns:repeat(3, minmax(0, 1fr))}.lg\:grid-cols-4{grid-template-columns:repeat(4, minmax(0, 1fr))}}
    </style>
</head><body class="p-6">

    <div id="main-content">
        <h1 class="text-3xl font-semibold text-center text-blue-600 mb-4">برنامج إدارة البضائع</h1>
        <p class="text-center text-sm text-gray-500 mb-2">البيانات المعروضة حاليًا لتاريخ: <span id="current-data-date" class="font-semibold"></span></p>
        <div id="global-message" class="section-message"></div>
        <div id="main-nav" class="flex flex-wrap justify-center gap-2 mb-6 border-b pb-4">
            <button class="nav-button active" data-target="summary-section">الملخص</button>
            <button class="nav-button" data-target="inventory-section">المخزون والإضافة</button>
            <button class="nav-button" data-target="suppliers-section">الموردين والبحث التسلسلي</button>
            <button class="nav-button" data-target="sell-product">بيع بضاعة / فاتورة</button>
            <button class="nav-button" data-target="liquidity-section">السيولة والتعديل</button> 
            <button class="nav-button" data-target="debts-section">الديون (لك)</button>
            <button class="nav-button" data-target="liabilities-section">الالتزامات (عليك)</button>
            <button class="nav-button" data-target="offsetting-section">المقاصة</button>
            <button class="nav-button" data-target="sales-report-section">تقرير المبيعات</button>
            <button class="nav-button" data-target="financial-center-section">المركز المالي</button>
            <button class="nav-button" data-target="search-section">بحث الفواتير</button>
            <button class="nav-button" data-target="log-section">السجل العام</button>
            <button class="nav-button" data-target="settings-section">تحميل/حفظ/إعدادات</button>
        </div>
        <div id="undo-redo-controls" class="mb-4 flex justify-center gap-4">
    <button id="undo-button" class="bg-orange-500 hover:bg-orange-600 text-black font-bold py-2 px-4 rounded" disabled>تراجع</button>
    <button id="redo-button" class="bg-yellow-400 hover:bg-yellow-500 text-black font-bold py-2 px-4 rounded" disabled>إعادة</button>
</div>
        

         <div id="content-area"><section id="summary-section" class="widget-card content-section">
                <h2>الملخص المالي ورأس المال</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                        <h3 class="text-sm font-medium text-blue-700 mb-1">السيولة المتاحة</h3>
                        <div id="summary-current-liquidity" class="text-xl font-bold text-blue-800">0.00 جنيه</div>
                    </div>
                    <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-200">
                        <h3 class="text-sm font-medium text-indigo-700 mb-1">قيمة المخزون</h3>
                        <div id="summary-total-inventory-value" class="text-xl font-bold text-indigo-800">0.00 جنيه</div>
                    </div>
                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                        <h3 class="text-sm font-medium text-yellow-700 mb-1">قيمة بضاعة مؤقتة</h3>
                        <div id="summary-consignment-value-display" class="text-xl font-bold text-yellow-800">0.00 جنيه</div>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                        <h3 class="text-sm font-medium text-purple-700 mb-1">إجمالي الديون (لك)</h3>
                        <div id="summary-total-debts-display" class="text-xl font-bold text-purple-800">0.00 جنيه</div>
                    </div>
                    <div class="bg-pink-50 p-4 rounded-lg border border-pink-200">
                        <h3 class="text-sm font-medium text-pink-700 mb-1">إجمالي الالتزامات (عليك)</h3>
                        <div id="summary-total-liabilities-display" class="text-xl font-bold text-pink-800">0.00 جنيه</div>
                    </div>
                    <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                        <h3 class="text-sm font-medium text-red-700 mb-1">إجمالي المصروفات</h3>
                        <div id="summary-total-expenses" class="text-xl font-bold text-red-800">0.00 جنيه</div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                        <h3 class="text-sm font-medium text-green-700 mb-1">إجمالي الربح</h3>
                        <div id="summary-total-profit" class="text-xl font-bold text-green-800">0.00 جنيه</div>
                    </div>
                    <div class="bg-teal-50 p-4 rounded-lg border border-teal-200">
                        <h3 class="text-sm font-medium text-teal-700 mb-1">رأس المال</h3>
                        <div id="summary-total-capital" class="text-xl font-bold text-teal-800">0.00 جنيه</div>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
    <h3 class="text-sm font-medium text-blue-700 mb-1">رأس المال المتوقع</h3>
    <div id="summary-expected-capital" class="text-xl font-bold text-blue-800">0.00 جنيه</div>
    
</div>
                </div>
            </section>
           <section id="financial-center-section" class="content-section hidden">
    <div class="max-w-7xl mx-auto">
        <div class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-semibold text-gray-800">
                <i class="fas fa-landmark text-blue-600"></i>
                المركز المالي الشامل
            </h1>
            <p class="text-gray-500 mt-2">نقطة التحكم المركزية لإدارة وتحليل جميع تكاليف ومصاريف عملك.</p>
        </div>

        <div id="fc-main-tabs" class="flex flex-wrap justify-center border-b border-gray-200 mb-6 -mx-6 px-6">
            <button class="fc-tab-button active flex items-center gap-2 text-base font-semibold py-3 px-4 border-b-2 border-transparent hover:border-gray-300 hover:text-gray-600 focus:outline-none" data-target="fc-tab-distribution"><i class="fas fa-sitemap"></i><span>توزيع التكاليف</span></button>
            <button class="fc-tab-button flex items-center gap-2 text-base font-semibold py-3 px-4 border-b-2 border-transparent hover:border-gray-300 hover:text-gray-600 focus:outline-none" data-target="fc-tab-debt-treatment"><i class="fas fa-heart-broken"></i><span>معالجة الديون</span></button>
            <button class="fc-tab-button flex items-center gap-2 text-base font-semibold py-3 px-4 border-b-2 border-transparent hover:border-gray-300 hover:text-gray-600 focus:outline-none" data-target="fc-tab-expenses"><i class="fas fa-receipt"></i><span>المصاريف التشغيلية</span></button>
            <button class="fc-tab-button flex items-center gap-2 text-base font-semibold py-3 px-4 border-b-2 border-transparent hover:border-gray-300 hover:text-gray-600 focus:outline-none" data-target="fc-tab-fixed-liabilities"><i class="fas fa-calendar-alt"></i><span>الإلتزامات الثابتة</span></button>
        </div>

        <div>
            <div id="fc-tab-distribution" class="fc-tab-content">
                <div class="fc-step-card">
                    <h3><span class="fc-step-number">1</span>اختر الشهر للتحليل</h3>
                    <select id="fc-distribution-month" class="fc-form-select max-w-xs"></select>
                </div>
                <div class="fc-step-card">
                    <h3><span class="fc-step-number">2</span>حدد إجمالي التكلفة</h3>
                    <div class="space-y-4">
                        <div><label class="flex items-center p-2 rounded-md hover:bg-gray-100 cursor-pointer"><input type="radio" name="fc-cost-mode" value="auto" id="fc-auto-cost-mode-radio" class="ml-2" checked><strong>حساب التكلفة تلقائياً</strong> (من المصاريف المحددة أدناه)</label></div>
                        <div id="fc-expenses-selection-wrapper"><div id="fc-expenses-to-distribute-list" class="space-y-2 mt-2 ml-6 border-r-2 border-gray-200 pr-4"></div></div>
                        <hr class="my-4">
                        <div>
                            <label class="flex items-center p-2 rounded-md hover:bg-gray-100 cursor-pointer"><input type="radio" name="fc-cost-mode" value="manual" id="fc-manual-cost-mode-radio" class="ml-2"><strong>توزيع مبلغ تكلفة ثابت (يدوي)</strong></label>
                            <div id="fc-manual-cost-input-wrapper" class="hidden mt-2 ml-6">
                                <label for="fc-manual-cost-input" class="block text-sm font-medium text-gray-700">المبلغ الإجمالي للتوزيع</label>
                                <input type="number" id="fc-manual-cost-input" class="fc-form-input mt-1 max-w-xs" placeholder="أدخل مبلغاً ثابتاً">
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-center"><span class="text-gray-700 font-medium">إجمالي المبلغ المحدد للتوزيع: </span><strong id="fc-total-selected-expenses" class="text-blue-800 text-lg">0.00 جنيه</strong></div>
                </div>
                <div class="fc-step-card">
                    <h3><span class="fc-step-number">3</span>اختر المنتجات لتحميل التكاليف عليها</h3>
                    <div id="fc-products-to-load-list" class="space-y-2"></div>
                </div>
                <div class="fc-step-card">
                    <h3><span class="fc-step-number">4</span>اختر طريقة التوزيع</h3>
                    <div class="mt-4 space-y-3">
                        <label class="flex items-center p-3 bg-gray-50 rounded-md hover:bg-gray-100 cursor-pointer border"><input type="radio" name="fc-distribution-method" value="quantity" class="ml-3" checked>التوزيع بالتساوي على كل قطعة</label>
                        <label class="flex items-center p-3 bg-gray-50 rounded-md hover:bg-gray-100 cursor-pointer border"><input type="radio" name="fc-distribution-method" value="value" class="ml-3">التوزيع كنسبة من قيمة البضاعة</label>
                        <label class="flex items-center p-3 bg-gray-50 rounded-md hover:bg-gray-100 cursor-pointer border"><input type="radio" name="fc-distribution-method" value="manual" id="fc-distribution-manual-radio" class="ml-3">توزيع يدوي (تحديد النسب)</label>
                    </div>
                </div>
                <div id="fc-manual-distribution-container" class="fc-step-card hidden border-orange-500 bg-orange-50">
                    <h3><span class="fc-step-number bg-orange-500">!</span>تحديد نسب التوزيع اليدوي</h3>
                    <div id="fc-manual-percentage-list" class="space-y-2"></div>
                    <div class="mt-4 p-2 text-center rounded-md" id="fc-percentage-total-feedback"><span class="font-semibold">المجموع: </span><strong id="fc-percentage-total">0%</strong></div>
                </div>
                <div id="fc-cost-preview-container" class="fc-preview-card fc-step-card border-green-500 bg-green-50">
                    <h3 class="text-green-800 border-green-300"><span class="fc-step-number bg-green-600">✓</span>محاكاة النتائج</h3>
                    <div id="fc-cost-preview-results" class="space-y-3 text-gray-700"></div>
                    <div class="mt-6 border-t border-green-300 pt-4 text-center">
                        <p class="text-sm text-green-700 mb-3">عند الضغط على "تنفيذ"، سيتم تحديث متوسط تكلفة هذه المنتجات بشكل دائم في بيانات اليوم الحالي.</p>
                        <button id="fc-execute-distribution-btn" class="w-full md:w-auto bg-green-500 text-white font-bold py-2 px-6 rounded-md hover:bg-green-600 focus:outline-none">تنفيذ وتحديث التكاليف</button>
                    </div>
                </div>
            </div>
            
            <div id="fc-tab-debt-treatment" class="fc-tab-content hidden">
                 <div class="fc-step-card">
                    <h3><span class="fc-step-number">1</span>اختر الدين المتعثر للمعالجة</h3>
                    <p class="text-xs text-gray-500 mb-2">هذه الميزة تقوم بتحويل دين متعثر إلى التزام شهري ثابت ليتم توزيعه على المنتجات مستقبلاً.</p>
                    <select id="fc-debt-to-process" class="fc-form-select"></select>
                </div>
                <div class="fc-step-card">
                    <h3><span class="fc-step-number">2</span>حدد فترة توزيع التكلفة</h3>
                    <div class="grid md:grid-cols-2 gap-4 items-center">
                        <input type="number" id="fc-distribution-period-value" class="fc-form-input" value="3" min="1">
                        <select id="fc-distribution-period-unit" class="fc-form-select">
                            <option value="months">شهور</option>
                        </select>
                    </div>
                </div>
                 <div class="mt-6 text-center">
                    <button id="fc-execute-debt-treatment-btn" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 text-lg">تحويل الدين إلى التزام شهري</button>
                 </div>
            </div>

            <div id="fc-tab-expenses" class="fc-tab-content hidden">
                <div id="total-expenses" class="text-2xl font-bold text-red-700 mb-4">0.00 جنيه</div>
                <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="add-expense" class="block text-gray-700 text-sm font-bold mb-2">إضافة مصروف:<span class="required">*</span></label>
                        <input type="number" id="add-expense" value="0" min="0.01" step="0.01" class="shadow-sm">
                        <button id="add-expense-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded mt-2 w-full">إضافة</button>
                    </div>
                    <div>
                        <label for="remove-expense" class="block text-gray-700 text-sm font-bold mb-2">تقليل مصروف:<span class="required">*</span></label>
                        <input type="number" id="remove-expense" value="0" min="0.01" step="0.01" class="shadow-sm">
                        <button id="remove-expense-button" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded mt-2 w-full">تقليل</button>
                    </div>
                </div>
                <div id="expenses-message" class="section-message mt-3"></div>
            </div>

            <div id="fc-tab-fixed-liabilities" class="fc-tab-content hidden">
                <fieldset class="mb-6 pb-4 border-b">
                    <legend>إدارة الالتزامات الشهرية الثابتة</legend>
                    <p class="text-xs text-gray-500 mb-3">أضف هنا الالتزامات التي تتكرر كل شهر (مثل الإيجار والرواتب). سيقوم البرنامج بإضافتها تلقائياً إلى قائمة "الالتزامات (عليك)" في بداية كل شهر جديد.</p>
                    <div id="add-update-monthly-liability-form">
                        <h4 id="monthly-liability-form-title" class="text-md font-semibold mb-2">إضافة التزام شهري جديد</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                            <div class="form-group">
                                <label for="monthly-liability-name" class="block text-sm font-bold mb-1">اسم الالتزام:<span class="required">*</span></label>
                                <input type="text" id="monthly-liability-name" placeholder="مثال: إيجار المحل" class="shadow-sm">
                            </div>
                            <div class="form-group">
                                <label for="monthly-liability-amount" class="block text-sm font-bold mb-1">المبلغ الشهري:<span class="required">*</span></label>
                                <input type="number" id="monthly-liability-amount" placeholder="0.00" min="0.01" step="0.01" class="shadow-sm">
                            </div>
                            <div class="form-group">
                                <button id="add-monthly-liability-button" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded">إضافة / تحديث</button>
                            </div>
                        </div>
                        <button id="cancel-edit-monthly-liability-button" class="text-xs bg-gray-400 hover:bg-gray-500 text-white font-bold py-1 px-2 rounded mt-2 hidden">إلغاء التعديل</button>
                        <div id="monthly-liability-message" class="section-message mt-3"></div>
                    </div>
                    <div class="mt-4 border-t pt-4">
                        <h4 class="text-md font-semibold mb-2">الالتزامات الشهرية المسجلة حالياً:</h4>
                        <ul id="monthly-liabilities-list" class="space-y-2">
                            <li class="text-center text-gray-500">لا توجد التزامات شهرية مسجلة.</li>
                        </ul>
                    </div>
                </fieldset>
            </div>
        </div>
    </div>
</section>
            <section id="inventory-section" class="widget-card content-section hidden">
                <div id="add-update-product-form">
                    <h2 id="product-form-title">إضافة / تحديث بضاعة</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="mb-4">
                            <label for="product-name" class="block text-gray-700 text-sm font-bold mb-2">اسم البضاعة:<span class="required">*</span></label>
                            <input type="text" id="product-name" placeholder="اسم المنتج" class="shadow-sm" list="product-names-list">
                            <datalist id="product-names-list"></datalist>
                        </div>
                        <div class="mb-4">
                            <label for="product-quantity" class="block text-gray-700 text-sm font-bold mb-2">الكمية:<span class="required">*</span></label>
                            <input type="number" id="product-quantity" value="0" min="0" class="shadow-sm">
                            <p class="text-xs text-gray-500 mt-1">عند الإضافة: الكمية المضافة. عند التعديل: الكمية الجديدة الكلية.</p>
                        </div>
                        <div class="mb-4">
                            <label for="product-cost-price" class="block text-gray-700 text-sm font-bold mb-2">سعر التكلفة (للوحدة):<span class="required">*</span></label>
                            <input type="number" id="product-cost-price" value="0" min="0" step="0.01" class="shadow-sm">
                            <p class="text-xs text-gray-500 mt-1">عند الإضافة: يتم حساب المتوسط. عند التعديل: يتم استبدال السعر.</p>
                        </div>
                        <div class="mb-4">
                            <label for="product-supplier" class="block text-gray-700 text-sm font-bold mb-2">المورد (اختياري):</label>
                            <select id="product-supplier" class="shadow-sm">
                                <option value="">-- اختر المورد --</option>
                                </select>
                        </div>
                         <div class="mb-4 col-span-full md:col-span-1">
                            <label for="product-deduct-liquidity" class="inline-flex items-center cursor-pointer mt-2">
                                <input type="checkbox" id="product-deduct-liquidity" class="rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-offset-0 focus:ring-indigo-200 focus:ring-opacity-50 ml-2">
                                <span class="text-sm text-gray-700 font-medium">خصم تكلفة البضاعة المضافة من السيولة؟</span>
                            </label>
                            <p class="text-xs text-gray-500 mt-1">سيتم خصم تكلفة الكمية *المضافة* فقط.</p>
                        </div>
                        <div id="serial-number-entry-container" class="mb-4 col-span-full hidden">
                            <div class="flex justify-between items-center mb-2 flex-wrap gap-2">
                                <label for="product-serial-numbers" class="block text-gray-700 text-sm font-bold">
                                    الأرقام التسلسلية (اختياري - كل رقم في سطر، أو مفصولة بفاصلة/مسافة):
                                </label>
                                <label for="import-serial-csv-input" class="button-like bg-teal-500 hover:bg-teal-600 text-white text-xs py-1 px-3 rounded-md cursor-pointer">
                                    استيراد من ملف CSV
                                </label>
                                <input type="file" id="import-serial-csv-input" accept=".csv,.txt">
                            </div>
                            <textarea id="product-serial-numbers" rows="4" class="shadow-sm w-full font-mono text-sm" placeholder="SN12345&#10;SN12346, SN12347 SN12348..."></textarea>
                            <p class="text-xs text-gray-500 mt-1">إذا أدخلت سيريالات، يجب أن يتطابق عددها مع الكمية المضافة.</p>
                            <div id="serial-import-message" class="section-message text-xs mt-2"></div>
                        </div>
                        <div class="col-span-full flex flex-wrap gap-2 items-center">
                           <button id="add-product-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">إضافة/تحديث البضاعة</button>
                           <button id="cancel-edit-product-button" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded hidden">إلغاء التعديل</button>
                       </div>
                       <div id="product-message" class="section-message mt-3 col-span-full"></div>
                   </div>
                </div>

                <div class="mt-8 border-t pt-6">
                    <h3 class="sub-heading">قائمة البضائع المتوفرة</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div id="inventory-total-inventory-value" class="text-lg font-semibold text-indigo-600">إجمالي قيمة المخزون: 0.00 جنيه</div>
                        <div id="inventory-consignment-value-display" class="text-lg font-semibold text-yellow-600">قيمة مؤقتة: 0.00 جنيه</div>
                        <div id="inventory-total-profit" class="text-lg font-semibold text-green-600">إجمالي الربح: 0.00 جنيه</div>
                    </div>
                    <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <p class="text-center text-gray-500 col-span-full">لا توجد بضائع حتى الآن.</p>
                    </div>
                </div>
            </section><section id="suppliers-section" class="widget-card content-section hidden">
                <h2>الموردين والبحث التسلسلي</h2>
                <div id="add-update-supplier-form" class="mb-6 pb-4 border-b">
                    <h3 id="supplier-form-title" class="text-lg font-medium text-gray-700 mb-3">إضافة مورد جديد</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="mb-4">
                            <label for="supplier-name" class="block text-gray-700 text-sm font-bold mb-2">اسم المورد:<span class="required">*</span></label>
                            <input type="text" id="supplier-name" placeholder="اسم الشركة أو الشخص" class="shadow-sm">
                        </div>
                        <div class="mb-4">
                            <label for="supplier-contact" class="block text-gray-700 text-sm font-bold mb-2">معلومات الاتصال:</label>
                            <input type="text" id="supplier-contact" placeholder="رقم هاتف، بريد إلكتروني..." class="shadow-sm">
                        </div>
                        <div class="mb-4">
                            <label for="supplier-address" class="block text-gray-700 text-sm font-bold mb-2">العنوان:</label>
                            <input type="text" id="supplier-address" placeholder="عنوان المورد" class="shadow-sm">
                        </div>
                    </div>
                    <button id="add-supplier-button" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded">إضافة / تحديث المورد</button>
                    <button id="cancel-edit-supplier-button" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded hidden ml-2">إلغاء التعديل</button>
                    <div id="supplier-message" class="section-message mt-3"></div>
                </div>

                <div id="suppliers-list-container">
                    <h3 class="text-lg font-medium text-gray-700 mb-3">قائمة الموردين الحاليين</h3>
                    <div id="supplier-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <p class="text-center text-gray-500 col-span-full">لا يوجد موردين مسجلين بعد.</p>
                    </div>
                </div>

                <div id="serial-search-container" class="mt-8 border-t pt-6">
                    <h3 class="text-lg font-medium text-gray-700 mb-3">البحث عن الأرقام التسلسلية لمورد</h3>
                     <div class="flex flex-col sm:flex-row justify-start items-end gap-4 mb-4">
                        <div>
                            <label for="search-supplier-serial-name" class="block text-gray-700 text-sm font-bold mb-1">اسم المورد:<span class="required">*</span></label>
                            <input type="text" id="search-supplier-serial-name" list="supplier-names-list" placeholder="اكتب اسم المورد" class="shadow-sm w-full sm:w-auto">
                            <datalist id="supplier-names-list"></datalist>
                        </div>
                        <button id="search-supplier-serials-btn" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded w-full sm:w-auto">
                            بحث السيريالات
                        </button>
                    </div>
                    <div id="serial-search-message" class="section-message text-sm mb-4"></div>
                    <div id="filter-serials-container" class="mb-3 hidden">
                         <label for="filter-serials-input" class="block text-gray-700 text-sm font-bold mb-1">تصفية السيريالات المعروضة:</label>
                         <input type="text" id="filter-serials-input" placeholder="ابحث برقم السيريال..." class="shadow-sm w-full sm:w-1/2">
                    </div>
                    <div id="supplier-serials-results">
                        <p class="text-center text-gray-500">أدخل اسم المورد واضغط "بحث السيريالات".</p>
                    </div>
                </div>
            </section>

            <section id="sell-product" class="widget-card content-section hidden">
                <div>
                    <h2>بيع بضاعة (سريع / مؤقت)</h2>
                    <p class="text-sm text-gray-500 mb-4">للبيع السريع أو المؤقت بدون فاتورة تفصيلية. لإنشاء فاتورة مفصلة، استخدم الزر الأخضر أدناه.</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="mb-4">
                            <label for="sell-product-name" class="block text-gray-700 text-sm font-bold mb-2">اسم البضاعة المباعة:<span class="required">*</span></label>
                            <input type="text" id="sell-product-name" placeholder="اسم المنتج الرئيسي" list="product-names-list" class="shadow-sm">
                            </div>
                        <div class="mb-4">
                            <label for="sell-customer-name" class="block text-gray-700 text-sm font-bold mb-2">اسم العميل:</label>
                            <input type="text" id="sell-customer-name" placeholder="اسم العميل (اختياري)" class="shadow-sm">
                        </div>
                        <div class="mb-4">
                            <label for="sell-quantity" class="block text-gray-700 text-sm font-bold mb-2">الكمية المباعة:<span class="required">*</span></label>
                            <input type="number" id="sell-quantity" value="1" min="1" class="shadow-sm">
                        </div>
                        <div class="mb-4 md:col-start-1">
                            <label for="sell-price" class="block text-gray-700 text-sm font-bold mb-2">إجمالي سعر البيع:<span class="required">*</span></label>
                            <input type="number" id="sell-price" value="0" min="0" step="0.01" placeholder="السعر الإجمالي للكمية" class="shadow-sm">
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">خصم تكاليف إضافية (للحزم أو المرفقات):</label>
                        <div id="additional-costs-container">
                            <p class="text-center text-gray-500 text-sm">أدخل اسم المنتج الرئيسي لعرض المرفقات المتاحة.</p>
                        </div>
                    </div>
                    <div class="mt-4">
                        <label for="sell-pending" class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="sell-pending" class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-offset-0 focus:ring-blue-200 focus:ring-opacity-50 ml-2">
                            <span class="text-sm text-gray-700 font-medium">بيع مؤقت (تحت التسوية)</span>
                        </label>
                    </div>
                    <div class="flex flex-wrap gap-4 mt-6">
                        <button id="sell-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">بيع البضاعة (سريع/مؤقت)</button>
                        <button type="button" id="openInvoiceModalBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">إنشاء فاتورة بيع مفصلة</button>
                    </div>
                    <div id="sell-message" class="section-message mt-3"></div>
                </div>

                <div id="pending-sales-container" class="mt-8 border-t pt-6">
                    <h3 class="sub-heading">المبيعات المؤقتة الحالية</h3>

                    <div id="pending-sales-controls" class="flex flex-wrap gap-4 mb-4 items-center border-b pb-4">
                        <div id="pending-sales-search-group" class="flex-grow min-w-[250px]">
                            <label for="pending-sales-search-input" class="block text-sm font-medium text-gray-600 mb-1">بحث في المبيعات المؤقتة:</label>
                            <input type="text" id="pending-sales-search-input" placeholder="ابحث بالاسم أو المنتج..." class="shadow-sm text-sm p-2">
                        </div>
                        <div id="pending-sales-totals-group" class="flex-shrink-0 space-x-4 space-x-reverse text-sm font-semibold">
                            <span>الإجمالي:</span>
                            <span id="pending-sales-total-cost" class="text-purple-600">التكلفة: 0.00 جنيه</span>
                            <span id="pending-sales-total-profit" class="text-green-600">الربح المتوقع: 0.00 جنيه</span>
                        </div>
                    </div>
                     <div id="pending-sales-list">
                        <p class="text-center text-gray-500 text-sm">لا توجد مبيعات مؤقتة حاليًا.</p>
                    </div>
                </div>
            </section><section id="liquidity-section" class="widget-card content-section hidden">
                 <h2>السيولة المتاحة والتعديل اليدوي</h2>
                <div id="current-liquidity" class="text-2xl font-bold text-blue-700 mb-4">0.00 جنيه</div>

                <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="border-l border-gray-200 pl-4 md:border-l-0 md:pl-0 md:border-r md:pr-4">
                        <h3 class="text-lg font-medium text-gray-700 mb-3">إضافة سيولة</h3>
                        <div class="mb-3">
                            <label for="add-liquidity-amount" class="block text-gray-700 text-sm font-bold mb-1">المبلغ:<span class="required">*</span></label>
                            <input type="number" id="add-liquidity-amount" value="0" min="0.01" step="0.01" class="shadow-sm">
                        </div>
                        <div class="mb-3">
                            <label for="add-liquidity-source" class="block text-gray-700 text-sm font-bold mb-1">المصدر:<span class="required">*</span></label>
                            <input type="text" id="add-liquidity-source" placeholder="مثال: مبيعات، استثمار..." class="shadow-sm">
                        </div>
                        <button id="add-liquidity-button" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">إضافة</button>
                    </div>
                    <div>
                        <h3 class="text-lg font-medium text-gray-700 mb-3">سحب سيولة</h3>
                        <div class="mb-3">
                            <label for="remove-liquidity-amount" class="block text-gray-700 text-sm font-bold mb-1">المبلغ:<span class="required">*</span></label>
                            <input type="number" id="remove-liquidity-amount" value="0" min="0.01" step="0.01" class="shadow-sm">
                        </div>
                        <div class="mb-3">
                            <label for="remove-liquidity-reason" class="block text-gray-700 text-sm font-bold mb-1">السبب:<span class="required">*</span></label>
                            <input type="text" id="remove-liquidity-reason" placeholder="مثال: سحب شخصي، شراء..." class="shadow-sm">
                        </div>
                        <button id="remove-liquidity-button" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded">سحب</button>
                    </div>
                </div>
                <div id="liquidity-message" class="section-message mt-3"></div>

                 <div id="liquidity-adjustment-container" class="mt-8 border-t pt-6">
                     <h3 class="text-lg font-medium text-gray-700 mb-3">تعديل رصيد السيولة (يدوي)</h3>
                     <p class="text-xs text-gray-500 mb-3">استخدم هذا القسم بحذر لتصحيح رصيد السيولة مباشرة بسبب خطأ أو لضبط الرصيد الأولي.</p>
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                         <div class="form-group">
                             <label for="adjust-liquidity-amount" class="block text-sm font-bold mb-1">الرصيد الجديد للسيولة:<span class="required">*</span></label>
                             <input type="number" id="adjust-liquidity-amount" placeholder="أدخل الرصيد الصحيح" step="0.01" class="shadow-sm">
                         </div>
                         <div class="form-group">
                             <label for="adjust-liquidity-reason" class="block text-sm font-bold mb-1">سبب التعديل:<span class="required">*</span></label>
                             <input type="text" id="adjust-liquidity-reason" placeholder="مثال: تصحيح خطأ، رصيد افتتاحي" class="shadow-sm">
                         </div>
                         <div class="form-group">
                             <button id="adjust-liquidity-button" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded">تنفيذ التعديل</button>
                         </div>
                     </div>
                     <div id="adjust-liquidity-message" class="section-message mt-3"></div>
                 </div>
                  <div id="liquidity-log-container" class="mt-6 border-t border-gray-200 pt-4">
                    <h3 class="text-lg font-medium text-gray-700 mb-3">سجل عمليات السيولة</h3>
                    <ul id="liquidity-log-list" class="space-y-2">
                        <li class="text-center text-gray-500">لا توجد عمليات مسجلة على السيولة.</li>
                    </ul>
                </div>
            </section>
            <section id="debts-section" class="widget-card content-section hidden">
                <h2>الديون (المستحقة للشركة)</h2>
                <div id="total-debts-display" class="text-2xl font-bold text-purple-700 mb-4">إجمالي الديون: 0.00 جنيه</div>

                <div class="mb-6 pb-4 border-b">
                    <h3 class="text-lg font-medium text-gray-700 mb-3">تسجيل دين / سلفة جديدة</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div>
                            <label for="debtor-name" class="block text-gray-700 text-sm font-bold mb-1">اسم المدين:<span class="required">*</span></label>
                            <input type="text" id="debtor-name" placeholder="اسم الشخص أو الجهة" class="shadow-sm w-full">
                        </div>
                        <div>
                            <label for="add-debt-reason" class="block text-gray-700 text-sm font-bold mb-1">سبب الدين:</label>
                            <input type="text" id="add-debt-reason" placeholder="مثال: أدوات، أسنان، سلفة..." class="shadow-sm w-full">
                        </div>
                        <div>
                            <label for="add-debt-amount" class="block text-gray-700 text-sm font-bold mb-1">المبلغ:<span class="required">*</span></label>
                            <input type="number" id="add-debt-amount" value="0" min="0.01" step="0.01" class="shadow-sm w-full">
                        </div>
                    </div>
                    <div class="mt-4 flex flex-col sm:flex-row justify-between items-center gap-4">
                        <label for="debt-deduct-liquidity" class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="debt-deduct-liquidity" class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-offset-0 focus:ring-blue-200 focus:ring-opacity-50 ml-2">
                            <span class="text-sm text-gray-700 font-medium">خصم المبلغ من السيولة (تسجيل سلفة)؟</span>
                        </label>
                        <button id="add-debt-button" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded w-full sm:w-auto">تسجيل الدين/السلفة</button>
                    </div>
                </div>

                <div class="mb-6 pb-4 border-b">
                    <h3 class="text-lg font-medium text-gray-700 mb-3">استلام سداد</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                        <div>
                            <label for="payment-debtor-select" class="block text-gray-700 text-sm font-bold mb-1">اختر الدين المراد سداده:<span class="required">*</span></label>
                            <select id="payment-debtor-select" class="shadow-sm w-full">
                                <option value="">-- اختر الدين --</option>
                                </select>
                        </div>
                        <div>
                            <label for="payment-amount" class="block text-gray-700 text-sm font-bold mb-1">المبلغ المسدد:<span class="required">*</span></label>
                            <input type="number" id="payment-amount" value="0" min="0.01" step="0.01" class="shadow-sm w-full">
                        </div>
                    </div>
                    <button id="receive-payment-button" class="mt-4 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded w-full sm:w-auto">استلام المبلغ</button>
                </div>

                <div id="debts-message" class="section-message mt-3"></div>
                <div id="debtors-list-container">
                    <h3 class="text-lg font-medium text-gray-700 mb-3">قائمة الديون الحالية (مجمعة حسب الشخص)</h3>
                    <div id="debtors-list" class="space-y-2">
                        <p class="text-center text-gray-500 py-4">لا توجد ديون مسجلة حاليًا.</p>
                    </div>
                </div>
            </section><section id="liabilities-section" class="widget-card content-section hidden">
                <h2>الديون المستحقة على الشركة (للاخرين)</h2>
                <div id="total-liabilities-display" class="text-2xl font-bold text-pink-700 mb-4">إجمالي الالتزامات: 0.00 جنيه</div>
                <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="border-l border-gray-200 pl-4 md:border-l-0 md:pl-0 md:border-r md:pr-4">
                        <h3 class="text-lg font-medium text-gray-700 mb-3">تسجيل التزام جديد</h3>
                        <div class="mb-3">
                            <label for="creditor-name" class="block text-gray-700 text-sm font-bold mb-1">اسم الدائن:<span class="required">*</span></label>
                            <input type="text" id="creditor-name" placeholder="اسم الشخص أو الجهة" class="shadow-sm">
                        </div>
                        <div class="mb-3">
                            <label for="add-liability-amount" class="block text-gray-700 text-sm font-bold mb-1">المبلغ المستحق:<span class="required">*</span></label>
                            <input type="number" id="add-liability-amount" value="0" min="0.01" step="0.01" class="shadow-sm">
                        </div>
                        <div class="mb-3">
                            <label for="liability-received-cash" class="inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="liability-received-cash" class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-offset-0 focus:ring-blue-200 focus:ring-opacity-50 ml-2">
                                <span class="text-sm text-gray-700 font-medium">هل استلمت سيولة مقابل هذا الالتزام؟</span>
                            </label>
                        </div>
                        <button id="add-liability-button" class="w-full bg-rose-500 hover:bg-rose-600 text-white font-bold py-2 px-4 rounded">تسجيل الالتزام</button>
                    </div>
                    <div>
                        <h3 class="text-lg font-medium text-gray-700 mb-3">تسديد التزام</h3>
                        <div class="mb-3">
                            <label for="payment-creditor-name" class="block text-gray-700 text-sm font-bold mb-1">اسم الدائن:<span class="required">*</span></label>
                            <select id="payment-creditor-name" class="shadow-sm">
                                <option value="">-- اختر الدائن --</option>
                                </select>
                        </div>
                        <div class="mb-3">
                            <label for="liability-payment-amount" class="block text-gray-700 text-sm font-bold mb-1">المبلغ المسدد:<span class="required">*</span></label>
                            <input type="number" id="liability-payment-amount" value="0" min="0.01" step="0.01" class="shadow-sm">
                        </div>
                        <button id="pay-liability-button" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded">تسديد دفعة</button>
                    </div>
                </div>
                <div id="liabilities-message" class="section-message mt-3"></div>
                <div id="liabilities-list-container" class="mt-6 border-t border-gray-200 pt-4">
                    <h3 class="text-lg font-medium text-gray-700 mb-3">قائمة الالتزامات الحالية</h3>
                    <ul id="liabilities-list" class="space-y-2">
                        <li class="text-center text-gray-500">لا توجد التزامات مسجلة حاليًا.</li>
                    </ul>
                </div>
            </section>

            <section id="offsetting-section" class="widget-card content-section hidden">
                <h2>تسوية (مقاصة) بين طرفين</h2>
                <p class="text-sm text-gray-600 mb-4">
                    استخدم هذا القسم لتسوية دين مستحق على شخص (المدين) باستخدام التزام مستحق لشخص آخر (الدائن).
                    سيتم خصم المبلغ من دين المدين ومن الالتزام المستحق للدائن. لن تؤثر هذه العملية على السيولة النقدية مباشرة.
                </p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <div class="md:col-span-1">
                        <label for="offset-debtor-name" class="block text-gray-700 text-sm font-bold mb-1">اسم المدين (من عليه الدين):<span class="required">*</span></label>
                        <input type="text" id="offset-debtor-name" list="debtor-names-list-offset" placeholder="الشخص الذي عليه الدين للشركة" class="shadow-sm w-full">
                        <datalist id="debtor-names-list-offset"></datalist>
                    </div>
                    <div class="md:col-span-1">
                        <label for="offset-creditor-name" class="block text-gray-700 text-sm font-bold mb-1">اسم الدائن (من له الالتزام):<span class="required">*</span></label>
                        <input type="text" id="offset-creditor-name" list="creditor-names-list-offset" placeholder="الشخص الذي له التزام على الشركة" class="shadow-sm w-full">
                         <datalist id="creditor-names-list-offset"></datalist>
                    </div>
                    <div class="md:col-span-1">
                        <label for="offset-amount-input" class="block text-gray-700 text-sm font-bold mb-1">مبلغ المقاصة:<span class="required">*</span></label>
                        <input type="number" id="offset-amount-input" placeholder="0.00" min="0.01" step="0.01" class="shadow-sm w-full">
                    </div>
                </div>
                <div class="mt-4 flex justify-end">
                    <button id="perform-two-party-offset-button" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded">
                        تنفيذ المقاصة بين الطرفين
                    </button>
                </div>
                <div id="offset-message" class="section-message text-sm mt-3"></div>
            </section>

            <section id="sales-report-section" class="widget-card content-section hidden">
                <h2>تقرير المبيعات الشهرية</h2>
                <p class="text-sm text-gray-600 mb-4">
                    اختر الشهر والسنة لعرض تقرير المبيعات المفصل. سيتم عرض كل عملية بيع تمت خلال الشهر المحدد (من البيانات المحفوظة).
                </p>
                <div class="flex flex-col sm:flex-row justify-start items-end gap-4 mb-4">
                    <div>
                        <label for="report-month-year" class="block text-gray-700 text-sm font-bold mb-1">اختر الشهر:<span class="required">*</span></label>
                        <input type="month" id="report-month-year" class="shadow-sm w-full sm:w-auto">
                    </div>
                    <button id="generate-report-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded w-full sm:w-auto">
                        عرض التقرير
                    </button>
                </div>
                <div id="report-message" class="section-message text-sm mb-4"></div>

                <div id="sales-report-display">
                    <h3 class="text-lg font-medium text-gray-700 mb-3">تفاصيل المبيعات للشهر المحدد</h3>
                    <div class="overflow-x-auto">
                        <table id="sales-report-table" class="min-w-full">
                            <thead>
                                <tr>
                                    <th class="px-4 py-2">تاريخ العملية</th>
                                    <th class="px-4 py-2">العميل</th>
                                    <th class="px-4 py-2">المنتجات/البنود</th>
                                    <th class="px-4 py-2">إجمالي البيع</th>
                                    <th class="px-4 py-2">إجمالي التكلفة</th>
                                    <th class="px-4 py-2">الربح</th>
                                    <th class="px-4 py-2">نوع العملية</th>
                                </tr>
                            </thead>
                            <tbody id="sales-report-table-body">
                                <tr><td colspan="7" class="text-center text-gray-500 py-4">اختر الشهر واضغط "عرض التقرير".</td></tr>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="3" class="font-semibold text-right">الإجماليات الشهرية (للعمليات المعروضة):</td>
                                    <td id="report-total-sales" class="font-bold text-center">0 جنيه</td>
                                    <td id="report-total-cost" class="font-bold text-center">0 جنيه</td>
                                    <td id="report-total-profit" class="font-bold text-center">0 جنيه</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </section>

            <section id="search-section" class="widget-card content-section hidden">
                <h2>البحث عن فاتورة (لليوم الحالي)</h2>
                <p class="text-sm text-gray-600 mb-4">
                    ابحث عن الفواتير التي تم إنشاؤها أو تأكيدها في اليوم المحدد حالياً (البيانات المعروضة).
                </p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="search-invoice-number" class="block text-gray-700 text-sm font-bold mb-1">البحث برقم الفاتورة:</label>
                        <div class="flex gap-2">
                            <input type="text" id="search-invoice-number" placeholder="مثال: 20250501-001" class="shadow-sm flex-grow">
                            <button id="search-by-number-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold px-3 rounded flex-shrink-0">بحث</button>
                        </div>
                    </div>
                    <div>
                        <label for="search-customer-name" class="block text-gray-700 text-sm font-bold mb-1">البحث باسم العميل:</label>
                        <div class="flex gap-2">
                            <input type="text" id="search-customer-name" placeholder="جزء من اسم العميل" class="shadow-sm flex-grow">
                            <button id="search-by-name-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold px-3 rounded flex-shrink-0">بحث</button>
                        </div>
                    </div>
                </div>
                <div id="search-message" class="section-message text-sm mb-4"></div>
                <div id="search-results-container" class="mt-4 border-t pt-4">
                    <h3 class="text-lg font-medium text-gray-700 mb-3">نتائج البحث:</h3>
                    <div id="search-results-list">
                        <p class="text-center text-gray-500">أدخل معايير البحث واضغط "بحث".</p>
                    </div>
                </div>
            </section>

            <section id="log-section" class="widget-card content-section hidden">
                <h2>سجل العمليات العام (لليوم الحالي)</h2>
                <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                    <span class="text-sm text-gray-600">يعرض هذا السجل العمليات التي تمت في الجلسة الحالية للبيانات المعروضة.</span>
                    <button id="clear-log-button" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-600 font-bold py-1 px-2 rounded flex-shrink-0">مسح سجل اليوم المعروض</button>
                </div>
                <ul id="operation-log-list" class="list-disc pl-5 space-y-2">
                    <li class="text-center text-gray-500 list-none">لا توجد عمليات مسجلة بعد.</li>
                </ul>
            </section><div id="invoiceModal" class="invoice-modal modal">
                <div class="invoice-modal-content modal-content">
                    <div class="invoice-modal-header modal-header">
                        <span class="invoice-close-btn modal-close-btn no-print">&times;</span>
                        <h2>إنشاء فاتورة جديدة</h2>
                    </div>
                    <div class="invoice-modal-body modal-body" id="invoicePrintArea">
                        <form id="invoiceForm" autocomplete="off">
                            <fieldset>
                                <legend>بيانات العميل</legend>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="inv_customerName">اسم العميل: <span class="required">*</span></label>
                                        <input type="text" id="inv_customerName" name="customerName" placeholder="اسم العميل" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="inv_customerAddress">العنوان:</label>
                                        <input type="text" id="inv_customerAddress" name="customerAddress" placeholder="عنوان العميل">
                                    </div>
                                </div>
                            </fieldset>

                            <fieldset>
                                <legend>أرقام الهواتف</legend>
                                <div id="inv_phoneNumbersContainer">
                                    <div class="form-row inv-phone-entry">
                                        <div class="form-group">
                                            <label for="inv_phone1">رقم هاتف 1:</label>
                                            <input type="tel" id="inv_phone1" name="phone[]" placeholder="رقم الهاتف">
                                        </div>
                                        </div>
                                </div>
                                <button type="button" id="inv_addPhoneBtn" class="no-print mt-2">+ إضافة رقم آخر</button>
                            </fieldset>

                            <fieldset>
                                <legend>تفاصيل البضاعة</legend>
                                <div class="add-item-section no-print">
                                    <h4>إضافة بند جديد</h4>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="inv_itemName">اسم البند:<span class="required">*</span></label>
                                            <input type="text" id="inv_itemName" list="product-names-list" placeholder="اسم المنتج أو الخدمة">
                                        </div>
                                        <div class="form-group" style="flex: 0.5;">
                                            <label for="inv_itemQty">الكمية:<span class="required">*</span></label>
                                            <input type="number" id="inv_itemQty" value="1" min="1">
                                        </div>
                                        <div class="form-group" style="flex: 0.5;">
                                            <label for="inv_itemPrice">سعر الوحدة:<span class="required">*</span></label>
                                            <input type="number" id="inv_itemPrice" value="0" min="0" step="0.01">
                                        </div>
                                        <div class="form-group" style="flex: 0 0 auto;">
                                            <button type="button" id="inv_addItemBtn">إضافة</button>
                                        </div>
                                    </div>
                                     <div id="inv_serialSelectContainer" class="serial-select-container hidden">
                                        <label for="inv_itemSerialSelect" class="block text-gray-700 text-sm font-bold mb-1">اختر الرقم التسلسلي:<span class="required">*</span></label>
                                        <input type="text" id="inv_serialSearchInput" placeholder="ابحث عن سيريال..." class="shadow-sm mb-1">
                                        <select id="inv_itemSerialSelect" size="3">
                                            </select>
                                    </div>
                                    <div id="inv_itemAddError" class="error-message"></div>
                                </div>
                                <hr class="no-print my-4">
                                <table id="inv_invoiceItemsTable">
                                    <thead>
                                        <tr>
                                            <th>البند</th>
                                            <th>الكمية</th>
                                            <th>سعر الوحدة</th>
                                            <th>الإجمالي الفرعي</th>
                                            <th class="no-print">إجراء</th>
                                        </tr>
                                    </thead>
                                    <tbody id="inv_invoiceItemsBody">
                                        </tbody>
                                </table>
                                <div class="form-row totals-display" style="margin-top: 15px;">
                                    <div class="form-group">
                                        <label>إجمالي سعر البضاعة:</label>
                                        <span id="inv_totalGoodsPrice">0.00 جنيه</span>
                                    </div>
                                </div>
                            </fieldset>

                            <fieldset class="no-print">
                                <legend>خصم تكاليف إضافية (ملحقات/هدايا من المخزون)</legend>
                                <label class="block text-sm font-medium mb-2" style="color:#555;">اختر المنتجات التي سيتم خصم تكلفتها (بكمية 1 لكل عنصر - لن تظهر في الفاتورة المطبوعة):</label>
                                <div id="inv_deductibleCostsContainer">
                                    <p class="text-center text-gray-500 text-sm" style="color:grey;">سيتم عرض المنتجات المتاحة هنا.</p>
                                </div>
                            </fieldset>

                            <fieldset>
                                <legend>الشحن</legend>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="inv_shippingCost">قيمة الشحن:</label>
                                        <input type="number" id="inv_shippingCost" name="shippingCost" value="0" min="0" step="0.01">
                                    </div>
                                </div>
                                <div class="form-row totals-display">
                                    <div class="form-group">
                                        <label>إجمالي الشحن:</label>
                                        <span id="inv_totalShippingCost">0.00 جنيه</span>
                                    </div>
                                </div>
                            </fieldset>

                            <fieldset>
                                <legend>الضمان والملاحظات</legend>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="inv_warranty">مدة الضمان (اختياري):</label>
                                        <input type="text" id="inv_warranty" name="warranty" placeholder="مثال: سنة واحدة، 6 أشهر...">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="inv_notes">ملاحظات (اختياري):</label>
                                        <textarea id="inv_notes" name="notes" placeholder="أي ملاحظات إضافية على الفاتورة..."></textarea>
                                    </div>
                                </div>
                            </fieldset>

                            <fieldset>
                                <legend>الإجمالي الكلي</legend>
                                <div class="form-row totals-display">
                                    <div class="form-group">
                                        <label>المبلغ الإجمالي المطلوب:</label>
                                        <strong id="inv_grandTotalPrice">0.00 جنيه</strong>
                                    </div>
                                </div>
                            </fieldset>
                            <div id="inv_validationError" class="error-message no-print"></div>
                        </form>
                    </div> <div class="invoice-modal-footer modal-footer">
                        <button type="button" id="inv_printInvoiceBtn" class="no-print">طباعة الفاتورة</button>
                        <button type="button" id="inv_saveInvoiceBtn" class="no-print">إنشاء وحفظ الفاتورة</button>
                        <button type="button" class="invoice-close-btn-footer modal-close-btn-footer no-print">إغلاق</button>
                    </div>
                </div> </div> <div id="manageSerialsModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <span class="modal-close-btn no-print">&times;</span>
                        <h2>إدارة الأرقام التسلسلية للمنتج: <span id="modal_productNameDisplay"></span></h2>
                    </div>
                    <div class="modal-body">
                        <div id="modal_serialCounts" class="mb-4">
                            <p>الكمية الإجمالية: <span id="modal_totalQuantity"></span></p>
                            <p>السيريالات المسجلة: <span id="modal_registeredCount"></span></p>
                            <p>القطع غير المسجلة: <span id="modal_unregisteredCount" class="font-bold text-red-600"></span></p>
                        </div>

                        <hr class="my-4">

                        <div>
                            <h4 class="text-md font-semibold mb-2">إضافة سيريالات جديدة للقطع غير المسجلة:</h4>
                             <div class="flex justify-between items-center mb-2 flex-wrap gap-2">
                                <label for="modal_productSerialNumbers" class="block text-gray-700 text-sm font-bold">
                                    الأرقام التسلسلية الجديدة (اختياري - كل رقم في سطر):
                                </label>
                                <label for="modal-import-serial-csv-input" class="button-like bg-teal-500 hover:bg-teal-600 text-white text-xs py-1 px-3 rounded-md cursor-pointer">
                                    استيراد من ملف CSV
                                </label>
                                <input type="file" id="modal-import-serial-csv-input" accept=".csv,.txt">
                            </div>
                            <textarea id="modal_productSerialNumbers" rows="5" class="shadow-sm w-full font-mono text-sm" placeholder="SN55555&#10;SN66666..."></textarea>
                            <p class="text-xs text-gray-500 mt-1">أدخل فقط سيريالات للقطع غير المسجلة. العدد يجب ألا يتجاوز <span id="modal_maxSerialsToAdd">0</span>.</p>
                             <div id="modal-serial-import-message" class="section-message text-xs mt-2"></div>
                        </div>

                         <div class="mt-4 border-t pt-4">
                            <h4 class="text-md font-semibold mb-2">السيريالات المسجلة حالياً لهذا المنتج:</h4>
                            <div id="modal-registered-serials-list">
                                <p class="text-center text-gray-500">لا توجد سيريالات مسجلة حالياً.</p>
                            </div>
                        </div>

                    </div> <div class="modal-footer">
                        <button type="button" id="modal_saveAddedSerialsBtn" class="bg-blue-500 hover:bg-blue-600 text-white">حفظ السيريالات المضافة</button>
                        <button type="button" class="modal-close-btn-footer no-print">إغلاق</button>
                    </div>
                </div> </div> 
            <section id="settings-section" class="widget-card content-section hidden">
                <h2>تحميل/حفظ/إعدادات</h2>
                <div id="load-data-sub-section" class="mb-6 pb-4 border-b">
                    <h3 class="text-lg font-medium text-gray-700 mb-3">تحميل بيانات تاريخ سابق أو ترحيل أرصدة</h3>
                    <div class="flex flex-col sm:flex-row justify-start items-center gap-2 md:gap-4 flex-wrap">
                        <label for="load-date-alt" class="block text-gray-700 text-sm font-bold flex-shrink-0">اختر التاريخ:</label>
                        <input type="date" id="load-date-alt" class="shadow-sm w-52">
                        <span id="load-date-day-name-alt" class="text-gray-600 font-medium text-sm min-w-[50px] text-center"></span>
                        <button id="load-data-button-alt" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded">
                            تحميل / ترحيل يدوي
                        </button>
                    </div>
                    <div id="load-message-alt" class="section-message text-sm mt-3"></div>
                    <p class="text-xs text-gray-500 mt-2">ملاحظة: عند اختيار يوم فارغ، سيتم سؤالك إذا كنت تريد ترحيل الأرصدة من اليوم السابق له إن وجدت.</p>
                </div>

                <div id="import-export-section" class="mb-6 pb-4 border-b">
                    <h3 class="text-lg font-medium text-gray-700 mb-3">نسخ احتياطي واستعادة</h3>
                    <div class="flex flex-col sm:flex-row justify-center items-center gap-4 flex-wrap">
                        <button id="export-data-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
                            تصدير البيانات الحالية (JSON)
                        </button>
                        <label for="import-file-input" class="button-like bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded cursor-pointer">
                            استيراد بيانات من ملف (JSON/TXT)
                        </label>
                        <input type="file" id="import-file-input" accept=".json,.txt">
                    </div>
                     <p class="text-xs text-gray-500 mt-2 text-center">ملاحظة: عند الاستيراد، اختر أولاً التاريخ الذي تريد الاستيراد إليه من قسم "تحميل بيانات تاريخ سابق".</p>
                    <div id="import-message" class="section-message text-sm mt-2"></div>
                </div>

                <div id="controls-sub-section" class="mt-6 flex flex-col sm:flex-row justify-center items-center flex-wrap gap-4">
                    <button id="save-button-alt" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded flex items-center">
                        <svg class="save-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M17 3H5C3.89543 3 3 3.89543 3 5V19C3 20.1046 3.89543 21 5 21H19C20.1046 21 21 20.1046 21 19V7.82843C21 7.29799 20.7893 6.78929 20.4142 6.41421L17.5858 3.58579C17.2107 3.21071 16.702 3 16.1716 3H17ZM15 9C15 8.44772 14.5523 8 14 8H10C9.44772 8 9 8.44772 9 9V14C9 14.5523 9.44772 15 10 15H14C14.5523 15 15 14.5523 15 14V9ZM12 13C11.4477 13 11 12.5523 11 12C11 11.4477 11.4477 11 12 11C12.5523 11 13 11.4477 13 12C13 12.5523 12.5523 13 12 13Z"></path></svg>
                        حفظ التغييرات
                    </button>
                    <button id="print-button-alt" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">
                        طباعة تقرير اليوم
                    </button>
                    <button id="reset-button-alt" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded">
                        تصفير بيانات اليوم (بدون حفظ)
                    </button>
                    
                </div>
            </section>


        </div> <footer class="mt-10 text-center text-sm text-gray-500">
            <p>
                تم التطوير بواسطة:
                <a href="https://diaaashraf2004.github.io/drashraf/" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">
                    ضياء أشرف
                </a>
                 - <span id="current-time"></span>
            </p>
        </footer>

    </div><script>
    document.addEventListener("DOMContentLoaded", function() {
        // --- Global Error Handler ---
                window.addEventListener('error', function(event) {
            console.error('!!! خطأ عام غير معالج تم اكتشافه !!!');
            console.error('رسالة الخطأ:', event.message);
            console.error('الملف المصدر:', event.filename);
            console.error('رقم السطر:', event.lineno);
            console.error('رقم العمود:', event.colno);
            console.error('كائن الخطأ (Error Object):', event.error); // يحتوي عادة على تتبع المكدس (stack trace)

            // اختيارياً: يمكنك عرض رسالة للمستخدم في الواجهة أيضاً
            // if (typeof showGlobalMessage === 'function') {
            //     showGlobalMessage('حدث خطأ غير متوقع في البرنامج. يرجى مراجعة الـ console لمزيد من التفاصيل ومحاولة تحديث الصفحة.', true);
            // }
        });

        // اختيارياً: يمكنك أيضاً التقاط الأخطاء في الـ Promises التي لم يتم التعامل معها
        window.addEventListener('unhandledrejection', function(event) {
            console.error('!!! خطأ Promise غير معالج تم اكتشافه !!!');
            console.error('سبب الرفض (Rejection Reason):', event.reason);
        });
        // --- End of Global Error Handler ---
        // *** JavaScript - (أعيد ترقيمه ليبدأ هنا) الجزء 7 من 8 يبدأ هنا ***

        // --- تعريف المتغيرات والثوابت الأساسية أولاً ---
        const d = id => document.getElementById(id); // Helper function
        const lsPrefix = "goodsMgmt_data_"; // Define constants FIRST
        const lsLastSaveKey = "goodsMgmt_lastSaveDate";

        // --- متغيرات الحالة (Main App State) ---
        let monthlyLiabilities = []; // لتخزين قائمة الالتزامات الشهرية
let editingMonthlyLiabilityId = null; // لمعرفة الالتزام الذي يتم تعديله
const lsLastProcessedMonthKey = "goodsMgmt_lastProcessedMonth"; // مفتاح لتخزين آخر شهر تمت معالجته
        let products = [];
        let stateHistory = []; // لتخزين لقطات الحالات السابقة
let redoHistory = [];  // لتخزين الحالات التي تم التراجع عنها
        let suppliers = [];
        let liquidity = 0;
        let expenses = 0;
        let debtors = []; // Array of {id, name, reason, amount}
        let liabilities = []; // Array of {id, name, amount}
        let totalProfit = 0;
        let operationLog = []; // Array of {timestamp, type, details}
        let currentLoadedDate = null; // Stores the YYYY-MM-DD string of the loaded data
        let pendingSales = []; // Array of {id, timestamp, customerName, mainProduct{name,qty,cost,supplierId}, additionalItems[{name,qty,cost,supplierId}], totalSellPrice, potentialProfit, status}
        let goodsOnConsignmentValue = 0; // Calculated from pendingSales costs
        let liquidityLog = []; // Array of {id, timestamp, type['add'/'remove'/'adjust'], amount, description, currentBalance} // Added 'adjust' type
        let salesToday = []; // Array to store completed sales/invoices for the current day {id, invoiceNumber?, type['quick'/'invoice'/'invoice-from-pending'/'pending-confirmed'], timestamp, customerName, items[{}], totalSellPrice/grandTotal, totalCost, profit, etc.}
        let serialNumbersLog = []; // **** لتخزين سجل الأرقام التسلسلية **** Array of {serial, productName, supplierId, addedTimestamp, status: 'in_stock' | 'sold' | 'returned' | 'pending_sale' | 'in_invoice_temp' }
        let editingProductName = null; // Name of the product being edited
        let editingSupplierId = null; // ID of the supplier being edited
        let isInvoiceFromPending = false; // Flag if invoice modal is opened from a pending sale confirmation
        let pendingSaleOriginData = null; // Stores the original pending sale data when confirming with invoice
        let inv_phoneCounter = 1; // Counter for dynamic phone fields in invoice
        let currentManagingSerialsProduct = null; // **** لتخزين اسم المنتج الذي يتم إدارة سيريالاته ****
        let currentSupplierSerials = []; // **** لتخزين السيريالات المعروضة حالياً للفلترة ****
        let inboxTasks = [];

        // --- تعريف المراجع الأساسية (DOM Element References) ---
        // Declared here, assigned in initializeApp after DOM is ready
        let mainNav, contentSections, navButtons, globalMessage, currentDataDateDisplay, currentTimeDisplay,
            summaryLiquidity, summaryInventory, summaryConsignment, summaryDebts,
            summaryLiabilities, summaryExpenses, summaryProfit, summaryCapital,summaryExpectedCapital,
            productList, addProductButton, productNameInput, productQuantityInput,
            productCostPriceInput, productSupplierSelect, productMessage,
            inventoryTotalInventoryValue, inventoryConsignmentValue, inventoryTotalProfit,
            cancelEditProductButton, productFormTitle, productNamesDatalist,
            productDeductLiquidityCheckbox,
            serialNumberEntryContainer, productSerialNumbersTextarea, serialImportMessage, importSerialCsvInput,
            sellProductNameInput, sellCustomerNameInput, sellQuantityInput, sellPriceInput,
            sellButton, sellMessage, additionalCostsContainer, sellPendingCheckbox,
            pendingSalesListContainer, pendingSalesSearchInput, pendingSalesTotalCostSpan, pendingSalesTotalProfitSpan, // <<< جديد: عناصر تحكم المبيعات المؤقتة
            currentLiquidityDisplay, addLiquidityAmountInput,
            addLiquiditySourceInput, addLiquidityButton, removeLiquidityAmountInput,
            removeLiquidityReasonInput, removeLiquidityButton, liquidityMessage,
            liquidityLogListContainer,
            adjustLiquidityAmountInput, adjustLiquidityReasonInput, adjustLiquidityButton, adjustLiquidityMessage, // <<< جديد: عناصر تعديل السيولة
            totalExpensesDisplay, addExpenseInput,
            addExpenseButton, removeExpenseInput, removeExpenseButton, expensesMessage,
            totalDebtsDisplay, debtorNameInput, addDebtReasonInput, addDebtAmountInput,
            debtDeductLiquidityCheckbox, addDebtButton, paymentDebtorSelect, paymentAmountInput,
            receivePaymentButton, debtsMessage, debtorsListContainer, totalLiabilitiesDisplay,
            creditorNameInput, addLiabilityAmountInput, liabilityReceivedCashCheckbox,
            addLiabilityButton, paymentCreditorSelect, liabilityPaymentAmountInput,
            payLiabilityButton, liabilitiesMessage, liabilitiesListContainer,
            offsetDebtorNameInput, offsetCreditorNameInput, offsetAmountInput,
            performTwoPartyOffsetButton, offsetMessage, reportMonthYearInput,
            generateReportButton, reportMessage, salesReportTableBody, reportTotalSales,
            reportTotalCost, reportTotalProfit, operationLogList, clearLogButton,
            saveButtonAlt, loadDateInputAlt, loadDataButtonAlt, loadMessageAlt,
            loadDateDayNameDisplayAlt, printButtonAlt, resetButtonAlt, exportDataButton,
            importFileInput, importMessage, supplierNameInput, supplierContactInput,
            supplierAddressInput, addSupplierButton, cancelEditSupplierButton,
            supplierMessage, supplierList, supplierFormTitle, supplierNamesDatalist,
            searchSupplierSerialNameInput, searchSupplierSerialsBtn, serialSearchMessage, supplierSerialsResultsContainer, filterSerialsContainer, filterSerialsInput,
            inv_modal, inv_openInvoiceModalBtn, inv_closeBtn, inv_closeBtnFooter, inv_invoiceForm,
            inv_customerNameInput, inv_customerAddressInput, inv_phoneNumbersContainer,
            inv_addPhoneBtn, inv_shippingCostInput, inv_totalShippingCostSpan,
            inv_totalGoodsPriceSpan, inv_grandTotalPriceSpan, inv_validationErrorDiv,
            inv_itemNameInput, inv_itemQtyInput, inv_itemPriceInput, inv_addItemBtn,
            inv_itemAddErrorDiv, inv_invoiceItemsBody, inv_printInvoiceBtn,
            inv_deductibleCostsContainer, inv_warrantyInput, inv_notesTextarea,
            inv_saveInvoiceBtn, inv_serialSelectContainer, inv_itemSerialSelect, inv_serialSearchInput,
            manageSerialsModal, modal_productNameDisplay, modal_serialCounts, modal_totalQuantity, modal_registeredCount, modal_unregisteredCount,
            modal_productSerialNumbers, modal_maxSerialsToAdd, modal_serialImportMessage, modal_importSerialCsvInput,
            modal_registeredSerialsList, modal_saveAddedSerialsBtn, modal_closeBtns,
            debtorNamesDatalistOffset, creditorNamesDatalistOffset,
            // Invoice Search Elements
            searchInvoiceNumberInput, searchByNumberBtn, searchCustomerNameInput,
            searchByNameBtn, searchMessageContainer, searchResultsListContainer;
            // --- Financial Center (FC) Elements ---
let fc_main_tabs, fc_tab_buttons, fc_tab_contents, fc_month_select, fc_expenses_list,
    fc_products_list, fc_total_expenses_display, fc_preview_container, fc_preview_results,
    fc_manual_container, fc_manual_list, fc_percentage_feedback, fc_percentage_total,
    fc_expenses_wrapper, fc_manual_cost_wrapper, fc_manual_cost_input,
    fc_debt_select, fc_execute_dist_btn, fc_execute_debt_btn;    

        // --- الدوال المساعدة (Helper Functions) ---

        function convertNumerals(inputString) { if (typeof inputString !== 'string') return inputString; return inputString.replace(/[\u0660-\u0669]/g, d => d.charCodeAt(0) - 0x0660).replace(/[\u06F0-\u06F9]/g, d => d.charCodeAt(0) - 0x06F0); }
        function parseInputNumber(inputElement) { if (!inputElement) return NaN; const rawValue = inputElement.value; if (rawValue.trim() === '') return NaN; const westernValue = convertNumerals(rawValue.trim()); const normalizedValue = westernValue.replace(/٫/g, '.').replace(/,/g, ''); const number = parseFloat(normalizedValue); return isNaN(number) ? NaN : number; }
        function getTodayDateString() { const today = new Date(); const year = today.getFullYear(); const month = String(today.getMonth() + 1).padStart(2, '0'); const day = String(today.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; }
        function formatDateForDisplay(dateString) { if (!dateString || typeof dateString !== 'string' || !/^\d{4}-\d{2}-\d{2}$/.test(dateString)) return 'غير محدد'; try { const date = new Date(dateString + 'T00:00:00'); const options = { timeZone: 'Africa/Cairo', weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }; return date.toLocaleDateString('ar-EG', options); } catch (e) { console.error("Error formatting date:", dateString, e); return dateString; } }
        function fetchData(key, defaultValue){ const data = localStorage.getItem(key); try { if(data === null || data === undefined) return defaultValue; const parsed = JSON.parse(data); return parsed } catch(e) { console.error(`Error parsing data for key "${key}":`, e); localStorage.removeItem(key); return defaultValue } }
        // دالة جديدة لجلب بيانات يوم واحد من Firebase
async function fetchOnlineDataForDate(dateString) {
    try {
        const docRef = window.doc(window.db, "days", dateString);
        const docSnap = await window.getDoc(docRef);
        if (docSnap.exists()) {
            console.log(`Report: Found online data for ${dateString}`);
            return docSnap.data(); // إرجاع البيانات إذا وجدت
        }
        return null; // إرجاع null إذا لم يتم العثور على المستند
    } catch (error) {
        console.error("Error fetching online report data for", dateString, error);
        return null; // إرجاع null في حالة حدوث خطأ
    }
}
        function saveData(key, data){ console.log(`saveData: Saving data for key: ${key}`); try { localStorage.setItem(key, JSON.stringify(data)) } catch(e) { console.error(`Error saving data for key "${key}":`, e); showGlobalMessage("حدث خطأ أثناء حفظ البيانات. قد يكون التخزين ممتلئًا.", true) } }
        function formatCurrency(amount){ const numAmount = Number(amount); return isNaN(numAmount) ? '0.00 جنيه' : `${numAmount.toFixed(2)} جنيه` }
        function formatDateTime(isoString){ if(!isoString) return ''; try { return new Date(isoString).toLocaleString('ar-EG', {timeZone: 'Africa/Cairo', year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true}) } catch(e) { return isoString } }
        function showMessage(messageElement, text, isError = false, isInfo = false){ if (!messageElement) { /* console.warn("showMessage called with invalid element"); */ return } messageElement.innerHTML = text; // Use innerHTML to render <br> if needed
             messageElement.className = 'section-message'; // Reset classes first
             if (text) { // Only add visibility and color classes if there is text
                 if (isError) { messageElement.classList.add('error'); } else if (isInfo) { messageElement.classList.add('info'); } else { messageElement.classList.add('success'); } messageElement.classList.add('visible'); // Make visible
                 // Auto-hide logic (except for errors, maybe?)
                 if (!isError) {
                      setTimeout(() => { if (messageElement) { messageElement.classList.remove('visible'); } }, 6000); // Increased timeout slightly
                   }
             }
          }
        function showGlobalMessage(text, isError = false, isInfo = false){ const element = d("global-message"); if(!element) return; showMessage(element, text, isError, isInfo); }
        function updateLoadDateDayName(dateString, displayElement) { if (!displayElement) { /* console.warn("Day name display element not provided!"); */ return; } if (!dateString || typeof dateString !== 'string' || !/^\d{4}-\d{2}-\d{2}$/.test(dateString)) { displayElement.textContent = ''; return; } try { const date = new Date(dateString + 'T00:00:00'); // Ensure it's treated as local
             const options = { timeZone: 'Africa/Cairo', weekday: 'long' }; const dayName = date.toLocaleDateString('ar-EG', options); displayElement.textContent = `(${dayName})`; } catch (e) { console.error("Error getting day name for", dateString, ":", e); displayElement.textContent = ''; } }
        function getPreviousDayString(dateString) { try { const date = new Date(dateString + 'T00:00:00'); date.setDate(date.getDate() - 1); const year = date.getFullYear(); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; } catch (e) { console.error("Error calculating previous day for", dateString, e); return null; } }
        // الدالة الجديدة لتحديد اليوم التالي
        function getNextDayString(dateString) {
             try {
                 const date = new Date(dateString + 'T00:00:00'); // Treat as local date
                 date.setDate(date.getDate() + 1);
                 const year = date.getFullYear();
                 const month = String(date.getMonth() + 1).padStart(2, '0');
                 const day = String(date.getDate()).padStart(2, '0');
                 return `${year}-${month}-${day}`;
             } catch (e) {
                 console.error("Error calculating next day for", dateString, e);
                 return null;
             }
          }
        function generateId(prefix = 'id') { return `${prefix}-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`; }
        function getMonthStartDateEndDate(yearMonth) { //YYYY-MM format
             try {
                 const [year, month] = yearMonth.split('-').map(Number);
                 if (isNaN(year) || isNaN(month) || month < 1 || month > 12) {
                     throw new Error("Invalid year-month format");
                 }
                 const startDate = new Date(Date.UTC(year, month - 1, 1));
                 const endDate = new Date(Date.UTC(year, month, 0)); // Last day of the month
                 const dates = [];
                 let currentDate = new Date(startDate);
                 // Ensure loop doesn't run indefinitely if date logic is flawed
                 let safetyCounter = 0;
                 while (currentDate <= endDate && safetyCounter < 32) {
                     dates.push(currentDate.toISOString().split('T')[0]); // Get YYYY-MM-DD in UTC
                     currentDate.setUTCDate(currentDate.getUTCDate() + 1);
                     safetyCounter++;
                 }
                 return dates; // Array of YYYY-MM-DD strings for the month
             } catch (error) {
                 console.error("Error generating dates for month:", yearMonth, error);
                 return []; // Return empty array on error
             }
          }
        function updateTimeDisplay() {
            if (!currentTimeDisplay) return;
            const now = new Date();
            // Use Intl.DateTimeFormat for better locale support and options
            const options = { timeZone: 'Africa/Cairo', hour: 'numeric', minute: '2-digit', second: '2-digit', hour12: true };
            currentTimeDisplay.textContent = new Intl.DateTimeFormat('ar-EG', options).format(now);
        }
        // --- Undo/Redo State Management Functions ---

function createStateSnapshot() {
    // هذه الدالة تجمع كل بيانات البرنامج المهمة في كائن واحد "لقطة"
    return {
        products: JSON.parse(JSON.stringify(products)),
        suppliers: JSON.parse(JSON.stringify(suppliers)),
        liquidity: liquidity,
        expenses: expenses,
        debtors: JSON.parse(JSON.stringify(debtors)),
        liabilities: JSON.parse(JSON.stringify(liabilities)),
        monthlyLiabilities: JSON.parse(JSON.stringify(monthlyLiabilities)),
        totalProfit: totalProfit,
        operationLog: JSON.parse(JSON.stringify(operationLog)),
        pendingSales: JSON.parse(JSON.stringify(pendingSales)),
        liquidityLog: JSON.parse(JSON.stringify(liquidityLog)),
        salesToday: JSON.parse(JSON.stringify(salesToday)),
        serialNumbersLog: JSON.parse(JSON.stringify(serialNumbersLog)),
    };
}

function loadStateFromSnapshot(snapshot) {
    // هذه الدالة تقوم "بتحميل" اللقطة وتطبيقها على البرنامج
    products = snapshot.products;
    suppliers = snapshot.suppliers;
    liquidity = snapshot.liquidity;
    expenses = snapshot.expenses;
    debtors = snapshot.debtors;
    liabilities = snapshot.liabilities;
    monthlyLiabilities = snapshot.monthlyLiabilities;
    totalProfit = snapshot.totalProfit;
    operationLog = snapshot.operationLog;
    pendingSales = snapshot.pendingSales;
    liquidityLog = snapshot.liquidityLog;
    salesToday = snapshot.salesToday;
    serialNumbersLog = snapshot.serialNumbersLog;
}

function saveStateToHistory() {
    // هذه هي الدالة الرئيسية التي سنستدعيها قبل كل إجراء
    // 1. أضف الحالة الحالية إلى ذاكرة التراجع
    stateHistory.push(createStateSnapshot());

    // 2. امسح ذاكرة الإعادة، لأن أي إجراء جديد يلغيها
    redoHistory = [];

    // 3. تفعيل زر التراجع وتعطيل زر الإعادة
    const undoBtn = d('undo-button');
    const redoBtn = d('redo-button');
    if (undoBtn) undoBtn.disabled = false;
    if (redoBtn) redoBtn.disabled = true;

    // اختياري: وضع حد لذاكرة التراجع لمنع استهلاك ذاكرة كبير جدًا
    if (stateHistory.length > 50) {
        stateHistory.shift(); // إزالة أقدم عنصر
    }
}
function updateUndoRedoButtons() {
    // تحديث حالة أزرار التراجع والإعادة
    const undoBtn = d('undo-button');
    const redoBtn = d('redo-button');
    if (undoBtn) undoBtn.disabled = stateHistory.length === 0;
    if (redoBtn) redoBtn.disabled = redoHistory.length === 0;
}

function undo() {
    if (stateHistory.length === 0) {
        console.log("No more states to undo.");
        return; // لا يوجد شيء للتراجع عنه
    }

    // 1. احفظ الحالة الحالية في ذاكرة الإعادة قبل التراجع
    redoHistory.push(createStateSnapshot());

    // 2. استرجع آخر حالة من ذاكرة التراجع
    const lastState = stateHistory.pop();
    loadStateFromSnapshot(lastState);

    // 3. تحديث الواجهة والأزرار
    updateUI();
    updateUndoRedoButtons();
    console.log("Undo action performed.");
}

function redo() {
    if (redoHistory.length === 0) {
        console.log("No more states to redo.");
        return; // لا يوجد شيء للإعادة
    }

    // 1. احفظ الحالة الحالية في ذاكرة التراجع قبل الإعادة
    stateHistory.push(createStateSnapshot());

    // 2. استرجع آخر حالة من ذاكرة الإعادة
    const nextState = redoHistory.pop();
    loadStateFromSnapshot(nextState);

    // 3. تحديث الواجهة والأزرار
    updateUI();
    updateUndoRedoButtons();
    console.log("Redo action performed.");
}

        // --- دوال المنطق الأساسي ---
        function calculateConsignmentValue(){ return pendingSales.reduce((sum, sale) => { const mainCost = (Number(sale.mainProduct.costPrice) || 0) * (Number(sale.mainProduct.quantity) || 0); const additionalCost = (sale.additionalItems || []).reduce((addSum, item) => addSum + ((Number(item.costPrice) || 0) * (Number(item.quantity) || 0)), 0); return sum + mainCost + additionalCost }, 0) }
        function loadState(data, dateString){
        monthlyLiabilities = data.monthlyLiabilities || [];
             console.log("loadState called for date:", dateString, data); // Log input data
             products = data.products || [];
             suppliers = data.suppliers || [];
             liquidity = parseFloat(data.liquidity) || 0;
             expenses = parseFloat(data.expenses) || 0;
             debtors = data.debtors || [];
             liabilities = data.liabilities || [];
             totalProfit = parseFloat(data.profit) || 0;
             operationLog = data.log || [];
             pendingSales = data.pendingSales || []; // goodsOnConsignmentValue will be recalculated in updateUI
             liquidityLog = data.liquidityLog || [];
             salesToday = data.salesToday || [];
             serialNumbersLog = data.serialNumbersLog || []; // **** تحميل سجل السيريالات ****
             currentLoadedDate = dateString;
             console.log("currentLoadedDate set in loadState:", currentLoadedDate);
             // **** سطر التشخيص المضاف ****
             console.log('Inside loadState Check - Liquidity:', liquidity, 'Products count:', products.length, 'Debtors count:', debtors.length, 'Serials count:', serialNumbersLog.length);

    // أضف هذا في النهاية
    stateHistory = [];
    redoHistory = [];
    updateUndoRedoButtons();
         }
        function resetState(){
        monthlyLiabilities = [];
resetMonthlyLiabilityForm();
             console.log("resetState called.");
             products = []; suppliers = []; liquidity = 0; expenses = 0; debtors = []; liabilities = [];
             totalProfit = 0; operationLog = []; pendingSales = []; goodsOnConsignmentValue = 0;
             liquidityLog = []; salesToday = []; serialNumbersLog = []; // **** تصفير سجل السيريالات ****
             currentLoadedDate = null;
             console.log("currentLoadedDate reset in resetState:", currentLoadedDate);
             const dateInputElement = d("load-date-alt"); const dayDisplayElement = d("load-date-day-name-alt");
             if(dateInputElement) dateInputElement.value = ""; if(dayDisplayElement) dayDisplayElement.textContent = "";
             // Clear any previous messages on reset
             const messageElements = document.querySelectorAll('.section-message, .error-message');
             messageElements.forEach(el => {el.textContent = ''; el.classList.remove('visible','error','success','info');});
             resetProductForm(); resetSupplierForm();
              
    stateHistory = [];
    redoHistory = [];
    updateUndoRedoButtons();
         }
        function logOperation(type, details){ const timestamp = new Date().toISOString(); operationLog.push({timestamp, type, details}); updateLogDisplay() } // Log display updated immediately
        function calculateTotalDebts(){ const total = debtors.reduce((sum, debtor) => sum + (Number(debtor.amount) || 0), 0); return total; }
        function calculateTotalLiabilities(){ return liabilities.reduce((sum, liability) => sum + (Number(liability.amount) || 0), 0) }
        function calculateTotals(){ const totalInventoryValue = products.reduce((sum, p) => sum + (Number(p.quantity) || 0) * (Number(p.costPrice) || 0), 0); goodsOnConsignmentValue = calculateConsignmentValue(); // Recalculate consignment value here
             const totalDebtsValue = calculateTotalDebts(); const totalLiabilitiesValue = calculateTotalLiabilities(); const totalCapital = liquidity + totalInventoryValue + goodsOnConsignmentValue + totalDebtsValue - totalLiabilitiesValue; return {totalInventoryValue, totalCapital, totalDebtsValue, totalLiabilitiesValue}}

        // --- Supplier Management Functions ---
        function resetSupplierForm() { editingSupplierId = null; if(supplierNameInput) supplierNameInput.value = ""; if(supplierContactInput) supplierContactInput.value = ""; if(supplierAddressInput) supplierAddressInput.value = ""; if(addSupplierButton) addSupplierButton.textContent = "إضافة / تحديث المورد"; if(supplierFormTitle) supplierFormTitle.textContent = "إضافة مورد جديد"; if(cancelEditSupplierButton) cancelEditSupplierButton.classList.add('hidden'); if(supplierMessage) { showMessage(supplierMessage,""); supplierMessage.classList.remove('visible','error','success','info'); } }
        function updateSuppliersListDisplay() {
             if(!supplierList) return;
             if (suppliers.length === 0) {
                 supplierList.innerHTML = '<p class="text-center text-gray-500 col-span-full">لا يوجد موردين مسجلين بعد.</p>';
             } else {
                 const sortedSuppliers = [...suppliers].sort((a, b) => a.name.localeCompare(b.name, 'ar'));
                 supplierList.innerHTML = sortedSuppliers.map(supplier => `
                     <div class="bg-gray-50 rounded-lg shadow p-4 border border-gray-200 flex flex-col justify-between">
                         <div>
                             <h4 class="text-lg font-semibold text-gray-800 mb-2">${supplier.name}</h4>
                             ${supplier.contact ? `<p class="text-gray-600 text-sm">الاتصال: ${supplier.contact}</p>` : ''}
                             ${supplier.address ? `<p class="text-gray-600 text-sm">العنوان: ${supplier.address}</p>` : ''}
                         </div>
                         <div class="mt-3 pt-3 border-t border-gray-200 flex justify-end gap-2 supplier-actions">
                             <button data-supplier-id="${supplier.id}" class="edit-supplier-btn text-xs bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-semibold py-1 px-2 rounded border border-yellow-500">تعديل</button>
                             <button data-supplier-id="${supplier.id}" class="delete-supplier-btn text-xs bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-2 rounded border border-red-600">حذف</button>
                         </div>
                     </div>
                 `).join('');
             }
             // **** تحديث datalist لأسماء الموردين للبحث ****
             if(supplierNamesDatalist) {
                 supplierNamesDatalist.innerHTML = suppliers.map(s => `<option value="${s.name}"></option>`).join('');
             }
         }
        function updateSupplierDropdown(selectElementId, selectedSupplierId = null) { const selectElement = d(selectElementId); if (!selectElement) { /*console.warn(`Dropdown element #${selectElementId} not found yet.`);*/ return; } const currentVal = selectElement.value; selectElement.innerHTML = '<option value="">-- اختر المورد --</option>'; const sortedSuppliers = [...suppliers].sort((a, b) => a.name.localeCompare(b.name, 'ar')); sortedSuppliers.forEach(supplier => { const option = document.createElement('option'); option.value = supplier.id; option.textContent = supplier.name; if (selectedSupplierId && supplier.id === selectedSupplierId) { option.selected = true; } else if (!selectedSupplierId && supplier.id === currentVal) { // Retain current selection if not specifically overridden
                 option.selected = true; } selectElement.appendChild(option); }); }
        function addOrUpdateSupplier() { if (!supplierNameInput || !supplierContactInput || !supplierAddressInput || !supplierMessage) return; // Ensure elements exist
             const name = supplierNameInput.value.trim(); const contact = supplierContactInput.value.trim(); const address = supplierAddressInput.value.trim(); if (!name) { showMessage(supplierMessage, "اسم المورد مطلوب.", true); return; } if (editingSupplierId) { const supplierIndex = suppliers.findIndex(s => s.id === editingSupplierId); if (supplierIndex > -1) { const oldName = suppliers[supplierIndex].name; suppliers[supplierIndex].name = name; suppliers[supplierIndex].contact = contact; suppliers[supplierIndex].address = address; logOperation("تعديل مورد", `تم تعديل بيانات المورد "${oldName}" إلى "${name}".`); showMessage(supplierMessage, `تم تحديث المورد "${name}" بنجاح.`); } else { showMessage(supplierMessage, `خطأ: المورد المحدد للتعديل غير موجود.`, true); } resetSupplierForm(); } else { // Check if name already exists
             const nameExists = suppliers.some(s => s.name.toLowerCase() === name.toLowerCase());
             if (nameExists) {
                 showMessage(supplierMessage, `المورد "${name}" موجود بالفعل.`, true);
                 return;
             }
             const newSupplier = { id: generateId('sup'), name: name, contact: contact, address: address }; suppliers.push(newSupplier); logOperation("إضافة مورد", `تم إضافة مورد جديد: "${name}".`); showMessage(supplierMessage, `تمت إضافة المورد "${name}" بنجاح.`); supplierNameInput.value = ""; // Clear only name on successful add
                 supplierContactInput.value = ""; supplierAddressInput.value = ""; supplierNameInput.focus(); } updateUI(); } // Update UI including dropdowns
        function editSupplier(supplierId) { const supplier = suppliers.find(s => s.id === supplierId); if (supplier && supplierNameInput && supplierContactInput && supplierAddressInput && supplierFormTitle && addSupplierButton && cancelEditSupplierButton) { editingSupplierId = supplierId; supplierNameInput.value = supplier.name; supplierContactInput.value = supplier.contact || ""; supplierAddressInput.value = supplier.address || ""; supplierFormTitle.textContent = `تعديل المورد: ${supplier.name}`; addSupplierButton.textContent = "تحديث المورد"; cancelEditSupplierButton.classList.remove('hidden'); d('add-update-supplier-form').scrollIntoView({ behavior: 'smooth' }); } else { showMessage(supplierMessage, "المورد المحدد غير موجود أو عناصر النموذج غير جاهزة.", true); } }
        function deleteSupplier(supplierId) {
             const supplierIndex = suppliers.findIndex(s => s.id === supplierId);
             if (supplierIndex > -1) {
                 const supplierName = suppliers[supplierIndex].name;
                 if (confirm(`هل أنت متأكد من حذف المورد "${supplierName}"؟ سيتم إزالة ربطه من جميع المنتجات والأرقام التسلسلية المسجلة باسمه.`)) {
                     suppliers.splice(supplierIndex, 1);
                     let updatedProductsCount = 0;
                     products.forEach(p => {
                         if (p.supplierId === supplierId) {
                             p.supplierId = "";
                             updatedProductsCount++;
                         }
                     });
                     // **** حذف السيريالات المرتبطة بالمورد المحذوف ****
                     const initialSerialCount = serialNumbersLog.length;
                     serialNumbersLog = serialNumbersLog.filter(log => log.supplierId !== supplierId);
                     const deletedSerialCount = initialSerialCount - serialNumbersLog.length;

                     logOperation("حذف مورد", `تم حذف المورد "${supplierName}". تم فك ارتباط ${updatedProductsCount} منتج. تم حذف ${deletedSerialCount} رقم تسلسلي مسجل باسمه.`);
                     showMessage(supplierMessage, `تم حذف المورد "${supplierName}" والسيريالات المرتبطة به.`);
                     if (editingSupplierId === supplierId) { resetSupplierForm(); }
                     updateUI();
                 }
             } else {
                 showMessage(supplierMessage, "المورد المحدد غير موجود.", true);
             }
          }

        // *** JavaScript - (Corresponding to original Part 5) Ends Here ***
        // *** JavaScript - (Corresponding to original Part 6) Starts Here ***

        // --- دوال تحديث الواجهة (UI Updates) ---
        function updateProductListDisplay(){
             const productList = d("product-list");
             const productNamesDatalist = d("product-names-list");
             if(!productList || !productNamesDatalist) { return; }

             if(products.length === 0){
                 productList.innerHTML = '<p class="text-center text-gray-500 col-span-full">لا توجد بضائع حتى الآن.</p>';
                 productNamesDatalist.innerHTML = '';
             } else {
                 const sortedProducts = [...products].sort((a, b) => a.name.localeCompare(b.name, 'ar'));
                 const productsHTML = sortedProducts.map(product => {
                     const supplier = suppliers.find(s => s.id === product.supplierId);
                     // حساب عدد السيريالات المسجلة لهذا المنتج
                     const registeredSerialsCount = serialNumbersLog.filter(s => s.productName === product.name).length;
                     const quantity = Number(product.quantity) || 0;
                     const unregisteredCount = quantity - registeredSerialsCount;

                     return `<div class="bg-gray-50 rounded-lg shadow p-4 border border-gray-200 flex flex-col justify-between">
                                 <div>
                                     <h3 class="text-lg font-semibold text-gray-800 mb-2">${product.name || 'غير مسمى'}</h3>
                                     <p class="text-gray-600 text-sm">الكمية الإجمالية: <span class="font-semibold text-blue-500">${quantity}</span></p>
                                     <p class="text-gray-600 text-sm">السيريالات المسجلة: <span class="font-semibold text-green-600">${registeredSerialsCount}</span></p>
                                     ${unregisteredCount > 0 ? `<p class="text-xs text-red-500">قطع غير مسجلة: ${unregisteredCount}</p>` : ''}
                                     <p class="text-gray-600 text-sm">المورد: <span class="font-semibold text-cyan-600">${supplier ? supplier.name : '-'}</span></p>
                                     <p class="text-gray-600 text-sm">متوسط التكلفة: <span class="font-semibold text-purple-500">${formatCurrency(product.costPrice)}</span></p>
                                     <p class="text-gray-600 text-sm">إجمالي التكلفة: <span class="font-semibold text-gray-700">${formatCurrency(quantity * (Number(product.costPrice) || 0))}</span></p>
                                 </div>
                                 <div class="mt-3 pt-3 border-t border-gray-200 flex justify-end gap-2 product-actions">
                                     <button data-product-name="${product.name}" class="manage-serials-btn text-xs font-semibold py-1 px-2 rounded">إدارة السيريالات</button>
                                     <button data-product-name="${product.name}" class="edit-product-btn text-xs bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-semibold py-1 px-2 rounded border border-yellow-500">تعديل</button>
                                     <button data-product-name="${product.name}" class="delete-product-btn text-xs bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-2 rounded border border-red-600">حذف</button>
                                 </div>
                             </div>`
                 }).join('');
                 productList.innerHTML = productsHTML;
                 productNamesDatalist.innerHTML = sortedProducts.map(p => `<option value="${p.name}"></option>`).join('');
             }
          }
        function updateLogDisplay(){if(!operationLogList){return;} if(operationLog.length === 0){operationLogList.innerHTML = '<li class="text-center text-gray-500 list-none">لا توجد عمليات مسجلة بعد.</li>';} else {operationLogList.innerHTML = [...operationLog].reverse().map(log => `<li class=""><span class="font-semibold text-gray-700">${log.type}:</span> <span class="text-gray-600">${log.details}</span><span class="block text-xs text-gray-400">${formatDateTime(log.timestamp)}</span></li>`).join('');} }
      function updateAdditionalCostsCheckboxes() {
    if (!additionalCostsContainer || !sellProductNameInput) return;
    const mainProductName = sellProductNameInput.value.trim().toLowerCase();
    const otherProducts = products.filter(p => p.name.trim().toLowerCase() !== mainProductName && p.quantity > 0);

    additionalCostsContainer.innerHTML = ''; // أفرغ الحاوية أولاً

    if (otherProducts.length === 0) {
        additionalCostsContainer.innerHTML = '<p class="text-center text-gray-500 text-sm">لا توجد منتجات أخرى متاحة لخصم تكلفتها.</p>';
        return;
    }

    otherProducts.sort((a, b) => a.name.localeCompare(b.name, 'ar')).forEach(product => {
        const uniqueId = `addcost-${generateId(product.name)}`;
        const label = document.createElement('label');
        // استخدام flexbox لتنسيق العناصر على نفس السطر
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.gap = '10px'; // مسافة بين العناصر
        label.style.marginBottom = '8px';

        label.innerHTML = `
            <input type="checkbox" value="${product.name}" data-cost="${product.costPrice}" id="${uniqueId}" style="flex-shrink: 0;">
            <span style="flex-grow: 1;">
                ${product.name} (متوسط التكلفة: ${formatCurrency(product.costPrice)}, المتاح: ${product.quantity})
            </span>
            <span style="flex-shrink: 0;">الكمية للخصم:</span>
            <input type="number" class="additional-item-quantity" min="1" value="1" style="width: 60px; text-align: center; flex-shrink: 0; border: 1px solid #ccc; border-radius: 4px; padding: 2px;">
        `;
        additionalCostsContainer.appendChild(label);
    });
}
        function updateDebtorsListDisplay(){ if(!debtorsListContainer) return; debtorsListContainer.innerHTML=''; // Clear previous content
             const groupedDebts = debtors.reduce((acc, debt) => { const name = debt.name; if (!acc[name]) { acc[name] = { total: 0, items: [] }; } const amount = Number(debt.amount) || 0; if (amount > 0.001) { // Only include non-zero amounts
                  acc[name].total += amount; acc[name].items.push({ id: debt.id, reason: debt.reason || 'سبب غير محدد', amount: amount }); } return acc; }, {}); const sortedNames = Object.keys(groupedDebts).filter(name => groupedDebts[name].total > 0.001) // Filter out names with zero total
                 .sort((a, b) => a.localeCompare(b, 'ar')); if (sortedNames.length === 0) { debtorsListContainer.innerHTML = '<p class="text-center text-gray-500 py-4">لا توجد ديون مسجلة حاليًا بمبالغ ظاهرة.</p>'; return; } sortedNames.forEach(name => { const debtorData = groupedDebts[name]; const detailsElement = document.createElement('details'); detailsElement.className = 'mb-2 border border-gray-200 rounded overflow-hidden shadow-sm'; const summaryElement = document.createElement('summary'); summaryElement.className = 'p-3 bg-gray-50 hover:bg-gray-100 cursor-pointer flex justify-between items-center font-medium text-gray-800'; summaryElement.innerHTML = `<span>${name}</span><span class="text-purple-700 font-semibold">${formatCurrency(debtorData.total)}</span>`; const ulElement = document.createElement('ul'); ulElement.className = 'p-3 pt-2 border-t border-gray-200 bg-white'; debtorData.items.sort((a,b) => a.reason.localeCompare(b.reason, 'ar')).forEach(item => { const liElement = document.createElement('li'); liElement.className = 'text-sm text-gray-600 py-1.5 border-b border-gray-100 flex justify-between items-center'; liElement.innerHTML = `<span>${item.reason}</span><span class="font-mono text-xs">${formatCurrency(item.amount)}</span>`; ulElement.appendChild(liElement); }); detailsElement.appendChild(summaryElement); detailsElement.appendChild(ulElement); debtorsListContainer.appendChild(detailsElement); }); }
        function updatePaymentDebtorDropdown(){ if(!paymentDebtorSelect) return; const currentSelection = paymentDebtorSelect.value; paymentDebtorSelect.innerHTML = '<option value="">-- اختر الدين --</option>'; const validDebts = debtors.filter(d => (Number(d.amount) || 0) > 0.001); const sortedDebtors = validDebts.sort((a, b) => { const nameCompare = a.name.localeCompare(b.name, 'ar'); if (nameCompare !== 0) return nameCompare; return (a.reason || '').localeCompare(b.reason || '', 'ar'); }); let hasSelection = false; sortedDebtors.forEach(debtor => { const option = document.createElement('option'); option.value = debtor.id; option.textContent = `${debtor.name} - ${debtor.reason || 'غير محدد'} (${formatCurrency(debtor.amount)})`; paymentDebtorSelect.appendChild(option); if (debtor.id === currentSelection) { hasSelection = true; } }); if (hasSelection) { paymentDebtorSelect.value = currentSelection; } else { paymentDebtorSelect.value = ""; } }
        function updateLiquidityLogDisplay(){if(!liquidityLogListContainer)return; if(liquidityLog.length === 0){liquidityLogListContainer.innerHTML = '<li class="text-center text-gray-500">لا توجد عمليات مسجلة على السيولة.</li>'} else {liquidityLogListContainer.innerHTML = [...liquidityLog].reverse().map(log => { const amountClass = log.type === 'add' ? 'add' : (log.type === 'remove' ? 'remove' : ''); // Adjust color for 'adjust' if needed later
            const amountSign = log.type === 'add' ? '+' : (log.type === 'remove' ? '-' : (log.amount >= 0 ? '+' : '')); // Show sign for adjustment based on value
            return `<li><div class="flex justify-between items-start"><div><span class="font-medium ${amountClass}">${amountSign}${formatCurrency(Math.abs(log.amount))}</span> <span class="text-sm details">(${log.description || 'بدون وصف'})</span><span class="block text-xs text-gray-400">${formatDateTime(log.timestamp)}</span></div><span class="text-sm details flex-shrink-0 ml-2">الرصيد: ${formatCurrency(log.currentBalance)}</span></div></li>`}).join('')}}
        function updateLiabilitiesListDisplay(){if(!liabilitiesListContainer)return; liabilitiesListContainer.innerHTML = ''; const validLiabilities = liabilities.filter(l => (Number(l.amount) || 0) > 0.001); if(validLiabilities.length === 0){liabilitiesListContainer.innerHTML = '<li class="text-center text-gray-500">لا توجد التزامات مسجلة حاليًا بمبالغ ظاهرة.</li>'} else {const sortedLiabilities = [...validLiabilities].sort((a, b) => a.name.localeCompare(b.name, 'ar')); sortedLiabilities.forEach(liability => { const li = document.createElement('li'); li.className = 'flex justify-between items-center py-1 border-b border-gray-100'; li.innerHTML = `<span class="font-medium">${liability.name}</span> <span class="text-pink-700 font-semibold">${formatCurrency(liability.amount)}</span>`; liabilitiesListContainer.appendChild(li)})}}
        function updatePaymentCreditorDropdown(){if(!paymentCreditorSelect)return; const currentSelection = paymentCreditorSelect.value; paymentCreditorSelect.innerHTML = '<option value="">-- اختر الدائن --</option>'; const validLiabilities = liabilities.filter(l => (Number(l.amount) || 0) > 0.001); const sortedLiabilities = [...validLiabilities].sort((a, b) => a.name.localeCompare(b.name, 'ar')); let hasSelection = false; sortedLiabilities.forEach(liability => { const option = document.createElement('option'); option.value = liability.id; // Use ID for selection
             option.textContent = `${liability.name} (${formatCurrency(liability.amount)})`; paymentCreditorSelect.appendChild(option); if (liability.id === currentSelection) { hasSelection = true; } }); if (hasSelection) { paymentCreditorSelect.value = currentSelection; } else { paymentCreditorSelect.value = ""; } }

        // --- << تعديل دالة تحديث المبيعات المؤقتة >> ---
        function updatePendingSalesDisplay(){
             if(!pendingSalesListContainer || !pendingSalesSearchInput || !pendingSalesTotalCostSpan || !pendingSalesTotalProfitSpan) return;

             // 1. حساب الإجماليات (قبل الفلترة)
             let totalPendingCost = 0;
             let totalPendingProfit = 0;
             pendingSales.forEach(sale => {
                 totalPendingCost += calculateSinglePendingSaleCost(sale);
                 totalPendingProfit += (Number(sale.potentialProfit) || 0);
             });
             pendingSalesTotalCostSpan.textContent = `إجمالي التكلفة: ${formatCurrency(totalPendingCost)}`;
             pendingSalesTotalProfitSpan.textContent = `إجمالي الربح المتوقع: ${formatCurrency(totalPendingProfit)}`;


             // 2. فلترة العرض بناءً على البحث
             const searchTerm = pendingSalesSearchInput.value.trim().toLowerCase();
             const filteredSales = pendingSales.filter(sale => {
                 if (!searchTerm) return true; // Show all if search is empty
                 const customerMatch = sale.customerName && sale.customerName.toLowerCase().includes(searchTerm);
                 const productMatch = sale.mainProduct.name.toLowerCase().includes(searchTerm);
                 // يمكن إضافة البحث في المنتجات الإضافية لو أردت
                 // const additionalMatch = (sale.additionalItems || []).some(item => item.name.toLowerCase().includes(searchTerm));
                 return customerMatch || productMatch; // || additionalMatch;
             });

             // 3. عرض القائمة المفلترة
             if(filteredSales.length === 0){
                 pendingSalesListContainer.innerHTML = `<p class="text-center text-gray-500 text-sm">لا توجد مبيعات مؤقتة تطابق البحث "${searchTerm}".</p>`;
                 return;
             }

             pendingSalesListContainer.innerHTML = filteredSales.map(sale => {
                 let itemsText = `${sale.mainProduct.quantity}x "${sale.mainProduct.name}"`;
                 if(sale.additionalItems && sale.additionalItems.length > 0){itemsText += ` مع (${sale.additionalItems.map(item => `${item.quantity}x "${item.name}"`).join(', ')})`}
                 let customerInfo = sale.customerName ? `<span class="block text-sm text-blue-600">العميل: ${sale.customerName}</span>` : '';
                 const saleCost = calculateSinglePendingSaleCost(sale); // حساب التكلفة للعرض
                 return `<li>
                            <div class="flex justify-between items-start gap-2 flex-wrap">
                                <div>
                                    <span class="block font-semibold">${itemsText}</span>
                                    ${customerInfo}
                                    <span class="block text-sm details">السعر المتوقع: ${formatCurrency(sale.totalSellPrice)} | التكلفة: ${formatCurrency(saleCost)} | الربح المتوقع: ${formatCurrency(sale.potentialProfit)}</span>
                                    <span class="block text-xs text-gray-400">${formatDateTime(sale.timestamp)}</span>
                                </div>
                                <div class="actions flex-shrink-0 flex flex-col sm:flex-row gap-1 mt-1 sm:mt-0">
                                    <button data-pending-id="${sale.id}" class="confirm-pending bg-green-500 hover:bg-green-600 text-white rounded px-2 py-1 text-xs border border-green-700">تأكيد فقط</button>
                                    <button data-pending-id="${sale.id}" class="confirm-invoice-pending bg-yellow-500 hover:bg-yellow-600 text-white rounded px-2 py-1 text-xs border border-yellow-700">تأكيد وفاتورة</button>
                                    <button data-pending-id="${sale.id}" class="cancel-pending bg-red-500 hover:bg-red-600 text-white rounded px-2 py-1 text-xs border border-red-700">إلغاء/إرجاع</button>
                                    <button data-pending-id="${sale.id}" class="print-pending-invoice bg-blue-500 hover:bg-blue-600 text-white rounded px-2 py-1 text-xs border border-blue-700">طباعة (مؤقت)</button>
                                </div>
                            </div>
                         </li>`
             }).join('');
          }
        function calculateSinglePendingSaleCost(sale) { const mainCost = (Number(sale.mainProduct.costPrice) || 0) * (Number(sale.mainProduct.quantity) || 0); const additionalCost = (sale.additionalItems || []).reduce((addSum, item) => addSum + ((Number(item.costPrice) || 0) * (Number(item.quantity) || 0)), 0); return mainCost + additionalCost; }
        function updateOffsetDatalists() { if (!debtorNamesDatalistOffset || !creditorNamesDatalistOffset) return; // Populate Debtor Datalist
             const debtorNames = [...new Set(debtors.filter(d => (Number(d.amount) || 0) > 0.001).map(d => d.name))].sort((a, b) => a.localeCompare(b, 'ar'));
             debtorNamesDatalistOffset.innerHTML = debtorNames.map(name => `<option value="${name}"></option>`).join('');

             // Populate Creditor Datalist
             const creditorNames = [...new Set(liabilities.filter(l => (Number(l.amount) || 0) > 0.001).map(l => l.name))].sort((a, b) => a.localeCompare(b, 'ar'));
             creditorNamesDatalistOffset.innerHTML = creditorNames.map(name => `<option value="${name}"></option>`).join('');
          }

        // --- الدالة الرئيسية لتحديث الواجهة ---
        function updateUI(){
         updateMonthlyLiabilitiesDisplay();
             // **** سطر التشخيص المضاف ****
             console.log('Inside updateUI Start - Liquidity:', liquidity, 'summaryLiquidity Element:', d("summary-current-liquidity"));

             console.log("updateUI called. Current loaded date:", currentLoadedDate);
             const{totalInventoryValue, totalCapital, totalDebtsValue, totalLiabilitiesValue} = calculateTotals(); // This now also recalculates goodsOnConsignmentValue
             // 1. حساب إجمالي الربح المتوقع من جميع المبيعات المؤقتة
    const totalPotentialProfit = pendingSales.reduce((sum, sale) => {
        return sum + (Number(sale.potentialProfit) || 0);
    }, 0);

    // 2. حساب رأس المال المتوقع
    const expectedCapital = totalCapital + totalPotentialProfit;

    // 3. تحديث صندوق العرض الجديد في الواجهة
    summaryExpectedCapital = d("summary-expected-capital");
    if (summaryExpectedCapital) {
        summaryExpectedCapital.textContent = formatCurrency(expectedCapital);
    }

             // Update Summary Widgets
             if(summaryLiquidity) summaryLiquidity.textContent = formatCurrency(liquidity);
             if(summaryInventory) summaryInventory.textContent = formatCurrency(totalInventoryValue);
             if(summaryConsignment) summaryConsignment.textContent = formatCurrency(goodsOnConsignmentValue);
             if(summaryDebts) summaryDebts.textContent = formatCurrency(totalDebtsValue);
             if(summaryLiabilities) summaryLiabilities.textContent = formatCurrency(totalLiabilitiesValue);
             if(summaryExpenses) summaryExpenses.textContent = formatCurrency(expenses);
             if(summaryProfit) summaryProfit.textContent = formatCurrency(totalProfit);
             if(summaryCapital) summaryCapital.textContent = formatCurrency(totalCapital);

             // Update Inventory Section Details
             if(inventoryTotalInventoryValue) inventoryTotalInventoryValue.textContent = `إجمالي قيمة المخزون: ${formatCurrency(totalInventoryValue)}`;
             if(inventoryConsignmentValue) inventoryConsignmentValue.textContent = `قيمة مؤقتة: ${formatCurrency(goodsOnConsignmentValue)}`;
             if(inventoryTotalProfit) inventoryTotalProfit.textContent = `إجمالي الربح: ${formatCurrency(totalProfit)}`;

             // Update Lists and Dropdowns
             updateProductListDisplay(); // Includes product datalist update & manage serials button
             updateSuppliersListDisplay(); // Includes supplier datalist update for serial search
             updateSupplierDropdown('product-supplier'); // Update product form dropdown
             updateLogDisplay();
             updateAdditionalCostsCheckboxes(); // Update checkboxes in sell section
             updatePendingSalesDisplay(); // <<< Now updates totals and filtered list
             updateDebtorsListDisplay();
             updatePaymentDebtorDropdown();
             updateLiquidityLogDisplay();
             updateLiabilitiesListDisplay();
             updatePaymentCreditorDropdown();
             updateOffsetDatalists(); // Update datalists in offset section

             // Update Section Headers/Totals
             if(totalDebtsDisplay) totalDebtsDisplay.textContent = `إجمالي الديون: ${formatCurrency(totalDebtsValue)}`;
             if(currentLiquidityDisplay) currentLiquidityDisplay.textContent = formatCurrency(liquidity);
             if(totalExpensesDisplay) totalExpensesDisplay.textContent = formatCurrency(expenses);
             if(totalLiabilitiesDisplay) totalLiabilitiesDisplay.textContent = `إجمالي الالتزامات: ${formatCurrency(totalLiabilitiesValue)}`;

             // Update Top Bar Date Display
             if(currentDataDateDisplay){currentDataDateDisplay.textContent = currentLoadedDate ? formatDateForDisplay(currentLoadedDate) : "بيانات جديدة (لم تحفظ بعد)"}

             // Update invoice deductible costs only if modal is open (potentially redundant, but safe)
             if (inv_modal && inv_modal.style.display === 'block') {
                 inv_updateDeductibleCostsCheckboxes();
             }
             // ... at the end of updateUI() function
// Populate for the first time if the financial center tab is active initially
if (d('financial-center-section') && !d('financial-center-section').classList.contains('hidden')) {
    const activeTab = d('fc-main-tabs').querySelector('.fc-tab-button.active');
    if (activeTab) {
        const targetId = activeTab.dataset.target;
        if (targetId === 'fc-tab-distribution') {
            fc_populate_month_select();
        } else if (targetId === 'fc-tab-debt-treatment') {
            fc_populate_debt_treatment();
        }
        // Note: The expenses and monthly liabilities tabs will be updated by the main updateUI function
    }
}
          }

        // --- حفظ وتحميل وتصدير واستيراد ---
        // =======================================================
// START: دالة الحفظ الجديدة (المتصلة بالإنترنت)
// =======================================================
async function saveCurrentStateByDate(dateString) {
    console.log(`Saving data to Firebase for date: ${dateString}`);

    // تجهيز كائن البيانات للحفظ، تمامًا مثل السابق
    const stateToSave = {
        products, suppliers, liquidity, expenses, debtors, liabilities, monthlyLiabilities,
        profit: totalProfit, log: operationLog, pendingSales,
        liquidityLog, salesToday, serialNumbersLog, inboxTasks, // <-- تأكد من إضافة inboxTasks هنا
        savedAt: new Date().toISOString(),
        savedForDate: dateString
    };

    try {
        // هذا هو السطر الجديد الذي يحفظ البيانات على الإنترنت
        // يقوم بإنشاء "مستند" داخل "مجموعة" اسمها "days" ويستخدم التاريخ كاسم للمستند
        const docRef = window.doc(window.db, "days", dateString);
        await window.setDoc(docRef, stateToSave);
        saveData(lsPrefix + dateString, stateToSave);

        // لم نعد بحاجة لحفظ آخر تاريخ في localStorage، ولكن يمكن إبقاؤه مؤقتًا
        // saveData(lsLastSaveKey, dateString); 

        currentLoadedDate = dateString;
        updateUI();
        showGlobalMessage(`تم حفظ البيانات بنجاح على الإنترنت لتاريخ: ${formatDateForDisplay(dateString)}`, false);
    } catch (error) {
        console.error("Error saving data to Firebase: ", error);
        showGlobalMessage("حدث خطأ أثناء محاولة حفظ البيانات على الإنترنت. يرجى مراجعة الـ Console.", true);
    }
}
// =======================================================
// END: دالة الحفظ الجديدة
// =======================================================
        
        // =======================================================
// START: دالة تحميل البيانات الجديدة (من الإنترنت)
// =======================================================
// =======================================================
// START: دالة تحميل البيانات النهائية (مع الترحيل)
// =======================================================
async function loadDataForDate(dateString) {
    const loadMessageElement = d("load-message-alt");
    const dateInputElement = d("load-date-alt");
    const dayDisplayElement = d("load-date-day-name-alt");

    if (!dateString) {
        if (loadMessageElement) showMessage(loadMessageElement, "يرجى اختيار تاريخ للتحميل.", true);
        return false;
    }

    console.log(`=> Loading data from Firebase for: ${dateString}`);

    try {
        const docRef = window.doc(window.db, "days", dateString);
        const docSnap = await window.getDoc(docRef);

        if (docSnap.exists()) {
            console.log("Data found in Firebase for", dateString);
            loadState(docSnap.data(), dateString);
            if (loadMessageElement) showMessage(loadMessageElement, `تم تحميل البيانات بنجاح من الإنترنت لتاريخ ${formatDateForDisplay(dateString)}.`, false);
        } else {
            console.log("No data in Firebase for", dateString, ". Attempting carry-forward.");
            const previousDayString = getPreviousDayString(dateString);
            if (!previousDayString) {
                resetState();
                currentLoadedDate = dateString;
                return true;
            }

            const prevDocRef = window.doc(window.db, "days", previousDayString);
            const prevDocSnap = await window.getDoc(prevDocRef);

            if (prevDocSnap.exists()) {
                console.log(`Found previous day's data (${previousDayString}). Carrying forward.`);
                const previousData = prevDocSnap.data();

                products = previousData.products || [];
                suppliers = previousData.suppliers || [];
                liquidity = parseFloat(previousData.liquidity) || 0;
                debtors = previousData.debtors || [];
                liabilities = previousData.liabilities || [];
                monthlyLiabilities = previousData.monthlyLiabilities || [];
                pendingSales = previousData.pendingSales || [];
                serialNumbersLog = previousData.serialNumbersLog || [];
                inboxTasks = previousData.inboxTasks || [];

                expenses = 0;
                totalProfit = 0;
                operationLog = [];
                liquidityLog = [];
                salesToday = [];

                logOperation("ترحيل تلقائي", `تم ترحيل الأرصدة من يوم ${formatDateForDisplay(previousDayString)} إلى اليوم الحالي.`);
                if (loadMessageElement) showMessage(loadMessageElement, `تم ترحيل الأرصدة من اليوم السابق إلى تاريخ ${formatDateForDisplay(dateString)}.`, false);
            } else {
                console.log("No previous day's data found. Starting fresh.");
                resetState();
                if (loadMessageElement) showMessage(loadMessageElement, `لا توجد بيانات محفوظة لهذا اليوم أو لليوم السابق. تم البدء بيوم جديد فارغ.`, false, true);
            }
        }

        currentLoadedDate = dateString;
        if (dateInputElement) dateInputElement.value = dateString;
        updateLoadDateDayName(dateString, dayDisplayElement);
        return true;

    } catch (error) {
        console.error("Error in loadDataForDate: ", error);
        if (loadMessageElement) showMessage(loadMessageElement, "حدث خطأ أثناء التعامل مع البيانات من الإنترنت.", true);
        return false;
    }
}
// =======================================================
// END: دالة تحميل البيانات النهائية
// =======================================================
// =======================================================
// END: دالة تحميل البيانات الجديدة
// =======================================================
        function exportData() {
             console.log("Export button clicked. currentLoadedDate:", currentLoadedDate);
             const dateToExport = currentLoadedDate || getTodayDateString(); // Use loaded date or today if none loaded
              // Recalculate totals just before export to ensure consistency
              const { totalInventoryValue, totalCapital, totalDebtsValue, totalLiabilitiesValue } = calculateTotals();
              const stateToExport = {
                  products, suppliers, liquidity, expenses, debtors, liabilities,
                  profit: totalProfit, log: operationLog, pendingSales,
                  liquidityLog, salesToday,
                  serialNumbersLog, // **** تضمين سجل السيريالات في التصدير ****
                  savedAt: new Date().toISOString(),
                  savedForDate: dateToExport
              };
              const jsonString = JSON.stringify(stateToExport, null, 2);
              const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8' });
              const url = URL.createObjectURL(blob);
              const link = document.createElement('a');
              link.href = url;
              link.download = `بيانات_ادارة_البضائع_${dateToExport}.json`;
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              URL.revokeObjectURL(url);
              showGlobalMessage(`تم تجهيز ملف التصدير للبيانات المعروضة (تاريخ ${formatDateForDisplay(dateToExport)}).`, false);
          }
        function importData(event) {
             const file = event.target.files[0];
             const importMsgElement = d("import-message");
             if (!file) { showMessage(importMsgElement, "لم يتم اختيار ملف.", true); return; }
             if (!/\.(json|txt)$/i.test(file.name)) { showMessage(importMsgElement, "الرجاء اختيار ملف بصيغة JSON أو TXT.", true); event.target.value = null; return; }
             const reader = new FileReader();
             reader.onload = function(e) {
                 try {
                     const importedData = JSON.parse(e.target.result);
                     // Basic validation: check if it's an object and has savedForDate
                     if (typeof importedData !== 'object' || importedData === null || !importedData.savedForDate || typeof importedData.savedForDate !== 'string') {
                         throw new Error("ملف JSON غير صالح أو لا يحتوي على حقل 'savedForDate' صحيح.");
                     }
                     // **** التحقق من وجود مصفوفة السيريالات (حتى لو فارغة) ****
                     if (!Array.isArray(importedData.serialNumbersLog)) {
                         console.warn("Imported data missing 'serialNumbersLog' array. Initializing as empty.");
                         importedData.serialNumbersLog = []; // Initialize if missing
                     }

                     const originalDate = importedData.savedForDate;
                     const targetDateInputElement = d("load-date-alt");
                     const targetDate = targetDateInputElement ? targetDateInputElement.value : null;

                     if (!targetDate) {
                         showMessage(importMsgElement, "يرجى اختيار التاريخ الذي تريد استيراد البيانات إليه أولاً من قسم التحميل.", true);
                         event.target.value = null;
                         return;
                     }

                     const confirmationMsg = `الملف يحتوي على بيانات بتاريخ ${formatDateForDisplay(originalDate)}. هل تريد استيرادها وتطبيقها على تاريخ ${formatDateForDisplay(targetDate)}؟\n\nتحذير: سيتم الكتابة فوق أي بيانات موجودة لتاريخ ${formatDateForDisplay(targetDate)}.`;

                     if (confirm(confirmationMsg)) {
                         console.log(`Import confirmed. Importing data originally from ${originalDate} TO ${targetDate}`);
                         importedData.savedForDate = targetDate; // Set the date to the target date
                         loadState(importedData, targetDate); // Load the imported state (including serials)
                         saveCurrentStateByDate(targetDate); // Save the newly loaded state for the target date
                         updateUI(); // Update the display
                         const dayDisplayElement = d("load-date-day-name-alt");
                         if(targetDateInputElement) targetDateInputElement.value = targetDate;
                         updateLoadDateDayName(targetDate, dayDisplayElement);
                         showMessage(importMsgElement, `تم استيراد البيانات وتطبيقها بنجاح على تاريخ ${formatDateForDisplay(targetDate)}.`, false);
                     } else {
                         console.log("Import cancelled by user.");
                         showMessage(importMsgElement, "تم إلغاء عملية الاستيراد.", false, true);
                     }
                 } catch (error) {
                     console.error("Error parsing or validating imported file:", error);
                     showMessage(importMsgElement, `حدث خطأ أثناء قراءة أو تحليل الملف: ${error.message}`, true);
                 } finally {
                     event.target.value = null; // Reset file input
                 }
             };
             reader.onerror = function(e) {
                 console.error("Error reading file:", e);
                 showMessage(importMsgElement, "حدث خطأ أثناء قراءة الملف.", true);
                 event.target.value = null;
             };
             reader.readAsText(file, 'UTF-8');
          }

        // --- تقرير الطباعة العام ---
        function generateReportHTML(){ const {totalInventoryValue, totalCapital, totalDebtsValue, totalLiabilitiesValue} = calculateTotals(); const now = new Date(); const reportDate = currentLoadedDate ? formatDateForDisplay(currentLoadedDate) : "بيانات حالية غير محفوظة"; const printDateTime = now.toLocaleString('ar-EG', {timeZone: 'Africa/Cairo', dateStyle: 'full', timeStyle: 'medium'}); let productsTable = '<p>لا توجد منتجات في المخزون.</p>'; if(products.length > 0){ productsTable = `<table border="1" style="width:100%;border-collapse:collapse;margin-top:10px;font-size:.9em"><thead><tr style="background-color:#f2f2f2"><th style="padding:5px">اسم البضاعة</th><th style="padding:5px">الكمية</th><th style="padding:5px">المورد</th><th style="padding:5px">متوسط التكلفة</th><th style="padding:5px">إجمالي التكلفة</th></tr></thead><tbody>${[...products].sort((a, b) => a.name.localeCompare(b.name, 'ar')).map(p => { const supplier = suppliers.find(s => s.id === p.supplierId); return `<tr><td style="padding:5px">${p.name || 'غير مسمى'}</td><td style="padding:5px;text-align:center;">${Number(p.quantity) || 0}</td><td style="padding:5px">${supplier ? supplier.name : '-'}</td><td style="padding:5px;text-align:center;">${formatCurrency(p.costPrice)}</td><td style="padding:5px;text-align:center;">${formatCurrency((Number(p.quantity) || 0) * (Number(p.costPrice) || 0))}</td></tr>` }).join('')}</tbody><tfoot><tr style="background-color:#f2f2f2;font-weight:bold;"><td colspan="4" style="padding:5px;text-align:left;">إجمالي قيمة المخزون:</td><td style="padding:5px;text-align:center;">${formatCurrency(totalInventoryValue)}</td></tr></tfoot></table>` } let logList = '<p>لا توجد عمليات مسجلة.</p>'; if(operationLog.length > 0){ logList = `<ul style="list-style:none;padding-right:0;margin-top:10px;font-size:.85em">${[...operationLog].reverse().map(log => `<li style="border-bottom:1px dotted #ccc;margin-bottom:5px;padding-bottom:5px"><strong style="color:#333;">${log.type}:</strong> ${log.details}<br><small style="color:#555">${formatDateTime(log.timestamp)}</small></li>`).join('')}</ul>` } let debtorsTable = '<p>لا توجد ديون مستحقة.</p>'; if(debtors.length > 0){ const groupedDebtsForPrint = debtors.reduce((acc, debt) => { const name = debt.name; if (!acc[name]) acc[name] = { total: 0, items: [] }; const amount = Number(debt.amount) || 0; if(amount > 0.001){ acc[name].total += amount; acc[name].items.push({ reason: debt.reason || '-', amount: amount }); } return acc; }, {}); const sortedDebtorNames = Object.keys(groupedDebtsForPrint).filter(name => groupedDebtsForPrint[name].total > 0.001).sort((a, b) => a.localeCompare(b, 'ar')); if(sortedDebtorNames.length > 0) { debtorsTable = `<table border="1" style="width:100%;border-collapse:collapse;margin-top:10px;font-size:.9em"><thead><tr style="background-color:#f2f2f2"><th style="padding:5px">اسم المدين</th><th style="padding:5px">السبب</th><th style="padding:5px">المبلغ المستحق</th></tr></thead><tbody>`; sortedDebtorNames.forEach(name => { const data = groupedDebtsForPrint[name]; debtorsTable += `<tr style="background-color:#f9f9f9;"><td style="padding:5px; font-weight:bold;" colspan="2">${name} (الإجمالي)</td><td style="padding:5px; font-weight:bold;text-align:center;">${formatCurrency(data.total)}</td></tr>`; data.items.sort((a,b) => a.reason.localeCompare(b.reason, 'ar')).forEach(item => { debtorsTable += `<tr><td style="padding:5px; padding-right: 15px;"></td><td style="padding:5px;">${item.reason}</td><td style="padding:5px;text-align:center;">${formatCurrency(item.amount)}</td></tr>`; }); }); debtorsTable += `</tbody><tfoot><tr style="background-color:#f2f2f2;font-weight:bold;"><td colspan="2" style="padding:5px;text-align:left;">إجمالي الديون (لك):</td><td style="padding:5px;text-align:center;">${formatCurrency(totalDebtsValue)}</td></tr></tfoot></table>`; } } let liabilitiesTable = '<p>لا توجد التزامات مستحقة.</p>'; const validLiabilities = liabilities.filter(l => (Number(l.amount) || 0) > 0.001); if(validLiabilities.length > 0){ liabilitiesTable = `<table border="1" style="width:100%;border-collapse:collapse;margin-top:10px;font-size:.9em"><thead><tr style="background-color:#f2f2f2"><th style="padding:5px">اسم الدائن</th><th style="padding:5px">المبلغ المستحق</th></tr></thead><tbody>${[...validLiabilities].sort((a, b) => a.name.localeCompare(b.name, 'ar')).map(l => `<tr><td style="padding:5px">${l.name}</td><td style="padding:5px;text-align:center;">${formatCurrency(l.amount)}</td></tr>`).join('')}</tbody><tfoot><tr style="background-color:#f2f2f2;font-weight:bold;"><td style="padding:5px;text-align:left;">إجمالي الالتزامات (عليك):</td><td style="padding:5px;text-align:center;">${formatCurrency(totalLiabilitiesValue)}</td></tr></tfoot></table>` } let suppliersTable = '<p>لا يوجد موردين مسجلين.</p>'; if(suppliers.length > 0){ suppliersTable = `<table border="1" style="width:100%;border-collapse:collapse;margin-top:10px;font-size:.9em"><thead><tr style="background-color:#f2f2f2"><th style="padding:5px">اسم المورد</th><th style="padding:5px">الاتصال</th><th style="padding:5px">العنوان</th></tr></thead><tbody>${[...suppliers].sort((a, b) => a.name.localeCompare(b.name, 'ar')).map(s => `<tr><td style="padding:5px">${s.name}</td><td style="padding:5px">${s.contact || '-'}</td><td style="padding:5px">${s.address || '-'}</td></tr>`).join('')}</tbody></table>` } return `<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="UTF-8"><title>تقرير العمليات - ${reportDate}</title><style>body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;margin:20px; line-height: 1.4;}h1,h2{color:#333;border-bottom:1px solid #ccc;padding-bottom:5px;margin-bottom:15px}h1{text-align:center;font-size:1.4em}h2{font-size:1.1em;margin-top:25px;margin-bottom:10px;}p{margin:5px 0;}table{width:100%;border-collapse:collapse;margin-top:10px;font-size:.9em}th,td{border:1px solid #ddd;padding:6px;text-align:right; vertical-align:top;}th{background-color:#f2f2f2;font-weight:bold;}.summary p{font-size:1em;margin:5px 0; padding-right: 10px;}.print-info{text-align:center;font-size:.8em;color:#666;margin-bottom:20px}ul{list-style:none; padding-right:0;} tfoot td {font-weight:bold;} @media print { body { -webkit-print-color-adjust: exact; print-color-adjust: exact; } h2 { page-break-before: auto; page-break-after: avoid; } table { page-break-inside: auto; } tr { page-break-inside: avoid; page-break-after: auto; } thead { display: table-header-group; } tfoot { display: table-footer-group; } } </style></head><body><h1>تقرير العمليات</h1><p class="print-info">تاريخ بيانات التقرير: ${reportDate}<br>تاريخ ووقت الطباعة: ${printDateTime}</p><div class="summary"><h2>الملخص المالي</h2><p><strong>السيولة المتاحة:</strong> ${formatCurrency(liquidity)}</p><p><strong>إجمالي قيمة المخزون:</strong> ${formatCurrency(totalInventoryValue)}</p><p><strong>قيمة البضاعة المؤقتة:</strong> ${formatCurrency(goodsOnConsignmentValue)}</p><p><strong>إجمالي الديون المستحقة للشركة:</strong> ${formatCurrency(totalDebtsValue)}</p><p><strong>إجمالي الالتزامات المستحقة على الشركة:</strong> ${formatCurrency(totalLiabilitiesValue)}</p><p><strong>إجمالي المصروفات المسجلة:</strong> ${formatCurrency(expenses)}</p><p><strong>إجمالي الربح المحقق:</strong> ${formatCurrency(totalProfit)}</p><p><strong>رأس المال الحالي:</strong> ${formatCurrency(totalCapital)}</p></div><h2>تفاصيل الالتزامات المستحقة على الشركة</h2>${liabilitiesTable}<h2>تفاصيل الديون المستحقة للشركة</h2>${debtorsTable}<h2>تفاصيل المخزون</h2>${productsTable}<h2>تفاصيل الموردين</h2>${suppliersTable}<h2>سجل العمليات</h2>${logList}</body></html>` }
        // =======================================================
// START: Monthly Liabilities Functions
// =======================================================

function updateMonthlyLiabilitiesDisplay() {
    if (!monthlyLiabilitiesList) return;
    monthlyLiabilitiesList.innerHTML = ''; // Clear list

    if (monthlyLiabilities.length === 0) {
        monthlyLiabilitiesList.innerHTML = '<li class="text-center text-gray-500">لا توجد التزامات شهرية مسجلة.</li>';
        return;
    }

    const sortedLiabilities = [...monthlyLiabilities].sort((a, b) => a.name.localeCompare(b.name, 'ar'));

    sortedLiabilities.forEach(liability => {
        const li = document.createElement('li');
        li.className = 'flex justify-between items-center p-2 bg-gray-50 rounded-md border';
        li.innerHTML = `
            <div>
                <span class="font-semibold text-gray-800">${liability.name}</span>
                <span class="text-red-600 font-mono ml-4">${formatCurrency(liability.amount)}</span>
            </div>
            <div class="actions">
                <button data-id="${liability.id}" class="edit-monthly-liability-btn text-xs bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-semibold py-1 px-2 rounded">تعديل</button>
                <button data-id="${liability.id}" class="delete-monthly-liability-btn text-xs bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-2 rounded mr-1">حذف</button>
            </div>
        `;
        monthlyLiabilitiesList.appendChild(li);
    });
}

function resetMonthlyLiabilityForm() {
    editingMonthlyLiabilityId = null;
    if (monthlyLiabilityNameInput) monthlyLiabilityNameInput.value = '';
    if (monthlyLiabilityAmountInput) monthlyLiabilityAmountInput.value = '';
    if (monthlyLiabilityFormTitle) monthlyLiabilityFormTitle.textContent = "إضافة التزام شهري جديد";
    if (addMonthlyLiabilityButton) addMonthlyLiabilityButton.textContent = "إضافة / تحديث";
    if (cancelEditMonthlyLiabilityButton) cancelEditMonthlyLiabilityButton.classList.add('hidden');
    if (monthlyLiabilityMessage) showMessage(monthlyLiabilityMessage, '');
}

function addOrUpdateMonthlyLiability() {
    const name = monthlyLiabilityNameInput.value.trim();
    const amount = parseInputNumber(monthlyLiabilityAmountInput);

    if (!name || isNaN(amount) || amount <= 0) {
        showMessage(monthlyLiabilityMessage, "يرجى إدخال اسم ومبلغ صحيح (> 0).", true);
        return;
    }

    if (editingMonthlyLiabilityId) {
        // Update existing
        const liability = monthlyLiabilities.find(l => l.id === editingMonthlyLiabilityId);
        if (liability) {
            liability.name = name;
            liability.amount = amount;
            logOperation("تعديل التزام شهري", `تم تعديل الالتزام الشهري "${name}" إلى مبلغ ${formatCurrency(amount)}.`);
            showMessage(monthlyLiabilityMessage, "تم تحديث الالتزام الشهري بنجاح.");
        }
        resetMonthlyLiabilityForm();
    } else {
        // Add new
        if (monthlyLiabilities.some(l => l.name.toLowerCase() === name.toLowerCase())) {
             showMessage(monthlyLiabilityMessage, `الالتزام الشهري بالاسم "${name}" موجود بالفعل.`, true);
             return;
        }
        const newLiability = { id: generateId('m-liab'), name, amount };
        monthlyLiabilities.push(newLiability);
        logOperation("إضافة التزام شهري", `تمت إضافة التزام شهري جديد: "${name}" بقيمة ${formatCurrency(amount)}.`);
        showMessage(monthlyLiabilityMessage, "تمت إضافة الالتزام الشهري بنجاح.");
        resetMonthlyLiabilityForm(); // Reset form after adding
    }
    updateUI();
}

function processMonthlyLiabilities() {
    console.log("Checking for monthly liabilities processing...");
    const today = new Date();
    const currentMonthStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`; // YYYY-MM
    const lastProcessedMonth = fetchData(lsLastProcessedMonthKey, null);

    if (currentMonthStr === lastProcessedMonth) {
        console.log("Monthly liabilities for", currentMonthStr, "have already been processed.");
        return; // Already processed this month
    }

    if (monthlyLiabilities.length === 0) {
        console.log("No monthly liabilities defined. Skipping.");
        saveData(lsLastProcessedMonthKey, currentMonthStr);
        return;
    }

    console.log(`Processing monthly liabilities for new month: ${currentMonthStr}`);
    let totalAdded = 0;
    let addedItemsLog = [];

    monthlyLiabilities.forEach(mLiability => {
        const liabilityName = `التزام شهري: ${mLiability.name}`;
        const newLiability = {
            id: generateId('liab'),
            name: liabilityName,
            amount: mLiability.amount
        };
        liabilities.push(newLiability);
        totalAdded += mLiability.amount;
        addedItemsLog.push(`"${mLiability.name}" بقيمة ${formatCurrency(mLiability.amount)}`);
    });

    logOperation("معالجة التزامات شهرية", `تمت إضافة التزامات شهر ${currentMonthStr} تلقائياً: ${addedItemsLog.join(', ')}.`);
    saveData(lsLastProcessedMonthKey, currentMonthStr); // Mark this month as processed
    
    showGlobalMessage(`تمت إضافة الالتزامات الشهرية (بمجموع ${formatCurrency(totalAdded)}) تلقائياً لهذا الشهر.`, false, true);
}

// =======================================================
// END: Monthly Liabilities Functions
// =======================================================

        // --- إعادة تعيين النماذج ---
        function resetProductForm() {
             editingProductName = null;
             if(productNameInput) productNameInput.value = "";
             if(productQuantityInput) productQuantityInput.value = "0";
             if(productCostPriceInput) productCostPriceInput.value = "0";
             if(productSupplierSelect) productSupplierSelect.value = "";
             if(productDeductLiquidityCheckbox) productDeductLiquidityCheckbox.checked = false; // Reset checkbox
             if(serialNumberEntryContainer) serialNumberEntryContainer.classList.add('hidden'); // Hide serial field
             if(productSerialNumbersTextarea) productSerialNumbersTextarea.value = ''; // Clear serial field
             if(serialImportMessage) showMessage(serialImportMessage, ''); // Clear serial import message
             if(addProductButton) {
                 addProductButton.textContent = "إضافة/تحديث البضاعة";
                 addProductButton.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                 addProductButton.classList.add('bg-green-500', 'hover:bg-green-600');
             }
             if(productFormTitle) productFormTitle.textContent = "إضافة / تحديث بضاعة";
             if(cancelEditProductButton) cancelEditProductButton.classList.add('hidden');
             if(productMessage) { showMessage(productMessage,""); productMessage.classList.remove('visible','error','success','info');}
         }

        // --- <<< دالة جديدة لتعديل السيولة اليدوي >>> ---
        function adjustLiquidityManually() {
            if (!adjustLiquidityAmountInput || !adjustLiquidityReasonInput || !adjustLiquidityMessage) return;

            const newAmountRaw = adjustLiquidityAmountInput.value;
            const reason = adjustLiquidityReasonInput.value.trim();

            // استخدام parseFloat بدلاً من parseInputNumber للسماح بأي صيغة رقمية صحيحة
            const newAmount = parseFloat(convertNumerals(newAmountRaw));

            if (isNaN(newAmount)) {
                showMessage(adjustLiquidityMessage, "يرجى إدخال مبلغ الرصيد الجديد بشكل صحيح.", true);
                return;
            }
            if (!reason) {
                 showMessage(adjustLiquidityMessage, "يرجى إدخال سبب التعديل.", true);
                 return;
            }

            const oldLiquidity = liquidity;
            const adjustment = newAmount - oldLiquidity;

            if (confirm(`هل أنت متأكد من تعديل رصيد السيولة من ${formatCurrency(oldLiquidity)} إلى ${formatCurrency(newAmount)}؟\nالسبب: ${reason}`)) {
                liquidity = newAmount; // تحديث الرصيد مباشرة

                // تسجيل العملية في السجل العام
                logOperation("تعديل سيولة يدوي", `تم تعديل الرصيد إلى ${formatCurrency(newAmount)}. السبب: ${reason}. (التغيير: ${formatCurrency(adjustment)})`);

                // تسجيل العملية في سجل السيولة
                const liqLogEntry = {
                    id: `liq-adj-${Date.now()}`,
                    timestamp: new Date().toISOString(),
                    type: "adjust", // نوع خاص للتعديل
                    amount: adjustment, // قيمة التغيير (موجبة أو سالبة)
                    description: `تعديل يدوي - ${reason}`,
                    currentBalance: liquidity // الرصيد الجديد بعد التعديل
                };
                liquidityLog.push(liqLogEntry);

                updateUI(); // تحديث الواجهة لعكس التغيير

                showMessage(adjustLiquidityMessage, `تم تعديل رصيد السيولة بنجاح إلى ${formatCurrency(newAmount)}.`, false);
                adjustLiquidityAmountInput.value = ''; // مسح الحقول
                adjustLiquidityReasonInput.value = '';
            } else {
                 showMessage(adjustLiquidityMessage, "تم إلغاء عملية التعديل.", false, true);
            }
        }


        // --- Invoice Modal Logic ---
        // ستبدأ في الجزء التالي (8)

        // *** JavaScript - (Corresponding to original Part 6) Ends Here ***
        // *** نهاية الجزء السابع ***
// (استكمالاً للجزء السابع)

            // --- Invoice Modal Logic ---
            function inv_openModal() {
                console.log("inv_openModal called");
                if (!isInvoiceFromPending) {
                    pendingSaleOriginData = null;
                }
                if (inv_modal) {
                    inv_modal.style.display = 'block';
                    if(inv_invoiceForm) inv_invoiceForm.reset();
                    if(inv_invoiceItemsBody) inv_invoiceItemsBody.innerHTML = '';
                    // Reset phone numbers to just one entry
                    if(inv_phoneNumbersContainer) {
                        inv_phoneNumbersContainer.innerHTML = `<div class="form-row inv-phone-entry">
                                                                <div class="form-group">
                                                                    <label for="inv_phone1">رقم هاتف 1:</label>
                                                                    <input type="tel" id="inv_phone1" name="phone[]" placeholder="رقم الهاتف">
                                                                </div>
                                                                </div>`;
                    }
                    inv_phoneCounter = 1;
                    if(inv_validationErrorDiv) { inv_validationErrorDiv.textContent = ''; inv_validationErrorDiv.classList.remove('visible','error'); }
                    if(inv_itemAddErrorDiv) { inv_itemAddErrorDiv.textContent = ''; inv_itemAddErrorDiv.classList.remove('visible','error'); }
                    if(inv_serialSelectContainer) inv_serialSelectContainer.classList.add('hidden'); // Hide serial select initially
                    if(inv_serialSearchInput) inv_serialSearchInput.value = ''; // Clear serial search input
                    const existingNote = inv_invoiceItemsBody?.parentNode.querySelector('p.invoice-origin-note');
                    if(existingNote) existingNote.remove(); // Remove previous origin notes
                    inv_updateDeductibleCostsCheckboxes();
                    inv_calculateTotals();
                } else {
                    console.error("Modal element not found");
                }
            }

            function inv_closeModal() {
                 if (inv_modal) {
                     inv_modal.style.display = 'none';
                     isInvoiceFromPending = false; // Reset flag when closing manually
                     pendingSaleOriginData = null; // Clear origin data
                     // **** إرجاع حالة السيريالات المحجوزة مؤقتاً في الفاتورة إلى متوفر ****
                     serialNumbersLog.forEach(log => {
                         if (log.status === 'in_invoice_temp') {
                             log.status = 'in_stock';
                             console.log(`Serial ${log.serial} status reverted to 'in_stock' on modal close.`);
                         }
                     });
                 }
             }

            // **** دالة جديدة لملء قائمة السيريالات المتاحة مع فلترة ****
            function populateAvailableSerials(productName, selectElement, searchTerm = '') {
                if (!selectElement) return;
                const currentSelectedValue = selectElement.value; // Keep track of current selection if any
                selectElement.innerHTML = ''; // Clear previous options

                const availableSerials = serialNumbersLog.filter(log =>
                    log.productName === productName && log.status === 'in_stock'
                );

                // استبعاد السيريالات الموجودة بالفعل في الفاتورة الحالية (المحجوزة مؤقتاً)
                const serialsInCurrentInvoice = [];
                if (inv_invoiceItemsBody) {
                    inv_invoiceItemsBody.querySelectorAll('.invoice-item-row').forEach(row => {
                        if (row.dataset.itemSerial) {
                            serialsInCurrentInvoice.push(row.dataset.itemSerial);
                        }
                    });
                }

                // فلترة إضافية بناءً على مصطلح البحث
                const filteredSerials = availableSerials
                    .filter(log => !serialsInCurrentInvoice.includes(log.serial))
                    .filter(log => log.serial.toLowerCase().includes(searchTerm.toLowerCase())); // Filter by search term

                if (filteredSerials.length > 0) {
                     selectElement.innerHTML = '<option value="">-- اختر الرقم التسلسلي --</option>'; // Add default option back
                    filteredSerials.forEach(log => {
                        const option = document.createElement('option');
                        option.value = log.serial;
                        option.textContent = log.serial;
                         if (log.serial === currentSelectedValue) { // Re-select if it still matches filter
                             option.selected = true;
                         }
                        selectElement.appendChild(option);
                    });
                     // Ensure the previously selected value is still set if it exists after filtering
                     if (filteredSerials.some(log => log.serial === currentSelectedValue)) {
                         selectElement.value = currentSelectedValue;
                     } else {
                         selectElement.value = ""; // Reset if previous selection is filtered out
                     }
                    return true; // Indicate that serials are available
                } else {
                     selectElement.innerHTML = `<option value="">-- لا توجد سيريالات مطابقة${searchTerm ? ' للبحث' : ''} --</option>`;
                     return false; // Indicate no serials available or matching search
                }
            }


            // **** تعديل دالة إضافة بند للفاتورة ****
            function inv_addInvoiceItem() {
    if (!inv_itemNameInput || !inv_itemQtyInput || !inv_itemPriceInput || !inv_itemAddErrorDiv || !inv_invoiceItemsBody || !inv_serialSelectContainer || !inv_itemSerialSelect) return;

    const name = inv_itemNameInput.value.trim();
    const qty = parseInt(inv_itemQtyInput.value);
    const price = parseInputNumber(inv_itemPriceInput);
    const selectedSerial = inv_itemSerialSelect.value; 

    showMessage(inv_itemAddErrorDiv, "", false); 

    if (!name || isNaN(qty) || qty <= 0 || isNaN(price) || price < 0) {
        showMessage(inv_itemAddErrorDiv, 'يرجى إدخال اسم البند وكمية (>0) وسعر (>=0) صحيحين.', true);
        return;
    }

    const productData = products.find(p => p.name.toLowerCase() === name.toLowerCase());
    const availableQty = productData ? (Number(productData.quantity) || 0) : Infinity; 
    const currentCostPrice = productData ? (Number(productData.costPrice) || 0) : 0; 

    // منطق إظهار قائمة السيريالات (يبقى كما هو)
    const productHasSerialsRegistered = serialNumbersLog.some(log => log.productName === name);
    if (productData && qty === 1 && productHasSerialsRegistered) {
        populateAvailableSerials(name, inv_itemSerialSelect, inv_serialSearchInput.value);
        inv_serialSelectContainer.classList.remove('hidden');
    } else {
        inv_serialSelectContainer.classList.add('hidden');
    }

    // === بداية التعديل: تم حذف شرط التحقق الإجباري من هنا ===
    // لا يوجد الآن شرط يجبرك على اختيار السيريال
    // === نهاية التعديل ===

    let alreadyAddedQty = 0;
    inv_invoiceItemsBody.querySelectorAll('.invoice-item-row').forEach(row => {
        if (row.dataset.itemName.toLowerCase() === name.toLowerCase()) {
            alreadyAddedQty += parseInt(row.dataset.itemQty);
        }
    });

    if (productData && (qty + alreadyAddedQty) > availableQty) {
        showMessage(inv_itemAddErrorDiv, `الكمية الإجمالية المطلوبة (${qty + alreadyAddedQty}) لـ "${name}" غير متوفرة في المخزون (المتاح: ${availableQty}).`, true);
        inv_serialSelectContainer.classList.add('hidden');
        return;
    }

    if (selectedSerial && inv_invoiceItemsBody.querySelector(`tr[data-item-serial="${selectedSerial}"]`)) {
        showMessage(inv_itemAddErrorDiv, `الرقم التسلسلي "${selectedSerial}" تم إضافته بالفعل لهذه الفاتورة.`, true);
        return;
    }

    const subtotal = qty * price;
    const newRow = document.createElement('tr');
    newRow.classList.add('invoice-item-row');
    newRow.dataset.itemName = name;
    newRow.dataset.itemQty = qty;
    newRow.dataset.itemPrice = price.toFixed(2);
    newRow.dataset.itemSubtotal = subtotal.toFixed(2);
    newRow.dataset.itemCost = currentCostPrice.toFixed(2);

    if (selectedSerial && qty === 1) { // سيتم إضافة السيريال فقط في حالة اختياره
        newRow.dataset.itemSerial = selectedSerial;
        const serialIndex = serialNumbersLog.findIndex(log => log.serial === selectedSerial);
        if (serialIndex !== -1) {
            serialNumbersLog[serialIndex].status = 'in_invoice_temp';
            console.log(`Serial ${selectedSerial} status temporarily set to 'in_invoice_temp'.`);
        }
    }

    newRow.innerHTML = `
        <td class="item-name">
            ${name}
            ${selectedSerial && qty === 1 ? `<span class="serial-display no-print">(S/N: ${selectedSerial})</span><span class="serial-display-print">(S/N: ${selectedSerial})</span>` : ''}
        </td>
        <td class="item-qty">${qty}</td>
        <td class="item-price">${formatCurrency(price)}</td>
        <td class="item-subtotal">${formatCurrency(subtotal)}</td>
        <td class="no-print"><button type="button" class="remove-item-btn" title="حذف البند">×</button></td>
    `;
    inv_invoiceItemsBody.appendChild(newRow);

    // مسح الحقول للإدخال التالي
    inv_itemNameInput.value = '';
    inv_itemQtyInput.value = '1';
    inv_itemPriceInput.value = '0';
    inv_serialSelectContainer.classList.add('hidden');
    inv_itemSerialSelect.value = '';
    inv_serialSearchInput.value = '';
    inv_itemNameInput.focus();
    inv_calculateTotals();
    inv_updateDeductibleCostsCheckboxes();
}

            function inv_validateForm() {
                 if(!inv_validationErrorDiv) return true; // Skip validation if element DNE
                 showMessage(inv_validationErrorDiv, "", false); // Clear previous error
                 let isValid = true;
                 let errors = [];

                 if (!inv_customerNameInput || inv_customerNameInput.value.trim() === '') {
                     isValid = false;
                     errors.push('اسم العميل مطلوب.');
                     if(inv_customerNameInput) inv_customerNameInput.style.borderColor = 'red';
                 } else {
                     if(inv_customerNameInput) inv_customerNameInput.style.borderColor = '';
                 }

                 if (!inv_invoiceItemsBody || inv_invoiceItemsBody.querySelectorAll('.invoice-item-row').length === 0) {
                     isValid = false;
                     errors.push('يجب إضافة بند واحد على الأقل للفاتورة.');
                 }

                 // Validate deductible items stock just before saving
                 const deductibleCheckboxes = inv_deductibleCostsContainer ? inv_deductibleCostsContainer.querySelectorAll('input[type="checkbox"]:checked') : [];
                 let tempUnavailableDeducted = null;
                 deductibleCheckboxes.forEach(checkbox => {
                     if (tempUnavailableDeducted) return; // Stop checking if one error found
                     const name = checkbox.value;
                     const available = parseInt(checkbox.dataset.available) || 0;
                     const qtyToDeduct = 1; // Currently hardcoded to 1 for deducted items
                     if (available < qtyToDeduct) {
                         tempUnavailableDeducted = { name: name, required: qtyToDeduct, available: available };
                     }
                 });

                 if (tempUnavailableDeducted) {
                     isValid = false;
                     errors.push(`الكمية المطلوبة للخصم (${tempUnavailableDeducted.required}) من "${tempUnavailableDeducted.name}" غير متوفرة (${tempUnavailableDeducted.available}).`);
                 }


                 if (!isValid) {
                     showMessage(inv_validationErrorDiv, errors.join('<br>'), true);
                 }
                 return isValid;
             }

            function handleSaveInvoice() {
            saveStateToHistory();
                console.log("handleSaveInvoice called. isInvoiceFromPending:", isInvoiceFromPending);
                if (!inv_validateForm()){
                    console.log("Invoice Validation failed!");
                    return;
                }

                const customerName = inv_customerNameInput.value.trim();
                const customerAddress = inv_customerAddressInput.value.trim();
                const phones = inv_invoiceForm ? Array.from(inv_invoiceForm.querySelectorAll('input[name="phone[]"]')).map(input => input.value.trim()).filter(phone => phone) : [];
                const invoiceItems = inv_invoiceItemsBody ? Array.from(inv_invoiceItemsBody.querySelectorAll('.invoice-item-row')).map(row => ({
                    name: row.dataset.itemName,
                    quantity: parseInt(row.dataset.itemQty),
                    unitPrice: parseFloat(row.dataset.itemPrice),
                    subtotal: parseFloat(row.dataset.itemSubtotal),
                    costPrice: parseFloat(row.dataset.itemCost),
                    serial: row.dataset.itemSerial || null // **** حفظ السيريال مع البند ****
                })) : [];
                const shippingCost = parseInputNumber(inv_shippingCostInput) || 0;
                const warranty = inv_warrantyInput ? inv_warrantyInput.value.trim() : '';
                const notes = inv_notesTextarea ? inv_notesTextarea.value.trim() : '';

                const totalGoods = invoiceItems.reduce((sum, item) => sum + item.subtotal, 0);
                const grandTotal = totalGoods + shippingCost;

                // Handle deducted costs
                const deductibleCheckboxes = inv_deductibleCostsContainer ? inv_deductibleCostsContainer.querySelectorAll('input[type="checkbox"]:checked') : [];
                const deductedItemsData = [];
                let totalDeductedCost = 0;
                deductibleCheckboxes.forEach(checkbox => {
                    const name = checkbox.value;
                    const cost = parseFloat(checkbox.dataset.cost) || 0;
                    const qtyToDeduct = 1; // Assuming quantity 1 for deducted items
                    deductedItemsData.push({ name: name, quantity: qtyToDeduct, costPrice: cost });
                    totalDeductedCost += (cost * qtyToDeduct);
                });

                const costOfSoldItems = invoiceItems.reduce((sum, item) => sum + (item.costPrice * item.quantity), 0); // Use stored cost
                const finalInvoiceProfit = totalGoods - costOfSoldItems - totalDeductedCost;

                // Create map of all items to deduct from stock (invoice items + deducted items)
                let requiredQuantities = {};
                invoiceItems.forEach(item => {
                    // Only count inventory items for stock deduction
                     const product = products.find(p => p.name === item.name);
                     if(product) {
                         requiredQuantities[item.name] = (requiredQuantities[item.name] || 0) + item.quantity;
                     }
                });
                deductedItemsData.forEach(item => {
                     requiredQuantities[item.name] = (requiredQuantities[item.name] || 0) + item.quantity;
                });

                // Deduct from stock
                Object.keys(requiredQuantities).forEach(itemName => {
                     const productIndex = products.findIndex(p => p.name === itemName);
                     if (productIndex !== -1) {
                         products[productIndex].quantity -= requiredQuantities[itemName];
                     }
                });
                // Remove zero-quantity products after deduction
                products = products.filter(p => (Number(p.quantity) || 0) > 0.001);

                 // **** تحديث حالة السيريالات المباعة ****
                 invoiceItems.forEach(item => {
                     if (item.serial) { // إذا كان هناك سيريال مرتبط بهذا البند
                         const serialIndex = serialNumbersLog.findIndex(log => log.serial === item.serial);
                         if (serialIndex !== -1) {
                             serialNumbersLog[serialIndex].status = 'sold'; // تغيير الحالة إلى مباع
                             console.log(`Serial ${item.serial} status updated to 'sold'.`);
                         } else {
                             // هذا لا يجب أن يحدث إذا كان المنطق صحيحاً، لكن نضيف تحذيراً
                             console.warn(`Serial ${item.serial} selected in invoice but not found in log or was not in 'in_invoice_temp' status!`);
                         }
                     }
                 });
                 // **** نهاية تحديث حالة السيريالات ****


                // --- Generate Invoice Number ---
                const todayStr = currentLoadedDate ? currentLoadedDate.replace(/-/g, '') : getTodayDateString().replace(/-/g, '');
                let maxSeq = 0;
                salesToday.forEach(sale => {
                     if (sale.invoiceNumber && sale.invoiceNumber.startsWith(todayStr)) {
                         const seqPart = parseInt(sale.invoiceNumber.split('-')[1] || '0');
                         if (seqPart > maxSeq) maxSeq = seqPart;
                     }
                });
                const nextSeq = (maxSeq + 1).toString().padStart(3, '0');
                const generatedInvoiceNumber = `${todayStr}-${nextSeq}`;

                // --- Create Invoice Record ---
                const invoiceRecord = {
                    id: isInvoiceFromPending && pendingSaleOriginData ? pendingSaleOriginData.id.replace('pending','inv-from-pend') : `inv-${Date.now()}-${Math.random().toString(36).substring(2, 7)}`,
                    invoiceNumber: generatedInvoiceNumber, // Added invoice number
                    type: isInvoiceFromPending ? 'invoice-from-pending' : 'invoice',
                    timestamp: new Date().toISOString(),
                    customerName: customerName,
                    customerAddress: customerAddress,
                    phones: phones,
                    items: invoiceItems, // يتضمن الآن السيريال إذا تم اختياره
                    shippingCost: shippingCost,
                    totalGoodsPrice: totalGoods,
                    grandTotal: grandTotal,
                    warranty: warranty,
                    notes: notes,
                    deductedItems: deductedItemsData, // Store info about deducted items
                    totalCost: costOfSoldItems + totalDeductedCost,
                    profit: finalInvoiceProfit
                };

                // --- Handle State Updates based on Origin ---
                if (isInvoiceFromPending && pendingSaleOriginData) {
                    // Handle case: Invoice from Pending Sale Confirmation
                     console.log("Saving invoice generated from confirmed pending sale.");
                     // Sale was already logged as pending, cost deducted then.
                     // Liquidity/Profit were NOT affected by pending sale, affect them now.
                     liquidity += grandTotal;
                     totalProfit += finalInvoiceProfit;

                     const liqLogEntry = {
                         id: `liq-${Date.now()}`,
                         timestamp: new Date().toISOString(),
                         type: "add",
                         amount: grandTotal,
                         description: `فاتورة ${generatedInvoiceNumber} (مؤكدة) لـ ${customerName || 'عميل'}`,
                         currentBalance: liquidity
                     };
                     liquidityLog.push(liqLogEntry);
                     logOperation("تأكيد بيع مؤقت بفاتورة", `تأكيد فاتورة ${generatedInvoiceNumber} لـ ${customerName || '-'}. الإجمالي: ${formatCurrency(grandTotal)}. الربح النهائي: ${formatCurrency(finalInvoiceProfit)}.`);

                } else {
                     // Handle case: Brand New Invoice
                     console.log("Saving brand new invoice.");
                     // Affect liquidity and profit
                     liquidity += grandTotal;
                     totalProfit += finalInvoiceProfit;

                     let logItemsSummary = invoiceItems.map(i => `${i.quantity}x ${i.name}${i.serial ? ' (S/N: '+i.serial+')' : ''}`).join(', '); // أضف السيريال للسجل
                     let deductedItemsSummary = deductedItemsData.map(d => `${d.quantity}x ${d.name} (تكلفة مخصومة)`).join(', ');
                     let logDetails = `إنشاء فاتورة بيع ${generatedInvoiceNumber} لـ ${customerName || 'عميل غير مسمى'}. البنود: ${logItemsSummary}.`;
                     if (deductedItemsSummary) logDetails += ` تم خصم تكلفة: ${deductedItemsSummary}.`;
                     logDetails += ` الشحن: ${formatCurrency(shippingCost)}. الإجمالي: ${formatCurrency(grandTotal)}. التكلفة الكلية: ${formatCurrency(costOfSoldItems + totalDeductedCost)}. الربح: ${formatCurrency(finalInvoiceProfit)}.`;
                     logOperation("إنشاء فاتورة بيع", logDetails);

                     const liqLogEntry = {
                         id: `liq-${Date.now()}`,
                         timestamp: new Date().toISOString(),
                         type: "add",
                         amount: grandTotal,
                         description: `فاتورة بيع ${generatedInvoiceNumber} لـ ${customerName || 'عميل غير مسمى'}`,
                         currentBalance: liquidity
                     };
                     liquidityLog.push(liqLogEntry);
                }

                salesToday.push(invoiceRecord); // Add record to salesToday array

                // Reset flags and update UI
                isInvoiceFromPending = false;
                pendingSaleOriginData = null;
                updateUI();
                showGlobalMessage(`تم إنشاء وحفظ الفاتورة رقم ${generatedInvoiceNumber} لـ ${customerName || 'عميل'} بنجاح.`, false);
                inv_closeModal();
            }


            // (سيتم استكمال JavaScript في الجزء التالي 8ب)
// (استكمالاً للجزء 8أ)

            // (استكمالاً للجزء 8أ)
function printPendingSaleAsInvoice(pendingId) {
    console.log("printPendingSaleAsInvoice function started for ID:", pendingId);
    console.log("Attempting to print pending sale as invoice for ID:", pendingId);
    const saleIndex = pendingSales.findIndex(s => s.id === pendingId);
    if (saleIndex === -1) {
        console.error("Pending sale not found for printing:", pendingId);
        showGlobalMessage("خطأ: لم يتم العثور على البيع المؤقت للطباعة.", true);
        return;
    }
    const saleData = pendingSales[saleIndex];
    console.log("Found pending sale data:", saleData);

    // تهيئة بيانات مشابهة لكائن الفاتورة الذي تتوقعه دالة inv_printInvoice
    let itemsForPrint = [];
    const mainProductQty = Number(saleData.mainProduct.quantity) || 0;

    // سعر الوحدة للمنتج الرئيسي - تقدير بسيط للعرض
    let mainProductUnitPrice = 0;
    if (mainProductQty > 0) {
       mainProductUnitPrice = saleData.totalSellPrice / mainProductQty; // نفترض أن السعر موزع على المنتج الرئيسي بشكل أساسي للعرض
    }


    itemsForPrint.push({
        name: saleData.mainProduct.name,
        quantity: mainProductQty,
        unitPrice: mainProductUnitPrice,
        subtotal: mainProductUnitPrice * mainProductQty, // قد لا يكون دقيقاً إذا وجدت منتجات إضافية بسعر
        serial: null // البيع المؤقت لا يخزن سيريال محدد عادة
    });

    let totalGoodsForPrint = mainProductUnitPrice * mainProductQty;

    if (saleData.additionalItems && saleData.additionalItems.length > 0) {
        saleData.additionalItems.forEach(item => {
            itemsForPrint.push({
                name: item.name,
                quantity: Number(item.quantity) || 0,
                unitPrice: 0, // سعر المنتجات الإضافية يعتبر 0 في هذا العرض
                subtotal: 0,
                serial: null
            });
        });
         // إذا كان هناك منتجات إضافية، الإجمالي الكلي للبضاعة هو سعر البيع المؤقت
         totalGoodsForPrint = saleData.totalSellPrice;
         // يمكنك تعديل سعر المنتج الرئيسي إذا أردت (اختياري)
         if (itemsForPrint[0]) {
           // itemsForPrint[0].unitPrice = 0; // أو أي قيمة مناسبة
           // itemsForPrint[0].subtotal = 0;
         }
    }


    const invoiceDataForPrint = {
        customerName: saleData.customerName || '',
        customerAddress: '', // لا يوجد عنوان في البيع المؤقت
        phones: [], // لا توجد هواتف في البيع المؤقت
        items: itemsForPrint,
        shippingCost: 0, // لا يوجد شحن منفصل في البيع المؤقت
        grandTotal: saleData.totalSellPrice, // الإجمالي المطلوب هو سعر البيع المؤقت
        totalGoodsPrice: totalGoodsForPrint, // إجمالي البضاعة هو سعر البيع المؤقت
        warranty: '', // لا يوجد ضمان في البيع المؤقت
        notes: `*** فاتورة بيع مؤقت (للعرض فقط - لم يتم تأكيد العملية) ***\nالربح المتوقع (غير مؤكد): ${formatCurrency(saleData.potentialProfit)}`, // ملاحظة مهمة
        invoiceNumber: `مؤقت-${saleData.id.slice(-6)}`, // رقم فاتورة مؤقت
        timestamp: saleData.timestamp // استخدم وقت إنشاء البيع المؤقت
    };
    console.log("Data prepared for printing:", invoiceDataForPrint);

    // استدعاء دالة الطباعة الحالية مع البيانات المهيأة
    inv_printInvoice(invoiceDataForPrint); // مرر الكائن المنسق
}
            function inv_printInvoice(invoiceToPrint = null) { // Modified to accept an invoice object
                 let customerName, customerAddress, phones, items, shippingCost, grandTotal, warranty, notes, invoiceNumber, timestamp;
                 let totalGoodsPriceForPrint;
                 if (invoiceToPrint) { // Printing a saved/searched invoice
                      customerName = invoiceToPrint.customerName || '';
                      customerAddress = invoiceToPrint.customerAddress || '';
                      phones = invoiceToPrint.phones || [];
                      items = invoiceToPrint.items || []; // Items already include serial if saved
                      shippingCost = Number(invoiceToPrint.shippingCost) || 0;
                      grandTotal = Number(invoiceToPrint.grandTotal) || 0;
                      warranty = invoiceToPrint.warranty || '';
                      notes = invoiceToPrint.notes || '';
                      invoiceNumber = invoiceToPrint.invoiceNumber || `INV-${invoiceToPrint.id.slice(-6)}`; // Fallback ID based number
                      timestamp = invoiceToPrint.timestamp;
                       totalGoodsPriceForPrint = invoiceToPrint.totalGoodsPrice !== undefined ? Number(invoiceToPrint.totalGoodsPrice) : items.reduce((sum, i) => sum + parseFloat(i.subtotal || 0), 0);
                 } else { // Printing directly from modal before saving (or if validation fails on view)
                      if (!inv_validateForm()){ // Validate before generating preview print
                          console.log("Invoice Validation failed for printing!");
                          return;
                           totalGoodsPriceForPrint = items.reduce((sum, item) => sum + parseFloat(item.subtotal || 0), 0);
                      }
                      customerName = d('inv_customerName').value.trim();
                      customerAddress = d('inv_customerAddress').value.trim();
                      phones = inv_invoiceForm ? Array.from(inv_invoiceForm.querySelectorAll('input[name="phone[]"]')).map(input => input.value.trim()).filter(phone => phone) : [];
                      items = inv_invoiceItemsBody ? Array.from(inv_invoiceItemsBody.querySelectorAll('.invoice-item-row')).map(row => ({
                          name: row.dataset.itemName || '',
                          quantity: row.dataset.itemQty || 0,
                          unitPrice: parseFloat(row.dataset.itemPrice || 0).toFixed(2), // Use dataset, fallback might not work well
                          subtotal: parseFloat(row.dataset.itemSubtotal || 0).toFixed(2),
                          serial: row.dataset.itemSerial || null // **** احصل على السيريال للطباعة ****
                      })) : [];
                      shippingCost = inv_shippingCostInput ? (parseInputNumber(inv_shippingCostInput) || 0) : 0;
                      const totalGoods = items.reduce((sum, item) => sum + parseFloat(item.subtotal), 0);
                      grandTotal = totalGoods + shippingCost;
                      warranty = inv_warrantyInput ? inv_warrantyInput.value.trim() : '';
                      notes = inv_notesTextarea ? inv_notesTextarea.value.trim() : '';
                      timestamp = new Date().toISOString(); // Use current time for preview
                      invoiceNumber = `PREVIEW-${Date.now().toString().slice(-6)}`; // Preview number
                  }

                  const invoiceDate = new Date(timestamp);
                  const formattedDate = invoiceDate.toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' });
                  const formattedTime = invoiceDate.toLocaleTimeString('ar-EG', { hour: '2-digit', minute:'2-digit', hour12: true });

                  // Generate HTML for printing
                  let printHTML = `
                  <!DOCTYPE html>
                  <html lang="ar" dir="rtl">
                  <head>
                      <meta charset="UTF-8">
                      <title>فاتورة بيع - ${invoiceNumber}</title>
                      <style>
                          body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 15px; font-size: 10pt; line-height: 1.4; color: #333; }
                          .invoice-box { max-width: 800px; margin: auto; padding: 15px; border: 1px solid #eee; box-shadow: 0 0 8px rgba(0, 0, 0, 0.1); }
                          .invoice-header { text-align: center; margin-bottom: 20px; }
                          .invoice-header h1 { margin: 0; color: #000; font-size: 1.4em; }
                          .invoice-meta, .customer-info { margin-bottom: 15px; font-size: 9pt; }
                          .invoice-meta div, .customer-info div { margin-bottom: 4px; }
                          .invoice-meta span, .customer-info span { display: inline-block; min-width: 80px; font-weight: bold; margin-left: 5px;}
                          .customer-info { border-top: 1px solid #eee; padding-top: 10px; }
                          h3 { margin-top: 20px; margin-bottom: 8px; color:#000; border-bottom: 1px solid #eee; padding-bottom: 3px; font-size: 1.1em;}
                          table.items-table { width: 100%; line-height: inherit; text-align: right; border-collapse: collapse; margin-top: 5px; }
                          table.items-table th, table.items-table td { padding: 5px; border: 1px solid #ddd; vertical-align: top; }
                          table.items-table th { background: #f2f2f2; font-weight: bold; text-align: center; }
                          table.items-table td.num { text-align: center; font-family: monospace;}
                          table.items-table tr.total-row td { border-top: 2px solid #aaa; font-weight: bold; }
                          table.items-table tr.grand-total td { border-top: 2px solid #333; font-weight: bold; font-size: 1.1em; }
                          .text-left { text-align: left; }
                          .notes-section { margin-top: 20px; padding-top: 10px; border-top: 1px dashed #ccc; font-size: 9pt; }
                          .notes-section h4 { margin-top: 0; margin-bottom: 5px; font-size: 1em; }
                          .notes-section p { white-space: pre-wrap; margin: 0; }
                          .serial-display-print { font-size: 0.8em; color: #555; display: block; margin-top: 2px; } /* Style for printed serial */
                          @media print {
                              body { margin: 0; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                              .invoice-box { border: none; box-shadow: none; margin: 0; max-width: 100%; padding: 0; }
                              .serial-display-print { display: block !important; } /* Ensure serial shows in print */
                          }
                      </style>
                  </head>
                  <body>
                      <div class="invoice-box">
                          <div class="invoice-header">
                              <h1>فاتورة بيع</h1>
                          </div>
                          <div class="invoice-meta">
                              <div><span>رقم الفاتورة:</span> ${invoiceNumber}</div>
                              <div><span>تاريخ الفاتورة:</span> ${formattedDate} ${formattedTime}</div>
                              ${warranty ? `<div><span>مدة الضمان:</span> ${warranty}</div>` : ''}
                          </div>
                          <div class="customer-info">
                              <h3 style="margin-top:0;">بيانات العميل:</h3>
                              <div><span>الاسم:</span> ${customerName || 'غير محدد'}</div>
                              ${customerAddress ? `<div><span>العنوان:</span> ${customerAddress}</div>` : ''}
                              ${phones.length > 0 ? `<div><span>الهواتف:</span> ${phones.join(' / ')}</div>` : ''}
                          </div>
                          <h3>تفاصيل البنود:</h3>
                          <table class="items-table">
                              <thead>
                                  <tr>
                                      <th>البند</th>
                                      <th>الكمية</th>
                                      <th>سعر الوحدة</th>
                                      <th>الإجمالي الفرعي</th>
                                  </tr>
                              </thead>
                              <tbody>
                                  ${items.map(item => `<tr>
                                      <td>
                                          ${item.name}
                                          ${item.serial ? `<span class="serial-display-print">(S/N: ${item.serial})</span>` : ''}
                                      </td>
                                      <td class="num">${item.quantity}</td>
                                      <td class="num">${formatCurrency(item.unitPrice)}</td>
                                      <td class="num">${formatCurrency(item.subtotal)}</td>
                                      </tr>`).join('')}
                                  <tr class="total-row">
                                      <td colspan="3" class="text-left">إجمالي البضاعة</td>
                                      <td class="num">${formatCurrency(totalGoodsPriceForPrint)}</td>
                                  </tr>
                                  ${shippingCost > 0 ? `<tr class="total-row">
                                      <td colspan="3" class="text-left">قيمة الشحن</td>
                                      <td class="num">${formatCurrency(shippingCost)}</td>
                                      </tr>` : ''}
                                  <tr class="grand-total">
                                      <td colspan="3" class="text-left">الإجمالي الكلي المطلوب</td>
                                      <td class="num">${formatCurrency(grandTotal)}</td>
                                  </tr>
                              </tbody>
                          </table>
                          ${notes ? `<div class="notes-section"><h4>ملاحظات:</h4><p>${notes.replace(/\n/g, '<br>')}</p></div>` : ''}
                          <div style="margin-top: 30px; text-align: center; font-size: 9pt; color: #666;">
                              --- شكراً لتعاملكم معنا ---
                          </div>
                      </div>
                  </body>
                  </html>
                  `;

                  // Trigger print
                  document.body.classList.add('print-invoice'); // Add class for print styling
                  const printWindow = window.open('', '_blank');
                  if (printWindow) {
                      printWindow.document.open();
                      printWindow.document.write(printHTML);
                      printWindow.document.close();
                      setTimeout(() => { // Timeout allows content to render before print dialog
                          try {
                              printWindow.focus();
                              printWindow.print();
                              // printWindow.close(); // Optional: Close after printing attempt
                          } catch (e) {
                              console.error("Print error:", e);
                              alert("حدث خطأ أثناء محاولة الطباعة.");
                          } finally {
                              document.body.classList.remove('print-invoice'); // Remove class after printing attempt
                          }
                      }, 500);
                  } else {
                      alert('فشل فتح نافذة الطباعة. يرجى السماح بالنوافذ المنبثقة.');
                      document.body.classList.remove('print-invoice');
                  }
             }

            function inv_calculateTotals() {
                let goodsTotal = 0;
                if(inv_invoiceItemsBody) {
                    inv_invoiceItemsBody.querySelectorAll('.invoice-item-row').forEach(row => {
                        goodsTotal += parseFloat(row.dataset.itemSubtotal || 0);
                    });
                }
                const shippingCost = inv_shippingCostInput ? (parseInputNumber(inv_shippingCostInput) || 0) : 0;
                const grandTotal = goodsTotal + shippingCost;

                if(inv_totalGoodsPriceSpan) inv_totalGoodsPriceSpan.textContent = formatCurrency(goodsTotal);
                if(inv_totalShippingCostSpan) inv_totalShippingCostSpan.textContent = formatCurrency(shippingCost);
                if(inv_grandTotalPriceSpan) inv_grandTotalPriceSpan.textContent = formatCurrency(grandTotal);
            }

            function inv_updateDeductibleCostsCheckboxes() {
                if (!inv_deductibleCostsContainer) return;
                inv_deductibleCostsContainer.innerHTML = '';
                const itemsInInvoice = inv_invoiceItemsBody ? Array.from(inv_invoiceItemsBody.querySelectorAll('.invoice-item-row')).map(row => row.dataset.itemName.toLowerCase()) : [];
                const availableForDeduction = products.filter(p =>
                    !itemsInInvoice.includes(p.name.toLowerCase()) && (Number(p.quantity) || 0) > 0
                );

                if (availableForDeduction.length === 0) {
                    inv_deductibleCostsContainer.innerHTML = '<p class="text-center text-sm" style="color:grey;">لا توجد منتجات أخرى متاحة لخصم تكلفتها.</p>';
                    return;
                }

                availableForDeduction.sort((a, b) => a.name.localeCompare(b.name, 'ar')).forEach(product => {
                     const qtyAvailable = Number(product.quantity) || 0;
                     const cost = Number(product.costPrice) || 0;
                     const label = document.createElement('label');
                     const checkbox = document.createElement('input');
                     checkbox.type = 'checkbox';
                     checkbox.value = product.name;
                     checkbox.dataset.cost = cost;
                     checkbox.dataset.available = qtyAvailable; // Store available qty
                     checkbox.id = `inv_deductcost_${generateId(product.name)}`;
                     label.htmlFor = checkbox.id;
                     label.appendChild(checkbox);
                     label.appendChild(document.createTextNode(` ${product.name} (تكلفة: ${formatCurrency(cost)}, متاح: ${qtyAvailable})`));
                     inv_deductibleCostsContainer.appendChild(label);
                 });
             }

            // --- Manage Serials Modal Logic ---
            function openManageSerialsModal(productName) {
                currentManagingSerialsProduct = productName; // Store the product name being managed
                const product = products.find(p => p.name === productName);
                if (!product || !manageSerialsModal) {
                    showGlobalMessage(`خطأ: لم يتم العثور على المنتج "${productName}" لإدارة سيريالاته.`, true);
                    return;
                }

                // تحديث معلومات النافذة
                if (modal_productNameDisplay) modal_productNameDisplay.textContent = productName;
                const totalQty = Number(product.quantity) || 0;
                const registeredSerials = serialNumbersLog.filter(log => log.productName === productName);
                const registeredCount = registeredSerials.length;
                const unregisteredCount = totalQty - registeredCount;

                if (modal_totalQuantity) modal_totalQuantity.textContent = totalQty;
                if (modal_registeredCount) modal_registeredCount.textContent = registeredCount;
                if (modal_unregisteredCount) modal_unregisteredCount.textContent = unregisteredCount;
                if (modal_maxSerialsToAdd) modal_maxSerialsToAdd.textContent = unregisteredCount;

                // مسح حقل الإضافة ورسالة الاستيراد
                if (modal_productSerialNumbers) modal_productSerialNumbers.value = '';
                if (modal_serialImportMessage) showMessage(modal_serialImportMessage, '');

                // عرض السيريالات المسجلة حالياً
                if (modal_registeredSerialsList) {
                    if (registeredCount === 0) {
                        modal_registeredSerialsList.innerHTML = '<p class="text-center text-gray-500">لا توجد سيريالات مسجلة حالياً.</p>';
                    } else {
                        let listHtml = '<ul class="space-y-1">';
                        registeredSerials.sort((a,b) => a.serial.localeCompare(b.serial)).forEach(log => {
                             let statusColor = log.status === 'in_stock' ? 'text-green-600' : (log.status === 'sold' ? 'text-red-500' : 'text-gray-500');
                             let statusText = log.status === 'in_stock' ? 'متوفر' : (log.status === 'sold' ? 'مباع' : (log.status === 'in_invoice_temp' ? 'في فاتورة' : log.status));
                             listHtml += `<li class="text-sm flex justify-between items-center">
                                              <span class="font-mono"><strong>${log.serial}</strong></span>
                                              <span class="text-xs <span class="math-inline">\{statusColor\}"\>\[</span>{statusText}]</span>
                                           </li>`;
                        });
                        listHtml += '</ul>';
                        modal_registeredSerialsList.innerHTML = listHtml;
                    }
                }

                // إظهار النافذة
                manageSerialsModal.style.display = 'block';
            }

            function closeManageSerialsModal() {
                if (manageSerialsModal) {
                    manageSerialsModal.style.display = 'none';
                }
                currentManagingSerialsProduct = null; // Reset managed product name
            }

            function saveAddedSerialsFromModal() {
            saveStateToHistory();
                if (!currentManagingSerialsProduct || !modal_productSerialNumbers) return;

                const product = products.find(p => p.name === currentManagingSerialsProduct);
                if (!product) {
                    showMessage(d('modal-serial-import-message'), 'خطأ: المنتج لم يعد موجوداً.', true);
                    return;
                }

                const newSerialsInput = modal_productSerialNumbers.value.trim();
                if (!newSerialsInput) {
                    showMessage(d('modal-serial-import-message'), 'لم يتم إدخال أرقام تسلسلية جديدة.', false, true);
                    return; // لا يوجد شيء للحفظ
                }

                const totalQty = Number(product.quantity) || 0;
                const registeredCount = serialNumbersLog.filter(log => log.productName === currentManagingSerialsProduct).length;
                const unregisteredCount = totalQty - registeredCount;

                // فصل السيريالات المدخلة
                const cleanedInput = newSerialsInput.replace(/[,;\s\t]+/g, '\n');
                const newSerials = cleanedInput.split('\n').map(s => s.trim()).filter(s => s !== '');

                if (newSerials.length === 0) {
                     showMessage(d('modal-serial-import-message'), 'لم يتم إدخال أرقام تسلسلية صالحة.', true);
                     return;
                }

                if (newSerials.length > unregisteredCount) {
                     showMessage(d('modal-serial-import-message'), `لا يمكن إضافة ${newSerials.length} سيريال، العدد المتبقي غير المسجل هو ${unregisteredCount} فقط.`, true);
                     return;
                }

                // التحقق من التكرار
                const duplicateCheck = new Set();
                let error = false;
                for (const serial of newSerials) {
                     if (duplicateCheck.has(serial)) {
                         showMessage(d('modal-serial-import-message'), `الرقم التسلسلي "${serial}" مكرر في المدخلات.`, true);
                         error = true; break;
                     }
                     if (serialNumbersLog.some(log => log.serial === serial)) {
                         showMessage(d('modal-serial-import-message'), `الرقم التسلسلي "${serial}" مسجل بالفعل في النظام لمنتج آخر أو لهذا المنتج.`, true);
                         error = true; break;
                     }
                     duplicateCheck.add(serial);
                }
                if (error) return;

                // إضافة السيريالات الجديدة
                const timestamp = new Date().toISOString();
                const supplierId = product.supplierId || ""; // استخدم المورد المرتبط بالمنتج إن وجد
                newSerials.forEach(serial => {
                    serialNumbersLog.push({
                        serial: serial,
                        productName: currentManagingSerialsProduct,
                        supplierId: supplierId,
                        addedTimestamp: timestamp,
                        status: "in_stock"
                    });
                });

                logOperation("إدارة سيريالات", `تمت إضافة <span class="math-inline">\{newSerials\.length\} رقم تسلسلي للمنتج "</span>{currentManagingSerialsProduct}".`);
                showMessage(d('modal-serial-import-message'), `تم حفظ ${newSerials.length} رقم تسلسلي بنجاح.`, false);
                modal_productSerialNumbers.value = ''; // أفرغ الحقل بعد الحفظ
                // أعد تحديث قائمة السيريالات المسجلة داخل الـ modal وأرقام العد
                const updatedRegisteredSerials = serialNumbersLog.filter(log => log.productName === currentManagingSerialsProduct);
                const updatedRegisteredCount = updatedRegisteredSerials.length;
                const updatedUnregisteredCount = totalQty - updatedRegisteredCount;

                if (modal_registeredCount) modal_registeredCount.textContent = updatedRegisteredCount;
                if (modal_unregisteredCount) modal_unregisteredCount.textContent = updatedUnregisteredCount;
                if (modal_maxSerialsToAdd) modal_maxSerialsToAdd.textContent = updatedUnregisteredCount;

                 if (modal_registeredSerialsList) {
                     if (updatedRegisteredCount === 0) {
                          modal_registeredSerialsList.innerHTML = '<p class="text-center text-gray-500">لا توجد سيريالات مسجلة حالياً.</p>';
                     } else {
                          let listHtml = '<ul class="space-y-1">';
                          updatedRegisteredSerials.sort((a,b) => a.serial.localeCompare(b.serial)).forEach(log => {
                              let statusColor = log.status === 'in_stock' ? 'text-green-600' : (log.status === 'sold' ? 'text-red-500' : 'text-gray-500');
                              let statusText = log.status === 'in_stock' ? 'متوفر' : (log.status === 'sold' ? 'مباع' : (log.status === 'in_invoice_temp' ? 'في فاتورة' : log.status));
                              listHtml += `<li class="text-sm flex justify-between items-center">
                                               <span class="font-mono"><strong>${log.serial}</strong></span>
                                               <span class="text-xs <span class="math-inline">\{statusColor\}"\>\[</span>{statusText}]</span>
                                             </li>`;
                          });
                          listHtml += '</ul>';
                          modal_registeredSerialsList.innerHTML = listHtml;
                     }
                 }

                updateUI(); // تحديث الواجهة الرئيسية لعكس التغييرات (مثل عدد السيريالات المتوفرة)
            }


            // --- المقاصة، تقرير المبيعات، تأكيد/إلغاء المؤقت، البحث ---
            function performTwoPartyOffset() {
                if (!offsetDebtorNameInput || !offsetCreditorNameInput || !offsetAmountInput || !offsetMessage) return;
                const debtorName = offsetDebtorNameInput.value.trim();
                const creditorName = offsetCreditorNameInput.value.trim();
                const offsetAmount = parseInputNumber(offsetAmountInput);

                if (!debtorName || !creditorName || isNaN(offsetAmount) || offsetAmount <= 0) {
                    showMessage(offsetMessage, "يرجى إدخال اسم المدين والدائن ومبلغ مقاصة صحيح (> 0).", true);
                    return;
                }
                 if (debtorName === creditorName) {
                    showMessage(offsetMessage, "لا يمكن إجراء مقاصة لنفس الشخص (المدين هو الدائن).", true);
                    return;
                 }

                // Find total debt for the debtor
                const debtorTotal = debtors
                    .filter(d => d.name === debtorName)
                    .reduce((sum, d) => sum + (Number(d.amount) || 0), 0);

                // Find total liability for the creditor
                const creditorTotal = liabilities
                    .filter(l => l.name === creditorName)
                    .reduce((sum, l) => sum + (Number(l.amount) || 0), 0);

                if (debtorTotal < offsetAmount - 0.001) { // Use tolerance
                    showMessage(offsetMessage, `مبلغ المقاصة (<span class="math-inline">\{formatCurrency\(offsetAmount\)\}\) أكبر من إجمالي دين المدين "</span>{debtorName}" (${formatCurrency(debtorTotal)}).`, true);
                    return;
                }
                if (creditorTotal < offsetAmount - 0.001) { // Use tolerance
                    showMessage(offsetMessage, `مبلغ المقاصة (<span class="math-inline">\{formatCurrency\(offsetAmount\)\}\) أكبر من إجمالي التزام الدائن "</span>{creditorName}" (${formatCurrency(creditorTotal)}).`, true);
                    return;
                }

                // --- Apply Offset ---
                // Reduce Debtor's Debt
                let remainingOffsetForDebtor = offsetAmount;
                debtors = debtors.map(debt => {
                    if (debt.name === debtorName && remainingOffsetForDebtor > 0 && (Number(debt.amount) || 0) > 0.001) {
                        const deduction = Math.min(Number(debt.amount) || 0, remainingOffsetForDebtor);
                        debt.amount = (Number(debt.amount) || 0) - deduction;
                        remainingOffsetForDebtor -= deduction;
                    }
                    return debt;
                }).filter(debt => (Number(debt.amount) || 0) > 0.001); // Remove zeroed debts

                // Reduce Creditor's Liability
                let remainingOffsetForCreditor = offsetAmount;
                 liabilities = liabilities.map(liability => {
                    if (liability.name === creditorName && remainingOffsetForCreditor > 0 && (Number(liability.amount) || 0) > 0.001) {
                        const deduction = Math.min(Number(liability.amount) || 0, remainingOffsetForCreditor);
                        liability.amount = (Number(liability.amount) || 0) - deduction;
                        remainingOffsetForCreditor -= deduction;
                    }
                    return liability;
                }).filter(liability => (Number(liability.amount) || 0) > 0.001); // Remove zeroed liabilities


                logOperation("مقاصة", `تنفيذ مقاصة بمبلغ <span class="math-inline">\{formatCurrency\(offsetAmount\)\} بين المدين "</span>{debtorName}" والدائن "${creditorName}".`);
                showMessage(offsetMessage, `تم تنفيذ المقاصة بنجاح بمبلغ ${formatCurrency(offsetAmount)}.`, false);

                // Clear inputs
                offsetDebtorNameInput.value = '';
                offsetCreditorNameInput.value = '';
                offsetAmountInput.value = '';

                updateUI();
            }

             // --- دالة إنشاء تقرير المبيعات الشهري (نسخة مصححة للتأكد من استخدام Backticks) ---
           // --- دالة إنشاء تقرير المبيعات الشهري (نسخة معدلة للعمل مع Firebase) ---
// --- دالة إنشاء تقرير المبيعات الشهرية (النسخة النهائية والمحصّنة) ---
async function generateMonthlySalesReport() {
    if (!reportMonthYearInput || !reportMessage || !salesReportTableBody || !reportTotalSales || !reportTotalCost || !reportTotalProfit) return;

    const yearMonth = reportMonthYearInput.value;
    if (!yearMonth) {
        showMessage(reportMessage, "يرجى اختيار الشهر والسنة لعرض التقرير.", true);
        return;
    }

    showMessage(reportMessage, `جاري تحميل بيانات المبيعات لشهر ${yearMonth} من الإنترنت...`, false, true);

    const datesInMonth = getMonthStartDateEndDate(yearMonth);
    let monthlySales = [];
    let foundData = false;

    for (const dateStr of datesInMonth) {
        const dayData = await fetchOnlineDataForDate(dateStr); // هذه الدالة بها كود التشخيص

        // --- بداية الكود الجديد المحصّن ---
        // سيقوم هذا الكود بالبحث عن بيانات المبيعات بمرونة
        let salesForThisDay = null;
        if (dayData) {
            // جرب البحث عن "salesToday" بالضبط
            if (Array.isArray(dayData.salesToday)) {
                salesForThisDay = dayData.salesToday;
            }
            // إذا فشل، جرب البحث عن "salestoday" (حالة أحرف صغيرة)
            else if (Array.isArray(dayData.salestoday)) {
                console.log(`[تنبيه] تم العثور على حقل "salestoday" بدلاً من "salesToday" للتاريخ ${dateStr}.`);
                salesForThisDay = dayData.salestoday;
            }
        }
        // --- نهاية الكود الجديد المحصّن ---

        if (salesForThisDay && salesForThisDay.length > 0) {
            foundData = true;
            salesForThisDay.forEach(sale => {
                sale.saleDate = dateStr;
                monthlySales.push(sale);
            });
        }
    }

    if (!foundData) {
        showMessage(reportMessage, `لا توجد بيانات مبيعات محفوظة على الإنترنت للشهر المحدد (${yearMonth}).`, false, true);
        salesReportTableBody.innerHTML = `<tr><td colspan="7" class="text-center text-gray-500 py-4">لا توجد بيانات مبيعات محفوظة للشهر المحدد.</td></tr>`;
        reportTotalSales.textContent = formatCurrency(0);
        reportTotalCost.textContent = formatCurrency(0);
        reportTotalProfit.textContent = formatCurrency(0);
        return;
    }

    // باقي الكود يبقى كما هو بدون أي تغيير
    monthlySales.sort((a, b) => {
        const dateComparison = a.saleDate.localeCompare(b.saleDate);
        if (dateComparison !== 0) return dateComparison;
        return new Date(a.timestamp) - new Date(b.timestamp);
    });

    let totalMonthSales = 0, totalMonthCost = 0, totalMonthProfit = 0;
    let tableHTML = '';

    monthlySales.forEach(sale => {
        const saleDateDisplay = formatDateForDisplay(sale.saleDate);
        const customer = sale.customerName || '-';
        let itemsDesc = '';
        if (sale.items && sale.items.length > 0) {
            itemsDesc = sale.items.map(item => `${item.quantity}x ${item.name} ${item.serial ? '(S/N: '+item.serial+')' : ''}`).join('<br>');
        }
        const saleAmount = Number(sale.grandTotal ?? sale.totalSellPrice) || 0;
        const costAmount = Number(sale.totalCost) || 0;
        const profitAmount = Number(sale.profit) || 0;
        totalMonthSales += saleAmount;
        totalMonthCost += costAmount;
        totalMonthProfit += profitAmount;
        let saleTypeDesc = sale.type === 'invoice' ? 'فاتورة' :
                           sale.type === 'quick' ? 'بيع سريع' :
                           sale.type === 'pending-confirmed' ? 'مؤكد (بدون فاتورة)' :
                           sale.type === 'invoice-from-pending' ? 'فاتورة (من مؤكد)' : 'غير محدد';
        tableHTML += `
            <tr>
                <td>${saleDateDisplay}<br><small>${formatDateTime(sale.timestamp)}</small></td>
                <td>${customer}</td>
                <td>${itemsDesc}</td>
                <td class="text-center font-mono">${formatCurrency(saleAmount)}</td>
                <td class="text-center font-mono">${formatCurrency(costAmount)}</td>
                <td class="text-center font-mono">${formatCurrency(profitAmount)}</td>
                <td class="text-center">${saleTypeDesc}</td>
            </tr>
        `;
    });

    if (!tableHTML) {
        tableHTML = `<tr><td colspan="7" class="text-center text-gray-500 py-4">لا توجد عمليات بيع مسجلة لهذا الشهر.</td></tr>`;
    }

    salesReportTableBody.innerHTML = tableHTML;
    reportTotalSales.textContent = formatCurrency(totalMonthSales);
    reportTotalCost.textContent = formatCurrency(totalMonthCost);
    reportTotalProfit.textContent = formatCurrency(totalMonthProfit);
    showMessage(reportMessage, `تم عرض تقرير المبيعات لشهر ${yearMonth} بنجاح.`, false);
}
            function handlePendingSaleActions(event) {
            saveStateToHistory();
                console.log("handlePendingSaleActions called");
                const button = event.target.closest('button');
                if (!button) return;

                const pendingId = button.dataset.pendingId;
                const saleIndex = pendingSales.findIndex(s => s.id === pendingId);
                if (saleIndex === -1) {
                    console.error("Pending sale not found:", pendingId);
                    showGlobalMessage("خطأ: لم يتم العثور على البيع المؤقت.", true);
                    return;
                }
                const sale = pendingSales[saleIndex];
                const saleCost = calculateSinglePendingSaleCost(sale);

                if (button.classList.contains('confirm-pending')) {
                    // Confirm Only (No Invoice)
                    if (confirm(`هل أنت متأكد من تأكيد هذا البيع المؤقت (بدون إنشاء فاتورة مفصلة)؟\nالعميل: ${sale.customerName || '-'}\nالسعر: ${formatCurrency(sale.totalSellPrice)}\nالربح: ${formatCurrency(sale.potentialProfit)}`)) {
                        liquidity += sale.totalSellPrice;
                        totalProfit += sale.potentialProfit;
                        goodsOnConsignmentValue -= saleCost; // Reduce consignment value

                        // **** تحديث حالة السيريالات المرتبطة بالبيع المؤقت إلى 'sold' ****
                         const itemsInPendingSale = [sale.mainProduct, ...(sale.additionalItems || [])];
                         // حالياً، البيع المؤقت لا يسجل سيريال محدد، لذا لا يوجد تحديث للسيريالات هنا
                         // If serial tracking was implemented for pending sales, update status here

                        const confirmedSaleData = pendingSales.splice(saleIndex, 1)[0]; // Remove from pending and get data

                        const liqLogEntry = { id: `liq-${Date.now()}`, timestamp: new Date().toISOString(), type: "add", amount: sale.totalSellPrice, description: `تأكيد بيع مؤقت لـ ${sale.customerName || 'عميل'}`, currentBalance: liquidity };
                        liquidityLog.push(liqLogEntry);
                        logOperation("تأكيد بيع مؤقت", `تم تأكيد بيع مؤقت لـ ${sale.customerName || '-'}. السعر: ${formatCurrency(sale.totalSellPrice)}. الربح: ${formatCurrency(sale.potentialProfit)}.`);

                        // Add simple record to salesToday
                         const saleRecord = {
                             id: confirmedSaleData.id.replace('pending','confirmed'),
                             type: 'pending-confirmed',
                             timestamp: new Date().toISOString(), // Confirmation time
                             originalTimestamp: confirmedSaleData.timestamp,
                             customerName: confirmedSaleData.customerName || null,
                             items: [confirmedSaleData.mainProduct, ...(confirmedSaleData.additionalItems || [])], // Simplified items
                             totalSellPrice: confirmedSaleData.totalSellPrice,
                             totalCost: saleCost,
                             profit: confirmedSaleData.potentialProfit,
                         };
                         salesToday.push(saleRecord);

                        updateUI();
                        showGlobalMessage("تم تأكيد البيع المؤقت بنجاح.", false);
                    }
                } else if (button.classList.contains('confirm-invoice-pending')) {
                    // Confirm and Create Invoice
                    if (confirm(`هل أنت متأكد من تأكيد هذا البيع المؤقت وفتح نافذة لإنشاء فاتورة مفصلة؟\nالعميل: ${sale.customerName || '-'}\nالسعر المتوقع: ${formatCurrency(sale.totalSellPrice)}`)) {
                        goodsOnConsignmentValue -= saleCost; // Reduce consignment value now
                        pendingSaleOriginData = pendingSales.splice(saleIndex, 1)[0]; // Remove and store data
                        isInvoiceFromPending = true;

                         // **** تحديث حالة السيريالات المرتبطة إلى 'pending_invoice' أو تركها كما هي؟ ****
                         // حالياً لن نغير الحالة هنا، سيتم تغييرها إلى 'sold' عند حفظ الفاتورة

                        logOperation("بدء تأكيد مؤقت بفاتورة", `بدء عملية تأكيد بيع مؤقت مع إنشاء فاتورة لـ <span class="math-inline">\{sale\.customerName \|\| '\-'\}\. تم خصم التكلفة \(</span>{formatCurrency(saleCost)}) من قيمة البضاعة المؤقتة.`);

                        // Open invoice modal and pre-fill data
                        inv_openModal();
                        if(inv_customerNameInput) inv_customerNameInput.value = sale.customerName || '';
                        // Add items to invoice table
                        if(inv_invoiceItemsBody) inv_invoiceItemsBody.innerHTML = ''; // Clear first
                        const mainItemQty = Number(sale.mainProduct.quantity) || 0;
                        const mainItemCost = Number(sale.mainProduct.costPrice) || 0;
                        // Try to guess unit price if possible, otherwise set to 0
                        const mainItemUnitPrice = mainItemQty > 0 ? (sale.totalSellPrice / mainItemQty) : 0; // Simple guess

                        const mainRow = document.createElement('tr');
                        mainRow.classList.add('invoice-item-row');
                        mainRow.dataset.itemName = sale.mainProduct.name;
                        mainRow.dataset.itemQty = mainItemQty;
                        mainRow.dataset.itemPrice = mainItemUnitPrice.toFixed(2);
                        mainRow.dataset.itemSubtotal = (mainItemUnitPrice * mainItemQty).toFixed(2); // Use calculated price
                        mainRow.dataset.itemCost = mainItemCost.toFixed(2);
                        // لا نضيف سيريال هنا تلقائياً، سيتم اختياره يدوياً إذا كانت الكمية 1
                        mainRow.innerHTML = `<td class="item-name"><span class="math-inline">\{sale\.mainProduct\.name\}</td\><td class\="item\-qty"\></span>{mainItemQty}</td><td class="item-price"><span class="math-inline">\{formatCurrency\(mainItemUnitPrice\)\}</td\><td class\="item\-subtotal"\></span>{formatCurrency(mainItemUnitPrice * mainItemQty)}</td><td class="no-print"><button type="button" class="remove-item-btn" title="حذف البند">×</button></td>`;
                        if(inv_invoiceItemsBody) inv_invoiceItemsBody.appendChild(mainRow);

                        // Add additional items (assuming price was included in main product price initially)
                        (sale.additionalItems || []).forEach(item => {
                             const itemQty = Number(item.quantity) || 0;
                             const itemCost = Number(item.costPrice) || 0;
                             const itemRow = document.createElement('tr');
                             itemRow.classList.add('invoice-item-row');
                             itemRow.dataset.itemName = item.name;
                             itemRow.dataset.itemQty = itemQty;
                             itemRow.dataset.itemPrice = (0).toFixed(2); // Assuming additional items had 0 price initially
                             itemRow.dataset.itemSubtotal = (0).toFixed(2);
                             itemRow.dataset.itemCost = itemCost.toFixed(2);
                             itemRow.innerHTML = `<td class="item-name"><span class="math-inline">\{item\.name\}</td\><td class\="item\-qty"\></span>{itemQty}</td><td class="item-price"><span class="math-inline">\{formatCurrency\(0\)\}</td\><td class\="item\-subtotal"\></span>{formatCurrency(0)}</td><td class="no-print"><button type="button" class="remove-item-btn" title="حذف البند">×</button></td>`;
                              if(inv_invoiceItemsBody) inv_invoiceItemsBody.appendChild(itemRow);
                        });

                        // Add note about origin
                        const noteP = document.createElement('p');
                        noteP.className = 'invoice-origin-note'; // Add class for easier removal
                        noteP.style.color = 'blue';
                        noteP.style.fontSize = '0.8em';
                        noteP.style.marginTop = '10px';
                        noteP.textContent = `ملاحظة: تم ملء البيانات من بيع مؤقت. السعر الإجمالي الأصلي كان ${formatCurrency(sale.totalSellPrice)}. قم بمراجعة وتعديل الأسعار إذا لزم الأمر.`;
                        inv_invoiceItemsBody?.parentNode.insertBefore(noteP, inv_invoiceItemsBody.nextSibling);


                        inv_calculateTotals(); // Recalculate totals based on added items
                        inv_updateDeductibleCostsCheckboxes(); // Update deductible options
                        updateUI(); // Update main UI (like consignment value)
                        showGlobalMessage("تم فتح نافذة الفاتورة ببيانات البيع المؤقت.", false, true); // Info message

                    }

                } else if (button.classList.contains('cancel-pending')) {
                    // Cancel / Return to Stock
                    if (confirm(`هل أنت متأكد من إلغاء هذا البيع المؤقت وإرجاع البضاعة للمخزون؟\nالعميل: ${sale.customerName || '-'}\nالتكلفة المسترجعة: ${formatCurrency(saleCost)}`)) {
                        // Return items to stock
                        const itemsToReturn = [sale.mainProduct, ...(sale.additionalItems || [])];
                        itemsToReturn.forEach(item => {
                            const productIndex = products.findIndex(p => p.name === item.name);
                            if (productIndex !== -1) {
                                products[productIndex].quantity = (Number(products[productIndex].quantity) || 0) + (Number(item.quantity) || 0);
                                // Assume cost price doesn't need recalculation on return for simplicity
                            } else {
                                // If product was deleted, re-add it
                                products.push({
                                    name: item.name,
                                    quantity: Number(item.quantity) || 0,
                                    costPrice: Number(item.costPrice) || 0,
                                    supplierId: item.supplierId || ""
                                });
                            }
                            // **** تحديث حالة السيريالات المرتجعة (مهم) ****
                            // حالياً، لا يتم تغيير حالة السيريال عند إنشاء بيع مؤقت، لذا لا حاجة لإعادته هنا
                            // إذا تم تغيير هذا المنطق لاحقاً، يجب إضافة كود هنا لإعادة حالة السيريالات إلى 'in_stock'
                        });

                        goodsOnConsignmentValue -= saleCost; // Reduce consignment value
                        pendingSales.splice(saleIndex, 1); // Remove from pending

                        logOperation("إلغاء بيع مؤقت", `تم إلغاء بيع مؤقت لـ ${sale.customerName || '-'}. تم إرجاع البضاعة (تكلفة ${formatCurrency(saleCost)}) للمخزون.`);
                        updateUI();
                        showGlobalMessage("تم إلغاء البيع المؤقت وإرجاع البضاعة للمخزون.", false);
                    }
                }else if (button.classList.contains('print-pending-invoice')) {
                    console.log("Print pending button clicked for ID:", pendingId);
    printPendingSaleAsInvoice(pendingId); 
}
            }
            // --- Invoice Search Functions ---
            function searchInvoiceByNumber() {
                if (!searchInvoiceNumberInput || !searchResultsListContainer || !searchMessageContainer) return;
                const searchTerm = searchInvoiceNumberInput.value.trim();
                 showMessage(searchMessageContainer, ""); // Clear previous messages

                if (!searchTerm) {
                    showMessage(searchMessageContainer, "يرجى إدخال رقم الفاتورة للبحث.", true);
                    searchResultsListContainer.innerHTML = '<p class="text-center text-gray-500">أدخل رقم الفاتورة.</p>';
                    return;
                }
                 console.log(`Searching for invoice number: ${searchTerm} in salesToday:`, salesToday);
                // Search within the currently loaded day's sales
                const results = salesToday.filter(sale => sale.invoiceNumber && sale.invoiceNumber === searchTerm);
                displaySearchResults(results);
            }
            function searchInvoiceByName() {
                if (!searchCustomerNameInput || !searchResultsListContainer || !searchMessageContainer) return;
                const searchTerm = searchCustomerNameInput.value.trim().toLowerCase();
                 showMessage(searchMessageContainer, ""); // Clear previous messages

                if (!searchTerm) {
                    showMessage(searchMessageContainer, "يرجى إدخال اسم العميل للبحث.", true);
                    searchResultsListContainer.innerHTML = '<p class="text-center text-gray-500">أدخل اسم العميل.</p>';
                    return;
                }
                 console.log(`Searching for customer name: ${searchTerm} in salesToday:`, salesToday);
                // Search within the currently loaded day's sales (case-insensitive partial match)
                const results = salesToday.filter(sale => sale.customerName && sale.customerName.toLowerCase().includes(searchTerm));
                displaySearchResults(results);
            }
            function displaySearchResults(results) {
                 if (!searchResultsListContainer || !searchMessageContainer) return;

                 if (results.length === 0) {
                     searchResultsListContainer.innerHTML = '<p class="text-center text-gray-500">لم يتم العثور على فواتير مطابقة.</p>';
                     showMessage(searchMessageContainer, "لم يتم العثور على نتائج.", false, true); // Use info style
                     return;
                 }

                 // Simple list display for now
                 searchResultsListContainer.innerHTML = `
                     <ul class="space-y-3">
                         ${results.map(sale => `
                             <li class="p-3 border rounded-md bg-gray-50 shadow-sm">
                                 <div class="flex justify-between items-center flex-wrap gap-2">
                                     <div>
                                         <strong class="text-blue-600">رقم: ${sale.invoiceNumber || 'N/A'}</strong> |
                                         <span class="text-xs text-gray-500">${formatDateTime(sale.timestamp)}</span> <br>
                                         <span>العميل: ${sale.customerName || '-'}</span>
                                     </div>
                                     <div class="font-semibold text-red-600 text-lg">
                                         ${formatCurrency(sale.grandTotal || sale.totalSellPrice || 0)}
                                     </div>
                                 </div>
                                 <div class="text-sm mt-1 text-gray-600">
                                     الربح: ${formatCurrency(sale.profit || 0)} | التكلفة: ${formatCurrency(sale.totalCost || 0)}
                                 </div>
                                 <button data-invoice-id="${sale.id}" class="view-invoice-details-btn text-xs bg-teal-500 hover:bg-teal-600 text-white font-semibold py-1 px-2 rounded mt-2 border border-teal-600">عرض التفاصيل</button>
                             </li>
                         `).join('')}
                     </ul>`;
                  showMessage(searchMessageContainer, `تم العثور على ${results.length} فاتورة/فواتير.`, false);
             }
            // Function to handle viewing invoice details (uses print logic)
            function viewInvoiceDetails(invoiceId) {
                 const invoice = salesToday.find(s => s.id === invoiceId);
                 if (invoice) {
                     // Use print logic to show details in a new window
                     inv_printInvoice(invoice); // Pass the found invoice object
                 } else {
                     showGlobalMessage("لم يتم العثور على تفاصيل الفاتورة المطلوبة.", true);
                 }
              }

            // **** دالة البحث عن السيريالات للمورد (مع فلترة داخلية) ****
            function searchSerialsBySupplier() {
                if (!searchSupplierSerialNameInput || !supplierSerialsResultsContainer || !serialSearchMessage || !filterSerialsContainer) return;
                const supplierName = searchSupplierSerialNameInput.value.trim();
                showMessage(serialSearchMessage, ''); // Clear previous message
                supplierSerialsResultsContainer.innerHTML = ''; // Clear previous results
                filterSerialsContainer.classList.add('hidden'); // Hide filter input initially
                filterSerialsInput.value = ''; // Clear filter input
                currentSupplierSerials = []; // Clear the temporary list

                if (!supplierName) {
                    showMessage(serialSearchMessage, "يرجى إدخال اسم المورد للبحث.", true);
                    supplierSerialsResultsContainer.innerHTML = '<p class="text-center text-gray-500">أدخل اسم المورد.</p>';
                    return;
                }

                // Find supplier ID (case-insensitive)
                const supplier = suppliers.find(s => s.name.toLowerCase() === supplierName.toLowerCase());

                if (!supplier) {
                    showMessage(serialSearchMessage, `لم يتم العثور على مورد بالاسم "${supplierName}".`, true);
                    supplierSerialsResultsContainer.innerHTML = `<p class="text-center text-gray-500">لم يتم العثور على مورد بالاسم "${supplierName}".</p>`;
                    return;
                }

                // Filter serial numbers log based on supplier ID
                const foundSerials = serialNumbersLog
                    .filter(log => log.supplierId === supplier.id)
                    .sort((a, b) => new Date(b.addedTimestamp) - new Date(a.addedTimestamp)); // Sort by newest first

                currentSupplierSerials = foundSerials; // Store the found serials for filtering

                if (foundSerials.length === 0) {
                    showMessage(serialSearchMessage, `لا توجد أرقام تسلسلية مسجلة للمورد "${supplierName}".`, false, true); // Info message
                    supplierSerialsResultsContainer.innerHTML = `<p class="text-center text-gray-500">لا توجد أرقام تسلسلية مسجلة لهذا المورد.</p>`;
                } else {
                     displayFilteredSupplierSerials(''); // Display all found serials initially
                     filterSerialsContainer.classList.remove('hidden'); // Show the filter input
                     showMessage(serialSearchMessage, `تم العثور على <span class="math-inline">\{foundSerials\.length\} رقم تسلسلي للمورد "</span>{supplierName}". يمكنك الآن تصفية النتائج أدناه.`, false);
                }
            }

            // **** دالة جديدة لعرض السيريالات المفلترة ****
            function displayFilteredSupplierSerials(searchTerm = '') {
                 if (!supplierSerialsResultsContainer) return;
                 const lowerSearchTerm = searchTerm.toLowerCase();

                 const filteredList = currentSupplierSerials.filter(log =>
                     log.serial.toLowerCase().includes(lowerSearchTerm)
                 );

                 if (filteredList.length === 0) {
                      supplierSerialsResultsContainer.innerHTML = `<p class="text-center text-gray-500">لا توجد أرقام تسلسلية تطابق "${searchTerm}".</p>`;
                      return;
                 }

                 // Display results
                 let html = '<ul class="space-y-2">';
                 filteredList.forEach(log => {
                      let statusColor = 'text-gray-500'; // افتراضي
                      let statusText = log.status || 'غير محدد';
                      if (statusText === 'in_stock') { statusColor = 'text-green-600'; statusText = 'متوفر'; }
                      else if (statusText === 'sold') { statusColor = 'text-red-500'; statusText = 'مباع'; }
                      else if (statusText === 'in_invoice_temp') { statusColor = 'text-yellow-600'; statusText = 'في فاتورة'; }
                      // Add more statuses if needed

                      html += `<li class="border-b border-gray-100 pb-1">
                                   <span class="font-mono"><strong><span class="math-inline">\{log\.serial \|\| 'N/A'\}</strong\></span\>
<span class\="text\-sm text\-gray\-700"\>\(</span>{log.productName || 'منتج غير محدد'})</span> -
                                   <span class="text-xs text-gray-500">${formatDateTime(log.addedTimestamp)}</span>
                                   <span class="text-xs <span class="math-inline">\{statusColor\} ml\-2 font\-medium"\>\[</span>{statusText}]</span>
                                 </li>`;
                 });
                 html += '</ul>';
                 supplierSerialsResultsContainer.innerHTML = html;
             }


            // **** دالة استيراد السيريالات من ملف CSV ****
            function importSerialCSV(event, targetTextarea, messageElement) {
                const file = event.target.files[0];

                if (!file || !targetTextarea) {
                    showMessage(messageElement, "لم يتم اختيار ملف أو أن حقل السيريالات غير موجود.", true);
                    return;
                }
                if (!/\.(csv|txt)$/i.test(file.name)) {
                     showMessage(messageElement, "الرجاء اختيار ملف بصيغة CSV أو TXT.", true);
                     event.target.value = null; // Reset file input
                     return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const content = e.target.result;
                        let importedSerials = [];

                        // **** تعديل منطق القراءة لاستخلاص السيريال فقط ****
                        const lines = content.split('\n');
                        lines.forEach(line => {
                            const trimmedLine = line.trim();
                            if (trimmedLine) {
                                // افترض أن السيريال هو الجزء الأول قبل أول مسافة أو فاصلة
                                const match = trimmedLine.match(/^([^\s,]+)/);
                                if (match && match[1]) {
                                    const potentialSerial = match[1].trim();
                                    if (potentialSerial) { // تأكد أنه ليس فارغاً بعد الاقتطاع
                                        importedSerials.push(potentialSerial);
                                    }
                                }
                            }
                        });
                        // **** نهاية تعديل منطق القراءة ****


                        if (importedSerials.length > 0) {
                            // ضع السيريالات المستوردة في الـ textarea (كل واحد في سطر)
                            targetTextarea.value = importedSerials.join('\n');
                            showMessage(messageElement, `تم استيراد ${importedSerials.length} رقم تسلسلي بنجاح. يرجى المراجعة ثم الضغط على زر الحفظ/الإضافة.`, false);
                        } else {
                            showMessage(messageElement, "لم يتم العثور على أرقام تسلسلية صالحة في الملف. تأكد أن كل سيريال في سطر أو مفصول بفاصلة/مسافة.", true);
                        }

                    } catch (error) {
                        console.error("Error reading or processing serial file:", error);
                        showMessage(messageElement, `حدث خطأ أثناء قراءة الملف: ${error.message}`, true);
                    } finally {
                        event.target.value = null; // Reset file input
                    }
                };
                reader.onerror = function(e) {
                     console.error("Error reading file:", e);
                     showMessage(messageElement, "حدث خطأ أثناء قراءة الملف.", true);
                     event.target.value = null;
                };
                reader.readAsText(file);
            }

            // (سيتم استكمال JavaScript في الجزء التالي 8ج مع initializeApp)
            // ===================================================================================
// START: FINANCIAL CENTER (FC) LOGIC
// ===================================================================================

// Helper to get all data for a specific month (YYYY-MM) from localStorage
 async function fc_get_data_for_month(month) {
    const datesInMonth = getMonthStartDateEndDate(month);
    let monthlyExpenses = new Map();
    let monthlyProductPurchases = new Map();

    // أولاً: أضف كل الالتزامات الشهرية والديون المعالجة (التي لم تكتمل)
    if (monthlyLiabilities && monthlyLiabilities.length > 0) {
        monthlyLiabilities.forEach(liability => {
            if (liability.isAmortizedDebt) {
                // إذا كان ديناً معالجاً، تحقق مما إذا كانت مدته قد انتهت
                if (liability.periodsProcessed < liability.totalPeriods) {
                    monthlyExpenses.set(liability.id, { name: `${liability.name} [شهر ${liability.periodsProcessed + 1}/${liability.totalPeriods}]`, amount: liability.amount });
                }
            } else {
                // إذا كان التزاماً شهرياً عادياً (مثل الإيجار)، أضفه دائماً
                monthlyExpenses.set(liability.id, { name: liability.name, amount: liability.amount });
            }
        });
    }

    // ثانياً: أضف المصاريف اليومية المسجلة في السجل
    for (const dateStr of datesInMonth) {
        const dayData = fetchData(lsPrefix + dateStr, null);
        if (dayData && dayData.log) {
            dayData.log.forEach(logEntry => {
                if (logEntry.type === "تسجيل مصروف") {
                    const expenseMatch = logEntry.details.match(/بقيمة ([\d\.,]+) جنيه/);
                    if (expenseMatch && expenseMatch[1]) {
                        const amount = parseFloat(expenseMatch[1].replace(/,/g, ''));
                        const name = `مصروف يومي: ${logEntry.details.split('.')[0]}`;
                        if (!isNaN(amount)) {
                            const expenseId = `daily-${logEntry.timestamp}`;
                            monthlyExpenses.set(expenseId, { name: name, amount: (monthlyExpenses.get(expenseId)?.amount || 0) + amount });
                        }
                    }
                }
            });
        }
    }
    
    // تحويل الـ Map إلى مصفوفة للعرض
    const expensesArray = Array.from(monthlyExpenses.entries());
    return { expenses: expensesArray };
}


// Populate the UI lists for the selected month with REAL data
 async function fc_populate_lists(month) {
    if (!month || !fc_expenses_list || !fc_products_list) return;
    
    const { expenses } = await fc_get_data_for_month(month);
    
    fc_expenses_list.innerHTML = expenses.length > 0
        ? expenses.map(([id, exp]) => `<label class="flex items-center p-2 rounded-md hover:bg-gray-100 cursor-pointer"><input type="checkbox" data-id="${id}" data-amount="${exp.amount}" class="fc-expense-checkbox ml-3" checked>${exp.name} <span class="mr-auto font-mono text-gray-600">${formatCurrency(exp.amount)}</span></label>`).join('')
        : '<p class="text-sm text-gray-500">لا توجد مصاريف مسجلة لهذا الشهر.</p>';

    const productsInStock = products.filter(p => p.quantity > 0);

    fc_products_list.innerHTML = productsInStock.length > 0
        ? productsInStock.map(prod => {
            const totalValue = (prod.quantity || 0) * (prod.costPrice || 0);
            return `<label class="flex items-center p-3 bg-gray-50 rounded-md hover:bg-gray-100 cursor-pointer border"><input type="checkbox" class="fc-product-checkbox ml-3" data-name="${prod.name}" data-qty="${prod.quantity}" data-value="${totalValue}" data-cost="${prod.costPrice}" checked>${prod.name} <span class="mr-auto font-mono text-gray-600">(الكمية الحالية: ${prod.quantity}، التكلفة: ${formatCurrency(prod.costPrice)})</span></label>`;
        }).join('')
        : '<p class="text-sm text-gray-500">لا توجد منتجات في المخزون حالياً.</p>';
    
    fc_add_event_listeners_to_lists();
    fc_update_ui();
}


// Populate the debt treatment tab with REAL data
function fc_populate_debt_treatment() {
    if (!fc_debt_select) return;
    const validDebts = debtors.filter(d => (Number(d.amount) || 0) > 0.001);
    fc_debt_select.innerHTML = '<option value="">-- اختر الدين للمعالجة --</option>' 
        + validDebts.map(d => `<option value="${d.id}" data-amount="${d.amount}">${d.name} - ${d.reason} (${formatCurrency(d.amount)})</option>`).join('');
}

function fc_populate_month_select() {
    if (!fc_month_select) return;
    const months = new Set();
    // Get all keys from localStorage
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith(lsPrefix)) {
            const dateStr = key.substring(lsPrefix.length);
            const monthStr = dateStr.substring(0, 7); // YYYY-MM
            months.add(monthStr);
        }
    }
    
    const sortedMonths = Array.from(months).sort().reverse();
    fc_month_select.innerHTML = sortedMonths.map(month => {
        const [year, m] = month.split('-');
        const date = new Date(year, m - 1);
        const monthName = date.toLocaleString('ar-EG', { month: 'long', year: 'numeric' });
        return `<option value="${month}">${monthName}</option>`;
    }).join('');

    // If there are months, populate lists for the first one
    if (sortedMonths.length > 0) {
        fc_populate_lists(sortedMonths[0]);
    }
}

 function fc_update_ui() {
    if (!d('fc-auto-cost-mode-radio')) return; // Check if the elements are rendered
    fc_toggle_cost_mode();
    fc_calculate_and_display_totals();
    fc_toggle_manual_distribution();

    // هذا هو السطر المهم الذي تم تعديله
    // سيقوم دائماً بتشغيل المحاكاة، وهي التي ستقرر إظهار النافذة أو إخفائها
    fc_simulate_distribution(); 
}

function fc_add_event_listeners_to_lists() {
    document.querySelectorAll('.fc-expense-checkbox, .fc-product-checkbox, input[name="fc-distribution-method"], input[name="fc-cost-mode"], #fc-manual-cost-input').forEach(el => el.addEventListener('change', fc_update_ui));
    if(fc_manual_cost_input) fc_manual_cost_input.addEventListener('input', fc_update_ui);
    const manualRadio = d('fc-distribution-manual-radio');
    if(manualRadio) manualRadio.addEventListener('change', fc_populate_manual_inputs);
    if(fc_products_list) fc_products_list.addEventListener('change', () => { if(d('fc-distribution-manual-radio').checked) fc_populate_manual_inputs(); });
}

function fc_toggle_cost_mode() {
    if(!fc_expenses_wrapper || !fc_manual_cost_wrapper) return;
    const isManual = d('fc-manual-cost-mode-radio').checked;
    fc_expenses_wrapper.classList.toggle('fc-disabled-section', isManual);
    fc_manual_cost_wrapper.classList.toggle('hidden', !isManual);
}

function fc_calculate_and_display_totals() {
    if (!fc_total_expenses_display) return;
    let totalExpenses = 0;
    if (d('fc-manual-cost-mode-radio').checked) {
        totalExpenses = parseFloat(fc_manual_cost_input.value) || 0;
    } else {
        fc_expenses_list.querySelectorAll('input:checked').forEach(e => totalExpenses += parseFloat(e.dataset.amount));
    }
    fc_total_expenses_display.textContent = formatCurrency(totalExpenses);
}

function fc_toggle_manual_distribution() {
    if(!fc_manual_container) return;
    const isManual = d('fc-distribution-manual-radio').checked;
    fc_manual_container.classList.toggle('hidden', !isManual);
    if (isManual) fc_populate_manual_inputs();
}

function fc_populate_manual_inputs() {
    if (!fc_manual_list || !fc_products_list) return;
    const selectedProducts = Array.from(fc_products_list.querySelectorAll('input:checked'));
    fc_manual_list.innerHTML = selectedProducts.map(prod => `<div class="flex items-center justify-between p-2"><label for="fc-perc-${prod.dataset.name}">${prod.dataset.name}</label><div class="flex items-center"><input type="number" id="fc-perc-${prod.dataset.name}" data-product-name="${prod.dataset.name}" class="fc-manual-dist-input fc-form-input" min="0" max="100" value="0"><span class="mr-2 font-semibold">%</span></div></div>`).join('') || '<p class="text-sm text-center text-gray-500">اختر المنتجات أولاً.</p>';
    document.querySelectorAll('.fc-manual-dist-input').forEach(input => input.addEventListener('input', fc_validate_and_simulate));
    fc_validate_percentages();
}

function fc_validate_percentages() {
    if (!fc_percentage_total) return false;
    let currentTotal = 0;
    document.querySelectorAll('.fc-manual-dist-input').forEach(input => currentTotal += parseFloat(input.value) || 0);
    fc_percentage_total.textContent = `${currentTotal}%`;
    const feedbackEl = d('fc-percentage-total-feedback');
    if (feedbackEl) {
        feedbackEl.className = 'mt-4 p-2 text-center rounded-md'; // Reset
        if (Math.round(currentTotal) === 100) {
            feedbackEl.classList.add('bg-green-100', 'text-green-800');
        } else {
            feedbackEl.classList.add('bg-red-100', 'text-red-800');
        }
    }
    return Math.round(currentTotal) === 100;
}

function fc_validate_and_simulate() {
    fc_validate_percentages();
    fc_simulate_distribution();
}

function fc_get_simulation_results() {
    let totalExpenses = 0;
    if (d('fc-manual-cost-mode-radio').checked) { totalExpenses = parseFloat(fc_manual_cost_input.value) || 0; } 
    else { fc_expenses_list.querySelectorAll('input:checked').forEach(e => totalExpenses += parseFloat(e.dataset.amount)); }
    
    const selectedProductsEls = Array.from(fc_products_list.querySelectorAll('input:checked'));
    if (selectedProductsEls.length === 0 || totalExpenses <= 0) {
        return null;
    }

    const distributionMethod = document.querySelector('input[name="fc-distribution-method"]:checked').value;
    let productUpdates = [];
    
    if (distributionMethod === 'quantity') {
        let totalQty = 0; selectedProductsEls.forEach(p => totalQty += parseInt(p.dataset.qty));
        if (totalQty === 0) return { error: "مجموع كميات المنتجات صفر." };
        const costPerItem = totalExpenses / totalQty;
        selectedProductsEls.forEach(p => {
            productUpdates.push({ name: p.dataset.name, addedCost: costPerItem });
        });
    } else if (distributionMethod === 'value') {
        let totalValue = 0; selectedProductsEls.forEach(p => totalValue += parseFloat(p.dataset.value));
        if (totalValue === 0) return { error: "مجموع قيمة المنتجات صفر." };
        selectedProductsEls.forEach(p => {
            const qty = parseInt(p.dataset.qty);
            const val = parseFloat(p.dataset.value);
            const costShare = (val / totalValue) * totalExpenses;
            const addedPerItem = qty > 0 ? costShare / qty : 0;
            productUpdates.push({ name: p.dataset.name, addedCost: addedPerItem });
        });
    } else if (distributionMethod === 'manual') {
        if (!fc_validate_percentages()) return { error: "مجموع النسب المئوية يجب أن يكون 100%." };
        selectedProductsEls.forEach(p => {
            const percentageInput = d(`fc-perc-${p.dataset.name}`);
            const percentage = parseFloat(percentageInput.value) || 0;
            const qty = parseInt(p.dataset.qty);
            const costShare = (percentage / 100) * totalExpenses;
            const addedPerItem = qty > 0 ? costShare / qty : 0;
            productUpdates.push({ name: p.dataset.name, addedCost: addedPerItem });
        });
    }
    return { productUpdates };
}

function fc_simulate_distribution() {
    if (!fc_preview_results || !fc_preview_container) return;

    const results = fc_get_simulation_results();
    let resultsHTML = '';

    if (!results) {
        fc_preview_container.classList.remove('visible');
        return;
    }
    if (results.error) {
        resultsHTML = `<p class="text-center text-red-700 font-semibold">${results.error}</p>`;
    } else {
        resultsHTML += `<p class="font-semibold pb-2 mb-2 border-b">نتائج المحاكاة:</p>`;
        results.productUpdates.forEach(update => {
            const originalProduct = products.find(p => p.name === update.name);
            if(originalProduct) {
                const originalCost = originalProduct.costPrice;
                resultsHTML += `<div class="p-2 border-l-4 border-gray-200"><strong>${update.name}:</strong><br><span class="text-sm">التكلفة الجديدة: <span class="font-mono text-gray-500">${formatCurrency(originalCost)}</span> + <span class="font-mono text-orange-500">${formatCurrency(update.addedCost)}</span> = <span class="font-bold text-green-700 font-mono">${formatCurrency(originalCost + update.addedCost)}</span></span></div>`;
            }
        });
    }
    
    fc_preview_results.innerHTML = resultsHTML;
    fc_preview_container.classList.add('visible');
}

function fc_execute_cost_distribution() {
    if (!confirm("هل أنت متأكد من تنفيذ هذا التوزيع؟ سيتم تحديث تكاليف المنتجات المحددة بشكل دائم في بيانات اليوم الحالي.")) return;

    const results = fc_get_simulation_results();
    if (!results || results.error) {
        showGlobalMessage(results ? results.error : "لا يمكن التنفيذ، يرجى مراجعة المدخلات.", true);
        return;
    }

    // --- تحديث تكاليف المنتجات (هذا الجزء لم يتغير) ---
    let logDetails = [];
    results.productUpdates.forEach(update => {
        const productIndex = products.findIndex(p => p.name === update.name);
        if (productIndex > -1) {
            const oldCost = products[productIndex].costPrice;
            products[productIndex].costPrice += update.addedCost;
            const newCost = products[productIndex].costPrice;
            logDetails.push(`"${update.name}" (من ${formatCurrency(oldCost)} إلى ${formatCurrency(newCost)})`);
        }
    });

    // --- الجزء الجديد: تحديث عداد الديون المعالجة التي تم توزيعها ---
    const distributedExpenseCheckboxes = Array.from(d('fc-expenses-to-distribute-list').querySelectorAll('input:checked'));
    distributedExpenseCheckboxes.forEach(checkbox => {
        const liabilityId = checkbox.dataset.id; // سنحتاج لإضافة هذا في الخطوة التالية
        const liabilityToUpdate = monthlyLiabilities.find(l => l.id === liabilityId && l.isAmortizedDebt);
        
        if (liabilityToUpdate) {
            liabilityToUpdate.periodsProcessed += 1;
            logOperation("تحديث معالجة دين", `تم توزيع القسط ${liabilityToUpdate.periodsProcessed} من ${liabilityToUpdate.totalPeriods} للدين "${liabilityToUpdate.name}".`);
        }
    });


    logOperation("توزيع تكاليف", `تم تحديث تكلفة المنتجات: ${logDetails.join(', ')}.`);
    showGlobalMessage("تم تحديث تكاليف المنتجات بنجاح.", false);
    updateUI();
}

function fc_execute_debt_treatment() {
    if (!fc_debt_select) return;
    const selectedOption = fc_debt_select.options[fc_debt_select.selectedIndex];
    if (!selectedOption || !selectedOption.value) {
        showGlobalMessage("يرجى اختيار دين للمعالجة أولاً.", true);
        return;
    }
    
    const debtId = selectedOption.value;
    const debtAmount = parseFloat(selectedOption.dataset.amount);
    const debtIndex = debtors.findIndex(d => d.id === debtId);
    
    if (debtIndex === -1) {
        showGlobalMessage("لم يتم العثور على الدين المحدد.", true);
        return;
    }

    const periodValue = parseInt(d('fc-distribution-period-value').value) || 1;
    const costPerMonth = debtAmount / periodValue;
    const debtInfo = debtors[debtIndex];

    if (!confirm(`هل أنت متأكد من تحويل دين "${debtInfo.name}" بقيمة ${formatCurrency(debtAmount)} إلى التزام شهري؟\nسيتم حذف الدين الحالي وإنشاء التزام شهري بقيمة ${formatCurrency(costPerMonth)} لمدة ${periodValue} شهور.`)) {
        return;
    }

    // 1. Remove the debt from debtors list
    debtors.splice(debtIndex, 1);

    // 2. Add a new "smart" monthly liability with tracking properties
    const newMonthlyLiability = {
        id: generateId('amortized-debt'),
        name: `معالجة دين (${debtInfo.name})`,
        amount: costPerMonth,
        isAmortizedDebt: true,       // علامة لتمييز هذا النوع من الالتزام
        totalPeriods: periodValue,       // إجمالي عدد الشهور
        periodsProcessed: 0,             // عدد الشهور التي تم توزيعها (يبدأ بصفر)
    };
    monthlyLiabilities.push(newMonthlyLiability);
    
    logOperation("معالجة دين متعثر", `تم تحويل دين "${debtInfo.name}" (${formatCurrency(debtAmount)}) إلى التزام شهري ثابت بقيمة ${formatCurrency(costPerMonth)} لمدة ${periodValue} شهور.`);
    showGlobalMessage("تم تحويل الدين إلى التزام شهري بنجاح.", false);

    // Refresh UI
    updateUI();
}

// ===================================================================================
// END: FINANCIAL CENTER (FC) LOGIC
// ===================================================================================

            // --- Initialization --- (دالة التهيئة النهائية مع منطق الترحيل التلقائي والتعديل)
           // =======================================================
// START: دالة بدء التشغيل النهائية (متصلة بالإنترنت)
// =======================================================
async function initializeApp() {
    console.log("Initializing App with Online-First Logic...");

    // (هنا تضع كل تعريفات المتغيرات التي كانت داخل الدالة القديمة)
    // مثال: mainNav = d("main-nav"); contentSections = document.querySelectorAll(...);
    // ... ضع كل تعريفات d(...) هنا ...
     // --- Assign DOM Element References ---
                 // Monthly Liabilities Elements Assignment
monthlyLiabilityNameInput = d('monthly-liability-name');
monthlyLiabilityAmountInput = d('monthly-liability-amount');
addMonthlyLiabilityButton = d('add-monthly-liability-button');
cancelEditMonthlyLiabilityButton = d('cancel-edit-monthly-liability-button');
monthlyLiabilityMessage = d('monthly-liability-message');
monthlyLiabilitiesList = d('monthly-liabilities-list');
monthlyLiabilityFormTitle = d('monthly-liability-form-title');
                 mainNav = d("main-nav");
                 contentSections = document.querySelectorAll(".content-section");
                 navButtons = document.querySelectorAll(".nav-button");
                 globalMessage = d("global-message");
                 currentDataDateDisplay = d("current-data-date");
                 currentTimeDisplay = d("current-time");
                 summaryLiquidity = d("summary-current-liquidity");
                 summaryInventory = d("summary-total-inventory-value");
                 summaryConsignment = d("summary-consignment-value-display");
                 summaryDebts = d("summary-total-debts-display");
                 summaryLiabilities = d("summary-total-liabilities-display");
                 summaryExpenses = d("summary-total-expenses");
                 summaryProfit = d("summary-total-profit");
                 summaryCapital = d("summary-total-capital");
                 productList = d("product-list");
                 addProductButton = d("add-product-button");
                 productNameInput = d("product-name");
                 productQuantityInput = d("product-quantity");
                 productCostPriceInput = d("product-cost-price");
                 productSupplierSelect = d("product-supplier");
                 productDeductLiquidityCheckbox = d("product-deduct-liquidity");
                 serialNumberEntryContainer = d('serial-number-entry-container');
                 productSerialNumbersTextarea = d('product-serial-numbers');
                 serialImportMessage = d('serial-import-message');
                 importSerialCsvInput = d('import-serial-csv-input');
                 productMessage = d("product-message");
                 inventoryTotalInventoryValue = d("inventory-total-inventory-value");
                 inventoryConsignmentValue = d("inventory-consignment-value-display");
                 inventoryTotalProfit = d("inventory-total-profit");
                 cancelEditProductButton = d("cancel-edit-product-button");
                 productFormTitle = d("product-form-title");
                 productNamesDatalist = d("product-names-list");
                 sellProductNameInput = d("sell-product-name");
                 sellCustomerNameInput = d("sell-customer-name");
                 sellQuantityInput = d("sell-quantity");
                 sellPriceInput = d("sell-price");
                 sellButton = d("sell-button");
                 sellMessage = d("sell-message");
                 additionalCostsContainer = d("additional-costs-container");
                 sellPendingCheckbox = d("sell-pending");
                 pendingSalesListContainer = d("pending-sales-list");
                 pendingSalesSearchInput = d('pending-sales-search-input'); // <<< جديد
                 pendingSalesTotalCostSpan = d('pending-sales-total-cost'); // <<< جديد
                 pendingSalesTotalProfitSpan = d('pending-sales-total-profit'); // <<< جديد
                 currentLiquidityDisplay = d("current-liquidity");
                 addLiquidityAmountInput = d("add-liquidity-amount");
                 addLiquiditySourceInput = d("add-liquidity-source");
                 addLiquidityButton = d("add-liquidity-button");
                 removeLiquidityAmountInput = d("remove-liquidity-amount");
                 removeLiquidityReasonInput = d("remove-liquidity-reason");
                 removeLiquidityButton = d("remove-liquidity-button");
                 liquidityMessage = d("liquidity-message");
                 liquidityLogListContainer = d("liquidity-log-list");
                 adjustLiquidityAmountInput = d('adjust-liquidity-amount'); // <<< جديد
                 adjustLiquidityReasonInput = d('adjust-liquidity-reason'); // <<< جديد
                 adjustLiquidityButton = d('adjust-liquidity-button'); // <<< جديد
                 adjustLiquidityMessage = d('adjust-liquidity-message'); // <<< جديد
                 totalExpensesDisplay = d("total-expenses");
                 addExpenseInput = d("add-expense");
                 addExpenseButton = d("add-expense-button");
                 removeExpenseInput = d("remove-expense");
                 removeExpenseButton = d("remove-expense-button");
                 expensesMessage = d("expenses-message");
                 totalDebtsDisplay = d("total-debts-display");
                 debtorNameInput = d("debtor-name");
                 addDebtReasonInput = d("add-debt-reason");
                 addDebtAmountInput = d("add-debt-amount");
                 debtDeductLiquidityCheckbox = d("debt-deduct-liquidity");
                 addDebtButton = d("add-debt-button");
                 paymentDebtorSelect = d("payment-debtor-select");
                 paymentAmountInput = d("payment-amount");
                 receivePaymentButton = d("receive-payment-button");
                 debtsMessage = d("debts-message");
                 debtorsListContainer = d("debtors-list");
                 totalLiabilitiesDisplay = d("total-liabilities-display");
                 creditorNameInput = d("creditor-name");
                 addLiabilityAmountInput = d("add-liability-amount");
                 liabilityReceivedCashCheckbox = d("liability-received-cash");
                 addLiabilityButton = d("add-liability-button");
                 paymentCreditorSelect = d("payment-creditor-name");
                 liabilityPaymentAmountInput = d("liability-payment-amount");
                 payLiabilityButton = d("pay-liability-button");
                 liabilitiesMessage = d("liabilities-message");
                 liabilitiesListContainer = d("liabilities-list");
                 offsetDebtorNameInput = d("offset-debtor-name");
                 offsetCreditorNameInput = d("offset-creditor-name");
                 offsetAmountInput = d("offset-amount-input");
                 performTwoPartyOffsetButton = d("perform-two-party-offset-button");
                 offsetMessage = d("offset-message");
                 reportMonthYearInput = d("report-month-year");
                 generateReportButton = d("generate-report-button");
                 reportMessage = d("report-message");
                 salesReportTableBody = d("sales-report-table-body");
                 reportTotalSales = d("report-total-sales");
                 reportTotalCost = d("report-total-cost");
                 reportTotalProfit = d("report-total-profit");
                 operationLogList = d("operation-log-list");
                 clearLogButton = d("clear-log-button");
                 saveButtonAlt = d("save-button-alt");
                 loadDateInputAlt = d("load-date-alt");
                 loadDataButtonAlt = d("load-data-button-alt");
                 loadMessageAlt = d("load-message-alt");
                 loadDateDayNameDisplayAlt = d("load-date-day-name-alt");
                 printButtonAlt = d("print-button-alt");
                 resetButtonAlt = d("reset-button-alt");
                 exportDataButton = d("export-data-button");
                 importFileInput = d("import-file-input");
                 importMessage = d("import-message");
                 supplierNameInput = d("supplier-name");
                 supplierContactInput = d("supplier-contact");
                 supplierAddressInput = d("supplier-address");
                 addSupplierButton = d("add-supplier-button");
                 cancelEditSupplierButton = d("cancel-edit-supplier-button");
                 supplierMessage = d("supplier-message");
                 supplierList = d("supplier-list");
                 supplierFormTitle = d("supplier-form-title");
                 supplierNamesDatalist = d('supplier-names-list');
                 searchSupplierSerialNameInput = d('search-supplier-serial-name');
                 searchSupplierSerialsBtn = d('search-supplier-serials-btn');
                 serialSearchMessage = d('serial-search-message');
                 supplierSerialsResultsContainer = d('supplier-serials-results');
                 filterSerialsContainer = d('filter-serials-container'); // **** إسناد حاوية فلتر السيريالات ****
                 filterSerialsInput = d('filter-serials-input'); // **** إسناد حقل فلتر السيريالات ****
                 inv_modal = d('invoiceModal');
                 inv_openInvoiceModalBtn = d('openInvoiceModalBtn');
                 inv_closeBtn = inv_modal ? inv_modal.querySelector('.modal-close-btn') : null; // Use generic class
                 inv_closeBtnFooter = inv_modal ? inv_modal.querySelector('.modal-close-btn-footer') : null; // Use generic class
                 inv_invoiceForm = d('invoiceForm');
                 inv_customerNameInput = d('inv_customerName');
                 inv_customerAddressInput = d('inv_customerAddress');
                 inv_phoneNumbersContainer = d('inv_phoneNumbersContainer');
                 inv_addPhoneBtn = d('inv_addPhoneBtn');
                 inv_shippingCostInput = d('inv_shippingCost');
                 inv_totalShippingCostSpan = d('inv_totalShippingCost');
                 inv_totalGoodsPriceSpan = d('inv_totalGoodsPrice');
                 inv_grandTotalPriceSpan = d('inv_grandTotalPrice');
                 inv_validationErrorDiv = d('inv_validationError');
                 inv_itemNameInput = d('inv_itemName');
                 inv_itemQtyInput = d('inv_itemQty');
                 inv_itemPriceInput = d('inv_itemPrice');
                 inv_addItemBtn = d('inv_addItemBtn');
                 inv_itemAddErrorDiv = d('inv_itemAddError');
                 inv_invoiceItemsBody = d('inv_invoiceItemsBody');
                 inv_printInvoiceBtn = d('inv_printInvoiceBtn');
                 inv_deductibleCostsContainer = d('inv_deductibleCostsContainer');
                 inv_warrantyInput = d('inv_warranty');
                 inv_notesTextarea = d('inv_notes');
                 inv_saveInvoiceBtn = d('inv_saveInvoiceBtn');
                 inv_serialSelectContainer = d('inv_serialSelectContainer');
                 inv_itemSerialSelect = d('inv_itemSerialSelect');
                 inv_serialSearchInput = d('inv_serialSearchInput');
                 // **** إسناد عناصر نافذة إدارة السيريالات ****
                 manageSerialsModal = d('manageSerialsModal');
                 modal_productNameDisplay = d('modal_productNameDisplay');
                 modal_serialCounts = d('modal_serialCounts');
                 modal_totalQuantity = d('modal_totalQuantity');
                 modal_registeredCount = d('modal_registeredCount');
                 modal_unregisteredCount = d('modal_unregisteredCount');
                 modal_productSerialNumbers = d('modal_productSerialNumbers');
                 modal_maxSerialsToAdd = d('modal_maxSerialsToAdd');
                 modal_serialImportMessage = d('modal-serial-import-message');
                 modal_importSerialCsvInput = d('modal-import-serial-csv-input');
                 modal_registeredSerialsList = d('modal-registered-serials-list');
                 modal_saveAddedSerialsBtn = d('modal_saveAddedSerialsBtn');
                 modal_closeBtns = manageSerialsModal ? manageSerialsModal.querySelectorAll('.modal-close-btn, .modal-close-btn-footer') : [];

                 debtorNamesDatalistOffset = d('debtor-names-list-offset');
                 creditorNamesDatalistOffset = d('creditor-names-list-offset');
                  // Invoice Search Elements References
                  searchInvoiceNumberInput = d('search-invoice-number');
                  searchByNumberBtn = d('search-by-number-btn');
                  searchCustomerNameInput = d('search-customer-name');
                  searchByNameBtn = d('search-by-name-btn');
                  searchMessageContainer = d('search-message');
                  searchResultsListContainer = d('search-results-list');
                  // --- Financial Center (FC) Elements ---
fc_main_tabs = d('fc-main-tabs');
fc_tab_buttons = document.querySelectorAll('.fc-tab-button');
fc_tab_contents = document.querySelectorAll('.fc-tab-content');
fc_month_select = d('fc-distribution-month');
fc_expenses_list = d('fc-expenses-to-distribute-list');
fc_products_list = d('fc-products-to-load-list');
fc_total_expenses_display = d('fc-total-selected-expenses');
fc_preview_container = d('fc-cost-preview-container');
fc_preview_results = d('fc-cost-preview-results');
fc_manual_container = d('fc-manual-distribution-container');
fc_manual_list = d('fc-manual-percentage-list');
fc_percentage_feedback = d('fc-percentage-total-feedback');
fc_percentage_total = d('fc-percentage-total');
fc_expenses_wrapper = d('fc-expenses-selection-wrapper');
fc_manual_cost_wrapper = d('fc-manual-cost-input-wrapper');
fc_manual_cost_input = d('fc-manual-cost-input');
fc_debt_select = d('fc-debt-to-process');
fc_execute_dist_btn = d('fc-execute-distribution-btn');
fc_execute_debt_btn = d('fc-execute-debt-treatment-btn');

    // ربط مستمعات الأحداث (event listeners)
    // ... ضع كل addEventListener هنا ...
    // مثال: if (saveButtonAlt) { saveButtonAlt.addEventListener(...); }
     // --- Attach Event Listeners ---
                 // Monthly Liabilities Listeners
if (addMonthlyLiabilityButton) { addMonthlyLiabilityButton.addEventListener('click', addOrUpdateMonthlyLiability); }
if (cancelEditMonthlyLiabilityButton) { cancelEditMonthlyLiabilityButton.addEventListener('click', resetMonthlyLiabilityForm); }
if (monthlyLiabilitiesList) {
    monthlyLiabilitiesList.addEventListener('click', (e) => {
        const target = e.target.closest('button');
        if (!target) return;
        const liabilityId = target.dataset.id;
        if (!liabilityId) return;

        if (target.classList.contains('edit-monthly-liability-btn')) {
            const liability = monthlyLiabilities.find(l => l.id === liabilityId);
            if (liability) {
                editingMonthlyLiabilityId = liability.id;
                monthlyLiabilityNameInput.value = liability.name;
                monthlyLiabilityAmountInput.value = liability.amount;
                monthlyLiabilityFormTitle.textContent = `تعديل: ${liability.name}`;
                addMonthlyLiabilityButton.textContent = "تحديث";
                cancelEditMonthlyLiabilityButton.classList.remove('hidden');
                d('add-update-monthly-liability-form').scrollIntoView({ behavior: 'smooth' });
            }
        } else if (target.classList.contains('delete-monthly-liability-btn')) {
            const liabilityIndex = monthlyLiabilities.findIndex(l => l.id === liabilityId);
            if (liabilityIndex > -1) {
                 const liabilityName = monthlyLiabilities[liabilityIndex].name;
                 if (confirm(`هل أنت متأكد من حذف الالتزام الشهري "${liabilityName}"؟`)) {
                     monthlyLiabilities.splice(liabilityIndex, 1);
                     logOperation("حذف التزام شهري", `تم حذف الالتزام الشهري الدائم "${liabilityName}".`);
                     showMessage(monthlyLiabilityMessage, `تم حذف "${liabilityName}".`);
                     updateUI();
                 }
            }
        }
    });
}
                 if (mainNav) { mainNav.addEventListener('click', (e) => { if (e.target.tagName === 'BUTTON' && e.target.classList.contains('nav-button')) { const targetId = e.target.dataset.target; contentSections.forEach(section => { section.classList.add('hidden'); }); const targetSection = d(targetId); if (targetSection) { targetSection.classList.remove('hidden'); } navButtons.forEach(button => { button.classList.remove('active'); }); e.target.classList.add('active'); } }); }
                 // --- Financial Center Tabs Listener ---
if (fc_main_tabs) {
    fc_main_tabs.addEventListener('click', (e) => {
        const button = e.target.closest('.fc-tab-button');
        if (!button) return; // إذا لم يتم الضغط على زر، لا تفعل شيئاً

        // 1. أزل علامة "نشط" من كل الأزرار
        fc_tab_buttons.forEach(btn => btn.classList.remove('active'));
        // 2. أضف علامة "نشط" للزر الذي تم الضغط عليه
        button.classList.add('active');

        // 3. أخفِ جميع أقسام المحتوى
        fc_tab_contents.forEach(content => content.classList.add('hidden'));
        
        // 4. أظهر القسم المرتبط بالزر الذي تم الضغط عليه
        const targetId = button.dataset.target;
        const targetContent = d(targetId);
        if (targetContent) {
            targetContent.classList.remove('hidden');
        }

        // 5. قم بتعبئة بيانات القسم الذي تم إظهاره (مهم جداً)
        if (targetId === 'fc-tab-distribution') {
            fc_populate_month_select(); // تعبئة قائمة الشهور
        } else if (targetId === 'fc-tab-debt-treatment') {
            fc_populate_debt_treatment(); // تعبئة قائمة الديون
        }
    });
}

                 // ... داخل دالة initializeApp() مع باقي الـ event listeners

if (d('undo-button')) { d('undo-button').addEventListener('click', undo); }
if (d('redo-button')) { d('redo-button').addEventListener('click', redo); }
                 if (saveButtonAlt) { saveButtonAlt.addEventListener("click", async () => { const loadedDate = currentLoadedDate; const todayString = getTodayDateString(); const targetDate = loadedDate || todayString; const storageKey = lsPrefix + targetDate; const existingData = localStorage.getItem(storageKey); let proceed = true; let confirmMsg = `هل تريد حفظ التغييرات لتاريخ ${formatDateForDisplay(targetDate)}؟`; if (existingData) { if(loadedDate === targetDate) { confirmMsg += `\n(سيتم الكتابة فوق البيانات المحفوظة الحالية لهذا اليوم)`; } else { confirmMsg = `أنت تعرض بيانات تاريخ ${formatDateForDisplay(loadedDate)}. هل تريد حفظ التغييرات الحالية فوق بيانات اليوم ${formatDateForDisplay(targetDate)}؟`; } } // Always confirm if saving over existing or saving to a different date
                      proceed = confirm(confirmMsg); if (proceed) { saveCurrentStateByDate(targetDate); } else { console.log("Save cancelled by user."); } }); }
                 if (loadDataButtonAlt) { loadDataButtonAlt.addEventListener("click", async () => { const dateToLoad = loadDateInputAlt ? loadDateInputAlt.value : null; const loadResult = loadDataForDate(dateToLoad); if(loadResult) updateUI(); }); } // Update UI only if loadDataForDate indicates a change happened
                 if (loadDateInputAlt) { loadDateInputAlt.addEventListener('change', (e) => { const dateValue = e.target.value; updateLoadDateDayName(dateValue, loadDateDayNameDisplayAlt); }); }
                 if (clearLogButton) { clearLogButton.addEventListener("click", () => { if (confirm("هل أنت متأكد من رغبتك في مسح سجل عمليات اليوم الحالي المعروض؟ لن يتم حفظ هذا التغيير إلا بالضغط على زر الحفظ.")) { operationLog = []; updateLogDisplay(); showGlobalMessage("تم مسح سجل اليوم الحالي من العرض. اضغط 'حفظ' لتثبيت التغيير.", false, true); } }); }
                 if (resetButtonAlt) { resetButtonAlt.addEventListener("click", () => { if (confirm("تحذير: سيؤدي هذا إلى مسح جميع البيانات المعروضة حاليًا على الشاشة (لن يتم حذف أي بيانات محفوظة سابقًا). هل أنت متأكد؟")) { resetState(); updateUI(); showGlobalMessage("تم تصفير الواجهة. يمكنك البدء من جديد أو تحميل بيانات تاريخ آخر.", false, true); } }); }
                 if (printButtonAlt) { printButtonAlt.addEventListener("click", () => { document.body.classList.add('print-report'); // Add class for print styling
                      const reportHTML = generateReportHTML(); const printWindow = window.open('', '_blank', 'height=600,width=800'); if (printWindow) { printWindow.document.open(); printWindow.document.write(reportHTML); printWindow.document.close(); setTimeout(() => { try { printWindow.focus(); printWindow.print(); // printWindow.close(); // Optional: close after printing
                      } catch (e) { console.error("Print error:", e); showGlobalMessage("حدث خطأ أثناء محاولة الطباعة.", true); } finally { document.body.classList.remove('print-report'); // Remove class after printing attempt
                      } }, 500); } else { showGlobalMessage('فشل فتح نافذة الطباعة. يرجى السماح بالنوافذ المنبثقة.', true); document.body.classList.remove('print-report'); } }); }
                 if (exportDataButton) { exportDataButton.addEventListener("click", exportData); }
                 if (importFileInput) { importFileInput.addEventListener("change", importData); }
                 // **** جديد: مستمع حدث لزر استيراد CSV للسيريالات (في قسم إضافة البضاعة) ****
                 if (importSerialCsvInput) {
                     importSerialCsvInput.addEventListener("change", (event) => importSerialCSV(event, productSerialNumbersTextarea, serialImportMessage));
                 }
                  // **** جديد: مستمع حدث لزر استيراد CSV للسيريالات (في نافذة الإدارة) ****
                 if (modal_importSerialCsvInput) {
                     modal_importSerialCsvInput.addEventListener("change", (event) => importSerialCSV(event, modal_productSerialNumbers, d('modal-serial-import-message')));
                 }

                 // *** Add Product Button Listener (with Deduct Logic & Optional Serial Handling) ***
                 if (addProductButton) {
                     addProductButton.addEventListener("click", () => {
                         saveStateToHistory();
                         const name = productNameInput.value.trim();
                         const quantity = parseInputNumber(productQuantityInput); // الكمية المدخلة
                         const costPrice = parseInputNumber(productCostPriceInput); // سعر التكلفة المدخل
                         const supplierId = productSupplierSelect.value;
                         const deductLiquidity = productDeductLiquidityCheckbox.checked;
                         const serialNumbersInput = productSerialNumbersTextarea ? productSerialNumbersTextarea.value.trim() : ''; // اقرأ السيريالات

                         if (!name || isNaN(quantity) || quantity < 0 || isNaN(costPrice) || costPrice < 0) {
                             showMessage(productMessage, "يرجى ملء اسم وكمية (>=0) وسعر تكلفة (>=0) المنتج بشكل صحيح.", true);
                             return;
                         }

                        // انسخ هذا الكود بالكامل واستبدل به كتلة if (editingProductName) الموجودة لديك

if (editingProductName) {
    // --- تعديل منتج موجود ---
    const productIndex = products.findIndex(p => p.name === editingProductName);

    if (productIndex === -1) {
        showMessage(productMessage, `خطأ: المنتج "${editingProductName}" غير موجود للتعديل.`, true);
        resetProductForm();
        return;
    }

    // التحقق من أن الاسم الجديد غير مستخدم لمنتج آخر
    const newNameExistsIndex = products.findIndex(p => p.name.toLowerCase() === name.toLowerCase() && p.name !== editingProductName);
    if (newNameExistsIndex !== -1) {
        showMessage(productMessage, `لا يمكن تغيير الاسم إلى "${name}"، الاسم مستخدم لمنتج آخر.`, true);
        return;
    }

    // ====> بداية الكود الجديد لحساب الفروقات <====

    const originalProduct = products[productIndex];
    // حساب التكلفة الإجمالية للمنتج قبل التعديل
    const oldTotalCost = (Number(originalProduct.quantity) || 0) * (Number(originalProduct.costPrice) || 0);
    // حساب التكلفة الإجمالية الجديدة بناءً على القيم المدخلة في النموذج
    const newTotalCost = (Number(quantity) || 0) * (Number(costPrice) || 0);
    // حساب الفرق في القيمة
    const valueDifference = newTotalCost - oldTotalCost;

    // التحقق مما إذا كان المستخدم يريد تحديث السيولة
    if (deductLiquidity && valueDifference !== 0) {
        // إذا زادت قيمة المخزون، يجب خصم الفرق من السيولة
        if (valueDifference > 0) {
            if (valueDifference > liquidity) {
                showMessage(productMessage, `لا توجد سيولة كافية (${formatCurrency(liquidity)}) لخصم الزيادة في قيمة المخزون (${formatCurrency(valueDifference)}).`, true);
                return; // أوقف العملية
            }
            liquidity -= valueDifference;
            logOperation("تعديل سيولة", `خصم ${formatCurrency(valueDifference)} من السيولة بسبب زيادة قيمة مخزون "${name}".`);
            const liqLogEntry = { id: `liq-${Date.now()}`, timestamp: new Date().toISOString(), type: "remove", amount: valueDifference, description: `زيادة قيمة مخزون: ${name}`, currentBalance: liquidity };
            liquidityLog.push(liqLogEntry);
        }
        // إذا قلت قيمة المخزون، يجب إرجاع الفرق إلى السيولة
        else if (valueDifference < 0) {
            const amountToReturn = Math.abs(valueDifference);
            liquidity += amountToReturn;
            logOperation("تعديل سيولة", `إرجاع ${formatCurrency(amountToReturn)} إلى السيولة بسبب نقصان قيمة مخزون "${name}".`);
            const liqLogEntry = { id: `liq-${Date.now()}`, timestamp: new Date().toISOString(), type: "add", amount: amountToReturn, description: `نقصان قيمة مخزون: ${name}`, currentBalance: liquidity };
            liquidityLog.push(liqLogEntry);
        }
    }

    // ====> نهاية الكود الجديد لحساب الفروقات <====


    // الآن قم بتحديث بيانات المنتج بالقيم الجديدة
    originalProduct.name = name;
    originalProduct.quantity = quantity;
    originalProduct.costPrice = costPrice;
    originalProduct.supplierId = supplierId;

    showMessage(productMessage, `تم تحديث المنتج "${name}" بنجاح.`);
    resetProductForm();

} else {
                             // --- Add New Quantity or New Product ---
                             const existingIndex = products.findIndex(p => p.name.toLowerCase() === name.toLowerCase());
                             let newQuantity = Number(quantity); // الكمية المضافة فعلاً
                             let serials = [];

                             // **** تعديل التحقق من السيريالات (جعله اختيارياً) ****
                             if (newQuantity > 0 && !serialNumberEntryContainer.classList.contains('hidden') && serialNumbersInput) {
                                 // إذا كان الحقل ظاهراً وبه نص، قم بالتحقق
                                 const cleanedInput = serialNumbersInput.replace(/[,;\s\t]+/g, '\n');
                                 serials = cleanedInput.split('\n').map(s => s.trim()).filter(s => s !== '');

                                 if (serials.length !== newQuantity) {
                                     showMessage(productMessage, `عدد الأرقام التسلسلية المكتشفة (${serials.length}) لا يتطابق مع الكمية المضافة (${newQuantity}).<br>إذا كنت لا تريد إدخال سيريالات، اترك الحقل فارغاً.`, true);
                                     return;
                                 }
                                 // التحقق من التكرار
                                 const duplicateCheck = new Set();
                                 for (const serial of serials) {
                                     if (duplicateCheck.has(serial)) {
                                         showMessage(productMessage, `الرقم التسلسلي "${serial}" مكرر في المدخلات.`, true);
                                         return;
                                     }
                                     if (serialNumbersLog.some(log => log.serial === serial)) {
                                         showMessage(productMessage, `الرقم التسلسلي "${serial}" مسجل بالفعل في النظام.`, true);
                                         return;
                                     }
                                     duplicateCheck.add(serial);
                                 }
                             } else if (newQuantity > 0 && !serialNumberEntryContainer.classList.contains('hidden') && !serialNumbersInput) {
                                 // الحقل ظاهر لكن فارغ - هذا يعني أن المستخدم لا يريد إدخال سيريالات (وهو مسموح الآن)
                                 console.log("Serial number input is visible but empty. Proceeding without serials.");
                                 serials = []; // تأكد أنها فارغة
                             } else {
                                 // الكمية صفر أو الحقل مخفي
                                 serials = [];
                             }
                             // **** انتهى التحقق من السيريالات ****


                             if (existingIndex !== -1) {
                                 // --- Add Quantity to Existing ---
                                 if (newQuantity <= 0) { showMessage(productMessage, "الكمية المضافة يجب أن تكون أكبر من صفر.", true); return; } // تحقق مرة أخرى هنا خصيصاً للإضافة
                                 const existing = products[existingIndex];
                                 const oldQuantity = Number(existing.quantity) || 0;
                                 const oldCostPrice = Number(existing.costPrice) || 0;
                                 const newCostPriceInput = Number(costPrice); // سعر تكلفة الكمية المضافة
                                 const totalQuantity = oldQuantity + newQuantity;

                                 // **** ابدأ منطق الخصم ****
                                 let costToDeduct = 0;
                                 let deductionDone = false; // Flag لتتبع ما إذا تم الخصم
                                 if (deductLiquidity && newQuantity > 0) {
                                     costToDeduct = newQuantity * newCostPriceInput;
                                     if (costToDeduct > liquidity) {
                                         showMessage(productMessage, `لا توجد سيولة كافية (${formatCurrency(liquidity)}) لخصم تكلفة الإضافة (${formatCurrency(costToDeduct)}). لم تتم الإضافة.`, true);
                                         return; // أوقف العملية بالكامل
                                     }
                                     // إذا وصلنا هنا، يمكن الخصم
                                     liquidity -= costToDeduct;
                                     const liqLogEntry = {
                                         id: `liq-${Date.now()}`,
                                         timestamp: new Date().toISOString(),
                                         type: "remove",
                                         amount: costToDeduct,
                                         description: `شراء بضاعة: ${newQuantity}x ${name}`,
                                         currentBalance: liquidity
                                     };
                                     liquidityLog.push(liqLogEntry);
                                     deductionDone = true; // علم أنه تم الخصم
                                 }
                                 // **** انتهى منطق الخصم ****

                                 // حساب متوسط التكلفة الجديد (يبقى كما هو)
                                 let newAverageCost = oldCostPrice;
                                 if (totalQuantity > 0) {
                                     const oldTotalValue = oldQuantity * oldCostPrice;
                                     const newTotalValue = newQuantity * newCostPriceInput;
                                     newAverageCost = (oldTotalValue + newTotalValue) / totalQuantity;
                                 } else {
                                     newAverageCost = newCostPriceInput; // إذا كانت الكمية القديمة 0
                                 }

                                 // تحديث المنتج الموجود
                                 existing.quantity = totalQuantity;
                                 existing.costPrice = newAverageCost;
                                 existing.supplierId = supplierId || existing.supplierId; // حافظ على المورد القديم إذا لم يتم اختيار جديد
                                 const supplierName = suppliers.find(s => s.id === existing.supplierId)?.name || '-';

                                 // **** إضافة السيريالات الجديدة للسجل (إذا تم إدخالها) ****
                                 if (serials.length > 0) {
                                     const timestamp = new Date().toISOString();
                                     serials.forEach(serial => {
                                         serialNumbersLog.push({
                                             serial: serial,
                                             productName: name,
                                             supplierId: existing.supplierId, // استخدم المورد المحدد أو القديم
                                             addedTimestamp: timestamp,
                                             status: "in_stock" // الحالة الافتراضية عند الإضافة
                                         });
                                     });
                                 }
                                 // **** نهاية إضافة السيريالات ****

                                 let logDetails = `تحديث مخزون: إضافة ${newQuantity} من '${name}'. الكمية الإجمالية: ${totalQuantity}. التكلفة المتوسطة المحدثة: ${formatCurrency(newAverageCost)}. المورد: ${supplierName}.`;
                                 if (serials.length > 0) logDetails += ` تم تسجيل ${serials.length} رقم تسلسلي.`;
                                 if (deductionDone) logDetails += ` تم خصم ${formatCurrency(costToDeduct)} من السيولة.`;
                                 logOperation("تحديث مخزون", logDetails);
                                 showMessage(productMessage, `تم تحديث المنتج "${name}". متوسط التكلفة الجديد: ${formatCurrency(newAverageCost)}`);


                             } else {
                                 // --- Add New Product ---
                                 if (newQuantity <= 0) { showMessage(productMessage, "كمية المنتج الجديد يجب أن تكون أكبر من صفر.", true); return; } // تحقق مرة أخرى هنا خصيصاً للإضافة

                                 const newCostPriceInput = Number(costPrice); // سعر تكلفة الكمية المضافة

                                 // **** ابدأ منطق الخصم ****
                                 let costToDeduct = 0;
                                 let deductionDone = false;
                                 if (deductLiquidity && newQuantity > 0) {
                                     costToDeduct = newQuantity * newCostPriceInput;
                                     if (costToDeduct > liquidity) {
                                         showMessage(productMessage, `لا توجد سيولة كافية (${formatCurrency(liquidity)}) لخصم تكلفة الإضافة (${formatCurrency(costToDeduct)}). لم تتم الإضافة.`, true);
                                         return; // أوقف العملية بالكامل
                                     }
                                     liquidity -= costToDeduct;
                                     const liqLogEntry = {
                                         id: `liq-${Date.now()}`,
                                         timestamp: new Date().toISOString(),
                                         type: "remove",
                                         amount: costToDeduct,
                                         description: `شراء بضاعة جديدة: ${newQuantity}x ${name}`,
                                         currentBalance: liquidity
                                     };
                                     liquidityLog.push(liqLogEntry);
                                     deductionDone = true;
                                 }
                                 // **** انتهى منطق الخصم ****

                                 const newProduct = { name, quantity: newQuantity, costPrice: newCostPriceInput, supplierId: supplierId || "" };
                                 products.push(newProduct);
                                 const supplierName = suppliers.find(s => s.id === supplierId)?.name || '-';

                                 // **** إضافة السيريالات الجديدة للسجل (إذا تم إدخالها) ****
                                  if (serials.length > 0) {
                                     const timestamp = new Date().toISOString();
                                     serials.forEach(serial => {
                                         serialNumbersLog.push({
                                             serial: serial,
                                             productName: name,
                                             supplierId: newProduct.supplierId,
                                             addedTimestamp: timestamp,
                                             status: "in_stock" // الحالة الافتراضية عند الإضافة
                                         });
                                     });
                                 }
                                 // **** نهاية إضافة السيريالات ****

                                 let logDetails = `إضافة بضاعة: إضافة منتج جديد ${newQuantity} من '${name}' بسعر تكلفة ${formatCurrency(newCostPriceInput)}. المورد: ${supplierName}`;
                                 if (serials.length > 0) logDetails += `. تم تسجيل ${serials.length} رقم تسلسلي.`;
                                 if (deductionDone) logDetails += `. تم خصم ${formatCurrency(costToDeduct)} من السيولة.`;
                                 logOperation("إضافة بضاعة", logDetails);
                                 showMessage(productMessage, "تمت إضافة المنتج الجديد بنجاح.");
                             }
                             // Clear form
                             resetProductForm(); // سيقوم بإخفاء حقل السيريال أيضاً
                             productNameInput.focus();
                         }
                         updateUI();
                     });
                 }
                 // *** End Add Product Button Listener ***

                 // **** مستمع حدث حقل الكمية لإظهار/إخفاء حقل السيريال ****
                 if (productQuantityInput && serialNumberEntryContainer) {
                     productQuantityInput.addEventListener('input', () => {
                         const quantity = parseInputNumber(productQuantityInput);
                         // أظهر حقل السيريال فقط عند إضافة كمية جديدة (ليس في وضع التعديل وليس كمية صفر)
                         if (!editingProductName && !isNaN(quantity) && quantity > 0) {
                             serialNumberEntryContainer.classList.remove('hidden');
                         } else {
                             serialNumberEntryContainer.classList.add('hidden');
                             if(productSerialNumbersTextarea) productSerialNumbersTextarea.value = ''; // أفرغ الحقل عند إخفائه
                             if(serialImportMessage) showMessage(serialImportMessage, ''); // امسح رسالة الاستيراد
                         }
                     });
                     // قم بإخفائه أيضاً عند إلغاء التعديل
                     if(cancelEditProductButton) {
                         cancelEditProductButton.addEventListener('click', () => {
                              serialNumberEntryContainer.classList.add('hidden');
                              if(productSerialNumbersTextarea) productSerialNumbersTextarea.value = '';
                              if(serialImportMessage) showMessage(serialImportMessage, '');
                         });
                     }
                 }

                 if (cancelEditProductButton) { cancelEditProductButton.addEventListener('click', resetProductForm); }
                 if (productList) {
                     productList.addEventListener('click', (e) => {
                         const target = e.target.closest('button');
                         if (!target) return;
                         const productName = target.dataset.productName;
                         if (!productName) return;

                         if (target.classList.contains('edit-product-btn')) {
                             const productToEdit = products.find(p => p.name === productName);
                             if (productToEdit && productNameInput && productQuantityInput && productCostPriceInput && productSupplierSelect && addProductButton && productFormTitle && cancelEditProductButton) {
                                 editingProductName = productName;
                                 productNameInput.value = productToEdit.name;
                                 productQuantityInput.value = productToEdit.quantity;
                                 productCostPriceInput.value = productToEdit.costPrice;
                                 productSupplierSelect.value = productToEdit.supplierId || "";
                                 addProductButton.textContent = "تحديث المنتج";
                                 addProductButton.classList.remove('bg-green-500', 'hover:bg-green-600');
                                 addProductButton.classList.add('bg-blue-500', 'hover:bg-blue-600');
                                 productFormTitle.textContent = `تعديل المنتج: ${productName}`;
                                 cancelEditProductButton.classList.remove('hidden');
                                 serialNumberEntryContainer.classList.add('hidden'); // Ensure serial field is hidden during edit mode
                                 if(productSerialNumbersTextarea) productSerialNumbersTextarea.value = '';
                                 d('add-update-product-form').scrollIntoView({ behavior: 'smooth' });
                             } else {
                                 showMessage(productMessage, `لم يتم العثور على المنتج "${productName}" للتعديل أو عناصر النموذج غير جاهزة.`, true);
                             }
                         } else if (target.classList.contains('delete-product-btn')) {
                             if (confirm(`هل أنت متأكد من حذف المنتج "${productName}"؟ سيتم حذف جميع الأرقام التسلسلية المرتبطة به أيضاً.`)) {
                                 saveStateToHistory();
                                 const initialLength = products.length;
                                 products = products.filter(p => p.name !== productName);
                                 // **** حذف السيريالات المرتبطة بالمنتج المحذوف ****
                                 const initialSerialCount = serialNumbersLog.length;
                                 serialNumbersLog = serialNumbersLog.filter(log => log.productName !== productName);
                                 const deletedSerialCount = initialSerialCount - serialNumbersLog.length;
                                 if (products.length < initialLength) {
                                     logOperation("حذف منتج", `تم حذف المنتج "${productName}". تم حذف ${deletedSerialCount} رقم تسلسلي مرتبط.`);
                                     showMessage(productMessage, `تم حذف المنتج "${productName}" و ${deletedSerialCount} رقم تسلسلي مرتبط بنجاح.`);
                                     if (editingProductName === productName) { resetProductForm(); }
                                     updateUI();
                                 }
                             }
                         } else if (target.classList.contains('manage-serials-btn')) { // **** جديد: التعامل مع زر إدارة السيريالات ****
                             openManageSerialsModal(productName);
                         }
                     });
                 }
                 if (sellButton) { sellButton.addEventListener("click", () => {saveStateToHistory(); 
                    const isPendingSale = sellPendingCheckbox.checked; const mainProductName = sellProductNameInput.value.trim(); const customerName = d("sell-customer-name").value.trim(); const quantitySold = parseInputNumber(sellQuantityInput); const totalSellPrice = parseInputNumber(sellPriceInput); if (!mainProductName || isNaN(quantitySold) || quantitySold <= 0 || isNaN(totalSellPrice) || (totalSellPrice < 0 && !isPendingSale) ) { showMessage(sellMessage, "يرجى ملء اسم المنتج والكمية (>0) وسعر البيع (>=0) بشكل صحيح.", true); return; } const mainProductIndex = products.findIndex(p => p.name === mainProductName); if (mainProductIndex === -1) { showMessage(sellMessage, `المنتج الرئيسي "${mainProductName}" غير موجود بالمخزون.`, true); return; } const mainProduct = { ...products[mainProductIndex] }; // Clone product data
                      if (mainProduct.quantity < quantitySold) { showMessage(sellMessage, `الكمية المطلوبة (${quantitySold}) من "${mainProductName}" غير متوفرة (المتاح: ${mainProduct.quantity}).`, true); return; } let costOfGoodsSold = (Number(mainProduct.costPrice) || 0) * quantitySold; let additionalItemsDataForPending = []; let additionalItemsToUpdateIndices = []; let additionalItemsLog = []; const additionalCheckboxes = additionalCostsContainer ? additionalCostsContainer.querySelectorAll('input[type="checkbox"]:checked') : []; let possible = true; // Check stock for additional items
                     // ألصق هذا الكود الجديد مكانه
additionalCheckboxes.forEach(checkbox => {
    if (!possible) return;

    const parentLabel = checkbox.closest('label');
    const quantityInput = parentLabel.querySelector('.additional-item-quantity');
    const qtyToDeduct = parseInt(quantityInput.value) || 0; // يقرأ الكمية من الحقل الجديد

    const additionalProductName = checkbox.value;
    const additionalProductIndex = products.findIndex(p => p.name === additionalProductName);

    if (qtyToDeduct > 0 && additionalProductIndex !== -1) {
        const additionalProduct = products[additionalProductIndex];
        if (additionalProduct.quantity < qtyToDeduct) { // يستخدم الكمية الجديدة في التحقق
            showMessage(sellMessage, `الكمية المطلوبة (${qtyToDeduct}) للمرفق "${additionalProductName}" غير متوفرة (المتاح: ${additionalProduct.quantity}).`, true);
            possible = false;
        } else {
            costOfGoodsSold += (Number(additionalProduct.costPrice) || 0) * qtyToDeduct; 
            additionalItemsDataForPending.push({ name: additionalProduct.name, quantity: qtyToDeduct, costPrice: additionalProduct.costPrice, supplierId: additionalProduct.supplierId });
            additionalItemsToUpdateIndices.push({ index: additionalProductIndex, quantity: qtyToDeduct });
            additionalItemsLog.push(`${qtyToDeduct}x ${additionalProductName}`);
        }
    }
}); if (!possible) return; const potentialProfit = totalSellPrice - costOfGoodsSold; // --- Update Stock ---
                      products[mainProductIndex].quantity -= quantitySold; additionalItemsToUpdateIndices.forEach(item => {
    const productToUpdate = products[item.index];
    if (productToUpdate) {
        productToUpdate.quantity -= item.quantity; // <-- أصبح يخصم الكمية الصحيحة لكل مرفق
    }
}); products = products.filter(p => (Number(p.quantity) || 0) > 0.001); // Remove zero-quantity products

                       // **** تحديث حالة السيريالات المباعة (بيع سريع/مؤقت) ****
                       // حالياً، البيع السريع/المؤقت لا يحدد سيريال معين
                       // يمكن لاحقاً إضافة منطق لاختيار سيريال عشوائي من المتوفرين وتغيير حالته
                       // أو ببساطة لا يتم تغيير حالة السيريال في هذه الحالة

                      // --- Handle Sale Type ---
                      if (!isPendingSale) { // --- Normal Quick Sale ---
                           totalProfit += potentialProfit; liquidity += totalSellPrice; let logDetails = `بيع سريع لـ ${quantitySold}x "${mainProductName}"`; if (additionalItemsLog.length > 0) { logDetails += ` مع (${additionalItemsLog.join(', ')})`; } if (customerName) { logDetails += ` للعميل: ${customerName}`; } logDetails += ` بسعر إجمالي ${formatCurrency(totalSellPrice)}. التكلفة الإجمالية: ${formatCurrency(costOfGoodsSold)}. الربح: ${formatCurrency(potentialProfit)}.`; logOperation("بيع عادي (سريع)", logDetails); const saleRecord = { id: `sale-${Date.now()}`, type: 'quick', timestamp: new Date().toISOString(), customerName: customerName || null, items: [ // Store items involved
                               { name: mainProduct.name, quantity: quantitySold, costPrice: mainProduct.costPrice }, ...additionalItemsDataForPending ], totalSellPrice: totalSellPrice, totalCost: costOfGoodsSold, profit: potentialProfit }; salesToday.push(saleRecord); const liqLogEntry = { id: `liq-${Date.now()}`, timestamp: new Date().toISOString(), type: "add", amount: totalSellPrice, description: `بيع سريع لـ ${customerName || 'عميل'}`, currentBalance: liquidity }; liquidityLog.push(liqLogEntry); showMessage(sellMessage, `تمت عملية البيع السريع بنجاح. الربح: ${formatCurrency(potentialProfit)}`); } else { // --- Pending Sale ---
                           goodsOnConsignmentValue += costOfGoodsSold; // Add cost to consignment value
                           const pendingSaleData = { id: `pending-${Date.now()}-${Math.random().toString(36).substring(2, 7)}`, timestamp: new Date().toISOString(), customerName: customerName || null, mainProduct: { name: mainProduct.name, quantity: quantitySold, costPrice: mainProduct.costPrice, supplierId: mainProduct.supplierId }, additionalItems: additionalItemsDataForPending, totalSellPrice: totalSellPrice, potentialProfit: potentialProfit, status: 'pending' }; pendingSales.push(pendingSaleData); let logDetails = `تسجيل بيع مؤقت لـ ${quantitySold}x "${mainProductName}"`; if (additionalItemsLog.length > 0) { logDetails += ` مع (${additionalItemsLog.join(', ')})`; } if (customerName) { logDetails += ` للعميل: ${customerName}`; } logDetails += `. التكلفة: ${formatCurrency(costOfGoodsSold)}. السعر المتوقع: ${formatCurrency(totalSellPrice)}.`; logOperation("بيع مؤقت", logDetails); showMessage(sellMessage, "تم تسجيل البيع كعملية مؤقتة."); } updateUI(); sellProductNameInput.value = ""; d("sell-customer-name").value = ""; sellQuantityInput.value = "1"; sellPriceInput.value = "0"; sellPendingCheckbox.checked = false; if(additionalCostsContainer) additionalCostsContainer.innerHTML = '<p class="text-center text-gray-500 text-sm">أدخل اسم المنتج الرئيسي لعرض المرفقات المتاحة.</p>'; }); }
                 if(sellProductNameInput) { // Update checkboxes when main product changes
                     sellProductNameInput.addEventListener('input', updateAdditionalCostsCheckboxes); sellProductNameInput.addEventListener('change', updateAdditionalCostsCheckboxes); }
                 // <<< جديد: مستمع حدث لبحث المبيعات المؤقتة >>>
                 if(pendingSalesSearchInput) {
                    pendingSalesSearchInput.addEventListener('input', updatePendingSalesDisplay);
                 }
                 if(pendingSalesListContainer) { // Use event delegation for pending sale buttons
                     pendingSalesListContainer.addEventListener('click', handlePendingSaleActions); }
                 if (addLiquidityButton) { addLiquidityButton.addEventListener("click", () => {saveStateToHistory();
                     const amount = parseInputNumber(addLiquidityAmountInput); const source = addLiquiditySourceInput.value.trim(); if (isNaN(amount) || amount <= 0) { showMessage(liquidityMessage, "يرجى إدخال مبلغ صحيح (> 0) للإضافة.", true); return; } if (!source) { showMessage(liquidityMessage, "يرجى إدخال مصدر السيولة.", true); return; } liquidity += amount; const logEntry = { id: `liq-${Date.now()}`, timestamp: new Date().toISOString(), type: "add", amount: amount, description: source, currentBalance: liquidity }; liquidityLog.push(logEntry); logOperation("إضافة سيولة", `إضافة ${formatCurrency(amount)} من "${source}". الرصيد الحالي: ${formatCurrency(liquidity)}`); updateUI(); addLiquidityAmountInput.value = "0"; addLiquiditySourceInput.value = ""; addLiquiditySourceInput.focus(); // Focus source for next entry
                     showMessage(liquidityMessage, `تمت إضافة ${formatCurrency(amount)} من "${source}".`); }); }
                 if (removeLiquidityButton) { removeLiquidityButton.addEventListener("click", () => {
                    saveStateToHistory();
                     const amount = parseInputNumber(removeLiquidityAmountInput); const reason = removeLiquidityReasonInput.value.trim(); if (isNaN(amount) || amount <= 0) { showMessage(liquidityMessage, "يرجى إدخال مبلغ صحيح (> 0) للسحب.", true); return; } if (!reason) { showMessage(liquidityMessage, "يرجى إدخال سبب السحب.", true); return; } if (amount > liquidity) { showMessage(liquidityMessage, `المبلغ المطلوب (${formatCurrency(amount)}) أكبر من السيولة المتاحة (${formatCurrency(liquidity)}).`, true); return; } liquidity -= amount; const logEntry = { id: `liq-${Date.now()}`, timestamp: new Date().toISOString(), type: "remove", amount: amount, description: reason, currentBalance: liquidity }; liquidityLog.push(logEntry); logOperation("سحب سيولة", `سحب ${formatCurrency(amount)} بسبب "${reason}". الرصيد الحالي: ${formatCurrency(liquidity)}`); updateUI(); removeLiquidityAmountInput.value = "0"; removeLiquidityReasonInput.value = ""; removeLiquidityReasonInput.focus(); showMessage(liquidityMessage, `تم سحب ${formatCurrency(amount)} بسبب "${reason}".`); }); }
                 // <<< جديد: مستمع حدث لزر تعديل السيولة >>>
                if (adjustLiquidityButton) {
    adjustLiquidityButton.addEventListener('click', () => {
        saveStateToHistory(); // <-- أضف هذا السطر
        adjustLiquidityManually();
    });
}
                 if (addExpenseButton) { addExpenseButton.addEventListener("click", () => {saveStateToHistory();
                     const amount = parseInputNumber(addExpenseInput); if (isNaN(amount) || amount <= 0) { showMessage(expensesMessage, "يرجى إدخال مبلغ مصروف صحيح (> 0).", true); return; } if (amount > liquidity) { showMessage(expensesMessage, `مبلغ المصروف (${formatCurrency(amount)}) أكبر من السيولة المتاحة (${formatCurrency(liquidity)}).`, true); return; } expenses += amount; liquidity -= amount; logOperation("تسجيل مصروف", `تسجيل مصروف بقيمة ${formatCurrency(amount)}. تم خصمه من السيولة (الحالية: ${formatCurrency(liquidity)}).`); const liqLogEntry = { id: `liq-${Date.now()}`, timestamp: new Date().toISOString(), type: "remove", amount: amount, description: `مصروف (${formatCurrency(amount)})`, currentBalance: liquidity }; liquidityLog.push(liqLogEntry); updateUI(); addExpenseInput.value = "0"; showMessage(expensesMessage, `تم تسجيل مصروف ${formatCurrency(amount)}.`); }); }
                 if (removeExpenseButton) { removeExpenseButton.addEventListener("click", () => {saveStateToHistory();
                     const amount = parseInputNumber(removeExpenseInput); if (!isNaN(amount) && amount > 0) { if (amount <= expenses) { expenses -= amount; liquidity += amount; logOperation("تقليل مصروف", `تقليل المصروفات بقيمة ${formatCurrency(amount)}. تم إرجاعه للسيولة.`); const liqLogEntry = { id: `liq-${Date.now()}`, timestamp: new Date().toISOString(), type: "add", amount: amount, description: `إلغاء/تقليل مصروف (${formatCurrency(amount)})`, currentBalance: liquidity }; liquidityLog.push(liqLogEntry); updateUI(); removeExpenseInput.value = "0"; showMessage(expensesMessage, `تم تقليل المصروفات بمقدار ${formatCurrency(amount)}.`); } else { showMessage(expensesMessage, `المبلغ (${formatCurrency(amount)}) أكبر من إجمالي المصروفات (${formatCurrency(expenses)}).`, true); } } else { showMessage(expensesMessage, "أدخل مبلغ صحيح (> 0) للتقليل.", true); } }); }
                 if (addDebtButton) { addDebtButton.addEventListener("click", () => {saveStateToHistory();
                     const name = debtorNameInput.value.trim(); const reason = addDebtReasonInput.value.trim() || 'دين عام'; // Default reason
                      const amount = parseInputNumber(addDebtAmountInput); const deductLiquidity = debtDeductLiquidityCheckbox.checked; if (!name) { showMessage(debtsMessage, "يرجى إدخال اسم المدين.", true); return; } if (isNaN(amount) || amount <= 0) { showMessage(debtsMessage, "يجب أن يكون مبلغ الدين أكبر من صفر.", true); return; } if (deductLiquidity && amount > liquidity) { showMessage(debtsMessage, `مبلغ السلفة (${formatCurrency(amount)}) أكبر من السيولة المتاحة (${formatCurrency(liquidity)}).`, true); return; } // Check if debt with same name and reason exists to update it, otherwise add new
                      const existingDebtIndex = debtors.findIndex(d => d.name === name && d.reason === reason); let logMsg = ""; if (existingDebtIndex !== -1) { debtors[existingDebtIndex].amount = (Number(debtors[existingDebtIndex].amount) || 0) + amount; logMsg = `زيادة دين قائم على "${name}" (سبب: ${reason}) بمبلغ ${formatCurrency(amount)}. الإجمالي الآن: ${formatCurrency(debtors[existingDebtIndex].amount)}`; showMessage(debtsMessage, `تمت زيادة الدين لـ "${name}".`); } else { const newDebtId = generateId('debt'); const newDebt = { id: newDebtId, name: name, reason: reason, amount: amount }; debtors.push(newDebt); logMsg = `تسجيل دين جديد على "${name}" بمبلغ ${formatCurrency(amount)} (السبب: ${reason}).`; showMessage(debtsMessage, `تم تسجيل دين جديد لـ "${name}".`); } if (deductLiquidity) { liquidity -= amount; const liqLogEntry = { id: `liq-${Date.now()}`, timestamp: new Date().toISOString(), type: "remove", amount: amount, description: `سلفة لـ ${name} (${reason})`, currentBalance: liquidity }; liquidityLog.push(liqLogEntry); logMsg += ` وتم خصمه من السيولة كسلفة.`; } logOperation("تسجيل/زيادة دين (لك)", logMsg); updateUI(); debtorNameInput.value = ""; // Clear name too
                      addDebtReasonInput.value = ""; addDebtAmountInput.value = "0"; debtDeductLiquidityCheckbox.checked = false; debtorNameInput.focus(); }); }
                 if (receivePaymentButton) { receivePaymentButton.addEventListener("click", () => { saveStateToHistory();
                     const selectedDebtId = paymentDebtorSelect.value; const payment = parseInputNumber(paymentAmountInput); if (!selectedDebtId) { showMessage(debtsMessage, "يرجى اختيار الدين المراد سداده.", true); return; } if (isNaN(payment) || payment <= 0) { showMessage(debtsMessage, "يجب أن يكون مبلغ السداد أكبر من صفر.", true); return; } const debtIndex = debtors.findIndex(d => d.id === selectedDebtId); if (debtIndex === -1) { showMessage(debtsMessage, "خطأ: الدين المحدد غير موجود!", true); updatePaymentDebtorDropdown(); return; } const debtor = debtors[debtIndex]; debtor.amount = Number(debtor.amount); if (isNaN(debtor.amount)) { console.error("Debtor amount NaN:", selectedDebtId, debtor); showMessage(debtsMessage, "خطأ في بيانات الدين.", true); return; } const tolerance = 0.001; if (payment > debtor.amount + tolerance) { showMessage(debtsMessage, `المبلغ المسدد (${formatCurrency(payment)}) أكبر من الدين المتبقي (${formatCurrency(debtor.amount)}).`, true); return; } const actualPayment = Math.min(payment, debtor.amount); debtor.amount -= actualPayment; liquidity += actualPayment; const liqLogEntry = { id: `liq-${Date.now()}`, timestamp: new Date().toISOString(), type: "add", amount: actualPayment, description: `سداد دين من ${debtor.name} (${debtor.reason || 'دين'})`, currentBalance: liquidity }; liquidityLog.push(liqLogEntry); logOperation("استلام سداد دين", `استلام دفعة ${formatCurrency(actualPayment)} من "${debtor.name}" (دين: ${debtor.reason || 'غير محدد'}). المتبقي: ${formatCurrency(debtor.amount)}.`); if (debtor.amount < tolerance) { debtors.splice(debtIndex, 1); // Remove if fully paid
                          showMessage(debtsMessage, `تم استلام سداد كامل لبند الدين (${debtor.reason || 'غير محدد'}) من "${debtor.name}".`); paymentDebtorSelect.value = ""; } else { showMessage(debtsMessage, `تم استلام دفعة من "${debtor.name}" بنجاح.`); } updateUI(); paymentAmountInput.value = "0"; }); }
                 if (addLiabilityButton) { addLiabilityButton.addEventListener("click", () => {saveStateToHistory();
                     const name = creditorNameInput.value.trim(); const amount = parseInputNumber(addLiabilityAmountInput); const receivedCash = liabilityReceivedCashCheckbox.checked; if (!name) { showMessage(liabilitiesMessage, "يرجى إدخال اسم الدائن.", true); return; } if (isNaN(amount) || amount <= 0) { showMessage(liabilitiesMessage, "يجب أن يكون مبلغ الالتزام أكبر من صفر.", true); return; } const existingIndex = liabilities.findIndex(l => l.name === name); let logMsg = ""; if (existingIndex !== -1) { liabilities[existingIndex].amount = (Number(liabilities[existingIndex].amount) || 0) + amount; logMsg = `زيادة التزام قائم لـ "${name}" بمبلغ ${formatCurrency(amount)}. الإجمالي: ${formatCurrency(liabilities[existingIndex].amount)}`; showMessage(liabilitiesMessage, `تمت زيادة الالتزام لـ "${name}".`); } else { const newLiabilityId = generateId('liab'); const newLiability = { id: newLiabilityId, name: name, amount: amount }; liabilities.push(newLiability); logMsg = `تسجيل التزام جديد على الشركة لـ "${name}" بمبلغ ${formatCurrency(amount)}.`; showMessage(liabilitiesMessage, `تم تسجيل التزام جديد لـ "${name}".`); } if (receivedCash) { liquidity += amount; const liqLogEntry = { id: `liq-${Date.now()}`, timestamp: new Date().toISOString(), type: "add", amount: amount, description: `استلام سيولة مقابل التزام لـ ${name}`, currentBalance: liquidity }; liquidityLog.push(liqLogEntry); logMsg += ` وتم استلام سيولة مقابله.`; } logOperation("تسجيل/زيادة التزام", logMsg); updateUI(); creditorNameInput.value = ""; addLiabilityAmountInput.value = "0"; liabilityReceivedCashCheckbox.checked = false; creditorNameInput.focus(); }); }
                 if (payLiabilityButton) { payLiabilityButton.addEventListener("click", () => {saveStateToHistory();
                     const selectedCreditorId = paymentCreditorSelect.value; const payment = parseInputNumber(liabilityPaymentAmountInput); if (!selectedCreditorId) { showMessage(liabilitiesMessage, "يرجى اختيار اسم الدائن.", true); return; } if (isNaN(payment) || payment <= 0) { showMessage(liabilitiesMessage, "يجب أن يكون مبلغ السداد أكبر من صفر.", true); return; } if (payment > liquidity) { showMessage(liabilitiesMessage, `المبلغ المسدد (${formatCurrency(payment)}) أكبر من السيولة المتاحة (${formatCurrency(liquidity)}).`, true); return; } const liabilityIndex = liabilities.findIndex(l => l.id === selectedCreditorId); if (liabilityIndex === -1) { showMessage(liabilitiesMessage, "خطأ: الدائن المحدد غير موجود!", true); updatePaymentCreditorDropdown(); return; } const liability = liabilities[liabilityIndex]; liability.amount = Number(liability.amount) || 0; if (isNaN(liability.amount)) { console.error("Liability amount NaN:", selectedCreditorId); showMessage(liabilitiesMessage, "خطأ في بيانات الالتزام.", true); return; } const tolerance = 0.001; if (payment > liability.amount + tolerance) { showMessage(liabilitiesMessage, `المبلغ المسدد (${formatCurrency(payment)}) أكبر من الالتزام المتبقي (${formatCurrency(liability.amount)}).`, true); return; } const actualPayment = Math.min(payment, liability.amount); liability.amount -= actualPayment; liquidity -= actualPayment; const liqLogEntry = { id: `liq-${Date.now()}`, timestamp: new Date().toISOString(), type: "remove", amount: actualPayment, description: `تسديد التزام لـ ${liability.name}`, currentBalance: liquidity }; liquidityLog.push(liqLogEntry); logOperation("تسديد التزام", `تسديد دفعة ${formatCurrency(actualPayment)} إلى "${liability.name}". المتبقي: ${formatCurrency(liability.amount)}. تم خصمه من السيولة (الحالية: ${formatCurrency(liquidity)}).`); if (liability.amount < tolerance) { liabilities.splice(liabilityIndex, 1); // Remove if fully paid
                          showMessage(liabilitiesMessage, `تم تسديد كامل الالتزام لـ "${liability.name}".`); paymentCreditorSelect.value = ""; } else { showMessage(liabilitiesMessage, `تم تسديد دفعة إلى "${liability.name}" بنجاح.`); } updateUI(); liabilityPaymentAmountInput.value = "0"; }); }
                 if (performTwoPartyOffsetButton) { 
    performTwoPartyOffsetButton.addEventListener("click", () => {
        saveStateToHistory(); // <-- أضف هذا السطر
        performTwoPartyOffset()
    }); 
}
// --- Financial Center Buttons Listener ---
if (fc_execute_debt_btn) {
    fc_execute_debt_btn.addEventListener('click', () => {
        saveStateToHistory(); // لحفظ الحالة قبل التنفيذ
        fc_execute_debt_treatment();
    });
}

if (fc_execute_dist_btn) {
    fc_execute_dist_btn.addEventListener('click', () => {
        saveStateToHistory(); // لحفظ الحالة قبل التنفيذ
        fc_execute_cost_distribution();
    });
}
                 if (generateReportButton) { generateReportButton.addEventListener("click", generateMonthlySalesReport); }
                 if (addSupplierButton) { 
    addSupplierButton.addEventListener("click", () => {
        saveStateToHistory(); // <-- أضف هذا السطر
        addOrUpdateSupplier();
    }); 
}
                 if (cancelEditSupplierButton) { cancelEditSupplierButton.addEventListener("click", resetSupplierForm); }
                 if (supplierList) { supplierList.addEventListener('click', (e) => { const target = e.target.closest('button'); if (!target) return; const supplierId = target.dataset.supplierId; if (!supplierId) return; if (target.classList.contains('edit-supplier-btn')) { editSupplier(supplierId); } else if (target.classList.contains('delete-supplier-btn')) {saveStateToHistory();
                  deleteSupplier(supplierId); } }); }

                 // **** جديد: مستمع حدث لزر استيراد CSV للسيريالات (في قسم إضافة البضاعة) ****
                 if (importSerialCsvInput) {
                     importSerialCsvInput.addEventListener("change", (event) => importSerialCSV(event, productSerialNumbersTextarea, serialImportMessage));
                 }
                  // **** جديد: مستمع حدث لزر استيراد CSV للسيريالات (في نافذة الإدارة) ****
                 if (modal_importSerialCsvInput) {
                     modal_importSerialCsvInput.addEventListener("change", (event) => importSerialCSV(event, modal_productSerialNumbers, d('modal-serial-import-message')));
                 }

                 // **** جديد: مستمع حدث زر البحث عن السيريالات ****
                 if (searchSupplierSerialsBtn) {
                     searchSupplierSerialsBtn.addEventListener('click', searchSerialsBySupplier);
                     // Optional: Trigger search on Enter key in the input field
                     searchSupplierSerialNameInput?.addEventListener('keypress', function (e) {
                         if (e.key === 'Enter') {
                             searchSerialsBySupplier();
                         }
                     });
                 }
                 // **** جديد: مستمع حدث لفلترة السيريالات المعروضة ****
                 if (filterSerialsInput) {
                     filterSerialsInput.addEventListener('input', (e) => {
                         displayFilteredSupplierSerials(e.target.value);
                     });
                 }

                 // **** جديد: مستمعات أحداث نافذة إدارة السيريالات ****
                 if (modal_saveAddedSerialsBtn) {
                     modal_saveAddedSerialsBtn.addEventListener('click', saveAddedSerialsFromModal);
                 }
                 if (modal_closeBtns) {
                     modal_closeBtns.forEach(btn => btn.addEventListener('click', closeManageSerialsModal));
                 }
                 // Close modal if clicked outside the content
                 window.addEventListener('click', function(event) {
                     if (event.target == manageSerialsModal) {
                         closeManageSerialsModal();
                     }
                     if (event.target == inv_modal) { // Close invoice modal too
                         inv_closeModal();
                     }
                 });


                 // Invoice Modal Listeners
                 if(inv_openInvoiceModalBtn) { inv_openInvoiceModalBtn.addEventListener('click', inv_openModal); }
                 if(inv_closeBtn) { inv_closeBtn.addEventListener('click', inv_closeModal); }
                 if(inv_closeBtnFooter) { inv_closeBtnFooter.addEventListener('click', inv_closeModal); }
                 if (inv_addPhoneBtn) { inv_addPhoneBtn.addEventListener('click', function() { inv_phoneCounter++; const newPhoneEntry = document.createElement('div'); newPhoneEntry.classList.add('form-row', 'inv-phone-entry'); newPhoneEntry.innerHTML = `<div class="form-group"><label for="inv_phone${inv_phoneCounter}">رقم هاتف ${inv_phoneCounter}:</label><input type="tel" id="inv_phone${inv_phoneCounter}" name="phone[]" placeholder="رقم الهاتف"></div><button type="button" class="remove-phone-btn no-print" title="حذف الرقم">×</button>`; if(inv_phoneNumbersContainer) inv_phoneNumbersContainer.appendChild(newPhoneEntry); }); }
                 if (inv_phoneNumbersContainer) { inv_phoneNumbersContainer.addEventListener('click', function(event) { const button = event.target.closest('.remove-phone-btn'); if (button) { button.closest('.inv-phone-entry')?.remove(); } }); }
                 if (inv_addItemBtn) { inv_addItemBtn.addEventListener('click', inv_addInvoiceItem); }
                 if (inv_invoiceItemsBody) { inv_invoiceItemsBody.addEventListener('click', function(event) { const button = event.target.closest('.remove-item-btn'); if (button) { const row = button.closest('.invoice-item-row'); if(row) { // **** إعادة السيريال للحالة المتاحة عند حذف البند من الفاتورة ****
                     const removedSerial = row.dataset.itemSerial; if (removedSerial) { const serialIndex = serialNumbersLog.findIndex(log => log.serial === removedSerial); if (serialIndex !== -1 && serialNumbersLog[serialIndex].status === 'in_invoice_temp') { // تأكد أنه كان محجوزاً لهذه الفاتورة
                         serialNumbersLog[serialIndex].status = 'in_stock'; console.log(`Serial ${removedSerial} status reverted to 'in_stock' on item removal.`); } } row.remove(); inv_calculateTotals(); inv_updateDeductibleCostsCheckboxes(); } } }); }
                 if(inv_shippingCostInput) { inv_shippingCostInput.addEventListener('input', inv_calculateTotals); }
                 if (inv_saveInvoiceBtn) { inv_saveInvoiceBtn.addEventListener('click', handleSaveInvoice); }
                 if (inv_printInvoiceBtn) { inv_printInvoiceBtn.addEventListener('click', () => inv_printInvoice()); } // Call without args for direct print
                 // **** جديد: مستمعات الأحداث للتعامل مع اختيار وبحث السيريال في الفاتورة ****
                 if (inv_itemQtyInput && inv_serialSelectContainer) {
                     inv_itemQtyInput.addEventListener('input', () => {
                         const qty = parseInt(inv_itemQtyInput.value);
                         const itemName = inv_itemNameInput.value.trim();
                         const productHasSerialsRegistered = serialNumbersLog.some(log => log.productName === itemName);
                         if (qty === 1 && itemName && products.some(p => p.name === itemName) && productHasSerialsRegistered) {
                             const hasSerials = populateAvailableSerials(itemName, inv_itemSerialSelect, inv_serialSearchInput.value);
                             inv_serialSelectContainer.classList.remove('hidden');
                             if (!hasSerials && !inv_serialSearchInput.value) { // Show error only if no serials exist at all (and no search term)
                                 showMessage(inv_itemAddErrorDiv, `لا توجد أرقام تسلسلية متاحة في المخزون للمنتج "${itemName}".`, true);
                             } else if(!hasSerials && inv_serialSearchInput.value) {
                                 showMessage(inv_itemAddErrorDiv, `لا توجد أرقام تسلسلية مطابقة للبحث.`, false, true); // Info if search yields no results
                             } else {
                                  showMessage(inv_itemAddErrorDiv, ""); // Clear message if serials found
                             }
                         } else {
                             inv_serialSelectContainer.classList.add('hidden');
                             inv_itemSerialSelect.value = '';
                             inv_serialSearchInput.value = '';
                             showMessage(inv_itemAddErrorDiv, "");
                         }
                     });
                     // أخف القائمة أيضاً عند تغيير اسم المنتج
                     inv_itemNameInput.addEventListener('change', () => {
                         inv_serialSelectContainer.classList.add('hidden');
                         inv_itemSerialSelect.value = '';
                         inv_serialSearchInput.value = '';
                         showMessage(inv_itemAddErrorDiv, "");
                         // أعد التحقق إذا كانت الكمية 1
                         const qty = parseInt(inv_itemQtyInput.value);
                         const itemName = inv_itemNameInput.value.trim();
                         const productHasSerialsRegistered = serialNumbersLog.some(log => log.productName === itemName);
                          if (qty === 1 && itemName && products.some(p => p.name === itemName) && productHasSerialsRegistered) {
                              const hasSerials = populateAvailableSerials(itemName, inv_itemSerialSelect, ''); // Populate without search term initially
                              inv_serialSelectContainer.classList.remove('hidden');
                               if (!hasSerials) {
                                   showMessage(inv_itemAddErrorDiv, `لا توجد أرقام تسلسلية متاحة في المخزون للمنتج "${itemName}".`, true);
                               }
                          }
                     });
                 }
                 // مستمع حدث لحقل بحث السيريال لتحديث القائمة المنسدلة
                 if(inv_serialSearchInput && inv_itemSerialSelect && inv_itemNameInput) {
                     inv_serialSearchInput.addEventListener('input', () => {
                         const itemName = inv_itemNameInput.value.trim();
                         const searchTerm = inv_serialSearchInput.value;
                         if (itemName && inv_serialSelectContainer && !inv_serialSelectContainer.classList.contains('hidden')) {
                             populateAvailableSerials(itemName, inv_itemSerialSelect, searchTerm);
                         }
                     });
                 }


                 // Search Listeners
                 if(searchByNumberBtn) {
                     searchByNumberBtn.addEventListener('click', searchInvoiceByNumber);
                     searchInvoiceNumberInput?.addEventListener('keypress', function (e) { if (e.key === 'Enter') searchInvoiceByNumber(); });
                 }
                 if(searchByNameBtn) {
                     searchByNameBtn.addEventListener('click', searchInvoiceByName);
                     searchCustomerNameInput?.addEventListener('keypress', function (e) { if (e.key === 'Enter') searchInvoiceByName(); });
                 }
                 if(searchResultsListContainer) {
                     searchResultsListContainer.addEventListener('click', (event) => {
                         const button = event.target.closest('.view-invoice-details-btn');
                         if (button && button.dataset.invoiceId) {
                             viewInvoiceDetails(button.dataset.invoiceId);
                         }
                     });
                 }

    // --- Initial Load Logic ---
    const todayString = getTodayDateString();
    // لا داعي للبحث عن آخر يوم محفوظ، سنقوم بالتحميل مباشرة
    await loadDataForDate(todayString);

    // بعد التأكد من تحميل البيانات، نقوم بتحديث الواجهة بالكامل
    updateUI();

    // تعيين القيم الافتراضية لحقول التاريخ
    if (loadDateInputAlt) {
        loadDateInputAlt.value = currentLoadedDate;
        updateLoadDateDayName(currentLoadedDate, loadDateDayNameDisplayAlt);
    }
    if (reportMonthYearInput && currentLoadedDate) {
        reportMonthYearInput.value = currentLoadedDate.substring(0, 7);
    }

    // تشغيل الساعة
    updateTimeDisplay();
    setInterval(updateTimeDisplay, 1000);

    console.log("Initialization complete. Final loaded date:", currentLoadedDate);
}
// =======================================================
// END: دالة بدء التشغيل النهائية
// ======================================================= // End of initializeApp

            // Call initializeApp LAST, after all functions and references are set
            initializeApp();

    }); // End DOMContentLoaded
            </script>
            <!-- ======================================================= -->
<!-- START: Firebase Connection (Revised) -->
<!-- ======================================================= -->
<script type="module">
    // استيراد المكتبات المطلوبة من الإنترنت
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

    // الصق كود firebaseConfig الذي نسخته من موقع Firebase هنا
    const firebaseConfig = {
    apiKey: "AIzaSyCgJeOT_wh9d6h3MTkj-XsEoWW9wo-97ZE",
    authDomain: "financial-app-96527.firebaseapp.com",
    projectId: "financial-app-96527",
    storageBucket: "financial-app-96527.firebasestorage.app",
    messagingSenderId: "409763079254",
    appId: "1:409763079254:web:ae95c7da0aaea083a207f7",
    measurementId: "G-Q5ZLBCBG3J"
  };

    // تهيئة وتشغيل Firebase
    const app = initializeApp(firebaseConfig);

    // تجهيز قاعدة البيانات وجعلها متاحة لكل البرنامج
    window.db = getFirestore(app);
    window.doc = doc; // لجعل دالة doc متاحة
    window.setDoc = setDoc; // لجعل دالة setDoc متاحة
    window.getDoc = getDoc; // لجعل دالة getDoc متاحة

    console.log("Firebase connected successfully! قاعدة البيانات جاهزة.");
</script>
<!-- ======================================================= -->
<!-- END: Firebase Connection (Revised) -->
<!-- ======================================================= -->
            </body>
    </html>