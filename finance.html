<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>برنامج إدارة البضائع والمخزون والفواتير (drashraf) - مُعدل</title>
    <meta name="description" content="برنامج ويب لإدارة المخزون، المبيعات، الموردين، السيولة، الديون، الالتزامات، وحساب رأس المال مع تقارير، بحث فواتير، وترحيل أرصدة تلقائي عند بدء يوم جديد. يتضمن تتبع الأرقام التسلسلية وإدارتها للمخزون الحالي مع بحث داخلي. تطوير ضياء أشرف (drashraf). يشمل بحث وتصفيات للمبيعات المؤقتة وإمكانية تعديل السيولة يدوياً.">
    <meta name="keywords" content="إدارة بضائع, مخزون, موردين, سيولة, ديون, التزامات, مقاصة, تقرير مبيعات, بحث فاتورة, ترحيل أرصدة, ترحيل تلقائي, تعديل, حذف, سبب الدين, برنامج, drashraf, ضياء أشرف, فاتورة, بيع مؤقت, بحث بيع مؤقت, رقم تسلسلي, سيريال, بحث سيريال, استيراد CSV, ربط سيريال بالفاتورة, إدارة سيريالات, بحث داخلي, تعديل السيولة, supplier, invoice, inventory, management, offsetting, sales report, invoice search, carry forward, auto carry forward, edit, delete, debt reason, pending sale, filter pending sales, deduct cost, serial number tracking, serial search, csv import, invoice serial link, manage serials, filter serials, adjust liquidity">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
    /* === تصميم تقرير المبيعات الجديد === */
.report-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: white;
    padding: 1.5rem;
    border-radius: 1rem;
    border: 1px solid #e2e8f0;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    transition: transform 0.2s;
    display: flex;
    flex-direction: column;
}

.stat-card:hover { transform: translateY(-3px); }

.stat-title { font-size: 0.875rem; font-weight: 600; color: #64748b; margin-bottom: 0.5rem; }
.stat-value { font-size: 1.5rem; font-weight: 800; font-family: 'Segoe UI', monospace; }

.stat-sales { border-bottom: 4px solid #3b82f6; }
.stat-sales .stat-value { color: #1d4ed8; }

.stat-cost { border-bottom: 4px solid #f59e0b; }
.stat-cost .stat-value { color: #b45309; }

.stat-profit { border-bottom: 4px solid #10b981; }
.stat-profit .stat-value { color: #047857; }

/* تصميم الجدول */
.report-table-container {
    background: white;
    border-radius: 1rem;
    border: 1px solid #e2e8f0;
    overflow: hidden;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
}

.modern-table { width: 100%; border-collapse: collapse; text-align: right; }
.modern-table thead { background-color: #f8fafc; border-bottom: 1px solid #e2e8f0; }
.modern-table th { padding: 1rem; font-size: 0.85rem; font-weight: 700; color: #475569; text-transform: uppercase; letter-spacing: 0.05em; }
.modern-table td { padding: 1rem; border-bottom: 1px solid #f1f5f9; color: #334155; vertical-align: middle; }
.modern-table tr:last-child td { border-bottom: none; }
.modern-table tr:hover { background-color: #f8fafc; }

/* بادجات الحالة */
.badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 700; display: inline-block; }
.badge-invoice { background-color: #e0e7ff; color: #3730a3; }
.badge-quick { background-color: #f0fdf4; color: #166534; }
.badge-pending { background-color: #fff7ed; color: #9a3412; }

/* أيقونات الجدول */
.td-icon { color: #94a3b8; margin-left: 0.5rem; }
    /* === START: Professional Inline Payment Form Styles === */
.inline-payment-form {
    background-color: #f0f5ff; /* خلفية زرقاء فاتحة جداً */
    padding: 1rem;
    margin-top: 0.75rem;
    border-top: 2px solid #adc8ff;
    border-radius: 0 0 0.375rem 0.375rem; /* حواف دائرية للأسفل فقط */
    
    /* Animation */
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s ease-in-out, padding 0.4s ease-in-out;
}

.inline-payment-form.visible {
    max-height: 300px; /* ارتفاع كافٍ لإظهار النموذج */
    padding: 1rem;
}

.inline-payment-form .form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    align-items: end;
}
/* === END: Professional Inline Payment Form Styles === */
    /* --- START: NEW STYLES FOR BULK PAYMENT --- */
.payment-list-container {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #e2e8f0;
    padding: 0.75rem;
    border-radius: 0.375rem;
    background-color: #f9fafb;
    margin-top: 0.5rem;
}
.payment-list-container label {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem;
    border-radius: 0.25rem;
    cursor: pointer;
    border-bottom: 1px solid #e5e7eb;
}
.payment-list-container label:last-child {
    border-bottom: none;
}
.payment-list-container label:hover {
    background-color: #e5e7eb;
}
.payment-list-container input[type="checkbox"] {
    width: 1.1rem;
    height: 1.1rem;
    flex-shrink: 0;
}
.payment-summary {
    margin-top: 1rem;
    padding: 0.75rem;
    background-color: #eff6ff;
    border: 1px solid #93c5fd;
    border-radius: 0.375rem;
    text-align: center;
    font-weight: 600;
    color: #1e40af;
}
/* --- END: NEW STYLES FOR BULK PAYMENT --- */

        /* --- التنسيقات الأساسية --- */
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; margin: 0; padding: 0; }
        html { direction: rtl; }

        /* --- تنسيقات الأقسام (Widgets) --- */
        .widget-card { background-color: #ffffff; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); border: 1px solid #e5e7eb; transition: box-shadow 0.3s ease-in-out; margin-bottom: 1.5rem; }
        .widget-card:hover { box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .widget-card h2 { font-size: 1.25rem; font-weight: 600; color: #1f2937; margin-top: 0; margin-bottom: 1.25rem; padding-bottom: 0.75rem; border-bottom: 1px solid #e5e7eb; }
        .widget-card h3.sub-heading { font-size: 1.1rem; font-weight: 600; color: #374151; margin-top: 1.5rem; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px dashed #e5e7eb; }

        /* --- تنسيقات التنقل (Tabs) --- */
        #main-nav button { padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 500; color: #4b5563; background-color: #f9fafb; border: 1px solid #e5e7eb; transition: all 0.2s ease-in-out; margin-bottom: 0.5rem; cursor: pointer; }
        #main-nav button:hover { background-color: #f3f4f6; color: #1f2937; }
        #main-nav button.active { background-color: #3b82f6; color: #ffffff; border-color: #2563eb; }

        /* --- تنسيقات أخرى --- */
        .save-icon { display: inline-block; width: 1em; height: 1em; margin-left: 0.5em; vertical-align: middle; fill: currentColor; }
        input[type="text"], input[type="number"], input[type="tel"], input[type="date"], input[type="month"], select, textarea, input[type="checkbox"] { /* Added checkbox */
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            width: 100%;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            box-sizing: border-box; /* Added for consistent sizing */
            font-size: 1em; /* Ensure consistent font size */
            background-color: white; /* Ensure background */
        }
        input[type="checkbox"] { /* Specific checkbox overrides */
             width: auto; /* Checkboxes shouldn't be full width */
             padding: 0; /* Remove padding */
             vertical-align: middle; /* Align with text */
             margin-left: 0.5rem; /* Space after checkbox */
             cursor: pointer;
        }
        input[type="file"] { /* Style file input trigger button instead */
            display: none;
        }
        input[type="text"]:focus, input[type="number"]:focus, input[type="tel"]:focus, input[type="date"]:focus, input[type="month"]:focus, select:focus, textarea:focus, input[type="checkbox"]:focus { /* Added checkbox focus */
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }
        input[type="date"], input[type="month"] { appearance: none; -webkit-appearance: none; cursor: pointer; position: relative; } /* Added relative positioning */
        input[type="date"]::-webkit-calendar-picker-indicator, input[type="month"]::-webkit-calendar-picker-indicator { opacity: 0.6; cursor: pointer; filter: invert(0.5); /* Position indicator if needed, often handled by browser */ }
        select {
            appearance: none; -webkit-appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%2020%2020%22%20fill%3D%22%236b7280%22%3E%3Cpath%20fill-rule%3D%22evenodd%22%20d%3D%22M5.293%207.293a1%201%200%20011.414%200L10%2010.586l3.293-3.293a1%201%200%20111.414%201.414l-4%204a1%201%200%2001-1.414%200l-4-4a1%201%200%20010-1.414z%22%20clip-rule%3D%22evenodd%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat; background-position: left 0.5rem center; background-size: 1.25em; padding-left: 2.5rem; cursor: pointer;
        }

        .section-message {
            min-height: 1.5em; margin-top: 0.75rem; font-weight: 600; display: none;
            border-radius: 0.375rem; padding: 0.75rem; border: 1px solid transparent;
            text-align: center; font-size: 0.9em;
        }
        .section-message.visible { display: block; }
        .section-message.success { color: #065f46; background-color: #d1fae5; border-color: #6ee7b7; } /* text-green-800 bg-green-100 border-green-300 */
        .section-message.error { color: #991b1b; background-color: #fee2e2; border-color: #fca5a5; } /* text-red-800 bg-red-100 border-red-300 */
        .section-message.info { color: #1e40af; background-color: #dbeafe; border-color: #93c5fd; } /* text-blue-800 bg-blue-100 border-blue-300 */


        /* Adjusting global message slightly */
        #global-message { margin-bottom: 1rem; text-align: center; }

        #additional-costs-container { max-height: 150px; overflow-y: auto; border: 1px solid #e2e8f0; padding: 0.75rem; border-radius: 0.375rem; background-color: #f9fafb; margin-top: 1rem; }
        #additional-costs-container label { display: block; margin-bottom: 0.5rem; font-size: 0.875rem; cursor: pointer; padding: 4px; border-radius: 3px; }
        #additional-costs-container label:hover { background-color: #e5e7eb; }
        #additional-costs-container input[type="checkbox"] { margin-left: 0.5rem; cursor: pointer; vertical-align: middle;} /* Already had checkbox styles here */

        /* Unified max-height for lists */
        #pending-sales-list, #debtors-list, #liquidity-log-list, #liabilities-list,
        #sales-report-table-body, #supplier-list, #product-list, #operation-log-list,
        #search-results-list, #supplier-serials-results, #modal-registered-serials-list { /* Added modal-registered-serials-list */
             max-height: 300px; overflow-y: auto;
        }
        #product-list { max-height: 50vh; }
        #search-results-list { max-height: 40vh; }
        #supplier-serials-results { max-height: 40vh; border: 1px solid #e5e7eb; padding: 0.75rem; border-radius: 0.375rem; background-color: #f9fafb; } /* Style for serial results */
        #modal-registered-serials-list { max-height: 150px; /* Shorter height for modal list */ border: 1px solid #e5e7eb; padding: 0.75rem; border-radius: 0.375rem; background-color: #f9fafb; margin-top: 1rem; }
        #operation-log-list { max-height: 60vh; background-color: #f9fafb; border: 1px solid #e5e7eb; padding: 0.75rem; border-radius: 0.375rem; }
        #operation-log-list li { border-bottom: 1px solid #eee; padding-bottom: 0.5rem; margin-bottom: 0.5rem; list-style-position: inside; }

        #pending-sales-list li, #liquidity-log-list li, #liabilities-list li, #supplier-serials-results li, #modal-registered-serials-list li { /* Added modal-registered-serials-list */
            border-bottom: 1px solid #eee; padding: 0.75rem 0.5rem; margin-bottom: 0.5rem; font-size: 0.9em; list-style: none;
        }
        #supplier-serials-results li strong, #modal-registered-serials-list li strong { color: #1d4ed8; } /* Style serial number */
        #debtors-list details { list-style: none; padding: 0; margin: 0 0 0.5rem 0; border: 1px solid #e5e7eb; border-radius: 0.375rem; overflow: hidden;}
        #debtors-list summary { list-style: none; cursor: pointer; background-color: #f9fafb; padding: 0.75rem; font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
        #debtors-list summary::-webkit-details-marker { display: none; }
        #debtors-list details[open] summary { border-bottom: 1px solid #e5e7eb; }
        #debtors-list ul { padding: 0.75rem; background-color: #ffffff; margin: 0; }
        #debtors-list li .debt-details { font-size: 0.8em; color: #6b7280; }
        #pending-sales-list li .details, #liquidity-log-list li .details, #liabilities-list li .details { color: #4b5563; }
        #pending-sales-list li .actions button, #debtors-list li .actions button, #liabilities-list li .actions button, .supplier-actions button, .product-actions button { font-size: 0.75rem; padding: 0.25rem 0.5rem; margin-right: 0.5rem; cursor: pointer; border-radius: 0.25rem; border: 1px solid transparent; }
        .product-actions .manage-serials-btn { background-color: #6366f1; color: white; border-color: #4f46e5; } /* Style for manage serials button */
        .product-actions .manage-serials-btn:hover { background-color: #4f46e5; }

        #consignment-value-display { font-size: 1.125rem; font-weight: 600; color: #ca8a04; }

        /* Ensure containers have consistent spacing and border */
        #debtors-list-container, #liquidity-log-container, #liabilities-list-container,
        #pending-sales-container, #import-export-section, #sales-report-display,
        #suppliers-list-container, #search-results-container, #serial-search-container,
        #liquidity-adjustment-container { /* Added liquidity-adjustment-container */
            margin-top: 1.5rem; border-top: 1px solid #e5e7eb; padding-top: 1rem;
        }
        #debtors-list-container h3, #liquidity-log-container h3, #liabilities-list-container h3,
        #pending-sales-container h3, #import-export-section h3, #sales-report-display h3,
        #suppliers-list-container h3, #search-results-container h3, #serial-search-container h3,
        #liquidity-adjustment-container h3 { /* Added liquidity-adjustment-container */
            font-weight: 600; margin-bottom: 0.75rem; color: #374151; font-size: 1.1rem;
        }
        /* Styling for pending sales search and totals (New) */
        #pending-sales-controls { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem; align-items: center;}
        #pending-sales-search-group { flex-grow: 1; min-width: 200px;}
        #pending-sales-totals-group { display: flex; flex-wrap: wrap; gap: 0.5rem 1.5rem; font-size: 0.9em; font-weight: 500; flex-shrink: 0;}
        #pending-sales-totals-group span { white-space: nowrap; }
        #pending-sales-total-cost { color: #c026d3; } /* Fuchsia for cost */
        #pending-sales-total-profit { color: #16a34a; } /* Green for profit */


        #liquidity-log-list li span.add { color: #16a34a; }
        #liquidity-log-list li span.remove { color: #dc2626; }
        #liabilities-list li span { color: #7c3aed; } /* Purple color for liabilities */

        .hidden { display: none; }
        #import-file-input, #import-serial-csv-input, #modal-import-serial-csv-input { display: none; } /* Hide all file inputs */

        #sales-report-table { width: 100%; border-collapse: collapse; }
        #sales-report-table th, #sales-report-table td { border: 1px solid #e5e7eb; padding: 0.5rem; text-align: right; font-size: 0.875rem; vertical-align: top; }
        #sales-report-table th { background-color: #f9fafb; font-weight: 600; text-align: center;}
        #sales-report-table tfoot td { font-weight: bold; background-color: #f3f4f6; }
        #sales-report-table tbody tr.no-sales-day td { color: #9ca3af; font-style: italic; text-align: center; }
        #sales-report-table td.font-mono { font-family: monospace; }

        textarea { resize: vertical; min-height: 60px; font-family: inherit; }
        .required { color: #dc2626; margin-left: 2px; font-weight: bold; }
        button, label.button-like { /* Style label like a button */
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
            cursor: pointer;
            padding: 0.5rem 1rem; /* Example padding */
            border-radius: 0.375rem;
            font-weight: 500;
            text-align: center;
            display: inline-block; /* Make label behave like button */
        }
        button:disabled { cursor: default; opacity: 0.7; }

        /* --- Modal Styles (Generic) --- */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.5); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 0; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 0.5rem; box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19); animation-name: animatetop; animation-duration: 0.4s; display: flex; flex-direction: column; }
        @keyframes animatetop { from {top: -300px; opacity: 0} to {top: 0; opacity: 1} }
        .modal-header { padding: 0.75rem 1rem; background-color: #f9fafb; color: #1f2937; border-bottom: 1px solid #e5e7eb; border-top-left-radius: 0.5rem; border-top-right-radius: 0.5rem; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { margin: 0; font-size: 1.15em; font-weight: 600; }
        .modal-close-btn { color: #9ca3af; font-size: 24px; font-weight: bold; cursor: pointer; border: none; background: none; padding: 0;}
        .modal-close-btn:hover, .modal-close-btn:focus { color: #374151; text-decoration: none; }
        .modal-body { padding: 1rem 1.25rem; max-height: 70vh; overflow-y: auto; }
        .modal-footer { padding: 0.75rem 1rem; background-color: #f9fafb; border-top: 1px solid #e5e7eb; text-align: left; display: flex; justify-content: flex-start; flex-wrap: wrap; gap: 0.5rem; border-bottom-left-radius: 0.5rem; border-bottom-right-radius: 0.5rem; }
        .modal-footer button { padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 500; color: white; border: 1px solid transparent; transition: all 0.2s ease-in-out; cursor: pointer; }
        .modal-footer button.modal-close-btn-footer { background-color: #6b7280; border-color: #6b7280; margin-right: auto; margin-left: 0; } /* Adjusted margin */
        .modal-footer button.modal-close-btn-footer:hover { background-color: #4b5563; border-color: #4b5563;}

        /* --- Invoice Modal Specific Styles (Overrides) --- */
        #invoiceModal .modal-content { max-width: 800px; } /* Larger modal for invoice */
        #inv_printInvoiceBtn { background-color: #f59e0b; border-color: #f59e0b; color:#fff;}
        #inv_printInvoiceBtn:hover { background-color: #d97706; border-color: #d97706;}
        #inv_saveInvoiceBtn { background-color: #10b981; border-color: #10b981;}
        #inv_saveInvoiceBtn:hover { background-color: #059669; border-color: #059669;}

        /* --- Manage Serials Modal Specific Styles --- */
        #manageSerialsModal .modal-content { max-width: 500px; } /* Smaller modal */
        #modal_saveAddedSerialsBtn { background-color: #3b82f6; border-color: #2563eb; }
        #modal_saveAddedSerialsBtn:hover { background-color: #2563eb; border-color: #1d4ed8; }
        #modal_productNameDisplay { font-weight: 600; color: #1e40af; }
        #modal_serialCounts { font-size: 0.9em; color: #4b5563; margin-bottom: 1rem; }

        fieldset { border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1.25rem; }
        legend { font-weight: 600; color: #374151; padding: 0 0.5rem; font-size: 1rem; }
        .form-row { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem; align-items: flex-end; }
        .form-group { flex: 1; min-width: 150px; display: flex; flex-direction: column; }
        .form-group label { margin-bottom: 0.3rem; font-size: 0.875rem; color: #374151; font-weight: 500;}
        .inv-phone-entry { margin-bottom: 0.75rem; padding-bottom: 0.75rem; border-bottom: 1px dashed #e5e7eb; align-items: center; }
        .inv-phone-entry .form-group { flex-grow: 1; margin-bottom: 0; } /* Removed bottom margin */
        .remove-phone-btn { padding: 0.3rem 0.5rem; background-color: #f59e0b; color: white; border: none; border-radius: 0.375rem; cursor: pointer; font-size: 0.9em; margin-right: 0; margin-left: 0; flex-shrink: 0; height: fit-content; } /* Adjusted margin */
        .remove-phone-btn:hover { background-color: #d97706;}
        #inv_addPhoneBtn { padding: 0.5rem 0.75rem; background-color: #0ea5e9; color: white; border: none; border-radius: 0.375rem; cursor: pointer; margin-top: 0.25rem; font-size: 0.9em; }
        #inv_addPhoneBtn:hover { background-color: #0284c7; }
        .add-item-section { background-color: #f9fafb; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; margin-bottom: 1rem; }
        .add-item-section h4 { margin-top: 0; margin-bottom: 0.75rem; color: #4b5563; font-weight: 600; font-size: 1rem; }
        #inv_addItemBtn { background-color: #3b82f6; color: white; border-color: #3b82f6; width: auto; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 500; cursor: pointer; flex-shrink: 0; /* Prevent shrinking */ }
        #inv_addItemBtn:hover { background-color: #2563eb; border-color: #2563eb; }
        #inv_invoiceItemsTable { width: 100%; border-collapse: collapse; margin-top: 0.75rem; }
        #inv_invoiceItemsTable th, #inv_invoiceItemsTable td { border: 1px solid #e5e7eb; padding: 0.5rem; text-align: right; font-size: 0.9em; vertical-align: middle; }
        #inv_invoiceItemsTable th { background-color: #f3f4f6; font-weight: 600; text-align: center; }
        #inv_invoiceItemsTable tbody tr:nth-child(even) { background-color: #f9fafb; }
        #inv_invoiceItemsTable td.item-qty, #inv_invoiceItemsTable td.item-price, #inv_invoiceItemsTable td.item-subtotal { text-align: center; font-family: monospace; }
        #inv_invoiceItemsTable td .serial-display { font-size: 0.8em; color: #6b7280; display: block; margin-top: 2px; } /* Style for serial in invoice */
        .item-subtotal { font-weight: bold; }
        .remove-item-btn { color: #ef4444; background: none; border: none; font-weight: bold; cursor: pointer; font-size: 1.1em; padding: 0 5px; }
        .remove-item-btn:hover { color: #dc2626; }
        .serial-select-container { margin-top: 0.3rem; } /* Container for serial dropdown */
        .serial-select-container input[type="text"] { /* Style for serial search input */
             width: auto; /* Adjust width as needed */
             min-width: 150px;
             padding: 0.25rem 0.5rem;
             font-size: 0.85em;
             margin-bottom: 0.25rem; /* Space below search */
        }
        .serial-select-container select { font-size: 0.85em; padding: 0.25rem 0.5rem; width: auto; min-width: 150px; max-height: 100px; } /* Style for serial dropdown */

        #inv_deductibleCostsContainer { max-height: 100px; overflow-y: auto; border: 1px solid #e5e7eb; padding: 0.75rem; border-radius: 0.375rem; background-color: #f9fafb; margin-top: 1rem; }
        #inv_deductibleCostsContainer label { display: block; margin-bottom: 0.5rem; font-size: 0.875rem; cursor: pointer; padding: 4px; border-radius: 3px; }
        #inv_deductibleCostsContainer label:hover { background-color: #e5e7eb; }
        #inv_deductibleCostsContainer input[type="checkbox"] { margin-left: 0.5rem; cursor: pointer; vertical-align: middle; }
        .totals-display .form-group { flex-direction: row; align-items: center; justify-content: space-between; background-color: #f3f4f6; padding: 0.5rem 0.75rem; border-radius: 0.375rem; min-width: 180px; flex-basis: auto; margin-bottom: 0.5rem; }
        .totals-display label { margin-bottom: 0; font-weight: 600; white-space: nowrap; margin-left: 0.5rem; }
        .totals-display span, .totals-display strong { font-family: monospace; font-size: 1em; margin-right: 0.3rem; white-space: nowrap; }
        #inv_grandTotalPrice { color: #dc2626; font-size: 1.1em; }
        .error-message {
            color: #991b1b; background-color: #fee2e2; border: 1px solid #fca5a5;
            padding: 0.75rem; border-radius: 0.375rem; margin-top: 1rem;
            text-align: center; font-size: 0.9em; display: none;
        }
        .error-message.visible { display: block; }
        #inv_itemAddError { padding: 0.3rem 0.6rem; margin-top: 0.4rem; margin-bottom: 0.75rem; }
        .no-print { /* Applied via @media print */ }

        /* --- Print Styles --- */
        @media print {
            body { background-color: #ffffff !important; margin: 0; padding: 10px; font-size: 10pt; }
            section, .widget-card, .modal { display: none !important; } /* Hide all main sections & modals by default */
             #main-nav, footer, #global-message, #current-data-date, #current-time { display: none !important; } /* Hide time in footer */

            /* Show only specific sections for general report */
             body.print-report #summary-section,
             body.print-report #inventory-section,
             body.print-report #suppliers-section,
             body.print-report #debts-section,
             body.print-report #liabilities-section,
             body.print-report #log-section {
                 display: block !important;
                 box-shadow: none !important;
                 border: 1px solid #ccc !important;
                 margin-bottom: 15px !important;
                 border-radius: 0 !important;
                 padding: 10px !important;
             }
             body.print-report #inventory-section #add-update-product-form, /* Hide product input form */
             body.print-report #inventory-section #serial-number-entry-container, /* Hide serial number input */
             body.print-report #inventory-section label[for="product-deduct-liquidity"], /* Hide deduct checkbox */
             body.print-report #suppliers-section #add-update-supplier-form, /* Hide supplier input form */
             body.print-report #suppliers-section #serial-search-container, /* Hide serial search form */
             body.print-report #debts-section > div:not(#debtors-list-container), /* Hide input forms in debts */
             body.print-report #liabilities-section > div:not(#liabilities-list-container), /* Hide input forms in liabilities */
             body.print-report #log-section button,
             body.print-report #liquidity-adjustment-container { /* Hide liquidity adjustment form */
                  display: none !important;
             }
             body.print-report .product-actions, body.print-report .supplier-actions { display: none !important; }
             body.print-report #debtors-list details { page-break-inside: avoid; }
             body.print-report #debtors-list details > ul { display: block !important; } /* Ensure debt details are expanded */
             body.print-report #debtors-list summary { list-style: none; cursor: default; background-color: #eee !important; padding: 5px !important; }
             body.print-report #debtors-list summary::-webkit-details-marker { display: none !important; }
             body.print-report h2 { border-bottom: 1px solid #eee !important; font-size: 1.2em !important; page-break-after: avoid; }
             body.print-report h3 { font-size: 1.1em !important; page-break-after: avoid; }
             body.print-report .grid { display: block !important; } /* Simplify grid layouts */
             body.print-report table { font-size: 9pt !important; page-break-inside: auto; }
             body.print-report th, body.print-report td { padding: 4px !important; }
             body.print-report tr { page-break-inside: avoid; page-break-after: auto; }
             body.print-report thead { display: table-header-group; }
             body.print-report tfoot { display: table-footer-group; }


            /* Hide things not needed in any print */
            .no-print, #controls-section, #load-data-section, #pending-sales-section button, #consignment-value-display, #debtors-list button, #load-date-day-name-alt, #liquidity-section button, #liabilities-section button, #liabilities-list button, #settings-section button, #pending-sales-list button, #import-export-section, #offsetting-section, #sales-report-section button, #sales-report-section input, #sales-report-section label, #search-section, #openInvoiceModalBtn, #add-update-product-form button, #sell-product > div:first-of-type, #pending-sales-container h3, #liquidity-section > div:nth-of-type(2), #expenses-section > div:nth-of-type(2), #debts-section > div:nth-of-type(2), #debts-section > div:nth-of-type(3), #liabilities-section > div:nth-of-type(2), #offsetting-section > div:nth-of-type(1), #log-section button, #add-update-supplier-form button, #suppliers-list-container button,
            #pending-sales-controls /* Hide pending sales search/totals in print */ {
                 display: none !important;
             }

            /* Invoice Modal Print Specifics */
            body.print-invoice #main-content { display: none !important; } /* Hide main app when printing invoice */
            body.print-invoice #invoicePrintArea { display: block !important; }
            body.print-invoice .invoice-modal-content { border: none !important; box-shadow: none !important; margin: 0 !important; max-width: 100% !important; border-radius: 0 !important; animation: none !important; }
            body.print-invoice .invoice-modal-body { max-height: none !important; overflow: visible !important; padding: 0 !important; }
            body.print-invoice .no-print { display: none !important; }
            body.print-invoice #inv_invoiceItemsTable { font-size: 9pt !important; }
            body.print-invoice #inv_invoiceItemsTable th, body.print-invoice #inv_invoiceItemsTable td { padding: 4px !important; }
            body.print-invoice .serial-display-print { display: block !important; font-size: 0.8em; color: #555; } /* Show serial in print */

        }
        /* --- START: FINANCIAL CENTER STYLES --- */
.fc-main-tabs button.active { border-color: #3b82f6; color: #3b82f6; background-color: #eff6ff; }
.fc-form-input, .fc-form-select { border: 1px solid #d1d5db; border-radius: 0.375rem; padding: 0.5rem 0.75rem; width: 100%; transition: all 0.2s; }
.fc-form-input:focus, .fc-form-select:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
.fc-step-card { background-color: white; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.07); border: 1px solid #e5e7eb; margin-bottom: 1.5rem; }
.fc-step-card h3 { font-size: 1.25rem; font-weight: 700; color: #1e3a8a; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; gap: 0.75rem; }
.fc-step-card h3 .fc-step-number { background-color: #3b82f6; color: white; height: 2rem; width: 2rem; border-radius: 9999px; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; }
.fc-preview-card { transition: all 0.4s ease-in-out; max-height: 0; overflow: hidden; opacity: 0; border-width: 2px; }
.fc-preview-card.visible { max-height: 1500px; opacity: 1; margin-top: 1.5rem; }
.fc-manual-dist-input { width: 80px; text-align: center; }
.fc-disabled-section { opacity: 0.45; pointer-events: none; user-select: none; background-color: #f9fafb; }
/* --- END: FINANCIAL CENTER STYLES --- */
#undo-button:disabled, #redo-button:disabled {
    background-color: #fed7aa; /* لون برتقالي باهت */
    color: #7c2d12;           /* لون بني داكن للنص */
    opacity: 0.7;
    cursor: not-allowed;
 /* === بداية التصميم الاحترافي الجديد لزر الحفظ التلقائي === */

/* الحاوية الرئيسية للزر */
.auto-save-switch {
  position: relative;
  display: inline-block;
  width: 50px;
  height: 28px;
}

/* إخفاء مربع الاختيار الافتراضي */
.auto-save-switch input { 
  opacity: 0;
  width: 0;
  height: 0;
}

/* شريط التمرير (الجزء الخلفي للزر) */
.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #d1d5db; /* لون رمادي فاتح احترافي لوضع الإيقاف */
  -webkit-transition: .3s;
  transition: .3s;
  border-radius: 28px; /* حواف دائرية بالكامل */
}

/* الدائرة التي تتحرك (المقبض) */
.slider:before {
  position: absolute;
  content: "";
  height: 22px;
  width: 22px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  -webkit-transition: .3s;
  transition: .3s;
  border-radius: 50%;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1); /* ظل ناعم لإعطاء عمق */
}

/* عند تفعيل الزر */
input:checked + .slider {
  background-color: #2563eb; /* لون أزرق جذاب يتناسب مع البرنامج */
}

/* عند تفعيل الزر، يتم تحريك المقبض */
input:checked + .slider:before {
  -webkit-transform: translateX(22px);
  -ms-transform: translateX(22px);
  transform: translateX(22px);
}

/* تأثير بسيط عند الضغط على الزر (يعطي إحساسًا بالتفاعلية) */
input:active + .slider:before {
    width: 26px; /* يتمدد المقبض قليلاً عند الضغط */
}

input:checked:active + .slider:before {
    -webkit-transform: translateX(18px);
    -ms-transform: translateX(18px);
    transform: translateX(18px); /* يتم تعديل موضعه ليتناسب مع الحجم الجديد */
}
/* ============================================= */
/* ====== تنسيقات قسم المرتجعات الجديد ====== */
/* ============================================= */
/* ============================================= */
/* ====== تنسيقات التصميم الجديد لقسم المرتجعات ====== */
/* ============================================= */
#returns-section .section-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding-bottom: 1.5rem;
    border-bottom: 2px solid #e2e8f0;
}
#returns-section .section-header h2 {
    font-size: 1.75rem;
    font-weight: 700;
    color: #1a202c;
    margin: 0;
}
#returns-section .section-header .icon {
    font-size: 2rem;
    color: #e53e3e;
}
#returns-section .card-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}
#returns-section .option-card {
    background-color: #f7fafc;
    border-radius: 10px;
    padding: 1.5rem;
    border: 1px solid #e2e8f0;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    transition: all 0.2s ease-in-out;
}
#returns-section .option-card:hover {
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
    border-color: #a0aec0;
}
#returns-section .card-header {
    display: flex;
    align-items: center;
    gap: 1rem;
}
#returns-section .card-header .card-icon {
    font-size: 1.5rem;
    color: #718096;
}
#returns-section .card-header .card-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: #2d3748;
    margin: 0;
}
#returns-section .card-content {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    padding-right: 2.5rem;
    border-right: 2px dashed #e2e8f0;
}
#returns-section .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}
#returns-section .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}
#returns-section .form-group label {
    font-size: 0.875rem;
    font-weight: 600;
    color: #4a5568;
}
#returns-section .form-input,
#returns-section .form-select {
    border: 1px solid #cbd5e0;
    border-radius: 8px;
    padding: 0.75rem 1rem;
    width: 100%;
    transition: all 0.3s;
    font-size: 1rem;
    background-color: #ffffff;
}
#returns-section .radio-buttons,
#returns-section .checkbox-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
}
#returns-section .radio-label,
#returns-section .checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 500;
    color: #4a5568;
    padding: 0.75rem 1rem;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    transition: all 0.2s ease-in-out;
    background-color: #f7fafc;
}
#returns-section .radio-label:hover,
#returns-section .checkbox-label:hover {
    border-color: #4299e1;
    background-color: #ebf8ff;
}
#returns-section input[type="radio"]:checked + .label-text,
#returns-section input[type="checkbox"]:checked + .label-text {
    color: #2b6cb0;
    font-weight: 700;
}
#returns-section input[type="radio"],
#returns-section input[type="checkbox"] {
    display: none;
}
#returns-section .display-text-box {
    padding: 0.75rem 1rem;
    background-color: #edf2f7;
    border-radius: 8px;
    text-align: center;
    font-size: 1.1rem;
    font-weight: 700;
    color: #2d3748;
    border: 1px solid #e2e8f0;
}
#returns-section .action-button {
    background-color: #e53e3e;
    color: white;
    padding: 1rem;
    border-radius: 8px;
    font-weight: 700;
    font-size: 1.1rem;
    border: none;
    cursor: pointer;
    transition: background-color 0.3s, transform 0.1s;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    width: 100%;
}
#returns-section .action-button:hover {
    background-color: #c53030;
    transform: translateY(-1px);
}
#returns-section .hidden { display: none; }

/* === نهاية التصميم الاحترافي الجديد === */
}
/* ... أكواد CSS أخرى ... */

input:checked:active + .slider:before {
    -webkit-transform: translateX(18px);
    -ms-transform: translateX(18px);
    transform: translateX(18px); /* يتم تعديل موضعه ليتناسب مع الحجم الجديد */
}


/* === نهاية التصميم الاحترافي الجديد === */
} 
/* ============================================= */
/* ====== تنسيقات جدول تقرير المصروفات ====== */
/* ============================================= */
#expenses-report-table {
    width: 100%;
    border-collapse: collapse; /* يزيل المسافات المزدوجة بين الحدود */
    margin-top: 1rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    border-radius: 0.5rem;
    overflow: hidden; /* لإخفاء الزوايا الحادة للخلفية */
}

#expenses-report-table th {
    background-color: #f9fafb; /* خلفية رمادية فاتحة جداً للرأس */
    color: #374151; /* لون نص أغمق قليلاً */
    font-weight: 600;
    text-align: right;
    padding: 0.75rem 1rem;
    border-bottom: 2px solid #e5e7eb;
}

#expenses-report-table td {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #e5e7eb;
    color: #4b5563; /* لون نص المحتوى */
}

/* سطر تجميع التاريخ */
#expenses-report-table .date-group-header td {
    background-color: #eff6ff; /* خلفية زرقاء فاتحة */
    color: #1e40af; /* لون أزرق داكن للنص */
    font-weight: bold;
    padding: 0.5rem 1rem;
    border-top: 2px solid #dbeafe;
    border-bottom: 2px solid #dbeafe;
}

/* تظليل السطور الفردية لتحسين القراءة */
#expenses-report-table tbody tr.expense-row:nth-child(even) {
    background-color: #f9fafb;
}

#expenses-report-table tfoot td {
    font-weight: bold;
    font-size: 1.1em;
    background-color: #f3f4f6;
    border-top: 2px solid #d1d5db;
}
/* ============================================= */
/* ====== تنسيقات التصميم الجديد لقسم المرتجعات ====== */
/* ============================================= */
#returns-section .section-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding-bottom: 1.5rem;
    border-bottom: 2px solid #e2e8f0;
}

#returns-section .section-header h2 {
    font-size: 1.75rem;
    font-weight: 700;
    color: #1a202c;
    margin: 0;
}

    
#returns-section .section-header .icon {
    font-size: 2rem;
    color: #e53e3e;
}
    
#returns-section .card-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

#returns-section .option-card {
    background-color: #f7fafc;
    border-radius: 10px;
    padding: 1.5rem;
    border: 1px solid #e2e8f0;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    transition: all 0.2s ease-in-out;
}

#returns-section .option-card:hover {
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
    border-color: #a0aec0;
}

#returns-section .card-header {
    display: flex;
    align-items: center;
    gap: 1rem;
}

#returns-section .card-header .card-icon {
    font-size: 1.5rem;
    color: #718096;
}

#returns-section .card-header .card-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: #2d3748;
    margin: 0;
}
    
#returns-section .card-content {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    padding-right: 2.5rem;
    border-right: 2px dashed #e2e8f0;
}

#returns-section .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

#returns-section .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}
    
#returns-section .form-group label {
    font-size: 0.875rem;
    font-weight: 600;
    color: #4a5568;
}

#returns-section .form-input,
#returns-section .form-select {
    border: 1px solid #cbd5e0;
    border-radius: 8px;
    padding: 0.75rem 1rem;
    width: 100%;
    transition: all 0.3s;
    font-size: 1rem;
    background-color: #ffffff;
}

#returns-section .radio-buttons,
#returns-section .checkbox-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
}

#returns-section .radio-label,
#returns-section .checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 500;
    color: #4a5568;
    padding: 0.75rem 1rem;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    transition: all 0.2s ease-in-out;
    background-color: #f7fafc;
}
    
#returns-section .radio-label:hover,
#returns-section .checkbox-label:hover {
    border-color: #4299e1;
    background-color: #ebf8ff;
}

#returns-section input[type="radio"]:checked + .label-text,
#returns-section input[type="checkbox"]:checked + .label-text {
    color: #2b6cb0;
    font-weight: 700;
}
    
#returns-section input[type="radio"],
#returns-section input[type="checkbox"] {
    display: none;
}

#returns-section .display-text-box {
    padding: 0.75rem 1rem;
    background-color: #edf2f7;
    border-radius: 8px;
    text-align: center;
    font-size: 1.1rem;
    font-weight: 700;
    color: #2d3748;
    border: 1px solid #e2e8f0;
}

#returns-section .action-button {
    background-color: #e53e3e;
    color: white;
    padding: 1rem;
    border-radius: 8px;
    font-weight: 700;
    font-size: 1.1rem;
    border: none;
    cursor: pointer;
    transition: background-color 0.3s, transform 0.1s;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    width: 100%;
}

#returns-section .action-button:hover {
    background-color: #c53030;
    transform: translateY(-1px);
}

#returns-section .hidden { display: none; }
/* ======================================================= */
/* START: NEW STYLES FOR LIQUIDITY SECTION V2              */
/* ======================================================= */
#safes-overview-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}
.safe-card {
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    padding: 1rem;
    transition: all 0.2s ease-in-out;
}
.safe-card.total-card {
    background-color: #1e3a8a;
    color: white;
    border-color: #1e40af;
}
.safe-card h4 {
    margin: 0 0 0.5rem 0;
    font-size: 0.9rem;
    font-weight: 500;
    color: #6b7280;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
.safe-card.total-card h4 {
    color: #93c5fd;
}
.safe-card-balance {
    font-size: 1.5rem;
    font-weight: 700;
    font-family: monospace;
    color: #1d4ed8;
}
.safe-card.total-card .safe-card-balance {
    color: white;
}
.action-tabs {
    display: flex;
    gap: 0.5rem;
    border-bottom: 1px solid #d1d5db;
    margin-bottom: 1.5rem;
}
.action-tabs button {
    background-color: transparent;
    color: #4b5563;
    border-radius: 0.5rem 0.5rem 0 0;
    border: 1px solid transparent;
    border-bottom: none;
    padding: 0.75rem 1.25rem;
    font-weight: 600;
    width: auto;
}
.action-tabs button.active {
    background-color: #ffffff;
    color: #3b82f6;
    border-color: #d1d5db;
}
.liquidity-actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    align-items: flex-start;
}
.action-column {
    background-color: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    padding: 1rem;
}
.action-column h3 {
    font-size: 1.1rem;
    font-weight: 600;
    color: #374151;
    margin-top: 0;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
#liquidity-log-advanced-container {
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid #e5e7eb;
}
#accounts-list {
    list-style: none;
    padding: 0;
    margin: 0;
}
.account-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    border-bottom: 1px solid #e5e7eb;
}
.account-item:last-child {
    border-bottom: none;
}
.account-item-name {
    font-weight: 500;
}
.account-item-actions button {
    width: auto;
    font-size: 0.8rem;
    padding: 0.25rem 0.75rem;
    margin-right: 0.5rem;
}
.edit-btn { background-color: #f59e0b; }
.delete-btn { background-color: #ef4444; }

#account-form {
    margin-top: 1.5rem;
    padding: 1.5rem;
    background-color: #f9fafb;
    border-radius: 0.5rem;
    border: 1px solid #e5e7eb;
}
#account-form h3 { margin-top: 0; }

/* Styles for screens smaller than 768px (most phones) */
@media (max-width: 768px) {
    
    /* تقليل الهوامش العامة للجسم */
    body {
        padding: 0.75rem; /* 12px */
    }

    /* تعديل حجم الخط الرئيسي والعناوين */
    h1 {
        font-size: 1.5rem; /* 24px */
    }
    .widget-card h2, .fc-step-card h3 {
        font-size: 1.1rem; /* 18px */
    }

    /* جعل الأقسام تأخذ العرض الكامل وتقليل الهوامش الداخلية */
    .widget-card {
        padding: 1rem; /* 16px */
    }

    /* تعديل أزرار التنقل الرئيسية لتكون أفضل على الموبايل */
    #main-nav {
        gap: 0.5rem; /* 8px */
    }
    #main-nav button {
        flex-grow: 1; /* تجعل الأزرار تتمدد لتملأ السطر */
        flex-basis: 45%; /* كل زر يأخذ حوالي نصف العرض */
        font-size: 0.8rem; /* تصغير الخط قليلاً */
    }

    /* تحويل كل الشبكات (Grids) إلى عمود واحد */
    .grid {
        grid-template-columns: 1fr !important; /* !important للتأكد من تطبيق الستايل */
    }

    /* تنسيق النماذج لتكون عمودية وواضحة */
    .form-row, 
    #pending-sales-controls, 
    #add-update-monthly-liability-form .grid {
        flex-direction: column;
        gap: 0.75rem;
        align-items: stretch; /* تجعل العناصر تمتد بعرض الحاوية */
    }
    .form-group {
        min-width: 100%;
    }

    /* تعديل عرض الجداول لتكون قابلة للتمرير أفقيًا */
    #sales-report-display .overflow-x-auto,
    #expenses-report-display .overflow-x-auto {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch; /* لتحسين التمرير على iOS */
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
    }
    #sales-report-table, #expenses-report-table, #pi_items_table {
        min-width: 600px; /* اجعل الجدول أعرض من الشاشة لإجبار التمرير */
        font-size: 0.8rem;
    }
    
    /* تعديل حجم النوافذ المنبثقة (Modals) */
    .modal-content {
        width: 95%;
        margin: 10% auto;
        max-height: 80vh;
    }
    .modal-body {
        padding: 0.75rem;
    }
    
    /* تعديل الأزرار في الفوتر الخاص بالـ Modal */
    .modal-footer {
        flex-direction: column-reverse; /* وضع الأزرار فوق بعضها */
        align-items: stretch;
    }
    .modal-footer button {
        width: 100%;
        margin-right: 0 !important;
        margin-left: 0 !important;
    }
} 
   
   
    </style>

    <style>
/* ... أكواد CSS أخرى ... */
    </style>
    <style>
        /* TailwindCSS Utility Class Placeholders (Copied for reference, not dynamically generated) */
        *, ::before, ::after{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }
        *,::after,::before{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}::after,::before{--tw-content:''}
        html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}
        body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0;padding:0}legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default; opacity: 0.7;}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]{display:none} /* Simplified */
        .col-span-full{grid-column:1 / -1}.mb-1{margin-bottom:0.25rem}.mb-2{margin-bottom:0.5rem}.mb-3{margin-bottom:0.75rem}.mb-4{margin-bottom:1rem}.mb-6{margin-bottom:1.5rem}.ml-2{margin-left:0.5rem}.mt-1{margin-top:0.25rem}.mt-10{margin-top:2.5rem}.mt-2{margin-top:0.5rem}.mt-3{margin-top:0.75rem}.mt-4{margin-top:1rem}.mt-6{margin-top:1.5rem}.mt-8{margin-top:2rem}.block{display:block}.flex{display:flex}.inline-flex{display:inline-flex}.grid{display:grid}.hidden{display:none}.max-h-\[50vh\]{max-height:50vh}.max-h-\[60vh\]{max-height:60vh}.w-52{width:13rem}.w-full{width:100%}.min-w-\[50px\]{min-width:50px}.min-w-full{min-width:100%}.flex-shrink-0{flex-shrink:0}.cursor-pointer{cursor:pointer}.list-disc{list-style-type:disc}.grid-cols-1{grid-template-columns:repeat(1, minmax(0, 1fr))}.flex-col{flex-direction:column}.flex-wrap{flex-wrap:wrap}.items-start{align-items:flex-start}.items-end{align-items:flex-end}.items-center{align-items:center}.justify-start{justify-content:flex-start}.justify-end{justify-content:flex-end}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-1{gap:0.25rem}.gap-2{gap:0.5rem}.gap-4{gap:1rem}.gap-6{gap:1.5rem}.space-y-2 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(0.5rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(0.5rem * var(--tw-space-y-reverse))}.space-y-3 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(0.75rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(0.75rem * var(--tw-space-y-reverse))}.overflow-hidden{overflow:hidden}.overflow-x-auto{overflow-x:auto}.overflow-y-auto{overflow-y:auto}.rounded{border-radius:0.25rem}.rounded-lg{border-radius:0.5rem}.rounded-md{border-radius:0.375rem}.border{border-width:1px}.border-b{border-bottom-width:1px}.border-l{border-left-width:1px}.border-t{border-top-width:1px}.border-blue-200{--tw-border-opacity:1;border-color:rgb(191 219 254 / var(--tw-border-opacity, 1))}.border-gray-200{--tw-border-opacity:1;border-color:rgb(229 231 235 / var(--tw-border-opacity, 1))}.border-gray-300{--tw-border-opacity:1;border-color:rgb(209 213 219 / var(--tw-border-opacity, 1))}.border-green-200{--tw-border-opacity:1;border-color:rgb(187 247 208 / var(--tw-border-opacity, 1))}.border-indigo-200{--tw-border-opacity:1;border-color:rgb(199 210 254 / var(--tw-border-opacity, 1))}.border-indigo-300{--tw-border-opacity:1;border-color:rgb(165 180 252 / var(--tw-border-opacity, 1))}.border-pink-200{--tw-border-opacity:1;border-color:rgb(251 207 232 / var(--tw-border-opacity, 1))}.border-purple-200{--tw-border-opacity:1;border-color:rgb(233 213 255 / var(--tw-border-opacity, 1))}.border-red-200{--tw-border-opacity:1;border-color:rgb(254 202 202 / var(--tw-border-opacity, 1))}.border-teal-200{--tw-border-opacity:1;border-color:rgb(153 246 228 / var(--tw-border-opacity, 1))}.border-yellow-200{--tw-border-opacity:1;border-color:rgb(254 240 138 / var(--tw-border-opacity, 1))}.border-gray-100{--tw-border-opacity:1;border-color:rgb(243 244 246 / var(--tw-border-opacity, 1))}.border-red-400{--tw-border-opacity:1;border-color:rgb(248 113 113 / var(--tw-border-opacity, 1))}.border-green-400{--tw-border-opacity:1;border-color:rgb(74 222 128 / var(--tw-border-opacity, 1))}.border-yellow-500{--tw-border-opacity:1;border-color:rgb(234 179 8 / var(--tw-border-opacity, 1))}.border-red-600{--tw-border-opacity:1;border-color:rgb(220 38 38 / var(--tw-border-opacity, 1))}.border-green-700{--tw-border-opacity:1;border-color:rgb(21 128 61 / var(--tw-border-opacity, 1))}.border-yellow-700{--tw-border-opacity:1;border-color:rgb(161 98 7 / var(--tw-border-opacity, 1))}.border-teal-600{--tw-border-opacity:1;border-color:rgb(13 148 136 / var(--tw-border-opacity, 1))}.bg-blue-50{--tw-bg-opacity:1;background-color:rgb(239 246 255 / var(--tw-bg-opacity, 1))}.bg-blue-500{--tw-bg-opacity:1;background-color:rgb(59 130 246 / var(--tw-bg-opacity, 1))}.bg-cyan-500{--tw-bg-opacity:1;background-color:rgb(6 182 212 / var(--tw-bg-opacity, 1))}.bg-gray-200{--tw-bg-opacity:1;background-color:rgb(229 231 235 / var(--tw-bg-opacity, 1))}.bg-gray-400{--tw-bg-opacity:1;background-color:rgb(156 163 175 / var(--tw-bg-opacity, 1))}.bg-gray-50{--tw-bg-opacity:1;background-color:rgb(249 250 251 / var(--tw-bg-opacity, 1))}.bg-green-50{--tw-bg-opacity:1;background-color:rgb(240 253 244 / var(--tw-bg-opacity, 1))}.bg-green-500{--tw-bg-opacity:1;background-color:rgb(34 197 94 / var(--tw-bg-opacity, 1))}.bg-indigo-50{--tw-bg-opacity:1;background-color:rgb(238 242 255 / var(--tw-bg-opacity, 1))}.bg-indigo-500{--tw-bg-opacity:1;background-color:rgb(99 102 241 / var(--tw-bg-opacity, 1))}.bg-orange-500{--tw-bg-opacity:1;background-color:rgb(249 115 22 / var(--tw-bg-opacity, 1))}.bg-pink-50{--tw-bg-opacity:1;background-color:rgb(253 242 248 / var(--tw-bg-opacity, 1))}.bg-purple-50{--tw-bg-opacity:1;background-color:rgb(250 245 255 / var(--tw-bg-opacity, 1))}.bg-purple-500{--tw-bg-opacity:1;background-color:rgb(168 85 247 / var(--tw-bg-opacity, 1))}.bg-red-50{--tw-bg-opacity:1;background-color:rgb(254 242 242 / var(--tw-bg-opacity, 1))}.bg-red-500{--tw-bg-opacity:1;background-color:rgb(239 68 68 / var(--tw-bg-opacity, 1))}.bg-rose-500{--tw-bg-opacity:1;background-color:rgb(244 63 94 / var(--tw-bg-opacity, 1))}.bg-teal-50{--tw-bg-opacity:1;background-color:rgb(240 253 250 / var(--tw-bg-opacity, 1))}.bg-teal-500{--tw-bg-opacity:1;background-color:rgb(20 184 166 / var(--tw-bg-opacity, 1))}.bg-yellow-50{--tw-bg-opacity:1;background-color:rgb(254 252 232 / var(--tw-bg-opacity, 1))}.bg-yellow-500{--tw-bg-opacity:1;background-color:rgb(234 179 8 / var(--tw-bg-opacity, 1))}.bg-white{--tw-bg-opacity:1;background-color:rgb(255 255 255 / var(--tw-bg-opacity, 1))}.bg-yellow-400{--tw-bg-opacity:1;background-color:rgb(250 204 21 / var(--tw-bg-opacity, 1))}.bg-red-100{--tw-bg-opacity:1;background-color:rgb(254 226 226 / var(--tw-bg-opacity, 1))}.bg-green-100{--tw-bg-opacity:1;background-color:rgb(220 252 231 / var(--tw-bg-opacity, 1))}.p-2{padding:0.5rem}.p-3{padding:0.75rem}.p-4{padding:1rem}.p-6{padding:1.5rem}.px-2{padding-left:0.5rem;padding-right:0.5rem}.px-3{padding-left:0.75rem;padding-right:0.75rem}.px-4{padding-left:1rem;padding-right:1rem}.py-1{padding-top:0.25rem;padding-bottom:0.25rem}.py-2{padding-top:0.5rem;padding-bottom:0.5rem}.py-4{padding-top:1rem;padding-bottom:1rem}.py-1\.5{padding-top:0.375rem;padding-bottom:0.375rem}.pb-4{padding-bottom:1rem}.pl-4{padding-left:1rem}.pl-5{padding-left:1.25rem}.pt-4{padding-top:1rem}.pt-6{padding-top:1.5rem}.pb-1{padding-bottom:0.25rem}.pt-2{padding-top:0.5rem}.pt-3{padding-top:0.75rem}.text-center{text-align:center}.text-right{text-align:right}.font-mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}.text-2xl{font-size:1.5rem;line-height:2rem}.text-3xl{font-size:1.875rem;line-height:2.25rem}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-sm{font-size:0.875rem;line-height:1.25rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-xs{font-size:0.75rem;line-height:1rem}.font-bold{font-weight:700}.font-medium{font-weight:500}.font-semibold{font-weight:600}.text-blue-600{--tw-text-opacity:1;color:rgb(37 99 235 / var(--tw-text-opacity, 1))}.text-blue-700{--tw-text-opacity:1;color:rgb(29 78 216 / var(--tw-text-opacity, 1))}.text-blue-800{--tw-text-opacity:1;color:rgb(30 64 175 / var(--tw-text-opacity, 1))}.text-gray-500{--tw-text-opacity:1;color:rgb(107 114 128 / var(--tw-text-opacity, 1))}.text-gray-600{--tw-text-opacity:1;color:rgb(75 85 99 / var(--tw-text-opacity, 1))}.text-gray-700{--tw-text-opacity:1;color:rgb(55 65 81 / var(--tw-text-opacity, 1))}.text-green-600{--tw-text-opacity:1;color:rgb(22 163 74 / var(--tw-text-opacity, 1))}.text-green-700{--tw-text-opacity:1;color:rgb(21 128 61 / var(--tw-text-opacity, 1))}.text-green-800{--tw-text-opacity:1;color:rgb(22 101 52 / var(--tw-text-opacity, 1))}.text-indigo-600{--tw-text-opacity:1;color:rgb(79 70 229 / var(--tw-text-opacity, 1))}.text-indigo-700{--tw-text-opacity:1;color:rgb(67 56 202 / var(--tw-text-opacity, 1))}.text-indigo-800{--tw-text-opacity:1;color:rgb(55 48 163 / var(--tw-text-opacity, 1))}.text-pink-700{--tw-text-opacity:1;color:rgb(190 24 93 / var(--tw-text-opacity, 1))}.text-pink-800{--tw-text-opacity:1;color:rgb(157 23 77 / var(--tw-text-opacity, 1))}.text-purple-700{--tw-text-opacity:1;color:rgb(126 34 206 / var(--tw-text-opacity, 1))}.text-purple-800{--tw-text-opacity:1;color:rgb(107 33 168 / var(--tw-text-opacity, 1))}.text-red-700{--tw-text-opacity:1;color:rgb(185 28 28 / var(--tw-text-opacity, 1))}.text-red-600{--tw-text-opacity:1;color:rgb(220 38 38 / var(--tw-text-opacity, 1))}.text-red-800{--tw-text-opacity:1;color:rgb(153 27 27 / var(--tw-text-opacity, 1))}.text-teal-700{--tw-text-opacity:1;color:rgb(15 118 110 / var(--tw-text-opacity, 1))}.text-teal-800{--tw-text-opacity:1;color:rgb(17 94 89 / var(--tw-text-opacity, 1))}.text-white{--tw-text-opacity:1;color:rgb(255 255 255 / var(--tw-text-opacity, 1))}.text-yellow-600{--tw-text-opacity:1;color:rgb(202 138 4 / var(--tw-text-opacity, 1))}.text-yellow-700{--tw-text-opacity:1;color:rgb(161 98 7 / var(--tw-text-opacity, 1))}.text-yellow-800{--tw-text-opacity:1;color:rgb(133 77 14 / var(--tw-text-opacity, 1))}.text-blue-500{--tw-text-opacity:1;color:rgb(59 130 246 / var(--tw-text-opacity, 1))}.text-gray-400{--tw-text-opacity:1;color:rgb(156 163 175 / var(--tw-text-opacity, 1))}.text-gray-800{--tw-text-opacity:1;color:rgb(31 41 55 / var(--tw-text-opacity, 1))}.text-purple-500{--tw-text-opacity:1;color:rgb(168 85 247 / var(--tw-text-opacity, 1))}.text-yellow-900{--tw-text-opacity:1;color:rgb(113 63 18 / var(--tw-text-opacity, 1))}.text-teal-500{--tw-text-opacity:1;color:rgb(20 184 166 / var(--tw-bg-opacity, 1))}.text-cyan-600{--tw-text-opacity:1;color:rgb(8 145 178 / var(--tw-text-opacity, 1))}.shadow-sm{--tw-shadow:0 1px 2px 0 rgb(0 0 0 / 0.05);--tw-shadow-colored:0 1px 2px 0 var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow{--tw-shadow:0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 1px 3px 0 var(--tw-shadow-color), 0 1px 2px -1px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.flex-grow{flex-grow:1}.hover\:bg-blue-600:hover{--tw-bg-opacity:1;background-color:rgb(37 99 235 / var(--tw-bg-opacity, 1))}.hover\:bg-cyan-600:hover{--tw-bg-opacity:1;background-color:rgb(8 145 178 / var(--tw-bg-opacity, 1))}.hover\:bg-gray-300:hover{--tw-bg-opacity:1;background-color:rgb(209 213 219 / var(--tw-bg-opacity, 1))}.hover\:bg-gray-500:hover{--tw-bg-opacity:1;background-color:rgb(107 114 128 / var(--tw-bg-opacity, 1))}.hover\:bg-green-600:hover{--tw-bg-opacity:1;background-color:rgb(22 163 74 / var(--tw-bg-opacity, 1))}.hover\:bg-indigo-600:hover{--tw-bg-opacity:1;background-color:rgb(79 70 229 / var(--tw-bg-opacity, 1))}.hover\:bg-orange-600:hover{--tw-bg-opacity:1;background-color:rgb(234 88 12 / var(--tw-bg-opacity, 1))}.hover\:bg-purple-600:hover{--tw-bg-opacity:1;background-color:rgb(147 51 234 / var(--tw-bg-opacity, 1))}.hover\:bg-red-600:hover{--tw-bg-opacity:1;background-color:rgb(220 38 38 / var(--tw-bg-opacity, 1))}.hover\:bg-rose-600:hover{--tw-bg-opacity:1;background-color:rgb(225 29 72 / var(--tw-bg-opacity, 1))}.hover\:bg-teal-600:hover{--tw-bg-opacity:1;background-color:rgb(13 148 136 / var(--tw-bg-opacity, 1))}.hover\:bg-yellow-600:hover{--tw-bg-opacity:1;background-color:rgb(202 138 4 / var(--tw-bg-opacity, 1))}.hover\:bg-gray-100:hover{--tw-bg-opacity:1;background-color:rgb(243 244 246 / var(--tw-bg-opacity, 1))}.hover\:bg-yellow-500:hover{--tw-bg-opacity:1;background-color:rgb(234 179 8 / var(--tw-bg-opacity, 1))}.hover\:underline:hover{-webkit-text-decoration-line:underline;text-decoration-line:underline}.focus\:border-blue-300:focus{--tw-border-opacity:1;border-color:rgb(147 197 253 / var(--tw-border-opacity, 1))}.focus\:border-indigo-300:focus{--tw-border-opacity:1;border-color:rgb(165 180 252 / var(--tw-border-opacity, 1))}.focus\:ring:focus{--tw-ring-offset-shadow:var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);--tw-ring-shadow:var(--tw-ring-inset) 0 0 0 calc(3px + var(--tw-ring-offset-width)) var(--tw-ring-color);box-shadow:var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000)}.focus\:ring-blue-200:focus{--tw-ring-opacity:1;--tw-ring-color:rgb(191 219 254 / var(--tw-ring-opacity, 1))}.focus\:ring-indigo-200:focus{--tw-ring-opacity:1;--tw-ring-color:rgb(199 210 254 / var(--tw-ring-opacity, 1))}.focus\:ring-opacity-50:focus{--tw-ring-opacity:0.5}.focus\:ring-offset-0:focus{--tw-ring-offset-width:0px}
        @media (min-width: 640px){.sm\:w-auto{width:auto}.sm\:grid-cols-2{grid-template-columns:repeat(2, minmax(0, 1fr))}.sm\:flex-row{flex-direction:row}}
        @media (min-width: 768px){.md\:col-span-1{grid-column:span 1 / span 1}.md\:col-start-1{grid-column-start:1}.md\:grid-cols-2{grid-template-columns:repeat(2, minmax(0, 1fr))}.md\:grid-cols-3{grid-template-columns:repeat(3, minmax(0, 1fr))}.md\:gap-4{gap:1rem}.md\:border-l-0{border-left-width:0px}.md\:border-r{border-right-width:1px}.md\:pl-0{padding-left:0px}.md\:pr-4{padding-right:1rem}}
        @media (min-width: 1024px){.lg\:grid-cols-3{grid-template-columns:repeat(3, minmax(0, 1fr))}.lg\:grid-cols-4{grid-template-columns:repeat(4, minmax(0, 1fr))}}
    </style>
</head><body class="p-6">
<div id="auth-container" class="widget-card" style="max-width: 400px; margin: 5% auto;">
    <h2 id="auth-title">تسجيل الدخول</h2>
    <div id="auth-error" class="section-message error" style="display:none;"></div>

    <div class="form-group mb-4">
        <label for="auth-email">البريد الإلكتروني:</label>
        <input type="email" id="auth-email" class="fc-form-input">
    </div>
    <div class="form-group mb-4">
        <label for="auth-password">كلمة المرور:</label>
        <input type="password" id="auth-password" class="fc-form-input">
    </div>

    <div class="flex gap-4">
        <button id="login-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded w-full">دخول</button>
        <button id="register-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded w-full">تسجيل جديد</button>
    </div>
</div>

    <div id="main-content" class="hidden">
        <h1 class="text-3xl font-semibold text-center text-blue-600 mb-4">برنامج إدارة البضائع</h1>
        <p class="text-center text-sm text-gray-500 mb-2">البيانات المعروضة حاليًا لتاريخ: <span id="current-data-date" class="font-semibold"></span></p>
        <div id="global-message" class="section-message"></div>
        <div id="main-nav" class="flex flex-wrap justify-center gap-2 mb-6 border-b pb-4">
            <button class="nav-button active" data-target="summary-section">الملخص</button>
            <button class="nav-button" data-target="inventory-section">المخزون والإضافة</button>
            <button class="nav-button" data-target="suppliers-section">الموردين والبحث التسلسلي</button>
            <button class="nav-button" data-target="purchases-section">إدارة المشتريات</button>
            <button class="nav-button" data-target="returns-section">إدارة المرتجعات</button>
            <button class="nav-button" data-target="sell-product">بيع بضاعة / فاتورة</button>
           <button class="nav-button" data-target="liquidity-section">الخزينة والمركز المالي</button>
            <button class="nav-button" data-target="debts-section">الديون (لك)</button>
            <button class="nav-button" data-target="liabilities-section">الالتزامات (عليك)</button>
            <button class="nav-button" data-target="offsetting-section">المقاصة</button>
            <button class="nav-button" data-target="sales-report-section">تقرير المبيعات</button>
            <button class="nav-button" data-target="expenses-report-section">تقرير المصروفات</button>
            <button class="nav-button" data-target="financial-center-section">المركز المالي</button>
            <button class="nav-button" data-target="search-section">بحث الفواتير</button>
            <button class="nav-button" data-target="log-section">السجل العام</button>
            <button class="nav-button" data-target="settings-section">تحميل/حفظ/إعدادات</button>
        </div>
        <div id="undo-redo-controls" class="mb-4 flex justify-center gap-4">
    <button id="undo-button" class="bg-orange-500 hover:bg-orange-600 text-black font-bold py-2 px-4 rounded" disabled>تراجع</button>
    <button id="redo-button" class="bg-yellow-400 hover:bg-yellow-500 text-black font-bold py-2 px-4 rounded" disabled>إعادة</button>
    <div class="flex items-center justify-center p-2 bg-gray-100 rounded-lg border border-gray-200">

    <label for="auto-save-toggle" class="text-sm font-medium text-gray-700 ml-3">الحفظ التلقائي (كل 20 ثانية)</label>

    <label class="auto-save-switch">

        <input type="checkbox" id="auto-save-toggle">

        <span class="slider round"></span>

    </label>

</div>                    
</div>
        

         <div id="content-area"><section id="summary-section" class="widget-card content-section">
                <h2>الملخص المالي ورأس المال</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                        <h3 class="text-sm font-medium text-blue-700 mb-1">السيولة المتاحة</h3>
                        <div id="summary-current-liquidity" class="text-xl font-bold text-blue-800">0.00 جنيه</div>
                    </div>
                    <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-200">
                        <h3 class="text-sm font-medium text-indigo-700 mb-1">قيمة المخزون</h3>
                        <div id="summary-total-inventory-value" class="text-xl font-bold text-indigo-800">0.00 جنيه</div>
                    </div>
                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                        <h3 class="text-sm font-medium text-yellow-700 mb-1">قيمة بضاعة مؤقتة</h3>
                        <div id="summary-consignment-value-display" class="text-xl font-bold text-yellow-800">0.00 جنيه</div>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
            <h3 class="text-sm font-medium text-purple-700 mb-1">إجمالي الديون (لك)</h3>
            <div id="summary-total-debts-display" class="text-xl font-bold text-purple-800">0.00 جنيه</div>
        </div>

     <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
    <h3 class="text-sm font-medium text-purple-700 mb-1">إجمالي المشتريات (اليوم)</h3>
    <div id="summary-total-purchases" class="text-xl font-bold text-purple-800">0.00 جنيه</div>
</div>

        <div class="bg-pink-50 p-4 rounded-lg border border-pink-200">
            <h3 class="text-sm font-medium text-pink-700 mb-1">إجمالي الالتزامات (عليك)</h3>
            <div id="summary-total-liabilities-display" class="text-xl font-bold text-pink-800">0.00 جنيه</div>
        </div>

        <div class="bg-red-50 p-4 rounded-lg border border-red-200">
            <h3 class="text-sm font-medium text-red-700 mb-1">إجمالي المصروفات</h3>
            <div id="summary-total-expenses" class="text-xl font-bold text-red-800">0.00 جنيه</div>
        </div>
                    <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                        <h3 class="text-sm font-medium text-green-700 mb-1">إجمالي الربح</h3>
                        <div id="summary-total-profit" class="text-xl font-bold text-green-800">0.00 جنيه</div>
                    </div>
                    <div class="bg-teal-50 p-4 rounded-lg border border-teal-200">
                        <h3 class="text-sm font-medium text-teal-700 mb-1">رأس المال</h3>
                        <div id="summary-total-capital" class="text-xl font-bold text-teal-800">0.00 جنيه</div>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
    <h3 class="text-sm font-medium text-blue-700 mb-1">رأس المال المتوقع</h3>
    <div id="summary-expected-capital" class="text-xl font-bold text-blue-800">0.00 جنيه</div>
    
</div>
<div class="p-4 rounded-lg border shadow-sm" style="background-color: #e6fafd; border-color: #a5f3fc;">
    <h3 class="text-sm font-medium mb-1" style="color: #0891b2;">
        <i class="fas fa-undo-alt ml-1"></i> مرتجعات قيد الاستلام
    </h3>
    <div id="summary-pending-returns" class="text-xl font-bold" style="color: #164e63;">0.00 جنيه</div>
</div>

<div class="p-4 rounded-lg border shadow-sm" style="background-color: #fff7ed; border-color: #fed7aa;">
    <h3 class="text-sm font-medium mb-1" style="color: #c2410c;">
        <i class="fas fa-truck-loading ml-1"></i> مشتريات قيد الاستلام
    </h3>
    <div id="summary-pending-purchases" class="text-xl font-bold" style="color: #7c2d12;">0.00 جنيه</div>
</div>
  </div>
            </section>
           <section id="financial-center-section" class="content-section hidden">
    <div class="max-w-7xl mx-auto">
        <div class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-semibold text-gray-800">
                <i class="fas fa-landmark text-blue-600"></i>
                المركز المالي الشامل
            </h1>
            <p class="text-gray-500 mt-2">نقطة التحكم المركزية لإدارة وتحليل جميع تكاليف ومصاريف عملك.</p>
        </div>

        <div id="fc-main-tabs" class="flex flex-wrap justify-center border-b border-gray-200 mb-6 -mx-6 px-6">
            <button class="fc-tab-button active flex items-center gap-2 text-base font-semibold py-3 px-4 border-b-2 border-transparent hover:border-gray-300 hover:text-gray-600 focus:outline-none" data-target="fc-tab-distribution"><i class="fas fa-sitemap"></i><span>توزيع التكاليف</span></button>
            <button class="fc-tab-button flex items-center gap-2 text-base font-semibold py-3 px-4 border-b-2 border-transparent hover:border-gray-300 hover:text-gray-600 focus:outline-none" data-target="fc-tab-debt-treatment"><i class="fas fa-heart-broken"></i><span>معالجة الديون</span></button>
            <button class="fc-tab-button flex items-center gap-2 text-base font-semibold py-3 px-4 border-b-2 border-transparent hover:border-gray-300 hover:text-gray-600 focus:outline-none" data-target="fc-tab-expenses"><i class="fas fa-receipt"></i><span>المصاريف التشغيلية</span></button>
            <button class="fc-tab-button flex items-center gap-2 text-base font-semibold py-3 px-4 border-b-2 border-transparent hover:border-gray-300 hover:text-gray-600 focus:outline-none" data-target="fc-tab-fixed-liabilities"><i class="fas fa-calendar-alt"></i><span>الإلتزامات الثابتة</span></button>
        </div>

        <div>
            <div id="fc-tab-distribution" class="fc-tab-content">
                <div class="fc-step-card">
                    <h3><span class="fc-step-number">1</span>اختر الشهر للتحليل</h3>
                    <select id="fc-distribution-month" class="fc-form-select max-w-xs"></select>
                </div>
                <div class="fc-step-card">
                    <h3><span class="fc-step-number">2</span>حدد إجمالي التكلفة</h3>
                    <div class="space-y-4">
                        <div><label class="flex items-center p-2 rounded-md hover:bg-gray-100 cursor-pointer"><input type="radio" name="fc-cost-mode" value="auto" id="fc-auto-cost-mode-radio" class="ml-2" checked><strong>حساب التكلفة تلقائياً</strong> (من المصاريف المحددة أدناه)</label></div>
                        <div id="fc-expenses-selection-wrapper"><div id="fc-expenses-to-distribute-list" class="space-y-2 mt-2 ml-6 border-r-2 border-gray-200 pr-4"></div></div>
                        <hr class="my-4">
                        <div>
                            <label class="flex items-center p-2 rounded-md hover:bg-gray-100 cursor-pointer"><input type="radio" name="fc-cost-mode" value="manual" id="fc-manual-cost-mode-radio" class="ml-2"><strong>توزيع مبلغ تكلفة ثابت (يدوي)</strong></label>
                            <div id="fc-manual-cost-input-wrapper" class="hidden mt-2 ml-6">
                                <label for="fc-manual-cost-input" class="block text-sm font-medium text-gray-700">المبلغ الإجمالي للتوزيع</label>
                                <input type="number" id="fc-manual-cost-input" class="fc-form-input mt-1 max-w-xs" placeholder="أدخل مبلغاً ثابتاً">
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-center"><span class="text-gray-700 font-medium">إجمالي المبلغ المحدد للتوزيع: </span><strong id="fc-total-selected-expenses" class="text-blue-800 text-lg">0.00 جنيه</strong></div>
                </div>
                <div class="fc-step-card">
                    <h3><span class="fc-step-number">3</span>اختر المنتجات لتحميل التكاليف عليها</h3>
                    <div id="fc-products-to-load-list" class="space-y-2"></div>
                </div>
                <div class="fc-step-card">
                    <h3><span class="fc-step-number">4</span>اختر طريقة التوزيع</h3>
                    <div class="mt-4 space-y-3">
                        <label class="flex items-center p-3 bg-gray-50 rounded-md hover:bg-gray-100 cursor-pointer border"><input type="radio" name="fc-distribution-method" value="quantity" class="ml-3" checked>التوزيع بالتساوي على كل قطعة</label>
                        <label class="flex items-center p-3 bg-gray-50 rounded-md hover:bg-gray-100 cursor-pointer border"><input type="radio" name="fc-distribution-method" value="value" class="ml-3">التوزيع كنسبة من قيمة البضاعة</label>
                        <label class="flex items-center p-3 bg-gray-50 rounded-md hover:bg-gray-100 cursor-pointer border"><input type="radio" name="fc-distribution-method" value="manual" id="fc-distribution-manual-radio" class="ml-3">توزيع يدوي (تحديد النسب)</label>
                    </div>
                </div>
                <div id="fc-manual-distribution-container" class="fc-step-card hidden border-orange-500 bg-orange-50">
                    <h3><span class="fc-step-number bg-orange-500">!</span>تحديد نسب التوزيع اليدوي</h3>
                    <div id="fc-manual-percentage-list" class="space-y-2"></div>
                    <div class="mt-4 p-2 text-center rounded-md" id="fc-percentage-total-feedback"><span class="font-semibold">المجموع: </span><strong id="fc-percentage-total">0%</strong></div>
                </div>
                <div id="fc-cost-preview-container" class="fc-preview-card fc-step-card border-green-500 bg-green-50">
                    <h3 class="text-green-800 border-green-300"><span class="fc-step-number bg-green-600">✓</span>محاكاة النتائج</h3>
                    <div id="fc-cost-preview-results" class="space-y-3 text-gray-700"></div>
                    <div class="mt-6 border-t border-green-300 pt-4 text-center">
                        <p class="text-sm text-green-700 mb-3">عند الضغط على "تنفيذ"، سيتم تحديث متوسط تكلفة هذه المنتجات بشكل دائم في بيانات اليوم الحالي.</p>
                        <button id="fc-execute-distribution-btn" class="w-full md:w-auto bg-green-500 text-white font-bold py-2 px-6 rounded-md hover:bg-green-600 focus:outline-none">تنفيذ وتحديث التكاليف</button>
                    </div>
                </div>
            </div>
            
            <div id="fc-tab-debt-treatment" class="fc-tab-content hidden">
                 <div class="fc-step-card">
                    <h3><span class="fc-step-number">1</span>اختر الدين المتعثر للمعالجة</h3>
                    <p class="text-xs text-gray-500 mb-2">هذه الميزة تقوم بتحويل دين متعثر إلى التزام شهري ثابت ليتم توزيعه على المنتجات مستقبلاً.</p>
                    <select id="fc-debt-to-process" class="fc-form-select"></select>
                </div>
                <div class="fc-step-card">
                    <h3><span class="fc-step-number">2</span>حدد فترة توزيع التكلفة</h3>
                    <div class="grid md:grid-cols-2 gap-4 items-center">
                        <input type="number" id="fc-distribution-period-value" class="fc-form-input" value="3" min="1">
                        <select id="fc-distribution-period-unit" class="fc-form-select">
                            <option value="months">شهور</option>
                        </select>
                    </div>
                </div>
                 <div class="mt-6 text-center">
                    <button id="fc-execute-debt-treatment-btn" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 text-lg">تحويل الدين إلى التزام شهري</button>
                 </div>
            </div>

           <div id="fc-tab-expenses" class="fc-tab-content hidden">
    <div id="total-expenses" class="text-2xl font-bold text-red-700 mb-4">0.00 جنيه</div>
    
    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- إضافة مصروف -->
        <div>
            <div class="form-group mb-2">
                <label for="expense-payment-account" class="block text-gray-700 text-sm font-bold mb-1">خصم من حساب:</label>
                <select id="expense-payment-account" class="shadow-sm"></select>
            </div>
            <label for="add-expense" class="block text-gray-700 text-sm font-bold mb-2">إضافة مصروف:<span class="required">*</span></label>
            <input type="number" id="add-expense" value="0" min="0.01" step="0.01" class="shadow-sm">
            <button id="add-expense-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded mt-2 w-full">إضافة</button>
        </div>

        <!-- تقليل مصروف -->
        <div>
            <div class="form-group mb-2">
                <label for="expense-refund-account" class="block text-gray-700 text-sm font-bold mb-1">إرجاع المبلغ إلى حساب:</label>
                <select id="expense-refund-account" class="shadow-sm"></select>
            </div>
            <label for="remove-expense" class="block text-gray-700 text-sm font-bold mb-2">تقليل مصروف:<span class="required">*</span></label>
            <input type="number" id="remove-expense" value="0" min="0.01" step="0.01" class="shadow-sm">
            <button id="remove-expense-button" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded mt-2 w-full">تقليل</button>
        </div>
    </div>

    <div id="expenses-message" class="section-message mt-3"></div>
</div>

            <div id="fc-tab-fixed-liabilities" class="fc-tab-content hidden">
                <fieldset class="mb-6 pb-4 border-b">
                    <legend>إدارة الالتزامات الشهرية الثابتة</legend>
                    <p class="text-xs text-gray-500 mb-3">أضف هنا الالتزامات التي تتكرر كل شهر (مثل الإيجار والرواتب). سيقوم البرنامج بإضافتها تلقائياً إلى قائمة "الالتزامات (عليك)" في بداية كل شهر جديد.</p>
                    <div id="add-update-monthly-liability-form">
                        <h4 id="monthly-liability-form-title" class="text-md font-semibold mb-2">إضافة التزام شهري جديد</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                            <div class="form-group">
                                <label for="monthly-liability-name" class="block text-sm font-bold mb-1">اسم الالتزام:<span class="required">*</span></label>
                                <input type="text" id="monthly-liability-name" placeholder="مثال: إيجار المحل" class="shadow-sm">
                            </div>
                            <div class="form-group">
                                <label for="monthly-liability-amount" class="block text-sm font-bold mb-1">المبلغ الشهري:<span class="required">*</span></label>
                                <input type="number" id="monthly-liability-amount" placeholder="0.00" min="0.01" step="0.01" class="shadow-sm">
                            </div>
                            <div class="form-group">
                                <button id="add-monthly-liability-button" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded">إضافة / تحديث</button>
                            </div>
                        </div>
                        <button id="cancel-edit-monthly-liability-button" class="text-xs bg-gray-400 hover:bg-gray-500 text-white font-bold py-1 px-2 rounded mt-2 hidden">إلغاء التعديل</button>
                        <div id="monthly-liability-message" class="section-message mt-3"></div>
                    </div>
                    <div class="mt-4 border-t pt-4">
                        <h4 class="text-md font-semibold mb-2">الالتزامات الشهرية المسجلة حالياً:</h4>
                        <ul id="monthly-liabilities-list" class="space-y-2">
                            <li class="text-center text-gray-500">لا توجد التزامات شهرية مسجلة.</li>
                        </ul>
                    </div>
                </fieldset>
            </div>
        </div>
    </div>
</section>
            <section id="inventory-section" class="widget-card content-section hidden">
                <div id="add-update-product-form">
                    <h2 id="product-form-title">إضافة / تحديث بضاعة</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="mb-4">
                            <label for="product-name" class="block text-gray-700 text-sm font-bold mb-2">اسم البضاعة:<span class="required">*</span></label>
                            <input type="text" id="product-name" placeholder="اسم المنتج" class="shadow-sm" list="product-names-list">
                            <datalist id="product-names-list"></datalist>
                        </div>
                        <div class="mb-4">
                            <label for="product-quantity" class="block text-gray-700 text-sm font-bold mb-2">الكمية:<span class="required">*</span></label>
                            <input type="number" id="product-quantity" value="0" min="0" class="shadow-sm">
                            <p class="text-xs text-gray-500 mt-1">عند الإضافة: الكمية المضافة. عند التعديل: الكمية الجديدة الكلية.</p>
                        </div>
                        <div class="mb-4">
                            <label for="product-cost-price" class="block text-gray-700 text-sm font-bold mb-2">سعر التكلفة (للوحدة):<span class="required">*</span></label>
                            <input type="number" id="product-cost-price" value="0" min="0" step="0.01" class="shadow-sm">
                            <p class="text-xs text-gray-500 mt-1">عند الإضافة: يتم حساب المتوسط. عند التعديل: يتم استبدال السعر.</p>
                        </div>
                        <div class="mb-4">
                            <label for="product-supplier" class="block text-gray-700 text-sm font-bold mb-2">المورد (اختياري):</label>
                            <select id="product-supplier" class="shadow-sm">
                                <option value="">-- اختر المورد --</option>
                                </select>
                        </div>
                        <div class="mb-4">
    <label for="product-supplier" class="block text-gray-700 text-sm font-bold mb-2">المورد (اختياري):</label>
    <select id="product-supplier" class="shadow-sm">
        <option value="">-- اختر المورد --</option>
    </select>
</div>

<div class="mb-4">
    <label for="product-category" class="block text-gray-700 text-sm font-bold mb-2">القسم (اختياري):</label>
    <input type="text" id="product-category" placeholder="مثال: اكسسوارات، شاشات" class="shadow-sm" list="category-names-list">
    <datalist id="category-names-list"></datalist>
</div>
<div class="mb-4 col-span-full md:col-span-1">
    <label for="product-deduct-liquidity" class="inline-flex items-center cursor-pointer mt-2">
                         <div class="mb-4 col-span-full md:col-span-1">
                            <label for="product-deduct-liquidity" class="inline-flex items-center cursor-pointer mt-2">
                                <input type="checkbox" id="product-deduct-liquidity" class="rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-offset-0 focus:ring-indigo-200 focus:ring-opacity-50 ml-2">
                                <span class="text-sm text-gray-700 font-medium">خصم تكلفة البضاعة المضافة من السيولة؟</span>
                            </label>
                            <p class="text-xs text-gray-500 mt-1">سيتم خصم تكلفة الكمية *المضافة* فقط.</p>
                            <div id="product-purchase-account-container" class="form-group mt-2 hidden">
    <label for="product-purchase-account" class="block text-sm font-bold mb-1">خصم من حساب:</label>
    <select id="product-purchase-account" class="shadow-sm"></select>
</div>
                        </div>
                        <div id="serial-number-entry-container" class="mb-4 col-span-full hidden">
                            <div class="flex justify-between items-center mb-2 flex-wrap gap-2">
                                <label for="product-serial-numbers" class="block text-gray-700 text-sm font-bold">
                                    الأرقام التسلسلية (اختياري - كل رقم في سطر، أو مفصولة بفاصلة/مسافة):
                                </label>
                                <label for="import-serial-csv-input" class="button-like bg-teal-500 hover:bg-teal-600 text-white text-xs py-1 px-3 rounded-md cursor-pointer">
                                    استيراد من ملف CSV
                                </label>
                                <input type="file" id="import-serial-csv-input" accept=".csv,.txt">
                            </div>
                            <textarea id="product-serial-numbers" rows="4" class="shadow-sm w-full font-mono text-sm" placeholder="SN12345&#10;SN12346, SN12347 SN12348..."></textarea>
                            <p class="text-xs text-gray-500 mt-1">إذا أدخلت سيريالات، يجب أن يتطابق عددها مع الكمية المضافة.</p>
                            <div id="serial-import-message" class="section-message text-xs mt-2"></div>
                        </div>
                        <div class="col-span-full flex flex-wrap gap-2 items-center">
                           <button id="add-product-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">إضافة/تحديث البضاعة</button>
                           <button id="cancel-edit-product-button" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded hidden">إلغاء التعديل</button>
                       </div>
                       <div id="product-message" class="section-message mt-3 col-span-full"></div>
                   </div>
                </div>

                <div class="mt-8 border-t pt-6">
                    <h3 class="sub-heading">قائمة البضائع المتوفرة</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div id="inventory-total-inventory-value" class="text-lg font-semibold text-indigo-600">إجمالي قيمة المخزون: 0.00 جنيه</div>
                        <div id="inventory-consignment-value-display" class="text-lg font-semibold text-yellow-600">قيمة مؤقتة: 0.00 جنيه</div>
                        <div id="inventory-total-profit" class="text-lg font-semibold text-green-600">إجمالي الربح: 0.00 جنيه</div>
                    </div>
                    <div id="inventory-controls" class="grid grid-cols-1 md:grid-cols-2 gap-4 my-4 p-4 bg-gray-50 rounded-lg border">
    <div class="form-group">
        <label for="inventory-search" class="block text-sm font-medium text-gray-700 mb-1">بحث بالاسم:</label>
        <input type="text" id="inventory-search" placeholder="ابحث عن منتج..." class="shadow-sm">
    </div>
    <div class="form-group">
        <label for="inventory-category-filter" class="block text-sm font-medium text-gray-700 mb-1">تصفية بالقسم:</label>
        <select id="inventory-category-filter" class="shadow-sm">
            <option value="all">كل الأقسام</option>
            </select>
    </div>
    </div>

                    <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <p class="text-center text-gray-500 col-span-full">لا توجد بضائع حتى الآن.</p>
                    </div>
                </div>
            </section>
            <!-- ======================================================= -->
<!-- START: Purchases Section -->
<!-- ======================================================= -->
<section id="purchases-section" class="widget-card content-section hidden">
    <h2>إدارة المشتريات (فواتير الشراء)</h2>
    <p class="text-sm text-gray-500 mb-4">
        استخدم هذا القسم لتسجيل فواتير الشراء الجديدة. عند تأكيد الفاتورة، سيتم تحديث المخزون والالتزامات والسيولة تلقائياً.
    </p>

    <!-- === Form to Add/Update Purchase Invoice === -->
    <div id="add-update-purchase-invoice-form" class="mb-6 pb-4 border-b">
        <h3 id="purchase-invoice-form-title" class="text-lg font-medium text-gray-700 mb-3">فاتورة شراء جديدة</h3>

        <!-- Supplier and Invoice Info -->
        <fieldset class="mb-4">
            <legend>البيانات الأساسية</legend>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="form-group">
                    <label for="pi_supplier" class="block text-sm font-bold mb-1">اختر المورد:<span class="required">*</span></label>
                  <select id="pi_supplier" class="shadow-sm"></select>


                </div>
                <div class="form-group">
                    <label for="pi_invoice_number" class="block text-sm font-bold mb-1">رقم فاتورة المورد:</label>
                    <input type="text" id="pi_invoice_number" placeholder="(اختياري)" class="shadow-sm">
                </div>
                <div class="form-group">
                    <label for="pi_date" class="block text-sm font-bold mb-1">تاريخ الفاتورة:<span class="required">*</span></label>
                    <input type="date" id="pi_date" class="shadow-sm">
                </div>
            </div>
        </fieldset>

        <!-- Items Section -->
        <fieldset>
            <legend>بنود الفاتورة</legend>
            <div id="pi_items_container">
                <!-- Table for items -->
                <table id="pi_items_table" class="w-full border-collapse mt-2">
                    <thead>
                        <tr>
                            <th class="border p-2 bg-gray-50">اسم المنتج</th>
                            <th class="border p-2 bg-gray-50 w-24">الكمية</th>
                            <th class="border p-2 bg-gray-50 w-32">سعر الوحدة</th>
                            <th class="border p-2 bg-gray-50 w-32">الإجمالي</th>
                            <th class="border p-2 bg-gray-50 w-16 no-print">إجراء</th>
                        </tr>
                    </thead>
                    <tbody id="pi_items_body">
                        <!-- Items will be added here via JS -->
                    </tbody>
                </table>
                 <p id="pi_no_items_msg" class="text-center text-gray-500 my-4">لم يتم إضافة أي بنود بعد.</p>

                <!-- Form to add a new item -->
                <div class="add-item-section mt-4 no-print">
                    <h4 class="text-md font-semibold mb-2">إضافة بند جديد للفاتورة</h4>
                  <div class="grid grid-cols-1 md:grid-cols-6 gap-3 items-end"> 
    <div class="form-group md:col-span-2">
        <label for="pi_item_name">اسم المنتج:<span class="required">*</span></label>
        <input type="text" id="pi_item_name" list="product-names-list" placeholder="اكتب اسم المنتج">
    </div>
    
    <div class="form-group">
        <label for="pi_item_category">الفئة:</label>
        <input type="text" id="pi_item_category" list="category-names-list" placeholder="القسم">
    </div>

    <div class="form-group">
        <label for="pi_item_quantity">الكمية:<span class="required">*</span></label>
        <input type="number" id="pi_item_quantity" value="1" min="1" step="1">
    </div>

    <div class="form-group">
        <label for="pi_item_cost">سعر الوحدة:<span class="required">*</span></label>
        <input type="number" id="pi_item_cost" value="0" min="0" step="0.01">
    </div>

    <div class="form-group">
        <label for="pi_item_total_cost">السعر الإجمالي:</label>
        <input type="number" id="pi_item_total_cost" value="0" min="0" step="0.01" style="background-color: #f0fdf4; border-color: #86efac;">
    </div>
</div>
                    <div class="form-group mt-2 hidden" id="pi_item_serials_container">
                        <label for="pi_item_serials">الأرقام التسلسلية (كل رقم في سطر):</label>
                        <textarea id="pi_item_serials" rows="3" class="font-mono text-sm" placeholder="SN-001\nSN-002..."></textarea>
                    </div>
                    <div class="mt-3 flex items-center justify-between">
                         <button type="button" id="pi_add_item_btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">إضافة البند</button>
                         <div id="pi_item_add_message" class="section-message text-sm"></div>
                    </div>
                </div>
            </div>
        </fieldset>

        <!-- Totals and Payment Section -->
        <div class="mt-4 mb-4 border rounded-lg bg-white overflow-hidden">
    <div class="bg-gray-50 px-4 py-2 border-b flex justify-between items-center">
        <h3 class="font-bold text-gray-700 text-sm">التكاليف الإضافية </h3>
        <button type="button" onclick="window.pi_addExtraCostRow()" class="text-blue-600 hover:text-blue-800 text-xs font-bold flex items-center bg-blue-50 px-2 py-1 rounded border border-blue-200 hover:bg-blue-100 transition">
            <span class="text-lg leading-none mr-1">+</span> إضافة بند
        </button>
    </div>
    
    <div id="pi_additional_costs_container" class="divide-y divide-gray-100">
        </div>
    
    <div id="pi_no_extra_costs_msg" class="text-center text-gray-400 text-xs py-2">
        لا توجد تكاليف إضافية مضافة.
    </div>
</div>
       <fieldset class="mt-4">
    <legend>المدفوعات والإجمالي</legend>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-start">
       <div class="space-y-2 p-4 bg-gray-50 rounded-lg border">
    <div class="flex justify-between font-semibold text-gray-600">
        <span>إجمالي الفاتورة (شامل):</span>
        <span id="pi_grand_total" class="font-mono">0.00 جنيه</span>
    </div>

    <div class="flex justify-between font-bold text-blue-700 border-b pb-2 mb-2">
        <span>المطلوب دفعه نقداً:</span>
        <span id="pi_cash_required" class="font-mono">0.00 جنيه</span>
    </div>

    <div class="flex justify-between">
        <span>المبلغ المدفوع فعلياً:</span>
        <span id="pi_paid_amount_display" class="font-mono text-green-600">0.00 جنيه</span>
    </div>

    <div class="flex justify-between font-bold text-lg border-t pt-2 mt-2">
        <span>المبلغ المتبقي:</span>
        <span id="pi_remaining_balance" class="font-mono text-red-600">0.00 جنيه</span>
    </div>
</div>

        <div class="form-group md:col-span-2">
            <label for="pi_paid_amount" class="block text-sm font-bold mb-1">المبلغ المدفوع (العربون):<span class="required">*</span></label>
            <input type="number" id="pi_paid_amount" value="0" min="0" step="0.01" class="shadow-sm">
            <p class="text-xs text-gray-500 mt-1">أدخل 0 إذا كانت الفاتورة آجلة بالكامل.</p>
            
            <label for="pi_deduct_from_liquidity" class="inline-flex items-center cursor-pointer mt-3">
                <input type="checkbox" id="pi_deduct_from_liquidity" class="rounded border-gray-300 text-blue-600 shadow-sm ml-2" checked>
                <span class="text-sm text-gray-700 font-medium">خصم المبلغ المدفوع من السيولة الآن؟</span>
                <div id="pi-payment-account-container" class="form-group mt-2">
    <label for="pi_payment_account" class="block text-sm font-bold mb-1">خصم من حساب:</label>
    <select id="pi_payment_account" class="shadow-sm"></select>
</div>
            </label>
            
        </div>
    </div>
</fieldset>
    </div>
<div class="my-4 p-3 bg-yellow-50 border border-yellow-200 rounded-md">
    <label for="pi_goods_received" class="inline-flex items-center cursor-pointer font-semibold">
        <input type="checkbox" id="pi_goods_received" class="rounded border-gray-300 text-blue-600 shadow-sm ml-2" checked>
        <span class="text-sm text-yellow-900">استلام البضاعة الآن؟ (سيتم تحديث المخزون والسيولة)</span>
    </label>
    <p class="text-xs text-gray-600 mt-1">إذا لم تحدد هذا الخيار، سيتم تسجيل الفاتورة كـ "شراء قيد الاستلام" دون التأثير على المخزون حاليًا.</p>
</div>
    <!-- === Action Buttons === -->
    <div class="flex flex-wrap gap-4 items-center">
        <button id="pi_confirm_btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded">
            تأكيد الفاتورة وإدخال البضاعة
        </button>
        <button id="pi_save_draft_btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded">
            حفظ كمسودة
        </button>
        <button id="pi_clear_form_btn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded">
            فاتورة جديدة
        </button>
        <div id="pi_form_message" class="section-message flex-grow"></div>
    </div>

    <!-- === List of recent purchase invoices === -->
    <div id="recent-purchases-container" class="mt-8 border-t pt-6">
        <h3 class="text-lg font-medium text-gray-700 mb-3">فواتير الشراء المسجلة لليوم الحالي</h3>
        <div id="recent-purchases-list">
            <p class="text-center text-gray-500">لا توجد فواتير شراء مسجلة لهذا اليوم بعد.</p>
        </div>
        <div id="pending-purchases-container" class="mt-8 border-t pt-6">
    <h3 class="text-lg font-medium text-yellow-700 mb-3">مشتريات قيد الاستلام</h3>
    <div id="pending-purchases-list">
        <p class="text-center text-gray-500">لا توجد فواتير شراء معلقة حاليًا.</p>
    </div>
</div>
<div id="pending-purchase-payment-form" class="hidden mt-4 p-4 border-t-4 border-purple-500 bg-purple-50 rounded-md shadow">
    <h4 class="text-md font-semibold text-purple-800">تسديد المتبقي لفاتورة معلقة</h4>
    <p class="text-sm text-gray-600">المورد: <strong id="pp-payment-supplier-name"></strong></p>
    <p class="text-sm text-gray-600 mb-2">المبلغ المتبقي: <strong id="pp-payment-remaining-amount" class="font-mono"></strong></p>
    
    <div class="form-group">
        <label for="pending-purchase-payment-account" class="block text-sm font-bold mb-1">اختر حساب الدفع:</label>
        <select id="pending-purchase-payment-account" class="shadow-sm"></select>
    </div>
    
    <div class="flex gap-2 mt-3">
        <button id="pp-confirm-payment-btn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-3 rounded text-sm">تأكيد الاستلام والدفع</button>
        <button id="pp-cancel-payment-btn" type="button" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-3 rounded text-sm">إلغاء</button>
    </div>
    <div id="pp-payment-message" class="section-message mt-2"></div>
</div>
    </div>
</section>
<!-- ======================================================= -->
<!-- END: Purchases Section -->
<!-- ======================================================= -->
            <section id="suppliers-section" class="widget-card content-section hidden">
                <h2>الموردين والبحث التسلسلي</h2>
                <div id="add-update-supplier-form" class="mb-6 pb-4 border-b">
                    <h3 id="supplier-form-title" class="text-lg font-medium text-gray-700 mb-3">إضافة مورد جديد</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="mb-4">
                            <label for="supplier-name" class="block text-gray-700 text-sm font-bold mb-2">اسم المورد:<span class="required">*</span></label>
                            <input type="text" id="supplier-name" placeholder="اسم الشركة أو الشخص" class="shadow-sm">
                        </div>
                        <div class="mb-4">
                            <label for="supplier-contact" class="block text-gray-700 text-sm font-bold mb-2">معلومات الاتصال:</label>
                            <input type="text" id="supplier-contact" placeholder="رقم هاتف، بريد إلكتروني..." class="shadow-sm">
                        </div>
                        <div class="mb-4">
                            <label for="supplier-address" class="block text-gray-700 text-sm font-bold mb-2">العنوان:</label>
                            <input type="text" id="supplier-address" placeholder="عنوان المورد" class="shadow-sm">
                        </div>
                    </div>
                    <button id="add-supplier-button" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded">إضافة / تحديث المورد</button>
                    <button id="cancel-edit-supplier-button" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded hidden ml-2">إلغاء التعديل</button>
                    <div id="supplier-message" class="section-message mt-3"></div>
                </div>

                <div id="suppliers-list-container">
                    <h3 class="text-lg font-medium text-gray-700 mb-3">قائمة الموردين الحاليين</h3>
                    <div id="supplier-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <p class="text-center text-gray-500 col-span-full">لا يوجد موردين مسجلين بعد.</p>
                    </div>
                </div>

                <div id="serial-search-container" class="mt-8 border-t pt-6">
                    <h3 class="text-lg font-medium text-gray-700 mb-3">البحث عن الأرقام التسلسلية لمورد</h3>
                     <div class="flex flex-col sm:flex-row justify-start items-end gap-4 mb-4">
                        <div>
                            <label for="search-supplier-serial-name" class="block text-gray-700 text-sm font-bold mb-1">اسم المورد:<span class="required">*</span></label>
                            <input type="text" id="search-supplier-serial-name" list="supplier-names-list" placeholder="اكتب اسم المورد" class="shadow-sm w-full sm:w-auto">
                            <datalist id="supplier-names-list"></datalist>
                        </div>
                        <button id="search-supplier-serials-btn" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded w-full sm:w-auto">
                            بحث السيريالات
                        </button>
                    </div>
                    <div id="serial-search-message" class="section-message text-sm mb-4"></div>
                    <div id="filter-serials-container" class="mb-3 hidden">
                         <label for="filter-serials-input" class="block text-gray-700 text-sm font-bold mb-1">تصفية السيريالات المعروضة:</label>
                         <input type="text" id="filter-serials-input" placeholder="ابحث برقم السيريال..." class="shadow-sm w-full sm:w-1/2">
                    </div>
                    <div id="supplier-serials-results">
                        <p class="text-center text-gray-500">أدخل اسم المورد واضغط "بحث السيريالات".</p>
                    </div>
                </div>
            </section>

            <section id="sell-product" class="widget-card content-section hidden">
                <div>
                    <h2>بيع بضاعة (سريع / مؤقت)</h2>
                    <p class="text-sm text-gray-500 mb-4">للبيع السريع أو المؤقت بدون فاتورة تفصيلية. لإنشاء فاتورة مفصلة، استخدم الزر الأخضر أدناه.</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="mb-4">
                            <label for="sell-product-name" class="block text-gray-700 text-sm font-bold mb-2">اسم البضاعة المباعة:<span class="required">*</span></label>
                            <input type="text" id="sell-product-name" placeholder="اسم المنتج الرئيسي" list="product-names-list" class="shadow-sm">
                            </div>
                        <div class="mb-4">
                            <label for="sell-customer-name" class="block text-gray-700 text-sm font-bold mb-2">اسم العميل:</label>
                            <input type="text" id="sell-customer-name" placeholder="اسم العميل (اختياري)" class="shadow-sm">
                        </div>
                        <div class="mb-4">
                            <label for="sell-quantity" class="block text-gray-700 text-sm font-bold mb-2">الكمية المباعة:<span class="required">*</span></label>
                            <input type="number" id="sell-quantity" value="1" min="1" class="shadow-sm">
                        </div>
                        <div id="sell-serial-container" class="mb-4 hidden">
    <label for="sell-serial-input" class="block text-gray-700 text-sm font-bold mb-2">الرقم التسلسلي (للمنتج المحدد):</label>
    <input type="text" id="sell-serial-input" list="sell-serials-datalist" placeholder="اختر او اكتب السيريال" class="shadow-sm">
    <datalist id="sell-serials-datalist"></datalist>
    <p class="text-xs text-blue-500 mt-1">هذا المنتج يتطلب تحديد سيريال.</p>
</div>

                      

                        <div class="mb-4 md:col-start-1">
                            <label for="sell-price" class="block text-gray-700 text-sm font-bold mb-2">إجمالي سعر البيع:<span class="required">*</span></label>
                            <input type="number" id="sell-price" value="0" min="0" step="0.01" placeholder="السعر الإجمالي للكمية" class="shadow-sm">
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">خصم تكاليف إضافية (للحزم أو المرفقات):</label>
                        <div id="additional-costs-container">
                            <p class="text-center text-gray-500 text-sm">أدخل اسم المنتج الرئيسي لعرض المرفقات المتاحة.</p>
                        </div>
                    </div>
                    <div class="mt-4">
                        <label for="sell-pending" class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="sell-pending" class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-offset-0 focus:ring-blue-200 focus:ring-opacity-50 ml-2">
                            <span class="text-sm text-gray-700 font-medium">بيع مؤقت (تحت التسوية)</span>
                        </label>
                    </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
    <div class="form-group">
        <label for="sell-account-select" class="block text-gray-700 text-sm font-bold mb-1">إيداع في حساب:</label>
        <select id="sell-account-select" class="shadow-sm"></select>
    </div>
    <div class="form-group">
        <label for="sell-paid-amount" class="block text-blue-700 text-sm font-bold mb-1">المبلغ المدفوع كاش:</label>
        <input type="number" id="sell-paid-amount" placeholder="اتركه فارغاً للدفع الكامل" 
               class="shadow-sm border-blue-200 w-full" oninput="window.updateQuickSaleDebt()">
        
        <div id="quick-sale-debt-container" class="mt-2 text-xs font-bold text-red-600 hidden">
            المتبقي كدين: <span id="quick-sale-remaining-debt">0.00</span> جنيه
        </div>
    </div>
</div>
                    <div class="flex flex-wrap gap-4 mt-6">
                        <button id="sell-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">بيع البضاعة (سريع/مؤقت)</button>
                        <button id="cancel-edit-pending-button" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded hidden">إلغاء التعديل</button>
                        <button type="button" id="openInvoiceModalBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">إنشاء فاتورة بيع مفصلة</button>
                    </div>
                    <div id="sell-message" class="section-message mt-3"></div>
                </div>

                <div id="pending-sales-container" class="mt-8 border-t pt-6">
                    <h3 class="sub-heading">المبيعات المؤقتة الحالية</h3>

                    <div id="pending-sales-controls" class="flex flex-wrap gap-4 mb-4 items-center border-b pb-4">
                        <div id="pending-sales-search-group" class="flex-grow min-w-[250px]">
                            <label for="pending-sales-search-input" class="block text-sm font-medium text-gray-600 mb-1">بحث في المبيعات المؤقتة:</label>
                            <input type="text" id="pending-sales-search-input" placeholder="ابحث بالاسم أو المنتج..." class="shadow-sm text-sm p-2">
                        </div>
                        <div id="pending-sales-totals-group" class="flex-shrink-0 space-x-4 space-x-reverse text-sm font-semibold">
                            <span>الإجمالي:</span>
                            <span id="pending-sales-total-cost" class="text-purple-600">التكلفة: 0.00 جنيه</span>
                            <span id="pending-sales-total-profit" class="text-green-600">الربح المتوقع: 0.00 جنيه</span>
                        </div>
                    </div>
                     <div id="pending-sales-list">
                        <p class="text-center text-gray-500 text-sm">لا توجد مبيعات مؤقتة حاليًا.</p>
                    </div>
                </div>
            </section><section id="liquidity-section" class="widget-card content-section hidden">
                 <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid #e5e7eb;">
        <i class="fas fa-university" style="font-size: 1.5rem; color: #1d4ed8;"></i>
        <h2 style="margin: 0; border: none; padding: 0;">الخزينة والمركز المالي</h2>
    </div>

    <div id="safes-overview-grid">
        <p class="text-center text-gray-500">جاري تحميل أرصدة الحسابات...</p>
    </div>

   <!-- Action Tabs -->
<div class="action-tabs">
    <button id="tab-daily" class="active" data-target="daily-actions">الحركات اليومية</button>
    <button id="tab-adjust" data-target="adjustments">التسويات والتعديلات</button>
    <button id="tab-manage" data-target="manage-accounts">إدارة الحسابات</button>
</div>

    <div id="tab-content">
        <div id="daily-actions">
            <div class="liquidity-actions-grid">
                <div class="action-column" style="border-top: 4px solid #16a34a;">
                    <h3><i class="fas fa-plus-circle" style="color: #16a34a;"></i> إضافة إيراد</h3>
                    <div class="form-group">
                        <label for="income-safe-select">إلى حساب:</label>
                        <select id="income-safe-select"></select>
                    </div>
                    <div class="form-group">
                        <label for="income-category-select">فئة الإيراد:</label>
                        <select id="income-category-select">
                            <option>مبيعات نقدية</option>
                            <option>تحصيل ديون</option>
                            <option>إيداع شخصي / استثمار</option>
                            <option>إيرادات أخرى</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="income-amount-input">المبلغ:</label>
                        <input type="number" id="income-amount-input" placeholder="0.00">
                    </div>
                    <button id="add-income-btn" style="background-color: #22c55e;">إضافة الإيراد</button>
                </div>
                <div class="action-column" style="border-top: 4px solid #dc2626;">
                    <h3><i class="fas fa-minus-circle" style="color: #dc2626;"></i> صرف مصروف</h3>
                    <div class="form-group">
                        <label for="expense-safe-select">من حساب:</label>
                        <select id="expense-safe-select"></select>
                    </div>
                    <div class="form-group">
                        <label for="expense-category-select">فئة المصروف:</label>
                        <select id="expense-category-select">
                            <option>مشتريات بضاعة</option>
                            <option>إيجار</option>
                            <option>رواتب</option>
                            <option>فواتير (كهرباء/مياه)</option>
                            <option>سحب شخصي</option>
                            <option>مصروفات أخرى</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="expense-amount-input">المبلغ:</label>
                        <input type="number" id="expense-amount-input" placeholder="0.00">
                    </div>
                    <button id="add-expense-btn" style="background-color: #ef4444;">صرف المبلغ</button>
                </div>
                <div class="action-column" style="border-top: 4px solid #f59e0b;">
                    <h3><i class="fas fa-exchange-alt" style="color: #f59e0b;"></i> تحويل بين الحسابات</h3>
                    <div class="form-group">
                        <label for="transfer-from-select">من حساب:</label>
                        <select id="transfer-from-select"></select>
                    </div>
                    <div class="form-group">
                        <label for="transfer-to-select">إلى حساب:</label>
                        <select id="transfer-to-select"></select>
                    </div>
                    <div class="form-group">
                        <label for="transfer-amount-input">المبلغ:</label>
                        <input type="number" id="transfer-amount-input" placeholder="0.00">
                    </div>
                    <button id="transfer-btn" style="background-color: #f97316;">تنفيذ التحويل</button>
                </div>
            </div>
        </div>

        <div id="adjustments" class="hidden">
             <div class="action-column" style="border-top: 4px solid #6366f1; max-width: 400px;">
                <h3><i class="fas fa-magic" style="color: #6366f1;"></i> تعديل رصيد يدوي</h3>
                <p style="font-size: 0.8rem; color: #6b7280; margin-top: -0.5rem; margin-bottom: 1rem;">استخدم هذا الخيار بحذر لتصحيح الأرصدة أو إدخال الرصيد الافتتاحي.</p>
                <div class="form-group">
                    <label for="adjust-safe-select">اختر الحساب للتعديل:</label>
                    <select id="adjust-safe-select"></select>
                </div>
                <div class="form-group">
                    <label for="adjust-amount-input">الرصيد **الجديد**:</label>
                    <input type="number" id="adjust-amount-input" placeholder="أدخل الرصيد الصحيح">
                </div>
                 <div class="form-group">
                    <label for="adjust-reason-input">سبب التعديل:</label>
                    <input type="text" id="adjust-reason-input" placeholder="مثال: رصيد افتتاحي، تصحيح خطأ">
                </div>
                <button id="adjust-liquidity-button" style="background-color: #818cf8;">تنفيذ التعديل</button>
            </div>
        </div>

        <div id="manage-accounts" class="hidden">
            <div id="accounts-list-container">
                <h3 class="sub-heading" style="margin-top:0;">الحسابات الحالية</h3>
                <ul id="accounts-list">
                    </ul>
            </div>
            <form id="account-form">
                <h3 id="account-form-title">إضافة حساب جديد</h3>
                <input type="hidden" id="account-id-input">
                <div class="form-group">
                    <label for="account-name-input">اسم الحساب:</label>
                    <input type="text" id="account-name-input" required placeholder="مثال: محفظة إلكترونية">
                </div>
                <div class="form-group" id="starting-balance-group">
                    <label for="account-balance-input">الرصيد الافتتاحي:</label>
                    <input type="number" id="account-balance-input" value="0" placeholder="0.00">
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button id="save-account-btn" type="submit" style="background-color: #2563eb;">حفظ الحساب</button>
                    <button id="cancel-edit-account-btn" type="button" class="hidden" style="background-color: #6b7280;">إلغاء التعديل</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="liquidity-log-advanced-container">
        <h3 class="sub-heading">السجل المالي المفصل</h3>
        <ul id="liquidity-log-list" style="max-height: 400px; overflow-y: auto;">
             <p class="text-center text-gray-500">لا توجد حركات مسجلة.</p>
        </ul>
    </div>
            </section>
            <section id="debts-section" class="widget-card content-section hidden">
                <h2>الديون (المستحقة للشركة)</h2>
                <div id="total-debts-display" class="text-2xl font-bold text-purple-700 mb-4">إجمالي الديون: 0.00 جنيه</div>

                <div class="mb-6 pb-4 border-b">
                    <h3 class="text-lg font-medium text-gray-700 mb-3">تسجيل دين / سلفة جديدة</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div>
                            <label for="debtor-name" class="block text-gray-700 text-sm font-bold mb-1">اسم المدين:<span class="required">*</span></label>
                            <input type="text" id="debtor-name" placeholder="اسم الشخص أو الجهة" class="shadow-sm w-full">
                        </div>
                        <div>
                            <label for="add-debt-reason" class="block text-gray-700 text-sm font-bold mb-1">سبب الدين:</label>
                            <input type="text" id="add-debt-reason" placeholder="مثال: أدوات، أسنان، سلفة..." class="shadow-sm w-full">
                        </div>
                        <div>
                            <label for="add-debt-amount" class="block text-gray-700 text-sm font-bold mb-1">المبلغ:<span class="required">*</span></label>
                            <input type="number" id="add-debt-amount" value="0" min="0.01" step="0.01" class="shadow-sm w-full">
                        </div>
                    </div>
                    <div class="mt-4 flex flex-col sm:flex-row justify-between items-center gap-4">
                        <label for="debt-deduct-liquidity" class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="debt-deduct-liquidity" class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-offset-0 focus:ring-blue-200 focus:ring-opacity-50 ml-2">
                            <span class="text-sm text-gray-700 font-medium">خصم المبلغ من السيولة (تسجيل سلفة)؟</span>
                        </label>
                        <div id="debt-advance-account-container" class="form-group mt-2 hidden">
    <label for="debt-advance-account" class="block text-sm font-bold mb-1">خصم السلفة من حساب:</label>
    <select id="debt-advance-account" class="shadow-sm"></select>
</div>
                        <button id="add-debt-button" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded w-full sm:w-auto">تسجيل الدين/السلفة</button>
                    </div>
                </div>

                <div class="mb-6 pb-4 border-b">
                   <h3 class="text-lg font-medium text-gray-700 mb-3">استلام سداد مجمع</h3>
<div>
    <label class="block text-gray-700 text-sm font-bold mb-1">اختر الديون المراد تحصيلها:<span class="required">*</span></label>
    <div class="flex items-center mt-2 mb-1">
    <input type="checkbox" id="toggle-all-debts" class="ml-2">
    <label for="toggle-all-debts" class="text-sm font-medium text-gray-700 cursor-pointer">تحديد الكل / إلغاء تحديد الكل</label>
</div>
    <div id="payment-debtor-list-container" class="payment-list-container">
        <p class="text-center text-gray-500">لا توجد ديون متاحة للتحصيل.</p>
    </div>
    <div id="debt-payment-summary" class="payment-summary hidden">
        الإجمالي المحدد: <span id="debt-payment-total">0.00 جنيه</span>
    </div>
    <div class="form-group mt-2">
        <label for="debt-payment-account" class="block text-sm font-bold mb-1">إيداع السداد في حساب:<span class="required">*</span></label>
        <select id="debt-payment-account" class="shadow-sm"></select>
    </div>
</div>
<button id="receive-payment-button" class="mt-4 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded w-full sm:w-auto">استلام المبلغ المحدد</button>
</div>

                <div id="debts-message" class="section-message mt-3"></div>
                <div id="debtors-list-container">
                    <h3 class="text-lg font-medium text-gray-700 mb-3">قائمة الديون الحالية (مجمعة حسب الشخص)</h3>
                    <div id="debtors-list" class="space-y-2">
                        <p class="text-center text-gray-500 py-4">لا توجد ديون مسجلة حاليًا.</p>
                    </div>
                </div>
            </section><section id="liabilities-section" class="widget-card content-section hidden">
                <h2>الديون المستحقة على الشركة (للاخرين)</h2>
                <div id="total-liabilities-display" class="text-2xl font-bold text-pink-700 mb-4">إجمالي الالتزامات: 0.00 جنيه</div>
                <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="border-l border-gray-200 pl-4 md:border-l-0 md:pl-0 md:border-r md:pr-4">
                        <h3 class="text-lg font-medium text-gray-700 mb-3">تسجيل التزام جديد</h3>
                        <div class="mb-3">
                            <label for="creditor-name" class="block text-gray-700 text-sm font-bold mb-1">اسم الدائن:<span class="required">*</span></label>
                            <input type="text" id="creditor-name" placeholder="اسم الشخص أو الجهة" class="shadow-sm">
                        </div>
                        <div class="mb-3">
                            <label for="add-liability-amount" class="block text-gray-700 text-sm font-bold mb-1">المبلغ المستحق:<span class="required">*</span></label>
                            <input type="number" id="add-liability-amount" value="0" min="0.01" step="0.01" class="shadow-sm">
                        </div>
                       <div class="mb-3">
    <label for="liability-received-cash" class="inline-flex items-center cursor-pointer">
        <input type="checkbox" id="liability-received-cash" class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-offset-0 focus:ring-blue-200 focus:ring-opacity-50 ml-2">
        <span class="text-sm text-gray-700 font-medium">هل استلمت سيولة مقابل هذا الالتزام؟</span>
    </label>
    <div id="liability-cash-account-container" class="form-group mt-2 hidden" style="margin-right: 1.5rem;">
        <label for="liability-cash-account" class="block text-sm font-bold mb-1">إيداع في حساب:</label>
        <select id="liability-cash-account" class="shadow-sm w-full md:w-1/2"></select>
    </div>
    </div>
                        <button id="add-liability-button" class="w-full bg-rose-500 hover:bg-rose-600 text-white font-bold py-2 px-4 rounded">تسجيل الالتزام</button>
                    </div>
                    <div>
                      <h3 class="text-lg font-medium text-gray-700 mb-3">تسديد التزام مجمع</h3>
<div>
    <label class="block text-gray-700 text-sm font-bold mb-1">اختر الالتزامات المراد تسديدها:<span class="required">*</span></label>
    <div class="flex items-center mt-2 mb-1">
    <input type="checkbox" id="toggle-all-liabilities" class="ml-2">
    <label for="toggle-all-liabilities" class="text-sm font-medium text-gray-700 cursor-pointer">تحديد الكل / إلغاء تحديد الكل</label>
</div>
    <div id="payment-creditor-list-container" class="payment-list-container">
        <p class="text-center text-gray-500">لا توجد التزامات متاحة للتسديد.</p>
    </div>
    <div id="liability-payment-summary" class="payment-summary hidden">
        الإجمالي المحدد: <span id="liability-payment-total">0.00 جنيه</span>
    </div>
    <div class="form-group mt-2">
        <label for="liability-payment-account" class="block text-sm font-bold mb-1">خصم من حساب:<span class="required">*</span></label>
        <select id="liability-payment-account" class="shadow-sm"></select>
    </div>
</div>
<button id="pay-liability-button" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded">تسديد المبلغ المحدد</button>
</div>
                </div>
                <div id="liabilities-message" class="section-message mt-3"></div>
                <div id="liabilities-list-container" class="mt-6 border-t border-gray-200 pt-4">
                    <h3 class="text-lg font-medium text-gray-700 mb-3">قائمة الالتزامات الحالية</h3>
                    <ul id="liabilities-list" class="space-y-2">
                        <li class="text-center text-gray-500">لا توجد التزامات مسجلة حاليًا.</li>
                    </ul>
                </div>
            </section>

            <section id="offsetting-section" class="widget-card content-section hidden">
                <h2>تسوية (مقاصة) بين طرفين</h2>
                <p class="text-sm text-gray-600 mb-4">
                    استخدم هذا القسم لتسوية دين مستحق على شخص (المدين) باستخدام التزام مستحق لشخص آخر (الدائن).
                    سيتم خصم المبلغ من دين المدين ومن الالتزام المستحق للدائن. لن تؤثر هذه العملية على السيولة النقدية مباشرة.
                </p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <div class="md:col-span-1">
                        <label for="offset-debtor-name" class="block text-gray-700 text-sm font-bold mb-1">اسم المدين (من عليه الدين):<span class="required">*</span></label>
                        <input type="text" id="offset-debtor-name" list="debtor-names-list-offset" placeholder="الشخص الذي عليه الدين للشركة" class="shadow-sm w-full">
                        <datalist id="debtor-names-list-offset"></datalist>
                    </div>
                    <div class="md:col-span-1">
                        <label for="offset-creditor-name" class="block text-gray-700 text-sm font-bold mb-1">اسم الدائن (من له الالتزام):<span class="required">*</span></label>
                        <input type="text" id="offset-creditor-name" list="creditor-names-list-offset" placeholder="الشخص الذي له التزام على الشركة" class="shadow-sm w-full">
                         <datalist id="creditor-names-list-offset"></datalist>
                    </div>
                    <div class="md:col-span-1">
                        <label for="offset-amount-input" class="block text-gray-700 text-sm font-bold mb-1">مبلغ المقاصة:<span class="required">*</span></label>
                        <input type="number" id="offset-amount-input" placeholder="0.00" min="0.01" step="0.01" class="shadow-sm w-full">
                    </div>
                </div>
                <div class="mt-4 flex justify-end">
                    <button id="perform-two-party-offset-button" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded">
                        تنفيذ المقاصة بين الطرفين
                    </button>
                </div>
                <div id="offset-message" class="section-message text-sm mt-3"></div>
            </section>

           <section id="sales-report-section" class="content-section hidden">
    
    <!-- رأس الصفحة -->
    <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 2rem;">
        <div>
            <h2 style="font-size: 1.8rem; font-weight: 800; color: #1e293b; display: flex; align-items: center; gap: 0.5rem;">
                <span style="background: #eff6ff; color: #3b82f6; padding: 8px; border-radius: 12px;">
                    <i class="fas fa-chart-pie"></i>
                </span>
                تقارير المبيعات
            </h2>
            <p style="color: #64748b; margin-top: 5px;">متابعة الأداء المالي والأرباح الشهرية</p>
        </div>
        
        <!-- أدوات التحكم (الشهر والبحث) -->
        <div style="display: flex; gap: 10px; align-items: center; background: white; padding: 5px; border-radius: 8px; border: 1px solid #e2e8f0;">
            <input type="month" id="report-month-year" style="border: none; background: transparent; font-weight: bold; color: #334155; outline: none;">
            <button id="generate-report-button" style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: background 0.2s;">
                <i class="fas fa-filter"></i> عرض التقرير
            </button>
           <button onclick="window.deleteAllReportData()" style="background: #fee2e2; border: 1px solid #fca5a5; color: #991b1b; padding: 8px 12px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: all 0.2s;" title="حذف البيانات المعروضة نهائياً">
    <i class="fas fa-trash-alt"></i> حذف المعروض
</button>
        </div>
    </div>

    <!-- رسائل التنبيه -->
    <div id="report-message" class="section-message"></div>

    <!-- 1. بطاقات الملخص (Stats Cards) -->
    <div class="report-grid">
        <div class="stat-card stat-sales">
            <span class="stat-title"><i class="fas fa-coins td-icon"></i> إجمالي المبيعات</span>
            <span id="report-total-sales" class="stat-value">0.00</span>
        </div>
        <div class="stat-card stat-cost">
            <span class="stat-title"><i class="fas fa-boxes td-icon"></i> تكلفة البضاعة</span>
            <span id="report-total-cost" class="stat-value">0.00</span>
        </div>
        <div class="stat-card stat-profit">
            <span class="stat-title"><i class="fas fa-chart-line td-icon"></i> صافي الربح</span>
            <span id="report-total-profit" class="stat-value">0.00</span>
        </div>
    </div>

    <!-- 2. شريط البحث والتصفية -->
    <div style="margin-bottom: 1rem; position: relative;">
        <i class="fas fa-search" style="position: absolute; right: 15px; top: 12px; color: #94a3b8;"></i>
        <input type="text" id="report-search-input" placeholder="بحث باسم العميل، المنتج، أو رقم الفاتورة..." 
               style="width: 100%; padding: 10px 40px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 0.9rem; outline: none; transition: border-color 0.2s;"
               onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#cbd5e1'">
        
        <div style="position: absolute; left: 5px; top: 5px;">
            <button id="report-direct-search-btn" style="background: #f1f5f9; border: 1px solid #e2e8f0; padding: 5px 10px; border-radius: 6px; font-size: 12px; font-weight: bold; color: #475569; cursor: pointer;">
                بحث شامل
            </button>
            <button id="report-clear-search-btn" style="background: white; border: 1px solid #e2e8f0; padding: 5px 10px; border-radius: 6px; font-size: 12px; font-weight: bold; color: #ef4444; cursor: pointer;">
                مسح
            </button>
        </div>
    </div>

    <!-- 3. جدول البيانات -->
    <div class="report-table-container">
        <div style="overflow-x: auto;">
            <table class="modern-table">
                <thead>
                    <tr>
                        <th style="width: 15%">التاريخ / الوقت</th>
                        <th style="width: 15%">العميل</th>
                        <th style="width: 30%">تفاصيل البنود</th>
                        <th style="width: 10%; text-align: center;">القيمة</th>
                        <th style="width: 10%; text-align: center;">التكلفة</th>
                        <th style="width: 10%; text-align: center;">الربح</th>
                        <th style="width: 10%; text-align: center;">النوع</th>
                    </tr>
                </thead>
                <tbody id="sales-report-table-body">
                    <tr><td colspan="7" class="text-center text-gray-500 py-8">اختر الشهر لعرض البيانات.</td></tr>
                </tbody>
            </table>
        </div>
    </div>

</section>
          <section id="expenses-report-section" class="widget-card content-section hidden">
    <h2>تقرير المصروفات الشهرية</h2>
    <p class="text-sm text-gray-600 mb-4">
        اختر الشهر لعرض تقرير مفصل بكل المصروفات، شاملةً سحب السيولة، المصاريف المباشرة، وتكلفة البضاعة المشتراة نقدًا.
    </p>
    <div class="flex flex-col sm:flex-row justify-start items-end gap-4 mb-4">
        <div>
            <label for="exp-report-month-year" class="block text-gray-700 text-sm font-bold mb-1">اختر الشهر:<span class="required">*</span></label>
            <input type="month" id="exp-report-month-year" class="shadow-sm w-full sm:w-auto">
        </div>
        <button id="generate-exp-report-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded w-full sm:w-auto">
            عرض تقرير المصروفات
        </button>
    </div>
    <div id="exp-report-message" class="section-message text-sm mb-4"></div>
    <div id="exp-report-summary-container" class="hidden">
     <div class="bg-red-50 p-4 rounded-lg border border-red-200 mb-4">
        <h3 class="text-sm font-medium text-red-700 mb-1">إجمالي المصروفات للشهر المحدد</h3>
        <div id="exp-report-summary-total" class="text-2xl font-bold text-red-800">0.00 جنيه</div>
    </div>
</div>

    <div id="expenses-report-display">
        <h3 class="text-lg font-medium text-gray-700 mb-3">تفاصيل المصروفات للشهر المحدد</h3>
        <div class="overflow-x-auto">
            <table id="expenses-report-table" class="min-w-full">
                <thead>
                    <tr>
                        <th class="px-4 py-2">تاريخ العملية</th>
                        <th class="px-4 py-2">نوع المصروف</th>
                        <th class="px-4 py-2">التفاصيل/السبب</th>
                        <th class="px-4 py-2">المبلغ</th>
                    </tr>
                </thead>
                <tbody id="expenses-report-table-body">
                    <tr><td colspan="4" class="text-center text-gray-500 py-4">اختر الشهر واضغط "عرض التقرير".</td></tr>
                </tbody>
                
            </table>
        </div>
    </div>

    <!-- زر تصفير المصروفات (تمت إضافته هنا) -->
    <div class="mt-8 pt-4 border-t border-dashed border-gray-300 text-center no-print">
        <button id="reset-expenses-button" class="text-sm bg-red-50 hover:bg-red-100 text-red-600 font-bold py-2 px-6 rounded-full border border-red-200 transition-colors shadow-sm">
            <i class="fas fa-trash-alt mr-1"></i> تصفير عداد المصروفات (بدء فترة جديدة)
        </button>
        <p class="text-xs text-gray-400 mt-2">ملاحظة: هذا الإجراء يجعل "إجمالي المصروفات" صفر، ولا يؤثر على رصيد الخزنة.</p>
    </div>
</section>

          <section id="search-section" class="widget-card content-section hidden">
    <h2>البحث الشامل في الأرشيف</h2>
    <p class="text-sm text-gray-600 mb-4">
        ابحث في كل الفواتير المحفوظة (سحابياً ومحلياً). يمكنك البحث برقم الفاتورة، اسم العميل، أو حتى جزء من الاسم.
    </p>
    
    <div class="flex flex-col sm:flex-row gap-2 mb-4">
        <div class="flex-grow">
            <label for="smart-search-input" class="block text-gray-700 text-sm font-bold mb-1">أدخل كلمة البحث:</label>
            <input type="text" id="smart-search-input" placeholder="مثال: ضياء، 001، أحمد..." class="shadow-sm w-full p-2 border rounded">
        </div>
        <div class="flex items-end">
            <button id="smart-search-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded w-full sm:w-auto flex items-center justify-center gap-2">
                <i class="fas fa-search"></i> بحث شامل
            </button>
        </div>
    </div>

    <div id="search-message" class="section-message text-sm mb-4"></div>

    <div id="search-results-container" class="mt-4 border-t pt-4">
        <h3 class="text-lg font-medium text-gray-700 mb-3">نتائج البحث:</h3>
        <div id="search-results-list" style="max-height: 500px; overflow-y: auto;">
            <p class="text-center text-gray-500">أدخل كلمة البحث واضغط "بحث شامل".</p>
        </div>
    </div>
</section>
            <section id="log-section" class="widget-card content-section hidden">
                <h2>سجل العمليات العام (لليوم الحالي)</h2>
                <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                    <span class="text-sm text-gray-600">يعرض هذا السجل العمليات التي تمت في الجلسة الحالية للبيانات المعروضة.</span>
                    <button id="clear-log-button" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-600 font-bold py-1 px-2 rounded flex-shrink-0">مسح سجل اليوم المعروض</button>
                </div>
                <ul id="operation-log-list" class="list-disc pl-5 space-y-2">
                    <li class="text-center text-gray-500 list-none">لا توجد عمليات مسجلة بعد.</li>
                </ul>
            </section><div id="invoiceModal" class="invoice-modal modal">
                <div class="invoice-modal-content modal-content">
                    <div class="invoice-modal-header modal-header">
                        <span class="invoice-close-btn modal-close-btn no-print">&times;</span>
                        <h2>إنشاء فاتورة جديدة</h2>
                    </div>
                    <div class="invoice-modal-body modal-body" id="invoicePrintArea">
                        <form id="invoiceForm" autocomplete="off">
                            <fieldset>
                                <legend>بيانات العميل</legend>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="inv_customerName">اسم العميل: <span class="required">*</span></label>
                                        <input type="text" id="inv_customerName" name="customerName" placeholder="اسم العميل" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="inv_customerAddress">العنوان:</label>
                                        <input type="text" id="inv_customerAddress" name="customerAddress" placeholder="عنوان العميل">
                                    </div>
                                </div>
                            </fieldset>

                            <fieldset>
                                <legend>أرقام الهواتف</legend>
                                <div id="inv_phoneNumbersContainer">
                                    <div class="form-row inv-phone-entry">
                                        <div class="form-group">
                                            <label for="inv_phone1">رقم هاتف 1:</label>
                                            <input type="tel" id="inv_phone1" name="phone[]" placeholder="رقم الهاتف">
                                        </div>
                                        </div>
                                </div>
                                <button type="button" id="inv_addPhoneBtn" class="no-print mt-2">+ إضافة رقم آخر</button>
                            </fieldset>

                            <fieldset>
                                <legend>تفاصيل البضاعة</legend>
                                <div class="add-item-section no-print">
                                    <h4>إضافة بند جديد</h4>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="inv_itemName">اسم البند:<span class="required">*</span></label>
                                            <input type="text" id="inv_itemName" list="product-names-list" placeholder="اسم المنتج أو الخدمة">
                                        </div>

                                        <div class="form-group" style="flex: 0.5;">
                                            <label for="inv_itemQty">الكمية:<span class="required">*</span></label>
                                            <input type="number" id="inv_itemQty" value="1" min="1">
                                        </div>
                                        <div class="form-group" style="flex: 0.5;">
                                            <label for="inv_itemPrice">سعر الوحدة:<span class="required">*</span></label>
                                            <input type="number" id="inv_itemPrice" value="0" min="0" step="0.01">
                                        </div>
                                        <div id="inv_serialSelectContainer" class="serial-select-container hidden mt-2 p-2 bg-blue-50 border border-blue-200 rounded">
    <label for="inv_itemSerialInput" class="block text-gray-700 text-sm font-bold mb-1">
        الرقم التسلسلي (اختياري):
    </label>
    
    <input type="text" id="inv_itemSerialInput" list="inv_serials_datalist" placeholder="اكتب السيريال أو اختره..." class="shadow-sm w-full text-sm p-2 border rounded">
    
    <datalist id="inv_serials_datalist"></datalist>
    
    <p class="text-xs text-gray-500 mt-1">يمكنك اختيار سيريال موجود أو كتابة سيريال جديد.</p>
</div>
                                        <div class="form-group" style="flex: 0 0 auto;">
                                            <button type="button" id="inv_addItemBtn">إضافة</button>
                                        </div>
                                    </div>
                                  
                                    <div id="inv_itemAddError" class="error-message"></div>
                                </div>
                                <hr class="no-print my-4">
                                <table id="inv_invoiceItemsTable">
                                    <thead>
                                        <tr>
                                            <th>البند</th>
                                            <th>الكمية</th>
                                            <th>سعر الوحدة</th>
                                            <th>الإجمالي الفرعي</th>
                                            <th class="no-print">إجراء</th>
                                        </tr>
                                    </thead>
                                    <tbody id="inv_invoiceItemsBody">
                                        </tbody>
                                </table>
                                <div class="form-row totals-display" style="margin-top: 15px;">
                                    <div class="form-group">
                                        <label>إجمالي سعر البضاعة:</label>
                                        <span id="inv_totalGoodsPrice">0.00 جنيه</span>
                                    </div>
                                </div>
                            </fieldset>

                            <fieldset class="no-print">
                                <legend>خصم تكاليف إضافية (ملحقات/هدايا من المخزون)</legend>
                                <label class="block text-sm font-medium mb-2" style="color:#555;">اختر المنتجات التي سيتم خصم تكلفتها (بكمية 1 لكل عنصر - لن تظهر في الفاتورة المطبوعة):</label>
                                <div id="inv_deductibleCostsContainer">
                                    <p class="text-center text-gray-500 text-sm" style="color:grey;">سيتم عرض المنتجات المتاحة هنا.</p>
                                </div>
                            </fieldset>

                            <fieldset>
                                <legend>الشحن</legend>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="inv_shippingCost">قيمة الشحن:</label>
                                        <input type="number" id="inv_shippingCost" name="shippingCost" value="0" min="0" step="0.01">
                                    </div>
                                </div>
                                <div class="form-row totals-display">
                                    <div class="form-group">
                                        <label>إجمالي الشحن:</label>
                                        <span id="inv_totalShippingCost">0.00 جنيه</span>
                                    </div>
                                </div>
                            </fieldset>

                            <fieldset>
                                <legend>الضمان والملاحظات</legend>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="inv_warranty">مدة الضمان (اختياري):</label>
                                        <input type="text" id="inv_warranty" name="warranty" placeholder="مثال: سنة واحدة، 6 أشهر...">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="inv_notes">ملاحظات (اختياري):</label>
                                        <textarea id="inv_notes" name="notes" placeholder="أي ملاحظات إضافية على الفاتورة..."></textarea>
                                    </div>
                                </div>
                            </fieldset>

                            <fieldset>
                                <legend>الإجمالي الكلي</legend>
                                <div class="form-row totals-display">
                                    <div class="form-group">
                                        <label>المبلغ الإجمالي المطلوب:</label>
                                        <strong id="inv_grandTotalPrice">0.00 جنيه</strong>
                                    </div>
                                </div>
                            </fieldset>
                           <fieldset id="inv_payment_details_field">
    <legend>تفاصيل الدفع والمديونية</legend>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="form-group">
            <label for="inv_payment_account" class="block text-sm font-bold mb-1">إيداع المبلغ في حساب:</label>
            <select id="inv_payment_account" class="shadow-sm"></select>
        </div>
        <div class="form-group">
            <label for="inv_paidAmount" class="text-blue-700 font-bold">المبلغ المدفوع الآن (كاش):</label>
            <input type="number" id="inv_paidAmount" value="0" min="0" step="0.01" class="shadow-sm border-blue-300" oninput="window.inv_calculateTotals()">
            <p class="text-xs text-gray-500 mt-1">اتركه 0 إذا دفع العميل الإجمالي بالكامل.</p>
        </div>
        <div class="form-group bg-red-50 p-2 rounded border border-red-100 md:col-span-2">
            <div class="flex justify-between items-center">
                <span class="text-red-700 font-semibold">المتبقي كدين تلقائي:</span>
                <strong id="inv_remainingDebt" class="text-lg text-red-600">0.00 جنيه</strong>
            </div>
        </div>
    </div>
</fieldset>
                            <fieldset class="no-print">
    <legend>حالة الفاتورة</legend>
    <div class="form-group">
        <label for="inv_markAsPending" class="inline-flex items-center cursor-pointer">
            <input type="checkbox" id="inv_markAsPending" class="rounded border-gray-300 text-blue-600 shadow-sm ml-2">
            <span class="text-sm text-yellow-800 font-semibold">تسجيل الفاتورة كـ "بيع مؤقت" (تحت التسوية)</span>
        </label>
        <p class="text-xs text-gray-500 mt-1">عند تفعيل هذا الخيار، سيتم خصم البضاعة من المخزون ولكن لن يتم إضافة قيمتها للسيولة أو الأرباح حتى يتم تأكيدها لاحقاً.</p>
    </div>
</fieldset>
                            <div id="inv_validationError" class="error-message no-print"></div>
                        </form>
                    </div> <div class="invoice-modal-footer modal-footer">

                        <button type="button" id="inv_printInvoiceBtn" class="no-print">طباعة الفاتورة</button>
                        <button type="button" id="inv_saveInvoiceBtn" class="no-print">إنشاء وحفظ الفاتورة</button>
                        <button type="button" class="invoice-close-btn-footer modal-close-btn-footer no-print">إغلاق</button>
                    </div>
                </div>
         </div> <div id="manageSerialsModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <span class="modal-close-btn no-print">&times;</span>
                        <h2>إدارة الأرقام التسلسلية للمنتج: <span id="modal_productNameDisplay"></span></h2>
                    </div>
                    <div class="modal-body">
                        <div id="modal_serialCounts" class="mb-4">
                            <p>الكمية الإجمالية: <span id="modal_totalQuantity"></span></p>
                            <p>السيريالات المسجلة: <span id="modal_registeredCount"></span></p>
                            <p>القطع غير المسجلة: <span id="modal_unregisteredCount" class="font-bold text-red-600"></span></p>
                        </div>

                        <hr class="my-4">

                        <div>
                            <h4 class="text-md font-semibold mb-2">إضافة سيريالات جديدة للقطع غير المسجلة:</h4>
                             <div class="flex justify-between items-center mb-2 flex-wrap gap-2">
                                <label for="modal_productSerialNumbers" class="block text-gray-700 text-sm font-bold">
                                    الأرقام التسلسلية الجديدة (اختياري - كل رقم في سطر):
                                </label>
                                <label for="modal-import-serial-csv-input" class="button-like bg-teal-500 hover:bg-teal-600 text-white text-xs py-1 px-3 rounded-md cursor-pointer">
                                    استيراد من ملف CSV
                                </label>
                                <input type="file" id="modal-import-serial-csv-input" accept=".csv,.txt">
                            </div>
                            <textarea id="modal_productSerialNumbers" rows="5" class="shadow-sm w-full font-mono text-sm" placeholder="SN55555&#10;SN66666..."></textarea>
                            <p class="text-xs text-gray-500 mt-1">أدخل فقط سيريالات للقطع غير المسجلة. العدد يجب ألا يتجاوز <span id="modal_maxSerialsToAdd">0</span>.</p>
                             <div id="modal-serial-import-message" class="section-message text-xs mt-2"></div>
                        </div>

                         <div class="mt-4 border-t pt-4">
                            <h4 class="text-md font-semibold mb-2">السيريالات المسجلة حالياً لهذا المنتج:</h4>
                            <div id="modal-registered-serials-list">
                                <p class="text-center text-gray-500">لا توجد سيريالات مسجلة حالياً.</p>
                            </div>
                        </div>

                    </div> <div class="modal-footer">
                        <button type="button" id="modal_saveAddedSerialsBtn" class="bg-blue-500 hover:bg-blue-600 text-white">حفظ السيريالات المضافة</button>
                        <button type="button" class="modal-close-btn-footer no-print">إغلاق</button>
                    </div>
                </div> </div> 
                <div id="backupHistoryModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <span class="modal-close-btn no-print">&times;</span>
            <h2>سجل النسخ الاحتياطية التلقائية لليوم</h2>
        </div>
        <div class="modal-body">
            <p class="text-sm text-gray-600 mb-4">
                هذه قائمة بآخر النسخ التي تم حفظها تلقائيًا. اختر النسخة التي تريد استعادتها.
            </p>
            <div id="backup-history-list" class="space-y-2" style="max-height: 60vh; overflow-y: auto;">
                <p class="text-center text-gray-500">جاري تحميل السجل...</p>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="modal-close-btn-footer no-print">إغلاق</button>
        </div>
    </div>
</div>

            <section id="settings-section" class="widget-card content-section hidden">
                <h2>تحميل/حفظ/إعدادات</h2>
                <div id="load-data-sub-section" class="mb-6 pb-4 border-b">
                    <h3 class="text-lg font-medium text-gray-700 mb-3">تحميل بيانات تاريخ سابق أو ترحيل أرصدة</h3>
                    <div class="flex flex-col sm:flex-row justify-start items-center gap-2 md:gap-4 flex-wrap">
                        <label for="load-date-alt" class="block text-gray-700 text-sm font-bold flex-shrink-0">اختر التاريخ:</label>
                        <input type="date" id="load-date-alt" class="shadow-sm w-52">
                        <span id="load-date-day-name-alt" class="text-gray-600 font-medium text-sm min-w-[50px] text-center"></span>
                        <button id="load-data-button-alt" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded">
                            تحميل / ترحيل يدوي
                        </button>
                    </div>
                    <div id="load-message-alt" class="section-message text-sm mt-3"></div>
                    <p class="text-xs text-gray-500 mt-2">ملاحظة: عند اختيار يوم فارغ، سيتم سؤالك إذا كنت تريد ترحيل الأرصدة من اليوم السابق له إن وجدت.</p>
                </div>

                <div id="import-export-section" class="mb-6 pb-4 border-b">

                    <h3 class="text-lg font-medium text-gray-700 mb-3">نسخ احتياطي واستعادة</h3>
                    <div class="flex flex-col sm:flex-row justify-center items-center gap-4 flex-wrap">
                        <button id="export-data-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
                            تصدير البيانات الحالية (JSON)
                        </button>
                        <label for="import-file-input" class="button-like bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded cursor-pointer">
                            استيراد بيانات من ملف (JSON/TXT)
                        </label>
                        <input type="file" id="import-file-input" accept=".json,.txt">
                    </div>
                     <p class="text-xs text-gray-500 mt-2 text-center">ملاحظة: عند الاستيراد، اختر أولاً التاريخ الذي تريد الاستيراد إليه من قسم "تحميل بيانات تاريخ سابق".</p>
                   
                    <div id="import-message" class="section-message text-sm mt-2"></div>

                 <div class="mt-4 pt-4 border-t border-gray-200">
    <h4 class="text-sm font-bold text-indigo-700 mb-2">مزامنة سحابية (إصلاح الأخطاء)</h4>
    <button onclick="syncLocalSalesToCloud()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded w-full sm:w-auto flex items-center justify-center gap-2">
        <i class="fas fa-sync-alt"></i> مزامنة الفواتير المحلية مع السحابة
    </button>
    <p class="text-xs text-gray-500 mt-1">اضغط هنا إذا لاحظت اختفاء بعض الفواتير الحديثة من التقرير (بسبب ضعف الإنترنت).</p>
</div>   
                </div>
                <div id="safety-net-section" class="mb-6 pb-4 border-b">
    <h3 class="text-lg font-medium text-yellow-700 mb-3">🛡️ شبكة الأمان (استعادة الطوارئ)</h3>
    <p class="text-xs text-gray-500 mb-3">
        إذا حدث خطأ كارثي وتم حفظ بيانات فارغة أو خاطئة تلقائيًا، يمكنك استخدام هذا الزر لاستعادة بياناتك كما كانت عند آخر عملية حفظ تلقائي ناجحة.
    </p>
    <div class="flex flex-col sm:flex-row justify-center items-center gap-4 flex-wrap">
        <button id="open-backup-history-button" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded">
    عرض واستعادة النسخ الاحتياطية لليوم
</button>
    </div>
    <div id="auto-backup-message" class="section-message text-sm mt-2"></div>
</div>

                <div id="controls-sub-section" class="mt-6 flex flex-col sm:flex-row justify-center items-center flex-wrap gap-4">
                    
<button id="save-button-alt" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded flex items-center">
                       
                        <svg class="save-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M17 3H5C3.89543 3 3 3.89543 3 5V19C3 20.1046 3.89543 21 5 21H19C20.1046 21 21 20.1046 21 19V7.82843C21 7.29799 20.7893 6.78929 20.4142 6.41421L17.5858 3.58579C17.2107 3.21071 16.702 3 16.1716 3H17ZM15 9C15 8.44772 14.5523 8 14 8H10C9.44772 8 9 8.44772 9 9V14C9 14.5523 9.44772 15 10 15H14C14.5523 15 15 14.5523 15 14V9ZM12 13C11.4477 13 11 12.5523 11 12C11 11.4477 11.4477 11 12 11C12.5523 11 13 11.4477 13 12C13 12.5523 12.5523 13 12 13Z"></path></svg>
                        حفظ التغييرات
                    </button>
                    <button id="print-button-alt" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">
                        طباعة تقرير اليوم
                    </button>
                    <button id="reset-button-alt" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded">
                        تصفير بيانات اليوم (بدون حفظ)
                    </button>
                    
                </div>
            </section>


        </div> <footer class="mt-10 text-center text-sm text-gray-500">
            <p>
                تم التطوير بواسطة:
                <a href="https://diaaashraf2004.github.io/drashraf/" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">
                    ضياء أشرف
                </a>
                 - <span id="current-time"></span>
            </p>
            <button id="logout-btn" class="hidden bg-red-500 text-white font-bold py-1 px-3 rounded mt-2">تسجيل الخروج</button>
       <!-- ======================================================= -->
<!-- START: Returns Section -->
<!-- ======================================================= -->
<section id="returns-section" class="widget-card content-section hidden">
    <div class="section-header">
        <i class="fas fa-undo-alt icon"></i>
        <h2>إدارة المرتجعات</h2>
    </div>

    <div class="card-container">
        <div class="option-card">
            <div class="card-header">
                <i class="fas fa-file-invoice card-icon"></i>
                <h3 class="card-title">بيانات المرتجع</h3>
            </div>
            <div class="card-content">
                <div class="form-grid">
                    <div class="form-group" style="grid-column: 1 / -1; display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label for="return-product-select">اختر منتجًا (إن وجد):</label>
                            <select id="return-product-select" class="form-input">
                                <option value="">-- اختر من القائمة --</option>
                            </select>
                        </div>
                        <div>
                            <label for="return-manual-product-name">أو أدخل اسم المنتج يدويًا:</label>
                            <input type="text" id="return-manual-product-name" class="form-input" placeholder="اكتب اسم المنتج هنا">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="return-quantity">الكمية:</label>
                        <input type="number" id="return-quantity" value="1" min="1" class="form-input">
                    </div>
                    <div class="form-group">
                        <label for="return-customer-name">اسم العميل:</label>
                        <input type="text" id="return-customer-name" placeholder="الاسم (اختياري)" class="form-input">
                    </div>
                </div>
            </div>
        </div>
        <div class="option-card">
    <div class="card-header">
        <i class="fas fa-cogs card-icon"></i>
        <h3 class="card-title">إجراءات المرتجع</h3>
    </div>
    <div class="card-content">
        <div class="form-group">
            <label class="font-bold">1. اختر الإجراء المالي:</label>
            <div class="radio-buttons mt-2" id="return-type-selector">
                <label class="radio-label" for="return-type-cash">
                    <input type="radio" name="return-financial-type" id="return-type-cash" value="cash" checked>
                    <span class="label-text">إرجاع نقدي (خصم من السيولة)</span>
                </label>
                <label class="radio-label" for="return-type-credit">
                    <input type="radio" name="return-financial-type" id="return-type-credit" value="credit">
                    <span class="label-text">تسجيل كرصيد للعميل (التزام)</span>
                </label>
                <label class="radio-label" for="return-type-stock">
                    <input type="radio" name="return-financial-type" id="return-type-stock" value="stock">
                    <span class="label-text">إرجاع للمخزون فقط (إلغاء)</span>
                </label>
            </div>
        </div>

        <div id="return-financial-details">
            <div class="form-group" id="return-account-selector-container">
                <label for="return-from-account-select">خصم المبلغ من حساب:</label>
                <select id="return-from-account-select" class="form-select"></select>
            </div>
            <div class="form-group" id="return-sale-price-group">
                <label for="return-sale-price-input">قيمة المرتجع:</label>
                <input type="number" id="return-sale-price-input" placeholder="0.00" min="0" class="form-input">
            </div>
        </div>

        <div class="form-group mt-4">
             <label class="font-bold">2. اختر خيارات المخزون:</label>
            <div class="checkbox-buttons mt-2">
                <label class="checkbox-label" for="return-receive-now">
                    <input type="checkbox" id="return-receive-now" checked>
                    <span class="label-text">استلام البضاعة الآن في المخزن</span>
                </label>
                <label class="checkbox-label" for="return-at-sale-price">
                    <input type="checkbox" id="return-at-sale-price">
                    <span class="label-text">إضافة للمخزون كتكلفة (باسم العميل)</span>
                </label>
            </div>
        </div>
    </div>
</div>

       
        
        
    </div>
    
    <button id="confirm-manual-return-btn" class="action-button">
        تأكيد الإرجاع اليدوي
    </button>
    <div id="return-message" class="section-message mt-4"></div>
    
    
    <div class="mt-8 border-t pt-6">
        <h3 class="sub-heading">مرتجعات قيد الاستلام</h3>
        <div id="pending-receipt-list">
            <p class="text-center text-gray-500">لا توجد مرتجعات معلقة حاليًا.</p>
        </div>
    </div>
    <div class="mt-8 border-t pt-6">
        <h3 class="sub-heading">المرتجعات التي تمت اليوم</h3>
        <div id="completed-returns-list">
            <p class="text-center text-gray-500">لم تتم أي عمليات إرجاع اليوم.</p>
        </div>
    </div>
</section>
<!-- END: Returns Section -->
<!-- ======================================================= -->
        </footer>
        <div id="partialLiabilityPaymentModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <span class="modal-close-btn">&times;</span>
            <h2>تسديد دفعة جزئية من التزام</h2>
        </div>
        <div class="modal-body">
            <p>الدائن: <strong id="partial-liability-creditor-name"></strong></p>
            <p>إجمالي الالتزام الحالي: <strong id="partial-liability-total-amount"></strong></p>
            <hr style="margin: 1rem 0;">
            <div class="form-group">
                <label for="partial-liability-payment-amount">المبلغ المراد تسديده:<span class="required">*</span></label>
                <input type="number" id="partial-liability-payment-amount" placeholder="0.00" min="0.01" step="0.01">
            </div>
            <div class="form-group" style="margin-top: 1rem;">
                <label for="partial-liability-payment-account">خصم المبلغ من حساب:<span class="required">*</span></label>
                <select id="partial-liability-payment-account"></select>
            </div>
            <div id="partial-liability-payment-message" class="section-message" style="margin-top: 1rem;"></div>
        </div>
        <div class="modal-footer">
            <button id="confirm-partial-liability-payment-btn" class="bg-green-500 hover:bg-green-600 text-white">تأكيد تسديد المبلغ</button>
            <button type="button" class="modal-close-btn-footer">إلغاء</button>
        </div>
    </div>


    </div>
    <div id="partialDebtPaymentModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <span class="modal-close-btn">&times;</span>
            <h2>استلام دفعة جزئية من دين</h2>
        </div>
        <div class="modal-body">
            <p>المدين: <strong id="partial-debtor-name"></strong></p>
            <p>سبب الدين: <strong id="partial-debt-reason"></strong></p>
            <p>إجمالي الدين الحالي: <strong id="partial-debt-total-amount"></strong></p>
            <hr style="margin: 1rem 0;">
            <div class="form-group">
                <label for="partial-debt-payment-amount">المبلغ المستلم:<span class="required">*</span></label>
                <input type="number" id="partial-debt-payment-amount" placeholder="0.00" min="0.01" step="0.01">
            </div>
            <div class="form-group" style="margin-top: 1rem;">
                <label for="partial-debt-payment-account">إيداع المبلغ في حساب:<span class="required">*</span></label>
                <select id="partial-debt-payment-account"></select>
            </div>
            <div id="partial-debt-payment-message" class="section-message" style="margin-top: 1rem;"></div>
        </div>
        <div class="modal-footer">
            <button id="confirm-partial-debt-payment-btn" class="bg-green-500 hover:bg-green-600 text-white">تأكيد استلام المبلغ</button>
            <button type="button" class="modal-close-btn-footer">إلغاء</button>
        </div>
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        console.log("البرنامج بدأ بنجاح - الخطوة 1 تمت");
        // --- Global Error Handler ---
                window.addEventListener('error', function(event) {
            console.error('!!! خطأ عام غير معالج تم اكتشافه !!!');
            console.error('رسالة الخطأ:', event.message);
            console.error('الملف المصدر:', event.filename);
            console.error('رقم السطر:', event.lineno);
            console.error('رقم العمود:', event.colno);
            console.error('كائن الخطأ (Error Object):', event.error); // يحتوي عادة على تتبع المكدس (stack trace)

            // اختيارياً: يمكنك عرض رسالة للمستخدم في الواجهة أيضاً
            // if (typeof showGlobalMessage === 'function') {
            //     showGlobalMessage('حدث خطأ غير متوقع في البرنامج. يرجى مراجعة الـ console لمزيد من التفاصيل ومحاولة تحديث الصفحة.', true);
            // }
        });
let backupSlotIndex = 0; // متغير جديد لتتبع خانة النسخ الاحتياطي
const MAX_BACKUP_SLOTS = 10; // سنحتفظ بـ 5 نسخ فقط كحد أقصى
        // اختيارياً: يمكنك أيضاً التقاط الأخطاء في الـ Promises التي لم يتم التعامل معها
        window.addEventListener('unhandledrejection', function(event) {
            console.error('!!! خطأ Promise غير معالج تم اكتشافه !!!');
            console.error('سبب الرفض (Rejection Reason):', event.reason);
        });
        // --- End of Global Error Handler ---
        // *** JavaScript - (أعيد ترقيمه ليبدأ هنا) الجزء 7 من 8 يبدأ هنا ***

        // --- تعريف المتغيرات والثوابت الأساسية أولاً ---
        const d = id => document.getElementById(id); // Helper function
        const lsPrefix = "goodsMgmt_data_"; // Define constants FIRST
        const lsLastSaveKey = "goodsMgmt_lastSaveDate";

        // --- متغيرات الحالة (Main App State) ---
        let editingPendingSaleId = null; // To track which pending sale is being edited
        let monthlyLiabilities = []; // لتخزين قائمة الالتزامات الشهرية
let editingMonthlyLiabilityId = null; // لمعرفة الالتزام الذي يتم تعديله
const lsLastProcessedMonthKey = "goodsMgmt_lastProcessedMonth"; // مفتاح لتخزين آخر شهر تمت معالجته
        let products = [];
             let returnSourceData = null; // سيخزن بيانات البيع المؤقت عند تحويله لمرتجع
             let globalSearchResults = []; // متغير لتخزين نتائج البحث الشامل مؤقتاً
        let stateHistory = []; // لتخزين لقطات الحالات السابقة
let redoHistory = [];  // لتخزين الحالات التي تم التراجع عنها
        let suppliers = [];
        let accounts = []; // سيخزن هذا كل حساباتك (خزائنك)
        let expenses = 0;
        let debtors = []; // Array of {id, name, reason, amount}
        let liabilities = []; // Array of {id, name, amount}
        let totalProfit = 0;
        let operationLog = []; // Array of {timestamp, type, details}
        let currentLoadedDate = null; // Stores the YYYY-MM-DD string of the loaded data
        let pendingSales = []; // Array of {id, timestamp, customerName, mainProduct{name,qty,cost,supplierId}, additionalItems[{name,qty,cost,supplierId}], totalSellPrice, potentialProfit, status}
        let goodsOnConsignmentValue = 0; // Calculated from pendingSales costs
        let liquidityLog = []; // Array of {id, timestamp, type['add'/'remove'/'adjust'], amount, description, currentBalance} // Added 'adjust' type
        let salesToday = []; // Array to store completed sales/invoices for the current day {id, invoiceNumber?, type['quick'/'invoice'/'invoice-from-pending'/'pending-confirmed'], timestamp, customerName, items[{}], totalSellPrice/grandTotal, totalCost, profit, etc.}
        let serialNumbersLog = []; // **** لتخزين سجل الأرقام التسلسلية **** Array of {serial, productName, supplierId, addedTimestamp, status: 'in_stock' | 'sold' | 'returned' | 'pending_sale' | 'in_invoice_temp' }
        let editingProductName = null; // Name of the product being edited
        let editingSupplierId = null; // ID of the supplier being edited
        let isInvoiceFromPending = false; // Flag if invoice modal is opened from a pending sale confirmation
        let pendingSaleOriginData = null; // Stores the original pending sale data when confirming with invoice
        let inv_phoneCounter = 1; // Counter for dynamic phone fields in invoice
        let currentManagingSerialsProduct = null; // **** لتخزين اسم المنتج الذي يتم إدارة سيريالاته ****
        let currentSupplierSerials = []; // **** لتخزين السيريالات المعروضة حالياً للفلترة ****
        // --- Purchase Invoice (PI) Elements ---
let piSupplierSelect, piInvoiceNumberInput, piDateInput, piItemsBody,
    piNoItemsMsg, piItemNameInput, piItemQuantityInput, piItemCostInput,
    piItemSerialsContainer, piItemSerialsTextarea, piAddItemBtn, piItemAddMessage,
    piGrandTotalSpan, piPaidAmountInput, piPaidAmountDisplaySpan, piRemainingBalanceSpan,
    piConfirmBtn, piSaveDraftBtn, piClearFormBtn, piFormMessage,
    piRecentPurchasesList;
        let inboxTasks = [];
        let currentMonthlySalesData = []; // لتخزين بيانات التقرير التي تم جلبها
        let purchaseInvoices = []; // لتخزين فواتير الشراء لليوم الحالي
        let pendingPurchases = [];
        let completedReturns = []; // <-- ✅ السطر الأول
let pendingReturns = [];   // <-- ✅ السطر الثاني
let pendingReturnsValue = 0; // ✅ أضف هذا السطر هنا

        let isAutoSaveEnabled = false;
let autoSaveTimer = null;
const lsAutoSaveKey = "goodsMgmt_autoSaveEnabled"; // مفتاح لحفظ تفضيل المستخدم


        // --- تعريف المراجع الأساسية (DOM Element References) ---
        // Declared here, assigned in initializeApp after DOM is ready
        let mainNav, contentSections, navButtons, globalMessage, currentDataDateDisplay, currentTimeDisplay,
            summaryLiquidity, summaryInventory, summaryConsignment, summaryDebts,
            summaryLiabilities, summaryExpenses, summaryProfit, summaryCapital,summaryExpectedCapital,
            productList, addProductButton, productNameInput, productQuantityInput,
            productCostPriceInput, productSupplierSelect, productMessage,
            inventoryTotalInventoryValue, inventoryConsignmentValue, inventoryTotalProfit,
            cancelEditProductButton, productFormTitle, productNamesDatalist,
            productDeductLiquidityCheckbox,
            serialNumberEntryContainer, productSerialNumbersTextarea, serialImportMessage, importSerialCsvInput,
            sellProductNameInput, sellCustomerNameInput, sellQuantityInput, sellPriceInput,
            sellButton, sellMessage, additionalCostsContainer, sellPendingCheckbox,
            pendingSalesListContainer, pendingSalesSearchInput, pendingSalesTotalCostSpan, pendingSalesTotalProfitSpan, // <<< جديد: عناصر تحكم المبيعات المؤقتة
            currentLiquidityDisplay, addLiquidityAmountInput,
            addLiquiditySourceInput, addLiquidityButton, removeLiquidityAmountInput,
            removeLiquidityReasonInput, removeLiquidityButton, liquidityMessage,
            liquidityLogListContainer,
            adjustLiquidityAmountInput, adjustLiquidityReasonInput, adjustLiquidityButton, adjustLiquidityMessage, // <<< جديد: عناصر تعديل السيولة
            totalExpensesDisplay, addExpenseInput,
            addExpenseButton, removeExpenseInput, removeExpenseButton, expensesMessage,
            totalDebtsDisplay, debtorNameInput, addDebtReasonInput, addDebtAmountInput,
            debtDeductLiquidityCheckbox, addDebtButton, paymentDebtorSelect, paymentAmountInput,
            receivePaymentButton, debtsMessage, debtorsListContainer, totalLiabilitiesDisplay,
            creditorNameInput, addLiabilityAmountInput, liabilityReceivedCashCheckbox,
            addLiabilityButton, paymentCreditorSelect, liabilityPaymentAmountInput,
            payLiabilityButton, liabilitiesMessage, liabilitiesListContainer,
            offsetDebtorNameInput, offsetCreditorNameInput, offsetAmountInput,
            performTwoPartyOffsetButton, offsetMessage, reportMonthYearInput,
            generateReportButton, reportMessage, salesReportTableBody, reportTotalSales,
            reportTotalCost, reportTotalProfit, operationLogList, clearLogButton,
            saveButtonAlt, loadDateInputAlt, loadDataButtonAlt, loadMessageAlt,
            loadDateDayNameDisplayAlt, printButtonAlt, resetButtonAlt, exportDataButton,
            importFileInput, importMessage, supplierNameInput, supplierContactInput,
            supplierAddressInput, addSupplierButton, cancelEditSupplierButton,
            supplierMessage, supplierList, supplierFormTitle, supplierNamesDatalist,
            searchSupplierSerialNameInput, searchSupplierSerialsBtn, serialSearchMessage, supplierSerialsResultsContainer, filterSerialsContainer, filterSerialsInput,
            inv_modal, inv_openInvoiceModalBtn, inv_closeBtn, inv_closeBtnFooter, inv_invoiceForm,
            inv_customerNameInput, inv_customerAddressInput, inv_phoneNumbersContainer,
            inv_addPhoneBtn, inv_shippingCostInput, inv_totalShippingCostSpan,
            inv_totalGoodsPriceSpan, inv_grandTotalPriceSpan, inv_validationErrorDiv,
            inv_itemNameInput, inv_itemQtyInput, inv_itemPriceInput, inv_addItemBtn,
            inv_itemAddErrorDiv, inv_invoiceItemsBody, inv_printInvoiceBtn,
            inv_deductibleCostsContainer, inv_warrantyInput, inv_notesTextarea,
            inv_saveInvoiceBtn, inv_serialSelectContainer, inv_itemSerialSelect, inv_serialSearchInput,
            manageSerialsModal, modal_productNameDisplay, modal_serialCounts, modal_totalQuantity, modal_registeredCount, modal_unregisteredCount,
            modal_productSerialNumbers, modal_maxSerialsToAdd, modal_serialImportMessage, modal_importSerialCsvInput,
            modal_registeredSerialsList, modal_saveAddedSerialsBtn, modal_closeBtns,
            debtorNamesDatalistOffset, creditorNamesDatalistOffset,
            // Invoice Search Elements
            searchInvoiceNumberInput, searchByNumberBtn, searchCustomerNameInput,
            searchByNameBtn, searchMessageContainer, searchResultsListContainer, partialLiabilityPaymentModal, partialLiabilityPaymentMessage, partialDebtPaymentModal;
            // --- Financial Center (FC) Elements ---
let fc_main_tabs, fc_tab_buttons, fc_tab_contents, fc_month_select, fc_expenses_list,
    fc_products_list, fc_total_expenses_display, fc_preview_container, fc_preview_results,
    fc_manual_container, fc_manual_list, fc_percentage_feedback, fc_percentage_total,
    fc_expenses_wrapper, fc_manual_cost_wrapper, fc_manual_cost_input,
    fc_debt_select, fc_execute_dist_btn, fc_execute_debt_btn, reportSearchInput,
    reportClearSearchBtn,
    salesReportSearchContainer, reportDirectSearchBtn; 
    let openBackupHistoryButton, autoBackupMessage, backupHistoryModal, backupHistoryList;
    let productCategoryInput, categoryDatalist, inventorySearchInput, inventoryCategoryFilter;
    let sellSerialContainer, sellSerialInput, sellSerialsDatalist;



        // --- الدوال المساعدة (Helper Functions) ---
// دالة مساعدة لإضافة مبلغ إلى السيولة وتسجيله في السجل
// دالة لحفظ فاتورة الشراء في أرشيف مستقل للرجوع إليها لاحقاً من قسم الالتزامات
async function savePurchaseInvoiceToCloud(invoiceData) {
    if (!window.currentUser) return;
    const userId = window.currentUser.uid;
    try {
        const docRef = window.doc(window.db, "users", userId, "purchase_archives", invoiceData.id);
        await window.setDoc(docRef, invoiceData);
        console.log("✅ تم أرشفة فاتورة الشراء سحابياً.");
    } catch (error) {
        console.error("❌ فشل أرشفة فاتورة الشراء:", error);
    }
}
// ✅✅✅ دالة جديدة لمسح كل البيانات في الجلسة الحالية ✅✅✅
function resetAllData() {
    console.log("resetAllData called - Clearing ALL current session data.");

    // تصفير كل متغيرات الحالة الرئيسية
    products = [];
    suppliers = [];
    // إعادة تعيين الحسابات إلى حساب افتراضي واحد أو تركها فارغة
    accounts = [{ id: 'main', name: 'الخزينة الرئيسية', balance: 0.00 }]; 
    expenses = 0;
    debtors = [];
    liabilities = [];
    monthlyLiabilities = []; // إذا كنت تريد مسحها أيضًا
    totalProfit = 0;
    operationLog = [];
    pendingSales = [];
    liquidityLog = [];
    salesToday = [];
    serialNumbersLog = [];
    purchaseInvoices = [];
    pendingPurchases = [];
    completedReturns = [];
    pendingReturns = [];
    pendingReturnsValue = 0;
    
    // تصفير حالات التعديل
    editingPendingSaleId = null;
    editingProductName = null;
    editingSupplierId = null;
    editingMonthlyLiabilityId = null;
    
    // تصفير سجل التراجع/الإعادة
    stateHistory = [];
    redoHistory = [];
    updateUndoRedoButtons();

    // مسح الرسائل
    const messageElements = document.querySelectorAll('.section-message, .error-message');
    messageElements.forEach(el => {
        el.textContent = '';
        el.classList.remove('visible', 'error', 'success', 'info');
    });
    
    // إضافة سجل يفيد بالتصفير الشامل
    logOperation("تصفير شامل", "تم مسح جميع بيانات الجلسة الحالية.");

    // تحديث الواجهة بالكامل لتعكس الحالة الفارغة
    updateUI(); 
    showGlobalMessage("تم تصفير جميع بيانات الجلسة الحالية بنجاح.", false, true);
}
function addAmountToDefaultAccount(amount, description) {
    if (isNaN(amount) || amount <= 0) {
        console.error("خطأ: لا يمكن إضافة مبلغ غير صحيح للسيولة.");
        return false;
    }
    // حفظ الحالة قبل التغيير للسماح بالتراجع
    saveStateToHistory(); 
    liquidity += amount;
    const logEntry = {
        id: `liq-${Date.now()}`,
        timestamp: new Date().toISOString(),
        type: "add",
        amount: amount,
        description: description,
        currentBalance: liquidity
    };
    liquidityLog.push(logEntry);
    logOperation("إضافة سيولة", `إضافة ${formatCurrency(amount)} من "${description}". الرصيد الحالي: ${formatCurrency(liquidity)}`);
    return true;
}
        function convertNumerals(inputString) { if (typeof inputString !== 'string') return inputString; return inputString.replace(/[\u0660-\u0669]/g, d => d.charCodeAt(0) - 0x0660).replace(/[\u06F0-\u06F9]/g, d => d.charCodeAt(0) - 0x06F0); }
        function parseInputNumber(inputElement) { if (!inputElement) return NaN; const rawValue = inputElement.value; if (rawValue.trim() === '') return NaN; const westernValue = convertNumerals(rawValue.trim()); const normalizedValue = westernValue.replace(/٫/g, '.').replace(/,/g, ''); const number = parseFloat(normalizedValue); return isNaN(number) ? NaN : number; }
        function getTodayDateString() { const today = new Date(); const year = today.getFullYear(); const month = String(today.getMonth() + 1).padStart(2, '0'); const day = String(today.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; }
        function formatDateForDisplay(dateString) { if (!dateString || typeof dateString !== 'string' || !/^\d{4}-\d{2}-\d{2}$/.test(dateString)) return 'غير محدد'; try { const date = new Date(dateString + 'T00:00:00'); const options = { timeZone: 'Africa/Cairo', weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }; return date.toLocaleDateString('ar-EG', options); } catch (e) { console.error("Error formatting date:", dateString, e); return dateString; } }
        function fetchData(key, defaultValue){ const data = localStorage.getItem(key); try { if(data === null || data === undefined) return defaultValue; const parsed = JSON.parse(data); return parsed } catch(e) { console.error(`Error parsing data for key "${key}":`, e); localStorage.removeItem(key); return defaultValue } }
        // دالة جديدة لجلب بيانات يوم واحد من Firebase
async function fetchOnlineDataForDate(dateString) {
    if (!window.currentUser) {
        console.error("Cannot fetch report data. No user logged in.");
        return null;
    }
    const userId = window.currentUser.uid;
    try {
        const docRef = window.doc(window.db, "users", userId, "days", dateString);
        const docSnap = await window.getDoc(docRef);
        if (docSnap.exists()) {
            console.log(`Report: Found online data for ${dateString}`);
            return docSnap.data();
        }
        return null;
    } catch (error) {
        console.error("Error fetching online report data for", dateString, error);
        return null;
    }
}
        function saveData(key, data){ console.log(`saveData: Saving data for key: ${key}`); try { localStorage.setItem(key, JSON.stringify(data)) } catch(e) { console.error(`Error saving data for key "${key}":`, e); showGlobalMessage("حدث خطأ أثناء حفظ البيانات. قد يكون التخزين ممتلئًا.", true) } }
        function formatCurrency(amount){ const numAmount = Number(amount); return isNaN(numAmount) ? '0.00 جنيه' : `${numAmount.toFixed(2)} جنيه` }
      
function sanitizeDataForFirebase(obj) {
    if (obj === null || typeof obj !== 'object') {
        return obj;
    }

    if (Array.isArray(obj)) {
        return obj.map(item => sanitizeDataForFirebase(item));
    }

    const newObj = {};
    for (const key in obj) {
        if (Object.prototype.hasOwnProperty.call(obj, key)) {
            const value = obj[key];
            if (value === undefined) {
                newObj[key] = null; // <--- هذا هو السطر المهم: تحويل undefined إلى null
            } else {
                newObj[key] = sanitizeDataForFirebase(value);
            }
        }
    }
    return newObj;
}
       
        function formatDateTime(isoString){ if(!isoString) return ''; try { return new Date(isoString).toLocaleString('ar-EG', {timeZone: 'Africa/Cairo', year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true}) } catch(e) { return isoString } }
        function showMessage(messageElement, text, isError = false, isInfo = false){ if (!messageElement) { /* console.warn("showMessage called with invalid element"); */ return } messageElement.innerHTML = text; // Use innerHTML to render <br> if needed
             messageElement.className = 'section-message'; // Reset classes first
             if (text) { // Only add visibility and color classes if there is text
                 if (isError) { messageElement.classList.add('error'); } else if (isInfo) { messageElement.classList.add('info'); } else { messageElement.classList.add('success'); } messageElement.classList.add('visible'); // Make visible
                 // Auto-hide logic (except for errors, maybe?)
                 if (!isError) {
                      setTimeout(() => { if (messageElement) { messageElement.classList.remove('visible'); } }, 6000); // Increased timeout slightly
                   }
             }
          }
        function showGlobalMessage(text, isError = false, isInfo = false){ const element = d("global-message"); if(!element) return; showMessage(element, text, isError, isInfo); }
        function updateLoadDateDayName(dateString, displayElement) { if (!displayElement) { /* console.warn("Day name display element not provided!"); */ return; } if (!dateString || typeof dateString !== 'string' || !/^\d{4}-\d{2}-\d{2}$/.test(dateString)) { displayElement.textContent = ''; return; } try { const date = new Date(dateString + 'T00:00:00'); // Ensure it's treated as local
             const options = { timeZone: 'Africa/Cairo', weekday: 'long' }; const dayName = date.toLocaleDateString('ar-EG', options); displayElement.textContent = `(${dayName})`; } catch (e) { console.error("Error getting day name for", dateString, ":", e); displayElement.textContent = ''; } }
        function getPreviousDayString(dateString) { try { const date = new Date(dateString + 'T00:00:00'); date.setDate(date.getDate() - 1); const year = date.getFullYear(); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; } catch (e) { console.error("Error calculating previous day for", dateString, e); return null; } }
        // الدالة الجديدة لتحديد اليوم التالي
        function getNextDayString(dateString) {
             try {
                 const date = new Date(dateString + 'T00:00:00'); // Treat as local date
                 date.setDate(date.getDate() + 1);
                 const year = date.getFullYear();
                 const month = String(date.getMonth() + 1).padStart(2, '0');
                 const day = String(date.getDate()).padStart(2, '0');
                 return `${year}-${month}-${day}`;
             } catch (e) {
                 console.error("Error calculating next day for", dateString, e);
                 return null;
             }
          }
        function generateId(prefix = 'id') { return `${prefix}-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`; }
        function getMonthStartDateEndDate(yearMonth) { //YYYY-MM format
             try {
                 const [year, month] = yearMonth.split('-').map(Number);
                 if (isNaN(year) || isNaN(month) || month < 1 || month > 12) {
                     throw new Error("Invalid year-month format");
                 }
                 const startDate = new Date(Date.UTC(year, month - 1, 1));
                 const endDate = new Date(Date.UTC(year, month, 0)); // Last day of the month
                 const dates = [];
                 let currentDate = new Date(startDate);
                 // Ensure loop doesn't run indefinitely if date logic is flawed
                 let safetyCounter = 0;
                 while (currentDate <= endDate && safetyCounter < 32) {
                     dates.push(currentDate.toISOString().split('T')[0]); // Get YYYY-MM-DD in UTC
                     currentDate.setUTCDate(currentDate.getUTCDate() + 1);
                     safetyCounter++;
                 }
                 return dates; // Array of YYYY-MM-DD strings for the month
             } catch (error) {
                 console.error("Error generating dates for month:", yearMonth, error);
                 return []; // Return empty array on error
             }
          }
        function updateTimeDisplay() {
            if (!currentTimeDisplay) return;
            const now = new Date();
            // Use Intl.DateTimeFormat for better locale support and options
            const options = { timeZone: 'Africa/Cairo', hour: 'numeric', minute: '2-digit', second: '2-digit', hour12: true };
            currentTimeDisplay.textContent = new Intl.DateTimeFormat('ar-EG', options).format(now);
        }
        // ================== بداية الدالة المساعدة الجديدة ==================
async function saveInvoiceToFirestore(invoiceRecord) {
    if (!window.currentUser) return;
    const userId = window.currentUser.uid;
    
    // ضمان وجود تاريخ البيع
    if (!invoiceRecord.saleDate) {
        invoiceRecord.saleDate = currentLoadedDate || new Date().toISOString().split('T')[0];
    }

    try {
        const invoiceDocRef = window.doc(window.db, "users", userId, "invoices", invoiceRecord.id);
        // ننتظر حتى ينتهي الحفظ تماماً
        await window.setDoc(invoiceDocRef, invoiceRecord);
        console.log(`تم رفع الفاتورة ${invoiceRecord.invoiceNumber} للسحابة بنجاح.`);
    } catch (error) {
        console.error("خطأ في الرفع للسحابة:", error);
        // تنبيه المستخدم بوجود مشكلة في السحابة
        alert(`تنبيه: تم حفظ الفاتورة محلياً، ولكن فشل رفعها للسحابة.\nالسبب: ${error.message}`);
    }
}
// ================== بداية دالة ترحيل البيانات القديمة ==================
async function migrateOldSalesToInvoicesCollection() {
    if (!window.currentUser) { 
        alert("يرجى تسجيل الدخول أولاً قبل بدء الترحيل.");
        return; 
    }
    if (!confirm("هل أنت متأكد من رغبتك في بدء عملية ترحيل المبيعات القديمة؟ قد تستغرق هذه العملية بعض الوقت. تأكد من أنك أخذت نسخة احتياطية.")) {
        return;
    }

    const userId = window.currentUser.uid;
    console.log("Starting migration of old sales data...");
    alert("بدأت عملية ترحيل البيانات. يرجى إبقاء هذه النافذة مفتوحة ومراقبة الـ Console (F12) للمتابعة.");
    let migratedCount = 0;
    
    // حدد نطاق التاريخ الذي تريد ترحيل بياناته (عدّل التاريخ حسب الحاجة)
    const startDate = new Date('2023-01-01'); // ابدأ من تاريخ قديم
    const endDate = new Date(); // حتى اليوم
    
    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
        const dateStr = d.toISOString().split('T')[0];
        const dayDocRef = window.doc(window.db, "users", userId, "days", dateStr);
        
        try {
            const dayDocSnap = await window.getDoc(dayDocRef);

            if (dayDocSnap.exists()) {
                const dayData = dayDocSnap.data();
                const salesForThisDay = dayData.salesToday || [];
                
                if (salesForThisDay.length > 0) {
                    console.log(`Found ${salesForThisDay.length} sales for ${dateStr}. Migrating...`);
                    for (const sale of salesForThisDay) {
                        // أهم خطوة: إضافة تاريخ البيع للبحث
                        if(sale.id && !sale.saleDate) { // تأكد من وجود ID وأنها ليست مرحّلة من قبل
                           sale.saleDate = dateStr; 
                           const invoiceDocRef = window.doc(window.db, "users", userId, "invoices", sale.id);
                           await window.setDoc(invoiceDocRef, sale);
                           migratedCount++;
                        }
                    }
                }
            }
        } catch(e) {
            console.error(`Could not process date ${dateStr}:`, e);
        }
    }
    console.log(`Migration complete! Total sales migrated: ${migratedCount}`);
    alert(`اكتملت عملية الترحيل! تم ترحيل ${migratedCount} عملية بيع قديمة بنجاح!`);
    
}
// =================== نهاية دالة ترحيل البيانات القديمة ===================
window.migrateOldSalesToInvoicesCollection = migrateOldSalesToInvoicesCollection;

        // --- Undo/Redo State Management Functions ---

function createStateSnapshot() {
    return {
        products: JSON.parse(JSON.stringify(products)),
        suppliers: JSON.parse(JSON.stringify(suppliers)),
        accounts: JSON.parse(JSON.stringify(accounts)),
        expenses: expenses,
        debtors: JSON.parse(JSON.stringify(debtors)),
        liabilities: JSON.parse(JSON.stringify(liabilities)),
        monthlyLiabilities: JSON.parse(JSON.stringify(monthlyLiabilities)),
        totalProfit: totalProfit,
        operationLog: JSON.parse(JSON.stringify(operationLog)),
        pendingSales: JSON.parse(JSON.stringify(pendingSales)),
        liquidityLog: JSON.parse(JSON.stringify(liquidityLog)),
        salesToday: JSON.parse(JSON.stringify(salesToday)),
        serialNumbersLog: JSON.parse(JSON.stringify(serialNumbersLog)),
        purchaseInvoices: JSON.parse(JSON.stringify(purchaseInvoices)),
        pendingPurchases: JSON.parse(JSON.stringify(pendingPurchases)),
        completedReturns: JSON.parse(JSON.stringify(completedReturns)),
        pendingReturns: JSON.parse(JSON.stringify(pendingReturns))
    };
}

function loadStateFromSnapshot(snapshot) {
    products = snapshot.products || [];
    suppliers = snapshot.suppliers || [];
    accounts = snapshot.accounts || [];
    expenses = snapshot.expenses || 0;
    debtors = snapshot.debtors || [];
    liabilities = snapshot.liabilities || [];
    monthlyLiabilities = snapshot.monthlyLiabilities || [];
    totalProfit = snapshot.totalProfit || 0;
    operationLog = snapshot.operationLog || [];
    pendingSales = snapshot.pendingSales || [];
    liquidityLog = snapshot.liquidityLog || [];
    salesToday = snapshot.salesToday || [];
    serialNumbersLog = snapshot.serialNumbersLog || [];
    purchaseInvoices = snapshot.purchaseInvoices || [];
    pendingPurchases = snapshot.pendingPurchases || [];
    completedReturns = snapshot.completedReturns || [];
    pendingReturns = snapshot.pendingReturns || [];
}

function saveStateToHistory() {
    // هذه هي الدالة الرئيسية التي سنستدعيها قبل كل إجراء
    // 1. أضف الحالة الحالية إلى ذاكرة التراجع
    stateHistory.push(createStateSnapshot());

    // 2. امسح ذاكرة الإعادة، لأن أي إجراء جديد يلغيها
    redoHistory = [];

    // 3. تفعيل زر التراجع وتعطيل زر الإعادة
    const undoBtn = d('undo-button');
    const redoBtn = d('redo-button');
    if (undoBtn) undoBtn.disabled = false;
    if (redoBtn) redoBtn.disabled = true;

    // اختياري: وضع حد لذاكرة التراجع لمنع استهلاك ذاكرة كبير جدًا
    if (stateHistory.length > 50) {
        stateHistory.shift(); // إزالة أقدم عنصر
    }
}
function updateUndoRedoButtons() {
    // تحديث حالة أزرار التراجع والإعادة
    const undoBtn = d('undo-button');
    const redoBtn = d('redo-button');
    if (undoBtn) undoBtn.disabled = stateHistory.length === 0;
    if (redoBtn) redoBtn.disabled = redoHistory.length === 0;
}
// ==========================================
// 1. دالة التراجع الذكية (Super Undo)
// ==========================================
async function undo() {
    if (stateHistory.length === 0) {
        console.log("No more states to undo.");
        return;
    }

    // لقطة للوضع الحالي قبل التغيير
    const currentInvoiceIds = salesToday.map(inv => inv.id);

    // نقل الحالة الحالية إلى ذاكرة "الإعادة"
    redoHistory.push(createStateSnapshot());

    // استرجاع الحالة السابقة
    const lastState = stateHistory.pop();
    const previousInvoiceIds = lastState.salesToday.map(inv => inv.id);

    // تطبيق الحالة السابقة محلياً
    loadStateFromSnapshot(lastState);

    const userId = window.currentUser ? window.currentUser.uid : null;

    if (userId) {
        // أ. السيناريو الأول: التراجع عن "إنشاء" (حذف ما تم إنشاؤه)
        // الفواتير الموجودة "الآن" وليست في "الماضي" = تم إنشاؤها حديثاً ويجب حذفها
        const createdInvoiceIds = currentInvoiceIds.filter(id => !previousInvoiceIds.includes(id));
        
        if (createdInvoiceIds.length > 0) {
            console.log(`Undo: جاري حذف ${createdInvoiceIds.length} فاتورة من السحابة...`);
            await Promise.all(createdInvoiceIds.map(id => 
                window.deleteDoc(window.doc(window.db, "users", userId, "invoices", id)).catch(e => console.error(e))
            ));
        }

        // ب. السيناريو الثاني: التراجع عن "حذف" (استعادة ما تم حذفه)
        // الفواتير الموجودة في "الماضي" وليست "الآن" = تم حذفها ويجب استعادتها
        const restoredInvoiceIds = previousInvoiceIds.filter(id => !currentInvoiceIds.includes(id));
        
        if (restoredInvoiceIds.length > 0) {
            console.log(`Undo: جاري استعادة ${restoredInvoiceIds.length} فاتورة محذوفة للسحابة...`);
            const restorePromises = restoredInvoiceIds.map(id => {
                const invoiceData = lastState.salesToday.find(inv => inv.id === id);
                if (invoiceData) {
                    if (!invoiceData.saleDate) invoiceData.saleDate = invoiceData.timestamp.split('T')[0];
                    return window.setDoc(window.doc(window.db, "users", userId, "invoices", id), invoiceData, { merge: true });
                }
            });
            await Promise.all(restorePromises);
        }
    }

    // حفظ التغييرات الشاملة (المخزون، السيولة، إلخ)
    await saveSystemToCloud();
    
    updateUI();
    updateUndoRedoButtons();
    
    // تحديث التقرير إذا كان مفتوحاً
    if(typeof generateMonthlySalesReport === 'function' && document.getElementById('sales-report-section') && !document.getElementById('sales-report-section').classList.contains('hidden')) {
        generateMonthlySalesReport();
    }
    
    showGlobalMessage("تم التراجع ومزامنة السحابة بنجاح.", false);
}

// ==========================================
// 2. دالة الإعادة الذكية (Super Redo)
// ==========================================
async function redo() {
    if (redoHistory.length === 0) {
        console.log("No more states to redo.");
        return;
    }

    // لقطة للوضع الحالي قبل التغيير
    const currentInvoiceIds = salesToday.map(inv => inv.id);

    // نقل الحالة الحالية إلى ذاكرة "التراجع"
    stateHistory.push(createStateSnapshot());

    // استرجاع الحالة القادمة (المستقبل)
    const nextState = redoHistory.pop();
    const nextInvoiceIds = nextState.salesToday.map(inv => inv.id);

    // تطبيق الحالة القادمة محلياً
    loadStateFromSnapshot(nextState);

    const userId = window.currentUser ? window.currentUser.uid : null;

    if (userId) {
        // أ. السيناريو الأول: إعادة "الإنشاء" (استعادة ما تم التراجع عن إنشائه)
        // الفواتير الموجودة في "المستقبل" وليست "الآن" = يجب رفعها للسحابة
        const reCreatedInvoiceIds = nextInvoiceIds.filter(id => !currentInvoiceIds.includes(id));

        if (reCreatedInvoiceIds.length > 0) {
            console.log(`Redo: جاري إعادة رفع ${reCreatedInvoiceIds.length} فاتورة للسحابة...`);
            const restorePromises = reCreatedInvoiceIds.map(id => {
                const invoiceData = nextState.salesToday.find(inv => inv.id === id);
                if (invoiceData) {
                    if (!invoiceData.saleDate) invoiceData.saleDate = invoiceData.timestamp.split('T')[0];
                    return window.setDoc(window.doc(window.db, "users", userId, "invoices", id), invoiceData, { merge: true });
                }
            });
            await Promise.all(restorePromises);
        }

        // ب. السيناريو الثاني: إعادة "الحذف" (حذف ما تم التراجع عن حذفه)
        // الفواتير الموجودة "الآن" وليست في "المستقبل" = يجب حذفها من السحابة مرة أخرى
        const reDeletedInvoiceIds = currentInvoiceIds.filter(id => !nextInvoiceIds.includes(id));

        if (reDeletedInvoiceIds.length > 0) {
            console.log(`Redo: جاري إعادة حذف ${reDeletedInvoiceIds.length} فاتورة من السحابة...`);
            await Promise.all(reDeletedInvoiceIds.map(id => 
                window.deleteDoc(window.doc(window.db, "users", userId, "invoices", id)).catch(e => console.error(e))
            ));
        }
    }

    // حفظ التغييرات الشاملة
    await saveSystemToCloud();

    updateUI();
    updateUndoRedoButtons();

    // تحديث التقرير إذا كان مفتوحاً
    if(typeof generateMonthlySalesReport === 'function' && document.getElementById('sales-report-section') && !document.getElementById('sales-report-section').classList.contains('hidden')) {
        generateMonthlySalesReport();
    }
    
    showGlobalMessage("تمت الإعادة ومزامنة السحابة.", false);
}

        // --- دوال المنطق الأساسي ---
function calculateConsignmentValue() {
    return pendingSales.reduce((sum, sale) => {
        let saleCost = 0;
        
        // يتحقق إذا كان البيع المؤقت هو فاتورة مفصلة (تحتوي على totalCost)
        if (sale.items && sale.totalCost !== undefined) {
            saleCost = Number(sale.totalCost) || 0;
        } 
        // إذا لم يكن كذلك، يستخدم الطريقة القديمة للبيع المؤقت السريع
        else if (sale.mainProduct) {
            const mainCost = (Number(sale.mainProduct.costPrice) || 0) * (Number(sale.mainProduct.quantity) || 0);
            const additionalCost = (sale.additionalItems || []).reduce((addSum, item) => addSum + ((Number(item.costPrice) || 0) * (Number(item.quantity) || 0)), 0);
            saleCost = mainCost + additionalCost;
        }

        return sum + saleCost;
    }, 0);
}
    // ✅✅✅ الكود النهائي والصحيح لدالة loadState (لحل مشكلة الاستيراد) ✅✅✅
function loadState(data, dateString) {
    resetState(); // ابدأ دائمًا بحالة نظيفة

    products = data.products || [];
    suppliers = data.suppliers || [];
    
    // هذا الجزء يعالج السيولة القديمة والجديدة وهو صحيح
    if (data.accounts && Array.isArray(data.accounts) && data.accounts.length > 0) {
        accounts = data.accounts;
    } else {
        console.log("Migrating old 'liquidity' value to new 'accounts' system.");
        accounts = [{ id: 'main', name: 'الخزينة الرئيسية', balance: parseFloat(data.liquidity) || 0 }];
    }

    expenses = parseFloat(data.expenses) || 0;
    debtors = data.debtors || [];
    liabilities = data.liabilities || [];
    monthlyLiabilities = data.monthlyLiabilities || [];
    totalProfit = parseFloat(data.profit) || 0;
    operationLog = data.log || [];
    pendingSales = data.pendingSales || [];
    liquidityLog = data.liquidityLog || [];
    salesToday = data.salesToday || [];
    serialNumbersLog = data.serialNumbersLog || [];

    // --- ✅ الأسطر الحاسمة التي كانت مفقودة وتسببت في مشكلة الاستيراد ---
    purchaseInvoices = data.purchaseInvoices || []; 
    pendingPurchases = data.pendingPurchases || [];
    completedReturns = data.completedReturns || [];
    pendingReturns = data.pendingReturns || [];
    pendingReturnsValue = data.pendingReturnsValue || 0;
    // --- ✅ نهاية الجزء المضاف ---

    currentLoadedDate = dateString;

    // تصفير سجل التراجع/الإعادة
    stateHistory = []; 
    redoHistory = [];
    updateUndoRedoButtons();
}
// ✅✅✅ الكود الجديد والصحيح لدالة resetState ✅✅✅
function resetState() {
    console.log("resetState called - Clearing DAILY transactions only.");

    // تصفير بيانات العمليات اليومية فقط
    expenses = 0;
    totalProfit = 0;
    operationLog = [];
    liquidityLog = [];
    salesToday = [];
    purchaseInvoices = [];
    completedReturns = [];
    
    // تصفير حالات التعديل
    editingPendingSaleId = null;
    editingProductName = null;
    editingSupplierId = null;
    editingMonthlyLiabilityId = null;
    currentLoadedDate = null;

    // تصفير سجل التراجع/الإعادة
    stateHistory = [];
    redoHistory = [];
    updateUndoRedoButtons();

    // مسح الرسائل
    const messageElements = document.querySelectorAll('.section-message, .error-message');
    messageElements.forEach(el => {
        el.textContent = '';
        el.classList.remove('visible', 'error', 'success', 'info');
    });
}
        function logOperation(type, details){ const timestamp = new Date().toISOString(); operationLog.push({timestamp, type, details}); updateLogDisplay() } // Log display updated immediately
        function calculateTotalDebts(){ const total = debtors.reduce((sum, debtor) => sum + (Number(debtor.amount) || 0), 0); return total; }
        function calculateTotalLiabilities(){ return liabilities.reduce((sum, liability) => sum + (Number(liability.amount) || 0), 0) }
      



function calculateTotals() {
    // 1. قيمة المخزون (بسعر التكلفة)
    const totalInventoryValue = products.reduce((sum, p) => sum + ((Number(p.quantity) || 0) * (Number(p.costPrice) || 0)), 0);
    
    // 2. قيمة البضاعة المؤقتة (أصل)
    let goodsOnConsignmentValue = 0;
    if (typeof calculateConsignmentValue === 'function') {
        goodsOnConsignmentValue = calculateConsignmentValue();
    }

    // 3. الديون والالتزامات
    const totalDebtsValue = calculateTotalDebts(); 
    const totalLiabilitiesValue = calculateTotalLiabilities(); 

    // 4. السيولة النقدية
    const totalLiquidity = accounts.reduce((sum, acc) => sum + (acc.balance || 0), 0);

    // 5. الأصول المعلقة الأخرى (المشتريات التي لم تصل)
    const pendingPurchasesAssetValue = pendingPurchases.reduce((sum, p) => sum + (p.paidAmount || 0), 0);
    
    // 🔥 التصحيح: حساب قيمة المرتجعات مباشرة من المصفوفة لضمان الدقة حتى لو تفرغ المتغير
    const pendingReturnsAssetValue = pendingReturns.reduce((sum, r) => sum + (Number(r.returnedAmount) || 0), 0);

    // 6. العربونات المستلمة (التزام مؤقت)
    const totalPendingDeposits = pendingSales.reduce((sum, sale) => sum + (Number(sale.depositPaid) || 0), 0);

    // المعادلة المحاسبية الشاملة لرأس المال
    const totalCapital = (totalInventoryValue + goodsOnConsignmentValue + totalLiquidity + totalDebtsValue + pendingPurchasesAssetValue + pendingReturnsAssetValue) - (totalLiabilitiesValue + totalPendingDeposits);

    return {
        totalInventoryValue,
        totalCapital,
        totalDebtsValue,
        totalLiabilitiesValue,
        totalPendingDeposits,
        calculatedPendingReturnsValue: pendingReturnsAssetValue, // نمرر القيمة للملخص
        calculatedPendingPurchasesValue: pendingPurchasesAssetValue // نمرر القيمة للملخص
    };
}
function calculateTotalPurchasesToday() {
    if (!purchaseInvoices || purchaseInvoices.length === 0) {
        return 0;
    }
    return purchaseInvoices.reduce((total, invoice) => total + (Number(invoice.grandTotal) || 0), 0);
}
        // --- Supplier Management Functions ---
        function resetSupplierForm() { editingSupplierId = null; if(supplierNameInput) supplierNameInput.value = ""; if(supplierContactInput) supplierContactInput.value = ""; if(supplierAddressInput) supplierAddressInput.value = ""; if(addSupplierButton) addSupplierButton.textContent = "إضافة / تحديث المورد"; if(supplierFormTitle) supplierFormTitle.textContent = "إضافة مورد جديد"; if(cancelEditSupplierButton) cancelEditSupplierButton.classList.add('hidden'); if(supplierMessage) { showMessage(supplierMessage,""); supplierMessage.classList.remove('visible','error','success','info'); } }
        function updateSuppliersListDisplay() {
             if(!supplierList) return;
             if (suppliers.length === 0) {
                 supplierList.innerHTML = '<p class="text-center text-gray-500 col-span-full">لا يوجد موردين مسجلين بعد.</p>';
             } else {
                 const sortedSuppliers = [...suppliers].sort((a, b) => a.name.localeCompare(b.name, 'ar'));
                 supplierList.innerHTML = sortedSuppliers.map(supplier => `
                     <div class="bg-gray-50 rounded-lg shadow p-4 border border-gray-200 flex flex-col justify-between">
                         <div>
                             <h4 class="text-lg font-semibold text-gray-800 mb-2">${supplier.name}</h4>
                             ${supplier.contact ? `<p class="text-gray-600 text-sm">الاتصال: ${supplier.contact}</p>` : ''}
                             ${supplier.address ? `<p class="text-gray-600 text-sm">العنوان: ${supplier.address}</p>` : ''}
                         </div>
                         <div class="mt-3 pt-3 border-t border-gray-200 flex justify-end gap-2 supplier-actions">
                             <button data-supplier-id="${supplier.id}" class="edit-supplier-btn text-xs bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-semibold py-1 px-2 rounded border border-yellow-500">تعديل</button>
                             <button data-supplier-id="${supplier.id}" class="delete-supplier-btn text-xs bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-2 rounded border border-red-600">حذف</button>
                         </div>
                     </div>
                 `).join('');
             }
             // **** تحديث datalist لأسماء الموردين للبحث ****
             if(supplierNamesDatalist) {
                 supplierNamesDatalist.innerHTML = suppliers.map(s => `<option value="${s.name}"></option>`).join('');
             }
         }
        function updateSupplierDropdown(selectElementId, selectedSupplierId = null) { const selectElement = d(selectElementId); if (!selectElement) { /*console.warn(`Dropdown element #${selectElementId} not found yet.`);*/ return; } const currentVal = selectElement.value; selectElement.innerHTML = '<option value="">-- اختر المورد --</option>'; const sortedSuppliers = [...suppliers].sort((a, b) => a.name.localeCompare(b.name, 'ar')); sortedSuppliers.forEach(supplier => { const option = document.createElement('option'); option.value = supplier.id; option.textContent = supplier.name; if (selectedSupplierId && supplier.id === selectedSupplierId) { option.selected = true; } else if (!selectedSupplierId && supplier.id === currentVal) { // Retain current selection if not specifically overridden
                 option.selected = true; } selectElement.appendChild(option); }); }
        function addOrUpdateSupplier() { if (!supplierNameInput || !supplierContactInput || !supplierAddressInput || !supplierMessage) return; // Ensure elements exist
             const name = supplierNameInput.value.trim(); const contact = supplierContactInput.value.trim(); const address = supplierAddressInput.value.trim(); if (!name) { showMessage(supplierMessage, "اسم المورد مطلوب.", true); return; } if (editingSupplierId) { const supplierIndex = suppliers.findIndex(s => s.id === editingSupplierId); if (supplierIndex > -1) { const oldName = suppliers[supplierIndex].name; suppliers[supplierIndex].name = name; suppliers[supplierIndex].contact = contact; suppliers[supplierIndex].address = address; logOperation("تعديل مورد", `تم تعديل بيانات المورد "${oldName}" إلى "${name}".`); showMessage(supplierMessage, `تم تحديث المورد "${name}" بنجاح.`); } else { showMessage(supplierMessage, `خطأ: المورد المحدد للتعديل غير موجود.`, true); } resetSupplierForm(); } else { // Check if name already exists
             const nameExists = suppliers.some(s => s.name.toLowerCase() === name.toLowerCase());
             if (nameExists) {
                 showMessage(supplierMessage, `المورد "${name}" موجود بالفعل.`, true);
                 return;
             }
             const newSupplier = { id: generateId('sup'), name: name, contact: contact, address: address }; suppliers.push(newSupplier); logOperation("إضافة مورد", `تم إضافة مورد جديد: "${name}".`); showMessage(supplierMessage, `تمت إضافة المورد "${name}" بنجاح.`); supplierNameInput.value = ""; // Clear only name on successful add
                 supplierContactInput.value = ""; supplierAddressInput.value = ""; supplierNameInput.focus(); } updateUI(); } // Update UI including dropdowns
        function editSupplier(supplierId) { const supplier = suppliers.find(s => s.id === supplierId); if (supplier && supplierNameInput && supplierContactInput && supplierAddressInput && supplierFormTitle && addSupplierButton && cancelEditSupplierButton) { editingSupplierId = supplierId; supplierNameInput.value = supplier.name; supplierContactInput.value = supplier.contact || ""; supplierAddressInput.value = supplier.address || ""; supplierFormTitle.textContent = `تعديل المورد: ${supplier.name}`; addSupplierButton.textContent = "تحديث المورد"; cancelEditSupplierButton.classList.remove('hidden'); d('add-update-supplier-form').scrollIntoView({ behavior: 'smooth' }); } else { showMessage(supplierMessage, "المورد المحدد غير موجود أو عناصر النموذج غير جاهزة.", true); } }
        function deleteSupplier(supplierId) {
             const supplierIndex = suppliers.findIndex(s => s.id === supplierId);
             if (supplierIndex > -1) {
                 const supplierName = suppliers[supplierIndex].name;
                 if (confirm(`هل أنت متأكد من حذف المورد "${supplierName}"؟ سيتم إزالة ربطه من جميع المنتجات والأرقام التسلسلية المسجلة باسمه.`)) {
                     suppliers.splice(supplierIndex, 1);
                     let updatedProductsCount = 0;
                     products.forEach(p => {
                         if (p.supplierId === supplierId) {
                             p.supplierId = "";
                             updatedProductsCount++;
                         }
                     });
                     // **** حذف السيريالات المرتبطة بالمورد المحذوف ****
                     const initialSerialCount = serialNumbersLog.length;
                     serialNumbersLog = serialNumbersLog.filter(log => log.supplierId !== supplierId);
                     const deletedSerialCount = initialSerialCount - serialNumbersLog.length;

                     logOperation("حذف مورد", `تم حذف المورد "${supplierName}". تم فك ارتباط ${updatedProductsCount} منتج. تم حذف ${deletedSerialCount} رقم تسلسلي مسجل باسمه.`);
                     showMessage(supplierMessage, `تم حذف المورد "${supplierName}" والسيريالات المرتبطة به.`);
                     if (editingSupplierId === supplierId) { resetSupplierForm(); }
                     updateUI();
                 }
             } else {
                 showMessage(supplierMessage, "المورد المحدد غير موجود.", true);
             }
          }

        // *** JavaScript - (Corresponding to original Part 5) Ends Here ***
        // *** JavaScript - (Corresponding to original Part 6) Starts Here ***

        // --- دوال تحديث الواجهة (UI Updates) ---
    // === 3. استبدل الدالة القديمة بالكامل بهذه الدالة ===
function updateProductListDisplay() {
    // التأكد من تحميل كل العناصر قبل المتابعة
    if (!productList || !productNamesDatalist || !inventorySearchInput || !inventoryCategoryFilter || !categoryDatalist) {
        // console.warn("Product list UI elements not fully loaded yet.");
        return;
    }

    // --- 1. تحديث قائمة الأقسام (للفلترة وللإكمال التلقائي) ---
    // استخراج كل الأقسام الفريدة من قائمة المنتجات الكاملة
    const allCategories = [...new Set(products.map(p => p.category || '').filter(Boolean))].sort((a, b) => a.localeCompare(b, 'ar'));
    
    // تحديث قائمة الفلترة <select>
    const currentCategoryFilter = inventoryCategoryFilter.value; // حفظ الاختيار الحالي
    inventoryCategoryFilter.innerHTML = '<option value="all">كل الأقسام</option>'; // إعادة تعيين القائمة
    allCategories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        inventoryCategoryFilter.appendChild(option);
    });
    inventoryCategoryFilter.value = currentCategoryFilter; // إعادة الاختيار الحالي إن كان لا يزال موجوداً

    // تحديث قائمة الإكمال التلقائي <datalist> في نموذج الإضافة
    categoryDatalist.innerHTML = allCategories.map(cat => `<option value="${cat}"></option>`).join('');

    // --- 2. الحصول على قيم التصفية الحالية ---
    const searchTerm = inventorySearchInput.value.trim().toLowerCase();
    const selectedCategory = inventoryCategoryFilter.value;

   const filteredProducts = products.filter(product => {
        const nameMatch = !searchTerm || product.name.toLowerCase().includes(searchTerm);
        const categoryMatch = (selectedCategory === 'all') || (product.category === selectedCategory);
        
        // ✅ إضافة هذا الشرط لضمان عدم عرض أي منتج كميته صفر
        const hasQuantity = (Number(product.quantity) || 0) > 0; 
        
        return nameMatch && categoryMatch && hasQuantity;
    });
    
    // --- 4. عرض المنتجات المفلترة ---
    if (filteredProducts.length === 0) {
        if (products.length === 0) {
            productList.innerHTML = '<p class="text-center text-gray-500 col-span-full">لا توجد بضائع حتى الآن.</p>';
        } else {
            productList.innerHTML = '<p class="text-center text-gray-500 col-span-full">لا توجد منتجات تطابق البحث أو التصفية.</p>';
        }
    } else {
        // فرز المنتجات المفلترة أبجديًا
        const sortedProducts = [...filteredProducts].sort((a, b) => a.name.localeCompare(b.name, 'ar'));
        
        // بناء HTML
        const productsHTML = sortedProducts.map(product => {
            const supplier = suppliers.find(s => s.id === product.supplierId);
            const registeredSerialsCount = serialNumbersLog.filter(s => s.productName === product.name).length;
            const quantity = Number(product.quantity) || 0;
            const unregisteredCount = quantity - registeredSerialsCount;
            
            // إضافة كود HTML لعرض القسم (إذا كان موجودًا)
            const categoryHTML = product.category ? `<p class="text-xs font-semibold text-blue-600 bg-blue-100 px-2 py-0.5 rounded-full inline-block mt-2">${product.category}</p>` : '';

            // كود بطاقة المنتج مع إضافة القسم
            return `<div class="bg-gray-50 rounded-lg shadow p-4 border border-gray-200 flex flex-col justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">${product.name || 'غير مسمى'}</h3>
                            <p class="text-gray-600 text-sm">الكمية الإجمالية: <span class="font-semibold text-blue-500">${quantity}</span></p>
                            <p class="text-gray-600 text-sm">السيريالات المسجلة: <span class="font-semibold text-green-600">${registeredSerialsCount}</span></p>
                            ${unregisteredCount > 0 ? `<p class="text-xs text-red-500">قطع غير مسجلة: ${unregisteredCount}</p>` : ''}
                            <p class="text-gray-600 text-sm">المورد: <span class="font-semibold text-cyan-600">${supplier ? supplier.name : '-'}</span></p>
                            <p class="text-gray-600 text-sm">متوسط التكلفة: <span class="font-semibold text-purple-500">${formatCurrency(product.costPrice)}</span></p>
                            <p class="text-gray-600 text-sm">إجمالي التكلفة: <span class="font-semibold text-gray-700">${formatCurrency(quantity * (Number(product.costPrice) || 0))}</span></p>
                            ${categoryHTML}
                        </div>
                        <div class="mt-3 pt-3 border-t border-gray-200 flex justify-end gap-2 product-actions">
                            <button data-product-name="${product.name}" class="manage-serials-btn text-xs font-semibold py-1 px-2 rounded">إدارة السيريالات</button>
                            <button data-product-name="${product.name}" class="edit-product-btn text-xs bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-semibold py-1 px-2 rounded border border-yellow-500">تعديل</button>
                            <button data-product-name="${product.name}" class="delete-product-btn text-xs bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-2 rounded border border-red-600">حذف</button>
                        </div>
                    </div>`;
        }).join('');
        
        productList.innerHTML = productsHTML;
    }
    
    // --- 5. تحديث قائمة الإكمال التلقائي لاسم المنتج (يجب أن تستخدم القائمة الكاملة دائمًا) ---
    productNamesDatalist.innerHTML = products.map(p => `<option value="${p.name}"></option>`).join('');
}
 function updateLogDisplay(){if(!operationLogList){return;} if(operationLog.length === 0){operationLogList.innerHTML = '<li class="text-center text-gray-500 list-none">لا توجد عمليات مسجلة بعد.</li>';} else {operationLogList.innerHTML = [...operationLog].reverse().map(log => `<li class=""><span class="font-semibold text-gray-700">${log.type}:</span> <span class="text-gray-600">${log.details}</span><span class="block text-xs text-gray-400">${formatDateTime(log.timestamp)}</span></li>`).join('');} }
      function updateAdditionalCostsCheckboxes() {
    if (!additionalCostsContainer || !sellProductNameInput) return;
    const mainProductName = sellProductNameInput.value.trim().toLowerCase();
    const otherProducts = products.filter(p => p.name.trim().toLowerCase() !== mainProductName && p.quantity > 0);

    additionalCostsContainer.innerHTML = ''; // أفرغ الحاوية أولاً

    if (otherProducts.length === 0) {
        additionalCostsContainer.innerHTML = '<p class="text-center text-gray-500 text-sm">لا توجد منتجات أخرى متاحة لخصم تكلفتها.</p>';
        return;
    }

    otherProducts.sort((a, b) => a.name.localeCompare(b.name, 'ar')).forEach(product => {
        const uniqueId = `addcost-${generateId(product.name)}`;
        const label = document.createElement('label');
        // استخدام flexbox لتنسيق العناصر على نفس السطر
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.gap = '10px'; // مسافة بين العناصر
        label.style.marginBottom = '8px';

        label.innerHTML = `
            <input type="checkbox" value="${product.name}" data-cost="${product.costPrice}" id="${uniqueId}" style="flex-shrink: 0;">
            <span style="flex-grow: 1;">
                ${product.name} (متوسط التكلفة: ${formatCurrency(product.costPrice)}, المتاح: ${product.quantity})
            </span>
            <span style="flex-shrink: 0;">الكمية للخصم:</span>
            <input type="number" class="additional-item-quantity" min="1" value="1" style="width: 60px; text-align: center; flex-shrink: 0; border: 1px solid #ccc; border-radius: 4px; padding: 2px;">
        `;
        additionalCostsContainer.appendChild(label);
    });
    // التحديث الجديد لحساب الدين
    if (typeof window.updateQuickSaleDebt === 'function') window.updateQuickSaleDebt();
}
        // =====================================================================
function updateDebtorsListDisplay() {
    if (!debtorsListContainer) return;
    debtorsListContainer.innerHTML = ''; // Clear previous content

    const groupedDebts = debtors.reduce((acc, debt) => {
        const name = debt.name;
        if (!acc[name]) {
            acc[name] = { total: 0, items: [] };
        }
        const amount = Number(debt.amount) || 0;
        if (amount > 0.001) { // Only include non-zero amounts
            acc[name].total += amount;
            acc[name].items.push({ id: debt.id, reason: debt.reason || 'سبب غير محدد', amount: amount });
        }
        return acc;
    }, {});

    const sortedNames = Object.keys(groupedDebts).filter(name => groupedDebts[name].total > 0.001)
        .sort((a, b) => a.localeCompare(b, 'ar'));

    if (sortedNames.length === 0) {
        debtorsListContainer.innerHTML = '<p class="text-center text-gray-500 py-4">لا توجد ديون مسجلة حاليًا بمبالغ ظاهرة.</p>';
        return;
    }

    sortedNames.forEach(name => {
        const debtorData = groupedDebts[name];
        const detailsElement = document.createElement('details');
        detailsElement.className = 'mb-2 border border-gray-200 rounded overflow-hidden shadow-sm';

        const summaryElement = document.createElement('summary');
        summaryElement.className = 'p-3 bg-gray-50 hover:bg-gray-100 cursor-pointer flex justify-between items-center font-medium text-gray-800';
        summaryElement.innerHTML = `<span>${name}</span><span class="text-purple-700 font-semibold">${formatCurrency(debtorData.total)}</span>`;

        const ulElement = document.createElement('ul');
        ulElement.className = 'p-3 pt-2 border-t border-gray-200 bg-white';

        debtorData.items.sort((a, b) => a.reason.localeCompare(b.reason, 'ar')).forEach(item => {
            const liElement = document.createElement('li');
            liElement.className = 'text-sm text-gray-600 py-1.5 border-b border-gray-100 flex justify-between items-center flex-wrap gap-2';
            
            liElement.innerHTML = `
                <div class="flex-grow">
                    <span>${item.reason}</span>
                    <span class="font-mono text-xs text-gray-500">${formatCurrency(item.amount)}</span>
                </div>
                <div class="actions flex-shrink-0">
                    <button data-debt-id="${item.id}" class="pay-partial-debt-btn text-xs bg-teal-500 hover:bg-teal-600 text-white font-semibold py-1 px-2 rounded">تسديد جزئي</button>
                </div>
            `;
            ulElement.appendChild(liElement);
        });

        detailsElement.appendChild(summaryElement);
        detailsElement.appendChild(ulElement);
        debtorsListContainer.appendChild(detailsElement);
    });
}



function toggleInlinePaymentForm(debtorName) {
    console.log(`toggleInlinePaymentForm called for: ${debtorName}`);

    const targetGroup = document.querySelector(`.debtor-group[data-debtor-name="${debtorName}"]`);
    if (!targetGroup) {
        console.error("Error: Could not find the debtor group element!");
        return;
    }

    const alreadyOpenForm = targetGroup.querySelector('.inline-payment-form');

    // الخطوة 1: قم بإغلاق كل النماذج المفتوحة دائمًا
    document.querySelectorAll('.inline-payment-form').forEach(form => form.remove());

    // الخطوة 2: إذا كان النموذج الذي ضغطنا عليه مفتوحًا بالفعل، فإن الخطوة السابقة قد أغلقته بالفعل.
    // لذلك، لا تفعل شيئًا آخر واخرج من الدالة.
    if (alreadyOpenForm) {
        console.log("Form was already open, now closing it.");
        return;
    }

    // الخطوة 3: إذا وصلنا إلى هنا، فهذا يعني أن النموذج كان مغلقًا، والآن سنقوم بإنشائه وفتحه.
    console.log("Form was closed, now creating and opening it.");

    const totalDebt = debtors
        .filter(d => d.name === debtorName)
        .reduce((sum, debt) => sum + (Number(debt.amount) || 0), 0);

    const formDiv = document.createElement('div');
    formDiv.className = 'inline-payment-form';
    formDiv.dataset.debtorName = debtorName;

    let accountOptions = accounts.map(acc => `<option value="${acc.id}">${acc.name} (${formatCurrency(acc.balance)})</option>`).join('');

    formDiv.innerHTML = `
        <p class="text-sm font-semibold text-gray-700 mb-3">استلام دفعة من ${debtorName} (الإجمالي: ${formatCurrency(totalDebt)})</p>
        <div class="form-grid">
            <div class="form-group">
                <label class="text-xs font-bold">المبلغ المحصّل:</label>
                <input type="number" class="inline-debt-amount-input" placeholder="0.00" min="0.01" max="${totalDebt}" step="0.01" required>
            </div>
            <div class="form-group">
                <label class="text-xs font-bold">إيداع في:</label>
                <select class="inline-debt-account-select">
                    <option value="">-- اختر حساب --</option>
                    ${accountOptions}
                </select>
            </div>
        </div>
        <div class="section-message error mt-2" style="display:none;"></div>
        <div class="flex gap-2 mt-4">
            <button class="confirm-inline-debt-payment text-sm bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded">تأكيد</button>
            <button type="button" class="cancel-inline-debt-payment text-sm bg-gray-400 hover:bg-gray-500 text-white font-bold py-1 px-3 rounded">إلغاء</button>
        </div>
    `;
    
    targetGroup.appendChild(formDiv);
    
    setTimeout(() => {
        formDiv.classList.add('visible');
        formDiv.querySelector('input[type="number"]').focus();
    }, 10);
}


function handleConfirmInlineDebtPayment(debtorName, formElement) {
    // ... (هذه الدالة لم تتغير)
}
// =====================================================================
// == END: DEBUGGING Professional Partial Debt Payment Code ==
// =====================================================================        
         function updateLiquidityLogDisplay(){if(!liquidityLogListContainer)return; if(liquidityLog.length === 0){liquidityLogListContainer.innerHTML = '<li class="text-center text-gray-500">لا توجد عمليات مسجلة على السيولة.</li>'} else {liquidityLogListContainer.innerHTML = [...liquidityLog].reverse().map(log => { const amountClass = log.type === 'add' ? 'add' : (log.type === 'remove' ? 'remove' : ''); // Adjust color for 'adjust' if needed later
            const amountSign = log.type === 'add' ? '+' : (log.type === 'remove' ? '-' : (log.amount >= 0 ? '+' : '')); // Show sign for adjustment based on value
            return `<li><div class="flex justify-between items-start"><div><span class="font-medium ${amountClass}">${amountSign}${formatCurrency(Math.abs(log.amount))}</span> <span class="text-sm details">(${log.description || 'بدون وصف'})</span><span class="block text-xs text-gray-400">${formatDateTime(log.timestamp)}</span></div><span class="text-sm details flex-shrink-0 ml-2">الرصيد: ${formatCurrency(log.currentBalance)}</span></div></li>`}).join('')}}
     function updateLiabilitiesListDisplay() {
    if (!liabilitiesListContainer) return;
    liabilitiesListContainer.innerHTML = ''; // مسح المحتوى السابق

    // تصفية الالتزامات التي لها مبالغ حقيقية فقط
    const validLiabilities = liabilities.filter(l => (Number(l.amount) || 0) > 0.001);

    if (validLiabilities.length === 0) {
        liabilitiesListContainer.innerHTML = '<li class="text-center text-gray-500 py-4">لا توجد التزامات مسجلة حاليًا بمبالغ ظاهرة.</li>';
        return;
    }

    // ترتيب الالتزامات أبجدياً حسب الاسم
    const sortedLiabilities = [...validLiabilities].sort((a, b) => a.name.localeCompare(b.name, 'ar'));

    sortedLiabilities.forEach(liability => {
        const li = document.createElement('li');
        li.className = 'flex justify-between items-center py-2 border-b border-gray-100'; 
        
        // التحقق من وجود معرف فاتورة شراء مرتبطة
        const hasInvoice = !!liability.purchaseInvoiceId;

        let nameHTML = `<span class="font-medium">${liability.name}</span>`; // الشكل الافتراضي للاسم

        // إذا كان الالتزام مرتباً بفاتورة، نجعله رابطاً تفاعلياً لجلب البيانات من الأرشيف
        if (hasInvoice) {
            nameHTML = `
                <div class="view-purchase-invoice-btn" style="cursor: pointer;" data-purchase-invoice-id="${liability.purchaseInvoiceId}">
                    <span class="font-medium text-blue-700 hover:underline">
                        <i class="fas fa-file-invoice ml-1"></i> ${liability.name}
                    </span>
                    <span class="block text-[10px] text-gray-400">اضغط لعرض التفاصيل من الأرشيف السحابي</span>
                </div>
            `;
        }

        // بناء الهيكل النهائي لسطر الالتزام
        li.innerHTML = `
            <div class="flex-grow pr-4">
                ${nameHTML}
            </div>
            <div class="actions flex-shrink-0 flex items-center gap-4">
                <span class="text-pink-700 font-semibold font-mono">${formatCurrency(liability.amount)}</span>
                <button data-liability-id="${liability.id}" class="pay-liability-btn text-xs bg-teal-500 hover:bg-teal-600 text-white font-semibold py-1 px-3 rounded transition-colors">تسديد</button>
            </div>
        `;

        liabilitiesListContainer.appendChild(li);
    });
}
       // =================================================================
// START: NEW BULK PAYMENT FUNCTIONS
// =================================================================

function renderDebtorPaymentList() {
    const container = d('payment-debtor-list-container');
    if (!container) return;

    const validDebts = debtors.filter(d => (Number(d.amount) || 0) > 0.001);
    if (validDebts.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-500">لا توجد ديون متاحة للتحصيل.</p>';
        return;
    }

    const sortedDebts = validDebts.sort((a, b) => a.name.localeCompare(b.name, 'ar'));
    container.innerHTML = sortedDebts.map(debt => `
        <label>
            <input type="checkbox" class="debt-payment-checkbox" data-debt-id="${debt.id}" data-amount="${debt.amount}">
            <span class="flex-grow">${debt.name} - ${debt.reason || 'دين عام'}</span>
            <strong class="font-mono">${formatCurrency(debt.amount)}</strong>
        </label>
    `).join('');
}

function renderLiabilityPaymentList() {
    const container = d('payment-creditor-list-container');
    if (!container) return;

    const validLiabilities = liabilities.filter(l => (Number(l.amount) || 0) > 0.001);
    if (validLiabilities.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-500">لا توجد التزامات متاحة للتسديد.</p>';
        return;
    }

    const sortedLiabilities = validLiabilities.sort((a, b) => a.name.localeCompare(b.name, 'ar'));
    container.innerHTML = sortedLiabilities.map(liability => `
        <label>
            <input type="checkbox" class="liability-payment-checkbox" data-liability-id="${liability.id}" data-amount="${liability.amount}">
            <span class="flex-grow">${liability.name}</span>
            <strong class="font-mono">${formatCurrency(liability.amount)}</strong>
        </label>
    `).join('');
}

function calculateSelectedTotal(containerSelector, checkboxSelector, summaryEl, totalEl) {
    const container = d(containerSelector);
    if (!container || !summaryEl || !totalEl) return;

    let total = 0;
    const checkedItems = container.querySelectorAll(`${checkboxSelector}:checked`);
    checkedItems.forEach(checkbox => {
        total += parseFloat(checkbox.dataset.amount) || 0;
    });

    if (total > 0) {
        totalEl.textContent = formatCurrency(total);
        summaryEl.classList.remove('hidden');
    } else {
        summaryEl.classList.add('hidden');
    }
}
function updatePendingSalesDisplay() {
    if (!pendingSalesListContainer || !pendingSalesSearchInput || !pendingSalesTotalCostSpan || !pendingSalesTotalProfitSpan) return;

    let totalPendingCost = 0;
    let totalPendingProfit = 0;

    pendingSales.forEach(sale => {
        let saleCost = 0;
        if (sale.totalCost !== undefined) {
             saleCost = Number(sale.totalCost);
        } else if (sale.mainProduct) {
             const mainCost = (Number(sale.mainProduct.costPrice) || 0) * (Number(sale.mainProduct.quantity) || 0);
             const addCost = (sale.additionalItems || []).reduce((sum, i) => sum + ((Number(i.costPrice) || 0) * (Number(i.quantity) || 0)), 0);
             saleCost = mainCost + addCost;
        }
        totalPendingCost += saleCost;
        totalPendingProfit += (Number(sale.potentialProfit) || 0);
    });

    if (pendingSalesTotalCostSpan) pendingSalesTotalCostSpan.textContent = `التكلفة: ${formatCurrency(totalPendingCost)}`;
    if (pendingSalesTotalProfitSpan) pendingSalesTotalProfitSpan.textContent = `الربح المتوقع: ${formatCurrency(totalPendingProfit)}`;

    const searchTerm = pendingSalesSearchInput.value.trim().toLowerCase();
    const filteredSales = pendingSales.filter(sale => {
        if (!searchTerm) return true;
        const customerMatch = (sale.customerName || "").toLowerCase().includes(searchTerm);
        let productMatch = false;
        if (sale.items) {
            productMatch = sale.items.some(item => item.name.toLowerCase().includes(searchTerm));
        } else if (sale.mainProduct) {
            productMatch = sale.mainProduct.name.toLowerCase().includes(searchTerm);
        }
        return customerMatch || productMatch;
    });

    if (filteredSales.length === 0) {
        pendingSalesListContainer.innerHTML = `<p class="text-center text-gray-500 text-sm">لا توجد مبيعات مؤقتة تطابق البحث.</p>`;
        return;
    }

    pendingSalesListContainer.innerHTML = filteredSales.map(sale => {
        // تجهيز النصوص للعرض
        let itemsText = "", attachmentsHTML = "";
        
        // 1. عرض الملحقات
        const attachments = sale.additionalItems || (sale.invoiceData ? sale.invoiceData.deductedItems : []);
        if (attachments && attachments.length > 0) {
            attachmentsHTML = `<div class="text-xs text-gray-500 mt-1 pl-4" style="margin-right: 10px;"><strong>+ ملحقات:</strong> ${attachments.map(item => `${item.quantity}x ${item.name}`).join(', ')}</div>`;
        }
        
        // 2. عرض المنتجات
        if (sale.items) {
            itemsText = sale.items.map(item => `${item.quantity}x "${item.name}"`).join(', ');
            if (itemsText.length > 50) itemsText = itemsText.substring(0, 50) + "...";
            itemsText = `<b>[فاتورة]</b> ${itemsText}`;
        } else if (sale.mainProduct) {
            itemsText = `${sale.mainProduct.quantity}x "${sale.mainProduct.name}"`;
        }
        
        let customerInfo = sale.customerName ? `<span class="block text-sm text-blue-600">العميل: ${sale.customerName}</span>` : '';

        // 3. حالة الدفع (عربون)
        const totalPaid = Number(sale.depositPaid) || 0;
        let paymentBadge = "";
        
        if (totalPaid > 0) {
            paymentBadge = `<span class="inline-block bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded font-bold mt-1 border border-yellow-200">
                💰 مدفوع عربون: ${formatCurrency(totalPaid)}
            </span>`;
        }

        // --- هيكل HTML المتوافق مع التصميم القديم ---
        return `
        <li style="border-bottom: 1px solid #eee; padding: 10px; list-style: none;">
            <div class="flex justify-between items-start gap-2 flex-wrap">
                <div>
                    <span class="block font-semibold text-blue-700 cursor-pointer hover:underline" onclick="window.showPendingSaleDetails('${sale.id}')" title="اضغط لعرض تفاصيل الربحية">
    ${itemsText} <i class="fas fa-info-circle text-xs ml-1"></i>
</span>
                    ${customerInfo}
                    ${attachmentsHTML}
                    <div class="mt-1 text-sm text-gray-600">
                        <span>السعر: <b>${formatCurrency(sale.totalSellPrice)}</b></span> | 
                        <span>الربح: <b>${formatCurrency(sale.potentialProfit)}</b></span>
                    </div>
                    ${paymentBadge}
                    <span class="block text-xs text-gray-400 mt-1">${formatDateTime(sale.timestamp)}</span>
                </div>
                
                <div class="actions flex-shrink-0 flex flex-col sm:flex-row gap-1 mt-2 sm:mt-0">
                    <!-- زر العربون الجديد بتنسيق متوافق -->
                    <button onclick="window.openDepositModal('${sale.id}')" class="bg-purple-500 hover:bg-purple-600 text-white rounded px-2 py-1 text-xs border border-purple-700" title="استلام دفعة">
                        استلام عربون
                    </button>
                    
                    <button data-pending-id="${sale.id}" class="edit-pending bg-blue-500 hover:bg-blue-600 text-white rounded px-2 py-1 text-xs border border-blue-700">تعديل</button>
                    <button data-pending-id="${sale.id}" class="confirm-pending bg-green-500 hover:bg-green-600 text-white rounded px-2 py-1 text-xs border border-green-700">تأكيد</button>
                    <button data-pending-id="${sale.id}" class="cancel-pending bg-red-500 hover:bg-red-600 text-white rounded px-2 py-1 text-xs border border-red-700">إلغاء</button>
                    <button data-pending-id="${sale.id}" class="initiate-return-from-pending bg-orange-500 hover:bg-orange-600 text-white rounded px-2 py-1 text-xs border border-orange-700">مرتجع</button>
                </div>
            </div>
        </li>`;
    }).join('');
}
      function calculateSinglePendingSaleCost(sale) {
    // إذا كان البيع المؤقت يحتوي على خاصية "totalCost" (موجودة في الفواتير المؤقتة)
    // قم بإرجاع قيمتها مباشرة لأنها محسوبة مسبقًا وبدقة
    if (sale.totalCost !== undefined) {
        return Number(sale.totalCost) || 0;
    }

    // إذا لم تكن موجودة، فهذا يعني أنه بيع مؤقت بالطريقة القديمة، فاحسبها
    if (sale.mainProduct) {
        const mainCost = (Number(sale.mainProduct.costPrice) || 0) * (Number(sale.mainProduct.quantity) || 0);
        const additionalCost = (sale.additionalItems || []).reduce((addSum, item) => addSum + ((Number(item.costPrice) || 0) * (Number(item.quantity) || 0)), 0);
        return mainCost + additionalCost;
    }

    // في حالة وجود هيكل غير متوقع، أرجع صفرًا لمنع الخطأ
    return 0;
}
 function updateOffsetDatalists() { if (!debtorNamesDatalistOffset || !creditorNamesDatalistOffset) return; // Populate Debtor Datalist
             const debtorNames = [...new Set(debtors.filter(d => (Number(d.amount) || 0) > 0.001).map(d => d.name))].sort((a, b) => a.localeCompare(b, 'ar'));
             debtorNamesDatalistOffset.innerHTML = debtorNames.map(name => `<option value="${name}"></option>`).join('');

             // Populate Creditor Datalist
             const creditorNames = [...new Set(liabilities.filter(l => (Number(l.amount) || 0) > 0.001).map(l => l.name))].sort((a, b) => a.localeCompare(b, 'ar'));
             creditorNamesDatalistOffset.innerHTML = creditorNames.map(name => `<option value="${name}"></option>`).join('');
          }

       
// =======================================================
function updateUI() {
    console.log("updateUI called. Current loaded date:", currentLoadedDate);
   const { 
        totalInventoryValue, 
        totalCapital, 
        totalDebtsValue, 
        totalLiabilitiesValue, 
        calculatedPendingReturnsValue, 
        calculatedPendingPurchasesValue 
    } = calculateTotals();
    const totalPurchases = calculateTotalPurchasesToday();
    renderAccounts(); // <-- السطر الأول الجديد
    const totalLiquidity = accounts.reduce((sum, acc) => sum + acc.balance, 0); // <-- السطر الثاني الجديد
    
    // ✅ 1. حساب الربح المتوقع من المبيعات المعلقة فقط
    const totalPotentialProfit = pendingSales.reduce((sum, sale) => {
        return sum + (Number(sale.potentialProfit) || 0);
    }, 0);

    // ✅ 2. المعادلة النهائية والصحيحة لرأس المال المتوقع
    const expectedCapital = totalCapital + totalPotentialProfit;

    // -- تحديث عناصر الواجهة (باقي الكود لم يتغير) --
    if (d('summary-current-liquidity')) d('summary-current-liquidity').textContent = formatCurrency(totalLiquidity);
    if (d('summary-total-inventory-value')) d('summary-total-inventory-value').textContent = formatCurrency(totalInventoryValue);
    if (d('summary-consignment-value-display')) d('summary-consignment-value-display').textContent = formatCurrency(goodsOnConsignmentValue);
    if (d('summary-total-debts-display')) d('summary-total-debts-display').textContent = formatCurrency(totalDebtsValue);
    if (d('summary-total-liabilities-display')) d('summary-total-liabilities-display').textContent = formatCurrency(totalLiabilitiesValue);
    if (d('summary-total-expenses')) d('summary-total-expenses').textContent = formatCurrency(expenses);
    if (d('summary-total-profit')) d('summary-total-profit').textContent = formatCurrency(totalProfit);
    if (d('summary-total-capital')) d('summary-total-capital').textContent = formatCurrency(totalCapital);
    if (d('summary-expected-capital')) d('summary-expected-capital').textContent = formatCurrency(expectedCapital);
    if (d('summary-total-purchases')) d('summary-total-purchases').textContent = formatCurrency(totalPurchases);

    if (inventoryTotalInventoryValue) inventoryTotalInventoryValue.textContent = `إجمالي قيمة المخزون: ${formatCurrency(totalInventoryValue)}`;
    if (inventoryConsignmentValue) inventoryConsignmentValue.textContent = `قيمة مؤقتة: ${formatCurrency(goodsOnConsignmentValue)}`;
    if (inventoryTotalProfit) inventoryTotalProfit.textContent = `إجمالي الربح: ${formatCurrency(totalProfit)}`;
    
    updateProductListDisplay();
    updateSuppliersListDisplay();
    updateSupplierDropdown('product-supplier');
    updateSupplierDropdown('pi_supplier');
    updateLogDisplay();
    updateAdditionalCostsCheckboxes();
    updatePendingSalesDisplay();
    updateDebtorsListDisplay();
    updateLiquidityLogDisplay();
    updateLiabilitiesListDisplay();
    renderDebtorPaymentList();
renderLiabilityPaymentList();
    updateOffsetDatalists();
    pi_updateRecentPurchasesDisplay();
    pi_updatePendingPurchasesDisplay();
    updateReturnsUI();
    populateReturnProductSelect();
    updateMonthlyLiabilitiesDisplay();
    
    if (totalDebtsDisplay) totalDebtsDisplay.textContent = `إجمالي الديون: ${formatCurrency(totalDebtsValue)}`;
    if (currentLiquidityDisplay) currentLiquidityDisplay.textContent = formatCurrency(liquidity);
    if (totalExpensesDisplay) totalExpensesDisplay.textContent = formatCurrency(expenses);
    if (totalLiabilitiesDisplay) totalLiabilitiesDisplay.textContent = `إجمالي الالتزامات: ${formatCurrency(totalLiabilitiesValue)}`;
    if (currentDataDateDisplay) { currentDataDateDisplay.textContent = currentLoadedDate ? formatDateForDisplay(currentLoadedDate) : "بيانات جديدة (لم تحفظ بعد)"; }
    if (inv_modal && inv_modal.style.display === 'block') { inv_updateDeductibleCostsCheckboxes(); }
    if (d('financial-center-section') && !d('financial-center-section').classList.contains('hidden')) { 
        const activeTab = d('fc-main-tabs').querySelector('.fc-tab-button.active'); 
        if (activeTab) { 
            const targetId = activeTab.dataset.target; 
            if (targetId === 'fc-tab-distribution') { 
                fc_populate_month_select(); 
            } else if (targetId === 'fc-tab-debt-treatment') { 
                fc_populate_debt_treatment(); 
            } 
        } 
    }
    // 🆕 تحديث بطاقة المرتجعات المعلقة
    if (document.getElementById('summary-pending-returns')) {
        document.getElementById('summary-pending-returns').textContent = formatCurrency(calculatedPendingReturnsValue);
    }

    // 🆕 تحديث بطاقة المشتريات المعلقة
    if (document.getElementById('summary-pending-purchases')) {
        document.getElementById('summary-pending-purchases').textContent = formatCurrency(calculatedPendingPurchasesValue);
    }
}
function initiateReturnFromPendingSale(pendingId) {
    const saleIndex = pendingSales.findIndex(s => s.id === pendingId);
    if (saleIndex === -1) {
        showGlobalMessage("خطأ: لم يتم العثور على البيع المؤقت.", true);
        return;
    }

    if (!confirm(`هل أنت متأكد من تحويل هذا البيع المؤقت إلى عملية مرتجع؟\nسيتم حذف البيع المؤقت فوراً وتحضير بياناته في قسم المرتجعات.`)) {
        return;
    }
    
    saveStateToHistory();

    // حذف البيع المؤقت الآن ونسخ بياناته
    returnSourceData = pendingSales.splice(saleIndex, 1)[0]; 

    logOperation("تحويل لمُرتجع", `حذف بيع مؤقت وبدء إرجاع للعميل ${returnSourceData.customerName || '-'}.`);
    
    // الانتقال إلى قسم المرتجعات
    const returnsSection = d('returns-section');
    const navButton = document.querySelector('button[data-target="returns-section"]');
    if (returnsSection && navButton) {
        document.querySelectorAll('.content-section').forEach(s => s.classList.add('hidden'));
        document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
        returnsSection.classList.remove('hidden');
        navButton.classList.add('active');
        returnsSection.scrollIntoView({ behavior: 'smooth' });
    }

    // ملء نموذج المرتجعات
    const mainItem = returnSourceData.items ? returnSourceData.items[0] : returnSourceData.mainProduct;
    if (mainItem) {
        d('return-manual-product-name').value = mainItem.name;
        d('return-product-select').value = ""; // تصفير الاختيار ليعتمد على الاسم اليدوي
        d('return-quantity').value = mainItem.quantity;
    }
    d('return-customer-name').value = returnSourceData.customerName || '';
    
    d('return-sale-price-input').value = returnSourceData.totalSellPrice || 0; 
    
    // تفعيل خيار الإرجاع بسعر البيع
    const atSalePriceCheckbox = d('return-at-sale-price');
    if (atSalePriceCheckbox) {
        atSalePriceCheckbox.checked = true;
        // مهم: تفعيل حدث التغيير في حال كان هناك كود يعتمد عليه لإظهار/إخفاء حقول
        atSalePriceCheckbox.dispatchEvent(new Event('change'));
    }

    d('return-receive-now').checked = false; // افتراضياً قيد الاستلام
    
    updateUI();
    showGlobalMessage("تم حذف البيع المؤقت. بيانات المرتجع جاهزة للتأكيد.", false, true);
}

function populateReturnProductSelect() {
    const returnProductSelect = d('return-product-select');
    if (!returnProductSelect) return;
    
    const currentSelection = returnProductSelect.value;
    returnProductSelect.innerHTML = '<option value="">-- اختر من القائمة --</option>';

    const productsInStock = products.filter(p => (p.quantity || 0) > 0);
    const sortedProducts = productsInStock.sort((a, b) => a.name.localeCompare(b.name, 'ar'));

    sortedProducts.forEach(p => {
        const option = document.createElement('option');
        option.value = p.name;
        option.textContent = `${p.name} (المتاح: ${p.quantity})`;
        option.dataset.cost = p.costPrice;
        returnProductSelect.appendChild(option);
    });

    if (sortedProducts.some(p => p.name === currentSelection)) {
        returnProductSelect.value = currentSelection;
    }
}

function updateReturnsUI() {
    updateCompletedReturnsDisplay();
    updatePendingReturnsDisplay();
}

function updateCompletedReturnsDisplay() {
    const completedReturnsList = d('completed-returns-list');
    if (!completedReturnsList) return;
    if (completedReturns.length === 0) {
        completedReturnsList.innerHTML = '<p class="text-center text-gray-500">لم تتم أي عمليات إرجاع اليوم.</p>';
        return;
    }
    const sortedReturns = [...completedReturns].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    completedReturnsList.innerHTML = sortedReturns.map(ret => `
        <div class="p-2 border-b">
            <div><strong>${(ret.items || []).map(item => `${item.quantity}x ${item.name}`).join(', ')}</strong> <span class="text-sm text-gray-500">(${ret.customerName})</span></div>
            <div class="font-mono text-red-600">-${formatCurrency(ret.returnedAmount)}</div>
            <div class="text-xs text-gray-400">${formatDateTime(ret.timestamp)}</div>
        </div>
    `).join('');
}

function updatePendingReturnsDisplay() {
    const pendingReceiptList = d('pending-receipt-list');
    if (!pendingReceiptList) return;
    if (pendingReturns.length === 0) {
        pendingReceiptList.innerHTML = '<p class="text-center text-gray-500">لا توجد مرتجعات معلقة حاليًا.</p>';
        return;
    }
    const sortedReturns = [...pendingReturns].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    pendingReceiptList.innerHTML = sortedReturns.map(ret => `
        <div class="p-3 border rounded-md bg-yellow-50 shadow-sm mb-2">
            <div class="flex justify-between items-center">
                <div>
                    <strong>${(ret.items || []).map(item => `${item.quantity}x ${item.name}`).join(', ')}</strong> 
                    <span class="text-sm text-gray-500">(${ret.customerName})</span>
                    <div class="text-xs text-gray-400">${formatDateTime(ret.timestamp)}</div>
                </div>
                <button data-pending-return-id="${ret.id}" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-1 px-3 rounded text-xs confirm-receipt-btn">تأكيد الاستلام</button>
            </div>
        </div>
    `).join('');
}

// ✅✅✅ الكود الجديد والصحيح لدالة handleConfirmReceipt ✅✅✅
function handleConfirmReceipt(pendingId) {
    saveStateToHistory();
    const returnIndex = pendingReturns.findIndex(r => r.id === pendingId);
    if (returnIndex === -1) {
        showGlobalMessage("خطأ: لم يتم العثور على المرتجع المعلق.", true);
        return;
    }

    const ret = pendingReturns.splice(returnIndex, 1)[0];

    // --- ✅ بداية الإصلاح: هذه الدالة الآن لوجيستية فقط ---

    // 1. تحديث المخزون باستخدام التكلفة الصحيحة المحفوظة
    ret.items.forEach(item => {
        // item.costPrice هنا يحتوي على القيمة الصحيحة التي تم حسابها في الخطوة السابقة
        if (ret.returnAtSalePrice) {
            const newProductName = `${item.name} - ${ret.customerName} (مرتجع)`;
            products.push({ name: newProductName, quantity: item.quantity, costPrice: item.costPrice });
        } else {
            const pIndex = products.findIndex(p => p.name === item.name);
            if (pIndex !== -1) {
                // منطق حساب المتوسط الصحيح
                const existing = products[pIndex];
                const oldTotalValue = (existing.costPrice || 0) * (existing.quantity || 0);
                const newTotalValue = item.costPrice * item.quantity;
                existing.quantity += item.quantity;
                existing.costPrice = (oldTotalValue + newTotalValue) / existing.quantity;
            } else {
                // إضافة المنتج بتكلفته الصحيحة لأول مرة
                products.push({ name: item.name, quantity: item.quantity, costPrice: item.costPrice || 0 });
            }
        }
    });

    // 2. نقل المرتجع إلى قائمة المكتملة
    completedReturns.push({ ...ret, status: 'Completed', timestamp: new Date().toISOString() });

    // 3. تسجيل العملية كإجراء لوجيستي
    logOperation("تأكيد استلام مرتجع", `تم تأكيد استلام ${ret.items.map(i=> i.quantity + 'x ' + i.name).join(', ')} في المخزن.`);
    
    // --- ✅ نهاية الإصلاح: تم حذف كل العمليات المالية من هنا ---

    updateUI();
    showGlobalMessage("تم تأكيد استلام البضاعة وتحديث المخزون بنجاح.", false);
}


// أضف هذه الدالة الجديدة بالكامل
// الكود الجديد (الصحيح)
function updateReturnFormVisibility() {
    const returnType = document.querySelector('input[name="return-financial-type"]:checked')?.value;
    const amountGroup = d('return-sale-price-group');
    const accountGroup = d('return-account-selector-container');

    if (!amountGroup || !accountGroup) return;

    // ✅ التعديل الجديد: إظهار حقل القيمة مع خيار "المخزون فقط"
    if (returnType === 'stock') {
        amountGroup.classList.remove('hidden'); // <-- أصبحت ظاهرة
        accountGroup.classList.add('hidden');
    } else if (returnType === 'credit') {
        amountGroup.classList.remove('hidden');
        accountGroup.classList.add('hidden');
    } else { // 'cash'
        amountGroup.classList.remove('hidden');
        accountGroup.classList.remove('hidden');
    }
}
function handleManualReturn() {
    saveStateToHistory();
    const returnMessage = d('return-message');
    
    // قراءة البيانات من المدخلات
    const productName = d('return-product-select').value || d('return-manual-product-name').value.trim();
    const quantity = parseInputNumber(d('return-quantity'));
    const customerName = d('return-customer-name').value.trim() || 'عميل';
    const returnedAmount = parseInputNumber(d('return-sale-price-input'));
    const financialType = document.querySelector('input[name="return-financial-type"]:checked').value;
    const receiveNow = d('return-receive-now').checked;
    const returnAtSalePrice = d('return-at-sale-price').checked;
    const selectedAccountId = d('return-from-account-select').value;
    const account = accounts.find(acc => acc.id === selectedAccountId);

    // التحقق من صحة المدخلات
    if (!productName || isNaN(quantity) || quantity <= 0) {
        showMessage(returnMessage, "يرجى إدخال اسم المنتج وكمية صحيحة.", true); return;
    }
    if (financialType !== 'stock' && (isNaN(returnedAmount) || returnedAmount < 0)) {
        showMessage(returnMessage, "يرجى إدخال مبلغ صحيح للمرتجع.", true); return;
    }
    if (financialType === 'cash' && !account) {
        showMessage(returnMessage, "للإرجاع النقدي، يجب اختيار الحساب الذي سيتم الخصم منه.", true); return;
    }
    
    // =================================================================
    // 🔥🔥 التعديل الجوهري هنا: حساب تكلفة البضاعة بناءً على خيارك 🔥🔥
    // =================================================================
    const productData = products.find(p => p.name === productName);
    let costOfGoods = 0;

    if (returnAtSalePrice) {
        // الحالة 1: إذا اخترت الإرجاع بسعر البيع
        // نعتبر أن التكلفة هي نفس المبلغ الذي أرجعته للعميل (إعادة شراء)
        costOfGoods = returnedAmount;
    } else if (productData) {
        // الحالة 2: إرجاع عادي والمنتج موجود -> نستخدم متوسط التكلفة القديم
        costOfGoods = (productData.costPrice || 0) * quantity;
    } else {
        // الحالة 3: إرجاع عادي لمنتج غير موجود -> نستخدم مبلغ الإرجاع كتكلفة
        costOfGoods = returnedAmount;
    }

    let logDetails = "";

    // --- 2. الإجراء المالي (السيولة أو الديون) ---
    if (financialType === 'cash') {
        if (returnedAmount > account.balance) { 
            showMessage(returnMessage, `رصيد حساب "${account.name}" غير كافٍ.`, true); 
            return; 
        }
        account.balance -= returnedAmount;
        logDetails = `إرجاع نقدي ${formatCurrency(returnedAmount)} للعميل "${customerName}" من حساب "${account.name}".`;
    } else if (financialType === 'credit') {
        liabilities.push({ id: generateId('liab'), name: `رصيد مرتجع للعميل: ${customerName}`, amount: returnedAmount });
        logDetails = `تسجيل رصيد للعميل "${customerName}" بقيمة ${formatCurrency(returnedAmount)}.`;
    }

    // --- 3. تعديل الأرباح ---
    // إذا كان الإرجاع بسعر البيع (returnAtSalePrice = true)، فإن costOfGoods = returnedAmount
    // وبالتالي profitToReverse سيكون صفر، وهذا صحيح (لا نخصم ربحاً لأننا اشترينا البضاعة بسعرها)
    if ((financialType === 'cash' || financialType === 'credit')) {
        const profitToReverse = returnedAmount - costOfGoods;
        
        // نخصم الفرق من الأرباح فقط إذا كان هناك فرق
        if (Math.abs(profitToReverse) > 0.001) {
            totalProfit -= profitToReverse;
            logOperation("عكس أرباح مرتجع", `عكس أرباح بقيمة ${formatCurrency(profitToReverse)}.`);
        }
    }

    // --- 4. إجراء المخزون ---
    // حساب تكلفة الوحدة الواحدة لإضافتها للمخزون
    const newUnitCost = (quantity > 0) ? (costOfGoods / quantity) : 0;

    if (receiveNow) {
        if (returnAtSalePrice) {
            // خيار: إضافة كمنتج منفصل لتمييزه (أو يمكنك دمجه وحساب متوسط جديد)
            // هنا سنضيفه كمنتج منفصل ليكون واضحاً أنه مرتجع بسعر مختلف
            products.push({ 
                name: `${productName} - ${customerName} (مرتجع)`, 
                quantity: quantity, 
                costPrice: newUnitCost // هنا سيأخذ سعر البيع كتكلفة
            });
        } else {
            // المنطق العادي: دمج وحساب المتوسط
            if (productData) {
                const oldTotalValue = (productData.costPrice || 0) * (productData.quantity || 0);
                const newTotalValue = costOfGoods; // محسوبة بالأعلى
                productData.quantity += quantity;
                // تحديث المتوسط
                productData.costPrice = (oldTotalValue + newTotalValue) / productData.quantity;
            } else {
                products.push({ name: productName, quantity, costPrice: newUnitCost });
            }
        }
        
        completedReturns.push({ id: generateId('ret'), items: [{ name: productName, quantity }], customerName, returnedAmount, timestamp: new Date().toISOString() });
        logOperation("مرتجع فوري", logDetails + " وتم استلام البضاعة.");
        showMessage(returnMessage, "تم تسجيل المرتجع واستلامه بالمخزن بنجاح.", false);
        
    } else {
        // --- مرتجع قيد الاستلام ---
        if (typeof pendingReturnsValue !== 'undefined') {
             pendingReturnsValue += returnedAmount;
        }
        
        pendingReturns.push({
            id: generateId('pend-ret'),
            // 🔥 هنا الإصلاح للمرتجع المعلق: نمرر التكلفة المحسوبة (الجديدة) وليس القديمة 🔥
            items: [{ name: productName, quantity, costPrice: newUnitCost }],
            customerName, returnedAmount,
            returnAtSalePrice: returnAtSalePrice,
        });
        logOperation("مرتجع قيد الاستلام", logDetails + " والبضاعة قيد الاستلام.");
        showMessage(returnMessage, "تم تسجيل المرتجع كـ 'قيد الاستلام' بنجاح. تم تنفيذ الإجراء المالي.", false, true);
    }
    
    resetReturnForm();
    updateUI();
}

// دالة مساعدة لتنظيف نموذج المرتجعات
function resetReturnForm() {
    if(d('return-product-select')) d('return-product-select').value = '';
    if(d('return-manual-product-name')) d('return-manual-product-name').value = '';
    if(d('return-quantity')) d('return-quantity').value = '1';
    if(d('return-customer-name')) d('return-customer-name').value = '';
    if(d('return-sale-price-input')) d('return-sale-price-input').value = 0;
    if(d('return-at-sale-price')) d('return-at-sale-price').checked = false;
    returnSourceData = null; 
}

// =======================================================
// START: Returns Section Event Listeners
// =======================================================

// دالة مساعدة لتنظيف نموذج المرتجعات
function resetReturnForm() {
    if(d('return-product-select')) d('return-product-select').value = '';
    if(d('return-manual-product-name')) d('return-manual-product-name').value = '';
    if(d('return-quantity')) d('return-quantity').value = '1';
    if(d('return-customer-name')) d('return-customer-name').value = '';
    if(d('return-sale-price-input')) d('return-sale-price-input').value = 0;
    if(d('return-at-sale-price')) d('return-at-sale-price').checked = false;
    returnSourceData = null; 
}

// دالة مساعدة لتنظيف نموذج المرتجعات
function resetReturnForm() {
    d('return-product-select').value = '';
    d('return-manual-product-name').value = '';
    d('return-quantity').value = '1';
    d('return-customer-name').value = '';
    d('return-sale-price-input').value = 0;
    d('return-at-sale-price').checked = false;
    returnSourceData = null; 
}

// دالة مساعدة لتنظيف نموذج المرتجعات
function resetReturnForm() {
    d('return-product-select').value = '';
    d('return-manual-product-name').value = '';
    d('return-quantity').value = '1';
    d('return-customer-name').value = '';
    d('return-sale-price-input').value = 0;
    d('return-at-sale-price').checked = false;
    returnSourceData = null; 
}
async function saveCurrentStateByDate(dateString) {
    // 1. التحقق من تسجيل الدخول
    if (!window.currentUser) {
        showGlobalMessage("تنبيه: أنت غير مسجل دخول. يتم الحفظ على الجهاز فقط.", false, true);
        return;
    }
    
    const userId = window.currentUser.uid;
    // console.log(`Starting save process for: ${dateString}...`); 

    const safePendingReturnsValue = (typeof pendingReturnsValue !== 'undefined') ? pendingReturnsValue : 0;
    const safeBackupIndex = (typeof backupSlotIndex !== 'undefined') ? backupSlotIndex : 0;

    // تجهيز كائن البيانات الكامل
    const stateToSave = {
        month: dateString.substring(0, 7),
        products: products || [],
        suppliers: suppliers || [],
        accounts: accounts || [],
        expenses: expenses || 0,
        debtors: debtors || [],
        liabilities: liabilities || [],
        monthlyLiabilities: monthlyLiabilities || [],
        profit: totalProfit || 0,
        log: operationLog || [],
        pendingSales: pendingSales || [],
        liquidityLog: liquidityLog || [],
        salesToday: salesToday || [],
        serialNumbersLog: serialNumbersLog || [],
        inboxTasks: inboxTasks || [],
        purchaseInvoices: purchaseInvoices || [],
        pendingPurchases: pendingPurchases || [],
        completedReturns: completedReturns || [],
        pendingReturns: pendingReturns || [],
        pendingReturnsValue: safePendingReturnsValue,
        savedAt: new Date().toISOString(),
        savedForDate: dateString
    };

    const sanitizedState = sanitizeDataForFirebase(stateToSave);

    // 1. حفظ نسخة محلية للطوارئ (بصمت تام)
    try {
        const fullLocalBackup = { ...stateToSave }; 
        const backupKey = `goodsMgmt_backup_${dateString}_slot_${safeBackupIndex}`;
        saveData(backupKey, fullLocalBackup);
        
        if (typeof backupSlotIndex !== 'undefined') {
            backupSlotIndex = (backupSlotIndex + 1) % MAX_BACKUP_SLOTS;
        }
        // console.log("تم تحديث نسخة الطوارئ المحلية."); 
    } catch (e) {
        console.warn("Local backup warning (silent):", e);
    }

    // 2. الحفظ السحابي (محاولة هادئة)
    try {
        const docRef = window.doc(window.db, "users", userId, "days", dateString);
        
        // محاولة الحفظ
        await window.setDoc(docRef, sanitizedState);

        // تحديث الملخص (في الخلفية، لا ننتظره ولا نزعج المستخدم إذا فشل)
        const latestBalancesSummary = {
            products: products || [],
            suppliers: suppliers || [],
            accounts: accounts || [],
            debtors: debtors || [],
            liabilities: liabilities || [],
            monthlyLiabilities: monthlyLiabilities || [],
            pendingSales: pendingSales || [],
            serialNumbersLog: serialNumbersLog || [],
            inboxTasks: inboxTasks || [],
            pendingPurchases: pendingPurchases || [],
            pendingReturns: pendingReturns || [],
            pendingReturnsValue: safePendingReturnsValue,
            summaryForDate: dateString,
            lastUpdated: new Date().toISOString()
        };
        const sanitizedSummary = sanitizeDataForFirebase(latestBalancesSummary);
        const summaryDocRef = window.doc(window.db, "users", userId, "summaries", "latestBalances");
        
        window.setDoc(summaryDocRef, sanitizedSummary).catch(e => console.log("Summary update delayed (silent)"));

        console.log("Cloud save success.");
        currentLoadedDate = dateString;
        
        // إظهار رسالة نجاح صغيرة وسريعة
        const msgBox = document.getElementById('global-message');
        if (msgBox) {
            msgBox.textContent = "تم الحفظ ✓";
            msgBox.className = "section-message success visible";
            setTimeout(() => { msgBox.classList.remove('visible'); }, 2000);
        }

    } catch (error) {
        console.error("Cloud save warning:", error);
        
        currentLoadedDate = dateString;

        // رسالة ذكية حسب نوع الخطأ
        let userMessage = "تم الحفظ على الجهاز (جاري المزامنة...)";
        let isError = false; 
        let isInfo = true;

        if (error.code === 'unavailable' || error.message.includes('offline')) {
            userMessage = "لا يوجد إنترنت. تم الحفظ محلياً وسيتم الرفع تلقائياً.";
        } else if (error.code === 'permission-denied') {
            userMessage = "خطأ في الصلاحيات. يرجى إعادة تسجيل الدخول.";
            isError = true;
            isInfo = false;
        }

        showGlobalMessage(userMessage, isError, isInfo);
    }
}// 1. دالة عرض القائمة (نسخة المسح الشامل المتوافقة مع كروم)
function openBackupHistoryModal() {
    const modal = document.getElementById('backupHistoryModal');
    const listContainer = document.getElementById('backup-history-list');
    
    if (!modal || !listContainer) return;

    // تحديد التاريخ المستهدف (أو استخدام تاريخ اليوم كاحتياطي)
    let targetDate = currentLoadedDate;
    if (!targetDate) {
        const now = new Date();
        // تنسيق التاريخ يدوياً لضمان التوافق (YYYY-MM-DD)
        const offset = now.getTimezoneOffset() * 60000;
        targetDate = new Date(now.getTime() - offset).toISOString().split('T')[0];
    }

    console.log(`Chrome-Safe Backup Search for: ${targetDate}`);
    
    let backups = [];

    // 🔥 التغيير الجذري: مسح شامل لكل مفاتيح الذاكرة بدلاً من التخمين
    // هذا يتجاوز مشاكل ترتيب المفاتيح في كروم
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        
        // هل المفتاح يخص برنامجنا ويخص التاريخ المطلوب؟
        if (key && key.includes("goodsMgmt_backup_") && key.includes(targetDate)) {
            try {
                const raw = localStorage.getItem(key);
                const data = JSON.parse(raw);
                
                if (data && data.savedAt) {
                    // حساب حجم البيانات
                    const infoCount = (data.products?.length || 0) + (data.log?.length || 0);
                    
                    backups.push({
                        key: key,
                        time: new Date(data.savedAt),
                        info: infoCount
                    });
                }
            } catch (e) {
                console.warn("ملف تالف تم تجاهله:", key);
            }
        }
    }

    // ترتيب النسخ: الأحدث أولاً
    backups.sort((a, b) => b.time - a.time);

    // عرض القائمة
    if (backups.length === 0) {
        listContainer.innerHTML = `
            <div class="text-center py-4">
                <p class="text-gray-500 mb-2">لا توجد نسخ لهذا اليوم (${targetDate}).</p>
                <small class="text-gray-400">تأكد أنك قمت بعملية حفظ واحدة على الأقل.</small>
            </div>`;
    } else {
        listContainer.innerHTML = backups.map(backup => `
            <div class="flex justify-between items-center p-3 mb-2 bg-white border border-gray-300 rounded shadow-sm hover:bg-gray-50 transition">
                <div>
                    <div class="font-bold text-gray-800" style="font-size: 1rem;">
                        ⏰ ${backup.time.toLocaleTimeString('ar-EG')}
                    </div>
                    <div class="text-xs text-gray-600 mt-1">
                        محتوى النسخة: <b>${backup.info}</b> عنصر
                    </div>
                </div>
                <button type="button" data-backup-key="${backup.key}" class="restore-backup-btn-action" style="
                    background-color: #16a34a; 
                    color: white; 
                    font-weight: bold; 
                    padding: 6px 12px; 
                    border-radius: 6px; 
                    border: none; 
                    cursor: pointer;
                    font-size: 0.85rem;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                ">
                    استعادة فورية
                </button>
            </div>
        `).join('');
    }
    
    modal.style.display = 'block';
}

// 2. تفعيل الأزرار بتقنية (Event Delegation) لتعمل على كروم
// ضع هذا الجزء مرة واحدة في نهاية الملف أو داخل initializeApp
document.addEventListener('click', async function(e) {
    // أ: التعامل مع زر "استعادة فورية"
    if (e.target.classList.contains('restore-backup-btn-action')) {
        const btn = e.target;
        const key = btn.dataset.backupKey;
        
        if (confirm("هل أنت متأكد من استعادة هذه النسخة؟\nسيتم استبدال البيانات الحالية.")) {
            try {
                const raw = localStorage.getItem(key);
                if (raw) {
                    const data = JSON.parse(raw);
                    // استخدام التاريخ المحفوظ أو الحالي
                    const dateStr = data.savedForDate || (new Date().toISOString().split('T')[0]);
                    
                    console.log("Restoring on Chrome logic:", key);
                    
                    // تحميل البيانات
                    loadState(data, dateStr);
                    updateUI();
                    
                    // إغلاق النافذة
                    document.getElementById('backupHistoryModal').style.display = 'none';
                    
                    // حفظ لتثبيت الحالة
                    await saveCurrentStateByDate(dateStr);
                    
                    alert("تمت الاستعادة بنجاح!");
                }
            } catch (err) {
                alert("حدث خطأ: " + err.message);
            }
        }
    }

    // ب: التعامل مع فتح النافذة
    if (e.target.id === 'open-backup-history-button') {
        openBackupHistoryModal();
    }

    // ج: التعامل مع إغلاق النافذة
    if (e.target.classList.contains('modal') || 
        e.target.closest('.modal-close-btn') || 
        e.target.closest('.modal-close-btn-footer')) {
        const modal = document.getElementById('backupHistoryModal');
        if (modal && modal.style.display === 'block') {
            modal.style.display = 'none';
        }
    }
});

// دالة لإغلاق نافذة سجل النسخ الاحتياطية
function closeBackupHistoryModal() {
    const modal = d('backupHistoryModal');
    if (modal) modal.style.display = 'none';
}
// دالة لتشغيل أو إيقاف الحفظ التلقائي
function toggleAutoSave() {
    const autoSaveToggle = d('auto-save-toggle');
    isAutoSaveEnabled = autoSaveToggle.checked;

    if (isAutoSaveEnabled) {
        // إذا تم تفعيل الميزة
        if (autoSaveTimer) clearInterval(autoSaveTimer); // أوقف أي مؤقت قديم احتياطياً

        // ابدأ مؤقت جديد يعمل كل 90 ثانية (90000 ميلي ثانية)
        autoSaveTimer = setInterval(() => {
            console.log("Auto-saving data...");
            const targetDate = currentLoadedDate || getTodayDateString();
            saveCurrentStateByDate(targetDate);
            // نعرض رسالة مؤقتة لتأكيد الحفظ
            const tempMsg = d("global-message");
            if(tempMsg) {
                showMessage(tempMsg, `تم الحفظ تلقائياً... ${new Date().toLocaleTimeString()}`, false, true);
            }
        }, 20000); // يمكنك تغيير هذا الرقم (بالمللي ثانية)

        showGlobalMessage("تم تفعيل الحفظ التلقائي.", false);
        saveData(lsAutoSaveKey, true); // حفظ تفضيل المستخدم

    } else {
        // إذا تم إيقاف الميزة
        if (autoSaveTimer) {
            clearInterval(autoSaveTimer); // أوقف المؤقت
            autoSaveTimer = null;
            showGlobalMessage("تم إيقاف الحفظ التلقائي.", false, true);
        }
        saveData(lsAutoSaveKey, false); // حفظ تفضيل المستخدم
    }
}
async function loadDataForDate(dateString) {
    console.log(`--- بدء عملية التحميل والترحيل الذكي لتاريخ: ${dateString} ---`);
    const loadMsg = document.getElementById("load-message-alt");
    
    if (!window.currentUser || !dateString) return false;
    const userId = window.currentUser.uid;

    try {
        // 1. محاولة جلب بيانات اليوم المختار من السحابة
        const docRef = window.doc(window.db, "users", userId, "days", dateString);
        const docSnap = await window.getDoc(docRef);

        if (docSnap.exists()) {
            // الحالة أ: اليوم موجود بالفعل (تحميل يوم مسجل سابقاً)
            console.log("تم تحميل بيانات مسجلة لهذا اليوم.");
            loadState(docSnap.data(), dateString);
            if(loadMsg) showMessage(loadMsg, `تم تحميل بيانات يوم ${dateString} بنجاح.`, false);
            updateUI();
            return true;
        } else {
            // الحالة ب: يوم جديد (بدء ترحيل الأرصدة من آخر وضع للبرنامج)
            console.log("يوم جديد.. جاري ترحيل الأصول والأرصدة...");
            
            let dataToMigrate = null;
            let sourceName = "";

            // البحث عن مصدر للبيانات (الأولوية لملخص الأرصدة السريع)
            const summaryDocRef = window.doc(window.db, "users", userId, "summaries", "latestBalances");
            const summarySnap = await window.getDoc(summaryDocRef);
            
            if (summarySnap.exists()) {
                dataToMigrate = summarySnap.data();
                sourceName = "آخر أرصدة مسجلة بالسحابة";
            } else {
                // محاولة جلب بيانات أمس إذا لم يوجد ملخص
                const yesterday = new Date(dateString);
                yesterday.setDate(yesterday.getDate() - 1);
                const prevDateStr = yesterday.toISOString().split('T')[0];
                const prevDocRef = window.doc(window.db, "users", userId, "days", prevDateStr);
                const prevSnap = await window.getDoc(prevDocRef);
                if (prevSnap.exists()) {
                    dataToMigrate = prevSnap.data();
                    sourceName = `يوم ${prevDateStr}`;
                }
            }

            if (dataToMigrate) {
                // 🛑🛑🛑 منطقة التطهير والتدقيق المالي 🛑🛑🛑
                
                // 1. تصفير السجلات اليومية (لا تنتقل لليوم الجديد)
                dataToMigrate.salesToday = [];       
                dataToMigrate.purchaseInvoices = []; 
                dataToMigrate.completedReturns = []; 
                dataToMigrate.expenses = 0;          
                dataToMigrate.profit = 0;            

                // 2. ✅ التأمين المالي للمرتجعات (إصلاح مشكلة الـ 9341 جنيه)
                // نضمن وجود مصفوفة المرتجعات
                dataToMigrate.pendingReturns = dataToMigrate.pendingReturns || [];
                // 🔥 إعادة حساب القيمة من واقع العناصر الموجودة فعلياً لضمان عدم ضياعها 🔥
                dataToMigrate.pendingReturnsValue = dataToMigrate.pendingReturns.reduce((sum, r) => {
                    return sum + (Number(r.returnedAmount) || 0);
                }, 0);

                // 3. ✅ التأمين المالي للمشتريات (Goods in Transit)
                // المشتريات المعلقة هي "فلوس دفعناها ومستنيين البضاعة"، فهي أصل مالي
                dataToMigrate.pendingPurchases = dataToMigrate.pendingPurchases || [];
                // نتركها كما هي لتنتقل لليوم الجديد، وإذا أردت دقة أكبر يمكنك جمع قيمتها المدفوعة
                // لضمان دخولها في معادلة رأس المال.

                // 4. السجلات الافتتاحية
                dataToMigrate.log = [{
                    id: typeof generateUniqueId === 'function' ? generateUniqueId('LOG') : `log-${Date.now()}`,
                    timestamp: new Date().toISOString(),
                    type: "ترحيل تلقائي",
                    details: `بدء يوم جديد بترحيل الأصول من: ${sourceName}`
                }];

                const totalLiquidity = (dataToMigrate.accounts || []).reduce((s, a) => s + (a.balance || 0), 0);
                dataToMigrate.liquidityLog = [{
                    id: typeof generateUniqueId === 'function' ? generateUniqueId('LIQ') : `liq-${Date.now()}`,
                    timestamp: new Date().toISOString(),
                    type: "adjust", 
                    amount: 0,
                    description: `رصيد افتتاح مرحل من ${sourceName}`,
                    currentBalance: totalLiquidity
                }];

                console.log(`✅ تمت معالجة وترحيل قيمة المرتجعات: ${dataToMigrate.pendingReturnsValue}`);
                
                // تحميل البيانات المنقحة
                loadState(dataToMigrate, dateString);
                
                // حفظ فوري لليوم الجديد بالسحابة لتثبيته كـ "يوم مفتوح"
                await saveSystemToCloud();
                
                if(loadMsg) showMessage(loadMsg, `تم بدء يوم جديد وترحيل كافة الأرصدة بنجاح.`, false);
                updateUI();
                return true;

            } else {
                // حالة عدم وجود أي بيانات سابقة نهائياً (بداية النظام لأول مرة)
                console.log("بداية نظام فارغ.");
                resetState(); 
                accounts = [{ id: 'main', name: 'الخزينة الرئيسية', balance: 0.00 }];
                currentLoadedDate = dateString;
                await saveSystemToCloud();
                updateUI();
                if(loadMsg) showMessage(loadMsg, `بدء يوم جديد (نظام فارغ).`, false, true);
                return true;
            }
        }

    } catch (error) {
        console.error("خطأ في التحميل المالي:", error);
        if(loadMsg) showMessage(loadMsg, "حدث خطأ أثناء الاتصال بالسحابة.", true);
        return false;
    }
}
// =======================================================
       function exportData() {
    console.log("Starting full system backup...");
    
    // تحديد تاريخ البيانات المصدرة (إما التاريخ المحمل حالياً أو اليوم)
    const dateToExport = currentLoadedDate || getTodayDateString();

    // تجميع الحالة الكاملة للنظام (شاملة كل التحديثات الجديدة)
    const stateToExport = {
        // 1. بيانات التعريف
        meta: {
            appName: "نظام إدارة البضائع",
            version: "3.0 (تحديث العربونات والتكاليف)",
            backupDate: new Date().toISOString(),
            targetDate: dateToExport
        },

        // 2. البيانات الأساسية (المخزون والعملاء)
        products: products || [],       // يشمل الفئة (Category) وتكلفة الشراء المحدثة
        suppliers: suppliers || [],
        
        // 3. النظام المالي الجديد (الخزائن المتعددة)
        accounts: accounts || [],       // بديل السيولة الواحدة القديمة

        // 4. المبيعات (شاملة العربونات)
        salesToday: salesToday || [],       // الفواتير النهائية
        pendingSales: pendingSales || [],   // يشمل حقل depositPaid (العربون) الجديد
        completedReturns: completedReturns || [],
        pendingReturns: pendingReturns || [],
        pendingReturnsValue: (typeof pendingReturnsValue !== 'undefined') ? pendingReturnsValue : 0,

        // 5. المشتريات (شاملة التكاليف الإضافية)
        purchaseInvoices: purchaseInvoices || [], // يشمل حقل extraCosts والديون المرتبطة
        pendingPurchases: pendingPurchases || [],

        // 6. الديون والالتزامات
        debtors: debtors || [],
        liabilities: liabilities || [],
        monthlyLiabilities: monthlyLiabilities || [],

        // 7. السجلات والتقارير
        expenses: expenses || 0,
        totalProfit: totalProfit || 0,
        operationLog: operationLog || [],
        liquidityLog: liquidityLog || [], // سجل الخزينة التفصيلي
        serialNumbersLog: serialNumbersLog || [],
        inboxTasks: inboxTasks || []
    };

    // تحويل البيانات لنص JSON وتنزيل الملف
    try {
        const jsonString = JSON.stringify(stateToExport, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        
        const link = document.createElement('a');
        link.href = url;
        // تسمية الملف باسم معبر يحتوي على التاريخ
        link.download = `Backup_${dateToExport}_WithDeposits.json`;
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        showGlobalMessage(`تم تصدير نسخة احتياطية شاملة لتاريخ ${formatDateForDisplay(dateToExport)} بنجاح.`, false);
        console.log("Backup completed successfully.");
    } catch (e) {
        console.error("Export failed:", e);
        showGlobalMessage("حدث خطأ أثناء التصدير. راجع الـ Console.", true);
    }
}
 function importData(event) {
    const file = event.target.files[0];
    const importMsgElement = document.getElementById("import-message");
    
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedData = JSON.parse(e.target.result);
            
            // التحقق الأساسي من صحة الملف
            if (typeof importedData !== 'object' || importedData === null) {
                throw new Error("صيغة الملف غير صالحة.");
            }

            // 🛠️ الإصلاح: إذا لم يكن التاريخ موجوداً في الملف، نستخدم التاريخ المختار في الواجهة
            const targetDateInput = document.getElementById("load-date-alt");
            let targetDate = targetDateInput ? targetDateInput.value : null;

            if (!importedData.savedForDate) {
                console.warn("الملف لا يحتوي على تاريخ محفوظ، سيتم استخدام التاريخ المختار.");
                if (targetDate) {
                    importedData.savedForDate = targetDate;
                } else {
                    // إذا لم يحدد المستخدم تاريخاً، نستخدم تاريخ اليوم
                    importedData.savedForDate = new Date().toISOString().split('T')[0];
                }
            } else {
                // إذا كان الملف يحتوي على تاريخ، نستخدمه
                // لكن، الأفضل دائماً أن نسأل المستخدم هل يريد الاستيراد لليوم المحدد أم لتاريخ الملف
                if (!targetDate) targetDate = importedData.savedForDate;
            }
            
            // التأكد النهائي من التاريخ المستهدف
            const finalDate = targetDate || importedData.savedForDate;

            const confirmationMsg = `سيتم استيراد البيانات وتطبيقها على تاريخ (${finalDate}).\n\nتحذير: سيتم استبدال البيانات الحالية لهذا اليوم. هل أنت متأكد؟`;

            if (confirm(confirmationMsg)) {
                loadState(importedData, finalDate);
                saveCurrentStateByDate(finalDate); // حفظ فوري
                updateUI();
                
                // تحديث الواجهة
                if (targetDateInput) targetDateInput.value = finalDate;
                if (typeof updateLoadDateDayName === 'function') {
                    updateLoadDateDayName(finalDate, document.getElementById("load-date-day-name-alt"));
                }
                
                showMessage(importMsgElement, "تم استيراد البيانات بنجاح.", false);
            } else {
                showMessage(importMsgElement, "تم إلغاء الاستيراد.", false, true);
            }

        } catch (error) {
            console.error("Import Error:", error);
            showMessage(importMsgElement, `خطأ في الملف: ${error.message}`, true);
        } finally {
            event.target.value = null; // تصفير الحقل للسماح بإعادة الاختيار
        }
    };
    reader.readAsText(file);
}

        // --- تقرير الطباعة العام ---
        function generateReportHTML(){ const {totalInventoryValue, totalCapital, totalDebtsValue, totalLiabilitiesValue} = calculateTotals(); const now = new Date(); const reportDate = currentLoadedDate ? formatDateForDisplay(currentLoadedDate) : "بيانات حالية غير محفوظة"; const printDateTime = now.toLocaleString('ar-EG', {timeZone: 'Africa/Cairo', dateStyle: 'full', timeStyle: 'medium'}); let productsTable = '<p>لا توجد منتجات في المخزون.</p>'; if(products.length > 0){ productsTable = `<table border="1" style="width:100%;border-collapse:collapse;margin-top:10px;font-size:.9em"><thead><tr style="background-color:#f2f2f2"><th style="padding:5px">اسم البضاعة</th><th style="padding:5px">الكمية</th><th style="padding:5px">المورد</th><th style="padding:5px">متوسط التكلفة</th><th style="padding:5px">إجمالي التكلفة</th></tr></thead><tbody>${[...products].sort((a, b) => a.name.localeCompare(b.name, 'ar')).map(p => { const supplier = suppliers.find(s => s.id === p.supplierId); return `<tr><td style="padding:5px">${p.name || 'غير مسمى'}</td><td style="padding:5px;text-align:center;">${Number(p.quantity) || 0}</td><td style="padding:5px">${supplier ? supplier.name : '-'}</td><td style="padding:5px;text-align:center;">${formatCurrency(p.costPrice)}</td><td style="padding:5px;text-align:center;">${formatCurrency((Number(p.quantity) || 0) * (Number(p.costPrice) || 0))}</td></tr>` }).join('')}</tbody><tfoot><tr style="background-color:#f2f2f2;font-weight:bold;"><td colspan="4" style="padding:5px;text-align:left;">إجمالي قيمة المخزون:</td><td style="padding:5px;text-align:center;">${formatCurrency(totalInventoryValue)}</td></tr></tfoot></table>` } let logList = '<p>لا توجد عمليات مسجلة.</p>'; if(operationLog.length > 0){ logList = `<ul style="list-style:none;padding-right:0;margin-top:10px;font-size:.85em">${[...operationLog].reverse().map(log => `<li style="border-bottom:1px dotted #ccc;margin-bottom:5px;padding-bottom:5px"><strong style="color:#333;">${log.type}:</strong> ${log.details}<br><small style="color:#555">${formatDateTime(log.timestamp)}</small></li>`).join('')}</ul>` } let debtorsTable = '<p>لا توجد ديون مستحقة.</p>'; if(debtors.length > 0){ const groupedDebtsForPrint = debtors.reduce((acc, debt) => { const name = debt.name; if (!acc[name]) acc[name] = { total: 0, items: [] }; const amount = Number(debt.amount) || 0; if(amount > 0.001){ acc[name].total += amount; acc[name].items.push({ reason: debt.reason || '-', amount: amount }); } return acc; }, {}); const sortedDebtorNames = Object.keys(groupedDebtsForPrint).filter(name => groupedDebtsForPrint[name].total > 0.001).sort((a, b) => a.localeCompare(b, 'ar')); if(sortedDebtorNames.length > 0) { debtorsTable = `<table border="1" style="width:100%;border-collapse:collapse;margin-top:10px;font-size:.9em"><thead><tr style="background-color:#f2f2f2"><th style="padding:5px">اسم المدين</th><th style="padding:5px">السبب</th><th style="padding:5px">المبلغ المستحق</th></tr></thead><tbody>`; sortedDebtorNames.forEach(name => { const data = groupedDebtsForPrint[name]; debtorsTable += `<tr style="background-color:#f9f9f9;"><td style="padding:5px; font-weight:bold;" colspan="2">${name} (الإجمالي)</td><td style="padding:5px; font-weight:bold;text-align:center;">${formatCurrency(data.total)}</td></tr>`; data.items.sort((a,b) => a.reason.localeCompare(b.reason, 'ar')).forEach(item => { debtorsTable += `<tr><td style="padding:5px; padding-right: 15px;"></td><td style="padding:5px;">${item.reason}</td><td style="padding:5px;text-align:center;">${formatCurrency(item.amount)}</td></tr>`; }); }); debtorsTable += `</tbody><tfoot><tr style="background-color:#f2f2f2;font-weight:bold;"><td colspan="2" style="padding:5px;text-align:left;">إجمالي الديون (لك):</td><td style="padding:5px;text-align:center;">${formatCurrency(totalDebtsValue)}</td></tr></tfoot></table>`; } } let liabilitiesTable = '<p>لا توجد التزامات مستحقة.</p>'; const validLiabilities = liabilities.filter(l => (Number(l.amount) || 0) > 0.001); if(validLiabilities.length > 0){ liabilitiesTable = `<table border="1" style="width:100%;border-collapse:collapse;margin-top:10px;font-size:.9em"><thead><tr style="background-color:#f2f2f2"><th style="padding:5px">اسم الدائن</th><th style="padding:5px">المبلغ المستحق</th></tr></thead><tbody>${[...validLiabilities].sort((a, b) => a.name.localeCompare(b.name, 'ar')).map(l => `<tr><td style="padding:5px">${l.name}</td><td style="padding:5px;text-align:center;">${formatCurrency(l.amount)}</td></tr>`).join('')}</tbody><tfoot><tr style="background-color:#f2f2f2;font-weight:bold;"><td style="padding:5px;text-align:left;">إجمالي الالتزامات (عليك):</td><td style="padding:5px;text-align:center;">${formatCurrency(totalLiabilitiesValue)}</td></tr></tfoot></table>` } let suppliersTable = '<p>لا يوجد موردين مسجلين.</p>'; if(suppliers.length > 0){ suppliersTable = `<table border="1" style="width:100%;border-collapse:collapse;margin-top:10px;font-size:.9em"><thead><tr style="background-color:#f2f2f2"><th style="padding:5px">اسم المورد</th><th style="padding:5px">الاتصال</th><th style="padding:5px">العنوان</th></tr></thead><tbody>${[...suppliers].sort((a, b) => a.name.localeCompare(b.name, 'ar')).map(s => `<tr><td style="padding:5px">${s.name}</td><td style="padding:5px">${s.contact || '-'}</td><td style="padding:5px">${s.address || '-'}</td></tr>`).join('')}</tbody></table>` } return `<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="UTF-8"><title>تقرير العمليات - ${reportDate}</title><style>body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;margin:20px; line-height: 1.4;}h1,h2{color:#333;border-bottom:1px solid #ccc;padding-bottom:5px;margin-bottom:15px}h1{text-align:center;font-size:1.4em}h2{font-size:1.1em;margin-top:25px;margin-bottom:10px;}p{margin:5px 0;}table{width:100%;border-collapse:collapse;margin-top:10px;font-size:.9em}th,td{border:1px solid #ddd;padding:6px;text-align:right; vertical-align:top;}th{background-color:#f2f2f2;font-weight:bold;}.summary p{font-size:1em;margin:5px 0; padding-right: 10px;}.print-info{text-align:center;font-size:.8em;color:#666;margin-bottom:20px}ul{list-style:none; padding-right:0;} tfoot td {font-weight:bold;} @media print { body { -webkit-print-color-adjust: exact; print-color-adjust: exact; } h2 { page-break-before: auto; page-break-after: avoid; } table { page-break-inside: auto; } tr { page-break-inside: avoid; page-break-after: auto; } thead { display: table-header-group; } tfoot { display: table-footer-group; } } </style></head><body><h1>تقرير العمليات</h1><p class="print-info">تاريخ بيانات التقرير: ${reportDate}<br>تاريخ ووقت الطباعة: ${printDateTime}</p><div class="summary"><h2>الملخص المالي</h2><p><strong>السيولة المتاحة:</strong> ${formatCurrency(liquidity)}</p><p><strong>إجمالي قيمة المخزون:</strong> ${formatCurrency(totalInventoryValue)}</p><p><strong>قيمة البضاعة المؤقتة:</strong> ${formatCurrency(goodsOnConsignmentValue)}</p><p><strong>إجمالي الديون المستحقة للشركة:</strong> ${formatCurrency(totalDebtsValue)}</p><p><strong>إجمالي الالتزامات المستحقة على الشركة:</strong> ${formatCurrency(totalLiabilitiesValue)}</p><p><strong>إجمالي المصروفات المسجلة:</strong> ${formatCurrency(expenses)}</p><p><strong>إجمالي الربح المحقق:</strong> ${formatCurrency(totalProfit)}</p><p><strong>رأس المال الحالي:</strong> ${formatCurrency(totalCapital)}</p></div><h2>تفاصيل الالتزامات المستحقة على الشركة</h2>${liabilitiesTable}<h2>تفاصيل الديون المستحقة للشركة</h2>${debtorsTable}<h2>تفاصيل المخزون</h2>${productsTable}<h2>تفاصيل الموردين</h2>${suppliersTable}<h2>سجل العمليات</h2>${logList}</body></html>` }
        // =======================================================
// START: Monthly Liabilities Functions
// =======================================================

function updateMonthlyLiabilitiesDisplay() {
    if (!monthlyLiabilitiesList) return;
    monthlyLiabilitiesList.innerHTML = ''; // Clear list

    if (monthlyLiabilities.length === 0) {
        monthlyLiabilitiesList.innerHTML = '<li class="text-center text-gray-500">لا توجد التزامات شهرية مسجلة.</li>';
        return;
    }

    const sortedLiabilities = [...monthlyLiabilities].sort((a, b) => a.name.localeCompare(b.name, 'ar'));

    sortedLiabilities.forEach(liability => {
        const li = document.createElement('li');
        li.className = 'flex justify-between items-center p-2 bg-gray-50 rounded-md border';
        li.innerHTML = `
            <div>
                <span class="font-semibold text-gray-800">${liability.name}</span>
                <span class="text-red-600 font-mono ml-4">${formatCurrency(liability.amount)}</span>
            </div>
            <div class="actions">
                <button data-id="${liability.id}" class="edit-monthly-liability-btn text-xs bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-semibold py-1 px-2 rounded">تعديل</button>
                <button data-id="${liability.id}" class="delete-monthly-liability-btn text-xs bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-2 rounded mr-1">حذف</button>
            </div>
        `;
        monthlyLiabilitiesList.appendChild(li);
    });
}

function resetMonthlyLiabilityForm() {
    editingMonthlyLiabilityId = null;
    if (monthlyLiabilityNameInput) monthlyLiabilityNameInput.value = '';
    if (monthlyLiabilityAmountInput) monthlyLiabilityAmountInput.value = '';
    if (monthlyLiabilityFormTitle) monthlyLiabilityFormTitle.textContent = "إضافة التزام شهري جديد";
    if (addMonthlyLiabilityButton) addMonthlyLiabilityButton.textContent = "إضافة / تحديث";
    if (cancelEditMonthlyLiabilityButton) cancelEditMonthlyLiabilityButton.classList.add('hidden');
    if (monthlyLiabilityMessage) showMessage(monthlyLiabilityMessage, '');
}

function addOrUpdateMonthlyLiability() {
    const name = monthlyLiabilityNameInput.value.trim();
    const amount = parseInputNumber(monthlyLiabilityAmountInput);

    if (!name || isNaN(amount) || amount <= 0) {
        showMessage(monthlyLiabilityMessage, "يرجى إدخال اسم ومبلغ صحيح (> 0).", true);
        return;
    }

    if (editingMonthlyLiabilityId) {
        // Update existing
        const liability = monthlyLiabilities.find(l => l.id === editingMonthlyLiabilityId);
        if (liability) {
            liability.name = name;
            liability.amount = amount;
            logOperation("تعديل التزام شهري", `تم تعديل الالتزام الشهري "${name}" إلى مبلغ ${formatCurrency(amount)}.`);
            showMessage(monthlyLiabilityMessage, "تم تحديث الالتزام الشهري بنجاح.");
        }
        resetMonthlyLiabilityForm();
    } else {
        // Add new
        if (monthlyLiabilities.some(l => l.name.toLowerCase() === name.toLowerCase())) {
             showMessage(monthlyLiabilityMessage, `الالتزام الشهري بالاسم "${name}" موجود بالفعل.`, true);
             return;
        }
        const newLiability = { id: generateId('m-liab'), name, amount };
        monthlyLiabilities.push(newLiability);
        logOperation("إضافة التزام شهري", `تمت إضافة التزام شهري جديد: "${name}" بقيمة ${formatCurrency(amount)}.`);
        showMessage(monthlyLiabilityMessage, "تمت إضافة الالتزام الشهري بنجاح.");
        resetMonthlyLiabilityForm(); // Reset form after adding
    }
    updateUI();
}

function processMonthlyLiabilities() {
    console.log("Checking for monthly liabilities processing...");
    const today = new Date();
    const currentMonthStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`; // YYYY-MM
    const lastProcessedMonth = fetchData(lsLastProcessedMonthKey, null);

    if (currentMonthStr === lastProcessedMonth) {
        console.log("Monthly liabilities for", currentMonthStr, "have already been processed.");
        return; // Already processed this month
    }

    if (monthlyLiabilities.length === 0) {
        console.log("No monthly liabilities defined. Skipping.");
        saveData(lsLastProcessedMonthKey, currentMonthStr);
        return;
    }

    console.log(`Processing monthly liabilities for new month: ${currentMonthStr}`);
    let totalAdded = 0;
    let addedItemsLog = [];

    monthlyLiabilities.forEach(mLiability => {
        const liabilityName = `التزام شهري: ${mLiability.name}`;
        const newLiability = {
            id: generateId('liab'),
            name: liabilityName,
            amount: mLiability.amount
        };
        liabilities.push(newLiability);
        totalAdded += mLiability.amount;
        addedItemsLog.push(`"${mLiability.name}" بقيمة ${formatCurrency(mLiability.amount)}`);
    });

    logOperation("معالجة التزامات شهرية", `تمت إضافة التزامات شهر ${currentMonthStr} تلقائياً: ${addedItemsLog.join(', ')}.`);
    saveData(lsLastProcessedMonthKey, currentMonthStr); // Mark this month as processed
    
    showGlobalMessage(`تمت إضافة الالتزامات الشهرية (بمجموع ${formatCurrency(totalAdded)}) تلقائياً لهذا الشهر.`, false, true);
}

// =======================================================
// END: Monthly Liabilities Functions
// =======================================================

        // --- إعادة تعيين النماذج ---
        function resetProductForm() {
             editingProductName = null;
             if(productNameInput) productNameInput.value = "";
             if(productQuantityInput) productQuantityInput.value = "0";
             if(productCostPriceInput) productCostPriceInput.value = "0";
             if(productSupplierSelect) productSupplierSelect.value = "";
             if(productCategoryInput) productCategoryInput.value = "";
             if(productDeductLiquidityCheckbox) productDeductLiquidityCheckbox.checked = false; // Reset checkbox
             if(serialNumberEntryContainer) serialNumberEntryContainer.classList.add('hidden'); // Hide serial field
             if(productSerialNumbersTextarea) productSerialNumbersTextarea.value = ''; // Clear serial field
             if(serialImportMessage) showMessage(serialImportMessage, ''); // Clear serial import message
             if(addProductButton) {
                 addProductButton.textContent = "إضافة/تحديث البضاعة";
                 addProductButton.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                 addProductButton.classList.add('bg-green-500', 'hover:bg-green-600');
             }
             if(productFormTitle) productFormTitle.textContent = "إضافة / تحديث بضاعة";
             if(cancelEditProductButton) cancelEditProductButton.classList.add('hidden');
             if(productMessage) { showMessage(productMessage,""); productMessage.classList.remove('visible','error','success','info');}
         }

        // --- <<< دالة جديدة لتعديل السيولة اليدوي >>> ---
       function adjustLiquidityManually() {
    // --- ✅ تم تعديل هذه الدالة بالكامل لتعمل مع الحسابات المتعددة ---
    const accountId = d('adjust-safe-select').value;
    const newBalance = parseInputNumber(d('adjust-amount-input'));
    const reason = d('adjust-reason-input').value.trim();
    const messageEl = d('adjust-liquidity-message'); // اسم متغير أفضل

    // 1. التحقق من المدخلات
    if (!accountId) {
        showMessage(messageEl, "يرجى اختيار الحساب للتعديل.", true);
        return;
    }
    if (isNaN(newBalance) || newBalance < 0) {
        showMessage(messageEl, "يرجى إدخال رصيد جديد صحيح (رقم موجب).", true);
        return;
    }
    if (!reason) {
        showMessage(messageEl, "يرجى إدخال سبب التعديل.", true);
        return;
    }
    
    // 2. العثور على الحساب المحدد
    const account = accounts.find(acc => acc.id === accountId);
    if (!account) {
        showMessage(messageEl, "خطأ: الحساب المحدد غير موجود.", true);
        return;
    }

    const oldBalance = account.balance;
    
    // 3. تأكيد من المستخدم
    if (confirm(`هل أنت متأكد من تغيير رصيد حساب "${account.name}" من ${formatCurrency(oldBalance)} إلى ${formatCurrency(newBalance)}؟`)) {
        saveStateToHistory(); // حفظ الحالة قبل التغيير للسماح بالتراجع

        // 4. تنفيذ التعديل
        account.balance = newBalance;
        
        const adjustment = newBalance - oldBalance; // حساب قيمة التغيير
        const newTotalLiquidity = accounts.reduce((sum, acc) => sum + acc.balance, 0);

        // 5. تسجيل العملية في السجلات
        logOperation("تعديل رصيد يدوي", `تم تعديل رصيد حساب "${account.name}" إلى ${formatCurrency(newBalance)}. السبب: ${reason}.`);
        
        liquidityLog.push({
            id: `liq-adj-${Date.now()}`,
            timestamp: new Date().toISOString(),
            type: "adjust",
            amount: adjustment,
            description: `تعديل يدوي لحساب "${account.name}" - ${reason}`,
            currentBalance: newTotalLiquidity 
        });

        // 6. تحديث الواجهة وتنظيف النموذج
        updateUI();
        showMessage(messageEl, `تم تعديل رصيد حساب "${account.name}" بنجاح.`, false);
        d('adjust-amount-input').value = '';
        d('adjust-reason-input').value = '';
    } else {
        showMessage(messageEl, "تم إلغاء عملية التعديل.", false, true);
    }
}
            // --- Invoice Modal Logic ---
            function inv_openModal() {
                console.log("inv_openModal called");
                if (!isInvoiceFromPending) {
                    pendingSaleOriginData = null;
                }
                if (inv_modal) {
                    inv_modal.style.display = 'block';
                    if(inv_invoiceForm) inv_invoiceForm.reset();
                    if(inv_invoiceItemsBody) inv_invoiceItemsBody.innerHTML = '';
                    // Reset phone numbers to just one entry
                    if(inv_phoneNumbersContainer) {
                        inv_phoneNumbersContainer.innerHTML = `<div class="form-row inv-phone-entry">
                                                                <div class="form-group">
                                                                    <label for="inv_phone1">رقم هاتف 1:</label>
                                                                    <input type="tel" id="inv_phone1" name="phone[]" placeholder="رقم الهاتف">
                                                                </div>
                                                                </div>`;
                    }
                    inv_phoneCounter = 1;
                    if(inv_validationErrorDiv) { inv_validationErrorDiv.textContent = ''; inv_validationErrorDiv.classList.remove('visible','error'); }
                    if(inv_itemAddErrorDiv) { inv_itemAddErrorDiv.textContent = ''; inv_itemAddErrorDiv.classList.remove('visible','error'); }
                    if(inv_serialSelectContainer) inv_serialSelectContainer.classList.add('hidden'); // Hide serial select initially
                    if(inv_serialSearchInput) inv_serialSearchInput.value = ''; // Clear serial search input
                    const existingNote = inv_invoiceItemsBody?.parentNode.querySelector('p.invoice-origin-note');
                    if(existingNote) existingNote.remove(); // Remove previous origin notes
                    inv_updateDeductibleCostsCheckboxes();
                    inv_calculateTotals();
                } else {
                    console.error("Modal element not found");
                }
            }

            function inv_closeModal() {
                 if (inv_modal) {
                     inv_modal.style.display = 'none';
                     isInvoiceFromPending = false; // Reset flag when closing manually
                     pendingSaleOriginData = null; // Clear origin data
                     // **** إرجاع حالة السيريالات المحجوزة مؤقتاً في الفاتورة إلى متوفر ****
                     serialNumbersLog.forEach(log => {
                         if (log.status === 'in_invoice_temp') {
                             log.status = 'in_stock';
                             console.log(`Serial ${log.serial} status reverted to 'in_stock' on modal close.`);
                         }
                     });
                 }
             }

            // **** دالة جديدة لملء قائمة السيريالات المتاحة مع فلترة ****
            function populateAvailableSerials(productName, selectElement, searchTerm = '') {
                if (!selectElement) return;
                const currentSelectedValue = selectElement.value; // Keep track of current selection if any
                selectElement.innerHTML = ''; // Clear previous options

                const availableSerials = serialNumbersLog.filter(log =>
                    log.productName === productName && log.status === 'in_stock'
                );

                // استبعاد السيريالات الموجودة بالفعل في الفاتورة الحالية (المحجوزة مؤقتاً)
                const serialsInCurrentInvoice = [];
                if (inv_invoiceItemsBody) {
                    inv_invoiceItemsBody.querySelectorAll('.invoice-item-row').forEach(row => {
                        if (row.dataset.itemSerial) {
                            serialsInCurrentInvoice.push(row.dataset.itemSerial);
                        }
                    });
                }

                // فلترة إضافية بناءً على مصطلح البحث
                const filteredSerials = availableSerials
                    .filter(log => !serialsInCurrentInvoice.includes(log.serial))
                    .filter(log => log.serial.toLowerCase().includes(searchTerm.toLowerCase())); // Filter by search term

                if (filteredSerials.length > 0) {
                     selectElement.innerHTML = '<option value="">-- اختر الرقم التسلسلي --</option>'; // Add default option back
                    filteredSerials.forEach(log => {
                        const option = document.createElement('option');
                        option.value = log.serial;
                        option.textContent = log.serial;
                         if (log.serial === currentSelectedValue) { // Re-select if it still matches filter
                             option.selected = true;
                         }
                        selectElement.appendChild(option);
                    });
                     // Ensure the previously selected value is still set if it exists after filtering
                     if (filteredSerials.some(log => log.serial === currentSelectedValue)) {
                         selectElement.value = currentSelectedValue;
                     } else {
                         selectElement.value = ""; // Reset if previous selection is filtered out
                     }
                    return true; // Indicate that serials are available
                } else {
                     selectElement.innerHTML = `<option value="">-- لا توجد سيريالات مطابقة${searchTerm ? ' للبحث' : ''} --</option>`;
                     return false; // Indicate no serials available or matching search
                }
            }


function inv_addInvoiceItem() {
    // تعريف حقول الإدخال الأساسية
    const nameInput = document.getElementById('inv_itemName');
    const qtyInput = document.getElementById('inv_itemQty');
    const priceInput = document.getElementById('inv_itemPrice');
    const errorDiv = document.getElementById('inv_itemAddError');
    const itemsBody = document.getElementById('inv_invoiceItemsBody');
    
    // --- التعديل الجديد: قراءة السيريال من حقل الكتابة الجديد ---
    const serialInput = document.getElementById('inv_itemSerialInput');
    const serialContainer = document.getElementById('inv_serialSelectContainer');
    
    if (!nameInput || !qtyInput || !priceInput || !itemsBody) return;

    const name = nameInput.value.trim();
    const qty = parseInt(qtyInput.value);
    const price = parseFloat(priceInput.value); // استخدام parseFloat مباشرة
    
    // قراءة قيمة السيريال (إذا كان الحقل موجوداً)
    const selectedSerial = serialInput ? serialInput.value.trim() : '';

    // تفريغ رسائل الخطأ السابقة
    if (errorDiv) {
        errorDiv.textContent = "";
        errorDiv.classList.remove('visible', 'error');
    }

    // 1. التحقق من البيانات الأساسية
    if (!name || isNaN(qty) || qty <= 0 || isNaN(price) || price < 0) {
        if(errorDiv) {
            errorDiv.textContent = 'يرجى إدخال اسم البند وكمية (>0) وسعر (>=0) صحيحين.';
            errorDiv.classList.add('visible', 'error');
        }
        return;
    }

    // 2. التحقق من تكرار السيريال في نفس الفاتورة الحالية
    if (selectedSerial && itemsBody.querySelector(`tr[data-item-serial="${selectedSerial}"]`)) {
        if(errorDiv) {
            errorDiv.textContent = `الرقم التسلسلي "${selectedSerial}" تم إضافته بالفعل لهذه الفاتورة.`;
            errorDiv.classList.add('visible', 'error');
        }
        return;
    }
    
    // 3. التحقق من أن السيريال ليس مباعاً من قبل (فقط إذا كان مسجلاً في النظام)
    if (selectedSerial && typeof serialNumbersLog !== 'undefined') {
        const existingSerialLog = serialNumbersLog.find(s => s.serial === selectedSerial && s.productName === name);
        if (existingSerialLog && existingSerialLog.status === 'sold') {
             if(errorDiv) {
                errorDiv.textContent = `تنبيه: السيريال "${selectedSerial}" مسجل كمباع مسبقاً.`;
                errorDiv.classList.add('visible', 'error');
             }
             return;
        }
    }

    // 4. التحقق من توفر الكمية في المخزون
    let currentProduct = null;
    if (typeof products !== 'undefined') {
        currentProduct = products.find(p => p.name.toLowerCase() === name.toLowerCase());
    }
    
    const availableQty = currentProduct ? (Number(currentProduct.quantity) || 0) : Infinity; 
    const currentCostPrice = currentProduct ? (Number(currentProduct.costPrice) || 0) : 0; 

    let alreadyAddedQty = 0;
    itemsBody.querySelectorAll('.invoice-item-row').forEach(row => {
        if (row.dataset.itemName.toLowerCase() === name.toLowerCase()) {
            alreadyAddedQty += parseInt(row.dataset.itemQty);
        }
    });

    if (currentProduct && (qty + alreadyAddedQty) > availableQty) {
        if(errorDiv) {
            errorDiv.textContent = `الكمية الإجمالية المطلوبة غير متوفرة بالمخزون (المتاح: ${availableQty}).`;
            errorDiv.classList.add('visible', 'error');
        }
        return;
    }

    // 5. إضافة الصف إلى الجدول
    const subtotal = qty * price;
    const newRow = document.createElement('tr');
    newRow.classList.add('invoice-item-row');
    newRow.dataset.itemName = name;
    newRow.dataset.itemQty = qty;
    newRow.dataset.itemPrice = price.toFixed(2);
    newRow.dataset.itemSubtotal = subtotal.toFixed(2);
    newRow.dataset.itemCost = currentCostPrice.toFixed(2);

    // إضافة بيانات السيريال للصف
    if (selectedSerial && qty === 1) {
        newRow.dataset.itemSerial = selectedSerial;
        // حجز مؤقت في سجل السيريالات (إن وجد في النظام)
        if (typeof serialNumbersLog !== 'undefined') {
            const serialIndex = serialNumbersLog.findIndex(log => log.serial === selectedSerial);
            if (serialIndex !== -1) {
                serialNumbersLog[serialIndex].status = 'in_invoice_temp';
            }
        }
    }

    // تنسيق العملة (يمكنك استخدام دالة formatCurrency الخاصة بك بدلاً من هذا إذا كانت متاحة)
    const formatMoney = (amount) => typeof formatCurrency === 'function' ? formatCurrency(amount) : amount.toFixed(2);

    newRow.innerHTML = `
        <td class="item-name">
            ${name}
            ${selectedSerial && qty === 1 ? `<span class="serial-display no-print" style="display:block; font-size:0.8em; color:#666;">(S/N: ${selectedSerial})</span>` : ''}
        </td>
        <td class="item-qty" style="text-align:center;">${qty}</td>
        <td class="item-price" style="text-align:center;">${formatMoney(price)}</td>
        <td class="item-subtotal" style="text-align:center; font-weight:bold;">${formatMoney(subtotal)}</td>
        <td class="no-print" style="text-align:center;"><button type="button" class="remove-item-btn" style="color:red; font-weight:bold; border:none; background:none; cursor:pointer;">×</button></td>
    `;
    itemsBody.appendChild(newRow);

    // 6. تنظيف الحقول وإعادة التعيين
    nameInput.value = '';
    qtyInput.value = '1';
    priceInput.value = '0';
    
    // إخفاء وتفريغ حقل السيريال الجديد
    if (serialContainer) serialContainer.classList.add('hidden');
    if (serialInput) serialInput.value = ''; 
    
    nameInput.focus();
    
    // تحديث الإجماليات (تأكد أن دالة inv_calculateTotals موجودة لديك)
    if (typeof inv_calculateTotals === 'function') inv_calculateTotals();
    if (typeof inv_updateDeductibleCostsCheckboxes === 'function') inv_updateDeductibleCostsCheckboxes();
}

            function inv_validateForm() {
                 if(!inv_validationErrorDiv) return true; // Skip validation if element DNE
                 showMessage(inv_validationErrorDiv, "", false); // Clear previous error
                 let isValid = true;
                 let errors = [];

                 if (!inv_customerNameInput || inv_customerNameInput.value.trim() === '') {
                     isValid = false;
                     errors.push('اسم العميل مطلوب.');
                     if(inv_customerNameInput) inv_customerNameInput.style.borderColor = 'red';
                 } else {
                     if(inv_customerNameInput) inv_customerNameInput.style.borderColor = '';
                 }

                 if (!inv_invoiceItemsBody || inv_invoiceItemsBody.querySelectorAll('.invoice-item-row').length === 0) {
                     isValid = false;
                     errors.push('يجب إضافة بند واحد على الأقل للفاتورة.');
                 }

                 // Validate deductible items stock just before saving
                 const deductibleCheckboxes = inv_deductibleCostsContainer ? inv_deductibleCostsContainer.querySelectorAll('input[type="checkbox"]:checked') : [];
                 let tempUnavailableDeducted = null;
                 deductibleCheckboxes.forEach(checkbox => {
                     if (tempUnavailableDeducted) return; // Stop checking if one error found
                     const name = checkbox.value;
                     const available = parseInt(checkbox.dataset.available) || 0;
                    const parentLabel = checkbox.closest('label');
const quantityInput = parentLabel.querySelector('.inv-deducted-item-quantity');
const qtyToDeduct = parseInt(quantityInput.value) || 0; // يقرأ الكمية من الحقل الجديد

if (available < qtyToDeduct) {
                         tempUnavailableDeducted = { name: name, required: qtyToDeduct, available: available };
                     }
                 });

                 if (tempUnavailableDeducted) {
                     isValid = false;
                     errors.push(`الكمية المطلوبة للخصم (${tempUnavailableDeducted.required}) من "${tempUnavailableDeducted.name}" غير متوفرة (${tempUnavailableDeducted.available}).`);
                 }


                 if (!isValid) {
                     showMessage(inv_validationErrorDiv, errors.join('<br>'), true);
                 }
                 return isValid;
             }
function getInvoiceFormData() {
    return {
        customerName: inv_customerNameInput.value.trim(),
        customerAddress: inv_customerAddressInput ? inv_customerAddressInput.value.trim() : '',
        phones: inv_invoiceForm ? Array.from(inv_invoiceForm.querySelectorAll('input[name="phone[]"]')).map(i => i.value.trim()).filter(Boolean) : [],
        shippingCost: parseInputNumber(inv_shippingCostInput) || 0,
        warranty: inv_warrantyInput ? inv_warrantyInput.value.trim() : '',
        notes: inv_notesTextarea ? inv_notesTextarea.value.trim() : '',
        selectedAccountId: d('inv_payment_account').value,
        isPendingCheckbox: d('inv_markAsPending').checked,
        
        // تجميع البنود من الجدول
        items: inv_invoiceItemsBody ? Array.from(inv_invoiceItemsBody.querySelectorAll('.invoice-item-row')).map(row => ({
            name: row.dataset.itemName,
            quantity: parseInt(row.dataset.itemQty),
            unitPrice: parseFloat(row.dataset.itemPrice),
            subtotal: parseFloat(row.dataset.itemSubtotal),
            costPrice: parseFloat(row.dataset.itemCost),
            serial: row.dataset.itemSerial || null
        })) : []
    };
}

/**
 * ب. دالة الحسابات المالية (Financial Logic)
 * وظيفتها: حساب الإجماليات، والتعامل مع العربون، وتحديد المبلغ المطلوب تحصيله الآن
 */
function calculateInvoiceFinancials(items, shippingCost, isFromPending, originData) {
    const totalGoods = items.reduce((sum, item) => sum + item.subtotal, 0);
    const grandTotal = totalGoods + shippingCost;
    
    // --- منطق العربون الحساس ---
    let depositPaid = 0;
    if (isFromPending && originData && originData.depositPaid) {
        depositPaid = Number(originData.depositPaid) || 0;
    }

    // حساب المطلوب دفعه الآن (الإجمالي - العربون)
    let amountToCollect = grandTotal - depositPaid;
    if (amountToCollect < 0) amountToCollect = 0;

    return { 
        totalGoods, 
        grandTotal, 
        depositPaid, 
        amountToCollect 
    };
}

/**
 * ج. دالة معالجة المخزون والتكلفة (Inventory & Cost Logic)
 * وظيفتها: خصم الكميات من المخزون (لو فاتورة جديدة) وحساب التكلفة الكلية شاملة الملحقات
 */
function processInventoryAndCosts(items, isFromPending) {
    let totalItemsCost = 0;
    let deductedItemsData = [];
    let requiredQuantities = {};

    // 1. تجميع المنتجات المباعة وحساب تكلفتها
    items.forEach(item => {
        totalItemsCost += (item.costPrice * item.quantity);
        if (!isFromPending) { 
            // نجمع الكميات لخصمها لاحقاً (فقط لو فاتورة جديدة)
            requiredQuantities[item.name] = (requiredQuantities[item.name] || 0) + item.quantity;
        }
    });

    // 2. تجميع وخصم الملحقات (الهدايا)
    // يتم هذا فقط للفواتير الجديدة، لأن الفواتير القادمة من "معلق" تم خصم ملحقاتها مسبقاً
    if (!isFromPending && inv_deductibleCostsContainer) {
        const checkedBoxes = inv_deductibleCostsContainer.querySelectorAll('input[type="checkbox"]:checked');
        checkedBoxes.forEach(checkbox => {
            const name = checkbox.value;
            const cost = parseFloat(checkbox.dataset.cost) || 0;
            const parentLabel = checkbox.parentElement;
            const qtyInput = parentLabel.querySelector('.inv-deducted-item-quantity');
            const qtyToDeduct = parseInt(qtyInput?.value || '0');
            
            if (qtyToDeduct > 0) {
                deductedItemsData.push({ name, quantity: qtyToDeduct, costPrice: cost });
                totalItemsCost += (cost * qtyToDeduct); // نضيف تكلفة الهدية للتكلفة الكلية
                requiredQuantities[name] = (requiredQuantities[name] || 0) + qtyToDeduct;
            }
        });
    }

    // 3. التنفيذ الفعلي للخصم من مصفوفة المنتجات العامة
    Object.keys(requiredQuantities).forEach(itemName => {
        const productIndex = products.findIndex(p => p.name.toLowerCase() === itemName.toLowerCase());
        if (productIndex !== -1) {
            products[productIndex].quantity -= requiredQuantities[itemName];
        }
    });

    return { totalItemsCost, deductedItemsData };
}

/**
 * د. دالة تحديث الحالة العامة (Global State Updates)
 * وظيفتها: تحديث السيولة، السيريالات، وحذف البيع المؤقت القديم
 */
function updateGlobalState(account, amountToCollect, customerName, grandTotal, depositPaid, accountId, items, isFromPending, pendingOrigin) {
    // 1. تحديث السيولة
    if (amountToCollect > 0 && account) {
        account.balance += amountToCollect;
        const newTotalLiquidity = accounts.reduce((sum, acc) => sum + acc.balance, 0);
        
        let logDesc = `فاتورة مبيعات ${customerName}`;
        if (depositPaid > 0) {
            logDesc = `استلام باقي فاتورة ${customerName} (إجمالي: ${grandTotal} - عربون: ${depositPaid})`;
        }
        
        liquidityLog.push({ 
            id: `liq-${Date.now()}`, 
            timestamp: new Date().toISOString(), 
            type: "add", 
            amount: amountToCollect, 
            description: logDesc, 
            currentBalance: newTotalLiquidity,
            accountId: accountId
        });
    }

    // 2. تحديث السيريالات
    items.forEach(item => {
        if (item.serial) {
            const idx = serialNumbersLog.findIndex(log => log.serial === item.serial);
            if (idx !== -1) serialNumbersLog[idx].status = 'sold';
        }
    });

    // 3. حذف البيع المؤقت الأصلي
    if (isFromPending && pendingOrigin && pendingOrigin.id) {
        const idx = pendingSales.findIndex(s => String(s.id).trim() === String(pendingOrigin.id).trim());
        if (idx !== -1) pendingSales.splice(idx, 1);
    }
}

async function handleSaveInvoice() {
    saveStateToHistory(); 
    
    // 1. التحقق من صحة النموذج
    if (!inv_validateForm()) { return; }

    const isPending = d('inv_markAsPending').checked; 
    const selectedAccountId = d('inv_payment_account').value;
    const account = accounts.find(acc => acc.id === selectedAccountId);

    // إذا كانت فاتورة نهائية، يجب اختيار حساب
    if (!isPending && !account) {
        showMessage(d('inv_validationError'), "يرجى اختيار حساب الإيداع.", true);
        return;
    }

    // 2. تجميع البيانات
    const customerName = inv_customerNameInput.value.trim();
    const customerAddress = inv_customerAddressInput ? inv_customerAddressInput.value.trim() : '';
    const phones = inv_invoiceForm ? Array.from(inv_invoiceForm.querySelectorAll('input[name="phone[]"]')).map(input => input.value.trim()).filter(phone => phone) : [];
    
    const invoiceItems = inv_invoiceItemsBody ? Array.from(inv_invoiceItemsBody.querySelectorAll('.invoice-item-row')).map(row => ({
        name: row.dataset.itemName,
        quantity: parseInt(row.dataset.itemQty),
        unitPrice: parseFloat(row.dataset.itemPrice),
        subtotal: parseFloat(row.dataset.itemSubtotal),
        costPrice: parseFloat(row.dataset.itemCost),
        serial: row.dataset.itemSerial || null
    })) : [];

    const shippingCost = parseInputNumber(inv_shippingCostInput) || 0;
    const warranty = inv_warrantyInput ? inv_warrantyInput.value.trim() : '';
    const notes = inv_notesTextarea ? inv_notesTextarea.value.trim() : '';
    
    const totalGoods = invoiceItems.reduce((sum, item) => sum + item.subtotal, 0);
    const grandTotal = totalGoods + shippingCost; 

    // --- معالجة العربون ---
    let depositAlreadyPaid = 0;
    if (isInvoiceFromPending && pendingSaleOriginData && pendingSaleOriginData.depositPaid) {
        depositAlreadyPaid = Number(pendingSaleOriginData.depositPaid) || 0;
    }
    
    // المبلغ الذي سيدخل الخزنة الآن
    let amountToCollectNow = grandTotal - depositAlreadyPaid;
    if (amountToCollectNow < 0) amountToCollectNow = 0; 
    // ----------------------

    // 3. حساب التكلفة ومعالجة الملحقات (المنطق المصحح 4.0)
    let totalInvoiceCost = 0;
    let deductedItemsData = [];
    let quantitiesToDeduct = {}; // لتجميع الكميات التي سيتم خصمها من المخزون

    // أ. حساب تكلفة المنتجات الأساسية
    invoiceItems.forEach(item => {
        totalInvoiceCost += (item.costPrice * item.quantity);
        
        // نجهز الكميات للخصم فقط إذا كانت فاتورة جديدة
        if (!isInvoiceFromPending) {
            quantitiesToDeduct[item.name] = (quantitiesToDeduct[item.name] || 0) + item.quantity;
        }
    });

    // ب. قراءة وحساب تكلفة الملحقات (يتم دائماً الآن لضمان دقة التكلفة وتسجيل البيانات)
    if (inv_deductibleCostsContainer) {
        const checkedBoxes = inv_deductibleCostsContainer.querySelectorAll('input[type="checkbox"]:checked');
        checkedBoxes.forEach(checkbox => {
            const name = checkbox.value;
            const cost = parseFloat(checkbox.dataset.cost) || 0;
            const parentLabel = checkbox.parentElement;
            const quantityInput = parentLabel.querySelector('.inv-deducted-item-quantity');
            const qtyToDeduct = parseInt(quantityInput?.value || '0');
            
            if (qtyToDeduct > 0) {
                // تسجيل البيانات للحفظ في الفاتورة
                deductedItemsData.push({ name, quantity: qtyToDeduct, costPrice: cost });
                
                // إضافة التكلفة للإجمالي (للحصول على صافي ربح دقيق)
                totalInvoiceCost += (cost * qtyToDeduct);
                
                // إضافة للكميات المطلوب خصمها من المخزون (فقط للجديد)
                if (!isInvoiceFromPending) {
                    quantitiesToDeduct[name] = (quantitiesToDeduct[name] || 0) + qtyToDeduct;
                }
            }
        });
    }

    // ج. تنفيذ خصم المخزون (فقط للفواتير الجديدة)
    if (!isInvoiceFromPending) {
        Object.keys(quantitiesToDeduct).forEach(itemName => {
            const productIndex = products.findIndex(p => p.name.toLowerCase() === itemName.toLowerCase());
            if (productIndex !== -1) {
                products[productIndex].quantity -= quantitiesToDeduct[itemName];
            }
        });
    }

    const finalInvoiceProfit = grandTotal - totalInvoiceCost; 

    // 4. الحفظ
    if (isPending) {
        // --- حفظ الفاتورة المؤقتة ---
        const pendingInvoiceData = {
            id: isInvoiceFromPending && pendingSaleOriginData ? pendingSaleOriginData.id : `pending-inv-${Date.now()}`,
            timestamp: new Date().toISOString(),
            customerName,
            customerAddress,
            phones,
            items: invoiceItems,
            shippingCost,
            warranty,
            notes,
            deductedItems: deductedItemsData, // ✅ الملحقات محفوظة
            
            totalSellPrice: grandTotal,
            totalCost: totalInvoiceCost, // ✅ التكلفة دقيقة
            potentialProfit: finalInvoiceProfit,
            
            depositPaid: depositAlreadyPaid, // ✅ العربون محفوظ
            status: 'pending',
            
            invoiceData: {
                customerAddress,
                phones,
                warranty,
                notes,
                deductedItems: deductedItemsData
            }
        };

        // حذف القديم إذا كان تعديل
        if (isInvoiceFromPending && pendingSaleOriginData && pendingSaleOriginData.id) {
            const idx = pendingSales.findIndex(s => String(s.id).trim() === String(pendingSaleOriginData.id).trim());
            if (idx !== -1) pendingSales.splice(idx, 1);
        }

        pendingSales.push(pendingInvoiceData);
        
        logOperation("فاتورة مؤقتة", `تم حفظ فاتورة مفصلة مؤقتة للعميل ${customerName} بقيمة ${formatCurrency(grandTotal)}.`);
        showMessage(globalMessage, "تم حفظ الفاتورة في قائمة المبيعات المؤقتة بنجاح.", false);

    } else {
      // --- 1. إنشاء رقم الفاتورة أولاً لضمان عدم حدوث خطأ ---
const generatedInvoiceNumber = "INV-" + Date.now(); 

// --- 2. منطق الدفع الجزئي والمديونية الجديد (المصحح) ---
const paidNow = parseFloat(document.getElementById('inv_paidAmount').value) || 0;
const depositAlreadyPaid = Number(pendingSaleOriginData?.depositPaid) || 0;
const totalInvoicePrice = grandTotal;

// تحديد كم سيتم إيداعه فعلياً في الخزينة الآن
let actualCashReceived = paidNow;
// استخدام document.getElementById لضمان الوصول للعنصر
const isPendingCheckbox = document.getElementById('inv_markAsPending');
if (paidNow === 0 && (!isPendingCheckbox || !isPendingCheckbox.checked)) {
    actualCashReceived = totalInvoicePrice - depositAlreadyPaid;
}

const remainingAsDebt = totalInvoicePrice - (actualCashReceived + depositAlreadyPaid);

// 3. تحديث الخزينة بالمبلغ المدفوع فعلياً فقط
if (actualCashReceived > 0) {
    account.balance += actualCashReceived;
    liquidityLog.push({
        id: `liq-${Date.now()}`,
        timestamp: new Date().toISOString(),
        type: "add",
        amount: actualCashReceived,
        description: `دفعة من فاتورة العميل: ${customerName}`,
        accountId: selectedAccountId
    });
}

// 4. تسجيل المتبقي كدين تلقائي
if (remainingAsDebt > 0.01) {
    debtors.push({
        id: `debt-auto-${Date.now()}`,
        name: customerName,
        reason: `متبقي فاتورة مبيعات رقم ${generatedInvoiceNumber}`,
        amount: remainingAsDebt,
        timestamp: new Date().toISOString()
    });
    logOperation("دين تلقائي", `تم تسجيل متبقي فاتورة على ${customerName} بقيمة ${formatCurrency(remainingAsDebt)}`);
}

        // ب. تحديث السيريالات
        invoiceItems.forEach(item => {
            if (item.serial) {
                const idx = serialNumbersLog.findIndex(log => log.serial === item.serial);
                if (idx !== -1) serialNumbersLog[idx].status = 'sold';
            }
        });

        // ج. تحديث الأرباح
        totalProfit += finalInvoiceProfit;

        // د. حذف البيع المؤقت الأصلي
        if (isInvoiceFromPending && pendingSaleOriginData && pendingSaleOriginData.id) {
            const idx = pendingSales.findIndex(s => String(s.id).trim() === String(pendingSaleOriginData.id).trim());
            if (idx !== -1) pendingSales.splice(idx, 1);
        }

        // هـ. إنشاء السجل
        const todayStr = currentLoadedDate ? currentLoadedDate.replace(/-/g, '') : getTodayDateString().replace(/-/g, '');
        let maxSeq = 0;
        salesToday.forEach(sale => {
            if (sale.invoiceNumber && sale.invoiceNumber.startsWith(todayStr)) {
                const seq = parseInt(sale.invoiceNumber.split('-')[1] || '0');
                if (seq > maxSeq) maxSeq = seq;
            }
        });
        

        const invoiceRecord = {
            id: isInvoiceFromPending && pendingSaleOriginData ? pendingSaleOriginData.id.replace('pending','inv') : `inv-${Date.now()}`,
            invoiceNumber: generatedInvoiceNumber,
            type: 'invoice',
            timestamp: new Date().toISOString(),
            saleDate: currentLoadedDate || getTodayDateString(),
            customerName, customerAddress, phones, items: invoiceItems,
            shippingCost, 
            totalGoodsPrice: totalGoods, 
            grandTotal, 
            paidAmount: grandTotal, 
            depositPaid: depositAlreadyPaid, 
            warranty, notes, 
            deductedItems: deductedItemsData, // ✅ سيتم حفظ الملحقات هنا
            totalCost: totalInvoiceCost,
            profit: finalInvoiceProfit, 
            accountId: selectedAccountId
        };
        
        salesToday.push(invoiceRecord);
        await saveInvoiceToFirestore(invoiceRecord); 

        logOperation("إنشاء فاتورة", `فاتورة ${generatedInvoiceNumber} للعميل ${customerName}. (إجمالي: ${grandTotal})`);
        
        let successMsg = `تم حفظ الفاتورة بنجاح.`;
        if (depositAlreadyPaid > 0) {
            successMsg += ` تم خصم العربون (${depositAlreadyPaid}) وإضافة الباقي (${amountToCollectNow}) للخزنة.`;
        }
        showMessage(globalMessage, successMsg, false);
    }

    isInvoiceFromPending = false;
    pendingSaleOriginData = null;
    updateUI();
    inv_closeModal();
}
            // (استكمالاً للجزء 8أ)
function printPendingSaleAsInvoice(pendingId) {
    console.log("printPendingSaleAsInvoice function started for ID:", pendingId);
    console.log("Attempting to print pending sale as invoice for ID:", pendingId);
    const saleIndex = pendingSales.findIndex(s => s.id === pendingId);
    if (saleIndex === -1) {
        console.error("Pending sale not found for printing:", pendingId);
        showGlobalMessage("خطأ: لم يتم العثور على البيع المؤقت للطباعة.", true);
        return;
    }
    const saleData = pendingSales[saleIndex];
    console.log("Found pending sale data:", saleData);

    // تهيئة بيانات مشابهة لكائن الفاتورة الذي تتوقعه دالة inv_printInvoice
    let itemsForPrint = [];
    const mainProductQty = Number(saleData.mainProduct.quantity) || 0;

    // سعر الوحدة للمنتج الرئيسي - تقدير بسيط للعرض
    let mainProductUnitPrice = 0;
    if (mainProductQty > 0) {
       mainProductUnitPrice = saleData.totalSellPrice / mainProductQty; // نفترض أن السعر موزع على المنتج الرئيسي بشكل أساسي للعرض
    }


    itemsForPrint.push({
        name: saleData.mainProduct.name,
        quantity: mainProductQty,
        unitPrice: mainProductUnitPrice,
        subtotal: mainProductUnitPrice * mainProductQty, // قد لا يكون دقيقاً إذا وجدت منتجات إضافية بسعر
        serial: null // البيع المؤقت لا يخزن سيريال محدد عادة
    });

    let totalGoodsForPrint = mainProductUnitPrice * mainProductQty;

    if (saleData.additionalItems && saleData.additionalItems.length > 0) {
        saleData.additionalItems.forEach(item => {
            itemsForPrint.push({
                name: item.name,
                quantity: Number(item.quantity) || 0,
                unitPrice: 0, // سعر المنتجات الإضافية يعتبر 0 في هذا العرض
                subtotal: 0,
                serial: null
            });
        });
         // إذا كان هناك منتجات إضافية، الإجمالي الكلي للبضاعة هو سعر البيع المؤقت
         totalGoodsForPrint = saleData.totalSellPrice;
         // يمكنك تعديل سعر المنتج الرئيسي إذا أردت (اختياري)
         if (itemsForPrint[0]) {
           // itemsForPrint[0].unitPrice = 0; // أو أي قيمة مناسبة
           // itemsForPrint[0].subtotal = 0;
         }
    }


    const invoiceDataForPrint = {
        customerName: saleData.customerName || '',
        customerAddress: '', // لا يوجد عنوان في البيع المؤقت
        phones: [], // لا توجد هواتف في البيع المؤقت
        items: itemsForPrint,
        shippingCost: 0, // لا يوجد شحن منفصل في البيع المؤقت
        grandTotal: saleData.totalSellPrice, // الإجمالي المطلوب هو سعر البيع المؤقت
        totalGoodsPrice: totalGoodsForPrint, // إجمالي البضاعة هو سعر البيع المؤقت
        warranty: '', // لا يوجد ضمان في البيع المؤقت
        notes: `*** فاتورة بيع مؤقت (للعرض فقط - لم يتم تأكيد العملية) ***\nالربح المتوقع (غير مؤكد): ${formatCurrency(saleData.potentialProfit)}`, // ملاحظة مهمة
        invoiceNumber: `مؤقت-${saleData.id.slice(-6)}`, // رقم فاتورة مؤقت
        timestamp: saleData.timestamp // استخدم وقت إنشاء البيع المؤقت
    };
    console.log("Data prepared for printing:", invoiceDataForPrint);

    // استدعاء دالة الطباعة الحالية مع البيانات المهيأة
    inv_printInvoice(invoiceDataForPrint); // مرر الكائن المنسق
}
            function inv_printInvoice(invoiceToPrint = null) { // Modified to accept an invoice object
                 let customerName, customerAddress, phones, items, shippingCost, grandTotal, warranty, notes, invoiceNumber, timestamp;
                 let totalGoodsPriceForPrint;
                 if (invoiceToPrint) { // Printing a saved/searched invoice
                      customerName = invoiceToPrint.customerName || '';
                      customerAddress = invoiceToPrint.customerAddress || '';
                      phones = invoiceToPrint.phones || [];
                      items = invoiceToPrint.items || []; // Items already include serial if saved
                      shippingCost = Number(invoiceToPrint.shippingCost) || 0;
                      grandTotal = Number(invoiceToPrint.grandTotal) || 0;
                      warranty = invoiceToPrint.warranty || '';
                      notes = invoiceToPrint.notes || '';
                      invoiceNumber = invoiceToPrint.invoiceNumber || `INV-${invoiceToPrint.id.slice(-6)}`; // Fallback ID based number
                      timestamp = invoiceToPrint.timestamp;
                       totalGoodsPriceForPrint = invoiceToPrint.totalGoodsPrice !== undefined ? Number(invoiceToPrint.totalGoodsPrice) : items.reduce((sum, i) => sum + parseFloat(i.subtotal || 0), 0);
                 } else { // Printing directly from modal before saving (or if validation fails on view)
                      if (!inv_validateForm()){ // Validate before generating preview print
                          console.log("Invoice Validation failed for printing!");
                          return;
                           totalGoodsPriceForPrint = items.reduce((sum, item) => sum + parseFloat(item.subtotal || 0), 0);
                      }
                      customerName = d('inv_customerName').value.trim();
                      customerAddress = d('inv_customerAddress').value.trim();
                      phones = inv_invoiceForm ? Array.from(inv_invoiceForm.querySelectorAll('input[name="phone[]"]')).map(input => input.value.trim()).filter(phone => phone) : [];
                      items = inv_invoiceItemsBody ? Array.from(inv_invoiceItemsBody.querySelectorAll('.invoice-item-row')).map(row => ({
                          name: row.dataset.itemName || '',
                          quantity: row.dataset.itemQty || 0,
                          unitPrice: parseFloat(row.dataset.itemPrice || 0).toFixed(2), // Use dataset, fallback might not work well
                          subtotal: parseFloat(row.dataset.itemSubtotal || 0).toFixed(2),
                          serial: row.dataset.itemSerial || null // **** احصل على السيريال للطباعة ****
                      })) : [];
                      shippingCost = inv_shippingCostInput ? (parseInputNumber(inv_shippingCostInput) || 0) : 0;
                      const totalGoods = items.reduce((sum, item) => sum + parseFloat(item.subtotal), 0);
                      grandTotal = totalGoods + shippingCost;
                      warranty = inv_warrantyInput ? inv_warrantyInput.value.trim() : '';
                      notes = inv_notesTextarea ? inv_notesTextarea.value.trim() : '';
                      timestamp = new Date().toISOString(); // Use current time for preview
                      invoiceNumber = `PREVIEW-${Date.now().toString().slice(-6)}`; // Preview number
                  }

                  const invoiceDate = new Date(timestamp);
                  const formattedDate = invoiceDate.toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' });
                  const formattedTime = invoiceDate.toLocaleTimeString('ar-EG', { hour: '2-digit', minute:'2-digit', hour12: true });

                  // Generate HTML for printing
                  let printHTML = `
                  <!DOCTYPE html>
                  <html lang="ar" dir="rtl">
                  <head>
                      <meta charset="UTF-8">

                      <title>فاتورة بيع - ${invoiceNumber}</title>
                      <style>
                          body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 15px; font-size: 10pt; line-height: 1.4; color: #333; }
                          .invoice-box { max-width: 800px; margin: auto; padding: 15px; border: 1px solid #eee; box-shadow: 0 0 8px rgba(0, 0, 0, 0.1); }
                          .invoice-header { text-align: center; margin-bottom: 20px; }
                          .invoice-header h1 { margin: 0; color: #000; font-size: 1.4em; }
                          .invoice-meta, .customer-info { margin-bottom: 15px; font-size: 9pt; }
                          .invoice-meta div, .customer-info div { margin-bottom: 4px; }
                          .invoice-meta span, .customer-info span { display: inline-block; min-width: 80px; font-weight: bold; margin-left: 5px;}
                          .customer-info { border-top: 1px solid #eee; padding-top: 10px; }
                          h3 { margin-top: 20px; margin-bottom: 8px; color:#000; border-bottom: 1px solid #eee; padding-bottom: 3px; font-size: 1.1em;}
                          table.items-table { width: 100%; line-height: inherit; text-align: right; border-collapse: collapse; margin-top: 5px; }
                          table.items-table th, table.items-table td { padding: 5px; border: 1px solid #ddd; vertical-align: top; }
                          table.items-table th { background: #f2f2f2; font-weight: bold; text-align: center; }
                          table.items-table td.num { text-align: center; font-family: monospace;}
                          table.items-table tr.total-row td { border-top: 2px solid #aaa; font-weight: bold; }
                          table.items-table tr.grand-total td { border-top: 2px solid #333; font-weight: bold; font-size: 1.1em; }
                          .text-left { text-align: left; }
                          .notes-section { margin-top: 20px; padding-top: 10px; border-top: 1px dashed #ccc; font-size: 9pt; }
                          .notes-section h4 { margin-top: 0; margin-bottom: 5px; font-size: 1em; }
                          .notes-section p { white-space: pre-wrap; margin: 0; }
                          .serial-display-print { font-size: 0.8em; color: #555; display: block; margin-top: 2px; } /* Style for printed serial */
                          @media print {
                              body { margin: 0; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                              .invoice-box { border: none; box-shadow: none; margin: 0; max-width: 100%; padding: 0; }
                              .serial-display-print { display: block !important; } /* Ensure serial shows in print */
                          }
                      </style>
                  </head>
                  <body>
                 
                      <div class="invoice-box">
                          <div class="invoice-header">
                              <h1>فاتورة بيع</h1>
                          </div>
                          <div class="invoice-meta">
                              <div><span>رقم الفاتورة:</span> ${invoiceNumber}</div>
                              <div><span>تاريخ الفاتورة:</span> ${formattedDate} ${formattedTime}</div>
                              ${warranty ? `<div><span>مدة الضمان:</span> ${warranty}</div>` : ''}
                          </div>
                          <div class="customer-info">
                              <h3 style="margin-top:0;">بيانات العميل:</h3>
                              <div><span>الاسم:</span> ${customerName || 'غير محدد'}</div>
                              ${customerAddress ? `<div><span>العنوان:</span> ${customerAddress}</div>` : ''}
                              ${phones.length > 0 ? `<div><span>الهواتف:</span> ${phones.join(' / ')}</div>` : ''}
                          </div>
                          <h3>تفاصيل البنود:</h3>
                          <table class="items-table">
                              <thead>
                                  <tr>
                                      <th>البند</th>
                                      <th>الكمية</th>
                                      <th>سعر الوحدة</th>
                                      <th>الإجمالي الفرعي</th>
                                  </tr>
                              </thead>
                              <tbody>
                                  ${items.map(item => `<tr>
                                      <td>
                                          ${item.name}
                                          ${item.serial ? `<span class="serial-display-print">(S/N: ${item.serial})</span>` : ''}
                                      </td>
                                      <td class="num">${item.quantity}</td>
                                      <td class="num">${formatCurrency(item.unitPrice)}</td>
                                      <td class="num">${formatCurrency(item.subtotal)}</td>
                                      </tr>`).join('')}
                                  <tr class="total-row">
                                      <td colspan="3" class="text-left">إجمالي البضاعة</td>
                                      <td class="num">${formatCurrency(totalGoodsPriceForPrint)}</td>
                                  </tr>
                                  ${shippingCost > 0 ? `<tr class="total-row">
                                      <td colspan="3" class="text-left">قيمة الشحن</td>
                                      <td class="num">${formatCurrency(shippingCost)}</td>
                                      </tr>` : ''}
                                  <tr class="grand-total">
                                      <td colspan="3" class="text-left">الإجمالي الكلي المطلوب</td>
                                      <td class="num">${formatCurrency(grandTotal)}</td>
                                  </tr>
                              </tbody>
                          </table>
                          ${notes ? `<div class="notes-section"><h4>ملاحظات:</h4><p>${notes.replace(/\n/g, '<br>')}</p></div>` : ''}
                          <div style="margin-top: 30px; text-align: center; font-size: 9pt; color: #666;">
                              --- شكراً لتعاملكم معنا ---
                          </div>
                      </div>
                      <!-- نافذة استلام عربون (تصميم معزول) -->
<div id="depositModal" class="modal" style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5);">
    <div class="modal-content" style="background-color:#fff; margin:10% auto; padding:20px; border-radius:8px; width:90%; max-width:400px; position:relative; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <span onclick="document.getElementById('depositModal').style.display='none'" style="position:absolute; left:15px; top:10px; cursor:pointer; font-size:24px; font-weight:bold; color:#666;">&times;</span>
        
        <h3 style="margin-top:0; color:#1f2937; border-bottom:1px solid #eee; padding-bottom:10px; font-family:sans-serif;">استلام دفعة / عربون</h3>
        
        <div style="margin-top:15px;">
            <div style="background:#f9fafb; padding:10px; border-radius:6px; margin-bottom:15px; font-size:13px;">
                <p style="margin:5px 0;"><strong>العميل:</strong> <span id="dep_customer_name">...</span></p>
                <p style="margin:5px 0;"><strong>إجمالي الفاتورة:</strong> <span id="dep_total_amount" style="color:#2563eb;">0.00</span></p>
                <p style="margin:5px 0;"><strong>تم دفع سابقاً:</strong> <span id="dep_already_paid" style="color:#16a34a;">0.00</span></p>
            </div>
            
            <div class="form-group" style="margin-bottom:15px;">
                <label style="display:block; font-size:12px; font-weight:bold; margin-bottom:5px;">المبلغ المستلم الآن:</label>
                <input type="number" id="dep_amount" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:4px; font-size:16px; font-weight:bold;" placeholder="0.00">
            </div>
            
            <div class="form-group" style="margin-bottom:20px;">
                <label style="display:block; font-size:12px; font-weight:bold; margin-bottom:5px;">إيداع في الخزنة:</label>
                <select id="dep_account" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:4px; background:#fff;"></select>
            </div>
            
            <input type="hidden" id="dep_pending_id">
            
            <button onclick="window.confirmDeposit()" style="width:100%; background-color:#7c3aed; color:white; padding:12px; border:none; border-radius:6px; font-weight:bold; cursor:pointer; font-size:14px;">تأكيد وحفظ العربون</button>
        </div>
    </div>
</div>
<!-- نافذة تفاصيل الربحية للبيع المؤقت -->
<div id="pendingDetailsModal" class="modal" style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.6); backdrop-filter: blur(2px);">
    <div class="modal-content" style="background-color:#fff; margin:10% auto; padding:0; border-radius:12px; width:90%; max-width:450px; overflow:hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
        
        <!-- الهيدر -->
        <div style="background: linear-gradient(to right, #1e40af, #3b82f6); padding: 15px 20px; color: white; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin:0; font-size:16px; font-weight:bold;">تفاصيل الربحية والتكلفة</h3>
            <span onclick="document.getElementById('pendingDetailsModal').style.display='none'" style="cursor:pointer; font-size:24px; opacity:0.8;">&times;</span>
        </div>

        <!-- الجسم -->
        <div style="padding: 20px;">
            
            <!-- العميل والمنتج -->
            <div style="text-align: center; margin-bottom: 20px;">
                <h2 id="pd_product_name" style="margin: 0; font-size: 18px; color: #1f2937; font-weight: bold;">...</h2>
                <p id="pd_customer_name" style="margin: 5px 0 0; color: #6b7280; font-size: 14px;">...</p>
            </div>

            <!-- بطاقة التكاليف -->
            <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                
                <!-- تفاصيل التكلفة -->
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px;">
                    <span style="color: #64748b;">تكلفة المنتج الأصلي:</span>
                    <span id="pd_main_cost" style="font-weight: bold; font-family: monospace;">0.00</span>
                </div>
                
                <!-- تفاصيل الملحقات -->
                <div id="pd_attachments_container" style="display: none; border-top: 1px dashed #cbd5e1; padding-top: 8px; margin-top: 8px;">
                    <div style="font-size: 12px; color: #94a3b8; margin-bottom: 4px;">+ تكلفة الملحقات المضافة:</div>
                    <ul id="pd_attachments_list" style="margin: 0; padding-right: 15px; font-size: 13px; color: #475569;">
                        <!-- سيتم إضافة الملحقات هنا -->
                    </ul>
                    <div style="display: flex; justify-content: space-between; margin-top: 5px; font-weight: bold; font-size: 13px; color: #475569;">
                        <span>إجمالي تكلفة الملحقات:</span>
                        <span id="pd_attachments_cost">0.00</span>
                    </div>
                </div>

                <!-- الخط الفاصل -->
                <hr style="border: 0; border-top: 1px solid #e2e8f0; margin: 12px 0;">

                <!-- الإجماليات -->
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span style="color: #ef4444; font-weight: bold;">إجمالي التكلفة (عليك):</span>
                    <span id="pd_total_cost" style="color: #ef4444; font-weight: bold; font-family: monospace; font-size: 15px;">0.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span style="color: #1f2937; font-weight: bold;">سعر البيع (للعميل):</span>
                    <span id="pd_sell_price" style="color: #1f2937; font-weight: bold; font-family: monospace; font-size: 15px;">0.00</span>
                </div>
            </div>

            <!-- النتيجة النهائية (الربح) -->
            <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 15px; text-align: center;">
                <span style="display: block; font-size: 12px; color: #166534; font-weight: bold; text-transform: uppercase;">صافي الربح المتوقع</span>
                <span id="pd_profit" style="display: block; font-size: 24px; color: #15803d; font-weight: 800; margin-top: 5px; font-family: monospace;">0.00</span>
            </div>

        </div>
        
        <!-- الفوتر -->
        <div style="background: #f9fafb; padding: 12px 20px; text-align: right; border-top: 1px solid #e5e7eb;">
            <button onclick="document.getElementById('pendingDetailsModal').style.display='none'" style="background: #fff; border: 1px solid #d1d5db; padding: 6px 15px; border-radius: 6px; color: #374151; font-weight: bold; cursor: pointer;">إغلاق</button>
        </div>
    </div>
</div>
                  </body>
                  </html>
                  `;

                  // Trigger print
                  document.body.classList.add('print-invoice'); // Add class for print styling
                  const printWindow = window.open('', '_blank');
                  if (printWindow) {
                      printWindow.document.open();
                      printWindow.document.write(printHTML);
                      printWindow.document.close();
                      setTimeout(() => { // Timeout allows content to render before print dialog
                          try {
                              printWindow.focus();
                              printWindow.print();
                              // printWindow.close(); // Optional: Close after printing attempt
                          } catch (e) {
                              console.error("Print error:", e);
                              alert("حدث خطأ أثناء محاولة الطباعة.");
                          } finally {
                              document.body.classList.remove('print-invoice'); // Remove class after printing attempt
                          }
                      }, 500);
                  } else {
                      alert('فشل فتح نافذة الطباعة. يرجى السماح بالنوافذ المنبثقة.');
                      document.body.classList.remove('print-invoice');
                  }
             }

         // نقوم بتعريف الدالة وربطها بـ window مباشرة لضمان وصول الـ HTML إليها
window.inv_calculateTotals = function() {
    let goodsTotal = 0;
    
    // حساب إجمالي البضائع من الجدول
    const tbody = document.getElementById('inv_invoiceItemsBody');
    if (tbody) {
        tbody.querySelectorAll('.invoice-item-row').forEach(row => {
            goodsTotal += parseFloat(row.dataset.itemSubtotal || 0);
        });
    }

    // جلب تكلفة الشحن
    const shippingInput = document.getElementById('inv_shippingCost');
    const shippingCost = shippingInput ? (parseFloat(shippingInput.value) || 0) : 0;
    
    // الإجمالي الكلي للفاتورة
    const grandTotal = goodsTotal + shippingCost;

    // --- منطق الدين الجزئي الجديد ---
    const paidInput = document.getElementById('inv_paidAmount');
    const remainingDebtDisplay = document.getElementById('inv_remainingDebt');
    
    if (paidInput && remainingDebtDisplay) {
        let paidAmount = parseFloat(paidInput.value) || 0;
        
        // حساب الدين (الإجمالي - المدفوع)
        let debt = grandTotal - paidAmount;
        if (debt < 0) debt = 0;

        // تحديث عرض الدين المتبقي
        remainingDebtDisplay.textContent = formatCurrency(debt);
        
        // إظهار أو إخفاء حقل التنبيه بالدين
        if (debt > 0) {
            remainingDebtDisplay.parentElement.parentElement.classList.remove('hidden');
        } else {
            remainingDebtDisplay.parentElement.parentElement.classList.add('hidden');
        }
    }

    // تحديث الأرقام في أسفل الفاتورة (الأسبان)
    const totalGoodsSpan = document.getElementById('inv_totalGoodsPrice');
    const totalShippingSpan = document.getElementById('inv_totalShippingCost');
    const grandTotalSpan = document.getElementById('inv_grandTotalPrice');

    if (totalGoodsSpan) totalGoodsSpan.textContent = formatCurrency(goodsTotal);
    if (totalShippingSpan) totalShippingSpan.textContent = formatCurrency(shippingCost);
    if (grandTotalSpan) grandTotalSpan.textContent = formatCurrency(grandTotal);
};

         function inv_updateDeductibleCostsCheckboxes() {
    if (!inv_deductibleCostsContainer) return;
    inv_deductibleCostsContainer.innerHTML = '';
    
    const itemsInInvoice = inv_invoiceItemsBody ? Array.from(inv_invoiceItemsBody.querySelectorAll('.invoice-item-row')).map(row => row.dataset.itemName.toLowerCase()) : [];
    
    // استبعاد المنتجات الموجودة في الفاتورة الحالية والمنتجات التي كميتها 0
    const availableForDeduction = products.filter(p =>
        !itemsInInvoice.includes(p.name.toLowerCase()) && (Number(p.quantity) || 0) > 0
    );

    if (availableForDeduction.length === 0) {
        inv_deductibleCostsContainer.innerHTML = '<p class="text-center text-sm" style="color:grey;">لا توجد منتجات أخرى متاحة لخصم تكلفتها.</p>';
        return;
    }

    availableForDeduction.sort((a, b) => a.name.localeCompare(b.name, 'ar')).forEach(product => {
        const qtyAvailable = Number(product.quantity) || 0;
        const cost = Number(product.costPrice) || 0;
        const uniqueId = `inv_deductcost_${generateId(product.name)}`;
        
        const label = document.createElement('label');
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.gap = '8px';
        label.style.marginBottom = '5px';
        label.style.cursor = 'pointer';
        label.htmlFor = uniqueId;
        
        // بناء HTML بشكل آمن يضمن وجود البيانات
        label.innerHTML = `
            <input type="checkbox" id="${uniqueId}" value="${product.name}" data-cost="${cost}" data-available="${qtyAvailable}">
            <span style="flex-grow: 1; font-size: 0.9em;">
                 ${product.name} <span class="text-gray-500 text-xs">(ت: ${formatCurrency(cost)} | م: ${qtyAvailable})</span>
            </span>
            <span style="flex-shrink: 0; font-size: 0.8em; color: #555;">خصم:</span>
            <input type="number" class="inv-deducted-item-quantity" min="1" max="${qtyAvailable}" value="1" style="width: 50px; text-align: center; flex-shrink: 0; border: 1px solid #ccc; border-radius: 4px; padding: 2px; font-size: 0.9em;" onclick="event.preventDefault()">
        `;
        
        inv_deductibleCostsContainer.appendChild(label);
    });
}
            // --- Manage Serials Modal Logic ---
            function openManageSerialsModal(productName) {
                currentManagingSerialsProduct = productName; // Store the product name being managed
                const product = products.find(p => p.name === productName);
                if (!product || !manageSerialsModal) {
                    showGlobalMessage(`خطأ: لم يتم العثور على المنتج "${productName}" لإدارة سيريالاته.`, true);
                    return;
                }

                // تحديث معلومات النافذة
                if (modal_productNameDisplay) modal_productNameDisplay.textContent = productName;
                const totalQty = Number(product.quantity) || 0;
                const registeredSerials = serialNumbersLog.filter(log => log.productName === productName);
                const registeredCount = registeredSerials.length;
                const unregisteredCount = totalQty - registeredCount;

                if (modal_totalQuantity) modal_totalQuantity.textContent = totalQty;
                if (modal_registeredCount) modal_registeredCount.textContent = registeredCount;
                if (modal_unregisteredCount) modal_unregisteredCount.textContent = unregisteredCount;
                if (modal_maxSerialsToAdd) modal_maxSerialsToAdd.textContent = unregisteredCount;

                // مسح حقل الإضافة ورسالة الاستيراد
                if (modal_productSerialNumbers) modal_productSerialNumbers.value = '';
                if (modal_serialImportMessage) showMessage(modal_serialImportMessage, '');

                // عرض السيريالات المسجلة حالياً
                if (modal_registeredSerialsList) {
                    if (registeredCount === 0) {
                        modal_registeredSerialsList.innerHTML = '<p class="text-center text-gray-500">لا توجد سيريالات مسجلة حالياً.</p>';
                    } else {
                        let listHtml = '<ul class="space-y-1">';
                        registeredSerials.sort((a,b) => a.serial.localeCompare(b.serial)).forEach(log => {
                             let statusColor = log.status === 'in_stock' ? 'text-green-600' : (log.status === 'sold' ? 'text-red-500' : 'text-gray-500');
                             let statusText = log.status === 'in_stock' ? 'متوفر' : (log.status === 'sold' ? 'مباع' : (log.status === 'in_invoice_temp' ? 'في فاتورة' : log.status));
                             listHtml += `<li class="text-sm flex justify-between items-center">
                                              <span class="font-mono"><strong>${log.serial}</strong></span>
                                              <span class="text-xs <span class="math-inline">\{statusColor\}"\>\[</span>{statusText}]</span>
                                           </li>`;
                        });
                        listHtml += '</ul>';
                        modal_registeredSerialsList.innerHTML = listHtml;
                    }
                }

                // إظهار النافذة
                manageSerialsModal.style.display = 'block';
            }

            function closeManageSerialsModal() {
                if (manageSerialsModal) {
                    manageSerialsModal.style.display = 'none';
                }
                currentManagingSerialsProduct = null; // Reset managed product name
            }

            function saveAddedSerialsFromModal() {
            saveStateToHistory();
                if (!currentManagingSerialsProduct || !modal_productSerialNumbers) return;

                const product = products.find(p => p.name === currentManagingSerialsProduct);
                if (!product) {
                    showMessage(d('modal-serial-import-message'), 'خطأ: المنتج لم يعد موجوداً.', true);
                    return;
                }

                const newSerialsInput = modal_productSerialNumbers.value.trim();
                if (!newSerialsInput) {
                    showMessage(d('modal-serial-import-message'), 'لم يتم إدخال أرقام تسلسلية جديدة.', false, true);
                    return; // لا يوجد شيء للحفظ
                }

                const totalQty = Number(product.quantity) || 0;
                const registeredCount = serialNumbersLog.filter(log => log.productName === currentManagingSerialsProduct).length;
                const unregisteredCount = totalQty - registeredCount;

                // فصل السيريالات المدخلة
                const cleanedInput = newSerialsInput.replace(/[,;\s\t]+/g, '\n');
                const newSerials = cleanedInput.split('\n').map(s => s.trim()).filter(s => s !== '');

                if (newSerials.length === 0) {
                     showMessage(d('modal-serial-import-message'), 'لم يتم إدخال أرقام تسلسلية صالحة.', true);
                     return;
                }

                if (newSerials.length > unregisteredCount) {
                     showMessage(d('modal-serial-import-message'), `لا يمكن إضافة ${newSerials.length} سيريال، العدد المتبقي غير المسجل هو ${unregisteredCount} فقط.`, true);
                     return;
                }

                // التحقق من التكرار
                const duplicateCheck = new Set();
                let error = false;
                for (const serial of newSerials) {
                     if (duplicateCheck.has(serial)) {
                         showMessage(d('modal-serial-import-message'), `الرقم التسلسلي "${serial}" مكرر في المدخلات.`, true);
                         error = true; break;
                     }
                     if (serialNumbersLog.some(log => log.serial === serial)) {
                         showMessage(d('modal-serial-import-message'), `الرقم التسلسلي "${serial}" مسجل بالفعل في النظام لمنتج آخر أو لهذا المنتج.`, true);
                         error = true; break;
                     }
                     duplicateCheck.add(serial);
                }
                if (error) return;

                // إضافة السيريالات الجديدة
                const timestamp = new Date().toISOString();
                const supplierId = product.supplierId || ""; // استخدم المورد المرتبط بالمنتج إن وجد
                newSerials.forEach(serial => {
                    serialNumbersLog.push({
                        serial: serial,
                        productName: currentManagingSerialsProduct,
                        supplierId: supplierId,
                        addedTimestamp: timestamp,
                        status: "in_stock"
                    });
                });

                logOperation("إدارة سيريالات", `تمت إضافة <span class="math-inline">\{newSerials\.length\} رقم تسلسلي للمنتج "</span>{currentManagingSerialsProduct}".`);
                showMessage(d('modal-serial-import-message'), `تم حفظ ${newSerials.length} رقم تسلسلي بنجاح.`, false);
                modal_productSerialNumbers.value = ''; // أفرغ الحقل بعد الحفظ
                // أعد تحديث قائمة السيريالات المسجلة داخل الـ modal وأرقام العد
                const updatedRegisteredSerials = serialNumbersLog.filter(log => log.productName === currentManagingSerialsProduct);
                const updatedRegisteredCount = updatedRegisteredSerials.length;
                const updatedUnregisteredCount = totalQty - updatedRegisteredCount;

                if (modal_registeredCount) modal_registeredCount.textContent = updatedRegisteredCount;
                if (modal_unregisteredCount) modal_unregisteredCount.textContent = updatedUnregisteredCount;
                if (modal_maxSerialsToAdd) modal_maxSerialsToAdd.textContent = updatedUnregisteredCount;

                 if (modal_registeredSerialsList) {
                     if (updatedRegisteredCount === 0) {
                          modal_registeredSerialsList.innerHTML = '<p class="text-center text-gray-500">لا توجد سيريالات مسجلة حالياً.</p>';
                     } else {
                          let listHtml = '<ul class="space-y-1">';
                          updatedRegisteredSerials.sort((a,b) => a.serial.localeCompare(b.serial)).forEach(log => {
                              let statusColor = log.status === 'in_stock' ? 'text-green-600' : (log.status === 'sold' ? 'text-red-500' : 'text-gray-500');
                              let statusText = log.status === 'in_stock' ? 'متوفر' : (log.status === 'sold' ? 'مباع' : (log.status === 'in_invoice_temp' ? 'في فاتورة' : log.status));
                              listHtml += `<li class="text-sm flex justify-between items-center">
                                               <span class="font-mono"><strong>${log.serial}</strong></span>
                                               <span class="text-xs <span class="math-inline">\{statusColor\}"\>\[</span>{statusText}]</span>
                                             </li>`;
                          });
                          listHtml += '</ul>';
                          modal_registeredSerialsList.innerHTML = listHtml;
                     }
                 }

                updateUI(); // تحديث الواجهة الرئيسية لعكس التغييرات (مثل عدد السيريالات المتوفرة)
            }


            // --- المقاصة، تقرير المبيعات، تأكيد/إلغاء المؤقت، البحث ---
            function performTwoPartyOffset() {
                if (!offsetDebtorNameInput || !offsetCreditorNameInput || !offsetAmountInput || !offsetMessage) return;
                const debtorName = offsetDebtorNameInput.value.trim();
                const creditorName = offsetCreditorNameInput.value.trim();
                const offsetAmount = parseInputNumber(offsetAmountInput);

                if (!debtorName || !creditorName || isNaN(offsetAmount) || offsetAmount <= 0) {
                    showMessage(offsetMessage, "يرجى إدخال اسم المدين والدائن ومبلغ مقاصة صحيح (> 0).", true);
                    return;
                }
                 if (debtorName === creditorName) {
                    showMessage(offsetMessage, "لا يمكن إجراء مقاصة لنفس الشخص (المدين هو الدائن).", true);
                    return;
                 }

                // Find total debt for the debtor
                const debtorTotal = debtors
                    .filter(d => d.name === debtorName)
                    .reduce((sum, d) => sum + (Number(d.amount) || 0), 0);

                // Find total liability for the creditor
                const creditorTotal = liabilities
                    .filter(l => l.name === creditorName)
                    .reduce((sum, l) => sum + (Number(l.amount) || 0), 0);

                if (debtorTotal < offsetAmount - 0.001) { // Use tolerance
                    showMessage(offsetMessage, `مبلغ المقاصة (<span class="math-inline">\{formatCurrency\(offsetAmount\)\}\) أكبر من إجمالي دين المدين "</span>{debtorName}" (${formatCurrency(debtorTotal)}).`, true);
                    return;
                }
                if (creditorTotal < offsetAmount - 0.001) { // Use tolerance
                    showMessage(offsetMessage, `مبلغ المقاصة (<span class="math-inline">\{formatCurrency\(offsetAmount\)\}\) أكبر من إجمالي التزام الدائن "</span>{creditorName}" (${formatCurrency(creditorTotal)}).`, true);
                    return;
                }

                // --- Apply Offset ---
                // Reduce Debtor's Debt
                let remainingOffsetForDebtor = offsetAmount;
                debtors = debtors.map(debt => {
                    if (debt.name === debtorName && remainingOffsetForDebtor > 0 && (Number(debt.amount) || 0) > 0.001) {
                        const deduction = Math.min(Number(debt.amount) || 0, remainingOffsetForDebtor);
                        debt.amount = (Number(debt.amount) || 0) - deduction;
                        remainingOffsetForDebtor -= deduction;
                    }
                    return debt;
                }).filter(debt => (Number(debt.amount) || 0) > 0.001); // Remove zeroed debts

                // Reduce Creditor's Liability
                let remainingOffsetForCreditor = offsetAmount;
                 liabilities = liabilities.map(liability => {
                    if (liability.name === creditorName && remainingOffsetForCreditor > 0 && (Number(liability.amount) || 0) > 0.001) {
                        const deduction = Math.min(Number(liability.amount) || 0, remainingOffsetForCreditor);
                        liability.amount = (Number(liability.amount) || 0) - deduction;
                        remainingOffsetForCreditor -= deduction;
                    }
                    return liability;
                }).filter(liability => (Number(liability.amount) || 0) > 0.001); // Remove zeroed liabilities


                logOperation("مقاصة", `تنفيذ مقاصة بمبلغ <span class="math-inline">\{formatCurrency\(offsetAmount\)\} بين المدين "</span>{debtorName}" والدائن "${creditorName}".`);
                showMessage(offsetMessage, `تم تنفيذ المقاصة بنجاح بمبلغ ${formatCurrency(offsetAmount)}.`, false);

                // Clear inputs
                offsetDebtorNameInput.value = '';
                offsetCreditorNameInput.value = '';
                offsetAmountInput.value = '';

                updateUI();
            }

       
// salesToDisplay: هي مصفوفة المبيعات التي سيتم عرضها
function displaySalesReport(salesToDisplay) {
    if (!salesReportTableBody || !reportTotalSales || !reportTotalCost || !reportTotalProfit) return;

    // تصفية البيانات
    const searchTerm = reportSearchInput ? reportSearchInput.value.trim().toLowerCase() : "";
    const filteredSales = !searchTerm ? salesToDisplay : salesToDisplay.filter(sale => {
        const customerMatch = (sale.customerName || '').toLowerCase().includes(searchTerm);
        const invoiceNumberMatch = (sale.invoiceNumber || '').toLowerCase().includes(searchTerm);
        const itemMatch = (sale.items || []).some(item =>
            (item.name || '').toLowerCase().includes(searchTerm)
        );
        return customerMatch || itemMatch || invoiceNumberMatch;
    });

    let totalMonthSales = 0, totalMonthCost = 0, totalMonthProfit = 0;
    let tableHTML = '';

    if (filteredSales.length === 0) {
        tableHTML = `<tr><td colspan="7" class="text-center text-gray-500 py-8 font-medium">لا توجد بيانات للعرض.</td></tr>`;
    } else {
        filteredSales.forEach(sale => {
            const saleDateDisplay = formatDateForDisplay(sale.saleDate);
            const timeDisplay = sale.timestamp ? new Date(sale.timestamp).toLocaleTimeString('ar-EG', {hour: '2-digit', minute:'2-digit'}) : '';
            const customer = sale.customerName || '<span class="text-gray-400">نقدي</span>';
            
            // تنسيق البنود بشكل أنيق
            let itemsDesc = (sale.items || []).map(item => `
                <div style="font-size: 0.85rem; margin-bottom: 2px;">
                    <span style="font-weight:bold; color:#334155;">${item.quantity}x</span> ${item.name}
                    ${item.serial ? `<span style="font-size:0.7rem; color:#64748b; background:#f1f5f9; padding:0 4px; border-radius:4px;">${item.serial}</span>` : ''}
                </div>
            `).join('');

            const saleAmount = Number(sale.grandTotal ?? sale.totalSellPrice) || 0;
            const costAmount = Number(sale.totalCost) || 0;
            const profitAmount = Number(sale.profit) || 0;

            totalMonthSales += saleAmount;
            totalMonthCost += costAmount;
            totalMonthProfit += profitAmount;

            // تحديد نوع البادج (Badge)
            let badgeClass = 'badge-invoice';
            let typeName = 'فاتورة';
            if (sale.type === 'quick') { badgeClass = 'badge-quick'; typeName = 'سريع'; }
            else if (sale.type === 'invoice-from-pending') { badgeClass = 'badge-pending'; typeName = 'مؤكدة'; }

            // لون الربح
            const profitColor = profitAmount >= 0 ? '#16a34a' : '#dc2626';

            tableHTML += `
                <tr>
                    <td>
                        <div style="font-weight:bold; color:#334155;">${saleDateDisplay}</div>
                        <div style="font-size:0.75rem; color:#94a3b8;">${timeDisplay}</div>
                        ${sale.invoiceNumber ? `<div style="font-size:0.7rem; color:#6366f1; margin-top:2px;">#${sale.invoiceNumber}</div>` : ''}
                    </td>
                    <td style="font-weight:500;">${customer}</td>
                    <td>${itemsDesc}</td>
                    <td class="text-center" style="font-family:monospace; font-weight:bold; font-size:1rem;">${formatCurrency(saleAmount)}</td>
                    <td class="text-center" style="font-family:monospace; color:#64748b;">${formatCurrency(costAmount)}</td>
                    <td class="text-center" style="font-family:monospace; font-weight:bold; color:${profitColor};">${formatCurrency(profitAmount)}</td>
                    <td class="text-center">
                        <span class="badge ${badgeClass}">${typeName}</span>
                    </td>
                </tr>
            `;
        });
    }

    salesReportTableBody.innerHTML = tableHTML;
    
    // تحديث بطاقات الملخص بالأعلى
    reportTotalSales.textContent = formatCurrency(totalMonthSales);
    reportTotalCost.textContent = formatCurrency(totalMonthCost);
    reportTotalProfit.textContent = formatCurrency(totalMonthProfit);
    
    // تغيير لون بطاقة الربح حسب النتيجة
    const profitCardValue = document.querySelector('.stat-profit .stat-value');
    if(profitCardValue) profitCardValue.style.color = totalMonthProfit >= 0 ? '#047857' : '#dc2626';
}

// =======================================================
async function performDirectSearch() {
    if (!reportMonthYearInput || !reportMessage || !reportSearchInput || !window.currentUser) return;

    const yearMonth = reportMonthYearInput.value;
    const searchTerm = reportSearchInput.value.trim().toLowerCase();

    if (!yearMonth) {
        showMessage(reportMessage, "يرجى اختيار الشهر للبحث فيه.", true); return;
    }
    if (!searchTerm) {
        showMessage(reportMessage, "يرجى كتابة ما تريد البحث عنه أولاً.", true); return;
    }

    showMessage(reportMessage, `جاري البحث المباشر عن "${searchTerm}" في شهر ${yearMonth}...`, false, true);
    displaySalesReport([]); // عرض جدول فارغ مبدئيًا

    try {
        // بما أن جلب كل بيانات الشهر أصبح سريعًا، سنقوم بجلبها كلها ثم التصفية محليًا
        // هذا أسرع وأكثر مرونة من عمل استعلامات معقدة
        const userId = window.currentUser.uid;
        const [year, month] = yearMonth.split('-');
        
        const startDate = `${yearMonth}-01`;
        const endDate = new Date(year, month, 0).toISOString().split('T')[0];

        const invoicesColRef = window.collection(window.db, "users", userId, "invoices");
        const q = window.query(invoicesColRef, 
            window.where("saleDate", ">=", startDate), 
            window.where("saleDate", "<=", endDate)
        );

        const querySnapshot = await window.getDocs(q);
        
        let allMonthSales = [];
        querySnapshot.forEach((doc) => {
            allMonthSales.push(doc.data());
        });

        // الآن نقوم بالتصفية على البيانات التي تم جلبها بسرعة
        const matchedSales = allMonthSales.filter(sale => {
            const customerMatch = (sale.customerName || '').toLowerCase().includes(searchTerm);
            const invoiceNumberMatch = (sale.invoiceNumber || '').toLowerCase().includes(searchTerm);
            const itemMatch = (sale.items || []).some(item => (item.name || '').toLowerCase().includes(searchTerm));
            return customerMatch || itemMatch || invoiceNumberMatch;
        });

        if (matchedSales.length === 0) {
            showMessage(reportMessage, `لم يتم العثور على نتائج للبحث المباشر.`, false, true);
            return;
        }

        matchedSales.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
        
        currentMonthlySalesData = matchedSales; // نخزن نتائج البحث فقط
        displaySalesReport(currentMonthlySalesData);
        
        showMessage(reportMessage, `تم العثور على ${matchedSales.length} نتيجة للبحث المباشر.`, false);

    } catch (error) {
        console.error("Error during direct search: ", error);
        showMessage(reportMessage, "حدث خطأ أثناء البحث. راجع الـ Console.", true);
    }
}
// =======================================================
// START: دالة تحليل المصروفات (النسخة النهائية الآمنة)
// =======================================================
function parseAmountFromLogDetails(details) {
    // ★★★ السطر الجديد المضاف للإصلاح ★★★
    // يتحقق أولاً إذا كانت التفاصيل موجودة وهي نص قبل المتابعة
    if (typeof details !== 'string') return 0;

    // تبحث عن أي نمط مثل "بقيمة 100.50 جنيه" أو "سحب 50" أو "خصم 200"
    const match = details.match(/(?:بقيمة|سحب|خصم|مبلغ|بدفع)\s*([\d\.,]+)/);
    if (match && match[1]) {
        // تنظيف الرقم من الفواصل وتحويله
        return parseFloat(match[1].replace(/,/g, ''));
    }
    return 0; // إذا لم تجد مبلغًا، ترجع صفرًا
}
async function generateExpensesReport() {
    const monthInput = document.getElementById('exp-report-month-year');
    const messageEl = document.getElementById('exp-report-message');
    const tableBody = document.getElementById('expenses-report-table-body');
    const summaryContainer = document.getElementById('exp-report-summary-container');
    const summaryTotalEl = document.getElementById('exp-report-summary-total');

    if (!monthInput || !messageEl || !tableBody || !summaryTotalEl || !summaryContainer) return;

    const yearMonth = monthInput.value; // مثال: "2026-01"
    if (!yearMonth) {
        showMessage(messageEl, "يرجى اختيار الشهر والسنة.", true);
        return;
    }

    showMessage(messageEl, `جاري جلب وتحليل المصروفات (دمج سحابي + محلي)...`, false, true);
    
    summaryContainer.classList.add('hidden');
    tableBody.innerHTML = `<tr><td colspan="4" class="text-center text-gray-500 py-4"><i class="fas fa-spinner fa-spin"></i> جاري معالجة البيانات...</td></tr>`;

    // دالة استخراج الأرقام (نفسها)
    const extractAmountFromText = (text) => {
        if (!text || typeof text !== 'string') return 0;
        let cleanText = text.replace('جنيه', '').replace('EGP', '');
        const regex = /(?:بقيمة|سحب|خصم|مبلغ|بدفع|دفع)\s*([\d,]+(?:\.\d+)?)/;
        const match = cleanText.match(regex);
        if (match && match[1]) return parseFloat(match[1].replace(/,/g, ''));
        const startNumberMatch = cleanText.match(/^([\d,]+(?:\.\d+)?)/);
        if (startNumberMatch && startNumberMatch[1]) return parseFloat(startNumberMatch[1].replace(/,/g, ''));
        return 0;
    };

    let allDaysData = [];
    let isOffline = false;

    try {
        const userId = window.currentUser ? window.currentUser.uid : null;
        
        // 1. جلب البيانات من السحابة (Cloud)
        if (userId) {
            try {
                // توليد تواريخ الشهر
                const [y, m] = yearMonth.split('-');
                const date = new Date(y, m - 1, 1);
                const dates = [];
                while (date.getMonth() === m - 1) {
                    dates.push(new Date(date).toISOString().split('T')[0]);
                    date.setDate(date.getDate() + 1);
                }

                const promises = dates.map(dateStr => 
                    window.getDoc(window.doc(window.db, "users", userId, "days", dateStr))
                    .then(snap => snap.exists() ? { date: snap.id, ...snap.data() } : null)
                    .catch(() => null)
                );
                
                const snapshots = await Promise.all(promises);
                allDaysData = snapshots.filter(d => d !== null);

            } catch (cloudError) {
                console.warn("فشل الاتصال بالسحابة للمصروفات:", cloudError);
                isOffline = true;
            }
        }

        // 2. الحقن المحلي الذكي (Local Injection)
        // هنا التعديل: نتأكد أن التاريخ المحلي يطابق الشهر المختار
        if (typeof currentLoadedDate !== 'undefined' && currentLoadedDate) {
            // هل التاريخ المحلي يقع في الشهر الذي نبحث عنه؟
            if (currentLoadedDate.startsWith(yearMonth)) {
                const cloudDayIndex = allDaysData.findIndex(d => d.date === currentLoadedDate);
                
                // استخدام السجل المحلي الحقيقي الموجود في الذاكرة الآن
                const localDayData = {
                    date: currentLoadedDate,
                    log: typeof operationLog !== 'undefined' ? operationLog : []
                };

                if (cloudDayIndex !== -1) {
                    // استبدال نسخة السحابة القديمة بالنسخة المحلية الحية
                    allDaysData[cloudDayIndex] = localDayData;
                } else {
                    // إضافة اليوم الجديد
                    allDaysData.push(localDayData);
                }
            }
        }
        
        // 3. الفلترة الصارمة (Strict Filtering)
        // التأكد من أننا نعرض فقط المصروفات التي تخص الشهر المحدد
        let allExpenses = [];
        
        allDaysData.forEach(dayData => {
            // تحقق إضافي: هل تاريخ الملف يطابق الشهر؟
            if (!dayData.date.startsWith(yearMonth)) return;

            if (dayData.log && Array.isArray(dayData.log)) {
                dayData.log.forEach(logEntry => {
                    // --- 🔴 الفلتر الزمني الدقيق ---
                    // بعض السجلات القديمة قد تكون مرحلة بالخطأ، لذا نتأكد من تاريخ السجل نفسه إن وجد
                    // أو نعتمد على تاريخ الملف (dayData.date) وهو الأضمن هنا
                    const entryDate = dayData.date; // نعتمد تاريخ الملف الحاوي

                    const type = logEntry.type || "";
                    const details = logEntry.details || "";

                    const isExpense = 
                        type.includes("مصروف") || 
                        type.includes("سحب") || 
                        details.includes("مصروف") || 
                        details.includes("سحب") ||
                        details.includes("فاتورة شراء");

                    const isRefund = type.includes("add") || details.includes("استرداد") || details.includes("إلغاء") || type.includes("ترحيل");

                    if (isExpense && !isRefund) {
                        const amount = extractAmountFromText(details);
                        if (amount > 0) {
                            allExpenses.push({
                                date: entryDate,
                                timestamp: logEntry.timestamp || entryDate,
                                type: type,
                                details: details,
                                amount: amount
                            });
                        }
                    }
                });
            }
        });

        // 4. العرض
        tableBody.innerHTML = '';
        
        if (allExpenses.length === 0) {
            showMessage(messageEl, `لا توجد مصروفات مسجلة لشهر ${yearMonth}.`, false, true);
            tableBody.innerHTML = `<tr><td colspan="4" class="text-center text-gray-500 py-4">لا توجد نتائج.</td></tr>`;
            summaryTotalEl.textContent = "0.00 جنيه";
            summaryContainer.classList.remove('hidden');
            return;
        }

        allExpenses.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

        let totalAmount = 0;
        allExpenses.forEach(exp => {
            totalAmount += exp.amount;
            const row = tableBody.insertRow();
            row.className = 'expense-row border-b hover:bg-gray-50 transition-colors';
            
            let timeStr = "";
            try {
                timeStr = new Date(exp.timestamp).toLocaleTimeString('ar-EG', {hour: '2-digit', minute:'2-digit'});
            } catch(e){}

            row.innerHTML = `
                <td class="p-3 text-sm">
                    <div class="font-bold text-gray-700">${formatDateForDisplay(exp.date)}</div>
                    <div class="text-xs text-gray-400">${timeStr}</div>
                </td>
                <td class="p-3 text-sm font-semibold text-blue-800">${exp.type}</td>
                <td class="p-3 text-sm text-gray-600">${exp.details}</td>
                <td class="p-3 text-sm text-center font-mono font-bold text-red-600">-${formatCurrency(exp.amount)}</td>
            `;
        });

        summaryTotalEl.textContent = formatCurrency(totalAmount);
        summaryContainer.classList.remove('hidden');
        
        showMessage(messageEl, `تم عرض ${allExpenses.length} عملية مصروف لشهر ${yearMonth}.`, false);

    } catch (error) {
        console.error("Expenses Report Error:", error);
        showMessage(messageEl, "حدث خطأ غير متوقع أثناء بناء التقرير.", true);
    }
}

async function generateMonthlySalesReport() {
    const monthInput = document.getElementById('report-month-year');
    const msgEl = document.getElementById('report-message');
    
    // التحقق من العناصر والمستخدم
    if (!monthInput || !msgEl) return;
    if (!window.currentUser) {
        showMessage(msgEl, "يجب تسجيل الدخول أولاً.", true);
        return;
    }
    
    const yearMonth = monthInput.value;
    if (!yearMonth) {
        showMessage(msgEl, "يرجى اختيار الشهر والسنة.", true); return;
    }

    showMessage(msgEl, `جاري جلب البيانات (مع تصفية التراجعات)...`, false, true);
    
    if(typeof displaySalesReport === 'function') displaySalesReport([]); 

    const userId = window.currentUser.uid;
    const [year, month] = yearMonth.split('-');
    const startDate = `${yearMonth}-01`;
    const endDate = new Date(year, month, 0).toISOString().split('T')[0];

    // خريطة لتجميع الفواتير
    const salesMap = new Map();

    // =========================================================
    // الخطوة 1: جلب بيانات السحابة
    // =========================================================
    try {
        const invoicesColRef = window.collection(window.db, "users", userId, "invoices");
        const q = window.query(invoicesColRef, 
            window.where("saleDate", ">=", startDate), 
            window.where("saleDate", "<=", endDate)
        );
        
        const querySnapshot = await window.getDocs(q);
        querySnapshot.forEach((doc) => {
            salesMap.set(doc.id, doc.data());
        });
        console.log(`تم جلب ${querySnapshot.size} فاتورة من السحابة.`);
        
    } catch (cloudError) {
        console.warn("فشل الاتصال بالسحابة:", cloudError);
        showMessage(msgEl, "تنبيه: فشل جلب بيانات السحابة. جاري عرض البيانات المحلية.", true, true);
    }

    // =========================================================
    // 🔥 الخطوة 2 (الجديدة): تنقية البيانات بناءً على الواقع المحلي (Smart Filter)
    // هذا يمنع ظهور الفواتير التي قمت بعمل (Undo) لها
    // =========================================================
    if (typeof currentLoadedDate !== 'undefined' && currentLoadedDate && typeof salesToday !== 'undefined') {
        for (const [id, cloudSale] of salesMap.entries()) {
            const sDate = cloudSale.saleDate || (cloudSale.timestamp ? cloudSale.timestamp.split('T')[0] : '');
            
            // إذا كانت الفاتورة بتاريخ "اليوم المفتوح حالياً"
            if (sDate === currentLoadedDate) {
                // يجب أن تكون موجودة في الذاكرة المحلية أيضاً
                const existsLocally = salesToday.some(local => local.id === id);
                
                // إذا كانت في السحابة لكن اختفت محلياً (بسبب Undo)، نحذفها من التقرير
                if (!existsLocally) {
                    salesMap.delete(id);
                }
            }
        }
    }

    // =========================================================
    // الخطوة 3: دمج البيانات المحلية الجديدة (لتظهر الفواتير الجديدة فوراً)
    // =========================================================
    let localCount = 0;
    if (typeof salesToday !== 'undefined' && Array.isArray(salesToday)) {
        salesToday.forEach(localSale => {
            const sDate = localSale.saleDate || (localSale.timestamp ? localSale.timestamp.split('T')[0] : '');
            if (sDate >= startDate && sDate <= endDate) {
                salesMap.set(localSale.id, localSale);
                localCount++;
            }
        });
    }

    // =========================================================
    // الخطوة 4: الترتيب والعرض
    // =========================================================
    let finalSalesList = Array.from(salesMap.values());

    finalSalesList.sort((a, b) => new Date(b.timestamp || b.saleDate) - new Date(a.timestamp || a.saleDate));
    
    currentMonthlySalesData = finalSalesList;
    
    if(typeof displaySalesReport === 'function') displaySalesReport(finalSalesList);

    if (finalSalesList.length === 0) {
        showMessage(msgEl, `لا توجد مبيعات مسجلة لشهر ${yearMonth}.`, false, true);
    } else {
        showMessage(msgEl, `تم عرض ${finalSalesList.length} فاتورة.`, false);
    }
}


// دالة البحث المباشر (الطريقة الثانية) - نسخة محدثة
// =======================================================
// START: دالة البحث المباشر (النسخة النهائية فائقة السرعة)
// =======================================================
async function performDirectSearch() {
    if (!reportMonthYearInput || !reportMessage || !reportSearchInput || !window.currentUser) return;

    const yearMonth = reportMonthYearInput.value;
    const searchTerm = reportSearchInput.value.trim().toLowerCase();

    if (!yearMonth) {
        showMessage(reportMessage, "يرجى اختيار الشهر للبحث فيه.", true); return;
    }
    if (!searchTerm) {
        showMessage(reportMessage, "يرجى كتابة ما تريد البحث عنه أولاً.", true); return;
    }

    showMessage(reportMessage, `جاري البحث المباشر عن "${searchTerm}" في شهر ${yearMonth}...`, false, true);
    displaySalesReport([]); // عرض جدول فارغ مبدئيًا

    try {
        // بما أن جلب كل بيانات الشهر أصبح سريعًا، سنقوم بجلبها كلها ثم التصفية محليًا
        // هذا أسرع وأكثر مرونة من عمل استعلامات معقدة
        const userId = window.currentUser.uid;
        const [year, month] = yearMonth.split('-');
        
        const startDate = `${yearMonth}-01`;
        const endDate = new Date(year, month, 0).toISOString().split('T')[0];

        const invoicesColRef = window.collection(window.db, "users", userId, "invoices");
        const q = window.query(invoicesColRef, 
            window.where("saleDate", ">=", startDate), 
            window.where("saleDate", "<=", endDate)
        );

        const querySnapshot = await window.getDocs(q);
        
        let allMonthSales = [];
        querySnapshot.forEach((doc) => {
            allMonthSales.push(doc.data());
        });

        // الآن نقوم بالتصفية على البيانات التي تم جلبها بسرعة
        const matchedSales = allMonthSales.filter(sale => {
            const customerMatch = (sale.customerName || '').toLowerCase().includes(searchTerm);
            const invoiceNumberMatch = (sale.invoiceNumber || '').toLowerCase().includes(searchTerm);
            const itemMatch = (sale.items || []).some(item => (item.name || '').toLowerCase().includes(searchTerm));
            return customerMatch || itemMatch || invoiceNumberMatch;
        });

        if (matchedSales.length === 0) {
            showMessage(reportMessage, `لم يتم العثور على نتائج للبحث المباشر.`, false, true);
            return;
        }

        matchedSales.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
        
        currentMonthlySalesData = matchedSales; // نخزن نتائج البحث فقط
        displaySalesReport(currentMonthlySalesData);
        
        showMessage(reportMessage, `تم العثور على ${matchedSales.length} نتيجة للبحث المباشر.`, false);

    } catch (error) {
        console.error("Error during direct search: ", error);
        showMessage(reportMessage, "حدث خطأ أثناء البحث. راجع الـ Console.", true);
    }
}

// --- >>> START: انسخ هذا الكود بالكامل والصقه مكان دالة handlePendingSaleActions القديمة <<< ---
async function handlePendingSaleActions(event) {
    const button = event.target.closest('button');
    if (!button) return;

    const pendingId = button.dataset.pendingId;
    if (!pendingId) return;

    // --- زر تحويل البيع المؤقت إلى مرتجع ---
    if (button.classList.contains('initiate-return-from-pending')) {
        initiateReturnFromPendingSale(pendingId);
        return;
    }

    const saleIndex = pendingSales.findIndex(s => s.id === pendingId);
    if (saleIndex === -1) {
        showGlobalMessage("خطأ: لم يتم العثور على البيع المؤقت.", true);
        return;
    }
    
    const sale = { ...pendingSales[saleIndex] }; // اعمل نسخة من البيانات

    // --- زر تأكيد البيع المؤقت (وفتح الفاتورة) ---
    if (button.classList.contains('confirm-pending')) {
        if (confirm(`سيتم الآن فتح نافذة الفاتورة لتأكيد هذه العملية واختيار حساب الإيداع. هل تريد المتابعة؟`)) {
            isInvoiceFromPending = true;
            pendingSaleOriginData = sale; 
            inv_openModal(); // فتح النافذة وإعادة تعيينها

            // ملء بيانات العميل
            if(inv_customerNameInput) inv_customerNameInput.value = sale.customerName || '';
            if (sale.invoiceData) { // إذا كان البيع المؤقت من فاتورة مفصلة أصلاً
                if(inv_customerAddressInput) inv_customerAddressInput.value = sale.invoiceData.customerAddress || '';
                // (ملء باقي البيانات مثل الهاتف والملاحظات والشحن)
                if(inv_warrantyInput && sale.invoiceData.warranty) inv_warrantyInput.value = sale.invoiceData.warranty;
                if(inv_notesTextarea && sale.invoiceData.notes) inv_notesTextarea.value = sale.invoiceData.notes;
                if(inv_shippingCostInput) inv_shippingCostInput.value = sale.invoiceData.shippingCost || 0;
            }
            
            // ملء بنود الفاتورة
            if (inv_invoiceItemsBody) {
                inv_invoiceItemsBody.innerHTML = ''; // أفرغ البنود القديمة
                if (sale.items) {
                    // الحالة 1: فاتورة مفصلة
                    sale.items.forEach(item => {
                        if (item) {
                            // نستدعي دالة inv_addInvoiceItem بشكل غير مباشر (بملء الحقول والضغط)
                            // أو (الأفضل) نملأ الجدول مباشرة
                            const subtotal = item.quantity * item.unitPrice;
                            const newRow = document.createElement('tr');
                            newRow.classList.add('invoice-item-row');
                            newRow.dataset.itemName = item.name;
                            newRow.dataset.itemQty = item.quantity;
                            newRow.dataset.itemPrice = (item.unitPrice || 0).toFixed(2);
                            newRow.dataset.itemSubtotal = (subtotal || 0).toFixed(2);
                            newRow.dataset.itemCost = (item.costPrice || 0).toFixed(2);
                            newRow.dataset.itemSerial = item.serial || null; // احتفظ بالسيريال إذا كان موجودًا
                            newRow.innerHTML = `
                                <td class="item-name">
                                    ${item.name}
                                    ${item.serial ? `<span class="serial-display no-print">(S/N: ${item.serial})</span><span class="serial-display-print">(S/N: ${item.serial})</span>` : ''}
                                </td>
                                <td class="item-qty">${item.quantity}</td>
                                <td class="item-price">${formatCurrency(item.unitPrice)}</td>
                                <td class="item-subtotal">${formatCurrency(subtotal)}</td>
                                <td class="no-print"><button type="button" class="remove-item-btn" title="حذف البند">×</button></td>
                            `;
                            inv_invoiceItemsBody.appendChild(newRow);
                        }
                    });
                } else if (sale.mainProduct) {
                    // الحالة 2: بيع سريع (ادمجه في بند واحد)
                    let description = `${sale.mainProduct.quantity}x ${sale.mainProduct.name}`;
                    if (sale.additionalItems && sale.additionalItems.length > 0) {
                        const additionalDesc = sale.additionalItems.map(item => `${item.quantity}x ${item.name}`).join('، ');
                        description += ` (مع: ${additionalDesc})`;
                    }
                    const mainCost = (sale.mainProduct.costPrice || 0) * sale.mainProduct.quantity;
                    const addCost = (sale.additionalItems || []).reduce((sum, i) => sum + (i.costPrice || 0) * i.quantity, 0);
                    const subtotal = sale.totalSellPrice;
                    const newRow = document.createElement('tr');
                    newRow.classList.add('invoice-item-row');
                    newRow.dataset.itemName = description;
                    newRow.dataset.itemQty = 1;
                    newRow.dataset.itemPrice = sale.totalSellPrice.toFixed(2);
                    newRow.dataset.itemSubtotal = subtotal.toFixed(2);
                    newRow.dataset.itemCost = (mainCost + addCost).toFixed(2);
                    newRow.innerHTML = `
                        <td class="item-name">${description}</td>
                        <td class="item-qty">1</td>
                        <td class="item-price">${formatCurrency(sale.totalSellPrice)}</td>
                        <td class="item-subtotal">${formatCurrency(subtotal)}</td>
                        <td class="no-print"><button type="button" class="remove-item-btn" title="حذف البند">×</button></td>
                    `;
                    inv_invoiceItemsBody.appendChild(newRow);
                }
            }
            
            // حساب الإجماليات وتحديث الملحقات القابلة للخصم
            inv_calculateTotals();
            inv_updateDeductibleCostsCheckboxes(); // هذه الدالة ستعرض الملحقات المتاحة
            
            // لا تقم بحذف البيع المؤقت الآن، سيتم حذفه عند الحفظ النهائي
            // saveStateToHistory();
            // pendingSales.splice(saleIndex, 1);
            // updateUI();
        }

    // --- زر إلغاء البيع المؤقت ---
    } else if (button.classList.contains('cancel-pending')) {
        if (confirm(`هل أنت متأكد من إلغاء هذا البيع المؤقت وإرجاع البضاعة للمخزون؟`)) {
            saveStateToHistory();
            const saleCost = calculateSinglePendingSaleCost(sale);

            // <<< --- هذا هو السطر المعدل --- >>>
            // يجمع البنود الأساسية (items) والبنود المخصومة (deductedItems) معًا لإرجاعها
            let itemsToReturn = [];
            if (sale.items) {
                // فاتورة مفصلة: أرجع البنود الأساسية + البنود المخصومة
                itemsToReturn = (sale.items || []).concat(sale.deductedItems || sale.invoiceData?.deductedItems || []);
            } else if (sale.mainProduct) {
                // بيع سريع: أرجع المنتج الرئيسي + الملحقات
                itemsToReturn = [sale.mainProduct, ...(sale.additionalItems || [])];
            }
            // <<< --- نهاية السطر المعدل --- >>>
            
            itemsToReturn.forEach(item => {
                if(!item) return; // تجاهل أي عناصر فارغة
                const productIndex = products.findIndex(p => p.name === item.name);
                if (productIndex !== -1) {
                    products[productIndex].quantity += (Number(item.quantity) || 0);
                } else {
                    // إذا لم يكن المنتج موجودًا (ربما تم حذفه؟)، أعد إضافته
                    products.push({ 
                        name: item.name, 
                        quantity: (Number(item.quantity) || 0), 
                        costPrice: item.costPrice || 0, // استخدم التكلفة المسجلة
                        supplierId: item.supplierId || '',
                        isBundle: false, // افترض أنه ليس حزمة
                        components: []
                    });
                }
                // --- إرجاع حالة السيريال إلى 'in_stock' ---
                 if (item.serial) {
                     const serialIndex = serialNumbersLog.findIndex(log => log.serial === item.serial && log.status === 'pending_sale');
                     if (serialIndex !== -1) {
                         serialNumbersLog[serialIndex].status = 'in_stock';
                         console.log(`Serial ${item.serial} status reverted to 'in_stock'.`);
                     } else {
                         console.warn(`Could not find serial ${item.serial} with status 'pending_sale' to revert.`);
                     }
                 }
            });

            pendingSales.splice(saleIndex, 1); // احذف البيع المؤقت
            logOperation("إلغاء بيع مؤقت", `تم إلغاء بيع مؤقت. تم إرجاع بضاعة (تكلفة ${formatCurrency(saleCost)}) للمخزون.`);
            updateUI(); // حدث الواجهة
            showMessage(globalMessage, "تم إلغاء البيع المؤقت وإرجاع كل البضاعة للمخزون.", false, true);
        }
    // --- زر تعديل البيع المؤقت ---
    } else if (button.classList.contains('edit-pending')) {
        // (هذا المنطق خاص بالبيع السريع فقط، قد يحتاج لتعديل ليدعم الفواتير المفصلة)
        if (sale.mainProduct) {
            openPendingSaleForEdit(pendingId); 
        } else {
            alert("لا يمكن تعديل فاتورة مفصلة مؤقتة حاليًا. يرجى إلغاؤها وإنشاء واحدة جديدة أو تأكيدها.");
        }
    }
}
      function openPendingSaleForEdit(pendingId) {
    const sale = pendingSales.find(s => s.id === pendingId);
    if (!sale) {
        showGlobalMessage("لم يتم العثور على البيع المؤقت للتعديل.", true);
        return;
    }

    // --- حماية الفواتير المفصلة ---
    // إذا كان البيع عبارة عن فاتورة مفصلة (تحتوي على items ولا تحتوي على mainProduct)
    // نمنع تعديلها في نموذج البيع السريع لتجنب تدمير البيانات
    if (!sale.mainProduct && sale.items && sale.items.length > 0) {
        alert("تنبيه: هذه عملية 'فاتورة مفصلة'.\n\nلضمان دقة الحسابات والمخزون، لا يمكن تعديلها من هنا.\n\nالحل:\n1. اضغط على 'إلغاء/إرجاع' (سيقوم البرنامج بإرجاع البضاعة للمخزن).\n2. قم بإنشاء فاتورة جديدة بالتعديلات المطلوبة.");
        return;
    }

    // الانتقال للقسم
    const sellSection = d('sell-product');
    const navButton = document.querySelector('button[data-target="sell-product"]');
    if (sellSection && navButton) {
        document.querySelectorAll('.content-section').forEach(s => s.classList.add('hidden'));
        document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
        sellSection.classList.remove('hidden');
        navButton.classList.add('active');
        sellSection.scrollIntoView({ behavior: 'smooth' });
    }
    
    editingPendingSaleId = pendingId;

    // 1. ملء البيانات الأساسية للبيع السريع
    // إزالة السيريال من الاسم للعرض فقط
    sellProductNameInput.value = sale.mainProduct.name.split(' (S/N:')[0]; 
    sellCustomerNameInput.value = sale.customerName || '';
    sellQuantityInput.value = sale.mainProduct.quantity;
    sellPriceInput.value = sale.totalSellPrice;
    
    // التعامل مع السيريال القديم إن وجد
    const serialMatch = sale.mainProduct.name.match(/\(S\/N: (.*?)\)/);
    if (sellSerialInput) {
        if (serialMatch && serialMatch[1]) {
            sellSerialContainer.classList.remove('hidden');
            sellSerialInput.value = serialMatch[1];
        } else {
            sellSerialContainer.classList.add('hidden');
            sellSerialInput.value = '';
        }
    }

    sellPendingCheckbox.checked = true; // يجب أن يبقى مؤقت

    // 2. تحديث قائمة الملحقات (Checkboxes)
    updateAdditionalCostsCheckboxes(); 

    // 3. استرجاع حالة الملحقات المختارة سابقاً
    const attachments = sale.additionalItems || [];
    setTimeout(() => { 
        attachments.forEach(att => {
            const checkbox = additionalCostsContainer.querySelector(`input[value="${att.name}"]`);
            if (checkbox) {
                checkbox.checked = true;
                const parentLabel = checkbox.closest('label');
                const qtyInput = parentLabel.querySelector('.additional-item-quantity');
                if(qtyInput) {
                    qtyInput.value = att.quantity;
                }
            }
        });
    }, 50);

    // تغيير شكل الزر ليدل على التعديل
    sellButton.textContent = "حفظ التعديلات";
    sellButton.classList.remove('bg-blue-500', 'hover:bg-blue-600');
    sellButton.classList.add('bg-orange-500', 'hover:bg-orange-600');
    
    d('cancel-edit-pending-button').classList.remove('hidden');

// إضافة هذا السطر لضمان تحديث عرض الدين فور تحميل بيانات البيعة للتعديل
    setTimeout(() => { 
        if (typeof window.updateQuickSaleDebt === 'function') {
            window.updateQuickSaleDebt(); 
        }
    }, 150);

}
            // --- Invoice Search Functions ---
            function searchInvoiceByNumber() {
                if (!searchInvoiceNumberInput || !searchResultsListContainer || !searchMessageContainer) return;
                const searchTerm = searchInvoiceNumberInput.value.trim();
                 showMessage(searchMessageContainer, ""); // Clear previous messages

                if (!searchTerm) {
                    showMessage(searchMessageContainer, "يرجى إدخال رقم الفاتورة للبحث.", true);
                    searchResultsListContainer.innerHTML = '<p class="text-center text-gray-500">أدخل رقم الفاتورة.</p>';
                    return;
                }
                 console.log(`Searching for invoice number: ${searchTerm} in salesToday:`, salesToday);
                // Search within the currently loaded day's sales
                const results = salesToday.filter(sale => sale.invoiceNumber && sale.invoiceNumber === searchTerm);
                displaySearchResults(results);
            }
            function searchInvoiceByName() {
                if (!searchCustomerNameInput || !searchResultsListContainer || !searchMessageContainer) return;
                const searchTerm = searchCustomerNameInput.value.trim().toLowerCase();
                 showMessage(searchMessageContainer, ""); // Clear previous messages

                if (!searchTerm) {
                    showMessage(searchMessageContainer, "يرجى إدخال اسم العميل للبحث.", true);
                    searchResultsListContainer.innerHTML = '<p class="text-center text-gray-500">أدخل اسم العميل.</p>';
                    return;
                }
                 console.log(`Searching for customer name: ${searchTerm} in salesToday:`, salesToday);
                // Search within the currently loaded day's sales (case-insensitive partial match)
                const results = salesToday.filter(sale => sale.customerName && sale.customerName.toLowerCase().includes(searchTerm));
                displaySearchResults(results);
            }
            function displaySearchResults(results) {
                 if (!searchResultsListContainer || !searchMessageContainer) return;

                 if (results.length === 0) {
                     searchResultsListContainer.innerHTML = '<p class="text-center text-gray-500">لم يتم العثور على فواتير مطابقة.</p>';
                     showMessage(searchMessageContainer, "لم يتم العثور على نتائج.", false, true); // Use info style
                     return;
                 }

                 // Simple list display for now
                 searchResultsListContainer.innerHTML = `
                     <ul class="space-y-3">
                         ${results.map(sale => `
                             <li class="p-3 border rounded-md bg-gray-50 shadow-sm">
                                 <div class="flex justify-between items-center flex-wrap gap-2">
                                     <div>
                                         <strong class="text-blue-600">رقم: ${sale.invoiceNumber || 'N/A'}</strong> |
                                         <span class="text-xs text-gray-500">${formatDateTime(sale.timestamp)}</span> <br>
                                         <span>العميل: ${sale.customerName || '-'}</span>
                                     </div>
                                     <div class="font-semibold text-red-600 text-lg">
                                         ${formatCurrency(sale.grandTotal || sale.totalSellPrice || 0)}
                                     </div>
                                 </div>
                                 <div class="text-sm mt-1 text-gray-600">
                                     الربح: ${formatCurrency(sale.profit || 0)} | التكلفة: ${formatCurrency(sale.totalCost || 0)}
                                 </div>
                                 <button data-invoice-id="${sale.id}" class="view-invoice-details-btn text-xs bg-teal-500 hover:bg-teal-600 text-white font-semibold py-1 px-2 rounded mt-2 border border-teal-600">عرض التفاصيل</button>
                             </li>
                         `).join('')}
                     </ul>`;
                  showMessage(searchMessageContainer, `تم العثور على ${results.length} فاتورة/فواتير.`, false);
             }
            // Function to handle viewing invoice details (uses print logic)
         async function viewInvoiceDetails(invoiceId) {
     // 1. محاولة العثور عليها في مبيعات اليوم الحالي
     let invoice = salesToday.find(s => s.id === invoiceId);

     // 2. محاولة العثور عليها في نتائج البحث الشامل (المتغير الجديد)
     if (!invoice && typeof globalSearchResults !== 'undefined') {
         invoice = globalSearchResults.find(s => s.id === invoiceId);
     }

     // 3. محاولة العثور عليها في تقرير المبيعات الشهري (إذا كان مفتوحاً)
     if (!invoice && typeof currentMonthlySalesData !== 'undefined') {
        invoice = currentMonthlySalesData.find(s => s.id === invoiceId);
     }

     // 4. إذا وجدناها محلياً، اعرضها فوراً
     if (invoice) {
         inv_printInvoice(invoice);
         return;
     }

     // 5. الحل الجذري: إذا لم توجد في الذاكرة، اجلبها من قاعدة البيانات مباشرة
     if (window.currentUser) {
         try {
            // عرض رسالة تحميل صغيرة
             const msgBox = document.getElementById('global-message');
             if(msgBox) showMessage(msgBox, "جاري جلب تفاصيل الفاتورة من الخادم...", false, true);

             const docRef = window.doc(window.db, "users", window.currentUser.uid, "invoices", invoiceId);
             const docSnap = await window.getDoc(docRef);
             
             if (docSnap.exists()) {
                 invoice = docSnap.data();
                 inv_printInvoice(invoice); // عرض الفاتورة
                 if(msgBox) showMessage(msgBox, ""); // إخفاء الرسالة
             } else {
                 alert("عذراً، لم يتم العثور على بيانات هذه الفاتورة في قاعدة البيانات.");
             }
         } catch (error) {
             console.error("Error fetching invoice:", error);
             alert("حدث خطأ أثناء محاولة جلب تفاصيل الفاتورة.");
         }
     } else {
         alert("يرجى تسجيل الدخول لعرض تفاصيل الفواتير المؤرشفة.");
     }
 }
            // **** دالة البحث عن السيريالات للمورد (مع فلترة داخلية) ****
            function searchSerialsBySupplier() {
                if (!searchSupplierSerialNameInput || !supplierSerialsResultsContainer || !serialSearchMessage || !filterSerialsContainer) return;
                const supplierName = searchSupplierSerialNameInput.value.trim();
                showMessage(serialSearchMessage, ''); // Clear previous message
                supplierSerialsResultsContainer.innerHTML = ''; // Clear previous results
                filterSerialsContainer.classList.add('hidden'); // Hide filter input initially
                filterSerialsInput.value = ''; // Clear filter input
                currentSupplierSerials = []; // Clear the temporary list

                if (!supplierName) {
                    showMessage(serialSearchMessage, "يرجى إدخال اسم المورد للبحث.", true);
                    supplierSerialsResultsContainer.innerHTML = '<p class="text-center text-gray-500">أدخل اسم المورد.</p>';
                    return;
                }

                // Find supplier ID (case-insensitive)
                const supplier = suppliers.find(s => s.name.toLowerCase() === supplierName.toLowerCase());

                if (!supplier) {
                    showMessage(serialSearchMessage, `لم يتم العثور على مورد بالاسم "${supplierName}".`, true);
                    supplierSerialsResultsContainer.innerHTML = `<p class="text-center text-gray-500">لم يتم العثور على مورد بالاسم "${supplierName}".</p>`;
                    return;
                }

                // Filter serial numbers log based on supplier ID
                const foundSerials = serialNumbersLog
                    .filter(log => log.supplierId === supplier.id)
                    .sort((a, b) => new Date(b.addedTimestamp) - new Date(a.addedTimestamp)); // Sort by newest first

                currentSupplierSerials = foundSerials; // Store the found serials for filtering

                if (foundSerials.length === 0) {
                    showMessage(serialSearchMessage, `لا توجد أرقام تسلسلية مسجلة للمورد "${supplierName}".`, false, true); // Info message
                    supplierSerialsResultsContainer.innerHTML = `<p class="text-center text-gray-500">لا توجد أرقام تسلسلية مسجلة لهذا المورد.</p>`;
                } else {
                     displayFilteredSupplierSerials(''); // Display all found serials initially
                     filterSerialsContainer.classList.remove('hidden'); // Show the filter input
                     showMessage(serialSearchMessage, `تم العثور على <span class="math-inline">\{foundSerials\.length\} رقم تسلسلي للمورد "</span>{supplierName}". يمكنك الآن تصفية النتائج أدناه.`, false);
                }
            }

            // **** دالة جديدة لعرض السيريالات المفلترة ****
            function displayFilteredSupplierSerials(searchTerm = '') {
                 if (!supplierSerialsResultsContainer) return;
                 const lowerSearchTerm = searchTerm.toLowerCase();

                 const filteredList = currentSupplierSerials.filter(log =>
                     log.serial.toLowerCase().includes(lowerSearchTerm)
                 );

                 if (filteredList.length === 0) {
                      supplierSerialsResultsContainer.innerHTML = `<p class="text-center text-gray-500">لا توجد أرقام تسلسلية تطابق "${searchTerm}".</p>`;
                      return;
                 }

                 // Display results
                 let html = '<ul class="space-y-2">';
                 filteredList.forEach(log => {
                      let statusColor = 'text-gray-500'; // افتراضي
                      let statusText = log.status || 'غير محدد';
                      if (statusText === 'in_stock') { statusColor = 'text-green-600'; statusText = 'متوفر'; }
                      else if (statusText === 'sold') { statusColor = 'text-red-500'; statusText = 'مباع'; }
                      else if (statusText === 'in_invoice_temp') { statusColor = 'text-yellow-600'; statusText = 'في فاتورة'; }
                      // Add more statuses if needed

                      html += `<li class="border-b border-gray-100 pb-1">
                                   <span class="font-mono"><strong><span class="math-inline">\{log\.serial \|\| 'N/A'\}</strong\></span\>
<span class\="text\-sm text\-gray\-700"\>\(</span>{log.productName || 'منتج غير محدد'})</span> -
                                   <span class="text-xs text-gray-500">${formatDateTime(log.addedTimestamp)}</span>
                                   <span class="text-xs <span class="math-inline">\{statusColor\} ml\-2 font\-medium"\>\[</span>{statusText}]</span>
                                 </li>`;
                 });
                 html += '</ul>';
                 supplierSerialsResultsContainer.innerHTML = html;
             }


            // **** دالة استيراد السيريالات من ملف CSV ****
            function importSerialCSV(event, targetTextarea, messageElement) {
                const file = event.target.files[0];

                if (!file || !targetTextarea) {
                    showMessage(messageElement, "لم يتم اختيار ملف أو أن حقل السيريالات غير موجود.", true);
                    return;
                }
                if (!/\.(csv|txt)$/i.test(file.name)) {
                     showMessage(messageElement, "الرجاء اختيار ملف بصيغة CSV أو TXT.", true);
                     event.target.value = null; // Reset file input
                     return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const content = e.target.result;
                        let importedSerials = [];

                        // **** تعديل منطق القراءة لاستخلاص السيريال فقط ****
                        const lines = content.split('\n');
                        lines.forEach(line => {
                            const trimmedLine = line.trim();
                            if (trimmedLine) {
                                // افترض أن السيريال هو الجزء الأول قبل أول مسافة أو فاصلة
                                const match = trimmedLine.match(/^([^\s,]+)/);
                                if (match && match[1]) {
                                    const potentialSerial = match[1].trim();
                                    if (potentialSerial) { // تأكد أنه ليس فارغاً بعد الاقتطاع
                                        importedSerials.push(potentialSerial);
                                    }
                                }
                            }
                        });
                        // **** نهاية تعديل منطق القراءة ****


                        if (importedSerials.length > 0) {
                            // ضع السيريالات المستوردة في الـ textarea (كل واحد في سطر)
                            targetTextarea.value = importedSerials.join('\n');
                            showMessage(messageElement, `تم استيراد ${importedSerials.length} رقم تسلسلي بنجاح. يرجى المراجعة ثم الضغط على زر الحفظ/الإضافة.`, false);
                        } else {
                            showMessage(messageElement, "لم يتم العثور على أرقام تسلسلية صالحة في الملف. تأكد أن كل سيريال في سطر أو مفصول بفاصلة/مسافة.", true);
                        }

                    } catch (error) {
                        console.error("Error reading or processing serial file:", error);
                        showMessage(messageElement, `حدث خطأ أثناء قراءة الملف: ${error.message}`, true);
                    } finally {
                        event.target.value = null; // Reset file input
                    }
                };
                reader.onerror = function(e) {
                     console.error("Error reading file:", e);
                     showMessage(messageElement, "حدث خطأ أثناء قراءة الملف.", true);
                     event.target.value = null;
                };
                reader.readAsText(file);
            }

            // (سيتم استكمال JavaScript في الجزء التالي 8ج مع initializeApp)
            // ===================================================================================
// START: FINANCIAL CENTER (FC) LOGIC
// ===================================================================================

// Helper to get all data for a specific month (YYYY-MM) from localStorage
 async function fc_get_data_for_month(month) {
    const datesInMonth = getMonthStartDateEndDate(month);
    let monthlyExpenses = new Map();
    let monthlyProductPurchases = new Map();

    // أولاً: أضف كل الالتزامات الشهرية والديون المعالجة (التي لم تكتمل)
    if (monthlyLiabilities && monthlyLiabilities.length > 0) {
        monthlyLiabilities.forEach(liability => {
            if (liability.isAmortizedDebt) {
                // إذا كان ديناً معالجاً، تحقق مما إذا كانت مدته قد انتهت
                if (liability.periodsProcessed < liability.totalPeriods) {
                    monthlyExpenses.set(liability.id, { name: `${liability.name} [شهر ${liability.periodsProcessed + 1}/${liability.totalPeriods}]`, amount: liability.amount });
                }
            } else {
                // إذا كان التزاماً شهرياً عادياً (مثل الإيجار)، أضفه دائماً
                monthlyExpenses.set(liability.id, { name: liability.name, amount: liability.amount });
            }
        });
    }

    // ثانياً: أضف المصاريف اليومية المسجلة في السجل
    for (const dateStr of datesInMonth) {
        const dayData = fetchData(lsPrefix + dateStr, null);
        if (dayData && dayData.log) {
            dayData.log.forEach(logEntry => {
                if (logEntry.type === "تسجيل مصروف") {
                    const expenseMatch = logEntry.details.match(/بقيمة ([\d\.,]+) جنيه/);
                    if (expenseMatch && expenseMatch[1]) {
                        const amount = parseFloat(expenseMatch[1].replace(/,/g, ''));
                        const name = `مصروف يومي: ${logEntry.details.split('.')[0]}`;
                        if (!isNaN(amount)) {
                            const expenseId = `daily-${logEntry.timestamp}`;
                            monthlyExpenses.set(expenseId, { name: name, amount: (monthlyExpenses.get(expenseId)?.amount || 0) + amount });
                        }
                    }
                }
            });
        }
    }
    
    // تحويل الـ Map إلى مصفوفة للعرض
    const expensesArray = Array.from(monthlyExpenses.entries());
    return { expenses: expensesArray };
}


// Populate the UI lists for the selected month with REAL data
 async function fc_populate_lists(month) {
    if (!month || !fc_expenses_list || !fc_products_list) return;
    
    const { expenses } = await fc_get_data_for_month(month);
    
    fc_expenses_list.innerHTML = expenses.length > 0
        ? expenses.map(([id, exp]) => `<label class="flex items-center p-2 rounded-md hover:bg-gray-100 cursor-pointer"><input type="checkbox" data-id="${id}" data-amount="${exp.amount}" class="fc-expense-checkbox ml-3" checked>${exp.name} <span class="mr-auto font-mono text-gray-600">${formatCurrency(exp.amount)}</span></label>`).join('')
        : '<p class="text-sm text-gray-500">لا توجد مصاريف مسجلة لهذا الشهر.</p>';

    const productsInStock = products.filter(p => p.quantity > 0);

    fc_products_list.innerHTML = productsInStock.length > 0
        ? productsInStock.map(prod => {
            const totalValue = (prod.quantity || 0) * (prod.costPrice || 0);
            return `<label class="flex items-center p-3 bg-gray-50 rounded-md hover:bg-gray-100 cursor-pointer border"><input type="checkbox" class="fc-product-checkbox ml-3" data-name="${prod.name}" data-qty="${prod.quantity}" data-value="${totalValue}" data-cost="${prod.costPrice}" checked>${prod.name} <span class="mr-auto font-mono text-gray-600">(الكمية الحالية: ${prod.quantity}، التكلفة: ${formatCurrency(prod.costPrice)})</span></label>`;
        }).join('')
        : '<p class="text-sm text-gray-500">لا توجد منتجات في المخزون حالياً.</p>';
    
    fc_add_event_listeners_to_lists();
    fc_update_ui();
}


// Populate the debt treatment tab with REAL data
function fc_populate_debt_treatment() {
    if (!fc_debt_select) return;
    const validDebts = debtors.filter(d => (Number(d.amount) || 0) > 0.001);
    fc_debt_select.innerHTML = '<option value="">-- اختر الدين للمعالجة --</option>' 
        + validDebts.map(d => `<option value="${d.id}" data-amount="${d.amount}">${d.name} - ${d.reason} (${formatCurrency(d.amount)})</option>`).join('');
}

// =====================================================================
// ★★★ START: NEW FIREBASE-ENABLED MONTH SELECT FUNCTION ★★★
// =====================================================================
async function fc_populate_month_select() {
    if (!fc_month_select || !window.currentUser) return;
    
    // إظهار رسالة تحميل مؤقتة للمستخدم
    const tempOption = fc_month_select.querySelector('option');
    if(tempOption) tempOption.textContent = "جاري جلب الشهور...";

    const userId = window.currentUser.uid;
    const daysColRef = window.collection(window.db, "users", userId, "days");
    const months = new Set();
    
    // إضافة الشهر الحالي دائمًا كخيار متاح
    months.add(getTodayDateString().substring(0, 7)); 

    try {
        // جلب كل المستندات (الأيام) من قاعدة البيانات
        const querySnapshot = await window.getDocs(daysColRef);
        querySnapshot.forEach((doc) => {
            // ID المستند هو التاريخ نفسه 'YYYY-MM-DD'
            const monthStr = doc.id.substring(0, 7); // استخراج 'YYYY-MM'
            months.add(monthStr);
        });

        const sortedMonths = Array.from(months).sort().reverse();
        
        // بناء القائمة المنسدلة بالشهور التي تم العثور عليها
        fc_month_select.innerHTML = sortedMonths.map(month => {
            const [year, m] = month.split('-');
            const date = new Date(year, m - 1);
            const monthName = date.toLocaleString('ar-EG', { month: 'long', year: 'numeric' });
            return `<option value="${month}">${monthName}</option>`;
        }).join('');

        // تحميل بيانات أحدث شهر تلقائيًا
        if (sortedMonths.length > 0) {
            await fc_populate_lists(sortedMonths[0]); 
        }
    } catch (error) {
        console.error("Error fetching available months from Firestore:", error);
        fc_month_select.innerHTML = `<option value="">فشل جلب الشهور</option>`;
    }
}
// =====================================================================
// ★★★ END: NEW FIREBASE-ENABLED MONTH SELECT FUNCTION ★★★
// =====================================================================

 function fc_update_ui() {
    if (!d('fc-auto-cost-mode-radio')) return; // Check if the elements are rendered
    fc_toggle_cost_mode();
    fc_calculate_and_display_totals();
    fc_toggle_manual_distribution();

    // هذا هو السطر المهم الذي تم تعديله
    // سيقوم دائماً بتشغيل المحاكاة، وهي التي ستقرر إظهار النافذة أو إخفائها
    fc_simulate_distribution(); 
}

function fc_add_event_listeners_to_lists() {
    document.querySelectorAll('.fc-expense-checkbox, .fc-product-checkbox, input[name="fc-distribution-method"], input[name="fc-cost-mode"], #fc-manual-cost-input').forEach(el => el.addEventListener('change', fc_update_ui));
    if(fc_manual_cost_input) fc_manual_cost_input.addEventListener('input', fc_update_ui);
    const manualRadio = d('fc-distribution-manual-radio');
    if(manualRadio) manualRadio.addEventListener('change', fc_populate_manual_inputs);
    if(fc_products_list) fc_products_list.addEventListener('change', () => { if(d('fc-distribution-manual-radio').checked) fc_populate_manual_inputs(); });
}

function fc_toggle_cost_mode() {
    if(!fc_expenses_wrapper || !fc_manual_cost_wrapper) return;
    const isManual = d('fc-manual-cost-mode-radio').checked;
    fc_expenses_wrapper.classList.toggle('fc-disabled-section', isManual);
    fc_manual_cost_wrapper.classList.toggle('hidden', !isManual);
}

function fc_calculate_and_display_totals() {
    if (!fc_total_expenses_display) return;
    let totalExpenses = 0;
    if (d('fc-manual-cost-mode-radio').checked) {
        totalExpenses = parseFloat(fc_manual_cost_input.value) || 0;
    } else {
        fc_expenses_list.querySelectorAll('input:checked').forEach(e => totalExpenses += parseFloat(e.dataset.amount));
    }
    fc_total_expenses_display.textContent = formatCurrency(totalExpenses);
}

function fc_toggle_manual_distribution() {
    if(!fc_manual_container) return;
    const isManual = d('fc-distribution-manual-radio').checked;
    fc_manual_container.classList.toggle('hidden', !isManual);
    if (isManual) fc_populate_manual_inputs();
}

function fc_populate_manual_inputs() {
    if (!fc_manual_list || !fc_products_list) return;
    const selectedProducts = Array.from(fc_products_list.querySelectorAll('input:checked'));
    fc_manual_list.innerHTML = selectedProducts.map(prod => `<div class="flex items-center justify-between p-2"><label for="fc-perc-${prod.dataset.name}">${prod.dataset.name}</label><div class="flex items-center"><input type="number" id="fc-perc-${prod.dataset.name}" data-product-name="${prod.dataset.name}" class="fc-manual-dist-input fc-form-input" min="0" max="100" value="0"><span class="mr-2 font-semibold">%</span></div></div>`).join('') || '<p class="text-sm text-center text-gray-500">اختر المنتجات أولاً.</p>';
    document.querySelectorAll('.fc-manual-dist-input').forEach(input => input.addEventListener('input', fc_validate_and_simulate));
    fc_validate_percentages();
}

function fc_validate_percentages() {
    if (!fc_percentage_total) return false;
    let currentTotal = 0;
    document.querySelectorAll('.fc-manual-dist-input').forEach(input => currentTotal += parseFloat(input.value) || 0);
    fc_percentage_total.textContent = `${currentTotal}%`;
    const feedbackEl = d('fc-percentage-total-feedback');
    if (feedbackEl) {
        feedbackEl.className = 'mt-4 p-2 text-center rounded-md'; // Reset
        if (Math.round(currentTotal) === 100) {
            feedbackEl.classList.add('bg-green-100', 'text-green-800');
        } else {
            feedbackEl.classList.add('bg-red-100', 'text-red-800');
        }
    }
    return Math.round(currentTotal) === 100;
}

function fc_validate_and_simulate() {
    fc_validate_percentages();
    fc_simulate_distribution();
}

function fc_get_simulation_results() {
    let totalExpenses = 0;
    if (d('fc-manual-cost-mode-radio').checked) { totalExpenses = parseFloat(fc_manual_cost_input.value) || 0; } 
    else { fc_expenses_list.querySelectorAll('input:checked').forEach(e => totalExpenses += parseFloat(e.dataset.amount)); }
    
    const selectedProductsEls = Array.from(fc_products_list.querySelectorAll('input:checked'));
    if (selectedProductsEls.length === 0 || totalExpenses <= 0) {
        return null;
    }

    const distributionMethod = document.querySelector('input[name="fc-distribution-method"]:checked').value;
    let productUpdates = [];
    
    if (distributionMethod === 'quantity') {
        let totalQty = 0; selectedProductsEls.forEach(p => totalQty += parseInt(p.dataset.qty));
        if (totalQty === 0) return { error: "مجموع كميات المنتجات صفر." };
        const costPerItem = totalExpenses / totalQty;
        selectedProductsEls.forEach(p => {
            productUpdates.push({ name: p.dataset.name, addedCost: costPerItem });
        });
    } else if (distributionMethod === 'value') {
        let totalValue = 0; selectedProductsEls.forEach(p => totalValue += parseFloat(p.dataset.value));
        if (totalValue === 0) return { error: "مجموع قيمة المنتجات صفر." };
        selectedProductsEls.forEach(p => {
            const qty = parseInt(p.dataset.qty);
            const val = parseFloat(p.dataset.value);
            const costShare = (val / totalValue) * totalExpenses;
            const addedPerItem = qty > 0 ? costShare / qty : 0;
            productUpdates.push({ name: p.dataset.name, addedCost: addedPerItem });
        });
    } else if (distributionMethod === 'manual') {
        if (!fc_validate_percentages()) return { error: "مجموع النسب المئوية يجب أن يكون 100%." };
        selectedProductsEls.forEach(p => {
            const percentageInput = d(`fc-perc-${p.dataset.name}`);
            const percentage = parseFloat(percentageInput.value) || 0;
            const qty = parseInt(p.dataset.qty);
            const costShare = (percentage / 100) * totalExpenses;
            const addedPerItem = qty > 0 ? costShare / qty : 0;
            productUpdates.push({ name: p.dataset.name, addedCost: addedPerItem });
        });
    }
    return { productUpdates };
}

function fc_simulate_distribution() {
    if (!fc_preview_results || !fc_preview_container) return;

    const results = fc_get_simulation_results();
    let resultsHTML = '';

    if (!results) {
        fc_preview_container.classList.remove('visible');
        return;
    }
    if (results.error) {
        resultsHTML = `<p class="text-center text-red-700 font-semibold">${results.error}</p>`;
    } else {
        resultsHTML += `<p class="font-semibold pb-2 mb-2 border-b">نتائج المحاكاة:</p>`;
        results.productUpdates.forEach(update => {
            const originalProduct = products.find(p => p.name === update.name);
            if(originalProduct) {
                const originalCost = originalProduct.costPrice;
                resultsHTML += `<div class="p-2 border-l-4 border-gray-200"><strong>${update.name}:</strong><br><span class="text-sm">التكلفة الجديدة: <span class="font-mono text-gray-500">${formatCurrency(originalCost)}</span> + <span class="font-mono text-orange-500">${formatCurrency(update.addedCost)}</span> = <span class="font-bold text-green-700 font-mono">${formatCurrency(originalCost + update.addedCost)}</span></span></div>`;
            }
        });
    }
    
    fc_preview_results.innerHTML = resultsHTML;
    fc_preview_container.classList.add('visible');
}

function fc_execute_cost_distribution() {
    if (!confirm("هل أنت متأكد من تنفيذ هذا التوزيع؟ سيتم تحديث تكاليف المنتجات المحددة بشكل دائم في بيانات اليوم الحالي.")) return;

    const results = fc_get_simulation_results();
    if (!results || results.error) {
        showGlobalMessage(results ? results.error : "لا يمكن التنفيذ، يرجى مراجعة المدخلات.", true);
        return;
    }

    // --- تحديث تكاليف المنتجات (هذا الجزء لم يتغير) ---
    let logDetails = [];
    results.productUpdates.forEach(update => {
        const productIndex = products.findIndex(p => p.name === update.name);
        if (productIndex > -1) {
            const oldCost = products[productIndex].costPrice;
            products[productIndex].costPrice += update.addedCost;
            const newCost = products[productIndex].costPrice;
            logDetails.push(`"${update.name}" (من ${formatCurrency(oldCost)} إلى ${formatCurrency(newCost)})`);
        }
    });

    // --- الجزء الجديد: تحديث عداد الديون المعالجة التي تم توزيعها ---
    const distributedExpenseCheckboxes = Array.from(d('fc-expenses-to-distribute-list').querySelectorAll('input:checked'));
    distributedExpenseCheckboxes.forEach(checkbox => {
        const liabilityId = checkbox.dataset.id; // سنحتاج لإضافة هذا في الخطوة التالية
        const liabilityToUpdate = monthlyLiabilities.find(l => l.id === liabilityId && l.isAmortizedDebt);
        
        if (liabilityToUpdate) {
            liabilityToUpdate.periodsProcessed += 1;
            logOperation("تحديث معالجة دين", `تم توزيع القسط ${liabilityToUpdate.periodsProcessed} من ${liabilityToUpdate.totalPeriods} للدين "${liabilityToUpdate.name}".`);
        }
    });


    logOperation("توزيع تكاليف", `تم تحديث تكلفة المنتجات: ${logDetails.join(', ')}.`);
    showGlobalMessage("تم تحديث تكاليف المنتجات بنجاح.", false);
    updateUI();
}

function fc_execute_debt_treatment() {
    if (!fc_debt_select) return;
    const selectedOption = fc_debt_select.options[fc_debt_select.selectedIndex];
    if (!selectedOption || !selectedOption.value) {
        showGlobalMessage("يرجى اختيار دين للمعالجة أولاً.", true);
        return;
    }
    
    const debtId = selectedOption.value;
    const debtAmount = parseFloat(selectedOption.dataset.amount);
    const debtIndex = debtors.findIndex(d => d.id === debtId);
    
    if (debtIndex === -1) {
        showGlobalMessage("لم يتم العثور على الدين المحدد.", true);
        return;
    }

    const periodValue = parseInt(d('fc-distribution-period-value').value) || 1;
    const costPerMonth = debtAmount / periodValue;
    const debtInfo = debtors[debtIndex];

    if (!confirm(`هل أنت متأكد من تحويل دين "${debtInfo.name}" بقيمة ${formatCurrency(debtAmount)} إلى التزام شهري؟\nسيتم حذف الدين الحالي وإنشاء التزام شهري بقيمة ${formatCurrency(costPerMonth)} لمدة ${periodValue} شهور.`)) {
        return;
    }

    // 1. Remove the debt from debtors list
    debtors.splice(debtIndex, 1);

    // 2. Add a new "smart" monthly liability with tracking properties
    const newMonthlyLiability = {
        id: generateId('amortized-debt'),
        name: `معالجة دين (${debtInfo.name})`,
        amount: costPerMonth,
        isAmortizedDebt: true,       // علامة لتمييز هذا النوع من الالتزام
        totalPeriods: periodValue,       // إجمالي عدد الشهور
        periodsProcessed: 0,             // عدد الشهور التي تم توزيعها (يبدأ بصفر)
    };
    monthlyLiabilities.push(newMonthlyLiability);
    
    logOperation("معالجة دين متعثر", `تم تحويل دين "${debtInfo.name}" (${formatCurrency(debtAmount)}) إلى التزام شهري ثابت بقيمة ${formatCurrency(costPerMonth)} لمدة ${periodValue} شهور.`);
    showGlobalMessage("تم تحويل الدين إلى التزام شهري بنجاح.", false);

    // Refresh UI
    updateUI();
}
// =======================================================
// START: Invoice Return & Pending Receipt Logic
// =======================================================

/**
 * Searches for a sales invoice by its number and displays it for return processing.
 */
async function handleInvoiceSearchForReturn() {
    if (!searchInvoiceInput || !invoiceSearchResults) return;
    const invoiceNumber = searchInvoiceInput.value.trim();
    invoiceSearchResults.innerHTML = ''; // Clear previous results

    if (!invoiceNumber) {
        invoiceSearchResults.innerHTML = `<p class="text-red-600">يرجى إدخال رقم فاتورة للبحث.</p>`;
        return;
    }

    // Search in today's sales first, then search online in the invoices collection
    let invoice = salesToday.find(s => s.invoiceNumber === invoiceNumber);

    if (!invoice && window.currentUser) {
        try {
            const docRef = window.doc(window.db, "users", window.currentUser.uid, "invoices", invoiceNumber);
            const docSnap = await window.getDoc(docRef);
            if (docSnap.exists()) {
                invoice = docSnap.data();
            }
        } catch (error) {
            console.error("Error searching for invoice online:", error);
        }
    }


    if (!invoice) {
        invoiceSearchResults.innerHTML = `<p class="text-red-600">لم يتم العثور على فاتورة بهذا الرقم.</p>`;
        return;
    }

    let itemsHTML = invoice.items.map((item, index) => `
        <tr class="border-b border-gray-100">
            <td class="p-2">${item.name}</td>
            <td class="p-2 text-center">${item.quantity}</td>
            <td class="p-2 text-center font-mono">${formatCurrency(item.unitPrice)}</td>
            <td class="p-2" style="width: 100px;">
                <input type="number" value="0" min="0" max="${item.quantity}" class="text-center return-invoice-qty" data-item-index="${index}" data-unit-price="${item.unitPrice}" data-cost-price="${item.costPrice}">
            </td>
        </tr>
    `).join('');

    invoiceSearchResults.innerHTML = `
        <div class="p-3 bg-gray-50 rounded-md border">
            <p><strong>العميل:</strong> ${invoice.customerName}</p>
            <p><strong>التاريخ:</strong> ${formatDateForDisplay(invoice.saleDate || invoice.timestamp)}</p>
            <table class="w-full mt-2 text-sm">
                <thead><tr class="bg-gray-200">
                    <th class="p-2 text-right">المنتج</th><th class="p-2">الكمية المباعة</th><th class="p-2">سعر البيع</th><th class="p-2">الكمية المرتجعة</th>
                </tr></thead>
                <tbody>${itemsHTML}</tbody>
            </table>
            <div class="my-4">
                <label for="return-invoice-receive-now" class="inline-flex items-center cursor-pointer font-semibold">
                    <input type="checkbox" id="return-invoice-receive-now" checked>
                    <span class="text-sm">استلام البضاعة في المخزن الآن؟</span>
                </label>
            </div>
            <button id="confirm-invoice-return-btn" data-invoice-id="${invoice.id}" data-invoice-number="${invoice.invoiceNumber}" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded mt-3">تأكيد الإرجاع من الفاتورة</button>
        </div>
    `;
}

/**
 * Handles the confirmation of returning items from a searched invoice.
 */
function handleInvoiceReturnConfirmation(invoiceId, invoiceNumber) {
    saveStateToHistory();
    const itemsToReturn = [];
    let totalReturnValue = 0;
    let totalCostOfReturn = 0;

    document.querySelectorAll('.return-invoice-qty').forEach(input => {
        const qty = parseInt(input.value);
        if (qty > 0) {
            itemsToReturn.push({
                name: invoiceSearchResults.querySelector(`[data-item-index="${input.dataset.itemIndex}"]`).closest('tr').cells[0].textContent.trim(),
                quantity: qty,
                unitPrice: parseFloat(input.dataset.unitPrice),
                costPrice: parseFloat(input.dataset.costPrice)
            });
            totalReturnValue += qty * parseFloat(input.dataset.unitPrice);
            totalCostOfReturn += qty * parseFloat(input.dataset.costPrice);
        }
    });

    if (itemsToReturn.length === 0) {
        showMessage(returnMessage, "لم يتم تحديد أي كميات للإرجاع.", true);
        return;
    }

    if (totalReturnValue > liquidity) {
        showMessage(returnMessage, `السيولة غير كافية (${formatCurrency(liquidity)}) لإرجاع هذا المبلغ (${formatCurrency(totalReturnValue)}).`, true);
        return;
    }

    const receiveNow = d('return-invoice-receive-now').checked;
    const customerName = invoiceSearchResults.querySelector('p > strong').nextSibling.textContent.trim();

    // Process the return
    liquidity -= totalReturnValue;
    const profitToReverse = totalReturnValue - totalCostOfReturn;

    if(receiveNow) {
        itemsToReturn.forEach(item => {
            const productIndex = products.findIndex(p => p.name === item.name);
            if (productIndex !== -1) {
                products[productIndex].quantity += item.quantity;
            } else {
                products.push({ name: item.name, quantity: item.quantity, costPrice: item.costPrice, supplierId: '' });
            }
        });
        totalProfit -= profitToReverse;
        completedReturns.push({ id: generateId('ret'), items: itemsToReturn, customerName, returnedAmount: totalReturnValue, timestamp: new Date().toISOString(), fromInvoice: invoiceNumber });
        logOperation("مرتجع من فاتورة", `إرجاع بضاعة من فاتورة ${invoiceNumber} واستلامها. تم إرجاع ${formatCurrency(totalReturnValue)}.`);
    } else {
        pendingReturns.push({ id: generateId('pend-ret'), items: itemsToReturn, customerName, returnedAmount: totalReturnValue, costOfGoods: totalCostOfReturn, fromInvoice: invoiceNumber });
        logOperation("مرتجع معلق من فاتورة", `إرجاع مبلغ ${formatCurrency(totalReturnValue)} للعميل من فاتورة ${invoiceNumber}. البضاعة قيد الاستلام.`);
    }

    liquidityLog.push({ id: `liq-${Date.now()}`, type: "remove", amount: totalReturnValue, description: `مرتجع من فاتورة ${invoiceNumber}`, currentBalance: liquidity });

    showMessage(returnMessage, "تم تسجيل عملية الإرجاع من الفاتورة بنجاح.", false);
    invoiceSearchResults.innerHTML = '';
    updateUI();
}

// ✅✅✅ الكود الجديد والصحيح لدالة handleConfirmReceipt ✅✅✅
function handleConfirmReceipt(pendingId) {
    saveStateToHistory();
    const returnIndex = pendingReturns.findIndex(r => r.id === pendingId);
    if (returnIndex === -1) {
        showGlobalMessage("خطأ: لم يتم العثور على المرتجع المعلق.", true);
        return;
    }

    const ret = pendingReturns.splice(returnIndex, 1)[0];

    // --- ✅ بداية الإصلاح: هذه الدالة الآن لوجيستية فقط ---

    // 1. خصم القيمة من "الأصول المعلقة"
    pendingReturnsValue -= ret.returnedAmount;

    // 2. تحديث المخزون (إضافة القيمة إلى أصل المخزون)
    ret.items.forEach(item => {
        if (ret.returnAtSalePrice) {
            const newProductName = `${item.name} - ${ret.customerName} (مرتجع)`;
            products.push({ name: newProductName, quantity: item.quantity, costPrice: item.costPrice });
        } else {
            const pIndex = products.findIndex(p => p.name === item.name);
            if (pIndex !== -1) {
                const existing = products[pIndex];
                const oldTotalValue = (existing.costPrice || 0) * (existing.quantity || 0);
                const newTotalValue = item.costPrice * item.quantity;
                existing.quantity += item.quantity;
                existing.costPrice = (oldTotalValue + newTotalValue) / existing.quantity;
            } else {
                products.push({ name: item.name, quantity: item.quantity, costPrice: item.costPrice || 0 });
            }
        }
    });

    // 3. نقل المرتجع إلى قائمة المكتملة
    completedReturns.push({ ...ret, status: 'Completed', timestamp: new Date().toISOString() });

    // 4. تسجيل العملية كإجراء لوجيستي فقط
    logOperation("تأكيد استلام مرتجع", `تم تأكيد استلام ${ret.items.map(i=> i.quantity + 'x ' + i.name).join(', ')} في المخزن.`);
    
    // --- ✅ نهاية الإصلاح: تم حذف كل العمليات المالية من هنا ---

    updateUI();
    showGlobalMessage("تم تأكيد استلام البضاعة وتحديث المخزون بنجاح.", false);
}


function pi_addItem() {
    const name = piItemNameInput.value.trim();
    const categoryInput = document.getElementById('pi_item_category');
    const category = categoryInput ? categoryInput.value.trim() : ""; 
    const quantity = parseInt(piItemQuantityInput.value);
    
    // نعتمد على سعر الوحدة كمرجع أساسي لأنه الأدق في التخزين
    const cost = parseFloat(piItemCostInput.value) || 0;
    
    // نستخدم السعر الإجمالي للعرض أو التحقق
    const totalCostInput = document.getElementById('pi_item_total_cost');
    const totalCost = totalCostInput ? (parseFloat(totalCostInput.value) || 0) : (quantity * cost);

    const serialsInput = piItemSerialsTextarea.value.trim();

    // التحقق
    if (!name || isNaN(quantity) || quantity <= 0 || cost < 0) {
        showMessage(piItemAddMessage, "يرجى إدخال البيانات بشكل صحيح.", true);
        return;
    }

    const serials = serialsInput ? serialsInput.split('\n').map(s => s.trim()).filter(Boolean) : [];
    if (serials.length > 0 && serials.length !== quantity) {
         showMessage(piItemAddMessage, `عدد السيريالات (${serials.length}) لا يطابق الكمية (${quantity}).`, true);
        return;
    }

    // نستخدم (الكمية × سعر الوحدة) لضمان الدقة الحسابية في الفاتورة
    const subtotal = quantity * cost; 

    const newRow = document.createElement('tr');
    newRow.dataset.name = name;
    newRow.dataset.category = category;
    newRow.dataset.quantity = quantity;
    newRow.dataset.cost = cost;
    newRow.dataset.subtotal = subtotal;
    newRow.dataset.serials = JSON.stringify(serials);

    newRow.innerHTML = `
        <td class="border p-2">
            ${name} 
            ${category ? `<span class="text-xs text-blue-600 block">(${category})</span>` : ''} 
            ${serials.length > 0 ? `<span class="text-xs text-gray-500 block">(${serials.length} S/N)</span>` : ''}
        </td>
        <td class="border p-2 text-center font-mono">${quantity}</td>
        <td class="border p-2 text-center font-mono">${formatCurrency(cost)}</td>
        <td class="border p-2 text-center font-mono font-bold">${formatCurrency(subtotal)}</td>
        <td class="border p-2 text-center no-print">
            <button type="button" class="pi_remove_item_btn text-red-500 hover:text-red-700 font-bold" title="حذف البند">×</button>
        </td>
    `;
    piItemsBody.appendChild(newRow);

    pi_no_items_msg.classList.add('hidden');
    pi_updateTotals();

    // تنظيف الحقول
    piItemNameInput.value = '';
    if(categoryInput) categoryInput.value = '';
    piItemQuantityInput.value = '1';
    piItemCostInput.value = '0';
    if(totalCostInput) totalCostInput.value = '0'; // تصفير الإجمالي أيضاً
    piItemSerialsTextarea.value = '';
    piItemSerialsContainer.classList.add('hidden');
    showMessage(piItemAddMessage, "");
    piItemNameInput.focus();
}
function pi_clearForm() {
    // 1. مسح الحقول الأساسية
    d('pi_invoice_number').value = '';
    d('pi_date').value = new Date().toISOString().split('T')[0];
    piSupplierSelect.value = '';
    
    // 2. مسح جدول المنتجات
    piItemsBody.innerHTML = '';
    d('pi_no_items_msg').classList.remove('hidden');
    
    // 3. مسح الحقول المالية
    piPaidAmountInput.value = '0';
    d('pi_goods_received').checked = true; // الوضع الافتراضي
    d('pi_deduct_from_liquidity').checked = true; // الوضع الافتراضي
    if(d('pi_payment_account')) d('pi_payment_account').value = ''; // تصفير الحساب

    // 4. (الجزء الجديد) مسح التكاليف الإضافية الديناميكية
    const costsContainer = d('pi_additional_costs_container');
    if (costsContainer) {
        costsContainer.innerHTML = ''; // حذف كل صفوف التكاليف المضافة
    }

    // 5. تحديث الإجماليات لتظهر أصفار
    pi_updateTotals();
    
    // رسائل النظام
    showMessage(piFormMessage, "");
}
/**
 * Validates the entire purchase invoice form before confirmation.
 * @returns {boolean} True if the form is valid, otherwise false.
 */
function pi_validateForm() {
    const pi_supplierSelect = document.getElementById("pi_supplier");
    const piDateInput = d('pi_date');
    const piItemsBody = d('pi_items_body');
    const piGrandTotalSpan = d('pi_grand_total');
    const piPaidAmountInput = d('pi_paid_amount');
    const piFormMessage = d('pi_form_message');
    const deductFromLiquidity = d('pi_deduct_from_liquidity').checked;

    showMessage(piFormMessage, "");
    let errors = [];

    if (!piSupplierSelect || !piSupplierSelect.value) {
        errors.push("يجب اختيار المورد.");
    }
    if (!piDateInput || !piDateInput.value) {
        errors.push("يجب تحديد تاريخ الفاتورة.");
    }
    if (!piItemsBody || piItemsBody.children.length === 0) {
        errors.push("يجب إضافة بند واحد على الأقل للفاتورة.");
    }

    const grandTotal = parseFloat(piGrandTotalSpan.textContent) || 0;
    const paidAmount = parseInputNumber(piPaidAmountInput) || 0;

    if (paidAmount > grandTotal + 0.001) {
        errors.push(`المبلغ المدفوع (${formatCurrency(paidAmount)}) لا يمكن أن يكون أكبر من إجمالي الفاتورة (${formatCurrency(grandTotal)}).`);
    }

    // --- التحقق من رصيد الحساب المحدد ---
    if (deductFromLiquidity && paidAmount > 0) {
        const selectedAccountId = d('pi_payment_account').value;
        const account = accounts.find(acc => acc.id === selectedAccountId);

        if (!account) {
            errors.push("يرجى اختيار حساب الدفع للتحقق من الرصيد.");
        } else if (paidAmount > account.balance) {
            errors.push(`رصيد حساب "${account.name}" (${formatCurrency(account.balance)}) غير كافٍ لتغطية المبلغ المدفوع (${formatCurrency(paidAmount)}).`);
        }
    }
    
    if (errors.length > 0) {
        showMessage(piFormMessage, errors.join('<br>'), true);
        return false;
    }
    return true;
}

/**
 * Updates the list of recent purchases for the current day.
 */
function pi_updateRecentPurchasesDisplay() {
    if (!piRecentPurchasesList) return;

    if (purchaseInvoices.length === 0) {
        piRecentPurchasesList.innerHTML = '<p class="text-center text-gray-500">لا توجد فواتير شراء مسجلة لهذا اليوم بعد.</p>';
        return;
    }

    // Sort by timestamp, newest first
    const sortedInvoices = [...purchaseInvoices].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

    piRecentPurchasesList.innerHTML = sortedInvoices.map(invoice => {
        const supplier = suppliers.find(s => s.id === invoice.supplierId);
        return `
            <div class="p-3 border rounded-md bg-gray-50 shadow-sm mb-2">
                <div class="flex justify-between items-center flex-wrap gap-2">
                    <div>
                        <strong class="text-indigo-600">المورد: ${supplier ? supplier.name : 'غير محدد'}</strong><br>
                        <span class="text-xs text-gray-500">رقم الفاتورة: ${invoice.invoiceNumber || 'N/A'} | التاريخ: ${formatDateForDisplay(invoice.date)}</span>
                    </div>
                    <div class="font-semibold text-blue-700 text-lg">${formatCurrency(invoice.grandTotal)}</div>
                </div>
                <div class="text-sm mt-1 text-gray-600">
                    المدفوع: ${formatCurrency(invoice.paidAmount)} | المتبقي كالتزام: ${formatCurrency(invoice.remainingBalance)}
                </div>
            </div>
        `;
    }).join('');
}
/**
 * Updates the list of pending purchases for the current day.
/**
 * Updates the list of pending purchases for the current day.
 */
function pi_updatePendingPurchasesDisplay() {
    if (!d('pending-purchases-list')) return;
    const container = d('pending-purchases-list');

    if (pendingPurchases.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-500">لا توجد فواتير شراء معلقة حاليًا.</p>';
        return;
    }

    const sortedInvoices = [...pendingPurchases].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

    container.innerHTML = sortedInvoices.map(invoice => {
        const supplier = suppliers.find(s => s.id === invoice.supplierId);

        // --- ✅ الكود الجديد: متغير لتخزين زر التسديد الإضافي ---
        let receiveAndPayButtonHTML = '';
        // أظهر زر "استلام وتسديد" فقط إذا كان هناك مبلغ متبقٍ
        if (invoice.remainingBalance > 0.001) {
            receiveAndPayButtonHTML = `<button data-pending-purchase-id="${invoice.id}" class="receive-and-pay-btn text-xs bg-purple-500 hover:bg-purple-600 text-white font-semibold py-1 px-3 rounded">استلام وتسديد المتبقي</button>`;
        }
        
        const itemsTableHTML = `
            <table class="w-full text-sm mt-2" style="border-top: 1px dashed #e2e8f0;">
                <thead>
                    <tr class="text-gray-600">
                        <th class="p-1 text-right">المنتج</th>
                        <th class="p-1 text-center">الكمية</th>
                        <th class="p-1 text-center">التكلفة</th>
                    </tr>
                </thead>
                <tbody>
                    ${invoice.items.map(item => `
                        <tr class="border-b border-gray-100">
                            <td class="p-1">${item.name}</td>
                            <td class="p-1 text-center font-mono">${item.quantity}</td>
                            <td class="p-1 text-center font-mono">${formatCurrency(item.cost)}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
        
        return `
            <div class="p-3 border rounded-md bg-yellow-50 shadow-sm mb-2">
                <div class="flex justify-between items-center flex-wrap gap-2">
                    <div>
                        <strong class="text-yellow-800">المورد: ${supplier ? supplier.name : 'غير محدد'}</strong><br>
                        <span class="text-xs text-gray-500">رقم الفاتورة: ${invoice.invoiceNumber || 'N/A'} | التاريخ: ${formatDateForDisplay(invoice.date)}</span>
                    </div>
                    <div class="font-semibold text-blue-700 text-lg">${formatCurrency(invoice.grandTotal)}</div>
                </div>

                ${itemsTableHTML}

                <div class="text-sm mt-2 pt-2 border-t flex justify-end gap-2">
                    <button data-pending-purchase-id="${invoice.id}" class="cancel-pending-purchase-btn text-xs bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-3 rounded">إلغاء الشراء</button>
                    ${receiveAndPayButtonHTML} <button data-pending-purchase-id="${invoice.id}" class="receive-goods-btn text-xs bg-green-500 hover:bg-green-600 text-white font-semibold py-1 px-3 rounded">استلام (بقاء الدين)</button>
                </div>
            </div>
        `;
    }).join('');
}
// =======================================================
function handlePendingPurchaseActions(event) {
    const target = event.target.closest('button');
    if (!target) return;

    const pendingId = target.dataset.pendingPurchaseId;
    if (!pendingId) return;

    const purchaseIndex = pendingPurchases.findIndex(p => p.id === pendingId);
    if (purchaseIndex === -1) {
        showGlobalMessage("خطأ: لم يتم العثور على فاتورة الشراء المعلقة.", true);
        return;
    }
    const purchase = pendingPurchases[purchaseIndex];
    const supplier = suppliers.find(s => s.id === purchase.supplierId);

    // --- التعديل هنا: دالة تحديث المخزون المطورة ---
    const updateInventoryFromPurchase = (p) => {
        // 1. حساب إجمالي التكاليف الإضافية (مثل الشحن والعتالة) المسجلة في الفاتورة
        const totalExtraCosts = (p.extraCosts || []).reduce((sum, c) => sum + (Number(c.amount) || 0), 0);
        
        // 2. حساب إجمالي قيمة البضاعة الأساسية لعمل توزيع نسبي عادل
        const totalBaseGoodsValue = p.items.reduce((sum, item) => sum + (item.quantity * item.cost), 0);

        p.items.forEach(item => {
            // 3. توزيع التكاليف الإضافية نسبياً على كل قطعة
            let extraCostPerUnit = 0;
            if (totalBaseGoodsValue > 0 && totalExtraCosts > 0) {
                const itemTotalBaseCost = item.quantity * item.cost;
                const itemShareOfExtra = (itemTotalBaseCost / totalBaseGoodsValue) * totalExtraCosts;
                extraCostPerUnit = itemShareOfExtra / item.quantity;
            }
            
            // التكلفة النهائية للوحدة = السعر الأساسي + نصيبها من المصاريف الإضافية
            const finalUnitCost = item.cost + extraCostPerUnit;

            const productIndex = products.findIndex(prod => prod.name.toLowerCase() === item.name.toLowerCase());
            
            if (productIndex !== -1) {
                // تحديث منتج موجود
                const existing = products[productIndex];
                const oldQty = Number(existing.quantity) || 0;
                const oldCost = Number(existing.costPrice) || 0;
                const totalQty = oldQty + item.quantity;
                
                existing.quantity = totalQty;
                // تحديث متوسط التكلفة بناءً على السعر الشامل الجديد
                existing.costPrice = totalQty > 0 ? ((oldQty * oldCost) + (item.quantity * finalUnitCost)) / totalQty : finalUnitCost;
                
                // ✅ تحديث التصنيف لضمان انتقاله للمخزون
                if (item.category) existing.category = item.category;
            } else {
                // إضافة منتج جديد تماماً
                products.push({ 
                    name: item.name, 
                    quantity: item.quantity, 
                    costPrice: finalUnitCost, 
                    supplierId: p.supplierId,
                    category: item.category || "" // ✅ نقل التصنيف هنا
                });
            }

            // معالجة السيريالات
            if (item.serials && item.serials.length > 0) {
                item.serials.forEach(serial => {
                    if (!serialNumbersLog.some(s => s.serial === serial)) {
                        serialNumbersLog.push({ 
                            serial, 
                            productName: item.name, 
                            supplierId: p.supplierId, 
                            addedTimestamp: p.timestamp, 
                            status: "in_stock" 
                        });
                    }
                });
            }
        });
    };

    // --- باقي العمليات تبقى كما هي تماماً لضمان عدم تعطل النظام ---
    if (target.classList.contains('receive-goods-btn')) {
        if (!confirm(`هل أنت متأكد من استلام بضاعة الفاتورة من المورد "${supplier?.name || '-'}"؟ سيتم توزيع التكاليف الإضافية على البضاعة.`)) return;
        saveStateToHistory();
        updateInventoryFromPurchase(purchase);
        
        if (purchase.remainingBalance > 0.001) {
            liabilities.push({ id: generateId('liab'), name: `متبقي فاتورة لـ: ${supplier.name} (${purchase.invoiceNumber || 'بدون رقم'})`, amount: purchase.remainingBalance, purchaseInvoiceId: purchase.id });
        }
        
        purchase.status = 'Confirmed';
        purchaseInvoices.push(purchase);
        pendingPurchases.splice(purchaseIndex, 1);
        logOperation("استلام بضاعة", `تم استلام بضاعة من "${supplier?.name}" وتوزيع التكاليف وتحديث التصنيفات.`);
        showGlobalMessage("تم استلام البضاعة وتحديث المخزون بالتصنيفات والتكاليف الصحيحة.", false);

    } else if (target.classList.contains('receive-and-pay-btn')) {
        const paymentForm = d('pending-purchase-payment-form');
        d('pp-payment-supplier-name').textContent = supplier?.name || 'غير محدد';
        d('pp-payment-remaining-amount').textContent = formatCurrency(purchase.remainingBalance);
        d('pp-confirm-payment-btn').dataset.pendingId = pendingId;
        paymentForm.classList.remove('hidden');
        paymentForm.scrollIntoView({ behavior: 'smooth' });

    } else if (target.classList.contains('cancel-pending-purchase-btn')) {
        if (!confirm(`هل أنت متأكد من إلغاء فاتورة الشراء المعلقة من المورد "${supplier?.name || '-'}"؟`)) return;
        saveStateToHistory();
        
        if (purchase.deductedFromLiquidity && purchase.paidAmount > 0 && purchase.paidFromAccountId) {
            const accountToRefund = accounts.find(acc => acc.id === purchase.paidFromAccountId);
            if (accountToRefund) {
                accountToRefund.balance += purchase.paidAmount;
                const newTotalLiquidity = accounts.reduce((sum, acc) => sum + acc.balance, 0);
                liquidityLog.push({ id: `liq-${Date.now()}`, type: "add", amount: purchase.paidAmount, description: `إلغاء شراء وإرجاع عربون إلى حساب "${accountToRefund.name}"`, currentBalance: newTotalLiquidity });
            }
        }
        
        pendingPurchases.splice(purchaseIndex, 1);
        logOperation("إلغاء فاتورة شراء معلقة", `تم إلغاء شراء من "${supplier?.name}" بقيمة ${formatCurrency(purchase.grandTotal)}.`);
        showGlobalMessage("تم إلغاء الشراء المعلق بنجاح.", false, true);
    }
    updateUI();
}
async function pi_confirmPurchaseInvoice() {
    // 1. التحقق من صحة البيانات
    if (!pi_validateForm()) {
        return;
    }

    const goodsReceived = d('pi_goods_received').checked;
    const deductFromLiquidity = d('pi_deduct_from_liquidity').checked;
    const paidAmountValue = parseInputNumber(piPaidAmountInput) || 0;
    const selectedAccountId = d('pi_payment_account').value;
    const account = accounts.find(acc => acc.id === selectedAccountId);

    // 2. تجميع بنود البضاعة
    let itemsSubtotal = 0;
    const rawItems = Array.from(piItemsBody.querySelectorAll('tr')).map(row => {
        const q = parseInt(row.dataset.quantity);
        const c = parseFloat(row.dataset.cost);
        itemsSubtotal += (q * c);
        return {
            name: row.dataset.name,
            category: row.dataset.category || "",
            quantity: q,
            cost: c,
            serials: JSON.parse(row.dataset.serials || '[]')
        };
    });

    // 3. تجميع التكاليف الإضافية
    let extraCostsList = [];
    let totalExtraCostsVal = 0;
    let totalLiabilitiesVal = 0; // مجموع التكاليف الآجلة (منفصلة عن المورد)

    document.querySelectorAll('.pi-extra-cost-row').forEach(row => {
        const nameInput = row.querySelector('.pi-cost-name');
        const amountInput = row.querySelector('.pi-cost-amount');
        const liabilityCheckbox = row.querySelector('.pi-cost-liability');
        const liabilitySelect = row.querySelector('.pi-liability-select');

        if (nameInput && amountInput) {
            const name = nameInput.value.trim() || "مصروف إضافي";
            const amount = parseFloat(amountInput.value) || 0;
            const isLiability = liabilityCheckbox ? liabilityCheckbox.checked : false;
            const linkedLiabilityId = (isLiability && liabilitySelect) ? liabilitySelect.value : "";

            if (amount > 0) {
                extraCostsList.push({ name, amount, isLiability, linkedLiabilityId });
                totalExtraCostsVal += amount;
                if (isLiability) totalLiabilitiesVal += amount;
            }
        }
    });

    const trueGrandTotal = itemsSubtotal + totalExtraCostsVal;
    
    // المبلغ المستحق دفعه نقداً للمورد (الإجمالي - التكاليف الآجلة الخارجية)
    const maxCashPayment = trueGrandTotal - totalLiabilitiesVal;

    if (paidAmountValue > (maxCashPayment + 0.5)) {
        showMessage(piFormMessage, `تنبيه: المبلغ المدفوع (${formatCurrency(paidAmountValue)}) أكبر من المستحق نقداً للمورد.`, true);
        return;
    }

    if (deductFromLiquidity && paidAmountValue > 0) {
        if (!selectedAccountId || !account || paidAmountValue > account.balance) {
            showMessage(piFormMessage, `تنبيه: رصيد الحساب غير كافٍ أو لم يتم اختيار حساب.`, true);
            return;
        }
    }

    saveStateToHistory();

    // 4. إنشاء كائن الفاتورة
    const invoiceData = {
        id: generateId('pi'),
        supplierId: piSupplierSelect.value,
        invoiceNumber: piInvoiceNumberInput.value.trim(),
        date: piDateInput.value,
        timestamp: new Date().toISOString(),
        items: rawItems,
        extraCosts: extraCostsList,
        grandTotal: trueGrandTotal,
        paidAmount: paidAmountValue,
        // المتبقي للمورد الأساسي = الإجمالي الكلي - المدفوع - التكاليف الآجلة (لأنها ديون لأطراف أخرى)
        remainingBalance: trueGrandTotal - paidAmountValue - totalLiabilitiesVal,
        status: goodsReceived ? 'Confirmed' : 'Pending',
        deductedFromLiquidity: deductFromLiquidity && paidAmountValue > 0,
        paidFromAccountId: (deductFromLiquidity && paidAmountValue > 0) ? selectedAccountId : null
    };

    const supplier = suppliers.find(s => s.id === invoiceData.supplierId);

    // 5. دالة معالجة المخزون وتوزيع التكاليف
    const processInventoryUpdate = () => {
        invoiceData.items.forEach(item => {
            // توزيع التكاليف الإضافية (سواء نقدية أو آجلة) على تكلفة المنتج
            let extraCostPerUnit = 0;
            if (itemsSubtotal > 0) {
                const itemTotalBaseCost = item.quantity * item.cost;
                const itemShareOfExtra = (itemTotalBaseCost / itemsSubtotal) * totalExtraCostsVal;
                extraCostPerUnit = itemShareOfExtra / item.quantity;
            }
            const finalCostPerUnit = item.cost + extraCostPerUnit;

            const productIndex = products.findIndex(p => p.name.toLowerCase() === item.name.toLowerCase());
            if (productIndex !== -1) {
                const existing = products[productIndex];
                const oldQty = Number(existing.quantity) || 0;
                const oldCost = Number(existing.costPrice) || 0;
                const totalQty = oldQty + item.quantity;
                existing.quantity = totalQty;
                // تحديث متوسط التكلفة
                existing.costPrice = totalQty > 0 ? ((oldQty * oldCost) + (item.quantity * finalCostPerUnit)) / totalQty : finalCostPerUnit;
                if(item.category) existing.category = item.category;
            } else {
                products.push({
                    name: item.name,
                    quantity: item.quantity,
                    costPrice: finalCostPerUnit,
                    supplierId: invoiceData.supplierId,
                    category: item.category || ""
                });
            }
            
            // إضافة السيريالات
            if (item.serials && item.serials.length > 0) {
                item.serials.forEach(serial => {
                    if(!serialNumbersLog.some(s => s.serial === serial)) {
                        serialNumbersLog.push({
                            serial: serial,
                            productName: item.name,
                            supplierId: invoiceData.supplierId,
                            addedTimestamp: invoiceData.timestamp,
                            status: "in_stock"
                        });
                    }
                });
            }
        });
    };

    // 6. تنفيذ العمليات بناءً على حالة الاستلام
    if (goodsReceived) {
        processInventoryUpdate();
        purchaseInvoices.push(invoiceData);
        logOperation("فاتورة شراء", `تم تسجيل فاتورة شراء ${invoiceData.invoiceNumber} من "${supplier ? supplier.name : '-'}".`);
    } else {
        pendingPurchases.push(invoiceData);
        logOperation("شراء معلق", `تم تسجيل شراء معلق من "${supplier ? supplier.name : '-'}".`);
    }

    // 7. الخصم من السيولة (للمورد)
    if (deductFromLiquidity && paidAmountValue > 0) {
        account.balance -= paidAmountValue;
        const newTotalLiquidity = accounts.reduce((sum, acc) => sum + acc.balance, 0);
        liquidityLog.push({
            id: `liq-${Date.now()}`,
            timestamp: new Date().toISOString(),
            type: "remove",
            amount: paidAmountValue,
            description: `دفعة فاتورة شراء ${invoiceData.invoiceNumber} (${supplier ? supplier.name : ''})`,
            currentBalance: newTotalLiquidity,
            accountId: selectedAccountId
        });
    }

    // 8. تسجيل الدين الأساسي للمورد (Remaining Balance)
    if (invoiceData.remainingBalance > 0.001 && goodsReceived) {
        liabilities.push({
            id: generateId('liab'),
            name: `متبقي فاتورة شراء: ${supplier ? supplier.name : 'مورد'} (${invoiceData.invoiceNumber || 'بدون رقم'})`,
            amount: invoiceData.remainingBalance,
            purchaseInvoiceId: invoiceData.id
        });
    }

    // ========================================================================
    // 🔥🔥 الإصلاح الأساسي: تسجيل التكاليف الإضافية الآجلة كالتزامات منفصلة 🔥🔥
   // ========================================================================
// 🔥🔥 الإصلاح: دمج التكلفة مع الالتزام القديم إذا تم اختياره 🔥🔥
// ========================================================================
if (goodsReceived || !goodsReceived) {
    invoiceData.extraCosts.forEach(cost => {
        if (cost.isLiability) {
            let merged = false;

            // 1. التحقق هل اختار المستخدم التزاماً قديماً (linkedLiabilityId)؟
            if (cost.linkedLiabilityId) {
                const existingLiabIndex = liabilities.findIndex(l => l.id === cost.linkedLiabilityId);
                if (existingLiabIndex !== -1) {
                    // تحديث الالتزام القديم بإضافة المبلغ عليه
                    liabilities[existingLiabIndex].amount = (Number(liabilities[existingLiabIndex].amount) || 0) + cost.amount;
                    merged = true;
                }
            }

            // 2. إذا لم يتم الدمج (إما لم يختر قديماً، أو اختار "إنشاء جديد")، ننشئ واحداً جديداً
            if (!merged) {
                liabilities.push({
                    id: generateId('liab'),
                    // هنا سيظهر الاسم الجديد "ت. إضافية..." فقط إذا كان التزاماً جديداً
                    name: `ت. إضافية (${cost.name}) - فاتورة ${invoiceData.invoiceNumber || ''} (${supplier ? supplier.name : ''})`,
                    amount: cost.amount,
                    purchaseInvoiceId: invoiceData.id
                });
            }
        }
    });
}
    // ========================================================================

    // 9. الأرشفة السحابية
    if(window.savePurchaseInvoiceToCloud) {
        window.savePurchaseInvoiceToCloud(invoiceData);
    }

    updateUI();
    pi_clearForm();
    showMessage(piFormMessage, "تم حفظ الفاتورة وتحديث البيانات بنجاح.", false);
}
window.pi_addExtraCostRow = function() {
    const container = document.getElementById('pi_additional_costs_container');
    const noMsg = document.getElementById('pi_no_extra_costs_msg');
    
    if (!container) return;
    if (noMsg) noMsg.style.display = 'none';

    // تجهيز خيارات الالتزامات
    let liabilitiesOptions = '<option value="">-- إنشاء التزام جديد (باسم التكلفة) --</option>';
    if (typeof liabilities !== 'undefined' && Array.isArray(liabilities)) {
        liabilities.forEach(l => {
            liabilitiesOptions += `<option value="${l.id}">${l.name} (مدين بـ: ${l.amount})</option>`;
        });
    }

    const div = document.createElement('div');
    // تصميم البطاقة
    div.className = "pi-extra-cost-row mb-3 p-3 bg-white border border-gray-200 rounded-lg shadow-sm hover:shadow-md transition-all duration-200 group";
    
    div.innerHTML = `
        <div class="flex flex-wrap items-start gap-3">
            
            <div class="flex-grow min-w-[150px]">
                <label class="block text-[10px] text-gray-500 font-bold mb-1">وصف التكلفة</label>
                <input type="text" placeholder="مثلاً: شحن، عتالة" 
                       class="pi-cost-name w-full text-sm border-gray-300 rounded px-2 py-1.5 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-shadow bg-gray-50 focus:bg-white">
            </div>

            <div class="w-28">
                <label class="block text-[10px] text-gray-500 font-bold mb-1">المبلغ</label>
                <div class="relative">
                    <input type="number" placeholder="0" value="" min="0" step="0.01" 
                           class="pi-cost-amount w-full text-sm font-bold text-blue-700 border-gray-300 rounded px-2 py-1.5 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none text-center" 
                           oninput="window.pi_updateTotals()">
                    <span class="absolute left-1 top-1.5 text-[10px] text-gray-400 font-normal pointer-events-none">ج.م</span>
                </div>
            </div>

            <div class="pt-6">
                <button type="button" onclick="this.closest('.pi-extra-cost-row').remove(); window.pi_updateTotals();" 
                        class="text-gray-400 hover:text-red-500 p-1.5 rounded-full hover:bg-red-50 transition-colors" title="حذف هذا البند">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
            </div>
        </div>

        <div class="mt-2 pt-2 border-t border-gray-100 flex flex-col sm:flex-row sm:items-center gap-2">
            
            <label class="flex items-center cursor-pointer select-none">
                <input type="checkbox" class="pi-cost-liability w-4 h-4 text-red-600 rounded border-gray-300 focus:ring-red-500 cursor-pointer" 
                       onchange="
                           const select = this.closest('.pi-extra-cost-row').querySelector('.pi-liability-select');
                           const container = this.closest('.pi-extra-cost-row').querySelector('.liability-options-container');
                           
                           if (this.checked) {
                               container.classList.remove('hidden');
                               container.classList.add('flex');
                               this.parentElement.classList.add('text-red-700');
                           } else {
                               container.classList.add('hidden');
                               container.classList.remove('flex');
                               select.value = ''; 
                               this.parentElement.classList.remove('text-red-700');
                           }
                           window.pi_updateTotals();
                       ">
                <span class="mr-2 text-xs font-bold text-gray-600 transition-colors">تسجيل كدين (آجل)؟</span>
            </label>

            <div class="liability-options-container hidden flex-grow items-center animate-fade-in-down">
                <select class="pi-liability-select w-full text-xs border-yellow-300 bg-yellow-50 rounded text-gray-700 py-1 px-2 focus:ring-1 focus:ring-yellow-500 outline-none">
                    ${liabilitiesOptions}
                </select>
            </div>
        </div>
    `;

    container.appendChild(div);
};
window.pi_updateTotals = function() {
    // 1. حساب إجمالي المنتجات (البضاعة)
    let subtotal = 0;
    const itemsBody = document.getElementById('pi_items_body');
    if (itemsBody) {
        itemsBody.querySelectorAll('tr').forEach(row => {
            subtotal += parseFloat(row.dataset.subtotal) || 0;
        });
    }

    // 2. حساب المصاريف الإضافية + فصل الديون
    let totalExtra = 0;
    let totalLiabilities = 0; 

    document.querySelectorAll('.pi-extra-cost-row').forEach(row => {
        const amountInput = row.querySelector('.pi-cost-amount');
        const liabilityCheckbox = row.querySelector('.pi-cost-liability');
        
        const amount = parseFloat(amountInput.value) || 0;
        // التأكد من قراءة حالة الصندوق بشكل صحيح
        const isLiability = liabilityCheckbox.checked;

        totalExtra += amount;
        
        // إذا كان التزام، نجمعه في متغير الديون لطرحه لاحقاً
        if (isLiability) {
            totalLiabilities += amount;
        }
    });

    // 3. الحسابات النهائية
    const grandTotal = subtotal + totalExtra; // (1000 + 100 + 100) = 1200
    const cashRequired = grandTotal - totalLiabilities; // (1200 - 100) = 1100

    // 4. تحديث الواجهة
    
    // أ. عرض الإجمالي الكلي
    const totalSpan = document.getElementById('pi_grand_total');
    if (totalSpan) totalSpan.textContent = grandTotal.toFixed(2) + " جنيه";

    // ب. عرض المطلوب دفعه نقداً (السطر الجديد)
    const cashRequiredSpan = document.getElementById('pi_cash_required');
    if (cashRequiredSpan) cashRequiredSpan.textContent = cashRequired.toFixed(2) + " جنيه";

    // ج. عرض المبلغ المدفوع
    const paidInput = document.getElementById('pi_paid_amount');
    const paid = paidInput ? (parseFloat(paidInput.value) || 0) : 0;
    
    const paidDisplay = document.getElementById('pi_paid_amount_display');
    if (paidDisplay) paidDisplay.textContent = paid.toFixed(2) + " جنيه";
    
    // د. عرض المتبقي من الكاش المطلوب
    const remaining = cashRequired - paid;

    const remainingSpan = document.getElementById('pi_remaining_balance');
    if (remainingSpan) remainingSpan.textContent = remaining.toFixed(2) + " جنيه";
};

function renderAccounts() {
    const safesGrid = document.getElementById('safes-overview-grid');
    const accountsList = document.getElementById('accounts-list');
    
    // --- ✅ هذه هي المصفوفة الكاملة والنهائية التي تحتوي على كل شيء ---
    const allSafeSelects = [
        // قسم الخزينة والمركز المالي
        '#income-safe-select', '#expense-safe-select', 
        '#transfer-from-select', '#transfer-to-select', 
        '#adjust-safe-select', '#log-filter-safe',
        // ✅ السطر الجديد الذي يجب إضافته
    '#return-from-account-select',
        // قسم إضافة بضاعة
        '#product-purchase-account',
        // قسم فاتورة الشراء
        '#pi_payment_account',
        // قسم البيع السريع
        '#sell-account-select',
        // قسم الفواتير المفصلة
        '#inv_payment_account',
        // قسم الديون (لك)
        '#debt-advance-account', '#debt-payment-account',
        // قسم الالتزامات (عليك)
        '#liability-payment-account',
        // قسم المصروفات
        '#expense-payment-account', '#expense-refund-account',
        // قسم المشتريات المعلقة (الذي به المشكلة الحالية)
        '#pending-purchase-payment-account',
        '#liability-cash-account'
    ];
    
    // --- باقي الدالة يبقى كما هو ---
    if (!safesGrid || !accountsList) return;

    safesGrid.innerHTML = '';
    accountsList.innerHTML = '';
    allSafeSelects.forEach(selector => {
        const select = document.querySelector(selector);
        if (select) select.innerHTML = '<option value="">-- اختر الحساب --</option>';
    });

    let totalBalance = 0;

  

    accounts.forEach(acc => {
        totalBalance += acc.balance;

        const safeCard = document.createElement('div');
        safeCard.className = 'safe-card';
        safeCard.innerHTML = `<h4><i class="fas fa-cash-register"></i> ${acc.name}</h4><div class="safe-card-balance">${formatCurrency(acc.balance)}</div>`;
        safesGrid.appendChild(safeCard);

        const listItem = document.createElement('li');
        listItem.className = 'account-item';
        listItem.innerHTML = `<span class="account-item-name">${acc.name}</span><div class="account-item-actions"><button class="edit-btn" data-id="${acc.id}" style="background-color: #f59e0b;">تعديل</button><button class="delete-btn" data-id="${acc.id}" style="background-color: #ef4444;">حذف</button></div>`;
        accountsList.appendChild(listItem);

        const option = document.createElement('option');
        option.value = acc.id;
        option.textContent = acc.name;
        allSafeSelects.forEach(selector => {
            document.querySelector(selector)?.appendChild(option.cloneNode(true));
        });
    });
    
    const totalCard = document.createElement('div');
    totalCard.className = 'safe-card total-card';
    totalCard.innerHTML = `<h4><i class="fas fa-globe"></i> إجمالي السيولة</h4><div class="safe-card-balance">${formatCurrency(totalBalance)}</div>`;
    safesGrid.appendChild(totalCard);
    
    const allSafesOption = document.createElement('option');
    allSafesOption.value = 'all';
    allSafesOption.textContent = 'كل الحسابات';
    const logFilterSafe = document.querySelector('#log-filter-safe');
    if (logFilterSafe) {
        logFilterSafe.prepend(allSafesOption);
        logFilterSafe.value = 'all';
    }
}

/**
 * Handles switching between tabs in the liquidity section.
 * @param {string} tabId - The ID of the tab content to show.
 */
function showTab(tabId) {
    // هذه الدالة الآن أكثر أمانًا وتتحقق من وجود العناصر قبل التعامل معها
    ['daily-actions', 'adjustments', 'manage-accounts'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.add('hidden');
    });
    ['tab-daily', 'tab-adjust', 'tab-manage'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.remove('active');
    });

    const contentEl = document.getElementById(tabId);
    if (contentEl) contentEl.classList.remove('hidden');

    // --- هذا هو الجزء الذي تم إصلاحه ---
    let buttonId;
    if (tabId === 'adjustments') {
        // حالة خاصة للتبويب الذي يسبب المشكلة
        buttonId = 'tab-adjust';
    } else {
        // المنطق القديم يعمل بشكل صحيح مع باقي التبويبات
        buttonId = `tab-${tabId.split('-')[0]}`;
    }

    const buttonEl = document.getElementById(buttonId);
    if (buttonEl) buttonEl.classList.add('active');
}

/**
 * Resets the "Add/Edit Account" form to its default state.
 */
function resetAccountForm() {
    const accountForm = document.getElementById('account-form');
    const accountIdInput = document.getElementById('account-id-input');
    const accountFormTitle = document.getElementById('account-form-title');
    const saveAccountBtn = document.getElementById('save-account-btn');
    const startingBalanceGroup = document.getElementById('starting-balance-group');
    const cancelEditBtn = document.getElementById('cancel-edit-account-btn');

    accountForm.reset();
    accountIdInput.value = '';
    accountFormTitle.textContent = 'إضافة حساب جديد';
    saveAccountBtn.textContent = 'حفظ الحساب';
    startingBalanceGroup.classList.remove('hidden');
    cancelEditBtn.classList.add('hidden');
}
// =======================================================
// START: NEW LOGIC FOR FINANCIAL TRANSACTIONS (STEP 3)
// =======================================================

/**
 * Handles the logic for adding income to a specified account.
 * @returns {boolean} True on success, false on failure.
 */
function handleIncomeAddition() {
    const accountId = d('income-safe-select').value;
    const category = d('income-category-select').value;
    const amount = parseInputNumber(d('income-amount-input'));

    if (!accountId || isNaN(amount) || amount <= 0) {
        alert("يرجى اختيار حساب وإدخال مبلغ إيراد صحيح.");
        return false;
    }

    const account = accounts.find(acc => acc.id === accountId);
    if (!account) {
        alert("خطأ: الحساب المحدد غير موجود.");
        return false;
    }
    
    saveStateToHistory();
    account.balance += amount;
    logOperation("إضافة إيراد", `إضافة ${formatCurrency(amount)} إلى حساب "${account.name}" تحت فئة "${category}".`);
    // لاحقاً، سنضيف هذا لسجل السيولة المفصل
    return true;
}

function handleExpenseAddition() {
    const accountId = d('expense-safe-select').value;
    const category = d('expense-category-select').value;
    const amount = parseInputNumber(d('expense-amount-input'));

    // 1. التحقق من المدخلات
    if (!accountId || isNaN(amount) || amount <= 0) {
        alert("يرجى اختيار حساب وإدخال مبلغ مصروف صحيح.");
        return false;
    }

    const account = accounts.find(acc => acc.id === accountId);
    if (!account) {
        alert("خطأ: الحساب المحدد غير موجود.");
        return false;
    }

    // 2. التحقق من الرصيد
    if (amount > account.balance) {
        alert(`لا يوجد رصيد كافٍ في حساب "${account.name}". الرصيد المتاح: ${formatCurrency(account.balance)}.`);
        return false;
    }
    
    saveStateToHistory();
    
    // 3. التنفيذ
    
    // أ) خصم من الخزنة
    account.balance -= amount;

    // ب) زيادة إجمالي المصروفات العام
    expenses += amount;

    // ج) تسجيل الحركة في سجل السيولة (يظهر في حركة الخزينة)
    const newTotalLiquidity = accounts.reduce((sum, acc) => sum + acc.balance, 0);
    liquidityLog.push({
        id: `liq-${Date.now()}`,
        timestamp: new Date().toISOString(),
        type: "remove", // نوع remove عشان يظهر باللون الأحمر كسحب
        amount: amount,
        description: `صرف مصروف (${category}) من حساب "${account.name}"`,
        currentBalance: newTotalLiquidity,
        accountId: accountId
    });

    // د) [تعديل هام] توحيد صيغة السجل لتظهر في تقرير المصروفات
    // تم تغيير النوع إلى "تسجيل مصروف" وإضافة كلمة "بقيمة" ليتمكن التقرير من قراءتها
    logOperation("تسجيل مصروف", `بقيمة ${formatCurrency(amount)} - صرف من حساب "${account.name}" (فئة: ${category}).`);
    
    return true;
}
/**
 * Handles the logic for transferring money between two accounts.
 * @returns {boolean} True on success, false on failure.
 */
function handleTransfer() {
    const fromId = d('transfer-from-select').value;
    const toId = d('transfer-to-select').value;
    const amount = parseInputNumber(d('transfer-amount-input'));

    if (!fromId || !toId || isNaN(amount) || amount <= 0) {
        alert("يرجى اختيار الحسابات وإدخال مبلغ صحيح للتحويل.");
        return false;
    }

    if (fromId === toId) {
        alert("لا يمكن التحويل من وإلى نفس الحساب.");
        return false;
    }

    const fromAccount = accounts.find(acc => acc.id === fromId);
    const toAccount = accounts.find(acc => acc.id === toId);

    if (!fromAccount || !toAccount) {
        alert("خطأ: أحد الحسابات المحددة غير موجود.");
        return false;
    }

    if (amount > fromAccount.balance) {
        alert(`لا يوجد رصيد كافٍ في حساب "${fromAccount.name}" لإتمام التحويل.`);
        return false;
    }
    
    saveStateToHistory();
    fromAccount.balance -= amount;
    toAccount.balance += amount;
    logOperation("تحويل بين الحسابات", `تم تحويل ${formatCurrency(amount)} من "${fromAccount.name}" إلى "${toAccount.name}".`);
    return true;
}

/**
 * Handles the logic for manually adjusting an account's balance.
 * @returns {boolean} True on success, false on failure.
 */
function handleBalanceAdjustment() {
    const accountId = d('adjust-safe-select').value;
    const newBalance = parseInputNumber(d('adjust-amount-input'));
    const reason = d('adjust-reason-input').value.trim();

    if (!accountId || isNaN(newBalance) || newBalance < 0) {
        alert("يرجى اختيار حساب وإدخال رصيد جديد صحيح.");
        return false;
    }
    if (!reason) {
        alert("يرجى إدخال سبب التعديل.");
        return false;
    }
    
    const account = accounts.find(acc => acc.id === accountId);
    if (!account) {
        alert("خطأ: الحساب المحدد غير موجود.");
        return false;
    }

    if (confirm(`هل أنت متأكد من تغيير رصيد حساب "${account.name}" إلى ${formatCurrency(newBalance)}؟`)) {
        saveStateToHistory();
        account.balance = newBalance;
        logOperation("تعديل رصيد يدوي", `تم تعديل رصيد حساب "${account.name}" إلى ${formatCurrency(newBalance)}. السبب: ${reason}.`);
        return true;
    }
    return false;
}

async function performSmartGlobalSearch() {
    const searchInput = document.getElementById('smart-search-input');
    const messageEl = document.getElementById('search-message');
    const resultsContainer = document.getElementById('search-results-list');

    if (!searchInput || !messageEl || !resultsContainer) return;

    const term = searchInput.value.trim().toLowerCase();
    
    if (!term) {
        showMessage(messageEl, "يرجى كتابة كلمة للبحث عنها.", true);
        return;
    }

    resultsContainer.innerHTML = '<p class="text-center text-blue-600 py-4"><i class="fas fa-spinner fa-spin"></i> جاري البحث في الأرشيف...</p>';
    showMessage(messageEl, "");

    try {
        if (!window.currentUser) {
            showMessage(messageEl, "يجب تسجيل الدخول للبحث في الأرشيف.", true);
            return;
        }

        const userId = window.currentUser.uid;
        const invoicesRef = window.collection(window.db, "users", userId, "invoices");
        
        // جلب آخر 500 فاتورة (لتحسين الأداء)
        const q = window.query(invoicesRef, window.orderBy("timestamp", "desc"), window.limit(500));
        
        const querySnapshot = await window.getDocs(q);
        const allInvoices = [];
        querySnapshot.forEach((doc) => {
            allInvoices.push(doc.data());
        });

        const matchedInvoices = allInvoices.filter(inv => {
            const customerName = (inv.customerName || '').toLowerCase();
            const invoiceNum = (inv.invoiceNumber || '').toLowerCase();
            const notes = (inv.notes || '').toLowerCase();
            const productsMatch = (inv.items || []).some(item => 
                (item.name || '').toLowerCase().includes(term) || 
                (item.serial || '').toLowerCase().includes(term)
            );
            return customerName.includes(term) || invoiceNum.includes(term) || productsMatch || notes.includes(term);
        });

        // --- التعديل الهام هنا: تخزين النتائج في المتغير العام ---
        globalSearchResults = matchedInvoices;
        // -------------------------------------------------------

        if (matchedInvoices.length === 0) {
            resultsContainer.innerHTML = '<p class="text-center text-gray-500">لم يتم العثور على نتائج مطابقة.</p>';
            showMessage(messageEl, "لا توجد نتائج.", false, true);
        } else {
            displaySearchResults(matchedInvoices);
            showMessage(messageEl, `تم العثور على ${matchedInvoices.length} فاتورة مطابقة.`, false);
        }

    } catch (error) {
        console.error("Search Error:", error);
        showMessage(messageEl, "حدث خطأ أثناء البحث. راجع الـ Console.", true);
        resultsContainer.innerHTML = '<p class="text-center text-red-500">حدث خطأ.</p>';
    }
}

// START: دالة بدء التشغيل النهائية (متصلة بالإنترنت)
// =======================================================
async function initializeApp() {






    console.log("Initializing App with Online-First Logic...");
        // (هنا تضع كل تعريفات المتغيرات التي كانت داخل الدالة القديمة)
    // مثال: mainNav = d("main-nav"); contentSections = document.querySelectorAll(...);
    // ... ضع كل تعريفات d(...) هنا ...
     // --- Assign DOM Element References ---
                 // Monthly Liabilities Elements Assignment
monthlyLiabilityNameInput = d('monthly-liability-name');
monthlyLiabilityAmountInput = d('monthly-liability-amount');
addMonthlyLiabilityButton = d('add-monthly-liability-button');
cancelEditMonthlyLiabilityButton = d('cancel-edit-monthly-liability-button');
monthlyLiabilityMessage = d('monthly-liability-message');
monthlyLiabilitiesList = d('monthly-liabilities-list');
monthlyLiabilityFormTitle = d('monthly-liability-form-title');
// --- Purchase Invoice (PI) Elements Assignment ---
piSupplierSelect = d('pi_supplier');
piInvoiceNumberInput = d('pi_invoice_number');
piDateInput = d('pi_date');
piItemsBody = d('pi_items_body');
piNoItemsMsg = d('pi_no_items_msg');
piItemNameInput = d('pi_item_name');
piItemQuantityInput = d('pi_item_quantity');
piItemCostInput = d('pi_item_cost');
piItemSerialsContainer = d('pi_item_serials_container');
piItemSerialsTextarea = d('pi_item_serials');
piAddItemBtn = d('pi_add_item_btn');
piItemAddMessage = d('pi_item_add_message');
piGrandTotalSpan = d('pi_grand_total');
piPaidAmountInput = d('pi_paid_amount');
piPaidAmountDisplaySpan = d('pi_paid_amount_display');
piRemainingBalanceSpan = d('pi_remaining_balance');
piConfirmBtn = d('pi_confirm_btn');
piSaveDraftBtn = d('pi_save_draft_btn');
piClearFormBtn = d('pi_clear_form_btn');
piFormMessage = d('pi_form_message');
piRecentPurchasesList = d('recent-purchases-list');
// --- Returns Section Elements Assignment ---
searchInvoiceInput = d('search-invoice-input');
searchInvoiceBtn = d('search-invoice-btn');
invoiceSearchResults = d('invoice-search-results');
returnProductSelect = d('return-product-select');
returnQuantityInput = d('return-quantity');
returnCustomerNameInput = d('return-customer-name');
returnAtSalePriceCheckbox = d('return-at-sale-price'); // هذا هو السطر الجديد
returnSalePriceGroup = d('return-sale-price-group');
returnSalePriceInput = d('return-sale-price');
returnCostPriceGroup = d('return-cost-price-group');
returnCostPriceDisplay = d('return-cost-price-display');
returnReceiveNowCheckbox = d('return-receive-now');
confirmManualReturnBtn = d('confirm-manual-return-btn');
returnMessage = d('return-message');
pendingReceiptList = d('pending-receipt-list');
completedReturnsList = d('completed-returns-list');
                 mainNav = d("main-nav");
                 contentSections = document.querySelectorAll(".content-section");
                 navButtons = document.querySelectorAll(".nav-button");
                 globalMessage = d("global-message");
                 currentDataDateDisplay = d("current-data-date");
                 currentTimeDisplay = d("current-time");
                 summaryLiquidity = d("summary-current-liquidity");
                 summaryInventory = d("summary-total-inventory-value");
                 summaryConsignment = d("summary-consignment-value-display");
                 summaryDebts = d("summary-total-debts-display");
                 summaryLiabilities = d("summary-total-liabilities-display");
                 summaryExpenses = d("summary-total-expenses");
                 summaryProfit = d("summary-total-profit");
                 summaryCapital = d("summary-total-capital");
                 productList = d("product-list");
                 addProductButton = d("add-product-button");
                 productNameInput = d("product-name");
                 productQuantityInput = d("product-quantity");
                 productCostPriceInput = d("product-cost-price");
                 productSupplierSelect = d("product-supplier");
                 productDeductLiquidityCheckbox = d("product-deduct-liquidity");
                 serialNumberEntryContainer = d('serial-number-entry-container');
                 productSerialNumbersTextarea = d('product-serial-numbers');
                 serialImportMessage = d('serial-import-message');
                 importSerialCsvInput = d('import-serial-csv-input');
                 productMessage = d("product-message");
                 inventoryTotalInventoryValue = d("inventory-total-inventory-value");
                 inventoryConsignmentValue = d("inventory-consignment-value-display");
                 inventoryTotalProfit = d("inventory-total-profit");
                 cancelEditProductButton = d("cancel-edit-product-button");
                 productFormTitle = d("product-form-title");
                 productNamesDatalist = d("product-names-list");
                 productCategoryInput = d('product-category');
categoryDatalist = d('category-names-list');
inventorySearchInput = d('inventory-search');
inventoryCategoryFilter = d('inventory-category-filter');

                 sellProductNameInput = d("sell-product-name");
                 // --- تفعيل التحديث اللحظي للديون في البيع السريع ---
        ['sell-price', 'sell-quantity', 'sell-paid-amount'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('input', () => {
                    // استدعاء دالة الحساب فور أي تغيير في السعر أو الكمية أو المدفوع
                    if (typeof window.updateQuickSaleDebt === 'function') window.updateQuickSaleDebt();
                });
            }
        });
     // ============================================================
    // >>> انسخ هذا البلوك وضعه تحت السطر السابق مباشرة <<<
    // ============================================================
    // --- ضع هذا الكود داخل دالة initializeApp ---

// تعريف العناصر الجديدة
 piItemQuantityInput = d('pi_item_quantity');
piItemCostInput = d('pi_item_cost');
piItemTotalCostInput = d('pi_item_total_cost');

// 1. عند تغيير الكمية -> تحديث الإجمالي (بناءً على سعر الوحدة)
if (piItemQuantityInput) {
    piItemQuantityInput.addEventListener('input', () => {
        const qty = parseFloat(piItemQuantityInput.value) || 0;
        const cost = parseFloat(piItemCostInput.value) || 0;
        if (piItemTotalCostInput) piItemTotalCostInput.value = (qty * cost).toFixed(2);
        
        // (كود إظهار السيريال القديم)
        if (qty > 0 && d('pi_item_serials_container')) {
            d('pi_item_serials_container').classList.remove('hidden');
        } else if (d('pi_item_serials_container')) {
            d('pi_item_serials_container').classList.add('hidden');
        }
    });
}

// 2. عند تغيير سعر الوحدة -> تحديث الإجمالي
if (piItemCostInput) {
    piItemCostInput.addEventListener('input', () => {
        const qty = parseFloat(piItemQuantityInput.value) || 0;
        const cost = parseFloat(piItemCostInput.value) || 0;
        if (piItemTotalCostInput) piItemTotalCostInput.value = (qty * cost).toFixed(2);
    });
}

// 3. عند تغيير السعر الإجمالي -> حساب سعر الوحدة تلقائياً
if (piItemTotalCostInput) {
    piItemTotalCostInput.addEventListener('input', () => {
        const qty = parseFloat(piItemQuantityInput.value) || 1; // تجنب القسمة على صفر
        const total = parseFloat(piItemTotalCostInput.value) || 0;
        if (qty > 0) {
            piItemCostInput.value = (total / qty).toFixed(2); // حساب سعر الوحدة
        }
    });
}
 // =======================================================
    // منطق استلام العربون (مع التصحيح الذاتي لإنشاء النافذة)
    // =======================================================

    // 1. فتح النافذة (وإنشاؤها إذا لم تكن موجودة)
    window.openDepositModal = function(pendingId) {
        // التأكد من وجود البيانات
        if (typeof pendingSales === 'undefined' || typeof accounts === 'undefined') {
            console.error("Critical Error: Data arrays not found.");
            return;
        }

        const sale = pendingSales.find(s => s.id === pendingId);
        if (!sale) {
            alert("لم يتم العثور على البيعة.");
            return;
        }

        // --- 🛠️ التصحيح الذاتي: إنشاء النافذة في HTML لو مش موجودة ---
        let modal = document.getElementById('depositModal');
        if (!modal) {
            console.log("جاري إنشاء نافذة العربون تلقائياً...");
            modal = document.createElement('div');
            modal.id = 'depositModal';
            modal.className = 'modal'; 
            // ستايل احتياطي لضمان الظهور حتى لو CSS فيه مشكلة
            modal.style.cssText = "display:none; position:fixed; z-index:9999; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5);";
            
            modal.innerHTML = `
                <div class="modal-content" style="background-color:#fff; margin:15% auto; padding:20px; border-radius:8px; width:90%; max-width:400px; position:relative; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <span onclick="document.getElementById('depositModal').style.display='none'" style="position:absolute; left:15px; top:10px; cursor:pointer; font-size:24px; font-weight:bold; color:#666;">&times;</span>
                    
                    <h3 style="margin-top:0; color:#1f2937; border-bottom:1px solid #eee; padding-bottom:10px; font-family:sans-serif;">استلام دفعة / عربون</h3>
                    
                    <div style="margin-top:15px;">
                        <div style="background:#f9fafb; padding:10px; border-radius:6px; margin-bottom:15px; font-size:13px;">
                            <p style="margin:5px 0;"><strong>العميل:</strong> <span id="dep_customer_name">...</span></p>
                            <p style="margin:5px 0;"><strong>إجمالي الفاتورة:</strong> <span id="dep_total_amount" style="color:#2563eb;">0.00</span></p>
                            <p style="margin:5px 0;"><strong>تم دفع سابقاً:</strong> <span id="dep_already_paid" style="color:#16a34a;">0.00</span></p>
                        </div>
                        
                        <div class="form-group" style="margin-bottom:15px;">
                            <label style="display:block; font-size:12px; font-weight:bold; margin-bottom:5px;">المبلغ المستلم الآن:</label>
                            <input type="number" id="dep_amount" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:4px; font-size:16px; font-weight:bold;" placeholder="0.00">
                        </div>
                        
                        <div class="form-group" style="margin-bottom:20px;">
                            <label style="display:block; font-size:12px; font-weight:bold; margin-bottom:5px;">إيداع في الخزنة:</label>
                            <select id="dep_account" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:4px; background:#fff;"></select>
                        </div>
                        
                        <input type="hidden" id="dep_pending_id">
                        
                        <button onclick="window.confirmDeposit()" style="width:100%; background-color:#7c3aed; color:white; padding:12px; border:none; border-radius:6px; font-weight:bold; cursor:pointer; font-size:14px;">تأكيد وحفظ العربون</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        // -------------------------------------------------------

        // تعبئة البيانات (الآن نحن واثقين 100% أن العناصر موجودة)
        document.getElementById('dep_pending_id').value = pendingId;
        document.getElementById('dep_customer_name').textContent = sale.customerName || 'عميل نقدي';
        document.getElementById('dep_total_amount').textContent = formatCurrency(sale.totalSellPrice);
        document.getElementById('dep_already_paid').textContent = formatCurrency(sale.depositPaid || 0);
        
        // اقتراح المبلغ المتبقي
        const remaining = (sale.totalSellPrice || 0) - (sale.depositPaid || 0);
        document.getElementById('dep_amount').value = remaining > 0 ? remaining : '';

        // تعبئة الخزائن
        const select = document.getElementById('dep_account');
        if (select) {
            select.innerHTML = '';
            accounts.forEach(acc => {
                const op = document.createElement('option');
                op.value = acc.id;
                op.textContent = `${acc.name} (${formatCurrency(acc.balance)})`;
                select.appendChild(op);
            });
        }

        // إظهار النافذة
        modal.style.display = 'block';
    };

    // 2. تنفيذ الحفظ
    window.confirmDeposit = function() {
        // التأكد من وجود العناصر قبل القراءة
        const pendingEl = document.getElementById('dep_pending_id');
        const amountEl = document.getElementById('dep_amount');
        const accountEl = document.getElementById('dep_account');

        if (!pendingEl || !amountEl || !accountEl) {
            alert("خطأ داخلي: عناصر النافذة غير موجودة.");
            return;
        }

        const pendingId = pendingEl.value;
        const amount = parseFloat(amountEl.value);
        const accountId = accountEl.value;
        
        if (!amount || amount <= 0) { alert("أدخل مبلغاً صحيحاً."); return; }
        if (!accountId) { alert("اختر الخزنة."); return; }

        const saleIndex = pendingSales.findIndex(s => s.id === pendingId);
        const account = accounts.find(a => a.id === accountId);

        if (saleIndex === -1 || !account) return;

        saveStateToHistory(); // حفظ للتراجع

        // أ. زيادة السيولة
        account.balance += amount;

        // ب. تسجيل العربون في البيعة
        const oldPaid = Number(pendingSales[saleIndex].depositPaid) || 0;
        pendingSales[saleIndex].depositPaid = oldPaid + amount;

        // ج. تسجيل في السجل المالي
        const totalLiquidity = accounts.reduce((sum, a) => sum + a.balance, 0);
        liquidityLog.push({
            id: `liq-dep-${Date.now()}`,
            timestamp: new Date().toISOString(),
            type: "add",
            amount: amount,
            description: `عربون من: ${pendingSales[saleIndex].customerName}`,
            currentBalance: totalLiquidity,
            accountId: account.id
        });

        // إغلاق وتحديث
        document.getElementById('depositModal').style.display = 'none';
        updateUI(); 
        
        // رسالة نجاح
        const msgBox = document.getElementById('global-message');
        if(msgBox) {
            showMessage(msgBox, `تم استلام عربون ${formatCurrency(amount)} بنجاح.`, false);
        } else {
            alert("تم الحفظ بنجاح.");
        }
    };
 
 
 
 
    // 1. ربط عناصر السيريال بالمتغيرات
    sellSerialContainer = d('sell-serial-container');
    sellSerialInput = d('sell-serial-input');
    sellSerialsDatalist = d('sell-serials-datalist');

    // 2. تفعيل الاستماع للكتابة في حقل اسم المنتج
    if (sellProductNameInput) {
        // حذف أي مستمعات قديمة (احتياطياً)
        sellProductNameInput.removeEventListener('input', updateQuickSaleSerialUI);
        
        // إضافة المستمع الجديد لتشغيل دالة السيريال
        sellProductNameInput.addEventListener('input', updateQuickSaleSerialUI);
        sellProductNameInput.addEventListener('change', updateQuickSaleSerialUI);
        
        // الإبقاء على المستمع القديم الخاص بالملحقات (لا تحذفه)
        sellProductNameInput.addEventListener('input', updateAdditionalCostsCheckboxes);
    }
    
    // تأكد من طباعة رسالة في الكونسول لنعرف أن الربط تم
    console.log("تم تفعيل نظام السيريال في البيع السريع:", { 
        container: sellSerialContainer, 
        input: sellSerialInput 
    });

    // ============================================================
                 sellCustomerNameInput = d("sell-customer-name");
                 sellQuantityInput = d("sell-quantity");
                 sellPriceInput = d("sell-price");
                 // --- الجزء المطور لتحديث الدين تلقائياً في البيع السريع ---
if (sellPriceInput) {
    sellPriceInput.addEventListener('input', () => {
        if (typeof window.updateQuickSaleDebt === 'function') window.updateQuickSaleDebt();
    });
}

if (sellQuantityInput) {
    sellQuantityInput.addEventListener('input', () => {
        if (typeof window.updateQuickSaleDebt === 'function') window.updateQuickSaleDebt();
    });
}


// التأكد من ربط حقل المبلغ المدفوع أيضاً
const sellPaidInput = document.getElementById('sell-paid-amount');
if (sellPaidInput) {
    sellPaidInput.addEventListener('input', () => {
        if (typeof window.updateQuickSaleDebt === 'function') window.updateQuickSaleDebt();
    });
}
                 sellButton = d("sell-button");
                 sellMessage = d("sell-message");
                 additionalCostsContainer = d("additional-costs-container");
                 sellPendingCheckbox = d("sell-pending");
                 pendingSalesListContainer = d("pending-sales-list");
                 pendingSalesSearchInput = d('pending-sales-search-input'); // <<< جديد
                 pendingSalesTotalCostSpan = d('pending-sales-total-cost'); // <<< جديد
                 pendingSalesTotalProfitSpan = d('pending-sales-total-profit'); // <<< جديد
                 currentLiquidityDisplay = d("current-liquidity");
                 addLiquidityAmountInput = d("add-liquidity-amount");
                 addLiquiditySourceInput = d("add-liquidity-source");
                 addLiquidityButton = d("add-liquidity-button");
                 removeLiquidityAmountInput = d("remove-liquidity-amount");
                 removeLiquidityReasonInput = d("remove-liquidity-reason");
                 removeLiquidityButton = d("remove-liquidity-button");
                 liquidityMessage = d("liquidity-message");
                 liquidityLogListContainer = d("liquidity-log-list");
                 adjustLiquidityAmountInput = d('adjust-liquidity-amount'); // <<< جديد
                 adjustLiquidityReasonInput = d('adjust-liquidity-reason'); // <<< جديد
                 adjustLiquidityButton = d('adjust-liquidity-button'); // <<< جديد
                 adjustLiquidityMessage = d('adjust-liquidity-message'); // <<< جديد
                 totalExpensesDisplay = d("total-expenses");
                 addExpenseInput = d("add-expense");
                 addExpenseButton = d("add-expense-button");
                
                 removeExpenseInput = d("remove-expense");
                 removeExpenseButton = d("remove-expense-button");
                 expensesMessage = d("expenses-message");
                 totalDebtsDisplay = d("total-debts-display");
                 debtorNameInput = d("debtor-name");
                 addDebtReasonInput = d("add-debt-reason");
                 addDebtAmountInput = d("add-debt-amount");
                 debtDeductLiquidityCheckbox = d("debt-deduct-liquidity");
                 addDebtButton = d("add-debt-button");
                 paymentDebtorSelect = d("payment-debtor-select");
                 paymentAmountInput = d("payment-amount");
                 receivePaymentButton = d("receive-payment-button");
                 debtsMessage = d("debts-message");
                 debtorsListContainer = d("debtors-list");
                 totalLiabilitiesDisplay = d("total-liabilities-display");
                 creditorNameInput = d("creditor-name");
                 addLiabilityAmountInput = d("add-liability-amount");
                 liabilityReceivedCashCheckbox = d("liability-received-cash");
                 addLiabilityButton = d("add-liability-button");
                 paymentCreditorSelect = d("payment-creditor-name");
                 liabilityPaymentAmountInput = d("liability-payment-amount");
                 payLiabilityButton = d("pay-liability-button");
                 liabilitiesMessage = d("liabilities-message");
                 liabilitiesListContainer = d("liabilities-list");
                 offsetDebtorNameInput = d("offset-debtor-name");
                 offsetCreditorNameInput = d("offset-creditor-name");
                 offsetAmountInput = d("offset-amount-input");
                 performTwoPartyOffsetButton = d("perform-two-party-offset-button");
                 offsetMessage = d("offset-message");
                 reportMonthYearInput = d("report-month-year");
                 generateReportButton = d("generate-report-button");
                 reportMessage = d("report-message");
                 salesReportTableBody = d("sales-report-table-body");
                 reportTotalSales = d("report-total-sales");
                 reportTotalCost = d("report-total-cost");
                 reportTotalProfit = d("report-total-profit");
                 operationLogList = d("operation-log-list");
                 clearLogButton = d("clear-log-button");
                 saveButtonAlt = d("save-button-alt");
                 loadDateInputAlt = d("load-date-alt");
                 loadDataButtonAlt = d("load-data-button-alt");
                 loadMessageAlt = d("load-message-alt");
                 loadDateDayNameDisplayAlt = d("load-date-day-name-alt");
                 printButtonAlt = d("print-button-alt");
                 resetButtonAlt = d("reset-button-alt");
                 exportDataButton = d("export-data-button");
                 importFileInput = d("import-file-input");
                 importMessage = d("import-message");
                 supplierNameInput = d("supplier-name");
                 supplierContactInput = d("supplier-contact");
                 supplierAddressInput = d("supplier-address");
                 addSupplierButton = d("add-supplier-button");
                 cancelEditSupplierButton = d("cancel-edit-supplier-button");
                 supplierMessage = d("supplier-message");
                 supplierList = d("supplier-list");
                 supplierFormTitle = d("supplier-form-title");
                 supplierNamesDatalist = d('supplier-names-list');
                 searchSupplierSerialNameInput = d('search-supplier-serial-name');
                 searchSupplierSerialsBtn = d('search-supplier-serials-btn');
                 serialSearchMessage = d('serial-search-message');
                 supplierSerialsResultsContainer = d('supplier-serials-results');
                 filterSerialsContainer = d('filter-serials-container'); // **** إسناد حاوية فلتر السيريالات ****
                 filterSerialsInput = d('filter-serials-input'); // **** إسناد حقل فلتر السيريالات ****
                 inv_modal = d('invoiceModal');
                 inv_openInvoiceModalBtn = d('openInvoiceModalBtn');
                 inv_closeBtn = inv_modal ? inv_modal.querySelector('.modal-close-btn') : null; // Use generic class
                 inv_closeBtnFooter = inv_modal ? inv_modal.querySelector('.modal-close-btn-footer') : null; // Use generic class
                 inv_invoiceForm = d('invoiceForm');
                 inv_customerNameInput = d('inv_customerName');
                 inv_customerAddressInput = d('inv_customerAddress');
                 inv_phoneNumbersContainer = d('inv_phoneNumbersContainer');
                 inv_addPhoneBtn = d('inv_addPhoneBtn');
                 inv_shippingCostInput = d('inv_shippingCost');
                 inv_totalShippingCostSpan = d('inv_totalShippingCost');
                 inv_totalGoodsPriceSpan = d('inv_totalGoodsPrice');
                 inv_grandTotalPriceSpan = d('inv_grandTotalPrice');
                 inv_validationErrorDiv = d('inv_validationError');
                 inv_itemNameInput = d('inv_itemName');
                 inv_itemQtyInput = d('inv_itemQty');
                 inv_itemPriceInput = d('inv_itemPrice');
                 inv_addItemBtn = d('inv_addItemBtn');
                 inv_itemAddErrorDiv = d('inv_itemAddError');
                 inv_invoiceItemsBody = d('inv_invoiceItemsBody');
                 inv_printInvoiceBtn = d('inv_printInvoiceBtn');
                 inv_deductibleCostsContainer = d('inv_deductibleCostsContainer');
                 inv_warrantyInput = d('inv_warranty');
                 inv_notesTextarea = d('inv_notes');
                 inv_saveInvoiceBtn = d('inv_saveInvoiceBtn');
        // ... داخل دالة initializeApp ...

    // 1. تعريف المتغيرات (مع استخدام d مباشرة للتأكد)
    inv_serialSelectContainer = d('inv_serialSelectContainer');
    
    // استخدمنا const هنا داخل النطاق لضمان عدم التداخل
    const invItemSerialInputEl = d('inv_itemSerialInput'); 
    const invSerialsDatalistEl = d('inv_serials_datalist');

 // 2. المنطق الجديد (محصن بـ try-catch لمنع أي خطأ نهائياً)
    if (inv_itemNameInput && inv_itemQtyInput) {
        
        const checkInvoiceSerialRequirement = () => {
            try {
                const itemName = inv_itemNameInput.value.trim();
                const qty = parseInt(inv_itemQtyInput.value);
                
                // البحث عن العناصر مباشرة
                const container = document.getElementById('inv_serialSelectContainer');
                const inputField = document.getElementById('inv_itemSerialInput');
                const datalist = document.getElementById('inv_serials_datalist');

                // إذا لم نجد الحاوية، نخرج بصمت
                if (!container) return;

                if (qty === 1 && itemName) {
                    container.classList.remove('hidden');
                    // ملء المقترحات
                    if (datalist && typeof serialNumbersLog !== 'undefined') {
                        const availableSerials = serialNumbersLog.filter(log => log.productName === itemName && log.status === 'in_stock');
                        datalist.innerHTML = availableSerials.map(s => `<option value="${s.serial}">`).join('');
                    }
                } else {
                    container.classList.add('hidden');
                    // محاولة مسح الحقل فقط إذا كان موجوداً
                    if (inputField) {
                        inputField.value = ''; 
                    }
                }
            } catch (e) {
                // في حال حدوث أي خطأ، لا تفعل شيئاً (تجاهل الخطأ)
                console.log("تم تجاهل خطأ في واجهة السيريال");
            }
        };

        inv_itemNameInput.addEventListener('input', checkInvoiceSerialRequirement);
        inv_itemNameInput.addEventListener('change', checkInvoiceSerialRequirement);
        inv_itemQtyInput.addEventListener('input', checkInvoiceSerialRequirement);
    }
    
           // **** إسناد عناصر نافذة إدارة السيريالات ****
                 manageSerialsModal = d('manageSerialsModal');
                 modal_productNameDisplay = d('modal_productNameDisplay');
                 modal_serialCounts = d('modal_serialCounts');
                 modal_totalQuantity = d('modal_totalQuantity');
                 modal_registeredCount = d('modal_registeredCount');
                 modal_unregisteredCount = d('modal_unregisteredCount');
                 modal_productSerialNumbers = d('modal_productSerialNumbers');
                 modal_maxSerialsToAdd = d('modal_maxSerialsToAdd');
                 modal_serialImportMessage = d('modal-serial-import-message');
                 modal_importSerialCsvInput = d('modal-import-serial-csv-input');
                 modal_registeredSerialsList = d('modal-registered-serials-list');
                 modal_saveAddedSerialsBtn = d('modal_saveAddedSerialsBtn');
                 modal_closeBtns = manageSerialsModal ? manageSerialsModal.querySelectorAll('.modal-close-btn, .modal-close-btn-footer') : [];

                 debtorNamesDatalistOffset = d('debtor-names-list-offset');
                 creditorNamesDatalistOffset = d('creditor-names-list-offset');
                  // --- تعريف عناصر البحث الذكي الجديد ---
// نحتفظ بحاويات الرسائل والنتائج لأننا ما زلنا نستخدمها
searchMessageContainer = d('search-message');
searchResultsListContainer = d('search-results-list');

// تعريف عناصر الإدخال والزر الجديد
const smartSearchBtn = d('smart-search-btn');
const smartSearchInput = d('smart-search-input');

                 openBackupHistoryButton = d('open-backup-history-button');
autoBackupMessage = d('auto-backup-message');
backupHistoryModal = d('backupHistoryModal');
backupHistoryList = d('backup-history-list');
                  // --- Financial Center (FC) Elements ---
fc_main_tabs = d('fc-main-tabs');
fc_tab_buttons = document.querySelectorAll('.fc-tab-button');
fc_tab_contents = document.querySelectorAll('.fc-tab-content');
fc_month_select = d('fc-distribution-month');
fc_expenses_list = d('fc-expenses-to-distribute-list');
fc_products_list = d('fc-products-to-load-list');
fc_total_expenses_display = d('fc-total-selected-expenses');
fc_preview_container = d('fc-cost-preview-container');
fc_preview_results = d('fc-cost-preview-results');
fc_manual_container = d('fc-manual-distribution-container');
fc_manual_list = d('fc-manual-percentage-list');
fc_percentage_feedback = d('fc-percentage-total-feedback');
fc_percentage_total = d('fc-percentage-total');
fc_expenses_wrapper = d('fc-expenses-selection-wrapper');
fc_manual_cost_wrapper = d('fc-manual-cost-input-wrapper');
fc_manual_cost_input = d('fc-manual-cost-input');
fc_debt_select = d('fc-debt-to-process');
fc_execute_dist_btn = d('fc-execute-distribution-btn');
fc_execute_debt_btn = d('fc-execute-debt-treatment-btn');


    // ربط مستمعات الأحداث (event listeners)
    // ... ضع كل addEventListener هنا ...
    // مثال: if (saveButtonAlt) { saveButtonAlt.addEventListener(...); }
     // --- Attach Event Listeners ---
                 // Monthly Liabilities Listeners
if (addMonthlyLiabilityButton) { addMonthlyLiabilityButton.addEventListener('click', addOrUpdateMonthlyLiability); }
if (cancelEditMonthlyLiabilityButton) { cancelEditMonthlyLiabilityButton.addEventListener('click', resetMonthlyLiabilityForm); }
if (monthlyLiabilitiesList) {
    monthlyLiabilitiesList.addEventListener('click', (e) => {
        const target = e.target.closest('button');
        if (!target) return;
        const liabilityId = target.dataset.id;
        if (!liabilityId) return;

        if (target.classList.contains('edit-monthly-liability-btn')) {
            const liability = monthlyLiabilities.find(l => l.id === liabilityId);
            if (liability) {
                editingMonthlyLiabilityId = liability.id;
                monthlyLiabilityNameInput.value = liability.name;
                monthlyLiabilityAmountInput.value = liability.amount;
                monthlyLiabilityFormTitle.textContent = `تعديل: ${liability.name}`;
                addMonthlyLiabilityButton.textContent = "تحديث";
                cancelEditMonthlyLiabilityButton.classList.remove('hidden');
                d('add-update-monthly-liability-form').scrollIntoView({ behavior: 'smooth' });
            }
        } else if (target.classList.contains('delete-monthly-liability-btn')) {
            const liabilityIndex = monthlyLiabilities.findIndex(l => l.id === liabilityId);
            if (liabilityIndex > -1) {
                 const liabilityName = monthlyLiabilities[liabilityIndex].name;
                 if (confirm(`هل أنت متأكد من حذف الالتزام الشهري "${liabilityName}"؟`)) {
                     monthlyLiabilities.splice(liabilityIndex, 1);
                     logOperation("حذف التزام شهري", `تم حذف الالتزام الشهري الدائم "${liabilityName}".`);
                     showMessage(monthlyLiabilityMessage, `تم حذف "${liabilityName}".`);
                     updateUI();
                 }
            }
        }
    });
}
                 if (mainNav) { mainNav.addEventListener('click', (e) => { if (e.target.tagName === 'BUTTON' && e.target.classList.contains('nav-button')) { const targetId = e.target.dataset.target; contentSections.forEach(section => { section.classList.add('hidden'); }); const targetSection = d(targetId); if (targetSection) { targetSection.classList.remove('hidden'); } navButtons.forEach(button => { button.classList.remove('active'); }); e.target.classList.add('active'); } }); }
                 // --- Financial Center Tabs Listener ---
if (fc_main_tabs) {
    fc_main_tabs.addEventListener('click', (e) => {
        const button = e.target.closest('.fc-tab-button');
        if (!button) return; // إذا لم يتم الضغط على زر، لا تفعل شيئاً

        // 1. أزل علامة "نشط" من كل الأزرار
        fc_tab_buttons.forEach(btn => btn.classList.remove('active'));
        // 2. أضف علامة "نشط" للزر الذي تم الضغط عليه
        button.classList.add('active');

        // 3. أخفِ جميع أقسام المحتوى
        fc_tab_contents.forEach(content => content.classList.add('hidden'));
        
        // 4. أظهر القسم المرتبط بالزر الذي تم الضغط عليه
        const targetId = button.dataset.target;
        const targetContent = d(targetId);
        if (targetContent) {
            targetContent.classList.remove('hidden');
        }

        // 5. قم بتعبئة بيانات القسم الذي تم إظهاره (مهم جداً)
        if (targetId === 'fc-tab-distribution') {
            fc_populate_month_select(); // تعبئة قائمة الشهور
        } else if (targetId === 'fc-tab-debt-treatment') {
            fc_populate_debt_treatment(); // تعبئة قائمة الديون
        }
    });
}

                 // ... داخل دالة initializeApp() مع باقي الـ event listeners


if (d('undo-button')) { d('undo-button').addEventListener('click', undo); }
if (d('redo-button')) { d('redo-button').addEventListener('click', redo); }
               if (saveButtonAlt) {
    saveButtonAlt.addEventListener("click", async () => {
        // تحديد التاريخ المستهدف
        const todayString = getTodayDateString();
        const targetDate = currentLoadedDate || todayString;
        
        // رسالة التأكيد
        let confirmMsg = `هل تريد حفظ التغييرات لتاريخ ${formatDateForDisplay(targetDate)}؟`;
        
        // التحقق من وجود بيانات سابقة محلياً (اختياري للتحذير)
        if (typeof lsPrefix !== 'undefined') {
            const storageKey = lsPrefix + targetDate;
            if (localStorage.getItem(storageKey)) {
                if (currentLoadedDate === targetDate) {
                    confirmMsg += `\n(سيتم تحديث البيانات الحالية)`;
                } else {
                    confirmMsg = `أنت تعرض بيانات يوم ${formatDateForDisplay(currentLoadedDate)}. هل تريد الحفظ فوق بيانات يوم ${formatDateForDisplay(targetDate)}؟`;
                }
            }
        }

        if (confirm(confirmMsg)) {
            // تغيير نص الزر ليدل على التحميل
            const originalText = saveButtonAlt.textContent;
            saveButtonAlt.textContent = "جاري الحفظ...";
            saveButtonAlt.disabled = true;
            
            await saveCurrentStateByDate(targetDate);
            
            // إعادة الزر لحالته الطبيعية
            saveButtonAlt.textContent = originalText;
            saveButtonAlt.disabled = false;
        }
    });
}
  if (loadDataButtonAlt) { loadDataButtonAlt.addEventListener("click", async () => { const dateToLoad = loadDateInputAlt ? loadDateInputAlt.value : null; const loadResult = loadDataForDate(dateToLoad); if(loadResult) updateUI(); }); } // Update UI only if loadDataForDate indicates a change happened
                 if (loadDateInputAlt) { loadDateInputAlt.addEventListener('change', (e) => { const dateValue = e.target.value; updateLoadDateDayName(dateValue, loadDateDayNameDisplayAlt); }); }
                 if (clearLogButton) { clearLogButton.addEventListener("click", () => { if (confirm("هل أنت متأكد من رغبتك في مسح سجل عمليات اليوم الحالي المعروض؟ لن يتم حفظ هذا التغيير إلا بالضغط على زر الحفظ.")) { operationLog = []; updateLogDisplay(); showGlobalMessage("تم مسح سجل اليوم الحالي من العرض. اضغط 'حفظ' لتثبيت التغيير.", false, true); } }); }
                // 🎯🎯🎯 الكود المعدل للزر الأحمر 🎯🎯🎯
if (resetButtonAlt) { 
    resetButtonAlt.addEventListener("click", () => { 
        // رسالة تأكيد جديدة وأكثر وضوحًا
        if (confirm("تحذير خطير: سيتم مسح كل البيانات المعروضة على الشاشة نهائيًا (المخزون، الموردين، الديون، إلخ) والبدء من جديد. هذا الإجراء لا يمكن التراجع عنه. هل أنت متأكد؟")) { 
            resetAllData(); // 👈🏻 يستدعي الدالة الجديدة الشاملة
        } 
    }); 
}
                 if (printButtonAlt) { printButtonAlt.addEventListener("click", () => { document.body.classList.add('print-report'); // Add class for print styling
                      const reportHTML = generateReportHTML(); const printWindow = window.open('', '_blank', 'height=600,width=800'); if (printWindow) { printWindow.document.open(); printWindow.document.write(reportHTML); printWindow.document.close(); setTimeout(() => { try { printWindow.focus(); printWindow.print(); // printWindow.close(); // Optional: close after printing
                      } catch (e) { console.error("Print error:", e); showGlobalMessage("حدث خطأ أثناء محاولة الطباعة.", true); } finally { document.body.classList.remove('print-report'); // Remove class after printing attempt
                      } }, 500); } else { showGlobalMessage('فشل فتح نافذة الطباعة. يرجى السماح بالنوافذ المنبثقة.', true); document.body.classList.remove('print-report'); } }); }
                 if (exportDataButton) { exportDataButton.addEventListener("click", exportData); }
                 if (importFileInput) { importFileInput.addEventListener("change", importData); }
                 // **** جديد: مستمع حدث لزر استيراد CSV للسيريالات (في قسم إضافة البضاعة) ****
                 if (importSerialCsvInput) {
                     importSerialCsvInput.addEventListener("change", (event) => importSerialCSV(event, productSerialNumbersTextarea, serialImportMessage));
                 }
                  // **** جديد: مستمع حدث لزر استيراد CSV للسيريالات (في نافذة الإدارة) ****
                 if (modal_importSerialCsvInput) {
                     modal_importSerialCsvInput.addEventListener("change", (event) => importSerialCSV(event, modal_productSerialNumbers, d('modal-serial-import-message')));
                 }

               // استبدل هذا الكود بالكامل داخل دالة initializeApp
if (addProductButton) {
    addProductButton.addEventListener("click", () => {
        saveStateToHistory();
        const name = productNameInput.value.trim();
        const quantity = parseInputNumber(productQuantityInput);
        const costPrice = parseInputNumber(productCostPriceInput);
        const supplierId = productSupplierSelect.value;
        const category = productCategoryInput.value.trim();
        const deductLiquidity = productDeductLiquidityCheckbox.checked;
        const selectedAccountId = d('product-purchase-account').value;
        const account = accounts.find(acc => acc.id === selectedAccountId);
        const serialNumbersInput = productSerialNumbersTextarea ? productSerialNumbersTextarea.value.trim() : '';

        if (!name || isNaN(quantity) || quantity < 0 || isNaN(costPrice) || costPrice < 0) {
            showMessage(productMessage, "يرجى ملء اسم وكمية (>=0) وسعر تكلفة (>=0) المنتج بشكل صحيح.", true);
            return;
        }

        if (deductLiquidity && !selectedAccountId) {
            showMessage(productMessage, "يرجى اختيار الحساب الذي سيتم الخصم منه.", true);
            return;
        }

        if (editingProductName) {
            // منطق التعديل
            const productIndex = products.findIndex(p => p.name === editingProductName);
            if (productIndex === -1) return;
            
            // ... (باقي منطق التعديل كما هو) ...
            products[productIndex].name = name;
            products[productIndex].category = category;
            products[productIndex].quantity = quantity;
            products[productIndex].costPrice = costPrice;
            products[productIndex].supplierId = supplierId;
            showMessage(productMessage, `تم تحديث المنتج "${name}" بنجاح.`);
            resetProductForm();

        } else {
            // منطق الإضافة الجديدة
            const existingIndex = products.findIndex(p => p.name.toLowerCase() === name.toLowerCase());
            let newQuantity = Number(quantity);
            const newCostPriceInput = Number(costPrice);

         if (existingIndex !== -1) {
                 // منتج موجود مسبقاً
                 if (newQuantity <= 0) { showMessage(productMessage, "الكمية المضافة يجب أن تكون أكبر من صفر.", true); return; }
                 const existing = products[existingIndex];
                 
                 if (deductLiquidity && newQuantity > 0) {
                    const costToDeduct = newQuantity * newCostPriceInput;
                    if (costToDeduct > account.balance) {
                        showMessage(productMessage, `لا توجد سيولة كافية في حساب "${account.name}".`, true);
                        return;
                    }
                    // 1. خصم من حساب السيولة
                    account.balance -= costToDeduct;
                    // 2. إضافة إلى إجمالي المصروفات العامة
                    expenses += costToDeduct; 
                    
                    // 3. التسجيل في سجل السيولة (الخزينة)
                    liquidityLog.push({
                        id: `liq-${Date.now()}`,
                        timestamp: new Date().toISOString(),
                        type: "remove",
                        amount: costToDeduct,
                        description: `شراء كمية إضافية: ${newQuantity}x ${name}`,
                        currentBalance: accounts.reduce((s, a) => s + a.balance, 0),
                        accountId: selectedAccountId
                    });

                    // 4. التسجيل في السجل العام
                    logOperation("شراء بضاعة", `خصم ${formatCurrency(costToDeduct)} من حساب "${account.name}" لشراء ${newQuantity}x ${name}.`);
                } else {
                    // ✅ تم الإضافة: تسجيل في السجل العام حتى لو لم يتم الخصم من السيولة
                    logOperation("تسجيل بضاعة", `تم إضافة كمية ${newQuantity} من "${name}" للمخزون (بدون خصم من السيولة).`);
                }

                // تحديث بيانات المنتج
                const oldQuantity = Number(existing.quantity) || 0;
                const oldCostPrice = Number(existing.costPrice) || 0;
                const totalQuantity = oldQuantity + newQuantity;
                existing.quantity = totalQuantity;
                existing.costPrice = ((oldQuantity * oldCostPrice) + (newQuantity * newCostPriceInput)) / totalQuantity;
                existing.supplierId = supplierId || existing.supplierId;
                existing.category = category || existing.category;
                showMessage(productMessage, `تم تحديث المنتج "${name}".`);
                 } else {
                // منتج جديد كلياً
                if (newQuantity <= 0) { showMessage(productMessage, "كمية المنتج الجديد يجب أن تكون أكبر من صفر.", true); return; }

                if (deductLiquidity && newQuantity > 0) {
                    const costToDeduct = newQuantity * costPrice;
                    if (costToDeduct > account.balance) {
                        showMessage(productMessage, `لا توجد سيولة كافية في حساب "${account.name}".`, true);
                        return;
                    }
                    // 1. خصم السيولة وتحديث المصروفات
                    account.balance -= costToDeduct;
                    expenses += costToDeduct;

                    // 2. التسجيل في سجل السيولة (الخزينة)
                    liquidityLog.push({
                        id: `liq-${Date.now()}`,
                        timestamp: new Date().toISOString(),
                        type: "remove",
                        amount: costToDeduct,
                        description: `شراء منتج جديد: ${newQuantity}x ${name}`,
                        currentBalance: accounts.reduce((s, a) => s + a.balance, 0),
                        accountId: selectedAccountId
                    });

                    // 3. التسجيل في السجل العام
                    logOperation("شراء بضاعة جديدة", `خصم ${formatCurrency(costToDeduct)} من حساب "${account.name}" لشراء منتج جديد: ${name}.`);
                } else {
                    // ✅ تم الإضافة: تسجيل في السجل العام بدون خصم سيولة
                    logOperation("تسجيل منتج جديد", `إضافة منتج جديد "${name}" بكمية ${newQuantity} (بدون خصم من السيولة).`);
                }

                products.push({ name, quantity: newQuantity, costPrice, supplierId: supplierId || "", category: category });
                showMessage(productMessage, "تمت إضافة المنتج الجديد بنجاح.");
            }
            resetProductForm();
        }
        updateUI();
    });
}
const btnResetExpenses = document.getElementById("reset-expenses-button");

if (btnResetExpenses) {
    btnResetExpenses.addEventListener("click", () => {
        
        if (confirm(`تحذير: سيتم تصفير عداد المصروفات ومسح جميع سجلات المصروفات لهذا اليوم من الذاكرة المؤقتة.\n\nهل أنت متأكد؟`)) {
            
            // 1. حفظ نسخة للتراجع
            saveStateToHistory(); 
            
            const oldExpenses = expenses;
            
            // 2. تصفير المتغير الأساسي (الذاكرة)
            expenses = 0;
            
            // 3. تنظيف سجل العمليات (ذاكرة السجل النصي)
            // نستخدم دالة includes لحذف أي نوع يحتوي على كلمة "مصروف" أو "سحب" لضمان الشمولية
            if (typeof operationLog !== 'undefined') {
                operationLog = operationLog.filter(log => {
                    const type = (log.type || "").toString();
                    return !type.includes("مصروف") && !type.includes("سحب");
                });
            }
            
            // 4. تنظيف سجل السيولة (ذاكرة السجل المالي)
            if (typeof liquidityLog !== 'undefined') {
                 liquidityLog = liquidityLog.filter(log => {
                     const desc = (log.description || "").toString();
                     return !desc.includes("صرف مصروف") && !desc.includes("تسجيل مصروف") && !desc.includes("سحب");
                 });
            }

            // 5. تسجيل عملية التصفير (للتوثيق فقط)
            logOperation("تصفير شامل", `تم تصفير العداد يدوياً (كان ${formatCurrency(oldExpenses)}).`);
            
            // 6. === الخطوة الحاسمة: إجبار الواجهة على التحديث فوراً ===
            // نحدث النص مباشرة دون انتظار updateUI
            if (typeof totalExpensesDisplay !== 'undefined' && totalExpensesDisplay) {
                totalExpensesDisplay.textContent = formatCurrency(0);
            }
            
            // إذا كان جدول تقرير المصروفات مفتوحاً، نقوم بمسحه فوراً ليعكس التصفير
            const reportTableBody = document.getElementById('expenses-report-table-body');
            const reportSummary = document.getElementById('exp-report-summary-total');
            if (reportTableBody) {
                reportTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500 py-4">تم تصفير العداد. اضغط "عرض التقرير" مجدداً بعد الحفظ.</td></tr>';
            }
            if (reportSummary) {
                reportSummary.textContent = formatCurrency(0);
            }

            // 7. تحديث باقي الواجهة
            updateUI(); 
            
            // رسالة تأكيد
            const reportMsg = document.getElementById('exp-report-message');
            if (reportMsg) {
                showMessage(reportMsg, "تم التصفير فوراً. اضغط 'حفظ التغييرات' لتثبيت الحذف في قاعدة البيانات.", false);
            } else {
                alert("تم التصفير فوراً.\nتنبيه: اضغط 'حفظ التغييرات' لتثبيت هذا التغيير في قاعدة البيانات.");
            }
        }
    });
}
// أضف هذا الكود أيضًا لإظهار وإخفاء قائمة الحسابات
if (productDeductLiquidityCheckbox) {
    productDeductLiquidityCheckbox.addEventListener('change', (e) => {
        const container = d('product-purchase-account-container');
        if (e.target.checked) {
            container.classList.remove('hidden');
        } else {
            container.classList.add('hidden');
        }
    });
}
                 // **** مستمع حدث حقل الكمية لإظهار/إخفاء حقل السيريال ****
                 if (productQuantityInput && serialNumberEntryContainer) {
                     productQuantityInput.addEventListener('input', () => {
                         const quantity = parseInputNumber(productQuantityInput);
                         // أظهر حقل السيريال فقط عند إضافة كمية جديدة (ليس في وضع التعديل وليس كمية صفر)
                         if (!editingProductName && !isNaN(quantity) && quantity > 0) {
                             serialNumberEntryContainer.classList.remove('hidden');
                         } else {
                             serialNumberEntryContainer.classList.add('hidden');
                             if(productSerialNumbersTextarea) productSerialNumbersTextarea.value = ''; // أفرغ الحقل عند إخفائه
                             if(serialImportMessage) showMessage(serialImportMessage, ''); // امسح رسالة الاستيراد
                         }
                     });
                     // قم بإخفائه أيضاً عند إلغاء التعديل
                     if(cancelEditProductButton) {
                         cancelEditProductButton.addEventListener('click', () => {
                              serialNumberEntryContainer.classList.add('hidden');
                              if(productSerialNumbersTextarea) productSerialNumbersTextarea.value = '';
                              if(serialImportMessage) showMessage(serialImportMessage, '');
                         });
                     }
                 }

                 if (cancelEditProductButton) { cancelEditProductButton.addEventListener('click', resetProductForm); }
                 if (productList) {
                     productList.addEventListener('click', (e) => {
                         const target = e.target.closest('button');
                         if (!target) return;
                         const productName = target.dataset.productName;
                         if (!productName) return;

                         if (target.classList.contains('edit-product-btn')) {
                             const productToEdit = products.find(p => p.name === productName);
                             if (productToEdit && productNameInput && productQuantityInput && productCostPriceInput && productSupplierSelect && addProductButton && productFormTitle && cancelEditProductButton) {
                                 editingProductName = productName;
                                 productNameInput.value = productToEdit.name;
                                 productQuantityInput.value = productToEdit.quantity;
                                 productCostPriceInput.value = productToEdit.costPrice;
                                 productSupplierSelect.value = productToEdit.supplierId || "";
                                 productCategoryInput.value = productToEdit.category || "";
                                 addProductButton.textContent = "تحديث المنتج";
                                 addProductButton.classList.remove('bg-green-500', 'hover:bg-green-600');
                                 addProductButton.classList.add('bg-blue-500', 'hover:bg-blue-600');
                                 productFormTitle.textContent = `تعديل المنتج: ${productName}`;
                                 cancelEditProductButton.classList.remove('hidden');
                                 serialNumberEntryContainer.classList.add('hidden'); // Ensure serial field is hidden during edit mode
                                 if(productSerialNumbersTextarea) productSerialNumbersTextarea.value = '';
                                 d('add-update-product-form').scrollIntoView({ behavior: 'smooth' });
                             } else {
                                 showMessage(productMessage, `لم يتم العثور على المنتج "${productName}" للتعديل أو عناصر النموذج غير جاهزة.`, true);
                             }
                         } else if (target.classList.contains('delete-product-btn')) {
                             if (confirm(`هل أنت متأكد من حذف المنتج "${productName}"؟ سيتم حذف جميع الأرقام التسلسلية المرتبطة به أيضاً.`)) {
                                 saveStateToHistory();
                                 const initialLength = products.length;
                                 products = products.filter(p => p.name !== productName);
                                 // **** حذف السيريالات المرتبطة بالمنتج المحذوف ****
                                 const initialSerialCount = serialNumbersLog.length;
                                 serialNumbersLog = serialNumbersLog.filter(log => log.productName !== productName);
                                 const deletedSerialCount = initialSerialCount - serialNumbersLog.length;
                                 if (products.length < initialLength) {
                                     logOperation("حذف منتج", `تم حذف المنتج "${productName}". تم حذف ${deletedSerialCount} رقم تسلسلي مرتبط.`);
                                     showMessage(productMessage, `تم حذف المنتج "${productName}" و ${deletedSerialCount} رقم تسلسلي مرتبط بنجاح.`);
                                     if (editingProductName === productName) { resetProductForm(); }
                                     updateUI();
                                 }
                             }
                         } else if (target.classList.contains('manage-serials-btn')) { // **** جديد: التعامل مع زر إدارة السيريالات ****
                             openManageSerialsModal(productName);
                         }
                     
                     });
                 }
                 if (inventorySearchInput) { inventorySearchInput.addEventListener('input', updateProductListDisplay); }
if (inventoryCategoryFilter) { inventoryCategoryFilter.addEventListener('change', updateProductListDisplay); }
// =======================================================
// START: Debt Actions Event Listener (FIXED)
// =======================================================
if (debtorsListContainer) {
    debtorsListContainer.addEventListener('click', (e) => {
        const payButton = e.target.closest('.pay-partial-debt-btn');
        if (payButton) {
            const debtId = payButton.dataset.debtId;
            if (debtId) {
                openPartialDebtPaymentModal(debtId);
            }
        }
    });
}
// =======================================================
// END: Debt Actions Event Listener
// =======================================================
                 

                 // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
function resetSellForm() {
    editingPendingSaleId = null; // الخروج من وضع التعديل
    
    if (sellProductNameInput) sellProductNameInput.value = "";
    if (sellCustomerNameInput) sellCustomerNameInput.value = "";
    if (sellQuantityInput) sellQuantityInput.value = "1";
    if (sellPriceInput) sellPriceInput.value = "0";
    if (sellPendingCheckbox) sellPendingCheckbox.checked = false;
    
    // إخفاء حقل السيريال
    if (sellSerialContainer) sellSerialContainer.classList.add('hidden');
    if (sellSerialInput) sellSerialInput.value = '';

    // إعادة الزر لشكله الطبيعي
    if (sellButton) {
        sellButton.textContent = "بيع البضاعة (سريع/مؤقت)";
        sellButton.classList.remove('bg-orange-500', 'hover:bg-orange-600');
        sellButton.classList.add('bg-blue-500', 'hover:bg-blue-600');
    }

    // إخفاء زر الإلغاء
    if (d('cancel-edit-pending-button')) {
        d('cancel-edit-pending-button').classList.add('hidden');
    }

    // تفريغ الملحقات
    if (additionalCostsContainer) {
        additionalCostsContainer.innerHTML = '<p class="text-center text-gray-500 text-sm">أدخل اسم المنتج الرئيسي لعرض المرفقات المتاحة.</p>';
    }
    
    showMessage(sellMessage, ""); 
}
// 1. الدالة الرئيسية الجديدة للإضافة أو التحديث
if (sellButton) {
    // إزالة أي مستمعات أحداث قديمة لتجنب التكرار (اختياري لكن مفضل)
    const newSellButton = sellButton.cloneNode(true);
    sellButton.parentNode.replaceChild(newSellButton, sellButton);
    // تحديث المرجع للمتغير
    sellButton = newSellButton;

    sellButton.addEventListener("click", () => {
        saveStateToHistory(); // 1. حفظ نسخة احتياطية

        if (editingPendingSaleId) {
            // 2. إذا كان هناك ID، فهذا "تعديل" -> استدعِ دالة التحديث الجديدة
            console.log("Saving changes to pending sale...");
            updatePendingSale(editingPendingSaleId);
        } else {
            // 3. إذا لم يكن هناك ID، فهذا "بيع جديد" -> استدعِ دالة البيع العادية
            console.log("Processing new sale...");
            sellProduct();
        }
    });
}

// تفعيل زر إلغاء التعديل
if (d('cancel-edit-pending-button')) {
    d('cancel-edit-pending-button').addEventListener('click', resetSellForm);
}

function updateQuickSaleSerialUI() {
    // 1. التأكد من وجود العناصر
    if (!sellSerialContainer || !sellSerialsDatalist || !sellSerialInput) return;

    const productName = sellProductNameInput.value.trim();
    
    // 2. إذا كان هناك اسم منتج، أظهر الحقل فوراً
    if (productName) {
        sellSerialContainer.classList.remove('hidden');
        
        // 3. محاولة مساعدة المستخدم باقتراح السيريالات الموجودة (اختياري)
        const availableSerials = serialNumbersLog.filter(log => 
            log.productName === productName && log.status === 'in_stock'
        );
        
        sellSerialsDatalist.innerHTML = availableSerials.map(s => `<option value="${s.serial}">`).join('');
    } else {
        // إخفاء الحقل فقط إذا كان اسم المنتج فارغاً
        sellSerialContainer.classList.add('hidden');
        sellSerialInput.value = '';
    }
}
function sellProduct() {
    const isPendingSale = sellPendingCheckbox.checked;
    const mainProductName = sellProductNameInput.value.trim();
    const customerName = d("sell-customer-name").value.trim();
    const quantitySold = parseInputNumber(sellQuantityInput);
    const totalSellPrice = parseInputNumber(sellPriceInput);
    
    // قراءة السيريال (إن وجد)
    const selectedSerial = sellSerialInput ? sellSerialInput.value.trim() : '';
    
    const selectedAccountId = d('sell-account-select').value;
    const account = accounts.find(acc => acc.id === selectedAccountId);

    // 1. التحقق من المدخلات الأساسية
    if (!mainProductName || isNaN(quantitySold) || quantitySold <= 0 || isNaN(totalSellPrice) || totalSellPrice < 0) {
        showMessage(sellMessage, "يرجى ملء البيانات بشكل صحيح.", true);
        return;
    }

    // 2. التحقق من الحساب
    if (!isPendingSale && !account) {
        showMessage(sellMessage, "يرجى اختيار الحساب.", true);
        return;
    }

    // 3. التحقق من المخزون
    const mainProductIndex = products.findIndex(p => p.name === mainProductName);
    if (mainProductIndex === -1) {
        showMessage(sellMessage, `المنتج "${mainProductName}" غير موجود.`, true);
        return;
    }
    const mainProduct = products[mainProductIndex];
    if (mainProduct.quantity < quantitySold) {
        showMessage(sellMessage, `الكمية غير متوفرة. المتاح: ${mainProduct.quantity}`, true);
        return;
    }

    // --- معالجة السيريال (المنطق المرن الجديد) ---
    if (selectedSerial) {
        if (quantitySold !== 1) {
             showMessage(sellMessage, "تنبيه: عند تحديد سيريال، يفضل بيع قطعة واحدة فقط لضمان الدقة.", true);
             return;
        }
        
        // البحث عن السيريال في النظام
        const serialIndex = serialNumbersLog.findIndex(s => s.serial === selectedSerial && s.productName === mainProductName);
        
        if (serialIndex !== -1) {
            // أ: السيريال موجود -> نحدث حالته
            if (serialNumbersLog[serialIndex].status === 'sold') {
                showMessage(sellMessage, `تحذير: هذا السيريال (${selectedSerial}) مسجل كمباع مسبقاً!`, true);
                return; // نمنع بيع المباع فقط
            }
            serialNumbersLog[serialIndex].status = isPendingSale ? 'pending_sale' : 'sold';
        } else {
            // ب: السيريال جديد (غير مسجل) -> نقوم بإنشائه الآن وتسجيله كمباع
            // هذا هو ما طلبته: السماح بإدخال سيريال غير محفوظ
            serialNumbersLog.push({
                serial: selectedSerial,
                productName: mainProductName,
                supplierId: mainProduct.supplierId || "",
                addedTimestamp: new Date().toISOString(),
                status: isPendingSale ? 'pending_sale' : 'sold'
            });
        }
    }

    // 4. حساب التكاليف والملحقات
    let costOfGoodsSold = (Number(mainProduct.costPrice) || 0) * quantitySold;
    let additionalItemsDataForPending = [];
    let additionalItemsToUpdate = [];
    
    const additionalCheckboxes = additionalCostsContainer ? additionalCostsContainer.querySelectorAll('input[type="checkbox"]:checked') : [];
    let stockCheckFailed = false;

    additionalCheckboxes.forEach(checkbox => {
        if (stockCheckFailed) return;
        const parentLabel = checkbox.closest('label');
        const quantityInput = parentLabel.querySelector('.additional-item-quantity');
        const qtyToDeduct = parseInt(quantityInput.value) || 0;
        const additionalProductName = checkbox.value;
        const additionalProductIndex = products.findIndex(p => p.name === additionalProductName);

        if (qtyToDeduct > 0 && additionalProductIndex !== -1) {
            const additionalProduct = products[additionalProductIndex];
            if (additionalProduct.quantity < qtyToDeduct) {
                showMessage(sellMessage, `الكمية المطلوبة (${qtyToDeduct}) للمرفق "${additionalProductName}" غير متوفرة.`, true);
                stockCheckFailed = true;
            } else {
                costOfGoodsSold += (Number(additionalProduct.costPrice) || 0) * qtyToDeduct;
                additionalItemsDataForPending.push({ name: additionalProduct.name, quantity: qtyToDeduct, costPrice: additionalProduct.costPrice, supplierId: additionalProduct.supplierId });
                additionalItemsToUpdate.push({ index: additionalProductIndex, quantity: qtyToDeduct });
            }
        }
    });

    if (stockCheckFailed) return;

    // 5. تنفيذ الخصم من المخزون
    // خصم المنتج الأساسي
    products[mainProductIndex].quantity -= quantitySold;

    // خصم المنتجات الإضافية (إن وجدت)
    additionalItemsToUpdate.forEach(item => {
        products[item.index].quantity -= item.quantity;
    });

    // مراجعة المخزون: إذا وصل أي منتج لصفر أو أقل يتم حذفه فوراً
    // نستخدم filter لإنشاء مصفوفة جديدة خالية من المنتجات الصفرية
    const initialCount = products.length;
    products = products.filter(p => p.quantity > 0.01); 
    const finalCount = products.length;

    // سجل في السجل العام إذا تم حذف منتج لنفاذ كميته
    if (finalCount < initialCount) {
        logOperation("تنبيه مخزون", "تم حذف منتج أو أكثر من القائمة التلقائية لنفاذ الكمية (وصلت لصفر).");
    }
    const profit = totalSellPrice - costOfGoodsSold;

    // 6. تجهيز الاسم للعرض في الفاتورة (مع السيريال إن وجد)
    let productNameWithSerial = mainProduct.name;
    if (selectedSerial) {
        productNameWithSerial += ` (S/N: ${selectedSerial})`;
    }

    // 7. الحفظ
    if (isPendingSale) {
        goodsOnConsignmentValue += costOfGoodsSold;
        const pendingSaleData = { 
            id: generateId('pending'), 
            timestamp: new Date().toISOString(), 
            customerName, 
            mainProduct: { name: productNameWithSerial, quantity: quantitySold, costPrice: mainProduct.costPrice, supplierId: mainProduct.supplierId }, 
            additionalItems: additionalItemsDataForPending, 
            totalSellPrice, potentialProfit: profit, status: 'pending' 
        };
        pendingSales.push(pendingSaleData);
        logOperation("بيع مؤقت", `بيع مؤقت: ${productNameWithSerial}`);
        showMessage(sellMessage, "تم تسجيل البيع المؤقت.");
    } else {
            // --- الجزء المالي المطور للتعامل مع الدفع الجزئي ---
            const quickPaidInput = document.getElementById('sell-paid-amount');
            const quickPaidAmount = parseFloat(quickPaidInput.value) || 0;

            // إذا دفع 0 أو ترك الحقل فارغاً، نعتبره دفع كامل
            let cashForLiquidity = quickPaidAmount;
            if (quickPaidAmount === 0) {
                cashForLiquidity = totalSellPrice;
            }

            const quickDebtAmount = totalSellPrice - cashForLiquidity;

            // 1. تحديث الأرباح (الأرباح تُحسب على كامل الفاتورة دائماً)
            totalProfit += profit;

            // 2. إيداع الكاش في الخزينة
            if (cashForLiquidity > 0) {
                account.balance += cashForLiquidity;
                const newTotalLiquidity = accounts.reduce((sum, acc) => sum + acc.balance, 0);
                liquidityLog.push({
                    id: `liq-q-${Date.now()}`,
                    timestamp: new Date().toISOString(),
                    type: "add",
                    amount: cashForLiquidity,
                    description: `بيع سريع: ${productNameWithSerial} (دفعة نقدية)`,
                    currentBalance: newTotalLiquidity,
                    accountId: account.id
                });
            }

            // 3. تسجيل المتبقي كدين تلقائي
            if (quickDebtAmount > 0.01) {
                debtors.push({
                    id: `debt-q-${Date.now()}`,
                    name: customerName || "عميل غير مسمى",
                    reason: `متبقي بيع سريع: ${productNameWithSerial}`,
                    amount: quickDebtAmount,
                    timestamp: new Date().toISOString()
                });
                logOperation("دين تلقائي", `تم تسجيل دين على ${customerName || 'العميل'} بقيمة ${formatCurrency(quickDebtAmount)} متبقي بيع سريع.`);
            }
        const allItems = [
            { name: mainProduct.name, quantity: quantitySold, costPrice: mainProduct.costPrice, serial: selectedSerial },
            ...additionalItemsDataForPending
        ];

        const saleRecord = { 
            id: generateId('sale'), type: 'quick', timestamp: new Date().toISOString(), customerName, 
            items: allItems, 
            totalSellPrice, totalCost: costOfGoodsSold, profit 
        };
        salesToday.push(saleRecord);
        saveInvoiceToFirestore(saleRecord);
        logOperation("بيع سريع", `بيع ${productNameWithSerial} بقيمة ${formatCurrency(totalSellPrice)}`);
        showMessage(sellMessage, `تم البيع بنجاح. الربح: ${formatCurrency(profit)}`);
    }

    updateUI();
    saveData();
    resetSellForm();
    sellSerialContainer.classList.add('hidden');
    sellSerialInput.value = '';
}

function updatePendingSale(pendingId) {
    const saleIndex = pendingSales.findIndex(s => s.id === pendingId);
    if (saleIndex === -1) {
        showGlobalMessage("خطأ: لم يتم العثور على البيع المؤقت.", true);
        resetSellForm();
        return;
    }

    const originalSale = pendingSales[saleIndex];
    
    // =========================================================
    // خطوة 1: إرجاع المخزون القديم بالكامل (Revert Stock)
    // =========================================================
    const oldMainProduct = originalSale.mainProduct;
    const oldAttachments = originalSale.additionalItems || [];
    
    // إرجاع المنتج الرئيسي
    // نستخدم split لإزالة السيريال من الاسم عند البحث في المخزون
    const oldMainNameSimple = oldMainProduct.name.split(' (S/N:')[0];
    const oldMainIndex = products.findIndex(p => p.name === oldMainNameSimple);
    
    if (oldMainIndex !== -1) {
        products[oldMainIndex].quantity += Number(oldMainProduct.quantity);
    } else {
        // لو المنتج اتحذف بالغلط، نرجعه عشان الحسابات تظبط
        products.push({ ...oldMainProduct, name: oldMainNameSimple });
    }

    // إرجاع الملحقات
    oldAttachments.forEach(att => {
        const attIndex = products.findIndex(p => p.name === att.name);
        if (attIndex !== -1) {
            products[attIndex].quantity += Number(att.quantity);
        }
    });

    // =========================================================
    // خطوة 2: التحقق من البيانات الجديدة
    // =========================================================
    const newMainProductName = sellProductNameInput.value.trim();
    const newCustomerName = sellCustomerNameInput.value.trim();
    const newQuantitySold = parseInputNumber(sellQuantityInput);
    const newTotalSellPrice = parseInputNumber(sellPriceInput);
    const newSerial = sellSerialInput ? sellSerialInput.value.trim() : '';

    // التحقق من صحة المدخلات
    if (!newMainProductName || isNaN(newQuantitySold) || newQuantitySold <= 0 || isNaN(newTotalSellPrice)) {
        showMessage(sellMessage, "البيانات المدخلة غير صحيحة. تم التراجع عن العملية وإعادة المخزون السابق.", true);
        // فشل التحقق: يجب إعادة خصم المخزون القديم (لأننا أرجعناه في الخطوة 1)
        if(oldMainIndex !== -1) products[oldMainIndex].quantity -= Number(oldMainProduct.quantity);
        oldAttachments.forEach(att => {
            const idx = products.findIndex(p => p.name === att.name);
            if(idx !== -1) products[idx].quantity -= Number(att.quantity);
        });
        return;
    }

    // التحقق من توفر الكميات الجديدة في المخزون
    const newMainIndex = products.findIndex(p => p.name === newMainProductName);
    if (newMainIndex === -1 || products[newMainIndex].quantity < newQuantitySold) {
        showMessage(sellMessage, `الكمية الجديدة المطلوبة غير متوفرة. (المتاح: ${newMainIndex !== -1 ? products[newMainIndex].quantity : 0})`, true);
        // فشل الكمية: إعادة خصم المخزون القديم
        if(oldMainIndex !== -1) products[oldMainIndex].quantity -= Number(oldMainProduct.quantity);
        oldAttachments.forEach(att => { const idx = products.findIndex(p => p.name === att.name); if(idx !== -1) products[idx].quantity -= Number(att.quantity); });
        return;
    }

    // =========================================================
    // خطوة 3: خصم المخزون الجديد (Apply New Stock Deduction)
    // =========================================================
    
    // خصم المنتج الرئيسي الجديد
    products[newMainIndex].quantity -= newQuantitySold;
    
    // حساب التكلفة الجديدة
    let newTotalCost = (Number(products[newMainIndex].costPrice) || 0) * newQuantitySold;
    
    // معالجة الملحقات الجديدة وخصمها
    let newAdditionalItemsData = [];
    const additionalCheckboxes = additionalCostsContainer ? additionalCostsContainer.querySelectorAll('input[type="checkbox"]:checked') : [];
    
    for (const checkbox of additionalCheckboxes) {
        const attName = checkbox.value;
        const parentLabel = checkbox.closest('label');
        const qtyInput = parentLabel.querySelector('.additional-item-quantity');
        const qtyToDeduct = parseInt(qtyInput.value) || 0;
        
        const attIndex = products.findIndex(p => p.name === attName);
        
        if (attIndex !== -1 && qtyToDeduct > 0) {
            if (products[attIndex].quantity >= qtyToDeduct) {
                products[attIndex].quantity -= qtyToDeduct;
                newTotalCost += (Number(products[attIndex].costPrice) || 0) * qtyToDeduct;
                
                newAdditionalItemsData.push({
                    name: attName,
                    quantity: qtyToDeduct,
                    costPrice: products[attIndex].costPrice,
                    supplierId: products[attIndex].supplierId
                });
            }
        }
    }

    // 🔥🔥🔥 تم حذف سطر الفلترة من هنا لمنع الخطأ (Cannot read properties of undefined) 🔥🔥🔥
    // products = products.filter(p => p.quantity > 0.001); <--- هذا السطر كان السبب

    // =========================================================
    // خطوة 4: تحديث سجل البيع المؤقت
    // =========================================================
    
    // ضبط الاسم بالسيريال الجديد
    let displayName = newMainProductName;
    if (newSerial) displayName += ` (S/N: ${newSerial})`;

    // تحديث حالة السيريال
    if (typeof serialNumbersLog !== 'undefined') {
        const oldSerialName = oldMainProduct.name;
        const oldSerialMatch = oldSerialName.match(/\(S\/N: (.*?)\)/);
        if (oldSerialMatch) {
            const oldS = oldSerialMatch[1];
            const oldLogIdx = serialNumbersLog.findIndex(l => l.serial === oldS);
            if (oldLogIdx !== -1) serialNumbersLog[oldLogIdx].status = 'in_stock';
        }
        if (newSerial) {
             const newLogIdx = serialNumbersLog.findIndex(l => l.serial === newSerial);
             if (newLogIdx !== -1) {
                 serialNumbersLog[newLogIdx].status = 'pending_sale';
             } else {
                 serialNumbersLog.push({
                     serial: newSerial,
                     productName: newMainProductName,
                     supplierId: products[newMainIndex].supplierId || "",
                     addedTimestamp: new Date().toISOString(),
                     status: 'pending_sale'
                 });
             }
        }
    }

    // التحديث النهائي للكائن
    pendingSales[saleIndex] = {
        ...originalSale,
        customerName: newCustomerName,
        mainProduct: { 
            name: displayName, 
            quantity: newQuantitySold, 
            // الآن هذا السطر آمن لأننا لم نحذف المنتج من المصفوفة
            costPrice: products[newMainIndex].costPrice, 
            supplierId: products[newMainIndex].supplierId 
        },
        additionalItems: newAdditionalItemsData,
        totalSellPrice: newTotalSellPrice,
        potentialProfit: newTotalSellPrice - newTotalCost,
        timestamp: new Date().toISOString()
    };

    logOperation("تعديل بيع مؤقت", `تم تحديث بيانات البيع للعميل: ${newCustomerName}.`);
    showMessage(sellMessage, "تم تحديث البيع المؤقت وتعديل المخزون بنجاح.");

    resetSellForm();
    updateUI();
}

// ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
// ★★★ نهاية الكود الجديد الذي ستلصقه ★★★
// ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
                 if(sellProductNameInput) { // Update checkboxes when main product changes
                     sellProductNameInput.addEventListener('input', updateAdditionalCostsCheckboxes); sellProductNameInput.addEventListener('change', updateAdditionalCostsCheckboxes); }
                 // <<< جديد: مستمع حدث لبحث المبيعات المؤقتة >>>
                 if(pendingSalesSearchInput) {
                    pendingSalesSearchInput.addEventListener('input', updatePendingSalesDisplay);
                 }
                 if(pendingSalesListContainer) { // Use event delegation for pending sale buttons
                     pendingSalesListContainer.addEventListener('click', handlePendingSaleActions); }
                 if (addLiquidityButton) { addLiquidityButton.addEventListener("click", () => {saveStateToHistory();
                     const amount = parseInputNumber(addLiquidityAmountInput); const source = addLiquiditySourceInput.value.trim(); if (isNaN(amount) || amount <= 0) { showMessage(liquidityMessage, "يرجى إدخال مبلغ صحيح (> 0) للإضافة.", true); return; } if (!source) { showMessage(liquidityMessage, "يرجى إدخال مصدر السيولة.", true); return; } liquidity += amount; const logEntry = { id: `liq-${Date.now()}`, timestamp: new Date().toISOString(), type: "add", amount: amount, description: source, currentBalance: liquidity }; liquidityLog.push(logEntry); logOperation("إضافة سيولة", `إضافة ${formatCurrency(amount)} من "${source}". الرصيد الحالي: ${formatCurrency(liquidity)}`); updateUI(); addLiquidityAmountInput.value = "0"; addLiquiditySourceInput.value = ""; addLiquiditySourceInput.focus(); // Focus source for next entry
                     showMessage(liquidityMessage, `تمت إضافة ${formatCurrency(amount)} من "${source}".`); }); }
                 if (removeLiquidityButton) { removeLiquidityButton.addEventListener("click", () => {
                    saveStateToHistory();
                     const amount = parseInputNumber(removeLiquidityAmountInput); const reason = removeLiquidityReasonInput.value.trim(); if (isNaN(amount) || amount <= 0) { showMessage(liquidityMessage, "يرجى إدخال مبلغ صحيح (> 0) للسحب.", true); return; } if (!reason) { showMessage(liquidityMessage, "يرجى إدخال سبب السحب.", true); return; } if (amount > liquidity) { showMessage(liquidityMessage, `المبلغ المطلوب (${formatCurrency(amount)}) أكبر من السيولة المتاحة (${formatCurrency(liquidity)}).`, true); return; } liquidity -= amount; const logEntry = { id: `liq-${Date.now()}`, timestamp: new Date().toISOString(), type: "remove", amount: amount, description: reason, currentBalance: liquidity }; liquidityLog.push(logEntry); logOperation("سحب سيولة", `سحب ${formatCurrency(amount)} بسبب "${reason}". الرصيد الحالي: ${formatCurrency(liquidity)}`); updateUI(); removeLiquidityAmountInput.value = "0"; removeLiquidityReasonInput.value = ""; removeLiquidityReasonInput.focus(); showMessage(liquidityMessage, `تم سحب ${formatCurrency(amount)} بسبب "${reason}".`); }); }
                 // <<< جديد: مستمع حدث لزر تعديل السيولة >>>
                if (adjustLiquidityButton) {
    adjustLiquidityButton.addEventListener('click', () => {
        saveStateToHistory(); // <-- أضف هذا السطر
        adjustLiquidityManually();
    });
}
               // استبدل هذا الكود بالكامل داخل دالة initializeApp
if (addExpenseButton) {
    addExpenseButton.addEventListener("click", () => {
        const amount = parseInputNumber(addExpenseInput);
        const selectedAccountId = d('expense-payment-account').value;
        const account = accounts.find(acc => acc.id === selectedAccountId);

        if (isNaN(amount) || amount <= 0) {
            showMessage(expensesMessage, "يرجى إدخال مبلغ مصروف صحيح (> 0).", true);
            return;
        }

        if (!account) {
            showMessage(expensesMessage, "يرجى اختيار حساب لخصم المصروف منه.", true);
            return;
        }

        if (amount > account.balance) {
            showMessage(expensesMessage, `مبلغ المصروف (${formatCurrency(amount)}) أكبر من رصيد حساب "${account.name}" (${formatCurrency(account.balance)}).`, true);
            return;
        }
        
        saveStateToHistory();

        // تنفيذ العمليات
        expenses += amount;
        account.balance -= amount;
        
        const newTotalLiquidity = accounts.reduce((sum, acc) => sum + acc.balance, 0);
        
        liquidityLog.push({ 
            id: `liq-${Date.now()}`, 
            timestamp: new Date().toISOString(), 
            type: "remove", 
            amount: amount, 
            description: `تسجيل مصروف من حساب "${account.name}"`, 
            currentBalance: newTotalLiquidity,
            accountId: selectedAccountId
        });
        
        logOperation("تسجيل مصروف", `تسجيل مصروف بقيمة ${formatCurrency(amount)}. تم خصمه من حساب "${account.name}".`);
        
        updateUI();
        addExpenseInput.value = "0";
        showMessage(expensesMessage, `تم تسجيل مصروف ${formatCurrency(amount)} بنجاح.`);
    });
}
               // استبدل هذا الكود بالكامل داخل دالة initializeApp
if (removeExpenseButton) {
    removeExpenseButton.addEventListener("click", () => {
        const amount = parseInputNumber(removeExpenseInput);
        const selectedAccountId = d('expense-refund-account').value;
        const account = accounts.find(acc => acc.id === selectedAccountId);
        
        if (isNaN(amount) || amount <= 0) {
            showMessage(expensesMessage, "أدخل مبلغ صحيح (> 0) للتقليل.", true);
            return;
        }

        if (!account) {
            showMessage(expensesMessage, "يرجى اختيار حساب لإرجاع المبلغ إليه.", true);
            return;
        }

        if (amount > expenses) {
            showMessage(expensesMessage, `المبلغ (${formatCurrency(amount)}) أكبر من إجمالي المصروفات (${formatCurrency(expenses)}).`, true);
            return;
        }

        saveStateToHistory();

        // تنفيذ العمليات (عكس الإضافة)
        expenses -= amount;
        account.balance += amount;

        const newTotalLiquidity = accounts.reduce((sum, acc) => sum + acc.balance, 0);
        
        liquidityLog.push({ 
            id: `liq-${Date.now()}`, 
            timestamp: new Date().toISOString(), 
            type: "add", 
            amount: amount, 
            description: `إلغاء/تقليل مصروف (استرداد) إلى حساب "${account.name}"`, 
            currentBalance: newTotalLiquidity,
            accountId: selectedAccountId
        });

        logOperation("تقليل مصروف", `تقليل المصروفات بقيمة ${formatCurrency(amount)}. تم إرجاعه لحساب "${account.name}".`);

        updateUI();
        removeExpenseInput.value = "0";
        showMessage(expensesMessage, `تم تقليل المصروفات بمقدار ${formatCurrency(amount)}.`);
    });
}

if (addDebtButton) {
    addDebtButton.addEventListener("click", () => {
        saveStateToHistory();
        const name = debtorNameInput.value.trim();
        const reason = addDebtReasonInput.value.trim() || 'دين عام';
        const amount = parseInputNumber(addDebtAmountInput);
        const deductLiquidity = debtDeductLiquidityCheckbox.checked;

        // --- ✅ كود جديد: قراءة الحساب المحدد للسلفة ---
        const selectedAccountId = d('debt-advance-account').value;
        const account = accounts.find(acc => acc.id === selectedAccountId);

        if (!name || isNaN(amount) || amount <= 0) {
            showMessage(debtsMessage, "يرجى ملء اسم المدين ومبلغ صحيح (> 0).", true);
            return;
        }

        // --- ✅ كود جديد: التحقق من الرصيد والحساب ---
        if (deductLiquidity) {
            if (!account) {
                showMessage(debtsMessage, "يرجى اختيار الحساب الذي سيتم الخصم منه.", true);
                return;
            }
            if (amount > account.balance) {
                showMessage(debtsMessage, `مبلغ السلفة (${formatCurrency(amount)}) أكبر من رصيد حساب "${account.name}" (${formatCurrency(account.balance)}).`, true);
                return;
            }
        }

        const existingDebtIndex = debtors.findIndex(d => d.name === name && d.reason === reason);
        let logMsg = "";
        if (existingDebtIndex !== -1) {
            debtors[existingDebtIndex].amount = (Number(debtors[existingDebtIndex].amount) || 0) + amount;
            logMsg = `زيادة دين قائم على "${name}" بمبلغ ${formatCurrency(amount)}.`;
            showMessage(debtsMessage, `تمت زيادة الدين لـ "${name}".`);
        } else {
            debtors.push({ id: generateId('debt'), name, reason, amount });
            logMsg = `تسجيل دين جديد على "${name}" بمبلغ ${formatCurrency(amount)}.`;
            showMessage(debtsMessage, `تم تسجيل دين جديد لـ "${name}".`);
        }

        // --- ✅ كود جديد: الخصم من الحساب المحدد ---
        if (deductLiquidity) {
            account.balance -= amount;
            const newTotalLiquidity = accounts.reduce((sum, acc) => sum + acc.balance, 0);
            liquidityLog.push({ id: `liq-${Date.now()}`, timestamp: new Date().toISOString(), type: "remove", amount: amount, description: `سلفة لـ ${name} من حساب "${account.name}"`, currentBalance: newTotalLiquidity });
            logMsg += ` وتم خصمه كسلفة من حساب "${account.name}".`;
        }
        
        logOperation("تسجيل/زيادة دين", logMsg);
        updateUI();
        debtorNameInput.value = "";
        addDebtReasonInput.value = "";
        addDebtAmountInput.value = "0";
        debtDeductLiquidityCheckbox.checked = false;
        d('debt-advance-account-container').classList.add('hidden'); // إخفاء قائمة الحسابات
        debtorNameInput.focus();
    });

    // مستمع لإظهار وإخفاء قائمة الحسابات
    debtDeductLiquidityCheckbox.addEventListener('change', (e) => {
        d('debt-advance-account-container').classList.toggle('hidden', !e.target.checked);
    });
}
  // استبدل هذا الكود بالكامل داخل دالة initializeApp
// استبدل هذا الكود بالكامل داخل دالة initializeApp
if (receivePaymentButton) {
    receivePaymentButton.addEventListener("click", () => {
        const checkedDebts = d('payment-debtor-list-container').querySelectorAll('.debt-payment-checkbox:checked');
        const selectedAccountId = d('debt-payment-account').value;
        const account = accounts.find(acc => acc.id === selectedAccountId);

        if (checkedDebts.length === 0) {
            showMessage(debtsMessage, "يرجى تحديد دين واحد على الأقل لتحصيله.", true);
            return;
        }
        if (!account) {
            showMessage(debtsMessage, "يرجى اختيار الحساب الذي سيتم إيداع المبلغ فيه.", true);
            return;
        }

        let totalPayment = 0;
        let paidDebtIds = [];
        let paidDebtorsSummary = new Map();

        checkedDebts.forEach(checkbox => {
            const amount = parseFloat(checkbox.dataset.amount);
            totalPayment += amount;
            paidDebtIds.push(checkbox.dataset.debtId);
            const debt = debtors.find(d => d.id === checkbox.dataset.debtId);
            if (debt) {
                paidDebtorsSummary.set(debt.name, (paidDebtorsSummary.get(debt.name) || 0) + amount);
            }
        });

        saveStateToHistory();

        account.balance += totalPayment;
        debtors = debtors.filter(d => !paidDebtIds.includes(d.id));

        const summaryText = Array.from(paidDebtorsSummary.entries()).map(([name, amount]) => `${name} (${formatCurrency(amount)})`).join('، ');
        const newTotalLiquidity = accounts.reduce((sum, acc) => sum + acc.balance, 0);
        liquidityLog.push({ id: `liq-${Date.now()}`, timestamp: new Date().toISOString(), type: "add", amount: totalPayment, description: `سداد مجمع من: ${summaryText}`, currentBalance: newTotalLiquidity });
        logOperation("استلام سداد مجمع", `استلام ${formatCurrency(totalPayment)} في حساب "${account.name}" من: ${summaryText}.`);

        showMessage(debtsMessage, `تم استلام دفعة مجمعة بقيمة ${formatCurrency(totalPayment)} بنجاح.`);
        updateUI();
        d('debt-payment-summary').classList.add('hidden');
    });
}
              // --- ضع هذا الكود داخل دالة initializeApp بدلاً من الكود القديم الخاص بالالتزامات ---

// 1. تفعيل إظهار/إخفاء قائمة الحسابات
if (liabilityReceivedCashCheckbox) {
    liabilityReceivedCashCheckbox.addEventListener('change', (e) => {
        const container = d('liability-cash-account-container');
        if (container) {
            if (e.target.checked) {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        }
    });
}

// 2. تحديث منطق زر إضافة الالتزام
if (addLiabilityButton) {
    addLiabilityButton.addEventListener("click", () => {
        saveStateToHistory();
        const name = creditorNameInput.value.trim();
        const amount = parseInputNumber(addLiabilityAmountInput);
        const receivedCash = liabilityReceivedCashCheckbox.checked;
        
        // قراءة الحساب المختار
        const selectedAccountId = d('liability-cash-account').value;
        const account = accounts.find(acc => acc.id === selectedAccountId);

        if (!name) {
            showMessage(liabilitiesMessage, "يرجى إدخال اسم الدائن.", true);
            return;
        }
        if (isNaN(amount) || amount <= 0) {
            showMessage(liabilitiesMessage, "يجب أن يكون مبلغ الالتزام أكبر من صفر.", true);
            return;
        }

        // التحقق من اختيار الحساب إذا تم تحديد استلام السيولة
        if (receivedCash && !account) {
            showMessage(liabilitiesMessage, "يرجى اختيار الحساب الذي تم استلام السيولة فيه.", true);
            return;
        }

        const existingIndex = liabilities.findIndex(l => l.name === name);
        let logMsg = "";

        if (existingIndex !== -1) {
            liabilities[existingIndex].amount = (Number(liabilities[existingIndex].amount) || 0) + amount;
            logMsg = `زيادة التزام قائم لـ "${name}" بمبلغ ${formatCurrency(amount)}. الإجمالي: ${formatCurrency(liabilities[existingIndex].amount)}`;
            showMessage(liabilitiesMessage, `تمت زيادة الالتزام لـ "${name}".`);
        } else {
            const newLiabilityId = generateId('liab');
            const newLiability = {
                id: newLiabilityId,
                name: name,
                amount: amount
            };
            liabilities.push(newLiability);
            logMsg = `تسجيل التزام جديد على الشركة لـ "${name}" بمبلغ ${formatCurrency(amount)}.`;
            showMessage(liabilitiesMessage, `تم تسجيل التزام جديد لـ "${name}".`);
        }

        // إضافة السيولة للحساب المختار
        if (receivedCash) {
            account.balance += amount; // الإضافة للحساب المختار وليس 'main'
            
            const newTotalLiquidity = accounts.reduce((sum, acc) => sum + acc.balance, 0);
            
            const liqLogEntry = {
                id: `liq-${Date.now()}`,
                timestamp: new Date().toISOString(),
                type: "add",
                amount: amount,
                description: `استلام سيولة مقابل التزام لـ ${name} في حساب "${account.name}"`,
                currentBalance: newTotalLiquidity,
                accountId: selectedAccountId
            };
            liquidityLog.push(liqLogEntry);
            logMsg += ` وتم استلام سيولة مقابله في "${account.name}".`;
        }

        logOperation("تسجيل/زيادة التزام", logMsg);
        updateUI();
        
        // إعادة تعيين النموذج
        creditorNameInput.value = "";
        addLiabilityAmountInput.value = "0";
        liabilityReceivedCashCheckbox.checked = false;
        d('liability-cash-account-container').classList.add('hidden'); // إخفاء القائمة
        if(d('liability-cash-account')) d('liability-cash-account').value = "";
        creditorNameInput.focus();
    });
}
   // استبدل هذا الكود بالكامل داخل دالة initializeApp
if (payLiabilityButton) {
// Event listeners for bulk payment selections
const debtPaymentContainer = d('payment-debtor-list-container');
const liabilityPaymentContainer = d('payment-creditor-list-container');

if(debtPaymentContainer){
    debtPaymentContainer.addEventListener('change', () => {
        calculateSelectedTotal('payment-debtor-list-container', '.debt-payment-checkbox', d('debt-payment-summary'), d('debt-payment-total'));

        // Update "Select All" checkbox state
        const allDebts = debtPaymentContainer.querySelectorAll('.debt-payment-checkbox');
        const checkedDebts = debtPaymentContainer.querySelectorAll('.debt-payment-checkbox:checked');
        d('toggle-all-debts').checked = allDebts.length > 0 && allDebts.length === checkedDebts.length;
    });
}

if(liabilityPaymentContainer){
    liabilityPaymentContainer.addEventListener('change', () => {
        calculateSelectedTotal('payment-creditor-list-container', '.liability-payment-checkbox', d('liability-payment-summary'), d('liability-payment-total'));

        // Update "Select All" checkbox state
        const allLiabilities = liabilityPaymentContainer.querySelectorAll('.liability-payment-checkbox');
        const checkedLiabilities = liabilityPaymentContainer.querySelectorAll('.liability-payment-checkbox:checked');
        d('toggle-all-liabilities').checked = allLiabilities.length > 0 && allLiabilities.length === checkedLiabilities.length;
    });
}
// =======================================================
// START: NEW LOGIC FOR "SELECT ALL" CHECKBOXES
// =======================================================
const toggleAllDebtsCheckbox = d('toggle-all-debts');
const toggleAllLiabilitiesCheckbox = d('toggle-all-liabilities');

if (toggleAllDebtsCheckbox) {
    toggleAllDebtsCheckbox.addEventListener('change', (e) => {
        const isChecked = e.target.checked;
        const debtCheckboxes = d('payment-debtor-list-container').querySelectorAll('.debt-payment-checkbox');
        debtCheckboxes.forEach(checkbox => checkbox.checked = isChecked);
        // Trigger calculation after changing
        calculateSelectedTotal('payment-debtor-list-container', '.debt-payment-checkbox', d('debt-payment-summary'), d('debt-payment-total'));
    });
}

if (toggleAllLiabilitiesCheckbox) {
    toggleAllLiabilitiesCheckbox.addEventListener('change', (e) => {
        const isChecked = e.target.checked;
        const liabilityCheckboxes = d('payment-creditor-list-container').querySelectorAll('.liability-payment-checkbox');
        liabilityCheckboxes.forEach(checkbox => checkbox.checked = isChecked);
        // Trigger calculation after changing
        calculateSelectedTotal('payment-creditor-list-container', '.liability-payment-checkbox', d('liability-payment-summary'), d('liability-payment-total'));
    });
}
// =======================================================
// END: NEW LOGIC FOR "SELECT ALL" CHECKBOXES
// =======================================================

    payLiabilityButton.addEventListener("click", () => {
        const checkedLiabilities = d('payment-creditor-list-container').querySelectorAll('.liability-payment-checkbox:checked');
        const selectedAccountId = d('liability-payment-account').value;
        const account = accounts.find(acc => acc.id === selectedAccountId);

        if (checkedLiabilities.length === 0) {
            showMessage(liabilitiesMessage, "يرجى تحديد التزام واحد على الأقل لتسديده.", true);
            return;
        }
        if (!account) {
            showMessage(liabilitiesMessage, "يرجى اختيار الحساب الذي سيتم الدفع منه.", true);
            return;
        }

        let totalPayment = 0;
        let paidLiabilityIds = [];
        let paidCreditorsSummary = new Map();

        checkedLiabilities.forEach(checkbox => {
            const amount = parseFloat(checkbox.dataset.amount);
            totalPayment += amount;
            paidLiabilityIds.push(checkbox.dataset.liabilityId);
            const liability = liabilities.find(l => l.id === checkbox.dataset.liabilityId);
            if(liability) {
                paidCreditorsSummary.set(liability.name, (paidCreditorsSummary.get(liability.name) || 0) + amount);
            }
        });

        if (totalPayment > account.balance) {
            showMessage(liabilitiesMessage, `رصيد حساب "${account.name}" (${formatCurrency(account.balance)}) غير كافٍ لتسديد المبلغ المطلوب (${formatCurrency(totalPayment)}).`, true);
            return;
        }

        saveStateToHistory();

        account.balance -= totalPayment;
        liabilities = liabilities.filter(l => !paidLiabilityIds.includes(l.id));

        const summaryText = Array.from(paidCreditorsSummary.entries()).map(([name, amount]) => `${name} (${formatCurrency(amount)})`).join('، ');
        const newTotalLiquidity = accounts.reduce((sum, acc) => sum + acc.balance, 0);
        liquidityLog.push({ id: `liq-${Date.now()}`, timestamp: new Date().toISOString(), type: "remove", amount: totalPayment, description: `تسديد التزام مجمع لـ: ${summaryText}`, currentBalance: newTotalLiquidity });
        logOperation("تسديد التزام مجمع", `تسديد ${formatCurrency(totalPayment)} من حساب "${account.name}" إلى: ${summaryText}.`);

        showMessage(liabilitiesMessage, `تم تسديد دفعة مجمعة بقيمة ${formatCurrency(totalPayment)} بنجاح.`);
        updateUI();
        d('liability-payment-summary').classList.add('hidden');
    });
}
                 if (performTwoPartyOffsetButton) { 
    performTwoPartyOffsetButton.addEventListener("click", () => {
        saveStateToHistory(); // <-- أضف هذا السطر
        performTwoPartyOffset()
    }); 
}
// --- Financial Center Buttons Listener ---
if (fc_execute_debt_btn) {
    fc_execute_debt_btn.addEventListener('click', () => {
        saveStateToHistory(); // لحفظ الحالة قبل التنفيذ
        fc_execute_debt_treatment();
    });
}

if (fc_execute_dist_btn) {
    fc_execute_dist_btn.addEventListener('click', () => {
        saveStateToHistory(); // لحفظ الحالة قبل التنفيذ
        fc_execute_cost_distribution();
    });
}
// === ✅ استبدل هذا الجزء بالكامل داخل دالة initializeApp ===
const ppConfirmBtn = d('pp-confirm-payment-btn');
const ppCancelBtn = d('pp-cancel-payment-btn');
if (ppConfirmBtn) {
    ppConfirmBtn.addEventListener('click', async () => {
        const pendingId = ppConfirmBtn.dataset.pendingId;
        const purchaseIndex = pendingPurchases.findIndex(p => p.id === pendingId);
        
        if (purchaseIndex === -1) {
            showMessage(d('pp-payment-message'), "خطأ: لم يتم العثور على الفاتورة.", true);
            return;
        }

        const purchase = pendingPurchases[purchaseIndex];
        const selectedAccountId = d('pending-purchase-payment-account').value;
        const account = accounts.find(acc => acc.id === selectedAccountId);
        
        if (!account) {
            showMessage(d('pp-payment-message'), "يرجى اختيار حساب للدفع.", true);
            return;
        }

        // التحقق من الرصيد لتغطية المبلغ المتبقي فقط
        if (purchase.remainingBalance > account.balance) {
            showMessage(d('pp-payment-message'), `رصيد حساب "${account.name}" غير كافٍ.`, true);
            return;
        }

        saveStateToHistory();

        // --- 1. حساب توزيع التكاليف الإضافية نسبياً ---
        // جمع كل التكاليف الإضافية المسجلة في الفاتورة (شحن، عتالة، إلخ)
        const totalExtraCosts = (purchase.extraCosts || []).reduce((sum, c) => sum + (Number(c.amount) || 0), 0);
        // حساب إجمالي قيمة البضاعة الأساسية لعمل توزيع عادل
        const totalBaseGoodsValue = purchase.items.reduce((sum, item) => sum + (item.quantity * item.cost), 0);

        // --- 2. تحديث المخزون (بالتصنيفات والتكاليف الشاملة) ---
        purchase.items.forEach(item => {
            // حساب نصيب القطعة الواحدة من المصاريف الإضافية
            let extraCostPerUnit = 0;
            if (totalBaseGoodsValue > 0 && totalExtraCosts > 0) {
                const itemTotalBaseCost = item.quantity * item.cost;
                const itemShareOfExtra = (itemTotalBaseCost / totalBaseGoodsValue) * totalExtraCosts;
                extraCostPerUnit = itemShareOfExtra / item.quantity;
            }
            
            // التكلفة النهائية = التكلفة الأساسية + نصيب المصاريف
            const finalCostWithOverhead = item.cost + extraCostPerUnit;

            const productIndex = products.findIndex(p => p.name.toLowerCase() === item.name.toLowerCase());
            
            if (productIndex !== -1) {
                // تحديث منتج موجود مسبقاً
                const existing = products[productIndex];
                const oldQty = Number(existing.quantity) || 0;
                const oldCost = Number(existing.costPrice) || 0;
                const totalQty = oldQty + item.quantity;
                
                existing.quantity = totalQty;
                // تحديث متوسط التكلفة بناءً على السعر الشامل الجديد
                existing.costPrice = totalQty > 0 ? ((oldQty * oldCost) + (item.quantity * finalCostWithOverhead)) / totalQty : finalCostWithOverhead;
                
                // ✅ تحديث التصنيف (Category) لضمان انتقاله للمخزون
                if (item.category) existing.category = item.category;
            } else {
                // ✅ إضافة منتج جديد بالتصنيف والتكلفة الشاملة
                products.push({ 
                    name: item.name, 
                    quantity: item.quantity, 
                    costPrice: finalCostWithOverhead, 
                    supplierId: purchase.supplierId,
                    category: item.category || "" 
                });
            }

            // تسجيل السيريالات إن وجدت
            if (item.serials && item.serials.length > 0) {
                item.serials.forEach(serial => {
                    if (!serialNumbersLog.some(s => s.serial === serial)) {
                        serialNumbersLog.push({ 
                            serial, 
                            productName: item.name, 
                            supplierId: purchase.supplierId, 
                            addedTimestamp: purchase.timestamp, 
                            status: "in_stock" 
                        });
                    }
                });
            }
        });

        // --- 3. المعالجة المالية (الخصم من الخزنة) ---
        account.balance -= purchase.remainingBalance;
        const newTotalLiquidity = accounts.reduce((sum, acc) => sum + acc.balance, 0);
        
        liquidityLog.push({ 
            id: `liq-${Date.now()}`, 
            timestamp: new Date().toISOString(),
            type: "remove", 
            amount: purchase.remainingBalance, 
            description: `تسديد متبقي مشتريات شاملة المصاريف من حساب "${account.name}"`, 
            currentBalance: newTotalLiquidity,
            accountId: account.id
        });

        // --- 4. تحديث بيانات الفاتورة وتصفية الالتزامات ---
        purchase.paidAmount = purchase.grandTotal;
        purchase.remainingBalance = 0;
        purchase.status = 'Confirmed';
        
        // إزالة الالتزام المؤقت المرتبط بهذه الفاتورة لتجنب تكرار المبالغ
        liabilities = liabilities.filter(l => l.purchaseInvoiceId !== purchase.id);
        
        purchaseInvoices.push(purchase);
        pendingPurchases.splice(purchaseIndex, 1);
        
        logOperation("استلام وتسديد شامل", `تم استلام بضاعة وتسديد المتبقي شامل المصاريف من حساب "${account.name}".`);
        showGlobalMessage("تم الاستلام النهائي وتحديث المخزون بالتصنيفات والتكاليف الشاملة بنجاح.", false);
        
        d('pending-purchase-payment-form').classList.add('hidden');
        updateUI();

        // مزامنة سحابية (اختياري)
        if (typeof saveSystemToCloud === 'function') {
            await saveSystemToCloud();
        }
    });
}

if (ppCancelBtn) {
    ppCancelBtn.addEventListener('click', () => {
        d('pending-purchase-payment-form').classList.add('hidden');
        showMessage(d('pp-payment-message'), "");
    });
}
// =======================================================
// START: Returns Section Event Listeners
// =======================================================
if (returnProductSelect) {
    returnProductSelect.addEventListener('change', () => {
        const selectedOption = returnProductSelect.options[returnProductSelect.selectedIndex];
        const cost = selectedOption ? parseFloat(selectedOption.dataset.cost) : 0;
        if (d('return-sale-price-display')) d('return-sale-price-display').textContent = formatCurrency(cost);
        if (d('return-cost-price-display')) d('return-cost-price-display').textContent = formatCurrency(cost);
    });
}



if (confirmManualReturnBtn) {
    confirmManualReturnBtn.addEventListener('click', handleManualReturn);
}
// أضف هذا الكود داخل دالة initializeApp
if (d('return-type-selector')) {
    d('return-type-selector').addEventListener('change', updateReturnFormVisibility);
}

if (searchInvoiceBtn) {
    searchInvoiceBtn.addEventListener('click', handleInvoiceSearchForReturn);
}

if (invoiceSearchResults) {
    invoiceSearchResults.addEventListener('click', (e) => {
        if (e.target.id === 'confirm-invoice-return-btn') {
            handleInvoiceReturnConfirmation(e.target.dataset.invoiceId, e.target.dataset.invoiceNumber);
        }
    });
}

if (pendingReceiptList) {
    pendingReceiptList.addEventListener('click', (e) => {
        const button = e.target.closest('.confirm-receipt-btn');
        if (button) {
            handleConfirmReceipt(button.dataset.pendingReturnId);
        }
    });
}
// =======================================================
// END: Returns Section Event Listeners
// =======================================================
                 if (generateReportButton) { generateReportButton.addEventListener("click", generateMonthlySalesReport); }
                 if (d('generate-exp-report-button')) { d('generate-exp-report-button').addEventListener('click', generateExpensesReport); }
                 if (addSupplierButton) { 
    addSupplierButton.addEventListener("click", () => {
        saveStateToHistory(); // <-- أضف هذا السطر
        addOrUpdateSupplier();
    }); 
}
                 if (cancelEditSupplierButton) { cancelEditSupplierButton.addEventListener("click", resetSupplierForm); }
                 if (supplierList) { supplierList.addEventListener('click', (e) => { const target = e.target.closest('button'); if (!target) return; const supplierId = target.dataset.supplierId; if (!supplierId) return; if (target.classList.contains('edit-supplier-btn')) { editSupplier(supplierId); } else if (target.classList.contains('delete-supplier-btn')) {saveStateToHistory();
                  deleteSupplier(supplierId); } }); }

                 // **** جديد: مستمع حدث لزر استيراد CSV للسيريالات (في قسم إضافة البضاعة) ****
                 if (importSerialCsvInput) {
                     importSerialCsvInput.addEventListener("change", (event) => importSerialCSV(event, productSerialNumbersTextarea, serialImportMessage));
                 }
                  // **** جديد: مستمع حدث لزر استيراد CSV للسيريالات (في نافذة الإدارة) ****
                 if (modal_importSerialCsvInput) {
                     modal_importSerialCsvInput.addEventListener("change", (event) => importSerialCSV(event, modal_productSerialNumbers, d('modal-serial-import-message')));
                 }

                 // **** جديد: مستمع حدث زر البحث عن السيريالات ****
                 if (searchSupplierSerialsBtn) {
                     searchSupplierSerialsBtn.addEventListener('click', searchSerialsBySupplier);
                     // Optional: Trigger search on Enter key in the input field
                     searchSupplierSerialNameInput?.addEventListener('keypress', function (e) {
                         if (e.key === 'Enter') {
                             searchSerialsBySupplier();
                         }
                     });
                 }
                 // **** جديد: مستمع حدث لفلترة السيريالات المعروضة ****
                 if (filterSerialsInput) {
                     filterSerialsInput.addEventListener('input', (e) => {
                         displayFilteredSupplierSerials(e.target.value);
                     });
                 }

                 // **** جديد: مستمعات أحداث نافذة إدارة السيريالات ****
                 if (modal_saveAddedSerialsBtn) {
                     modal_saveAddedSerialsBtn.addEventListener('click', saveAddedSerialsFromModal);
                 }
                 if (modal_closeBtns) {
                     modal_closeBtns.forEach(btn => btn.addEventListener('click', closeManageSerialsModal));
                 }
                 // Close modal if clicked outside the content
                 window.addEventListener('click', function(event) {
                     if (event.target == manageSerialsModal) {
                         closeManageSerialsModal();
                     }
                     if (event.target == inv_modal) { // Close invoice modal too
                         inv_closeModal();
                     }
                 });


                 // Invoice Modal Listeners
                 if(inv_openInvoiceModalBtn) { inv_openInvoiceModalBtn.addEventListener('click', inv_openModal); }
                 if(inv_closeBtn) { inv_closeBtn.addEventListener('click', inv_closeModal); }
                 if(inv_closeBtnFooter) { inv_closeBtnFooter.addEventListener('click', inv_closeModal); }
                 if (inv_addPhoneBtn) { inv_addPhoneBtn.addEventListener('click', function() { inv_phoneCounter++; const newPhoneEntry = document.createElement('div'); newPhoneEntry.classList.add('form-row', 'inv-phone-entry'); newPhoneEntry.innerHTML = `<div class="form-group"><label for="inv_phone${inv_phoneCounter}">رقم هاتف ${inv_phoneCounter}:</label><input type="tel" id="inv_phone${inv_phoneCounter}" name="phone[]" placeholder="رقم الهاتف"></div><button type="button" class="remove-phone-btn no-print" title="حذف الرقم">×</button>`; if(inv_phoneNumbersContainer) inv_phoneNumbersContainer.appendChild(newPhoneEntry); }); }
                 if (inv_phoneNumbersContainer) { inv_phoneNumbersContainer.addEventListener('click', function(event) { const button = event.target.closest('.remove-phone-btn'); if (button) { button.closest('.inv-phone-entry')?.remove(); } }); }
                 if (inv_addItemBtn) { inv_addItemBtn.addEventListener('click', inv_addInvoiceItem); }
                 if (inv_invoiceItemsBody) { inv_invoiceItemsBody.addEventListener('click', function(event) { const button = event.target.closest('.remove-item-btn'); if (button) { const row = button.closest('.invoice-item-row'); if(row) { // **** إعادة السيريال للحالة المتاحة عند حذف البند من الفاتورة ****
                     const removedSerial = row.dataset.itemSerial; if (removedSerial) { const serialIndex = serialNumbersLog.findIndex(log => log.serial === removedSerial); if (serialIndex !== -1 && serialNumbersLog[serialIndex].status === 'in_invoice_temp') { // تأكد أنه كان محجوزاً لهذه الفاتورة
                         serialNumbersLog[serialIndex].status = 'in_stock'; console.log(`Serial ${removedSerial} status reverted to 'in_stock' on item removal.`); } } row.remove(); inv_calculateTotals(); inv_updateDeductibleCostsCheckboxes(); } } }); }
                 if(inv_shippingCostInput) { inv_shippingCostInput.addEventListener('input', inv_calculateTotals); }
                 if (inv_saveInvoiceBtn) { inv_saveInvoiceBtn.addEventListener('click', handleSaveInvoice); }
                 if (inv_printInvoiceBtn) { inv_printInvoiceBtn.addEventListener('click', () => inv_printInvoice()); } // Call without args for direct print
                 // **** جديد: مستمعات الأحداث للتعامل مع اختيار وبحث السيريال في الفاتورة ****
                 if (inv_itemQtyInput && inv_serialSelectContainer) {
                     inv_itemQtyInput.addEventListener('input', () => {
                         const qty = parseInt(inv_itemQtyInput.value);
                         const itemName = inv_itemNameInput.value.trim();
                         const productHasSerialsRegistered = serialNumbersLog.some(log => log.productName === itemName);
                         if (qty === 1 && itemName && products.some(p => p.name === itemName) && productHasSerialsRegistered) {
                             const hasSerials = populateAvailableSerials(itemName, inv_itemSerialSelect, inv_serialSearchInput.value);
                             inv_serialSelectContainer.classList.remove('hidden');
                             if (!hasSerials && !inv_serialSearchInput.value) { // Show error only if no serials exist at all (and no search term)
                                 showMessage(inv_itemAddErrorDiv, `لا توجد أرقام تسلسلية متاحة في المخزون للمنتج "${itemName}".`, true);
                             } else if(!hasSerials && inv_serialSearchInput.value) {
                                 showMessage(inv_itemAddErrorDiv, `لا توجد أرقام تسلسلية مطابقة للبحث.`, false, true); // Info if search yields no results
                             } else {
                                  showMessage(inv_itemAddErrorDiv, ""); // Clear message if serials found
                             }
                         } else {
                             inv_serialSelectContainer.classList.add('hidden');
                             inv_itemSerialSelect.value = '';
                             inv_serialSearchInput.value = '';
                             showMessage(inv_itemAddErrorDiv, "");
                         }
                     });
                     // أخف القائمة أيضاً عند تغيير اسم المنتج
                    
                 }
                 // مستمع حدث لحقل بحث السيريال لتحديث القائمة المنسدلة
                 if(inv_serialSearchInput && inv_itemSerialSelect && inv_itemNameInput) {
                     inv_serialSearchInput.addEventListener('input', () => {
                         const itemName = inv_itemNameInput.value.trim();
                         const searchTerm = inv_serialSearchInput.value;
                         if (itemName && inv_serialSelectContainer && !inv_serialSelectContainer.classList.contains('hidden')) {
                             populateAvailableSerials(itemName, inv_itemSerialSelect, searchTerm);
                         }
                     });
                 }


                 // Search Listeners
              // --- ربط أحداث البحث الذكي الشامل ---
if (smartSearchBtn) {
    smartSearchBtn.addEventListener('click', performSmartGlobalSearch);
}

if (smartSearchInput) {
    smartSearchInput.addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            performSmartGlobalSearch();
        }
    });
}
                 if(searchResultsListContainer) {
                     searchResultsListContainer.addEventListener('click', (event) => {
                         const button = event.target.closest('.view-invoice-details-btn');
                         if (button && button.dataset.invoiceId) {
                             viewInvoiceDetails(button.dataset.invoiceId);
                         }
                     });
                 }
              // --- كود تشغيل نافذة الطوارئ والاستعادة ---
    
    // 1. تشغيل الزر الرئيسي في صفحة الإعدادات
    if (openBackupHistoryButton) {
        openBackupHistoryButton.addEventListener('click', openBackupHistoryModal);
    }

    // 2. تفعيل أزرار النافذة نفسها (الإغلاق والاستعادة)
    if (backupHistoryModal) {
        // إغلاق النافذة عند الضغط على الخلفية أو زر الإغلاق
        backupHistoryModal.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal') || 
                e.target.closest('.modal-close-btn') || 
                e.target.closest('.modal-close-btn-footer')) {
                // دالة إغلاق النافذة (تأكد من وجودها أو استخدم الكود المباشر)
                if (typeof closeBackupHistoryModal === 'function') {
                    closeBackupHistoryModal();
                } else {
                    backupHistoryModal.style.display = 'none';
                }
            }
        });

        // تنفيذ الاستعادة عند الضغط على الزر الأخضر داخل القائمة
        backupHistoryModal.addEventListener('click', async (e) => {
            const btn = e.target.closest('.restore-backup-btn');
            if (!btn) return;

            const key = btn.dataset.backupKey;
            if (!key) return;

            if (confirm("هل أنت متأكد من استعادة هذه النسخة المحلية؟\nسيتم استبدال البيانات المعروضة حالياً بهذه النسخة.")) {
                try {
                    const raw = localStorage.getItem(key);
                    if (raw) {
                        const data = JSON.parse(raw);
                        const dateStr = data.savedForDate || currentLoadedDate;
                        
                        console.log("Restoring backup from key:", key);

                        // تحميل البيانات للذاكرة (المتغيرات)
                        loadState(data, dateStr);
                        
                        // تحديث الواجهة فوراً
                        updateUI();
                        
                        // إغلاق النافذة
                        backupHistoryModal.style.display = 'none';
                        
                        // 🔥 خطوة ذكية: حفظ النسخة المستعادة فوراً للسحابة لتثبيتها 🔥
                        await saveCurrentStateByDate(dateStr);
                        
                        alert("تمت الاستعادة بنجاح! وتمت مزامنة البيانات المستعادة مع السحابة.");
                    }
                } catch (err) {
                    console.error("Restore error:", err);
                    alert("حدث خطأ أثناء استعادة الملف: " + err.message);
                }
            }
        });
    }

// إسناد متغيرات عناصر البحث
reportSearchInput = d('report-search-input');
reportClearSearchBtn = d('report-clear-search-btn');
salesReportSearchContainer = d('sales-report-search-container');
reportDirectSearchBtn = d('report-direct-search-btn'); // <== السطر الجديد

// ربط البحث المباشر (الطريقة 2)
if (reportDirectSearchBtn) {
    reportDirectSearchBtn.addEventListener('click', performDirectSearch);
}

// ربط تصفية النتائج المعروضة (الطريقة 1)
if (reportSearchInput) {
    reportSearchInput.addEventListener('input', () => {
        // يتم التصفية فقط للبيانات المحملة بالفعل
        displaySalesReport(currentMonthlySalesData);
    });
}

// ربط وظيفة زر مسح البحث
if (reportClearSearchBtn) {
    reportClearSearchBtn.addEventListener('click', () => {
        if (reportSearchInput) reportSearchInput.value = '';
        displaySalesReport(currentMonthlySalesData); // أعد عرض كل النتائج المحملة
    });
}
// ... بعد كل أسطر addEventListener الأخرى ...

    // --- ربط وتشغيل ميزة الحفظ التلقائي ---
    const autoSaveToggle = d('auto-save-toggle');
    if (autoSaveToggle) {
        // ربط الزر بالدالة
        autoSaveToggle.addEventListener('change', toggleAutoSave);

        // التحقق من التفضيل المحفوظ عند بدء تشغيل البرنامج
        const savedAutoSavePref = fetchData(lsAutoSaveKey, false);
        if (savedAutoSavePref === true) {
            autoSaveToggle.checked = true; // اجعل الزر في وضعية "التشغيل"
            toggleAutoSave(); // قم بتفعيل الحفظ التلقائي مباشرة
        }
    }
    // --- Event Listeners for Account Management (STEP 2) ---
const accountForm = document.getElementById('account-form');
const accountsList = document.getElementById('accounts-list');
const cancelEditBtn = document.getElementById('cancel-edit-account-btn');

if (accountForm) {
    accountForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const accountNameInput = document.getElementById('account-name-input');
        const accountBalanceInput = document.getElementById('account-balance-input');
        const accountIdInput = document.getElementById('account-id-input');
        
        const name = accountNameInput.value.trim();
        const balance = parseFloat(accountBalanceInput.value) || 0;
        const id = accountIdInput.value;

        if (!name) {
            alert('يرجى إدخال اسم للحساب.');
            return;
        }

        if (id) { // Editing existing account
            const account = accounts.find(acc => acc.id === id);
            if(account) {
                 if (accounts.some(acc => acc.name.toLowerCase() === name.toLowerCase() && acc.id !== id)) {
                    alert('اسم الحساب موجود بالفعل.');
                    return;
                }
                logOperation("تعديل حساب", `تم تغيير اسم حساب "${account.name}" إلى "${name}".`);
                account.name = name;
            }
        } else { // Adding new account
            if (accounts.some(acc => acc.name.toLowerCase() === name.toLowerCase())) {
                alert('اسم الحساب موجود بالفعل.');
                return;
            }
            const newAccount = { id: `acc-${Date.now()}`, name: name, balance: balance };
            accounts.push(newAccount);
            logOperation("إضافة حساب", `تم إنشاء حساب جديد "${name}" برصيد افتتاحي ${formatCurrency(balance)}.`);
        }
        
        updateUI();
        resetAccountForm();
    });
}

if (cancelEditBtn) {
    cancelEditBtn.addEventListener('click', resetAccountForm);
}

if (accountsList) {
    accountsList.addEventListener('click', (e) => {
        const target = e.target.closest('button');
        if (!target) return;
        const id = target.dataset.id;
        if (!id) return;

        if (target.classList.contains('edit-btn')) {
            const account = accounts.find(acc => acc.id === id);
            if (account) {
                document.getElementById('account-id-input').value = account.id;
                document.getElementById('account-name-input').value = account.name;
                document.getElementById('account-form-title').textContent = `تعديل حساب: ${account.name}`;
                document.getElementById('save-account-btn').textContent = 'تحديث الاسم';
                document.getElementById('starting-balance-group').classList.add('hidden');
                document.getElementById('cancel-edit-account-btn').classList.remove('hidden');
                document.getElementById('account-name-input').focus();
            }
        }

        if (target.classList.contains('delete-btn')) {
            const account = accounts.find(acc => acc.id === id);
            if (account.balance > 0) {
                 if (!confirm(`تحذير: حساب "${account.name}" يحتوي على رصيد (${formatCurrency(account.balance)}).\nهل أنت متأكد من حذفه؟ سيتم فقدان هذا المبلغ.`)) {
                    return;
                }
            } else if (!confirm(`هل أنت متأكد من حذف حساب "${account.name}"؟`)){
                 return;
            }
            
            accounts = accounts.filter(acc => acc.id !== id);
            logOperation("حذف حساب", `تم حذف حساب "${account.name}".`);
            updateUI();
        }
    });
}
const addIncomeBtn = d('add-income-btn');
const addExpenseBtn = d('add-expense-btn');
const transferBtn = d('transfer-btn');
const adjustBalanceBtn = d('adjust-balance-btn');

if (addIncomeBtn) {
    addIncomeBtn.addEventListener('click', () => {
        if (handleIncomeAddition()) {
            updateUI();
            d('income-amount-input').value = '';
        }
    });
}
if (addExpenseBtn) {
    addExpenseBtn.addEventListener('click', () => {
        if (handleExpenseAddition()) {
            updateUI();
            d('expense-amount-input').value = '';
        }
    });
}
if (transferBtn) {
    transferBtn.addEventListener('click', () => {
        if (handleTransfer()) {
            updateUI();
            d('transfer-amount-input').value = '';
        }
    });
}
if (adjustBalanceBtn) {
    adjustBalanceBtn.addEventListener('click', () => {
        if (handleBalanceAdjustment()) {
            updateUI();
            d('adjust-amount-input').value = '';
            d('adjust-reason-input').value = '';
        }
    });
}
const actionTabsContainer = document.querySelector('.action-tabs');
if (actionTabsContainer) {
    actionTabsContainer.addEventListener('click', (e) => {
        const targetButton = e.target.closest('button');
        if (targetButton) {
            const tabId = targetButton.dataset.target;
            if (tabId) {
                showTab(tabId);
            }
        }
    });


}


    // --- Initial Load Logic ---
    const todayString = getTodayDateString();
    // =======================================================
// START: Returns Section Event Listeners
// =======================================================
if (returnProductSelect) {
    returnProductSelect.addEventListener('change', () => {
        const selectedOption = returnProductSelect.options[returnProductSelect.selectedIndex];
        const cost = selectedOption.dataset.cost || 0;
        if (returnCostPriceDisplay) returnCostPriceDisplay.textContent = formatCurrency(cost);
    });
}



if (confirmManualReturnBtn) {
    confirmManualReturnBtn.addEventListener('click', handleManualReturn);
}
// =======================================================
// END: Returns Section Event Listeners
// =======================================================
    // --- Purchase Invoice (PI) Event Listeners ---
if (piAddItemBtn) {
    piAddItemBtn.addEventListener('click', pi_addItem);
}

if (piItemNameInput) {
    piItemNameInput.addEventListener('change', () => {
        const name = piItemNameInput.value.trim();
        const product = products.find(p => p.name.toLowerCase() === name.toLowerCase());
        if (product && piItemCostInput) {
            piItemCostInput.value = product.costPrice.toFixed(2);
            showMessage(piItemAddMessage, `تم جلب متوسط التكلفة للمنتج "${name}".`, false, true);
        }
    });
}

if (piItemQuantityInput) {
    piItemQuantityInput.addEventListener('input', () => {
        const qty = parseInt(piItemQuantityInput.value);
        if (qty > 0) {
            piItemSerialsContainer.classList.remove('hidden');
        } else {
            piItemSerialsContainer.classList.add('hidden');
        }
    });
}

if (piItemsBody) {
    piItemsBody.addEventListener('click', (e) => {
        if (e.target.classList.contains('pi_remove_item_btn')) {
            e.target.closest('tr').remove();
            pi_updateTotals();
            if (piItemsBody.children.length === 0) {
                pi_no_items_msg.classList.remove('hidden');
            }
        }
    });
}
piPaidAmountInput = d('pi_paid_amount');
if (piPaidAmountInput) {
    piPaidAmountInput.addEventListener('input', function() {
        // نستخدم window لضمان مناداة الدالة الجديدة الموجودة في الشارع الرئيسي
        if (window.pi_updateTotals) {
            window.pi_updateTotals();
        }
    });
}

if (piClearFormBtn) {
    piClearFormBtn.addEventListener('click', pi_clearForm);
}
if (piConfirmBtn) {
    piConfirmBtn.addEventListener('click', pi_confirmPurchaseInvoice);
}
if (d('pending-purchases-container')) {
    d('pending-purchases-container').addEventListener('click', handlePendingPurchaseActions);
}


// البحث عن تفاصيل فاتورة الشراء من الالتزامات
if (d('liabilities-list-container')) {
    d('liabilities-list-container').addEventListener('click', async (e) => {
        const target = e.target.closest('.view-purchase-invoice-btn');
        if (target) {
            const invoiceId = target.dataset.purchaseInvoiceId;
            console.log("🔍 جاري محاولة جلب الفاتورة رقم:", invoiceId);

            if (!invoiceId) {
                alert("تنبيه: هذه الفاتورة قديمة ولا تملك معرّفاً سحابياً.");
                return;
            }

            let invoice = purchaseInvoices.find(inv => inv.id === invoiceId);

            if (!invoice && window.currentUser) {
                const statusEl = document.getElementById('global-message');
                if(statusEl) showMessage(statusEl, "جاري البحث في الأرشيف السحابي...", false, true);
                
                try {
                    const docRef = window.doc(window.db, "users", window.currentUser.uid, "purchase_archives", invoiceId);
                    const docSnap = await window.getDoc(docRef);
                    if (docSnap.exists()) {
                        invoice = docSnap.data();
                        console.log("✅ تم العثور على الفاتورة في السحابة.");
                    }
                } catch (err) {
                    console.error("❌ خطأ في الاتصال بالسحابة:", err);
                }
                if(statusEl) showMessage(statusEl, "");
            }

            if (invoice) {
                // عرض التفاصيل (نفس منطق Alert السابق)
                let details = `📦 تفاصيل الفاتورة من الأرشيف:\n----------------------------\n`;
                details += `رقمها: ${invoice.invoiceNumber || 'N/A'}\nإجمالي: ${formatCurrency(invoice.grandTotal)}\n`;
                details += `المتبقي: ${formatCurrency(invoice.remainingBalance)}\n\nالبنود:\n`;
                invoice.items.forEach(item => details += `- ${item.quantity}x ${item.name} (${formatCurrency(item.cost)})\n`);
                alert(details);
            } else {
                alert('عذراً، لم يتم العثور على تفاصيل هذه الفاتورة في الأرشيف السحابي.');
            }
        }
    });
}
    // لا داعي للبحث عن آخر يوم محفوظ، سنقوم بالتحميل مباشرة
    await loadDataForDate(todayString);

    // بعد التأكد من تحميل البيانات، نقوم بتحديث الواجهة بالكامل
    updateUI();

    // تعيين القيم الافتراضية لحقول التاريخ
    if (loadDateInputAlt) {
        loadDateInputAlt.value = currentLoadedDate;
        updateLoadDateDayName(currentLoadedDate, loadDateDayNameDisplayAlt);
    }
    if (reportMonthYearInput && currentLoadedDate) {
        reportMonthYearInput.value = currentLoadedDate.substring(0, 7);
    }

    // تشغيل الساعة
    updateTimeDisplay();
    setInterval(updateTimeDisplay, 1000);

    console.log("Initialization complete. Final loaded date:", currentLoadedDate);



    if (d('return-sale-price-group')) {
    const returnTypeRadios = document.querySelectorAll('input[name="return-type"]');
    returnTypeRadios.forEach(radio => {
        radio.addEventListener('change', () => {
            const selectedType = document.querySelector('input[name="return-type"]:checked').value;
            if (d('return-sale-price-group') && d('return-cost-price-group')) {
                d('return-sale-price-group').classList.toggle('hidden', selectedType === 'cost');
                d('return-cost-price-group').classList.toggle('hidden', selectedType === 'sale');
            }
        });
    });
}
}
// 1. تعريف متغيرات واجهة المصادقة وتعيينها مرة واحدة فقط
    const authContainer = d('auth-container');
    const mainContent = d('main-content');
    const logoutBtn = d('logout-btn');
    const loginBtn = d('login-btn');
    const registerBtn = d('register-btn');
    const authError = d('auth-error');

    // 2. ربط أزرار المصادقة بوظائفها
    if (loginBtn) {
        loginBtn.addEventListener('click', () => {
            if(!authError) return;
            const email = d('auth-email').value;
            const password = d('auth-password').value;
            window.signInWithEmailAndPassword(window.auth, email, password)
                .catch(error => { showMessage(authError, "فشل تسجيل الدخول: " + error.message, true); });
        });
    }
    if (registerBtn) {
        registerBtn.addEventListener('click', () => {
            if(!authError) return;
            const email = d('auth-email').value;
            const password = d('auth-password').value;
            window.createUserWithEmailAndPassword(window.auth, email, password)
                .catch(error => { showMessage(authError, "فشل التسجيل: " + error.message, true); });
        });
    }
    if (logoutBtn) {
        logoutBtn.addEventListener('click', () => {
            window.signOut(window.auth);
        });
    }

    // 3. تشغيل "حارس البوابة" الذي يقرر ما سيظهر للمستخدم
    window.onAuthStateChanged(window.auth, (user) => {
        if (user) {
            // المستخدم مسجل دخوله
            if(authContainer) authContainer.classList.add('hidden');
            if(mainContent) mainContent.classList.remove('hidden');
            if(logoutBtn) logoutBtn.classList.remove('hidden');
            
            window.currentUser = user; 

            // تشغيل البرنامج الرئيسي مرة واحدة فقط
            if (!window.appInitialized) {
                initializeApp(); 
                window.appInitialized = true;
            }
        } else {
            // المستخدم غير مسجل
            if(authContainer) authContainer.classList.remove('hidden');
            if(mainContent) mainContent.classList.add('hidden');
            if(logoutBtn) logoutBtn.classList.add('hidden');
            window.currentUser = null;
            window.appInitialized = false;
        }
    });
    // --- START: PARTIAL LIABILITY PAYMENT LOGIC ---

partialLiabilityPaymentModal = d('partialLiabilityPaymentModal');
 partialLiabilityPaymentMessage = d('partial-liability-payment-message');

// Function to open the partial liability payment modal
function openPartialLiabilityPaymentModal(liabilityId) {
    const liability = liabilities.find(l => l.id === liabilityId);
    if (!liability) {
        showGlobalMessage("خطأ: لم يتم العثور على الالتزام المحدد.", true);
        return;
    }

    const accountSelect = d('partial-liability-payment-account');
    accountSelect.innerHTML = '<option value="">-- اختر الحساب --</option>';
    accounts.forEach(acc => {
        accountSelect.innerHTML += `<option value="${acc.id}">${acc.name} (${formatCurrency(acc.balance)})</option>`;
    });

    d('partial-liability-creditor-name').textContent = liability.name;
    d('partial-liability-total-amount').textContent = formatCurrency(liability.amount);
    d('partial-liability-payment-amount').value = '';
    d('partial-liability-payment-amount').max = liability.amount;
    d('confirm-partial-liability-payment-btn').dataset.liabilityId = liability.id;
    
    showMessage(partialLiabilityPaymentMessage, "");
    partialLiabilityPaymentModal.style.display = 'block';
}

// Function to close the modal
function closePartialLiabilityPaymentModal() {
    partialLiabilityPaymentModal.style.display = 'none';
}

// Event listener for the new "Pay" button (using event delegation on the body)
document.body.addEventListener('click', (e) => {
    const payButton = e.target.closest('#liabilities-list .pay-liability-btn');
    if (payButton) {
        const liabilityId = payButton.dataset.liabilityId;
        if (liabilityId) {
            openPartialLiabilityPaymentModal(liabilityId);
        }
    }
});

// Event listener for the modal's confirm button
d('confirm-partial-liability-payment-btn').addEventListener('click', () => {
    const liabilityId = d('confirm-partial-liability-payment-btn').dataset.liabilityId;
    const liabilityIndex = liabilities.findIndex(l => l.id === liabilityId);
    if (liabilityIndex === -1) {
        showMessage(partialLiabilityPaymentMessage, "خطأ: لم يتم العثور على الالتزام.", true);
        return;
    }

    const amountToPay = parseInputNumber(d('partial-liability-payment-amount'));
    const accountId = d('partial-liability-payment-account').value;
    const account = accounts.find(acc => acc.id === accountId);
    const liability = liabilities[liabilityIndex];

    // Validation
    if (isNaN(amountToPay) || amountToPay <= 0) {
        showMessage(partialLiabilityPaymentMessage, "الرجاء إدخال مبلغ صحيح أكبر من صفر.", true);
        return;
    }
    if (amountToPay > liability.amount + 0.001) {
        showMessage(partialLiabilityPaymentMessage, "المبلغ المدفوع أكبر من قيمة الالتزام.", true);
        return;
    }
    if (!account) {
        showMessage(partialLiabilityPaymentMessage, "الرجاء اختيار حساب للدفع منه.", true);
        return;
    }
    if (amountToPay > account.balance) {
        showMessage(partialLiabilityPaymentMessage, `رصيد حساب "${account.name}" غير كافٍ.`, true);
        return;
    }
    
    saveStateToHistory("تسديد جزء من التزام");

    // Process payment
    liability.amount -= amountToPay;
    account.balance -= amountToPay;

    logOperation("تسديد جزء من التزام", `تسديد ${formatCurrency(amountToPay)} من التزام "${liability.name}" من حساب "${account.name}".`);
    
    // Remove liability if it's fully paid
    if (liability.amount < 0.01) {
        liabilities.splice(liabilityIndex, 1);
    }
    
    updateUI();
    closePartialLiabilityPaymentModal();
    showGlobalMessage(`تم تسديد مبلغ ${formatCurrency(amountToPay)} بنجاح.`, false);
});

// Event listeners for closing the modal
partialLiabilityPaymentModal.querySelectorAll('.modal-close-btn, .modal-close-btn-footer').forEach(btn => {
    btn.addEventListener('click', closePartialLiabilityPaymentModal);
});
window.addEventListener('click', (event) => {
    if (event.target == partialLiabilityPaymentModal) {
        closePartialLiabilityPaymentModal();
    }
});

// --- END: PARTIAL LIABILITY PAYMENT LOGIC ---
// --- START: PARTIAL DEBT PAYMENT LOGIC ---

 partialDebtPaymentModal = d('partialDebtPaymentModal');
 partialDebtPaymentMessage = d('partial-debt-payment-message');

// Function to open the partial debt payment modal
function openPartialDebtPaymentModal(debtId) {
    const debt = debtors.find(d => d.id === debtId);
    if (!debt) {
        showGlobalMessage("خطأ: لم يتم العثور على الدين المحدد.", true);
        return;
    }

    const accountSelect = d('partial-debt-payment-account');
    accountSelect.innerHTML = '<option value="">-- اختر الحساب --</option>';
    accounts.forEach(acc => {
        accountSelect.innerHTML += `<option value="${acc.id}">${acc.name} (${formatCurrency(acc.balance)})</option>`;
    });

    d('partial-debtor-name').textContent = debt.name;
    d('partial-debt-reason').textContent = debt.reason || 'دين عام';
    d('partial-debt-total-amount').textContent = formatCurrency(debt.amount);
    
    const amountInput = d('partial-debt-payment-amount');
    amountInput.value = '';
    amountInput.max = debt.amount;
    
    d('confirm-partial-debt-payment-btn').dataset.debtId = debt.id;
    
    showMessage(partialDebtPaymentMessage, "");
    partialDebtPaymentModal.style.display = 'block';
    amountInput.focus();
}

// Function to close the modal
function closePartialDebtPaymentModal() {
    partialDebtPaymentModal.style.display = 'none';
}

// ✅✅✅ الكود الجديد والصحيح لجميع النقرات في قائمة الديون ✅✅✅
if (debtorsListContainer) {
    debtorsListContainer.addEventListener('click', (e) => {
        const payPartialButton = e.target.closest('.pay-partial-debt-btn');
        const receiveAllButton = e.target.closest('.receive-all-debt-btn');

        if (payPartialButton) {
            console.log("Pay Partial Button Clicked!"); // للتأكد من أن الزر يعمل
            const debtId = payPartialButton.dataset.debtId;
            if (debtId) {
                openPartialDebtPaymentModal(debtId);
            }
            return; // أوقف التنفيذ هنا لمنع التعارض
        }

        if (receiveAllButton) {
            console.log("Receive All Button Clicked!"); // للتأكد من أن الزر يعمل
            const debtorName = receiveAllButton.dataset.debtorName;
            if (debtorName) {
                toggleInlinePaymentForm(debtorName);
            }
            return; // أوقف التنفيذ هنا
        }
    });
}

// Event listener for the modal's confirm button
d('confirm-partial-debt-payment-btn').addEventListener('click', () => {
    const debtId = d('confirm-partial-debt-payment-btn').dataset.debtId;
    const debtIndex = debtors.findIndex(d => d.id === debtId);
    if (debtIndex === -1) {
        showMessage(partialDebtPaymentMessage, "خطأ: لم يتم العثور على الدين.", true);
        return;
    }

    const amountToPay = parseInputNumber(d('partial-debt-payment-amount'));
    const accountId = d('partial-debt-payment-account').value;
    const account = accounts.find(acc => acc.id === accountId);
    const debt = debtors[debtIndex];

    // Validation
    if (isNaN(amountToPay) || amountToPay <= 0) {
        showMessage(partialDebtPaymentMessage, "الرجاء إدخال مبلغ صحيح أكبر من صفر.", true);
        return;
    }
    if (amountToPay > debt.amount + 0.001) { // Add tolerance for floating point issues
        showMessage(partialDebtPaymentMessage, "المبلغ المدفوع أكبر من قيمة الدين.", true);
        return;
    }
    if (!account) {
        showMessage(partialDebtPaymentMessage, "الرجاء اختيار الحساب الذي سيتم إيداع المبلغ فيه.", true);
        return;
    }
    
    saveStateToHistory(); // For Undo functionality

    // Process payment
    debt.amount -= amountToPay;
    account.balance += amountToPay;

    const summaryText = `سداد جزئي من ${debt.name} (${debt.reason})`;
    logOperation("استلام سداد جزئي", `استلام ${formatCurrency(amountToPay)} في حساب "${account.name}" من دين "${debt.name}".`);
    
    const newTotalLiquidity = accounts.reduce((sum, acc) => sum + acc.balance, 0);
    liquidityLog.push({ id: `liq-${Date.now()}`, timestamp: new Date().toISOString(), type: "add", amount: amountToPay, description: summaryText, currentBalance: newTotalLiquidity });

    // Remove debt if it's fully paid
    if (debt.amount < 0.01) {
        debtors.splice(debtIndex, 1);
    }
    
    updateUI();
    closePartialDebtPaymentModal();
    showGlobalMessage(`تم استلام مبلغ ${formatCurrency(amountToPay)} بنجاح.`, false);
});

// Event listeners for closing the modal
partialDebtPaymentModal.querySelectorAll('.modal-close-btn, .modal-close-btn-footer').forEach(btn => {
    btn.addEventListener('click', closePartialDebtPaymentModal);
});
window.addEventListener('click', (event) => {
    if (event.target == partialDebtPaymentModal) {
        closePartialDebtPaymentModal();
    }
});
// =======================================================
// نظام العربونات الآمن (Safe Deposit System)
// =======================================================


// 2. تنفيذ العربون (حفظ)
window.confirmDeposit = function() {
    const pendingId = document.getElementById('dep_pending_id').value;
    const amount = parseFloat(document.getElementById('dep_amount').value);
    const accountId = document.getElementById('dep_account').value;
    
    if (!amount || amount <= 0) { alert("المبلغ غير صحيح"); return; }
    if (!accountId) { alert("يجب اختيار خزنة"); return; }

    const saleIndex = pendingSales.findIndex(s => s.id === pendingId);
    const account = accounts.find(a => a.id === accountId);

    if (saleIndex === -1 || !account) return;

    saveStateToHistory(); // نقطة استعادة

    // أ. زيادة السيولة (الخزنة)
    account.balance += amount;

    // ب. تسجيل العربون في البيعة
    const oldPaid = Number(pendingSales[saleIndex].depositPaid) || 0;
    pendingSales[saleIndex].depositPaid = oldPaid + amount;

    // ج. تسجيل في السجل المالي
    const totalLiquidity = accounts.reduce((sum, a) => sum + a.balance, 0);
    liquidityLog.push({
        id: `liq-dep-${Date.now()}`,
        timestamp: new Date().toISOString(),
        type: "add",
        amount: amount,
        description: `عربون من: ${pendingSales[saleIndex].customerName}`,
        currentBalance: totalLiquidity,
        accountId: account.id
    });

    // إغلاق وتحديث
    document.getElementById('depositModal').style.display = 'none';
    updateUI();
    alert(`تم استلام ${formatCurrency(amount)} بنجاح.`);
};

// ==========================================
// دالة عرض تفاصيل الربحية (النسخة الذكية - تنشئ النافذة ذاتياً)
// ==========================================
window.showPendingSaleDetails = function(pendingId) {
    const sale = pendingSales.find(s => s.id === pendingId);
    if (!sale) return;

    // 1. فحص وجود النافذة، وإنشاؤها إذا كانت مفقودة
    let modal = document.getElementById('pendingDetailsModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'pendingDetailsModal';
        modal.className = 'modal';
        modal.style.cssText = "display:none; position:fixed; z-index:9999; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.6); backdrop-filter: blur(2px);";
        
        modal.innerHTML = `
            <div class="modal-content" style="background-color:#fff; margin:5% auto; padding:0; border-radius:12px; width:90%; max-width:450px; overflow:hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
                <div style="background: linear-gradient(to right, #1e40af, #3b82f6); padding: 15px 20px; color: white; display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin:0; font-size:16px; font-weight:bold;">تفاصيل الربحية والتكلفة</h3>
                    <span onclick="document.getElementById('pendingDetailsModal').style.display='none'" style="cursor:pointer; font-size:24px; opacity:0.8;">&times;</span>
                </div>
                <div style="padding: 20px;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <h2 id="pd_product_name" style="margin: 0; font-size: 18px; color: #1f2937; font-weight: bold;">...</h2>
                        <p id="pd_customer_name" style="margin: 5px 0 0; color: #6b7280; font-size: 14px;">...</p>
                    </div>
                    <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px;">
                            <span style="color: #64748b;">تكلفة المنتج الأصلي:</span>
                            <span id="pd_main_cost" style="font-weight: bold; font-family: monospace;">0.00</span>
                        </div>
                        <div id="pd_attachments_container" style="display: none; border-top: 1px dashed #cbd5e1; padding-top: 8px; margin-top: 8px;">
                            <div style="font-size: 12px; color: #94a3b8; margin-bottom: 4px;">+ تكلفة الملحقات المضافة:</div>
                            <ul id="pd_attachments_list" style="margin: 0; padding-right: 15px; font-size: 13px; color: #475569;"></ul>
                            <div style="display: flex; justify-content: space-between; margin-top: 5px; font-weight: bold; font-size: 13px; color: #475569;">
                                <span>إجمالي تكلفة الملحقات:</span>
                                <span id="pd_attachments_cost">0.00</span>
                            </div>
                        </div>
                        <hr style="border: 0; border-top: 1px solid #e2e8f0; margin: 12px 0;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="color: #ef4444; font-weight: bold;">إجمالي التكلفة (عليك):</span>
                            <span id="pd_total_cost" style="color: #ef4444; font-weight: bold; font-family: monospace; font-size: 15px;">0.00</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="color: #1f2937; font-weight: bold;">سعر البيع (للعميل):</span>
                            <span id="pd_sell_price" style="color: #1f2937; font-weight: bold; font-family: monospace; font-size: 15px;">0.00</span>
                        </div>
                    </div>
                    <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 15px; text-align: center;">
                        <span style="display: block; font-size: 12px; color: #166534; font-weight: bold; text-transform: uppercase;">صافي الربح المتوقع</span>
                        <span id="pd_profit" style="display: block; font-size: 24px; color: #15803d; font-weight: 800; margin-top: 5px; font-family: monospace;">0.00</span>
                    </div>
                </div>
                <div style="background: #f9fafb; padding: 12px 20px; text-align: right; border-top: 1px solid #e5e7eb;">
                    <button onclick="document.getElementById('pendingDetailsModal').style.display='none'" style="background: #fff; border: 1px solid #d1d5db; padding: 6px 15px; border-radius: 6px; color: #374151; font-weight: bold; cursor: pointer;">إغلاق</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }

    // 2. تعبئة البيانات (الآن العناصر مضمونة الوجود)
    document.getElementById('pd_customer_name').textContent = sale.customerName || 'عميل غير مسجل';
    
    let mainProductName = "فاتورة مجمعة";
    let mainCost = 0;

    if (sale.mainProduct) {
        mainProductName = `${sale.mainProduct.quantity}x ${sale.mainProduct.name}`;
        mainCost = (Number(sale.mainProduct.costPrice) || 0) * (Number(sale.mainProduct.quantity) || 0);
    } else if (sale.items) {
        mainProductName = `فاتورة تحتوي على ${sale.items.length} بنود`;
        mainCost = sale.items.reduce((sum, item) => sum + ((Number(item.costPrice)||0) * (Number(item.quantity)||0)), 0);
    }
    
    document.getElementById('pd_product_name').textContent = mainProductName;
    document.getElementById('pd_main_cost').textContent = formatCurrency(mainCost);

    const attachmentsList = document.getElementById('pd_attachments_list');
    const attachmentsContainer = document.getElementById('pd_attachments_container');
    attachmentsList.innerHTML = '';
    
    const attachments = sale.additionalItems || (sale.invoiceData ? sale.invoiceData.deductedItems : []) || (sale.deductedItems) || [];
    
    let attachmentsTotalCost = 0;

    if (attachments.length > 0) {
        attachmentsContainer.style.display = 'block';
        attachments.forEach(att => {
            const attQty = Number(att.quantity) || 0;
            const attUnitCost = Number(att.costPrice) || 0;
            const attTotal = attQty * attUnitCost;
            attachmentsTotalCost += attTotal;

            const li = document.createElement('li');
            li.style.display = "flex";
            li.style.justifyContent = "space-between";
            li.style.marginBottom = "3px";
            li.innerHTML = `
                <span>${attQty}x ${att.name}</span>
                <span style="font-family: monospace;">${formatCurrency(attTotal)}</span>
            `;
            attachmentsList.appendChild(li);
        });
        document.getElementById('pd_attachments_cost').textContent = formatCurrency(attachmentsTotalCost);
    } else {
        attachmentsContainer.style.display = 'none';
    }

    const totalCalculatedCost = mainCost + attachmentsTotalCost;
    const sellPrice = Number(sale.totalSellPrice) || 0;
    const profit = sellPrice - totalCalculatedCost;

    document.getElementById('pd_total_cost').textContent = formatCurrency(totalCalculatedCost);
    document.getElementById('pd_sell_price').textContent = formatCurrency(sellPrice);
    
    const profitEl = document.getElementById('pd_profit');
    profitEl.textContent = formatCurrency(profit);
    profitEl.style.color = profit >= 0 ? '#15803d' : '#dc2626';

    modal.style.display = 'block';
};
// ==========================================
// دالة المزامنة اليدوية (لإصلاح الفواتير غير المرفوعة)
// ==========================================
async function syncLocalSalesToCloud() {
    if (!window.currentUser) {
        alert("يجب تسجيل الدخول أولاً.");
        return;
    }
    
    if (!salesToday || salesToday.length === 0) {
        alert("لا توجد فواتير مسجلة محلياً لليوم الحالي للمزامنة.");
        return;
    }

    const userId = window.currentUser.uid;
    let successCount = 0;
    let failCount = 0;

    // إظهار مؤشر تحميل على الزر
    const btn = document.querySelector('button[onclick="syncLocalSalesToCloud()"]');
    const originalText = btn ? btn.innerHTML : "";
    if(btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري المزامنة...'; }

    for (const sale of salesToday) {
        // التأكد من وجود تاريخ صالح
        if (!sale.saleDate) sale.saleDate = sale.timestamp.split('T')[0];
        
        try {
            // نستخدم setDoc مع merge لضمان عدم مسح بيانات إضافية إن وجدت
            const docRef = window.doc(window.db, "users", userId, "invoices", sale.id);
            await window.setDoc(docRef, sale, { merge: true });
            successCount++;
        } catch (e) {
            console.error("فشل رفع الفاتورة:", sale.id, e);
            failCount++;
        }
    }

    if(btn) { btn.disabled = false; btn.innerHTML = originalText; }
    
    alert(`تمت العملية:\n✅ تم رفع/تحديث: ${successCount} فاتورة.\n❌ فشل: ${failCount} فاتورة.`);
}
// ==========================================
// دالة المزامنة اليدوية (لإصلاح الفواتير غير المرفوعة)
// ==========================================
window.syncLocalSalesToCloud = async function() {
    // 1. التحقق من تسجيل الدخول
    if (!window.currentUser) {
        alert("يجب تسجيل الدخول أولاً.");
        return;
    }
    
    // 2. التحقق من وجود فواتير محلية
    if (typeof salesToday === 'undefined' || !salesToday || salesToday.length === 0) {
        alert("لا توجد فواتير مسجلة محلياً لليوم الحالي للمزامنة.");
        return;
    }

    const userId = window.currentUser.uid;
    let successCount = 0;
    let failCount = 0;

    // إظهار مؤشر تحميل على الزر (تجميد الزر لمنع التكرار)
    const btn = document.querySelector('button[onclick="syncLocalSalesToCloud()"]');
    const originalText = btn ? btn.innerHTML : "";
    if(btn) { 
        btn.disabled = true; 
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري المزامنة...'; 
    }

    // 3. بدء عملية الرفع
    console.log("Starting manual sync...");
    
    for (const sale of salesToday) {
        // ضمان وجود تاريخ صالح
        if (!sale.saleDate) {
            sale.saleDate = sale.timestamp ? sale.timestamp.split('T')[0] : new Date().toISOString().split('T')[0];
        }
        
        try {
            // نستخدم setDoc مع merge لضمان عدم مسح بيانات إضافية إن وجدت
            const docRef = window.doc(window.db, "users", userId, "invoices", sale.id);
            await window.setDoc(docRef, sale, { merge: true });
            successCount++;
        } catch (e) {
            console.error("فشل رفع الفاتورة:", sale.id, e);
            failCount++;
        }
    }

    // 4. إعادة الزر لحالته
    if(btn) { 
        btn.disabled = false; 
        btn.innerHTML = originalText; 
    }
    
    // 5. رسالة النتيجة
    alert(`تمت عملية المزامنة:\n✅ تم رفع/تحديث: ${successCount} فاتورة.\n❌ فشل: ${failCount} فاتورة.`);
};
// ==========================================
// أداة البحث عن الفواتير المفقودة
// ==========================================
window.debugShowAllInvoices = function() {
    if (!salesToday || salesToday.length === 0) {
        alert("⚠️ ذاكرة المتصفح (salesToday) فارغة تماماً! لم يتم حفظ أي فاتورة في هذه الجلسة.");
        return;
    }

    let report = "تقرير بكل الفواتير في الذاكرة:\n--------------------------------\n";
    
    salesToday.forEach((inv, index) => {
        report += `${index + 1}. رقم: ${inv.invoiceNumber || 'بدون'}\n`;
        report += `   - العميل: ${inv.customerName}\n`;
        report += `   - المبلغ: ${inv.grandTotal}\n`;
        report += `   - التاريخ المسجل: ${inv.saleDate} (Timestamp: ${inv.timestamp})\n`;
        report += `   - النوع: ${inv.type}\n`;
        report += "--------------------------------\n";
    });

    console.log(report); // طباعة في الكونسول للمراجعة الدقيقة
    alert(report); // إظهار للمستخدم
};
// ==========================================
// أداة إصلاح تواريخ الفواتير (لحل مشكلة الاختفاء من التقرير)
// ==========================================
window.fixInvoiceDates = async function() {
    if (!salesToday || salesToday.length === 0) {
        alert("⚠️ لا توجد فواتير حالياً في ذاكرة المتصفح لإصلاحها.");
        return;
    }

    // 1. طلب التاريخ الصحيح من المستخدم
    const defaultDate = new Date().toISOString().split('T')[0]; // تاريخ اليوم
    const correctDate = prompt("أدخل التاريخ الصحيح الذي تريد أن تظهر فيه هذه الفواتير (YYYY-MM-DD):", defaultDate);
    
    if (!correctDate) return; // إلغاء

    // 2. تغيير رسالة الزر للتحميل
    const msgBox = document.getElementById('global-message');
    if(msgBox) showMessage(msgBox, "جاري تصحيح التواريخ والمزامنة...", false, true);

    let count = 0;
    const userId = window.currentUser ? window.currentUser.uid : null;

    // 3. المرور على الفواتير وتصحيحها
    for (const inv of salesToday) {
        // تحديث التاريخ في الذاكرة المحلية
        inv.saleDate = correctDate;
        
        // إذا كان هناك اتصال، نحدث السحابة أيضاً
        if (userId) {
            try {
                 const docRef = window.doc(window.db, "users", userId, "invoices", inv.id);
                 await window.setDoc(docRef, inv, { merge: true });
            } catch(e) { 
                console.error("فشل تحديث السحابة للفاتورة:", inv.id); 
            }
        }
        count++;
    }

    // 4. حفظ النسخة المحلية الجديدة
    if(typeof saveCurrentStateByDate === 'function') {
        saveCurrentStateByDate(correctDate); 
    }

    alert(`✅ تم تصحيح تاريخ ${count} فاتورة إلى (${correctDate}).\n\nالآن اذهب لتقرير المبيعات واختر شهر (${correctDate.substring(0, 7)}) وستظهر الفواتير بإذن الله.`);
    if(msgBox) showMessage(msgBox, "تم التصحيح بنجاح.", false);
};
// ==========================================
// 1. دالة الحفظ الشامل للسحابة (القلب النابض)
// ==========================================
async function saveSystemToCloud() {
    // التحقق من وجود مستخدم
    if (!window.currentUser) return;
    const userId = window.currentUser.uid;
    
    // تحديد تاريخ اليوم للعمليات
    const dateStr = currentLoadedDate || new Date().toISOString().split('T')[0];
    
    // إظهار مؤشر حفظ صغير (اختياري)
    const statusEl = document.getElementById('global-message');
    if(statusEl && !statusEl.textContent) {
        statusEl.textContent = "جاري المزامنة...";
        statusEl.style.color = "blue";
        statusEl.classList.add('visible');
    }

    // تجهيز كائن البيانات الكامل (Snapshot)
    const systemState = {
        products: products || [],
        suppliers: suppliers || [],
        accounts: accounts || [],
        expenses: expenses || 0,
        debtors: debtors || [],
        liabilities: liabilities || [],
        monthlyLiabilities: monthlyLiabilities || [],
        pendingSales: pendingSales || [], // يشمل العربونات
        salesToday: salesToday || [],
        purchaseInvoices: purchaseInvoices || [],
        pendingPurchases: pendingPurchases || [],
        completedReturns: completedReturns || [],
        pendingReturns: pendingReturns || [],
        liquidityLog: liquidityLog || [],
        serialNumbersLog: serialNumbersLog || [],
        log: operationLog || [], // سجل العمليات
        
        savedAt: new Date().toISOString(),
        savedForDate: dateStr
    };

    // تنظيف البيانات (إزالة القيم غير المعرفة)
    const sanitizedState = JSON.parse(JSON.stringify(systemState));

    try {
        // 1. حفظ بيانات اليوم
        await window.setDoc(window.doc(window.db, "users", userId, "days", dateStr), sanitizedState);
        
        // 2. تحديث "ملخص الأرصدة" (للسرعة في الفتح لاحقاً)
        await window.setDoc(window.doc(window.db, "users", userId, "summaries", "latestBalances"), {
            ...sanitizedState,
            lastUpdated: new Date().toISOString()
        });

        console.log("✅ تمت المزامنة السحابية بنجاح.");
        
        // إخفاء مؤشر الحفظ
        if(statusEl && statusEl.textContent === "جاري المزامنة...") {
            statusEl.textContent = "تم الحفظ ✓";
            statusEl.style.color = "green";
            setTimeout(() => { 
                statusEl.textContent = ""; 
                statusEl.classList.remove('visible'); 
            }, 1500);
        }

    } catch (error) {
        console.error("❌ فشل المزامنة التلقائية:", error);
        // لا نزعج المستخدم برسالة خطأ في كل مرة، لكن نسجلها في الكونسول
    }
}
// ==========================================
// أداة تنظيف ملف اليوم من بيانات الأيام السابقة (Fix Carry Over Error)
// ==========================================
window.cleanCurrentDayData = async function() {
    if (!window.currentUser) {
        alert("يجب تسجيل الدخول أولاً.");
        return;
    }

    // 1. تحديد تاريخ اليوم الحالي المفتوح في البرنامج
    const targetDate = currentLoadedDate || new Date().toISOString().split('T')[0];
    
    // رسالة تأكيد حاسمة
    if (!confirm(`أنت الآن بصدد تنظيف ملف يوم (${targetDate}).\n\nسيقوم البرنامج بحذف أي مبيعات أو مصروفات مسجلة بتواريخ "سابقة" لهذا التاريخ (مثل 31-12) والتي انتقلت بالخطأ.\n\nهل أنت متأكد؟`)) return;

    const msgBox = document.getElementById('global-message');
    if(msgBox) showMessage(msgBox, "جاري تنظيف البيانات...", false, true);

    let removedSales = 0;
    let removedPurchases = 0;
    let removedLogs = 0;

    // 2. تنظيف المبيعات (salesToday)
    // نحتفظ فقط بالفواتير التي تحمل نفس تاريخ اليوم، أو التي لا تحمل تاريخاً (نعتبرها جديدة)
    if (salesToday && Array.isArray(salesToday)) {
        const initialCount = salesToday.length;
        salesToday = salesToday.filter(sale => {
            // استخراج التاريخ الصافي (YYYY-MM-DD)
            const sDate = sale.saleDate || (sale.timestamp ? sale.timestamp.split('T')[0] : '');
            return sDate === targetDate;
        });
        removedSales = initialCount - salesToday.length;
    }

    // 3. تنظيف المشتريات (purchaseInvoices)
    if (purchaseInvoices && Array.isArray(purchaseInvoices)) {
        const initialCount = purchaseInvoices.length;
        purchaseInvoices = purchaseInvoices.filter(inv => {
            const pDate = inv.date || (inv.timestamp ? inv.timestamp.split('T')[0] : '');
            return pDate === targetDate;
        });
        removedPurchases = initialCount - purchaseInvoices.length;
    }

    // 4. تنظيف سجل العمليات والمصروفات (operationLog)
    // نحذف السجلات القديمة، لكن نترك سجل "بداية يوم جديد" أو "الترحيل"
    if (operationLog && Array.isArray(operationLog)) {
        const initialCount = operationLog.length;
        operationLog = operationLog.filter(log => {
            const logDate = log.timestamp ? log.timestamp.split('T')[0] : '';
            const isSystemLog = log.type && (log.type.includes("ترحيل") || log.type.includes("بداية يوم"));
            return logDate === targetDate || isSystemLog;
        });
        removedLogs = initialCount - operationLog.length;
    }
    
    // ملاحظة: لا نلمس الأرصدة (المخزون، الديون، الخزنة) لأنها تراكمية ويجب أن تبقى.

    // 5. حفظ التغييرات فوراً في السحابة (Update Cloud)
    await saveSystemToCloud();

    // 6. تحديث الواجهة
    updateUI();

    // تقرير النتيجة
    let report = `✅ تمت عملية التنظيف لملف ${targetDate} بنجاح.\n\n`;
    report += `🗑️ تم حذف ${removedSales} فاتورة بيع قديمة.\n`;
    report += `🗑️ تم حذف ${removedPurchases} فاتورة شراء قديمة.\n`;
    report += `🗑️ تم حذف ${removedLogs} سجل قديم.\n\n`;
    report += `الآن تقارير هذا اليوم ستكون نظيفة ودقيقة.`;

    alert(report);
    if(msgBox) showMessage(msgBox, "تم تنظيف اليوم بنجاح.", false);
};
window.deleteAllReportData = async function() {
    // 1. التحقق من وجود بيانات للحذف
    if (typeof currentMonthlySalesData === 'undefined' || currentMonthlySalesData.length === 0) {
        alert("لا توجد بيانات معروضة في التقرير لحذفها.");
        return;
    }

    // 2. رسالة تحذير شديدة اللهجة
    const count = currentMonthlySalesData.length;
    const confirmMsg = `⚠️ تحذير خطير ⚠️\n\nأنت على وشك حذف (${count}) فاتورة ظاهرة في التقرير نهائياً.\n\nسيتم حذفها من السحابة ومن جهازك، ولن يمكنك استرجاعها.\n\nهل أنت متأكد تماماً؟`;
    
    if (!confirm(confirmMsg)) return;

    // تأكيد ثاني للأمان
    if (!confirm("تأكيد أخير: هل أنت متأكد من الحذف النهائي؟")) return;

    const msgEl = document.getElementById('report-message');
    if (msgEl) showMessage(msgEl, "جاري حذف البيانات من السحابة...", false, true);

    const userId = window.currentUser ? window.currentUser.uid : null;
    let deletedCount = 0;

    try {
        // 3. بدء عملية الحذف
        const deletePromises = currentMonthlySalesData.map(async (sale) => {
            // أ. الحذف من السحابة
            if (userId) {
                try {
                    await window.deleteDoc(window.doc(window.db, "users", userId, "invoices", sale.id));
                } catch (e) {
                    console.error(`فشل حذف الفاتورة ${sale.id} من السحابة:`, e);
                }
            }

            // ب. الحذف من الذاكرة المحلية (salesToday)
            if (typeof salesToday !== 'undefined') {
                const localIndex = salesToday.findIndex(s => s.id === sale.id);
                if (localIndex !== -1) {
                    salesToday.splice(localIndex, 1);
                }
            }
            
            deletedCount++;
        });

        // انتظار اكتمال الحذف
        await Promise.all(deletePromises);

        // 4. حفظ التغييرات المحلية (لإزالة الفواتير من ملف اليوم)
        if (typeof saveSystemToCloud === 'function') {
            await saveSystemToCloud();
        }

        // 5. تنظيف الواجهة
        currentMonthlySalesData = [];
        const tableBody = document.getElementById('sales-report-table-body');
        if (tableBody) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center text-red-500 py-8" style="padding: 3rem;">
                        <i class="fas fa-trash-alt fa-2x mb-2" style="display:block; opacity:0.5;"></i>
                        تم حذف ${deletedCount} فاتورة نهائياً.
                    </td>
                </tr>`;
        }

        // تصفير الأرقام
        const zeroFmt = (typeof formatCurrency === 'function') ? formatCurrency(0) : "0.00";
        if (typeof reportTotalSales !== 'undefined' && reportTotalSales) reportTotalSales.textContent = zeroFmt;
        if (typeof reportTotalCost !== 'undefined' && reportTotalCost) reportTotalCost.textContent = zeroFmt;
        if (typeof reportTotalProfit !== 'undefined' && reportTotalProfit) reportTotalProfit.textContent = zeroFmt;

        if (msgEl) showMessage(msgEl, "تمت عملية الحذف بنجاح.", false);

    } catch (error) {
        console.error("Error deleting report data:", error);
        alert("حدث خطأ أثناء الحذف.");
    }
};
window.updateQuickSaleDebt = function() {
    // جلب الحقول الصحيحة من ملفك
    const priceInput = document.getElementById('sell-price');    // حقل السعر
    const qtyInput = document.getElementById('sell-quantity');   // حقل الكمية
    const paidInput = document.getElementById('sell-paid-amount'); // حقل المدفوع كاش
    
    const debtContainer = document.getElementById('quick-sale-debt-container');
    const debtDisplay = document.getElementById('quick-sale-remaining-debt');

    if (!priceInput || !paidInput || !debtContainer) return;

    // حساب الإجمالي (السعر × الكمية)
    const price = parseFloat(priceInput.value) || 0;
    const qty = parseFloat(qtyInput.value) || 1; // الافتراضي 1
    const totalPrice = price * qty;

    const paidAmount = parseFloat(paidInput.value) || 0;

    // المنطق: إذا كان المدفوع أقل من الإجمالي وأكبر من 0
    if (paidAmount > 0 && paidAmount < totalPrice) {
        const debt = totalPrice - paidAmount;
        debtDisplay.textContent = debt.toLocaleString('ar-EG', {minimumFractionDigits: 2}); // تنسيق العملة
        debtContainer.classList.remove('hidden');
    } else {
        debtContainer.classList.add('hidden');
    }
};
}); // End DOMContentLoaded
</script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    
    // ✅ لاحظ: تمت إضافة deleteDoc في هذا السطر لتفعيل الحذف
    import { getFirestore, doc, setDoc, getDoc, deleteDoc, collection, query, where, getDocs, orderBy, limit } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
    
    import { 
        getAuth, 
        createUserWithEmailAndPassword, 
        signInWithEmailAndPassword, 
        onAuthStateChanged, 
        signOut 
    } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCgJeOT_wh9d6h3MTkj-XsEoWW9wo-97ZE",
        authDomain: "financial-app-96527.firebaseapp.com",
        projectId: "financial-app-96527",
        storageBucket: "financial-app-96527.firebasestorage.app",
        messagingSenderId: "409763079254",
        appId: "1:409763079254:web:ae95c7da0aaea083a207f7",
        measurementId: "G-Q5ZLBCBG3J"
    };

    const app = initializeApp(firebaseConfig);
    
    // --- تهيئة الخدمات وجعلها متاحة عالميًا (Global Window Object) ---
    window.db = getFirestore(app);
    
    // دوال التعامل مع المستندات
    window.doc = doc;
    window.setDoc = setDoc;     // تستخدم في الحفظ و Redo
    window.getDoc = getDoc;     // تستخدم في القراءة
    window.deleteDoc = deleteDoc; // ✅ تستخدم في Undo (الحذف)

    // دوال الاستعلامات
    window.collection = collection;
    window.query = query;
    window.where = where;
    window.getDocs = getDocs;
    window.orderBy = orderBy;
    window.limit = limit; 

    // المصادقة
    const auth = getAuth(app);
    window.auth = auth;
    window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
    window.signInWithEmailAndPassword = signInWithEmailAndPassword;
    window.onAuthStateChanged = onAuthStateChanged;
    window.signOut = signOut;

    console.log("Firebase connected successfully! (deleteDoc & setDoc Ready)");
</script><!-- ======================================================= -->
<!-- END: Firebase Connection (Revised) -->
<!-- ======================================================= -->
            </body>
    </html>