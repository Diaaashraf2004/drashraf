<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مثال ماسح الباركود (EAN-13 فقط)</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js" type="text/javascript"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; text-align: center; }
        #qr-reader { width: 90%; max-width: 500px; margin: 20px auto; border: 1px solid #ccc; }
        #qr-reader-results { margin-top: 20px; font-size: 1.2em; font-weight: bold; color: green; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; font-size: 1em; border-radius: 5px; border: none; color: white; }
        #startScanBtn { background-color: #28a745; }
        #stopScanBtn { background-color: #dc3545; display: none; }
        #cameraPermissionStatus { font-size: 0.9em; color: #6c757d; margin-top: 10px; }
    </style>
</head>
<body>

    <h1>مثال لمسح الباركود (EAN-13 فقط)</h1>
    <div id="qr-reader"></div>
    <div id="qr-reader-results">لم يتم مسح أي كود بعد.</div>
    <div id="cameraPermissionStatus"></div>
    <button id="startScanBtn">بدء المسح بالكاميرا</button>
    <button id="stopScanBtn">إيقاف المسح</button>

    <script>
        const resultContainer = document.getElementById('qr-reader-results');
        const startScanBtn = document.getElementById('startScanBtn');
        const stopScanBtn = document.getElementById('stopScanBtn');
        const permissionStatusDiv = document.getElementById('cameraPermissionStatus');
        let html5QrCode = null;

        function onScanSuccess(decodedText, decodedResult) {
            console.log(`Code matched = ${decodedText}`, decodedResult);
            resultContainer.textContent = `تم المسح بنجاح: ${decodedText}`;
            // يمكنك إيقاف المسح تلقائياً إذا أردت
            // stopScanning();
        }

        function onScanFailure(error) {
            // لا يزال من المفيد رؤية الأخطاء في الكونسول
            console.warn(`Code scan error = ${error}`);
        }

        function startScanning() {
            permissionStatusDiv.textContent = 'جاري طلب إذن الكاميرا...';
            html5QrCode = new Html5Qrcode("qr-reader");

            // *** تعديل: تحديد نوع EAN-13 فقط ***
            const formatsToSupport = [
                Html5QrcodeSupportedFormats.EAN_13
            ];

            const config = {
                fps: 10,
                // تم إزالة qrbox سابقاً
                formatsToSupport: formatsToSupport // يبحث عن EAN-13 فقط
            };

            Html5Qrcode.getCameras().then(devices => {
                permissionStatusDiv.textContent = 'تم الحصول على إذن الكاميرا.';
                if (devices && devices.length) {
                    const cameraId = devices.find(d => d.label.toLowerCase().includes('back'))?.id || devices[0].id;
                    console.log("Using camera:", cameraId);

                    html5QrCode.start(
                        cameraId, config, onScanSuccess, onScanFailure
                    ).then(() => {
                        console.log("Barcode (EAN-13 only) scanning started.");
                        startScanBtn.style.display = 'none';
                        stopScanBtn.style.display = 'inline-block';
                        permissionStatusDiv.textContent = 'الكاميرا تعمل. وجهها نحو باركود EAN-13.';
                    }).catch(err => {
                        console.error("Error starting scanning.", err);
                        permissionStatusDiv.textContent = `خطأ في تشغيل الكاميرا: ${err}`;
                        alert(`خطأ في تشغيل الكاميرا: ${err}`);
                    });
                } else {
                     permissionStatusDiv.textContent = 'لم يتم العثور على كاميرات.';
                     alert("لم يتم العثور على كاميرات.");
                }
            }).catch(err => {
                console.error("Error getting camera permissions.", err);
                permissionStatusDiv.textContent = `خطأ في الحصول على إذن الكاميرا: ${err}`;
                alert(`خطأ في الحصول على إذن الكاميرا: ${err}. تأكد من السماح للمتصفح باستخدام الكاميرا وأن الموقع يعمل على HTTPS إذا لم يكن ملفاً محلياً.`);
            });
        }

        function stopScanning() {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().then((ignore) => {
                    console.log("Scanning stopped.");
                    startScanBtn.style.display = 'inline-block';
                    stopScanBtn.style.display = 'none';
                    permissionStatusDiv.textContent = '';
                }).catch((err) => {
                    console.error("Error stopping scanning.", err);
                });
            }
        }

        startScanBtn.addEventListener('click', startScanning);
        stopScanBtn.addEventListener('click', stopScanning);
    </script>

</body>
</html>
