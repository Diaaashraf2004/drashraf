<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>برنامج إدارة البضائع والمخزون (drashraf)</title>
  <meta name="description" content="برنامج ويب لإدارة المخزون، المبيعات، السيولة، الديون، الالتزامات، وحساب رأس المال. تطوير ضياء أشرف (drashraf).">
  <meta name="keywords" content="إدارة بضائع, مخزون, سيولة, ديون, التزامات, برنامج, drashraf, ضياء أشرف, inventory, management">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* ... (نفس كود CSS السابق) ... */
     /* --- التنسيقات الأساسية --- */
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    html { direction: rtl; }

    /* --- تنسيقات الأقسام (Widgets) --- */
    .widget-card {
        background-color: #ffffff; border-radius: 0.75rem; padding: 1.5rem;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        border: 1px solid #e5e7eb;
        transition: box-shadow 0.3s ease-in-out;
        margin-bottom: 1.5rem; /* هامش سفلي بين الأقسام */
    }
    .widget-card:hover { box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
    .widget-card h2 { font-size: 1.25rem; font-weight: 600; color: #1f2937; margin-bottom: 1.25rem; padding-bottom: 0.75rem; border-bottom: 1px solid #e5e7eb; }
    /* عنوان فرعي داخل القسم */
    .widget-card h3.sub-heading { font-size: 1.1rem; font-weight: 600; color: #374151; margin-top: 1.5rem; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px dashed #e5e7eb; }


    /* --- تنسيقات التنقل (Tabs) --- */
    #main-nav button {
        padding: 0.5rem 1rem; border-radius: 0.375rem; /* rounded-md */
        font-weight: 500; /* font-medium */
        color: #4b5563; /* text-gray-600 */
        background-color: #f9fafb; /* bg-gray-50 */
        border: 1px solid #e5e7eb; /* border-gray-200 */
        transition: all 0.2s ease-in-out;
        margin-bottom: 0.5rem; /* للمساعدة في الالتفاف */
    }
    #main-nav button:hover {
        background-color: #f3f4f6; /* bg-gray-100 */
        color: #1f2937; /* text-gray-800 */
    }
    #main-nav button.active { /* تنسيق الزر النشط */
        background-color: #3b82f6; /* bg-blue-600 */
        color: #ffffff; /* text-white */
        border-color: #2563eb; /* border-blue-700 */
    }

    /* --- تنسيقات أخرى --- */
    .save-icon { display: inline-block; width: 1em; height: 1em; margin-left: 0.5em; vertical-align: middle; fill: currentColor; }
    input[type="date"], select { appearance: none; -webkit-appearance: none; border: 1px solid #d1d5db; padding: 0.5rem 0.75rem; border-radius: 0.375rem; background-color: white; cursor: pointer; transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
    input[type="date"] { /* لا يوجد عرض محدد هنا، سيعتمد على الكلاس أو حجم المتصفح الافتراضي */ }
    input[type="date"]::-webkit-calendar-picker-indicator { opacity: 0.6; cursor: pointer; filter: invert(0.5); }
    select { background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%2020%2020%22%20fill%3D%22%236b7280%22%3E%3Cpath%20fill-rule%3D%22evenodd%22%20d%3D%22M5.293%207.293a1%201%200%20011.414%200L10%2010.586l3.293-3.293a1%201%200%20111.414%201.414l-4%204a1%201%200%2001-1.414%200l-4-4a1%201%200%20010-1.414z%22%20clip-rule%3D%22evenodd%22%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: left 0.5rem center; background-size: 1.25em; padding-left: 2.5rem; width: 100%; }
     @media print {
        body { background-color: #ffffff; }
        section { display: block !important; box-shadow: none; border: 1px solid #ccc; margin-bottom: 15px; border-radius: 0; }
        section h2 { border-bottom: 1px solid #eee; }
        #main-nav, #controls-section, #load-data-section, #pending-sales-section button, #consignment-value-display, #debtors-list button, #load-date-day-name, #liquidity-log-container, #liabilities-section button, #liabilities-list button, footer, #settings-section button, #pending-sales-list button, #import-export-section { display: none !important; }
        #pending-sales-list li button { display: none !important; }
     }
     .section-message { min-height: 1.5em; margin-top: 0.75rem; text-align: center; font-weight: 600; }
     #additional-costs-container { max-height: 150px; overflow-y: auto; border: 1px solid #e2e8f0; padding: 0.75rem; border-radius: 0.375rem; background-color: #f9fafb; margin-top: 1rem; }
     #additional-costs-container label { display: block; margin-bottom: 0.5rem; font-size: 0.875rem; cursor: pointer; }
     #additional-costs-container input[type="checkbox"] { margin-left: 0.5rem; cursor: pointer; }
     #pending-sales-list, #debtors-list, #liquidity-log-list, #liabilities-list { max-height: 300px; overflow-y: auto; }
     #pending-sales-list li, #debtors-list li, #liquidity-log-list li, #liabilities-list li { border-bottom: 1px solid #eee; padding: 0.75rem 0.5rem; margin-bottom: 0.5rem; font-size: 0.9em; list-style: none; }
     #pending-sales-list li .details, #debtors-list li .details, #liquidity-log-list li .details, #liabilities-list li .details { color: #4b5563; }
     #pending-sales-list li .actions button, #debtors-list li .actions button, #liabilities-list li .actions button { font-size: 0.75rem; padding: 0.25rem 0.5rem; margin-right: 0.5rem; }
     #consignment-value-display { font-size: 1.125rem; font-weight: 600; color: #ca8a04; }
     input[type="text"], input[type="number"] { border: 1px solid #d1d5db; border-radius: 0.375rem; padding: 0.5rem 0.75rem; width: 100%; transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
     input[type="text"]:focus, input[type="number"]:focus, input[type="date"]:focus, select:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); }
     #debtors-list-container, #liquidity-log-container, #liabilities-list-container, #pending-sales-container, #import-export-section { margin-top: 1.5rem; border-top: 1px solid #e5e7eb; padding-top: 1rem; }
     #debtors-list-container h3, #liquidity-log-container h3, #liabilities-list-container h3, #pending-sales-container h3, #import-export-section h3 { font-weight: 600; margin-bottom: 0.75rem; color: #374151; }
     #liquidity-log-list li span.add { color: #16a34a; }
     #liquidity-log-list li span.remove { color: #dc2626; }
     #liabilities-list li span { color: #7c3aed; }
     .hidden { display: none; }
     #import-file-input { display: none; }
  </style>
</head>
<body class="p-6">
  <div id="main-content">
    <h1 class="text-3xl font-semibold text-center text-blue-600 mb-4">برنامج إدارة البضائع</h1>
    <p class="text-center text-sm text-gray-500 mb-2">البيانات المعروضة حاليًا لتاريخ: <span id="current-data-date" class="font-semibold">لم يتم الحفظ بعد</span></p>
    <div id="global-message" class="text-center mb-4 font-semibold section-message"></div>

    <div id="main-nav" class="flex flex-wrap justify-center gap-2 mb-6 border-b pb-4">
        <button class="nav-button active" data-target="summary-section">الملخص</button>
        <button class="nav-button" data-target="inventory-section">المخزون والإضافة</button>
        <button class="nav-button" data-target="sell-product">بيع بضاعة</button>
        <button class="nav-button" data-target="liquidity-section">السيولة</button>
        <button class="nav-button" data-target="expenses-section">المصروفات</button>
        <button class="nav-button" data-target="debts-section">الديون (لك)</button>
        <button class="nav-button" data-target="liabilities-section">الالتزامات (عليك)</button>
        <button class="nav-button" data-target="log-section">السجل العام</button>
        <button class="nav-button" data-target="settings-section">تحميل/حفظ/إعدادات</button>
    </div>

    <div id="content-area">

        <section id="summary-section" class="widget-card content-section">
            <h2>الملخص المالي ورأس المال</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-200"> <h3 class="text-sm font-medium text-blue-700 mb-1">السيولة المتاحة</h3> <div id="summary-current-liquidity" class="text-xl font-bold text-blue-800">0 جنيه</div> </div>
                <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-200"> <h3 class="text-sm font-medium text-indigo-700 mb-1">قيمة المخزون</h3> <div id="summary-total-inventory-value" class="text-xl font-bold text-indigo-800">0 جنيه</div> </div>
                <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200"> <h3 class="text-sm font-medium text-yellow-700 mb-1">قيمة بضاعة مؤقتة</h3> <div id="summary-consignment-value-display" class="text-xl font-bold text-yellow-800">0 جنيه</div> </div>
                <div class="bg-purple-50 p-4 rounded-lg border border-purple-200"> <h3 class="text-sm font-medium text-purple-700 mb-1">إجمالي الديون (لك)</h3> <div id="summary-total-debts-display" class="text-xl font-bold text-purple-800">0 جنيه</div> </div>
                <div class="bg-pink-50 p-4 rounded-lg border border-pink-200"> <h3 class="text-sm font-medium text-pink-700 mb-1">إجمالي الالتزامات (عليك)</h3> <div id="summary-total-liabilities-display" class="text-xl font-bold text-pink-800">0 جنيه</div> </div>
                <div class="bg-red-50 p-4 rounded-lg border border-red-200"> <h3 class="text-sm font-medium text-red-700 mb-1">إجمالي المصروفات</h3> <div id="summary-total-expenses" class="text-xl font-bold text-red-800">0 جنيه</div> </div>
                <div class="bg-green-50 p-4 rounded-lg border border-green-200"> <h3 class="text-sm font-medium text-green-700 mb-1">إجمالي الربح</h3> <div id="summary-total-profit" class="text-xl font-bold text-green-800">0 جنيه</div> </div>
                <div class="bg-teal-50 p-4 rounded-lg border border-teal-200"> <h3 class="text-sm font-medium text-teal-700 mb-1">رأس المال</h3> <div id="summary-total-capital" class="text-xl font-bold text-teal-800">0 جنيه</div> </div>
            </div>
        </section>

        <section id="inventory-section" class="widget-card content-section hidden">
            <div>
                <h2>إضافة / تحديث بضاعة</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="mb-4"><label for="product-name" class="block text-gray-700 text-sm font-bold mb-2">اسم البضاعة:</label><input type="text" id="product-name" placeholder="اسم المنتج" class="shadow-sm"></div>
                    <div class="mb-4"><label for="product-quantity" class="block text-gray-700 text-sm font-bold mb-2">الكمية المضافة:</label><input type="number" id="product-quantity" value="0" min="0" class="shadow-sm"></div>
                    <div class="mb-4"><label for="product-cost-price" class="block text-gray-700 text-sm font-bold mb-2">سعر التكلفة (للوحدة):</label><input type="number" id="product-cost-price" value="0" min="0" step="0.01" class="shadow-sm"></div>
                </div>
                <button id="add-product-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">إضافة/تحديث البضاعة</button>
                <div id="product-message" class="section-message"></div>
            </div>
            <div class="mt-8 border-t pt-6">
                <h3 class="sub-heading">قائمة البضائع المتوفرة</h3>
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div id="inventory-total-inventory-value" class="text-lg font-semibold text-indigo-600">إجمالي قيمة المخزون: 0 جنيه</div>
                    <div id="inventory-consignment-value-display" class="text-lg font-semibold text-yellow-600">قيمة مؤقتة: 0 جنيه</div>
                    <div id="inventory-total-profit" class="text-lg font-semibold text-green-600">إجمالي الربح: 0 جنيه</div>
                 </div>
                <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 max-h-[50vh] overflow-y-auto">
                    <p class="text-center text-gray-500 col-span-full">لا توجد بضائع حتى الآن.</p>
                </div>
            </div>
        </section>

        <section id="sell-product" class="widget-card content-section hidden">
            <div>
                <h2>بيع بضاعة</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="mb-4"><label for="sell-product-name" class="block text-gray-700 text-sm font-bold mb-2">اسم البضاعة المباعة:</label><input type="text" id="sell-product-name" placeholder="اسم المنتج الرئيسي" list="product-names-list" class="shadow-sm"><datalist id="product-names-list"></datalist></div>
                    <div class="mb-4"><label for="sell-quantity" class="block text-gray-700 text-sm font-bold mb-2">الكمية المباعة:</label><input type="number" id="sell-quantity" value="1" min="1" class="shadow-sm"></div>
                    <div class="mb-4"><label for="sell-price" class="block text-gray-700 text-sm font-bold mb-2">إجمالي سعر البيع:</label><input type="number" id="sell-price" value="0" min="0" step="0.01" placeholder="السعر الإجمالي للكمية" class="shadow-sm"></div>
                </div>
                <div class="mt-4"><label class="block text-gray-700 text-sm font-bold mb-2">خصم تكاليف إضافية (للحزم أو المرفقات):</label><div id="additional-costs-container"><p class="text-center text-gray-500 text-sm">أدخل اسم المنتج الرئيسي لعرض المرفقات المتاحة.</p></div></div>
                <div class="mt-4"><label for="sell-pending" class="inline-flex items-center cursor-pointer"><input type="checkbox" id="sell-pending" class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-offset-0 focus:ring-blue-200 focus:ring-opacity-50 ml-2"><span class="text-sm text-gray-700 font-medium">بيع مؤقت (تحت التسوية)</span></label></div>
                <button id="sell-button" class="mt-6 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">بيع البضاعة</button>
                <div id="sell-message" class="section-message"></div>
            </div>
            <div id="pending-sales-container" class="mt-8 border-t pt-6">
                <h3 class="sub-heading">المبيعات المؤقتة الحالية</h3>
                <div id="pending-sales-list">
                    <p class="text-center text-gray-500 text-sm">لا توجد مبيعات مؤقتة حاليًا.</p>
                </div>
            </div>
        </section>

        <section id="liquidity-section" class="widget-card content-section hidden"><h2>السيولة المتاحة</h2><div id="current-liquidity" class="text-2xl font-bold text-blue-700 mb-4">0 جنيه</div><div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-6"><div class="border-l border-gray-200 pl-4 md:border-l-0 md:pl-0 md:border-r md:pr-4"><h3 class="text-lg font-medium text-gray-700 mb-3">إضافة سيولة</h3><div class="mb-3"><label for="add-liquidity-amount" class="block text-gray-700 text-sm font-bold mb-1">المبلغ:</label><input type="number" id="add-liquidity-amount" value="0" min="0" step="0.01" class="shadow-sm"></div><div class="mb-3"><label for="add-liquidity-source" class="block text-gray-700 text-sm font-bold mb-1">المصدر:</label><input type="text" id="add-liquidity-source" placeholder="مثال: مبيعات، استثمار..." class="shadow-sm"></div><button id="add-liquidity-button" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">إضافة</button></div><div><h3 class="text-lg font-medium text-gray-700 mb-3">سحب سيولة</h3><div class="mb-3"><label for="remove-liquidity-amount" class="block text-gray-700 text-sm font-bold mb-1">المبلغ:</label><input type="number" id="remove-liquidity-amount" value="0" min="0" step="0.01" class="shadow-sm"></div><div class="mb-3"><label for="remove-liquidity-reason" class="block text-gray-700 text-sm font-bold mb-1">السبب:</label><input type="text" id="remove-liquidity-reason" placeholder="مثال: سحب شخصي، شراء..." class="shadow-sm"></div><button id="remove-liquidity-button" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded">سحب</button></div></div><div id="liquidity-message" class="section-message"></div><div id="liquidity-log-container" class="mt-6 border-t border-gray-200 pt-4"><h3 class="text-lg font-medium text-gray-700 mb-3">سجل عمليات السيولة</h3><ul id="liquidity-log-list" class="space-y-2"><li class="text-center text-gray-500">لا توجد عمليات مسجلة على السيولة.</li></ul></div></section>
        <section id="expenses-section" class="widget-card content-section hidden"><h2>المصروفات</h2><div id="total-expenses" class="text-2xl font-bold text-red-700 mb-4">0 جنيه</div><div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="add-expense" class="block text-gray-700 text-sm font-bold mb-2">إضافة مصروف:</label><input type="number" id="add-expense" value="0" min="0" step="0.01" class="shadow-sm"><button id="add-expense-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded mt-2">إضافة</button></div><div><label for="remove-expense" class="block text-gray-700 text-sm font-bold mb-2">تقليل مصروف:</label><input type="number" id="remove-expense" value="0" min="0" step="0.01" class="shadow-sm"><button id="remove-expense-button" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded mt-2">تقليل</button></div></div><div id="expenses-message" class="section-message"></div></section>
        <section id="debts-section" class="widget-card content-section hidden">
            <h2>الديون (المستحقة للشركة)</h2>
            <div id="total-debts-display" class="text-2xl font-bold text-purple-700 mb-4">إجمالي الديون: 0 جنيه</div>
            <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="border-l border-gray-200 pl-4 md:border-l-0 md:pl-0 md:border-r md:pr-4">
                  <h3 class="text-lg font-medium text-gray-700 mb-3">تسجيل دين / سلفة</h3>
                  <div class="mb-3">
                      <label for="debtor-name" class="block text-gray-700 text-sm font-bold mb-1">اسم المدين:</label>
                      <input type="text" id="debtor-name" placeholder="اسم الشخص أو الجهة" class="shadow-sm">
                  </div>
                  <div class="mb-3">
                      <label for="add-debt-amount" class="block text-gray-700 text-sm font-bold mb-1">المبلغ:</label>
                      <input type="number" id="add-debt-amount" value="0" min="0" step="0.01" class="shadow-sm">
                  </div>
                  <div class="mb-3">
                      <label for="debt-deduct-liquidity" class="inline-flex items-center cursor-pointer">
                          <input type="checkbox" id="debt-deduct-liquidity" class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-offset-0 focus:ring-blue-200 focus:ring-opacity-50 ml-2">
                          <span class="text-sm text-gray-700 font-medium">خصم المبلغ من السيولة (تسجيل سلفة)؟</span>
                      </label>
                  </div>
                  <button id="add-debt-button" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded">تسجيل الدين/السلفة</button>
                </div>
                <div>
                  <h3 class="text-lg font-medium text-gray-700 mb-3">استلام سداد</h3>
                  <div class="mb-3">
                      <label for="payment-debtor-name" class="block text-gray-700 text-sm font-bold mb-1">اسم المدين:</label>
                      <select id="payment-debtor-name" class="shadow-sm"><option value="">-- اختر المدين --</option></select>
                  </div>
                  <div class="mb-3">
                      <label for="payment-amount" class="block text-gray-700 text-sm font-bold mb-1">المبلغ المسدد:</label>
                      <input type="number" id="payment-amount" value="0" min="0" step="0.01" class="shadow-sm">
                  </div>
                  <button id="receive-payment-button" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">استلام المبلغ</button>
                </div>
            </div>
            <div id="debts-message" class="section-message"></div>
            <div id="debtors-list-container" class="mt-6 border-t border-gray-200 pt-4"><h3 class="text-lg font-medium text-gray-700 mb-3">قائمة الديون الحالية</h3><ul id="debtors-list" class="space-y-2"><li class="text-center text-gray-500">لا توجد ديون مسجلة حاليًا.</li></ul></div>
        </section>
        <section id="liabilities-section" class="widget-card content-section hidden">
            <h2>الديون المستحقة على الشركة (للاخرين)</h2>
            <div id="total-liabilities-display" class="text-2xl font-bold text-pink-700 mb-4">إجمالي الالتزامات: 0 جنيه</div>
            <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="border-l border-gray-200 pl-4 md:border-l-0 md:pl-0 md:border-r md:pr-4">
                  <h3 class="text-lg font-medium text-gray-700 mb-3">تسجيل التزام جديد</h3>
                  <div class="mb-3">
                      <label for="creditor-name" class="block text-gray-700 text-sm font-bold mb-1">اسم الدائن:</label>
                      <input type="text" id="creditor-name" placeholder="اسم الشخص أو الجهة" class="shadow-sm">
                  </div>
                  <div class="mb-3">
                      <label for="add-liability-amount" class="block text-gray-700 text-sm font-bold mb-1">المبلغ المستحق:</label>
                      <input type="number" id="add-liability-amount" value="0" min="0" step="0.01" class="shadow-sm">
                  </div>
                  <div class="mb-3">
                      <label for="liability-received-cash" class="inline-flex items-center cursor-pointer">
                          <input type="checkbox" id="liability-received-cash" class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-offset-0 focus:ring-blue-200 focus:ring-opacity-50 ml-2">
                          <span class="text-sm text-gray-700 font-medium">هل استلمت سيولة مقابل هذا الالتزام؟</span>
                      </label>
                  </div>
                  <button id="add-liability-button" class="w-full bg-rose-500 hover:bg-rose-600 text-white font-bold py-2 px-4 rounded">تسجيل الالتزام</button>
                </div>
                <div>
                  <h3 class="text-lg font-medium text-gray-700 mb-3">تسديد التزام</h3>
                   <div class="mb-3">
                      <label for="payment-creditor-name" class="block text-gray-700 text-sm font-bold mb-1">اسم الدائن:</label>
                      <select id="payment-creditor-name" class="shadow-sm">
                          <option value="">-- اختر الدائن --</option>
                          </select>
                  </div>
                  <div class="mb-3">
                      <label for="liability-payment-amount" class="block text-gray-700 text-sm font-bold mb-1">المبلغ المسدد:</label>
                      <input type="number" id="liability-payment-amount" value="0" min="0" step="0.01" class="shadow-sm">
                  </div>
                  <button id="pay-liability-button" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded">تسديد دفعة</button>
                </div>
            </div>
            <div id="liabilities-message" class="section-message"></div>
            <div id="liabilities-list-container" class="mt-6 border-t border-gray-200 pt-4">
                <h3 class="text-lg font-medium text-gray-700 mb-3">قائمة الالتزامات الحالية</h3>
                <ul id="liabilities-list" class="space-y-2">
                    <li class="text-center text-gray-500">لا توجد التزامات مسجلة حاليًا.</li>
                    </ul>
            </div>
         </section>
        <section id="log-section" class="widget-card content-section hidden"><h2>سجل العمليات العام</h2><div class="flex justify-between items-center mb-4"><button id="clear-log-button" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-600 font-bold py-1 px-2 rounded">مسح سجل اليوم</button></div><ul id="operation-log-list" class="list-disc pl-5 space-y-2 max-h-[60vh] overflow-y-auto border border-gray-200 p-3 rounded bg-gray-50 text-sm"><li class="text-center text-gray-500">لا توجد عمليات مسجلة بعد.</li></ul></section>
        <section id="settings-section" class="widget-card content-section hidden">
            <h2>تحميل/حفظ/إعدادات</h2>
            <div id="load-data-sub-section" class="mb-6 pb-4 border-b">
                <h3 class="text-lg font-medium text-gray-700 mb-3">تحميل بيانات تاريخ سابق</h3>
                <div class="flex flex-col sm:flex-row justify-start items-center gap-2 md:gap-4">
                    <label for="load-date-alt" class="block text-gray-700 text-sm font-bold">اختر التاريخ:</label>
                    <input type="date" id="load-date-alt" class="shadow-sm w-52"> <span id="load-date-day-name-alt" class="text-gray-600 font-medium text-sm min-w-[50px] text-center"></span>
                    <button id="load-data-button-alt" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded">
                        تحميل
                    </button>
                </div>
                <div id="load-message-alt" class="section-message text-sm"></div>
            </div>
             <div id="import-export-section" class="mb-6 pb-4 border-b">
                <h3 class="text-lg font-medium text-gray-700 mb-3">نسخ احتياطي واستعادة</h3>
                <div class="flex flex-col sm:flex-row justify-center items-center gap-4">
                     <button id="export-data-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
                         تصدير البيانات الحالية (JSON)
                     </button>
                     <label for="import-file-input" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded cursor-pointer">
                         استيراد بيانات من ملف (JSON)
                     </label>
                     <input type="file" id="import-file-input" accept=".json">
                </div>
                 <div id="import-message" class="section-message text-sm mt-2"></div>
            </div>
            <div id="controls-sub-section" class="mt-6 flex flex-col sm:flex-row justify-center items-center gap-4">
               <button id="save-button-alt" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded flex items-center">
                   <svg class="save-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M17 3H5C3.89543 3 3 3.89543 3 5V19C3 20.1046 3.89543 21 5 21H19C20.1046 21 21 20.1046 21 19V7.82843C21 7.29799 20.7893 6.78929 20.4142 6.41421L17.5858 3.58579C17.2107 3.21071 16.702 3 16.1716 3H17ZM15 9C15 8.44772 14.5523 8 14 8H10C9.44772 8 9 8.44772 9 9V14C9 14.5523 9.44772 15 10 15H14C14.5523 15 15 14.5523 15 14V9ZM12 13C11.4477 13 11 12.5523 11 12C11 11.4477 11.4477 11 12 11C12.5523 11 13 11.4477 13 12C13 12.5523 12.5523 13 12 13Z"/></svg>
                   حفظ التغييرات
               </button>
               <button id="print-button-alt" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">
                 طباعة تقرير اليوم
               </button>
               <button id="reset-button-alt" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded">
                 تصفير بيانات اليوم (بدون حفظ)
               </button>
            </div>
        </section>


    </div> <footer class="mt-10 text-center text-sm text-gray-500">
        <p>
            تم التطوير بواسطة:
            <a href="https://diaaashraf2004.github.io/drashraf/" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">
                ضياء أشرف
            </a>
        </p>
    </footer>

  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      // --- تعريف المراجع والمتغيرات أولاً ---
      const d = id => document.getElementById(id);
      const lsPrefix = "goodsMgmt_data_";
      const lsLastSaveKey = "goodsMgmt_lastSaveDate";

      let products = [];
      let liquidity = 0;
      let expenses = 0;
      let debtors = [];
      let liabilities = [];
      let totalProfit = 0;
      let operationLog = [];
      let currentLoadedDate = null;
      let pendingSales = [];
      let goodsOnConsignmentValue = 0;
      let liquidityLog = [];
      let salesToday = [];

      // --- مراجع عناصر الواجهة ---
      const mainNav = d("main-nav");
      const contentSections = document.querySelectorAll(".content-section");
      const navButtons = document.querySelectorAll(".nav-button");

      const productList = d("product-list");
      const addProductButton = d("add-product-button");
      const productNameInput = d("product-name");
      const productQuantityInput = d("product-quantity");
      const productCostPriceInput = d("product-cost-price");
      const productMessage = d("product-message");
      // مراجع عناصر الملخص
      const summaryLiquidity = d("summary-current-liquidity");
      const summaryInventory = d("summary-total-inventory-value");
      const summaryConsignment = d("summary-consignment-value-display");
      const summaryDebts = d("summary-total-debts-display");
      const summaryLiabilities = d("summary-total-liabilities-display");
      const summaryExpenses = d("summary-total-expenses");
      const summaryProfit = d("summary-total-profit");
      const summaryCapital = d("summary-total-capital");
      // ---
      const inventoryTotalInventoryValue = d("inventory-total-inventory-value");
      const inventoryConsignmentValue = d("inventory-consignment-value-display");
      const inventoryTotalProfit = d("inventory-total-profit");

      const currentLiquidityDisplay = d("current-liquidity");
      // const totalCapitalDisplay = d("total-capital"); // تم نقله للملخص
      const totalExpensesDisplay = d("total-expenses");
      const totalDebtsDisplay = d("total-debts-display");
      const operationLogList = d("operation-log-list");
      const clearLogButton = d("clear-log-button");
      const currentDataDateDisplay = d("current-data-date");
      const sellProductNameInput = d("sell-product-name");
      const sellQuantityInput = d("sell-quantity");
      const sellPriceInput = d("sell-price");
      const sellButton = d("sell-button");
      const sellMessage = d("sell-message");
      const productNamesDatalist = d("product-names-list");
      const additionalCostsContainer = d("additional-costs-container");
      const sellPendingCheckbox = d("sell-pending");
      const pendingSalesListContainer = d("pending-sales-list");
      const addLiquidityAmountInput = d("add-liquidity-amount");
      const addLiquiditySourceInput = d("add-liquidity-source");
      const addLiquidityButton = d("add-liquidity-button");
      const removeLiquidityAmountInput = d("remove-liquidity-amount");
      const removeLiquidityReasonInput = d("remove-liquidity-reason");
      const removeLiquidityButton = d("remove-liquidity-button");
      const liquidityMessage = d("liquidity-message");
      const liquidityLogListContainer = d("liquidity-log-list");
      const addExpenseInput = d("add-expense");
      const addExpenseButton = d("add-expense-button");
      const removeExpenseInput = d("remove-expense");
      const removeExpenseButton = d("remove-expense-button");
      const expensesMessage = d("expenses-message");
      const debtorNameInput = d("debtor-name");
      const addDebtAmountInput = d("add-debt-amount");
      const debtDeductLiquidityCheckbox = d("debt-deduct-liquidity");
      const addDebtButton = d("add-debt-button");
      const paymentDebtorSelect = d("payment-debtor-name");
      const paymentAmountInput = d("payment-amount");
      const receivePaymentButton = d("receive-payment-button");
      const debtsMessage = d("debts-message");
      const debtorsListContainer = d("debtors-list");
      const totalLiabilitiesDisplay = d("total-liabilities-display");
      const creditorNameInput = d("creditor-name");
      const addLiabilityAmountInput = d("add-liability-amount");
      const liabilityReceivedCashCheckbox = d("liability-received-cash");
      const addLiabilityButton = d("add-liability-button");
      const paymentCreditorSelect = d("payment-creditor-name");
      const liabilityPaymentAmountInput = d("liability-payment-amount");
      const payLiabilityButton = d("pay-liability-button");
      const liabilitiesMessage = d("liabilities-message");
      const liabilitiesListContainer = d("liabilities-list");
      // مراجع الأزرار البديلة في الإعدادات
      const saveButtonAlt = d("save-button-alt");
      const loadDateInputAlt = d("load-date-alt");
      const loadDataButtonAlt = d("load-data-button-alt");
      const loadMessageAlt = d("load-message-alt");
      const loadDateDayNameDisplayAlt = d("load-date-day-name-alt");
      const printButtonAlt = d("print-button-alt");
      const resetButtonAlt = d("reset-button-alt");
      // مراجع الاستيراد والتصدير
      const exportDataButton = d("export-data-button");
      const importFileInput = d("import-file-input");
      const importMessage = d("import-message");


      // --- الدوال المساعدة ---
      function convertNumerals(inputString) { if (typeof inputString !== 'string') return inputString; return inputString.replace(/[\u0660-\u0669]/g, d => d.charCodeAt(0) - 0x0660).replace(/[\u06F0-\u06F9]/g, d => d.charCodeAt(0) - 0x06F0); }
      function parseInputNumber(inputElement) { if (!inputElement) return NaN; const rawValue = inputElement.value; if (rawValue.trim() === '') return NaN; const westernValue = convertNumerals(rawValue.trim()); const normalizedValue = westernValue.replace(/٫/g, '.').replace(/,/g, ''); const number = parseFloat(normalizedValue); return isNaN(number) ? NaN : number; }
      function getTodayDateString() { const today = new Date(); const year = today.getFullYear(); const month = String(today.getMonth() + 1).padStart(2, '0'); const day = String(today.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; }
      function formatDateForDisplay(dateString) { if (!dateString) return 'غير محدد'; try { const date = new Date(dateString); const options = { timeZone: 'Africa/Cairo', weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }; return date.toLocaleDateString('ar-EG', options); } catch (e) { console.error("Error formatting date:", dateString, e); return dateString; } }
      function fetchData(key, defaultValue){const data=localStorage.getItem(key);try{if(data===null||data===undefined)return defaultValue;const parsed=JSON.parse(data);return parsed}catch(e){console.error(`Error parsing data for key "${key}":`,e);localStorage.removeItem(key);return defaultValue}}
      function saveData(key, data){console.log(`saveData: Saving data for key: ${key}`); try{localStorage.setItem(key,JSON.stringify(data))}catch(e){console.error(`Error saving data for key "${key}":`,e);showGlobalMessage("حدث خطأ أثناء حفظ البيانات.",true)}}
      function formatCurrency(amount){const numAmount=Number(amount);return isNaN(numAmount)?'0.00 جنيه':`${numAmount.toFixed(2)} جنيه`}
      function formatDateTime(isoString){if(!isoString)return'';try{return new Date(isoString).toLocaleString('ar-EG',{timeZone:'Africa/Cairo',year:'numeric',month:'short',day:'numeric',hour:'numeric',minute:'2-digit',hour12:true})}catch(e){return isoString}}
      function showMessage(messageElement,text,isError=false){if(!messageElement){console.warn("showMessage called with invalid element", messageElement);return}messageElement.textContent=text;messageElement.classList.remove('text-red-600','text-green-600');messageElement.classList.add(isError?'text-red-600':'text-green-600');setTimeout(()=>{if(messageElement){messageElement.textContent='';messageElement.classList.remove('text-red-600','text-green-600')}},5000)}
      function showGlobalMessage(text,isError=false){const element=d("global-message");if(!element)return;element.textContent=text;element.classList.remove('text-red-600','text-green-600');element.classList.add(isError?'text-red-600':'text-green-600')}

      // --- دوال المنطق الأساسي ---
      function calculateConsignmentValue(){return pendingSales.reduce((sum,sale)=>{const mainCost=(sale.mainProduct.costPrice||0)*(sale.mainProduct.quantity||0);const additionalCost=(sale.additionalItems||[]).reduce((addSum,item)=>addSum+((item.costPrice||0)*(item.quantity||0)),0);return sum+mainCost+additionalCost},0)}
      function loadState(data, dateString){console.log("loadState called for date:", dateString); products=data.products||[];liquidity=parseFloat(data.liquidity)||0;expenses=parseFloat(data.expenses)||0;debtors=data.debtors||[];liabilities=data.liabilities||[];totalProfit=parseFloat(data.profit)||0;operationLog=data.log||[];pendingSales=data.pendingSales||[];goodsOnConsignmentValue=parseFloat(data.goodsOnConsignmentValue)||calculateConsignmentValue();liquidityLog=data.liquidityLog||[];salesToday=data.salesToday||[];currentLoadedDate=dateString; console.log("currentLoadedDate set in loadState:", currentLoadedDate);}
      function resetState(){console.log("resetState called."); products=[];liquidity=0;expenses=0;debtors=[];liabilities=[];totalProfit=0;operationLog=[];pendingSales=[];goodsOnConsignmentValue=0;liquidityLog=[];salesToday=[];currentLoadedDate=null; console.log("currentLoadedDate reset in resetState:", currentLoadedDate); const dateInputElement = d("load-date-alt"); const dayDisplayElement = d("load-date-day-name-alt"); if(dateInputElement) dateInputElement.value = ""; if(dayDisplayElement) dayDisplayElement.textContent = "";}
      function logOperation(type,details){const timestamp=new Date().toISOString();operationLog.push({timestamp,type,details});updateLogDisplay()}
      function calculateTotalDebts(){const total = debtors.reduce((sum,debtor)=>sum+(Number(debtor.amount)||0),0); console.log("calculateTotalDebts: Calculated totalDebtsValue:", total); return total;} // تتبع
      function calculateTotalLiabilities(){return liabilities.reduce((sum,liability)=>sum+(Number(liability.amount)||0),0)}
      function calculateTotals(){const totalInventoryValue=products.reduce((sum,p)=>sum+(Number(p.quantity)||0)*(Number(p.costPrice)||0),0);console.log("calculateTotals: Calculated totalInventoryValue:", totalInventoryValue);const totalDebtsValue=calculateTotalDebts();const totalLiabilitiesValue=calculateTotalLiabilities();const totalCapital=liquidity+totalInventoryValue+goodsOnConsignmentValue+totalDebtsValue-totalLiabilitiesValue;return{totalInventoryValue,totalCapital,totalDebtsValue,totalLiabilitiesValue}}
      function updateProductListDisplay(){const productList=d("product-list"); const productNamesDatalist=d("product-names-list"); if(!productList||!productNamesDatalist)return;if(products.length===0){productList.innerHTML='<p class="text-center text-gray-500 col-span-full">لا توجد بضائع حتى الآن.</p>';productNamesDatalist.innerHTML=''}else{productList.innerHTML=products.map(product=>`<div class="bg-gray-50 rounded-lg shadow p-4 border border-gray-200"><h3 class="text-lg font-semibold text-gray-800 mb-2">${product.name||'غير مسمى'}</h3><p class="text-gray-600 text-sm">الكمية: <span class="font-semibold text-blue-500">${Number(product.quantity)||0}</span></p><p class="text-gray-600 text-sm">متوسط التكلفة: <span class="font-semibold text-purple-500">${formatCurrency(product.costPrice)}</span></p><p class="text-gray-600 text-sm">إجمالي التكلفة: <span class="font-semibold text-gray-700">${formatCurrency((Number(product.quantity)||0)*(Number(product.costPrice)||0))}</span></p></div>`).join('');productNamesDatalist.innerHTML=products.map(p=>`<option value="${p.name}"></option>`).join('')}}
      function updateLogDisplay(){const operationLogList=d("operation-log-list"); if(!operationLogList){console.error("#operation-log-list not found"); return;} console.log("updateLogDisplay called. operationLog length:", operationLog?.length); if(operationLog.length===0){operationLogList.innerHTML='<li class="text-center text-gray-500">لا توجد عمليات مسجلة بعد.</li>'; console.log("updateLogDisplay: Set empty message.");}else{operationLogList.innerHTML=[...operationLog].reverse().map(log=>`<li class="border-b border-gray-100 pb-1 mb-1"><span class="font-semibold text-gray-700">${log.type}:</span> <span class="text-gray-600">${log.details}</span><span class="block text-xs text-gray-400">${formatDateTime(log.timestamp)}</span></li>`).join(''); console.log("updateLogDisplay: Rendered log entries.");}}
      function updateAdditionalCostsCheckboxes(){const additionalCostsContainer=d("additional-costs-container"); const sellProductNameInput=d("sell-product-name"); if(!additionalCostsContainer||!sellProductNameInput)return;const mainProductName=sellProductNameInput.value.trim().toLowerCase();const otherProducts=products.filter(p=>p.name.trim().toLowerCase()!==mainProductName&&p.quantity>0);additionalCostsContainer.innerHTML='';if(otherProducts.length===0){additionalCostsContainer.innerHTML='<p class="text-center text-gray-500 text-sm">لا توجد منتجات أخرى متاحة لخصم تكلفتها.</p>'}else{otherProducts.forEach(product=>{const label=document.createElement('label');const checkbox=document.createElement('input');checkbox.type='checkbox';checkbox.value=product.name;checkbox.dataset.cost=product.costPrice;checkbox.id=`addcost-${product.name.replace(/\s+/g,'-')}`;label.htmlFor=checkbox.id;label.appendChild(checkbox);label.appendChild(document.createTextNode(` ${product.name} (متوسط التكلفة: ${formatCurrency(product.costPrice)}, المتاح: ${product.quantity})`));additionalCostsContainer.appendChild(label)})}}
      function updatePendingSalesDisplay(){const pendingSalesListContainer=d("pending-sales-list"); if(!pendingSalesListContainer)return;if(pendingSales.length===0){pendingSalesListContainer.innerHTML='<p class="text-center text-gray-500 text-sm">لا توجد مبيعات مؤقتة حاليًا.</p>';return}pendingSalesListContainer.innerHTML=pendingSales.map(sale=>{let itemsText=`${sale.mainProduct.quantity}x "${sale.mainProduct.name}"`;if(sale.additionalItems&&sale.additionalItems.length>0){itemsText+=` مع (${sale.additionalItems.map(item=>`${item.quantity}x "${item.name}"`).join(', ')})`}return`<li><div class="flex justify-between items-start"><div><span class="block font-semibold">${itemsText}</span><span class="block text-sm details">السعر المتوقع: ${formatCurrency(sale.totalSellPrice)} | الربح المتوقع: ${formatCurrency(sale.potentialProfit)}</span><span class="block text-xs text-gray-400">${formatDateTime(sale.timestamp)}</span></div><div class="actions flex-shrink-0"><button data-pending-id="${sale.id}" class="confirm-pending bg-green-500 hover:bg-green-600 text-white rounded">تأكيد</button><button data-pending-id="${sale.id}" class="cancel-pending bg-red-500 hover:bg-red-600 text-white rounded">إلغاء/إرجاع</button></div></div></li>`}).join('');
        pendingSalesListContainer.removeEventListener('click', handlePendingSaleActions);
        pendingSalesListContainer.addEventListener('click', handlePendingSaleActions);
      }
       function handlePendingSaleActions(e) { if (e.target.classList.contains('confirm-pending')) { confirmPendingSale(e.target.dataset.pendingId); } else if (e.target.classList.contains('cancel-pending')) { cancelPendingSale(e.target.dataset.pendingId); } }
      function updateDebtorsListDisplay(){const debtorsListContainer=d("debtors-list"); if(!debtorsListContainer)return;debtorsListContainer.innerHTML='';if(debtors.length===0){debtorsListContainer.innerHTML='<li class="text-center text-gray-500">لا توجد ديون مسجلة حاليًا.</li>'}else{const sortedDebtors=[...debtors].sort((a,b)=>a.name.localeCompare(b.name,'ar'));sortedDebtors.forEach(debtor=>{const li=document.createElement('li');li.className='flex justify-between items-center';li.innerHTML=`<span class="font-medium">${debtor.name}</span> <span class="text-purple-700 font-semibold">${formatCurrency(debtor.amount)}</span>`;debtorsListContainer.appendChild(li)})}}
      function updatePaymentDebtorDropdown(){const paymentDebtorSelect=d("payment-debtor-name"); if(!paymentDebtorSelect)return;const currentSelection=paymentDebtorSelect.value;paymentDebtorSelect.innerHTML='<option value="">-- اختر المدين --</option>';const sortedDebtors=[...debtors].sort((a,b)=>a.name.localeCompare(b.name,'ar'));sortedDebtors.forEach(debtor=>{if(debtor.amount>0){const option=document.createElement('option');option.value=debtor.name;option.textContent=`${debtor.name} (${formatCurrency(debtor.amount)})`;paymentDebtorSelect.appendChild(option)}});if(sortedDebtors.some(d=>d.name===currentSelection&&d.amount>0)){paymentDebtorSelect.value=currentSelection}}
      function updateLiquidityLogDisplay(){const liquidityLogListContainer=d("liquidity-log-list"); if(!liquidityLogListContainer)return;if(liquidityLog.length===0){liquidityLogListContainer.innerHTML='<li class="text-center text-gray-500">لا توجد عمليات مسجلة على السيولة.</li>'}else{liquidityLogListContainer.innerHTML=[...liquidityLog].reverse().map(log=>{const amountClass=log.type==='add'?'add':'remove';const amountSign=log.type==='add'?'+':'-';return`<li><div class="flex justify-between items-start"><div><span class="font-medium ${amountClass}">${amountSign}${formatCurrency(log.amount)}</span> <span class="text-sm details">(${log.description||'بدون وصف'})</span><span class="block text-xs text-gray-400">${formatDateTime(log.timestamp)}</span></div><span class="text-sm details flex-shrink-0">الرصيد: ${formatCurrency(log.currentBalance)}</span></div></li>`}).join('')}}
      function updateLoadDateDayName(dateString, displayElement) { if (!displayElement) { console.error("Day name display element not provided!"); return; } if (!dateString || typeof dateString !== 'string' || !/^\d{4}-\d{2}-\d{2}$/.test(dateString)) { displayElement.textContent = ''; return; } try { const parts = dateString.split('-'); const year = parseInt(parts[0], 10); const monthIndex = parseInt(parts[1], 10) - 1; const day = parseInt(parts[2], 10); const date = new Date(year, monthIndex, day); if (isNaN(date.getTime())) { throw new Error("Invalid date created"); } const options = { timeZone: 'Africa/Cairo', weekday: 'long' }; const dayName = date.toLocaleDateString('ar-EG', options); displayElement.textContent = `(${dayName})`; } catch (e) { console.error("Error getting day name for", dateString, ":", e); displayElement.textContent = ''; } }
      function updateLiabilitiesListDisplay(){const liabilitiesListContainer=d("liabilities-list"); if(!liabilitiesListContainer)return;liabilitiesListContainer.innerHTML='';if(liabilities.length===0){liabilitiesListContainer.innerHTML='<li class="text-center text-gray-500">لا توجد التزامات مسجلة حاليًا.</li>'}else{const sortedLiabilities=[...liabilities].sort((a,b)=>a.name.localeCompare(b.name,'ar'));sortedLiabilities.forEach(liability=>{const li=document.createElement('li');li.className='flex justify-between items-center';li.innerHTML=`<span class="font-medium">${liability.name}</span> <span class="text-pink-700 font-semibold">${formatCurrency(liability.amount)}</span>`;liabilitiesListContainer.appendChild(li)})}}
      function updatePaymentCreditorDropdown(){const paymentCreditorSelect=d("payment-creditor-name"); if(!paymentCreditorSelect)return;const currentSelection=paymentCreditorSelect.value;paymentCreditorSelect.innerHTML='<option value="">-- اختر الدائن --</option>';const sortedLiabilities=[...liabilities].sort((a,b)=>a.name.localeCompare(b.name,'ar'));sortedLiabilities.forEach(liability=>{if(liability.amount>0){const option=document.createElement('option');option.value=liability.name;option.textContent=`${liability.name} (${formatCurrency(liability.amount)})`;paymentCreditorSelect.appendChild(option)}});if(sortedLiabilities.some(l=>l.name===currentSelection&&l.amount>0)){paymentCreditorSelect.value=currentSelection}}
      // *** تم تعديل دالة تحديث الواجهة ***
      function updateUI(){
          console.log("updateUI called. Current loaded date:", currentLoadedDate);
          const{totalInventoryValue, totalCapital, totalDebtsValue, totalLiabilitiesValue}=calculateTotals();
          console.log("updateUI: Calculated totals - Inv:", totalInventoryValue, "Cap:", totalCapital, "Debts:", totalDebtsValue, "Liab:", totalLiabilitiesValue);

          // *** تحديث عناصر الملخص ***
          const summaryLiquidity = d("summary-current-liquidity");
          const summaryInventory = d("summary-total-inventory-value");
          const summaryConsignment = d("summary-consignment-value-display");
          const summaryDebts = d("summary-total-debts-display");
          const summaryLiabilities = d("summary-total-liabilities-display");
          const summaryExpenses = d("summary-total-expenses");
          const summaryProfit = d("summary-total-profit");
          const summaryCapital = d("summary-total-capital");
          if(summaryLiquidity) summaryLiquidity.textContent = formatCurrency(liquidity); else console.error("summaryLiquidity element not found");
          if(summaryInventory) summaryInventory.textContent = formatCurrency(totalInventoryValue); else console.error("summaryInventory element not found");
          if(summaryConsignment) summaryConsignment.textContent = formatCurrency(goodsOnConsignmentValue); else console.error("summaryConsignment element not found");
          if(summaryDebts) summaryDebts.textContent = formatCurrency(totalDebtsValue); else console.error("summaryDebts element not found");
          if(summaryLiabilities) summaryLiabilities.textContent = formatCurrency(totalLiabilitiesValue); else console.error("summaryLiabilities element not found");
          if(summaryExpenses) summaryExpenses.textContent = formatCurrency(expenses); else console.error("summaryExpenses element not found");
          if(summaryProfit) summaryProfit.textContent = formatCurrency(totalProfit); else console.error("summaryProfit element not found");
          if(summaryCapital) summaryCapital.textContent = formatCurrency(totalCapital); else console.error("summaryCapital element not found");

          // *** تحديث عناصر قسم المخزون ***
          const inventoryTotalInventoryValue = d("inventory-total-inventory-value");
          const inventoryConsignmentValue = d("inventory-consignment-value-display");
          const inventoryTotalProfit = d("inventory-total-profit");
          // console.log("updateUI: Checking inventory section elements:", inventoryTotalInventoryValue, inventoryConsignmentValue, inventoryTotalProfit); // تتبع إضافي
          if(inventoryTotalInventoryValue) inventoryTotalInventoryValue.textContent = `إجمالي قيمة المخزون: ${formatCurrency(totalInventoryValue)}`; else console.error("inventoryTotalInventoryValue element not found");
          if(inventoryConsignmentValue) inventoryConsignmentValue.textContent = `قيمة مؤقتة: ${formatCurrency(goodsOnConsignmentValue)}`; else console.error("inventoryConsignmentValue element not found");
          if(inventoryTotalProfit) inventoryTotalProfit.textContent = `إجمالي الربح: ${formatCurrency(totalProfit)}`; else console.error("inventoryTotalProfit element not found");


          // تحديث بقية الواجهة
          updateProductListDisplay();updateLogDisplay();updateAdditionalCostsCheckboxes();updatePendingSalesDisplay();updateDebtorsListDisplay();updatePaymentDebtorDropdown();updateLiquidityLogDisplay();updateLiabilitiesListDisplay();updatePaymentCreditorDropdown();

          // *** تحديث عنصر إجمالي الديون في قسم الديون ***
          const totalDebtsDisplay = d("total-debts-display");
          console.log("updateUI: Checking debts section element:", totalDebtsDisplay); // تتبع
          if(totalDebtsDisplay) {
               console.log("updateUI: Updating totalDebtsDisplay with:", totalDebtsValue); // تتبع
               totalDebtsDisplay.textContent=`إجمالي الديون: ${formatCurrency(totalDebtsValue)}`;
          } else {
               console.error("updateUI: Element #total-debts-display not found!");
          }

          // تحديث القيم الأخرى
          const currentLiquidityDisplay = d("current-liquidity");
          const totalExpensesDisplay = d("total-expenses");
          const totalLiabilitiesDisplay = d("total-liabilities-display");
          const totalCapitalDisplay = d("total-capital"); // قد لا يكون مستخدماً
          const currentDataDateDisplay = d("current-data-date");
          if(currentLiquidityDisplay)currentLiquidityDisplay.textContent=formatCurrency(liquidity);
          if(totalExpensesDisplay)totalExpensesDisplay.textContent=formatCurrency(expenses);
          if(totalLiabilitiesDisplay)totalLiabilitiesDisplay.textContent=`إجمالي الالتزامات: ${formatCurrency(totalLiabilitiesValue)}`;
          if(totalCapitalDisplay)totalCapitalDisplay.textContent=formatCurrency(totalCapital);
          if(currentDataDateDisplay){currentDataDateDisplay.textContent=currentLoadedDate?formatDateForDisplay(currentLoadedDate):"بيانات جديدة (لم تحفظ بعد)"}
      }
      // *** تعديل دالة الحفظ ***
      function saveCurrentStateByDate(dateString){
          console.log(`Saving data for key: ${lsPrefix + dateString}. currentLoadedDate before save was: ${currentLoadedDate}`);
          const stateToSave={
              products, liquidity, expenses, debtors, liabilities,
              profit:totalProfit, log:operationLog, pendingSales,
              goodsOnConsignmentValue, liquidityLog, salesToday,
              savedAt: new Date().toISOString(),
              savedForDate: dateString // <-- التأكد من حفظ التاريخ الصحيح
          };
          const storageKey=lsPrefix+dateString;
          saveData(storageKey,stateToSave);
          saveData(lsLastSaveKey, dateString);
          currentLoadedDate=dateString;
          console.log("currentLoadedDate set in saveCurrentStateByDate:", currentLoadedDate);
          updateUI();
          showGlobalMessage(`تم حفظ البيانات بنجاح لتاريخ: ${formatDateForDisplay(dateString)}`, false);
      }
      // *** تعديل دالة تحميل البيانات ***
      function loadDataForDate(dateString){
          const loadMessageElement = d("load-message-alt");
          const dateInputElement = d("load-date-alt");
          const dayDisplayElement = d("load-date-day-name-alt");
          console.log(`=> loadDataForDate called for: ${dateString}`);
          if(!dateString){showMessage(loadMessageElement,"يرجى اختيار تاريخ للتحميل.",true);return}

          const storageKey=lsPrefix+dateString;
          const loadedData=fetchData(storageKey,null);

          if(loadedData){
              console.log("Data found for", dateString);
              loadState(loadedData,dateString); // Sets currentLoadedDate = dateString
              updateUI();
              showMessage(loadMessageElement,"تم تحميل البيانات بنجاح.", false);
              if(dateInputElement) { dateInputElement.value = dateString; updateLoadDateDayName(dateString, dayDisplayElement); }
              console.log("loadDataForDate: Successfully loaded. currentLoadedDate is now:", currentLoadedDate);
          } else {
              console.log("No data found for", dateString, ". Resetting state and setting currentLoadedDate.");
              resetState(); // تصفير الحالة الحالية تمامًا
              currentLoadedDate = dateString; // *** تعيين التاريخ المحمل إلى التاريخ المطلوب ***
              updateUI(); // تحديث الواجهة لتعكس الحالة الفارغة للتاريخ المحدد
              showMessage(loadMessageElement,`لا توجد بيانات محفوظة لتاريخ ${formatDateForDisplay(dateString)}. يمكنك البدء بإدخال بيانات لهذا اليوم.`, false);
              if(dateInputElement) { dateInputElement.value = dateString; updateLoadDateDayName(dateString, dayDisplayElement); }
              console.log("loadDataForDate: No data found, BUT currentLoadedDate is now SET to:", currentLoadedDate);
          }
           console.log("<= Exiting loadDataForDate. currentLoadedDate is:", currentLoadedDate);
      }
      // *** دالة تصدير البيانات ***
      function exportData() {
          console.log("Export button clicked. currentLoadedDate:", currentLoadedDate);
          const dateToExport = currentLoadedDate || getTodayDateString();
          const stateToExport = {
              products, liquidity, expenses, debtors, liabilities,
              profit: totalProfit, log: operationLog, pendingSales,
              goodsOnConsignmentValue, liquidityLog, salesToday,
              savedAt: new Date().toISOString(),
              savedForDate: dateToExport
          };
          const jsonString = JSON.stringify(stateToExport, null, 2);
          const blob = new Blob([jsonString], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `بيانات_ادارة_البضائع_${dateToExport}.json`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
          showGlobalMessage(`تم تجهيز ملف التصدير لتاريخ ${formatDateForDisplay(dateToExport)}.`, false);
      }

      // *** دالة استيراد البيانات المعدلة ***
      function importData(event) {
          const file = event.target.files[0];
          const importMessage = d("import-message"); // التأكد من وجود مرجع لرسالة الاستيراد
          if (!file) {
              showMessage(importMessage, "لم يتم اختيار ملف.", true);
              return;
          }
          if (file.type !== "application/json") {
              showMessage(importMessage, "الرجاء اختيار ملف بصيغة JSON.", true);
              event.target.value = null;
              return;
          }

          const reader = new FileReader();

          reader.onload = function(e) {
              try {
                  const importedData = JSON.parse(e.target.result);
                  if (typeof importedData !== 'object' || importedData === null || !('savedForDate' in importedData)) {
                      throw new Error("ملف JSON غير صالح أو لا يحتوي على تاريخ.");
                  }

                  const originalDate = importedData.savedForDate;
                  const targetDateInputElement = d("load-date-alt");
                  const targetDate = targetDateInputElement ? targetDateInputElement.value : null;

                  if (!targetDate) {
                      showMessage(importMessage, "يرجى اختيار التاريخ الذي تريد استيراد البيانات إليه أولاً.", true);
                      event.target.value = null;
                      return;
                  }

                  const confirmationMsg = `الملف يحتوي على بيانات بتاريخ ${formatDateForDisplay(originalDate)}. هل تريد استيرادها وتطبيقها على تاريخ ${formatDateForDisplay(targetDate)}؟ (سيتم الكتابة فوق بيانات تاريخ ${formatDateForDisplay(targetDate)} الحالية)`;

                  if (confirm(confirmationMsg)) {
                      console.log(`Import confirmed by user. Importing data from ${originalDate} TO ${targetDate}`);
                      // تعديل التاريخ داخل البيانات المستوردة قبل تحميلها وحفظها
                      importedData.savedForDate = targetDate;
                      loadState(importedData, targetDate); // تحميل البيانات وتعيين currentLoadedDate إلى targetDate
                      saveCurrentStateByDate(targetDate); // *** حفظ البيانات فورًا للتاريخ المستهدف ***
                      updateUI(); // تحديث الواجهة بالكامل
                      // تحديث حقل التاريخ في الإعدادات (للتأكيد البصري)
                      const dayDisplayElement = d("load-date-day-name-alt");
                      if(targetDateInputElement) targetDateInputElement.value = targetDate;
                      updateLoadDateDayName(targetDate, dayDisplayElement);
                      showMessage(importMessage, `تم استيراد البيانات وتطبيقها بنجاح على تاريخ ${formatDateForDisplay(targetDate)}.`, false);
                  } else {
                      console.log("Import cancelled by user.");
                      showMessage(importMessage, "تم إلغاء عملية الاستيراد.", false);
                  }

              } catch (error) {
                  console.error("Error parsing or validating imported file:", error);
                  showMessage(importMessage, `حدث خطأ أثناء قراءة أو تحليل الملف: ${error.message}`, true);
              } finally {
                  event.target.value = null; // مسح حقل الملف للسماح بإعادة اختيار نفس الملف
              }
          };

          reader.onerror = function(e) {
              console.error("Error reading file:", e);
              showMessage(importMessage, "حدث خطأ أثناء قراءة الملف.", true);
              event.target.value = null;
          };

          reader.readAsText(file);
      }

      function generateReportHTML(){const{totalInventoryValue,totalCapital,totalDebtsValue,totalLiabilitiesValue}=calculateTotals();const now=new Date();const reportDate=currentLoadedDate?formatDateForDisplay(currentLoadedDate):"بيانات حالية غير محفوظة";const printDateTime=now.toLocaleString('ar-EG',{timeZone:'Africa/Cairo',dateStyle:'full',timeStyle:'medium'});let productsTable='<p>لا توجد منتجات في المخزون.</p>';if(products.length>0){productsTable=`<table border="1" style="width:100%;border-collapse:collapse;margin-top:10px;font-size:.9em"><thead><tr style="background-color:#f2f2f2"><th style="padding:5px">اسم البضاعة</th><th style="padding:5px">الكمية</th><th style="padding:5px">متوسط التكلفة</th><th style="padding:5px">إجمالي التكلفة</th></tr></thead><tbody>${products.map(p=>`<tr><td style="padding:5px">${p.name||'غير مسمى'}</td><td style="padding:5px">${Number(p.quantity)||0}</td><td style="padding:5px">${formatCurrency(p.costPrice)}</td><td style="padding:5px">${formatCurrency((Number(p.quantity)||0)*(Number(p.costPrice)||0))}</td></tr>`).join('')}</tbody></table>`}let logList='<p>لا توجد عمليات مسجلة.</p>';if(operationLog.length>0){logList=`<ul style="list-style:none;padding-right:0;margin-top:10px;font-size:.85em">${[...operationLog].reverse().map(log=>`<li style="border-bottom:1px dotted #ccc;margin-bottom:5px;padding-bottom:5px"><strong>${log.type}:</strong> ${log.details}<br><small style="color:#555">${formatDateTime(log.timestamp)}</small></li>`).join('')}</ul>`}let debtorsTable='<p>لا توجد ديون مستحقة.</p>';if(debtors.length>0){debtorsTable=`<table border="1" style="width:100%;border-collapse:collapse;margin-top:10px;font-size:.9em"><thead><tr style="background-color:#f2f2f2"><th style="padding:5px">اسم المدين</th><th style="padding:5px">المبلغ المستحق</th></tr></thead><tbody>${[...debtors].sort((a,b)=>a.name.localeCompare(b.name,'ar')).map(d=>`<tr><td style="padding:5px">${d.name}</td><td style="padding:5px">${formatCurrency(d.amount)}</td></tr>`).join('')}</tbody></table>`}let liabilitiesTable='<p>لا توجد التزامات مستحقة.</p>';if(liabilities.length>0){liabilitiesTable=`<table border="1" style="width:100%;border-collapse:collapse;margin-top:10px;font-size:.9em"><thead><tr style="background-color:#f2f2f2"><th style="padding:5px">اسم الدائن</th><th style="padding:5px">المبلغ المستحق</th></tr></thead><tbody>${[...liabilities].sort((a,b)=>a.name.localeCompare(b.name,'ar')).map(l=>`<tr><td style="padding:5px">${l.name}</td><td style="padding:5px">${formatCurrency(l.amount)}</td></tr>`).join('')}</tbody></table>`}return`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="UTF-8"><title>تقرير العمليات - ${reportDate}</title><style>body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;margin:20px}h1,h2{color:#333;border-bottom:1px solid #ccc;padding-bottom:5px;margin-bottom:15px}h1{text-align:center;font-size:1.4em}h2{font-size:1.1em;margin-top:20px}p{margin:8px 0;line-height:1.4}table{width:100%;border-collapse:collapse;margin-top:10px;font-size:.9em}th,td{border:1px solid #ddd;padding:6px;text-align:right}th{background-color:#f2f2f2;font-weight:bold}.summary p{font-size:1em;margin:5px 0}.print-info{text-align:center;font-size:.8em;color:#666;margin-bottom:20px}ul{padding-right:20px}</style></head><body><h1>تقرير العمليات</h1><p class="print-info">تاريخ بيانات التقرير: ${reportDate}<br>تاريخ ووقت الطباعة: ${printDateTime}</p><div class="summary"><h2>الملخص المالي</h2><p><strong>السيولة المتاحة:</strong> ${formatCurrency(liquidity)}</p><p><strong>إجمالي قيمة المخزون:</strong> ${formatCurrency(totalInventoryValue)}</p><p><strong>قيمة البضاعة المؤقتة:</strong> ${formatCurrency(goodsOnConsignmentValue)}</p><p><strong>إجمالي الديون المستحقة للشركة:</strong> ${formatCurrency(totalDebtsValue)}</p><p><strong>إجمالي الالتزامات المستحقة على الشركة:</strong> ${formatCurrency(totalLiabilitiesValue)}</p><p><strong>إجمالي المصروفات المسجلة:</strong> ${formatCurrency(expenses)}</p><p><strong>إجمالي الربح المحقق:</strong> ${formatCurrency(totalProfit)}</p><p><strong>رأس المال الحالي:</strong> ${formatCurrency(totalCapital)}</p></div><h2>تفاصيل الالتزامات المستحقة على الشركة</h2>${liabilitiesTable}<h2>تفاصيل الديون المستحقة للشركة</h2>${debtorsTable}<h2>تفاصيل المخزون</h2>${productsTable}<h2>سجل العمليات</h2>${logList}</body></html>`}
      function confirmPendingSale(pendingId){const saleIndex=pendingSales.findIndex(sale=>sale.id===pendingId);if(saleIndex===-1){console.error("Pending sale not found for confirmation:",pendingId);return}const confirmedSale=pendingSales[saleIndex];const mainCost=(confirmedSale.mainProduct.costPrice||0)*(confirmedSale.mainProduct.quantity||0);const additionalCost=(confirmedSale.additionalItems||[]).reduce((addSum,item)=>addSum+((item.costPrice||0)*(item.quantity||0)),0);const costOfConfirmedSale=mainCost+additionalCost;liquidity+=confirmedSale.totalSellPrice;totalProfit+=confirmedSale.potentialProfit;goodsOnConsignmentValue-=costOfConfirmedSale;if(goodsOnConsignmentValue<0)goodsOnConsignmentValue=0;let itemsText=`${confirmedSale.mainProduct.quantity}x "${confirmedSale.mainProduct.name}"`;if(confirmedSale.additionalItems&&confirmedSale.additionalItems.length>0){itemsText+=` مع (${confirmedSale.additionalItems.map(item=>item.name).join(', ')})`}logOperation("تأكيد بيع مؤقت",`تأكيد بيع ${itemsText}. إضافة ${formatCurrency(confirmedSale.totalSellPrice)} للسيولة و ${formatCurrency(confirmedSale.potentialProfit)} للربح. خصم ${formatCurrency(costOfConfirmedSale)} من قيمة البضاعة المؤقتة.`);
        const saleRecord = { id: `sale-${Date.now()}`, timestamp: new Date().toISOString(), items: [ { name: confirmedSale.mainProduct.name, quantity: confirmedSale.mainProduct.quantity, costPrice: confirmedSale.mainProduct.costPrice }, ...(confirmedSale.additionalItems || []).map(item => ({ name: item.name, quantity: item.quantity, costPrice: item.costPrice })) ], totalSellPrice: confirmedSale.totalSellPrice, totalCost: costOfConfirmedSale, profit: confirmedSale.potentialProfit }; salesToday.push(saleRecord);
        pendingSales.splice(saleIndex,1);updateUI();showGlobalMessage("تم تأكيد عملية البيع بنجاح.",false)}
      function cancelPendingSale(pendingId){const saleIndex=pendingSales.findIndex(sale=>sale.id===pendingId);if(saleIndex===-1){console.error("Pending sale not found for cancellation:",pendingId);return}const cancelledSale=pendingSales[saleIndex];const mainCost=(cancelledSale.mainProduct.costPrice||0)*(cancelledSale.mainProduct.quantity||0);const additionalCost=(cancelledSale.additionalItems||[]).reduce((addSum,item)=>addSum+((item.costPrice||0)*(item.quantity||0)),0);const costOfCancelledSale=mainCost+additionalCost;let itemsReturnedLog=[];const mainProductInfo=cancelledSale.mainProduct;const existingMainIndex=products.findIndex(p=>p.name===mainProductInfo.name);if(existingMainIndex!==-1){products[existingMainIndex].quantity+=mainProductInfo.quantity}else{products.push({name:mainProductInfo.name,quantity:mainProductInfo.quantity,costPrice:mainProductInfo.costPrice})}itemsReturnedLog.push(`${mainProductInfo.quantity}x "${mainProductInfo.name}"`);if(cancelledSale.additionalItems){cancelledSale.additionalItems.forEach(itemInfo=>{const existingAddIndex=products.findIndex(p=>p.name===itemInfo.name);if(existingAddIndex!==-1){products[existingAddIndex].quantity+=itemInfo.quantity}else{products.push({name:itemInfo.name,quantity:itemInfo.quantity,costPrice:itemInfo.costPrice})}itemsReturnedLog.push(`${itemInfo.quantity}x "${itemInfo.name}"`)})}goodsOnConsignmentValue-=costOfCancelledSale;if(goodsOnConsignmentValue<0)goodsOnConsignmentValue=0;logOperation("إلغاء بيع مؤقت/إرجاع",`إرجاع ${itemsReturnedLog.join(', ')} إلى المخزون. خصم ${formatCurrency(costOfCancelledSale)} من قيمة البضاعة المؤقتة.`);pendingSales.splice(saleIndex,1);updateUI();showGlobalMessage("تم إلغاء البيع المؤقت وإرجاع البضاعة للمخزون.",false)}

      // --- معالجات الأحداث ---
      if (mainNav) { mainNav.addEventListener('click', (e) => { if (e.target.tagName === 'BUTTON' && e.target.classList.contains('nav-button')) { const targetId = e.target.dataset.target; console.log("Navigating to:", targetId); contentSections.forEach(section => { section.classList.add('hidden'); }); const targetSection = d(targetId); if (targetSection) { targetSection.classList.remove('hidden'); } else { console.error("Target section not found:", targetId); } navButtons.forEach(button => { button.classList.remove('active'); }); e.target.classList.add('active'); } }); }
      // *** معالج زر الحفظ (مع إعادة التأكيد) ***
      if (saveButtonAlt) {
          saveButtonAlt.addEventListener("click", () => {
              console.log("--- Save Button Clicked ---");
              const loadedDate = currentLoadedDate; // القيمة الحالية عند الضغط
              const todayString = getTodayDateString();
              const targetDate = loadedDate || todayString; // استخدام التاريخ المحمل إن وجد، وإلا تاريخ اليوم

              console.log("currentLoadedDate when save clicked:", loadedDate); // --> تحقق من هذه القيمة
              console.log("Target date for this save operation:", targetDate); // --> تحقق من هذه القيمة

              const storageKey = lsPrefix + targetDate;
              const existingData = localStorage.getItem(storageKey);
              let proceed = true;
              let confirmMsg = `هل تريد حفظ التغييرات لتاريخ ${formatDateForDisplay(targetDate)}؟`;

              if (existingData) {
                   // إذا كان التاريخ المستهدف هو نفس التاريخ المحمل (سواء كان اليوم أو سابق)
                   if(loadedDate === targetDate) {
                       confirmMsg += ` (سيتم الكتابة فوق البيانات الحالية لهذا اليوم)`;
                   } else { // إذا كان التاريخ المستهدف هو اليوم، ولكن التاريخ المحمل مختلف
                        confirmMsg = `أنت تعرض بيانات تاريخ ${formatDateForDisplay(loadedDate)}. هل تريد حفظ التغييرات فوق بيانات اليوم الحالي (${formatDateForDisplay(targetDate)})؟`;
                   }
                   proceed = confirm(confirmMsg);
                   console.log("Confirmation shown. User proceed:", proceed);
              }
              // لا حاجة للتأكيد إذا كان الحفظ لتاريخ لا توجد له بيانات محفوظة

              if (proceed) {
                  console.log(`Proceeding to save state to date: ${targetDate}`);
                  saveCurrentStateByDate(targetDate); // استدعاء الحفظ بالتاريخ المحدد
              } else {
                  console.log("Save cancelled by user.");
              }
              console.log("--- Save Button Handler Finished ---");
          });
       }
      function handleLoadDataClick() { const dateInputElement = d("load-date-alt"); const dateToLoad = dateInputElement ? dateInputElement.value : null; console.log("Load button clicked. Date to load:", dateToLoad); loadDataForDate(dateToLoad); }
      if (loadDataButtonAlt) { loadDataButtonAlt.addEventListener("click", handleLoadDataClick); }
      function handleDateInputChange(e) { const dateValue = e.target.value; const targetDayDisplayId = e.target.id === 'load-date-alt' ? 'load-date-day-name-alt' : 'load-date-day-name'; const targetDayDisplay = d(targetDayDisplayId); console.log("Date input changed:", dateValue); updateLoadDateDayName(dateValue, targetDayDisplay); }
      if (loadDateInputAlt) { loadDateInputAlt.addEventListener('change', handleDateInputChange); }
      if (clearLogButton) { clearLogButton.addEventListener("click", () => { console.log("Clear Log button clicked"); if (confirm("هل أنت متأكد من رغبتك في مسح سجل عمليات اليوم الحالي؟ لن يتم حفظ هذا التغيير إلا بالضغط على زر الحفظ.")) { console.log("User confirmed log clear"); operationLog = []; console.log("operationLog array cleared, length:", operationLog.length); updateLogDisplay(); showGlobalMessage("تم مسح سجل اليوم الحالي من العرض. اضغط 'حفظ' لتثبيت التغيير.", false); } else { console.log("User cancelled log clear"); } }); }
      if (resetButtonAlt) { resetButtonAlt.addEventListener("click", () => { console.log("Reset button clicked."); if (confirm("تحذير: سيؤدي هذا إلى مسح جميع البيانات المعروضة حاليًا على الشاشة (لن يتم حذف أي بيانات محفوظة سابقًا). هل أنت متأكد؟")) { console.log("User confirmed reset."); resetState(); updateUI(); if(productMessage) productMessage.textContent = ''; if(sellMessage) sellMessage.textContent = ''; if(loadMessageAlt) loadMessageAlt.textContent = ''; if(liquidityMessage) liquidityMessage.textContent = ''; if(expensesMessage) expensesMessage.textContent = ''; if(debtsMessage) debtsMessage.textContent = ''; if(liabilitiesMessage) liabilitiesMessage.textContent = ''; showGlobalMessage("تم تصفير الواجهة. يمكنك البدء من جديد أو تحميل بيانات تاريخ آخر.", false); } else { console.log("User cancelled reset."); } }); }
      if (printButtonAlt) { printButtonAlt.addEventListener("click", () => { console.log("Print button clicked."); const reportHTML = generateReportHTML(); const printWindow = window.open('', '_blank', 'height=600,width=800'); if (printWindow) { printWindow.document.open(); printWindow.document.write(reportHTML); printWindow.document.close(); setTimeout(() => { try { printWindow.focus(); printWindow.print(); } catch (e) { console.error("Print error:", e); showGlobalMessage("حدث خطأ أثناء محاولة الطباعة.", true); } }, 500); } else { showGlobalMessage('فشل فتح نافذة الطباعة. يرجى السماح بالنوافذ المنبثقة.', true); } }); }
      // *** معالج زر التصدير ***
      if (exportDataButton) { exportDataButton.addEventListener("click", exportData); }
      // *** معالج حقل الاستيراد ***
      if (importFileInput) { importFileInput.addEventListener("change", importData); }

      // --- بقية معالجات الأحداث للأقسام المختلفة ---
      if (addProductButton) { addProductButton.addEventListener("click", () => { console.log("Add product clicked. currentLoadedDate:", currentLoadedDate); const name = productNameInput.value.trim(); const quantity = parseInputNumber(productQuantityInput); const costPrice = parseInputNumber(productCostPriceInput); if (!name || isNaN(quantity) || quantity < 0 || isNaN(costPrice) || costPrice < 0) { showMessage(productMessage, "يرجى ملء جميع الحقول بكميات وأسعار صحيحة (أكبر من أو تساوي صفر).", true); return; } const existingIndex = products.findIndex(p => p.name === name); if (existingIndex !== -1) { const existing = products[existingIndex]; const oldQuantity = Number(existing.quantity) || 0; const oldCostPrice = Number(existing.costPrice) || 0; const newQuantity = Number(quantity); const newCostPrice = Number(costPrice); const totalQuantity = oldQuantity + newQuantity; let newAverageCost = oldCostPrice; if (totalQuantity > 0 && newQuantity > 0) { const oldTotalValue = oldQuantity * oldCostPrice; const newTotalValue = newQuantity * newCostPrice; newAverageCost = (oldTotalValue + newTotalValue) / totalQuantity; } else if (oldQuantity > 0 && newQuantity === 0) { newAverageCost = oldCostPrice; } else { newAverageCost = newCostPrice; } existing.quantity = totalQuantity; existing.costPrice = newAverageCost; logOperation("تحديث مخزون", `إضافة ${newQuantity} من '${name}'. الكمية الجديدة: ${totalQuantity}. متوسط التكلفة المحدث: ${formatCurrency(newAverageCost)}`); showMessage(productMessage, `تم تحديث المنتج "${name}". متوسط التكلفة الجديد: ${formatCurrency(newAverageCost)}`); } else { if (quantity <= 0) { showMessage(productMessage, "يجب أن تكون كمية المنتج الجديد أكبر من صفر.", true); return; } products.push({ name, quantity, costPrice }); logOperation("إضافة بضاعة", `إضافة ${quantity} من '${name}' بسعر تكلفة ${formatCurrency(costPrice)}`); showMessage(productMessage, "تمت إضافة المنتج بنجاح."); } updateUI(); productNameInput.value = ""; productQuantityInput.value = "0"; productCostPriceInput.value = "0"; }); }
      if (sellButton) { sellButton.addEventListener("click", () => { console.log("Sell button clicked. currentLoadedDate:", currentLoadedDate); const isPendingSale = sellPendingCheckbox.checked; const mainProductName = sellProductNameInput.value.trim(); const quantitySold = parseInputNumber(sellQuantityInput); const totalSellPrice = parseInputNumber(sellPriceInput); if (!mainProductName || isNaN(quantitySold) || quantitySold <= 0 || isNaN(totalSellPrice) || (totalSellPrice < 0 && !isPendingSale) ) { showMessage(sellMessage, "يرجى ملء اسم المنتج والكمية وسعر البيع بشكل صحيح.", true); return; } const mainProductIndex = products.findIndex(p => p.name === mainProductName); if (mainProductIndex === -1) { showMessage(sellMessage, `المنتج الرئيسي "${mainProductName}" غير موجود.`, true); return; } const mainProduct = { ...products[mainProductIndex] }; if (mainProduct.quantity < quantitySold) { showMessage(sellMessage, `الكمية المطلوبة (${quantitySold}) من "${mainProductName}" غير متوفرة (المتاح: ${mainProduct.quantity}).`, true); return; } let costOfGoodsSold = (Number(mainProduct.costPrice) || 0) * quantitySold; let additionalItemsDataForPending = []; let additionalItemsToUpdateIndices = []; let additionalItemsLog = []; const additionalCheckboxes = additionalCostsContainer.querySelectorAll('input[type="checkbox"]:checked'); let possible = true; additionalCheckboxes.forEach(checkbox => { if (!possible) return; const additionalProductName = checkbox.value; const additionalProductIndex = products.findIndex(p => p.name === additionalProductName); if (additionalProductIndex !== -1) { const additionalProduct = products[additionalProductIndex]; if (additionalProduct.quantity < quantitySold) { showMessage(sellMessage, `الكمية المطلوبة (${quantitySold}) من "${additionalProductName}" غير متوفرة (المتاح: ${additionalProduct.quantity}).`, true); possible = false; } else { costOfGoodsSold += (Number(additionalProduct.costPrice) || 0) * quantitySold; additionalItemsDataForPending.push({ name: additionalProduct.name, quantity: quantitySold, costPrice: additionalProduct.costPrice }); additionalItemsToUpdateIndices.push(additionalProductIndex); additionalItemsLog.push(additionalProductName); } } else { console.warn(`Additional product "${additionalProductName}" selected but not found.`); } }); if (!possible) return; const potentialProfit = totalSellPrice - costOfGoodsSold; products[mainProductIndex].quantity -= quantitySold; let mainProductRemoved = products[mainProductIndex].quantity === 0; let additionalProductsRemovedNames = []; additionalItemsToUpdateIndices.forEach(index => { const productToUpdate = products[index]; if (productToUpdate) { productToUpdate.quantity -= quantitySold; if (productToUpdate.quantity === 0) { additionalProductsRemovedNames.push(productToUpdate.name); } } }); products = products.filter(p => p.quantity > 0); if (isPendingSale) { goodsOnConsignmentValue += costOfGoodsSold; const pendingSaleData = { id: `pending-${Date.now()}-${Math.random().toString(36).substring(2, 7)}`, timestamp: new Date().toISOString(), mainProduct: { name: mainProduct.name, quantity: quantitySold, costPrice: mainProduct.costPrice }, additionalItems: additionalItemsDataForPending, totalSellPrice: totalSellPrice, potentialProfit: potentialProfit, status: 'pending' }; pendingSales.push(pendingSaleData); let logDetails = `تسجيل بيع مؤقت لـ ${quantitySold}x "${mainProductName}"`; if (additionalItemsLog.length > 0) { logDetails += ` مع (${additionalItemsLog.join(', ')})`; } logDetails += `. التكلفة: ${formatCurrency(costOfGoodsSold)}. السعر المتوقع: ${formatCurrency(totalSellPrice)}.`; logOperation("بيع مؤقت", logDetails); showMessage(sellMessage, "تم تسجيل البيع كعملية مؤقتة."); } else { totalProfit += potentialProfit; liquidity += totalSellPrice; let logDetails = `بيع ${quantitySold} من "${mainProductName}"`; if (additionalItemsLog.length > 0) { logDetails += ` مع (${additionalItemsLog.join(', ')})`; } logDetails += ` بسعر إجمالي ${formatCurrency(totalSellPrice)}. التكلفة الإجمالية: ${formatCurrency(costOfGoodsSold)}. الربح: ${formatCurrency(potentialProfit)}.`; logOperation("بيع عادي", logDetails);
       const saleRecord = { id: `sale-${Date.now()}`, timestamp: new Date().toISOString(), items: [ { name: mainProduct.name, quantity: quantitySold, costPrice: mainProduct.costPrice }, ...additionalItemsDataForPending.map(i => ({ name: i.name, quantity: i.quantity, costPrice: i.costPrice })) ], totalSellPrice: totalSellPrice, totalCost: costOfGoodsSold, profit: potentialProfit }; salesToday.push(saleRecord);
       showMessage(sellMessage, `تمت عملية البيع بنجاح. الربح: ${formatCurrency(potentialProfit)}`); } updateUI(); sellProductNameInput.value = ""; sellQuantityInput.value = "1"; sellPriceInput.value = "0"; sellPendingCheckbox.checked = false; }); }
      if(sellProductNameInput) { sellProductNameInput.addEventListener('input', updateAdditionalCostsCheckboxes); sellProductNameInput.addEventListener('change', updateAdditionalCostsCheckboxes); }
      if (addLiquidityButton) { addLiquidityButton.addEventListener("click", () => { console.log("Add liquidity clicked. currentLoadedDate:", currentLoadedDate); const amount = parseInputNumber(addLiquidityAmountInput); const source = addLiquiditySourceInput.value.trim(); if (isNaN(amount) || amount <= 0) { showMessage(liquidityMessage, "يرجى إدخال مبلغ صحيح (> 0) للإضافة.", true); return; } if (!source) { showMessage(liquidityMessage, "يرجى إدخال مصدر السيولة.", true); return; } liquidity += amount; const logEntry = { id: `liq-${Date.now()}`, timestamp: new Date().toISOString(), type: "add", amount: amount, description: source, currentBalance: liquidity }; liquidityLog.push(logEntry); logOperation("إضافة سيولة", `إضافة ${formatCurrency(amount)} من "${source}". الرصيد الحالي: ${formatCurrency(liquidity)}`); updateUI(); addLiquidityAmountInput.value = "0"; addLiquiditySourceInput.value = ""; showMessage(liquidityMessage, `تمت إضافة ${formatCurrency(amount)} من "${source}".`); }); }
      if (removeLiquidityButton) { removeLiquidityButton.addEventListener("click", () => { console.log("Remove liquidity clicked. currentLoadedDate:", currentLoadedDate); const amount = parseInputNumber(removeLiquidityAmountInput); const reason = removeLiquidityReasonInput.value.trim(); if (isNaN(amount) || amount <= 0) { showMessage(liquidityMessage, "يرجى إدخال مبلغ صحيح (> 0) للسحب.", true); return; } if (!reason) { showMessage(liquidityMessage, "يرجى إدخال سبب السحب.", true); return; } liquidity -= amount; const logEntry = { id: `liq-${Date.now()}`, timestamp: new Date().toISOString(), type: "remove", amount: amount, description: reason, currentBalance: liquidity }; liquidityLog.push(logEntry); logOperation("سحب سيولة", `سحب ${formatCurrency(amount)} بسبب "${reason}". الرصيد الحالي: ${formatCurrency(liquidity)}`); updateUI(); removeLiquidityAmountInput.value = "0"; removeLiquidityReasonInput.value = ""; showMessage(liquidityMessage, `تم سحب ${formatCurrency(amount)} بسبب "${reason}".`); }); }
      if (addExpenseButton) { addExpenseButton.addEventListener("click", () => { console.log("Add expense clicked. currentLoadedDate:", currentLoadedDate); const amount = parseInputNumber(addExpenseInput); if (isNaN(amount)) { showMessage(expensesMessage, "يرجى إدخال مبلغ رقمي صحيح للمصروف.", true); return; } if (amount <= 0) { showMessage(expensesMessage, "يجب أن يكون مبلغ المصروف أكبر من صفر.", true); return; } expenses += amount; liquidity -= amount; logOperation("تسجيل مصروف", `تسجيل مصروف بقيمة ${formatCurrency(amount)}. تم خصمه من السيولة (الحالية: ${formatCurrency(liquidity)}).`); updateUI(); addExpenseInput.value = "0"; showMessage(expensesMessage, `تم تسجيل مصروف ${formatCurrency(amount)}.`); }); }
      if (removeExpenseButton) { removeExpenseButton.addEventListener("click", () => { console.log("Remove expense clicked. currentLoadedDate:", currentLoadedDate); const amount = parseInputNumber(removeExpenseInput); if (!isNaN(amount) && amount > 0) { if (amount <= expenses) { expenses -= amount; liquidity += amount; logOperation("تقليل مصروف", `تقليل المصروفات بقيمة ${formatCurrency(amount)}. تم إرجاعه للسيولة.`); updateUI(); removeExpenseInput.value = "0"; showMessage(expensesMessage, `تم تقليل المصروفات ${formatCurrency(amount)}.`); } else { showMessage(expensesMessage, `المبلغ أكبر من إجمالي المصروفات (${formatCurrency(expenses)}).`, true); } } else { showMessage(expensesMessage, "أدخل مبلغ صحيح (> 0).", true); } }); }
      if (addDebtButton) { addDebtButton.addEventListener("click", () => { console.log("Add debt clicked. currentLoadedDate:", currentLoadedDate); const name = debtorNameInput.value.trim(); const amount = parseInputNumber(addDebtAmountInput); const deductLiquidity = debtDeductLiquidityCheckbox.checked; if (!name) { showMessage(debtsMessage, "يرجى إدخال اسم المدين.", true); return; } if (isNaN(amount)) { showMessage(debtsMessage, "يرجى إدخال مبلغ رقمي صحيح في حقل المبلغ.", true); return; } if (amount <= 0) { showMessage(debtsMessage, "يجب أن يكون مبلغ الدين أكبر من صفر.", true); return; } const existingDebtorIndex = debtors.findIndex(d => d.name === name); let logMsg = ""; if (existingDebtorIndex !== -1) { debtors[existingDebtorIndex].amount += amount; logMsg = `زيادة دين قائم لـ "${name}" بمبلغ ${formatCurrency(amount)}. الإجمالي: ${formatCurrency(debtors[existingDebtorIndex].amount)}`; showMessage(debtsMessage, `تمت زيادة دين "${name}" بنجاح.`); } else { const newDebtor = { id: `debtor-${Date.now()}`, name: name, amount: amount }; debtors.push(newDebtor); logMsg = `تسجيل دين جديد على "${name}" بمبلغ ${formatCurrency(amount)}.`; showMessage(debtsMessage, `تم تسجيل دين جديد على "${name}".`); } if (deductLiquidity) { liquidity -= amount; logMsg += ` (وتم خصمه من السيولة كسلفة).`; } logOperation("تسجيل/زيادة دين (لك)", logMsg); updateUI(); debtorNameInput.value = ""; addDebtAmountInput.value = "0"; debtDeductLiquidityCheckbox.checked = false; }); }
      if (receivePaymentButton) { receivePaymentButton.addEventListener("click", () => { console.log("Receive payment clicked. currentLoadedDate:", currentLoadedDate); const selectedDebtorName = paymentDebtorSelect.value; const payment = parseInputNumber(paymentAmountInput); if (!selectedDebtorName) { showMessage(debtsMessage, "يرجى اختيار اسم المدين من القائمة.", true); return; } if (isNaN(payment)) { showMessage(debtsMessage, "يرجى إدخال مبلغ سداد رقمي صحيح.", true); return; } if (payment <= 0) { showMessage(debtsMessage, "يجب أن يكون مبلغ السداد أكبر من صفر.", true); return; } const debtorIndex = debtors.findIndex(d => d.name === selectedDebtorName); if (debtorIndex === -1) { showMessage(debtsMessage, "خطأ: المدين المحدد غير موجود!", true); return; } const debtor = debtors[debtorIndex]; if (payment > debtor.amount) { showMessage(debtsMessage, `المبلغ المسدد (${formatCurrency(payment)}) أكبر من الدين المتبقي (${formatCurrency(debtor.amount)}).`, true); return; } debtor.amount -= payment; liquidity += payment; logOperation("استلام سداد دين", `استلام دفعة ${formatCurrency(payment)} من "${debtor.name}". المتبقي: ${formatCurrency(debtor.amount)}.`); if (debtor.amount < 0.001) { debtors.splice(debtorIndex, 1); showMessage(debtsMessage, `تم استلام سداد كامل من "${debtor.name}".`); paymentDebtorSelect.value = ""; } else { showMessage(debtsMessage, `تم استلام دفعة من "${debtor.name}" بنجاح.`); } updateUI(); paymentAmountInput.value = "0"; }); }
      if (addLiabilityButton) { addLiabilityButton.addEventListener("click", () => { console.log("Add liability clicked. currentLoadedDate:", currentLoadedDate); const name = creditorNameInput.value.trim(); const amount = parseInputNumber(addLiabilityAmountInput); const receivedCash = liabilityReceivedCashCheckbox.checked; if (!name) { showMessage(liabilitiesMessage, "يرجى إدخال اسم الدائن.", true); return; } if (isNaN(amount)) { showMessage(liabilitiesMessage, "يرجى إدخال مبلغ التزام رقمي صحيح.", true); return; } if (amount <= 0) { showMessage(liabilitiesMessage, "يجب أن يكون مبلغ الالتزام أكبر من صفر.", true); return; } const existingIndex = liabilities.findIndex(l => l.name === name); let logMsg = ""; if (existingIndex !== -1) { liabilities[existingIndex].amount += amount; logMsg = `زيادة التزام قائم لـ "${name}" بمبلغ ${formatCurrency(amount)}. الإجمالي: ${formatCurrency(liabilities[existingIndex].amount)}`; showMessage(liabilitiesMessage, `تمت زيادة الالتزام لـ "${name}".`); } else { const newLiability = { id: `liab-${Date.now()}`, name: name, amount: amount }; liabilities.push(newLiability); logMsg = `تسجيل التزام جديد على الشركة لـ "${name}" بمبلغ ${formatCurrency(amount)}.`; showMessage(liabilitiesMessage, `تم تسجيل التزام جديد لـ "${name}".`); } if (receivedCash) { liquidity += amount; logMsg += ` (تم استلام سيولة).`; } logOperation("تسجيل/زيادة التزام", logMsg); updateUI(); creditorNameInput.value = ""; addLiabilityAmountInput.value = "0"; liabilityReceivedCashCheckbox.checked = false; }); }
      if (payLiabilityButton) { payLiabilityButton.addEventListener("click", () => { console.log("Pay liability clicked. currentLoadedDate:", currentLoadedDate); const selectedCreditorName = paymentCreditorSelect.value; const payment = parseInputNumber(liabilityPaymentAmountInput); if (!selectedCreditorName) { showMessage(liabilitiesMessage, "يرجى اختيار اسم الدائن من القائمة.", true); return; } if (isNaN(payment)) { showMessage(liabilitiesMessage, "يرجى إدخال مبلغ سداد رقمي صحيح.", true); return; } if (payment <= 0) { showMessage(liabilitiesMessage, "يجب أن يكون مبلغ السداد أكبر من صفر.", true); return; } const liabilityIndex = liabilities.findIndex(l => l.name === selectedCreditorName); if (liabilityIndex === -1) { showMessage(liabilitiesMessage, "خطأ: الدائن المحدد غير موجود!", true); return; } const liability = liabilities[liabilityIndex]; if (payment > liability.amount) { showMessage(liabilitiesMessage, `المبلغ المسدد (${formatCurrency(payment)}) أكبر من الالتزام المتبقي (${formatCurrency(liability.amount)}).`, true); return; }
       liability.amount -= payment; liquidity -= payment;
       logOperation("تسديد التزام", `تسديد دفعة ${formatCurrency(payment)} إلى "${liability.name}". المتبقي: ${formatCurrency(liability.amount)}. تم خصمه من السيولة (الحالية: ${formatCurrency(liquidity)}).`); if (liability.amount < 0.001) { liabilities.splice(liabilityIndex, 1); showMessage(liabilitiesMessage, `تم تسديد كامل الالتزام لـ "${liability.name}".`); paymentCreditorSelect.value = ""; } else { showMessage(liabilitiesMessage, `تم تسديد دفعة إلى "${liability.name}" بنجاح.`); } updateUI(); liabilityPaymentAmountInput.value = "0"; }); }
      if (loadDateInputAlt) { loadDateInputAlt.addEventListener('change', (e) => { updateLoadDateDayName(e.target.value, loadDateDayNameDisplayAlt); }); }


      // --- التحميل الأولي ---
      function initializeApp(){
          console.log("Initializing App...");
          const lastSaveDate=fetchData(lsLastSaveKey,null);
          const dateInputElement = d("load-date-alt");
          const dayDisplayElement = d("load-date-day-name-alt");

          if(lastSaveDate){
              console.log("Found last save date:", lastSaveDate);
              if(dateInputElement) dateInputElement.value = lastSaveDate;
              loadDataForDate(lastSaveDate); // This calls loadState which sets currentLoadedDate
          } else {
              console.log("No last save date found. Resetting state.");
              resetState(); // This sets currentLoadedDate to null
              updateUI();
              showGlobalMessage("مرحبًا بك! ابدأ بإضافة المنتجات أو تحميل بيانات تاريخ سابق.",false);
              if(dateInputElement && !dateInputElement.value){
                  dateInputElement.value = getTodayDateString();
                  console.log("Set default date:", dateInputElement.value);
                  updateLoadDateDayName(dateInputElement.value, dayDisplayElement);
              }
          }
          // Ensure day name is updated for the initially loaded/set date
          if(dateInputElement && dateInputElement.value) {
               console.log("Updating day name for initial date:", dateInputElement.value);
               updateLoadDateDayName(dateInputElement.value, dayDisplayElement);
          } else {
               console.log("No initial date value found in input.");
               updateLoadDateDayName(null, dayDisplayElement); // Clear day name if no date
          }
           // إظهار القسم الافتراضي (الملخص) وتنشيط الزر
           contentSections.forEach(section => { section.classList.add('hidden'); });
           const defaultSection = d('summary-section');
           if (defaultSection) defaultSection.classList.remove('hidden');
           navButtons.forEach(button => { button.classList.remove('active'); if(button.dataset.target === 'summary-section') { button.classList.add('active'); } });
           console.log("Initialization complete. currentLoadedDate:", currentLoadedDate);
      }

      initializeApp(); // بدء التطبيق

    }); // نهاية DOMContentLoaded
  </script>
</body>
</html>
