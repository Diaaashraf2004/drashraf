<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مثال ماسح الباركود</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js" type="text/javascript"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; text-align: center; }
        #qr-reader { width: 90%; max-width: 400px; margin: 20px auto; border: 1px solid #ccc; }
        #qr-reader-results { margin-top: 20px; font-size: 1.2em; font-weight: bold; color: green; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; font-size: 1em; border-radius: 5px; border: none; color: white; }
        #startScanBtn { background-color: #28a745; } /* Green */
        #stopScanBtn { background-color: #dc3545; display: none; } /* Red, hidden initially */
        #cameraPermissionStatus { font-size: 0.9em; color: #6c757d; margin-top: 10px; }
    </style>
</head>
<body>

    <h1>مثال بسيط لمسح الباركود/QR Code</h1>

    <div id="qr-reader"></div>
    <div id="qr-reader-results">لم يتم مسح أي كود بعد.</div>
    <div id="cameraPermissionStatus"></div>

    <button id="startScanBtn">بدء المسح بالكاميرا</button>
    <button id="stopScanBtn">إيقاف المسح</button>

    <script>
        const resultContainer = document.getElementById('qr-reader-results');
        const startScanBtn = document.getElementById('startScanBtn');
        const stopScanBtn = document.getElementById('stopScanBtn');
        const permissionStatusDiv = document.getElementById('cameraPermissionStatus');
        let html5QrCode = null; // سيتم تهيئته لاحقاً

        function onScanSuccess(decodedText, decodedResult) {
            // التعامل مع النتيجة هنا
            console.log(`Code matched = ${decodedText}`, decodedResult);
            resultContainer.textContent = `تم المسح بنجاح: ${decodedText}`;
            // يمكنك إضافة الكود هنا لإضافة decodedText إلى textarea أو قائمة
            // يمكنك أيضاً إيقاف المسح تلقائياً بعد نجاح واحد إذا أردت
            // stopScanning();
        }

        function onScanFailure(error) {
            // يمكنك تجاهل أخطاء عدم العثور على كود
            // console.warn(`Code scan error = ${error}`);
        }

        function startScanning() {
            permissionStatusDiv.textContent = 'جاري طلب إذن الكاميرا...';
            // تهيئة الماسح
            html5QrCode = new Html5Qrcode("qr-reader"); // استخدم معرف الـ div

            // طلب قائمة الكاميرات والحصول على الإذن
            Html5Qrcode.getCameras().then(devices => {
                permissionStatusDiv.textContent = 'تم الحصول على إذن الكاميرا.';
                if (devices && devices.length) {
                    // يمكنك اختيار كاميرا معينة إذا أردت، هنا نستخدم الكاميرا الخلفية افتراضياً (environment)
                    const cameraId = devices.find(d => d.label.toLowerCase().includes('back'))?.id || devices[0].id;
                    console.log("Using camera:", cameraId);

                    // بدء المسح
                    html5QrCode.start(
                        cameraId, // أو { facingMode: "environment" }
                        {
                            fps: 10,    // إطارات في الثانية للمسح (اختياري)
                            qrbox: { width: 250, height: 250 }  // حجم مربع المسح (اختياري)
                        },
                        onScanSuccess, // دالة عند النجاح
                        onScanFailure  // دالة عند الفشل (أو عدم العثور على كود)
                    ).then(() => {
                        console.log("QR Code scanning started.");
                        startScanBtn.style.display = 'none';
                        stopScanBtn.style.display = 'inline-block';
                        permissionStatusDiv.textContent = 'الكاميرا تعمل. وجهها نحو الباركود.';
                    }).catch(err => {
                        console.error("Error starting QR Code scanning.", err);
                        permissionStatusDiv.textContent = `خطأ في تشغيل الكاميرا: ${err}`;
                        alert(`خطأ في تشغيل الكاميرا: ${err}`);
                    });
                } else {
                     permissionStatusDiv.textContent = 'لم يتم العثور على كاميرات.';
                     alert("لم يتم العثور على كاميرات.");
                }
            }).catch(err => {
                console.error("Error getting camera permissions.", err);
                permissionStatusDiv.textContent = `خطأ في الحصول على إذن الكاميرا: ${err}`;
                alert(`خطأ في الحصول على إذن الكاميرا: ${err}. تأكد من السماح للمتصفح باستخدام الكاميرا وأن الموقع يعمل على HTTPS إذا لم يكن ملفاً محلياً.`);
            });
        }

        function stopScanning() {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().then((ignore) => {
                    console.log("QR Code scanning stopped.");
                    startScanBtn.style.display = 'inline-block';
                    stopScanBtn.style.display = 'none';
                    permissionStatusDiv.textContent = '';
                    // يمكنك مسح منطقة عرض الكاميرا إذا أردت
                    // document.getElementById('qr-reader').innerHTML = '';
                }).catch((err) => {
                    console.error("Error stopping QR Code scanning.", err);
                });
            }
        }

        startScanBtn.addEventListener('click', startScanning);
        stopScanBtn.addEventListener('click', stopScanning);

    </script>

</body>
</html>
